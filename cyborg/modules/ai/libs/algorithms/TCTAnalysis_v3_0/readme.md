# tct_alg.py
## class KWW_ALG(AlgBase):
> ### 第一版，基于1.0的roi基础上作的细胞检测以及后续的细胞二分类
## class KWW_ALG_2(AlgBase): （现在主要是用这）
### 测试步骤：
1. 导入细胞检测，细胞分类，全场图分类的torchscript模型
2. 修改cal_tct()中的模型路径
```
507     self.cell_detector = ...
508     self.cell_classification = ...
509     self.wsi_classification = ...
```
3. 修改 中间变量：细胞检测框的坐标 保存位置（默认为全场图的根目录）
```
630      wsi_pt_path = os.path.join(os.path.dirname(slide.filename), "detect_result.pt")
```
4. 修改 中间变量：细胞分类的输入变量 保存位置 （默认为全场图的根目录）
```
wsi_cells_path = os.path.join(os.path.dirname(slide.filename), "wsi_cells_20X.pt") #20be
```
5. 修改 细胞检测抠出来的细胞图像的保存路径，**适配训练的输入数据**。
```
692     save_dir = r"D:/test_img_20X"
691     #fname = slide.filename.split("\\")[-2] + "_" + fname #为了防止全场图重复命名覆盖，可以把这这个注释打开
```
# 全场图数据清洗以及新增
---
## 训练端数据清洗过程
### 1. 按照顺序部署端测试集，验证集，训练集进行清洗
### 2. 把需要清洗的数据集归类为 A
### 3. 在训练端测试脚本中对**A类全场图**挑选出符合以下条件归类为**B**, 不符合条件依旧为**A类**
> 1. 标签与预测结果不一致的全场图
> 2. 阴性置信度在0.3~0.7之间的全场图
> 3. **训练集额外的条件**：全场图标签为阴性：却有100个以上的阳性细胞
### 4. 对所有B类的全场图以及做出全场图预测的前128个细胞进行可视化，交由算法人员+医生分析标签是否出错，分析条件如下：
> 1. 根据全场图上的前128个细胞能否推翻已有的 全场图标签
> 2. 如果不能则维持原有全场图标签判读。
> 3. 前128个细胞是否有分错类别，分错 保存下全场图路径，该细胞的坐标+正确类别，留给后续的细胞级模型适配优化。
### 5. **B**类全场图复核分析完后，重新训练模型。
### 6. 用 **5**的新模型 重复3，4，5步，直到 B类全场图为空或者A类全场图为空
---
## 适配以及初筛流程
### 1. 在部署端对**适配**或**初筛**的全场图进行细胞检测以及细胞分类以及全场图分类。
### 2. 测试完成后，去测试步骤中的 **5.** 细胞图像保存路径获取到测试的全场图的细胞图像。这些全场图的细胞图像相当于 **wsi_classify项目中的数据准备的第二步完成后**的细胞图像
### 3. 把这些全场图对应的细胞图像 以及对应的复核后的全场图标签 上传到训练端服务器，
### 4. 在训练端对这些全场图 根据标签结果 进行 **wsi_classify**的数据准备 **3.** 来得到全场图的特征，并且归类A
### 5. 对A类全场图，进行全场图结果的预测，并且符合以下条件的全场图归类为B，不符合条件的保留归类为A。
> 1.    标签与预测结果不一致的全场图
> 2.    阴性置信度在0.3~0.7之间的全场图
### 6. 对B类全场图按8：2划分训练集，验证集 添加到 训练过程中，按照 wsi_classify项目中的 **训练指令**完成训练
### 7. 根据部署段测试集的结果挑选最优的全场图分类模型，重复步骤**5，6**直至 A类或B类全场图为空
---
## 细胞级模型的优化以及适配
### 1. 需要进行该步骤的条件
> 1. 进行全场图适配后结果 依旧不好。
> 2. 在全场图适配或者数据集清洗过程中产生了足够多的新的细胞级分类数据
### 2. 按照细胞分类项目对新数据划分到训练集+验证集重新训练细胞级分类模型
### 3. 在更新了细胞级分类模型后 需要重新训练全场图分类模型


