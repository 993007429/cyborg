webpackJsonp([1],{"+EpN":function(t,e){},"+SYN":function(t,e){},"+Xyh":function(t,e,i){t.exports=i.p+"static/img/下载模版.3a010ac.svg"},"+cZ/":function(t,e){},"+we9":function(t,e){},"+yoz":function(t,e){},"0DuT":function(t,e){},"0Zwn":function(t,e){},"0q1C":function(t,e){},"22EN":function(t,e){},"2AQt":function(t,e){},"2UPN":function(t,e){},"2Yd2":function(t,e){},"3IMj":function(t,e){},"4iXm":function(t,e){},"4jrt":function(t,e,i){t.exports=i.p+"static/img/自由排除.22dcf85.svg"},"5C63":function(t,e){},"5ie8":function(t,e){},"5wHl":function(t,e){},"6lzc":function(t,e,i){t.exports=i.p+"static/img/三角.619288f.png"},"6tyt":function(t,e){},"70/Y":function(t,e,i){"use strict";(function(t){var s=i("umLD"),a=i("yxHg"),n=i("jyVo"),o=i("mtWM"),l=i.n(o);let r,c;if(window.electron){let t=window.electron.remote.require;r=t("fs"),c=t("stream")}e.a={props:["record","config"],components:{"v-eidtreport":s.a,"v-viewreport":a.a},data(){return this.record.reportInfo=this.record.reportInfo||{type:"REG",REG:{}},{userInfo:Object(n.o)(),scaleRate:1,reportType:this.record.reportInfo.type,algType:this.record.alg,slices:{dna:[],human:[],lct:[],tct:[]},sign:"/aipath/api/user/sign?id="+Object(n.o)().username+"&"+Math.random(),signed:!1,loading:!1,demoModeValue:"1"===localStorage.getItem("demoMode")||!1}},methods:{createReport(t){let e=window.localStorage.getItem("localeLanguage");return Object(n.b)("report/create",{data:JSON.stringify(this.record),caseid:this.record.id,reportid:t,lang:e})},next(){var t=Math.floor(1e5*Math.random());this.createReport(t).then(e=>this.record.reports.unshift({id:t,doctor:Object(n.o)().username,date:new Date})).then(t=>this.$emit("save"))},prev(){this.$emit("prev")},resize(){this.scaleRate=(window.document.body.clientWidth/2-60)/905},download(){let e=Math.floor(1e5*Math.random()),i=window.localStorage.getItem("localeLanguage");this.loading=!0;let s=this.deepClone(this.record);"DNA"==this.record.reportInfo.type&&(s.reportInfo.DNA.pageType="TBSPage"),Object(n.b)("report/create",{data:JSON.stringify(s),caseid:this.record.id,reportid:e,lang:i}).then(t=>this.record.reports.unshift({id:e,doctor:Object(n.o)().username,date:new Date})).then(async i=>{let s=Object(n.i)(new Date).replace(/\s+/g,"");if(window.electron)l()({headers:{"Content-Type":" application/x-www-form-urlencoded"},method:"get",url:`/aipath/api/report/view?caseid=${this.record.id}&reportid=${e}&time=${s}`,responseType:"blob"}).then(e=>{let i=new Blob([e.data],{type:"application/pdf;charset=utf-8"}),s=new FileReader;s.readAsDataURL(i),s.onload=(e=>{const{dialog:i}=window.electron.remote;let s=this.record.basic.caseid||this.record.basic.name?(this.record.basic.caseid||"")+(this.record.basic.name||""):"report";i.showSaveDialog({defaultPath:`${s}.pdf`,title:"下载报告",filters:[{name:"PDF",extensions:["pdf"]}]}).then(async({filePath:i})=>{if(i){let s=t.from(e.target.result.split("base64,")[1],"base64");const a=new c.PassThrough({allowHalfOpen:!1}),n=new r.createWriteStream(i);n.on("error",t=>{console.log(t),this.$message.error("导出错误，请重试"),this.loading=!1,this.$emit("save")}).on("finish",()=>{"DNA"==this.record.reportInfo.type&&"double"==window.reportTypeMode?this.downloadDNA():(this.loading=!1,this.$emit("save"))}),a.end(s),a.pipe(n)}else this.loading=!1,this.$emit("save")}).catch(t=>{this.loading=!1,this.$emit("save")})})}).catch(t=>this.$alert(t.message));else{"DNA"==this.record.reportInfo.type&&"double"==window.reportTypeMode?this.downloadDNA():(this.loading=!1,this.$emit("save"));var a=document.createElement("a");a.style.display="none";let t=this.record.basic.caseid||this.record.basic.name?(this.record.basic.caseid||"")+(this.record.basic.name||""):"report";a.download=`${t}.pdf`,a.href=`/aipath/api/report/view?caseid=${this.record.id}&reportid=${e}&time=${s}`,document.body.appendChild(a),a.click(),document.body.removeChild(a)}}).catch(t=>{this.loading=!1,this.$alert(t.message)})},downloadDNA(){let e=Math.floor(1e5*Math.random()),i=window.localStorage.getItem("localeLanguage");this.loading=!0;let s=this.deepClone(this.record);s.reportInfo.DNA.pageType="DNAPage",Object(n.b)("report/create",{data:JSON.stringify(s),caseid:this.record.id,reportid:e,lang:i}).then(t=>this.record.reports.unshift({id:e,doctor:Object(n.o)().username,date:new Date})).then(async i=>{let s=Object(n.i)(new Date).replace(/\s+/g,"");if(window.electron)l()({headers:{"Content-Type":" application/x-www-form-urlencoded"},method:"get",url:`/aipath/api/report/view?caseid=${this.record.id}&reportid=${e}&time=${s}`,responseType:"blob"}).then(e=>{let i=new Blob([e.data],{type:"application/pdf;charset=utf-8"}),s=new FileReader;s.readAsDataURL(i),s.onload=(e=>{const{dialog:i}=window.electron.remote;let s=this.record.basic.caseid||this.record.basic.name?(this.record.basic.caseid||"")+(this.record.basic.name||""):"report";i.showSaveDialog({defaultPath:`${s}_DNA.pdf`,title:"下载报告",filters:[{name:"PDF",extensions:["pdf"]}]}).then(async({filePath:i})=>{if(i){let s=t.from(e.target.result.split("base64,")[1],"base64");const a=new c.PassThrough({allowHalfOpen:!1}),n=new r.createWriteStream(i);n.on("error",t=>{console.log(t),this.$message.error("导出错误，请重试"),this.loading=!1,this.$emit("save")}).on("finish",()=>{this.loading=!1,this.$emit("save")}),a.end(s),a.pipe(n)}else this.loading=!1,this.$emit("save")}).catch(t=>{this.loading=!1,this.$emit("save")})})}).catch(t=>this.$alert(t.message));else{this.loading=!1,this.$emit("save");var a=document.createElement("a");a.style.display="none";let t=this.record.basic.caseid||this.record.basic.name?(this.record.basic.caseid||"")+(this.record.basic.name||""):"report";a.download=`${t}_DNA.pdf`,a.href=`/aipath/api/report/view?caseid=${this.record.id}&reportid=${e}&time=${s}`,document.body.appendChild(a),a.click(),document.body.removeChild(a)}}).catch(t=>{this.loading=!1,this.$alert(t.message)})},deepClone(t){let e={},i=JSON.stringify(t);return e=JSON.parse(i)},typeChange(t){this.$set(this.record.reportInfo,"type",t),this.reportType=t,this.record.reportInfo[t]=this.record.reportInfo[t]||{}},getImages(){Object(n.b)("report/getReportROI",{caseid:this.record.id,alg:this.reportType.toLowerCase()}).then(t=>{this.slices=t.data})},hasSign(){Object(n.b)("user/haveSign").then(t=>{this.signed=t.data})},getLogo(){Object(n.b)("records/getLogo").then(t=>{this.$set(this.record,"logo",t.data)})},changeSign(){this.sign="/aipath/api/user/sign?id="+this.userInfo.username+"&"+Math.random(),this.hasSign()}},mounted(){window.addEventListener("resize",this.resize),this.$set(this.record,"roishow",!0),this.resize(),Object(n.b)("records/getReportOpinion ",{caseid:this.record.id}).then(({data:t})=>{t.alg&&(t.alg.includes("tct")||t.alg.includes("lct"))?(this.$set(this.record.reportInfo,"type","LCT"),this.reportType="LCT",this.record.reportInfo.LCT=this.record.reportInfo.LCT||{},this.$set(this.record,"opinion",t.opinion)):"dna"==t.alg&&(this.$set(this.record.reportInfo,"type",t.alg.toUpperCase()),this.reportType=t.alg.toUpperCase(),this.record.reportInfo[this.reportType]=this.record.reportInfo[this.reportType]||{},this.$set(this.record,"opinion",t.opinion),this.$set(this.record,"DNAOpinion",t.DNAOpinion)),this.algType=t.alg,this.getImages(this.reportType)}),this.hasSign(),this.getLogo()},beforeDestroy(){window.removeEventListener("resize",this.resize)}}}).call(e,i("EuP9").Buffer)},"7NZ2":function(t,e){},"7VNn":function(t,e){},"7pAx":function(t,e){},"8+aK":function(t,e){},"8TD5":function(t,e,i){"use strict";(function(t){var s=i("I9+T"),a=i("k5KV"),n=i.n(a),o=i("jyVo"),l=[];l.append=function(t){let e=()=>{var t=l.shift();if(!t)return l.running=!1;l.running=!0,t().then(e).catch(e)};this.push(t),this.running||e()};let r=!1;function c(t,e=t.currentTarget){return t.touches?h(t.touches[0],e):t}function h(t,e){for(var i={x:0,y:0};e.offsetParent;)i.x+=e.offsetLeft,i.y+=e.offsetTop,e=e.offsetParent;return{offsetX:t.clientX-i.x,offsetY:t.clientY-i.y,x:t.clientX,y:t.clientY,shiftKey:t.shiftKey}}e.a={props:["slice","record","roilist","curRois","centerRegion","penColor","position","content","companyid","showMppGuide","cellArea","showLayer"],data(){return{mpp:this.slice.mppx||.242042,scale:1,fullPage:!1,osd:null,company:this.$props.companyid||Object(o.o)().company,viewport:null,paper:null,selectedTool:"choose",dataMapPath:{},offsetWidth:0,offsetHeight:0,curRoi:null,showRoi:!0,showScreenshot:!1,saved:!1,screenshotImages:[],showLabel:!0,knew:!1,drawMpp:!1,userMpp:null,deg:0,lineA:null,lineB:null,uploadData:new Map}},methods:{rotate(){this.deg+=90,this.$refs.rotate.style.transform=`rotate(${this.deg}deg)`},drawCell(){this.$emit("closeMppGuide",!0),this.drawMpp=!0,this.selectedTool="rectangle"},convertPoint(t,e){return this.paper.view.viewToProject(new this.paper.Point(t,e))},initOSD(){let t=OpenSeadragon({element:this.$refs.osd,tileSources:{height:this.slice.height,width:this.slice.width,tileSize:1024,getTileUrl:(t,e,i)=>`/aipath/api/files/slice?x=${e}&y=${i}&z=${t}&caseid=${this.record.id}&fileid=${this.slice.id}&companyid=${this.company}&filename=${encodeURIComponent(this.slice.filename||this.slice.name)}`},minZoomLevel:.001,maxZoomLevel:1e4,visibilityRatio:.01,toolbar:this.$refs.hideToolbar,mouseNavEnabled:!1,animationTime:.8,maxImageCacheCount:12});this.osd=t,this.viewport=t.viewport,this.$emit("viewer",this.viewport),t.activateImagingHelper(),t.addHandler("open",()=>{this.paper=new paper.PaperScope,this.paper.activate(),this.paper.setup(this.$refs.canvas),this.paper.settings.handleSize=8,this.roilistChange(this.roilist||[],[]),this.resized(),this.position.zoom?this.update(this.position,!0):this.buttonClick("home"),t.addHandler("update-viewport",()=>{let t=this.slice.width,{x:e,y:i}=this.viewport.getBounds(!0).getCenter();this.paper.view.setCenter(e*t,i*t),this.paper.view.zoom=this.viewport.viewportToImageZoom(this.viewport.getZoom(!0))})}),this.$refs.osd.addEventListener("contextmenu",this.contextmenu),window.addEventListener("resize",this.resize)},mappAgain(){this.roilist.forEach(t=>{this.$emit("delRoi",t)}),setTimeout(()=>{this.drawCloseRoi()},100)},drawCloseRoi(){let t=n.a.clone(this.record.slices.filter(t=>-1!==t.name.indexOf("痕"))[0].roilist);if(0===t.length)return void this.$message({message:"未检查到ESD数据标注，无法映射",type:"error"});let e=t.map(t=>({x:t.path.x,y:t.path.y,name:t.name}));var i=[];this.record.slices.filter(t=>-1===t.name.indexOf("痕")&&-1===t.name.indexOf("体")).forEach(t=>{i=[...i,...t.roilist]});var s=i.filter(t=>t.hasOwnProperty("esdMessage")),a=[];if(Math.abs(t[0].path.x[0]-t[0].path.x[1])>Math.abs(t[0].path.y[0]-t[0].path.y[1])){e.forEach(t=>{t.x[0]>t.x[1]&&(t.x.reverse(),t.y.reverse())}),e.sort((t,e)=>t.y[0]-e.y[0]);var o=[];e.forEach(t=>{var e=s.find(e=>e.name===t.name);e?o.push(e.esdMessage):o.push([])});var l=[];o.forEach(t=>{1!==t.length?l.push(t.filter(e=>e.startingPointDistance===Math.max.apply(Math,t.map(t=>t.startingPointDistance))||e.startingPointDistance===Math.min.apply(Math,t.map(t=>t.startingPointDistance)))):l.push(t)}),e.forEach((t,e)=>{var i=[],s=new this.paper.Path({strokeWidth:1,strokeColor:"white",strokeScaling:!1,fillColor:"rgba(0,0,0,0.001)"});s.add(new this.paper.Point(this.record.slices.filter(t=>-1!==t.name.indexOf("痕"))[0].roilist.find(e=>e.name===t.name).path.x[0],this.record.slices.filter(t=>-1!==t.name.indexOf("痕"))[0].roilist.find(e=>e.name===t.name).path.y[0])),s.add(new this.paper.Point(this.record.slices.filter(t=>-1!==t.name.indexOf("痕"))[0].roilist.find(e=>e.name===t.name).path.x[1],this.record.slices.filter(t=>-1!==t.name.indexOf("痕"))[0].roilist.find(e=>e.name===t.name).path.y[1])),l[e].forEach(t=>{var e=s.length*t.startingPointDistance/t.totalLength,a=s.length*(t.startingPointDistance+t.intersectionDistance)/t.totalLength,n=s.getPointAt(e),o=s.getPointAt(a);i.push({x:parseInt(n.x),y:parseInt(n.y)}),i.push({x:parseInt(o.x),y:parseInt(o.y)})}),2!=i.length&&0!=i.length&&(i=i.filter(t=>t.x===Math.min.apply(Math,i.map(t=>t.x))||t.x===Math.max.apply(Math,i.map(t=>t.x))))[0].x>i[1].x&&i.reverse(),a.push(i),s.remove()})}else{e.forEach(t=>{t.y[0]>t.y[1]&&(t.x.reverse(),t.y.reverse())}),e.sort((t,e)=>t.x[0]-e.x[0]);o=[];e.forEach(t=>{var e=s.find(e=>e.name===t.name);e?o.push(e.esdMessage):o.push([])});l=[];o.forEach(t=>{1!==t.length?l.push(t.filter(e=>e.startingPointDistance===Math.max.apply(Math,t.map(t=>t.startingPointDistance))||e.startingPointDistance===Math.min.apply(Math,t.map(t=>t.startingPointDistance)))):l.push(t)}),e.forEach((t,e)=>{var i=[],s=new this.paper.Path({strokeWidth:1,strokeColor:"white",strokeScaling:!1,fillColor:"rgba(0,0,0,0.001)"});s.add(new this.paper.Point(this.record.slices.filter(t=>-1!==t.name.indexOf("痕"))[0].roilist.find(e=>e.name===t.name).path.x[0],this.record.slices.filter(t=>-1!==t.name.indexOf("痕"))[0].roilist.find(e=>e.name===t.name).path.y[0])),s.add(new this.paper.Point(this.record.slices.filter(t=>-1!==t.name.indexOf("痕"))[0].roilist.find(e=>e.name===t.name).path.x[1],this.record.slices.filter(t=>-1!==t.name.indexOf("痕"))[0].roilist.find(e=>e.name===t.name).path.y[1])),l[e].forEach(t=>{var e=s.length*t.startingPointDistance/t.totalLength,a=s.length*(t.startingPointDistance+t.intersectionDistance)/t.totalLength,n=s.getPointAt(e),o=s.getPointAt(a);i.push({x:parseInt(n.x),y:parseInt(n.y)}),i.push({x:parseInt(o.x),y:parseInt(o.y)})}),2!=i.length&&0!=i.length&&(i=i.filter(t=>t.y===Math.min.apply(Math,i.map(t=>t.y))||t.y===Math.max.apply(Math,i.map(t=>t.y))))[0].y>i[1].y&&i.reverse(),a.push(i),s.remove()})}var r=[];e.forEach(t=>{r.push(t.x.map((e,i)=>({x:e,y:t.y[i]})))});for(var c={x:[],y:[]},h=0;h<r.length;h++)c.x.push(r[h][0].x),c.y.push(r[h][0].y);for(h=r.length-1;h>=0;h--)c.x.push(r[h][1].x),c.y.push(r[h][1].y);var u={x:[],y:[]};for(h=0;h<a.length;h++)0!=a[h].length&&(u.x.push(a[h][0].x),u.y.push(a[h][0].y));for(h=a.length-1;h>=0;h--)0!=a[h].length&&(u.x.push(a[h][1].x),u.y.push(a[h][1].y));r.forEach(t=>{var e={method:"signLine",path:{x:[t[0].x,t[1].x],y:[t[0].y,t[1].y]}};this.$emit("draw",e)});var d={method:"signArea",path:c};this.$emit("draw",d);var p={method:"redArea",path:u};this.$emit("draw",p)},move(t,e,i){this.$emit("position","number"==typeof t?t:this.position.offx,"number"==typeof e?e:this.position.offy,"number"==typeof i?i:this.position.zoom)},update(t=this.position,e){this.viewport.zoomTo(t.zoom,"",e),this.viewport.panTo({x:t.offx,y:t.offy},e)},resize(){setTimeout(t=>this.resized(this.position.zoom/this.scale),0)},resized(t){this.offsetWidth=this.$refs.osd.offsetWidth,this.offsetHeight=this.$refs.osd.offsetHeight,this.paper.view.viewSize=[this.offsetWidth,this.offsetHeight],this.scale=this.mpp*this.slice.width*Math.min(this.offsetHeight/this.offsetWidth,1)/22e3,this.move(null,null,t?t*this.scale:null),t&&t*this.scale!=this.position.zoom||setTimeout(this.update,80)},navstart(t){if(t.button)return;let e=this.$refs.navigator;var i=t=>{t=c(t),this.move(t.offsetX/e.clientWidth,t.offsetY/e.clientHeight*this.slice.height/this.slice.width)},s=()=>{e.removeEventListener("mousemove",i),e.removeEventListener("touchmove",i),window.removeEventListener("mouseup",s)};e.addEventListener("mousemove",i),e.addEventListener("touchmove",i),window.addEventListener("mouseup",s),i(t)},handleFullScreen(){this.fullPage=!this.fullPage,localStorage.setItem("fullPage",this.fullPage),this.resize()},buttonClick(t){switch(t){case"zoom-in":this.move(null,null,2*this.position.zoom);break;case"zoom-out":this.move(null,null,this.position.zoom/2);break;case"home":let e=this.slice.width/this.slice.height;this.move(.5,.5/e,Math.min(this.offsetHeight/this.offsetWidth*e,1));break;case"original":this.move(null,null,this.slice.width/this.offsetWidth);break;default:this.move(null,null,t)}},path2data:t=>({x:t.map(t=>Math.round(t.point.x)),y:t.map(t=>Math.round(t.point.y))}),equal(t,e){if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(t[i].image!==e[i].image)return!1;return!0},roilistChange(t,e){let i={},s={};t.filter(t=>t.image!=e[t.id]).map(t=>{i[t.id]=t}),e.filter(e=>e.image!=t[e.id]).map(t=>{s[t.id]=t});let a=e.filter(t=>!n.a.equals(t,i[t.id])),o=t.filter(t=>!n.a.equals(t,s[t.id]));if(this.equal(e,t)||a.length!==o.length){for(let t of a)this.dataMapPath[t.id]&&(this.dataMapPath[t.id].text&&(this.dataMapPath[t.id].text.remove(),this.dataMapPath[t.id].rectangle.remove()),this.dataMapPath[t.id].signpenTip&&this.dataMapPath[t.id].signpenTip.remove(),this.dataMapPath[t.id].measureText&&this.dataMapPath[t.id].measureText.remove(),this.dataMapPath[t.id].path.remove(),delete this.dataMapPath[t.id]);for(let t of o)this.newRoi(t);this.slice.roilist.find(t=>this.curRois[t.id])&&this.drawArea(this.slice.roilist.find(t=>this.curRois[t.id])),this.roilist.forEach(t=>{this.showRoi?this.dataMapPath[t.id].path.selected=!!this.curRois[t.id]:this.dataMapPath[t.id].path.selected=!1})}},spliceArray(t){for(var e=void 0,i=0;i<t.x.length-1;i++){var s=t.x[i+1]-t.x[i],a=(t.y[i+1]-t.y[i])/s;(isNaN(e)&&isNaN(a)||a==e)&&(t.x.splice(i,1),t.y.splice(i,1),i--),e=a}return t},newRoi(t={editable:!0,selectable:!0,path:{x:[],y:[]}}){this.viewport.viewportToImageZoom(this.position.zoom);let e,i={};if(this.paper.activate(),t.path.x.length>4&&(t.path=this.spliceArray(t.path)),e="spot"==t.method?new this.paper.Path.Circle({center:[4===t.path.x.length?t.path.x[1]:t.path.x[0],t.path.y[0]],radius:t.radius,strokeScaling:!1,fillColor:t.color,owner:t}):"freepen"==t.method?new this.paper.Path({segments:t.path.x.map((e,i)=>({x:e,y:t.path.y[i]})),strokeWidth:2,fillColor:"rgba(0,0,0,0.001)",strokeColor:t.color||"white",strokeScaling:!1,owner:t,closed:!1}):"signpen"==t.method?new this.paper.Path({segments:t.path.x.map((e,i)=>({x:e,y:t.path.y[i]})),strokeWidth:1,fillColor:"rgba(0,0,0,0.001)",strokeColor:t.color||"white",strokeScaling:!1,owner:t,closed:!1}):"measure"==t.method||"level_measure"==t.method||"verticl_measure"==t.method?new this.paper.Path({segments:t.path.x.map((e,i)=>({x:e,y:t.path.y[i]})),strokeWidth:3,dashArray:[4,10],strokeColor:"yellow",strokeScaling:!1,owner:t}):"circlepen"==t.method?new this.paper.Path({segments:t.path.x.map((e,i)=>({x:e,y:t.path.y[i]})),strokeWidth:2,fillColor:"rgba(0,0,0,0.001)",strokeColor:t.color||"#FF2400",strokeScaling:!1,owner:t,closed:!0}):"redArea"==t.method?new this.paper.Path({segments:t.path.x.map((e,i)=>({x:e,y:t.path.y[i]})),closed:!0,fillColor:"red",opacity:.5,owner:t}):"signArea"==t.method?new this.paper.Path({segments:t.path.x.map((e,i)=>({x:e,y:t.path.y[i]})),strokeWidth:t.width||2,fillColor:"rgba(0,0,0,0.001)",strokeColor:t.color||"black",strokeScaling:!1,owner:t,closed:!0}):"signLine"==t.method?new this.paper.Path({segments:t.path.x.map((e,i)=>({x:e,y:t.path.y[i]})),strokeWidth:t.width||2,fillColor:"rgba(0,0,0,0.001)",strokeColor:t.color||"white",strokeScaling:!1,owner:t,closed:!0}):"crashLine"==t.method?new this.paper.Path({segments:t.path.x.map((e,i)=>({x:e,y:t.path.y[i]})),strokeWidth:2,fillColor:"rgba(0,0,0,0.001)",strokeColor:"black",strokeScaling:!1,owner:t,closed:!0,dashArray:[10,10]}):new this.paper.Path({segments:t.path.x.map((e,i)=>({x:e,y:t.path.y[i]})),strokeWidth:t.width||3,fillColor:"rgba(0,0,0,0.001)",strokeColor:t.color||"yellow",strokeScaling:!1,owner:t,closed:!0}),Object.assign(i,{path:e,dragCenter:!1,dragVertex:!1,dragEdge:!1,resetDragStatus(){this.dragCenter=this.dragVertex=this.dragEdge=!1}}),"freepen"==t.method){var s=this;i.drag=function(t){this.dragVertex?(this.segment.point.x+=t.x,this.segment.point.y+=t.y,i.text&&(i.text.content=this.content?this.content:"面积:"+Math.round(Math.abs(i.path.area)*Math.pow(s.mpp,2))+"μm²")):this.dragCenter&&(this.path.position.x+=t.x,this.path.position.y+=t.y,i.text&&(i.text.position.x+=t.x,i.text.position.y+=t.y,i.rectangle.position.x+=t.x,i.rectangle.position.y+=t.y))},i.checkPath=function(t,e){this.segment=null,this.resetDragStatus(),"segment"==e.type?(this.segment=e.segment,this.dragVertex=!0,i.text&&(i.text.content=this.content?this.content:"面积:"+Math.round(Math.abs(i.path.area)*Math.pow(s.mpp,2))+"μm²")):e.type}}else if("signArea"==t.method||"redArea"==t.method||"signLine"==t.method)i.drag=function(t){this.path.segments.map(e=>{e.point.x+=t.x,e.point.y+=t.y})};else if("rectangle"==t.method){s=this;i.drag=function(t){let e=(t,e)=>Math.abs(t-e)<1e-4;if(this.dragVertex){let a=this.segment.point.x,n=this.segment.point.y,o=a+t.x,l=n+t.y;this.path.segments.map(t=>{t.point.x=e(t.point.x,a)?o:t.point.x,t.point.y=e(t.point.y,n)?l:t.point.y});let r=this.path.segments[0].point.x<this.path.segments[2].point.x?this.path.segments[0].point.x:this.path.segments[2].point.x,c=this.path.segments[0].point.y<this.path.segments[2].point.y?this.path.segments[0].point.y:this.path.segments[2].point.y;i.text.content=this.content?this.content:"面积:"+Math.round(Math.abs(i.path.area)*Math.pow(s.mpp,2))+"μm²";let h=r!=Math.min.apply(null,i.data.path.x),u=c!=Math.min.apply(null,i.data.path.y);h&&!u&&(i.text.position.x+=t.x,i.rectangle.position.x+=t.x),!h&&u&&(i.text.position.y+=t.y,i.rectangle.position.y+=t.y),h&&u&&(i.text.position.y+=t.y,i.rectangle.position.y+=t.y,i.text.position.x+=t.x,i.rectangle.position.x+=t.x)}else if(this.dragEdge){if(e(this.editPt1.x,this.editPt2.x)&&(this.editPt1.x+=t.x,this.editPt2.x+=t.x,i.text)){i.text.content=this.content?this.content:"面积:"+Math.round(Math.abs(i.path.area)*Math.pow(s.mpp,2))+"μm²";let e=i.path.segments[0].point.x>i.path.segments[2].point.x?i.path.segments[0].point.x:i.path.segments[2].point.x;this.editPt1.x<e&&(i.text.position.x+=t.x,i.rectangle.position.x+=t.x)}if(e(this.editPt1.y,this.editPt2.y)&&(this.editPt1.y+=t.y,this.editPt2.y+=t.y,i.text)){i.text.content=this.content?this.content:"面积:"+Math.round(Math.abs(i.path.area)*Math.pow(s.mpp,2))+"μm²";let e=i.path.segments[0].point.y>i.path.segments[2].point.y?i.path.segments[0].point.y:i.path.segments[2].point.y;this.editPt1.y<e&&(i.text.position.y+=t.y,i.rectangle.position.y+=t.y)}}else this.dragCenter&&(this.path.segments.map(e=>{e.point.x+=t.x,e.point.y+=t.y}),i.text&&(i.text.position.x+=t.x,i.text.position.y+=t.y,i.rectangle.position.x+=t.x,i.rectangle.position.y+=t.y))},i.checkPath=function(t,e){if(this.segment=this.editPt1=this.editPt2=null,this.resetDragStatus(),"segment"==e.type)this.segment=e.segment,this.dragVertex=!0;else if("stroke"==e.type){let t=e.location;this.editPt1=t.curve.point1,this.editPt2=t.curve.point2,this.dragEdge=!0}else"fill"==e.type&&(this.dragCenter=!0)}}else if("spot"==t.method)i.drag=function(t){this.path.position.x+=t.x,this.path.position.y+=t.y},i.checkPath=function(t,e){this.segment=null,this.resetDragStatus(),"segment"==e.type?(this.segment=e.segment,this.dragVertex=!0):"fill"==e.type&&(this.dragCenter=!0)};else if("signpen"==t.method){let e=new this.paper.Point({x:t.path.x[1]-t.path.x[0],y:t.path.y[1]-t.path.y[0]}),s=new this.paper.Path.RegularPolygon({center:[t.path.x[1],t.path.y[1]],sides:3,radius:2,fillColor:"white"});s.rotate(Math.abs(e.angle)>90?e.angle-150:e.angle-30),i.signpenTip=s}else if("measure"==t.method||"level_measure"==t.method||"verticl_measure"==t.method){let e=new this.paper.Point({x:t.path.x[1]-t.path.x[0],y:t.path.y[1]-t.path.y[0]}),s=e.normalize(10/this.paper.view.zoom).rotate(Math.abs(e.angle)>90?90:-90),a=new this.paper.PointText({point:{x:(t.path.x[1]+t.path.x[0])/2+s.x,y:(t.path.y[0]+t.path.y[1])/2+s.y},content:Math.round(100*e.length*this.mpp)/100+"μm",justification:"center",fontSize:14/this.paper.view.zoom});a.rotate(Math.abs(e.angle)>90?180+e.angle:e.angle),i.measureText=a}return i.data=t,i.path.visible=this.showRoi,i.path.selected=this.showRoi,this.dataMapPath[t.id]=i,i},drawArea(t){if("circlepen"==t.method||"signArea"==t.method||"redArea"==t.method||"measure"==t.method||"level_measure"==t.method||"verticl_measure"==t.method)return;this.paper.activate();let e=this.dataMapPath[t.id];e.text&&(e.text.remove(),e.rectangle.remove());let i=t.path.x[0],s=t.path.y[0],a=this.viewport.viewportToImageZoom(this.position.zoom);var n={x:i,y:s-30/a},o={x:i,y:s},l=t.name;"rectangle"==t.method&&(l=this.content?this.content:"面积:"+Math.round(Math.abs(e.path.area)*Math.pow(this.mpp,2)+200)+"μm²"),e.text=new this.paper.PointText({point:o,content:l,fillColor:"white",justification:"center",fontSize:14/a});var r=e.text.bounds.width,c=e.text.bounds.height;e.text.bounds.top-=28/a-c,e.text.bounds.left+=r/2+4/a,e.rectangle=new this.paper.Path.Rectangle(n,r+8/a,24/a,4/a),e.rectangle.fillColor="rgba(0,0,0,0.5)",this.paper.project.activeLayer.addChild(e.text),"freepen"==t.method&&(e.text.bounds.left-=r+12/a,e.rectangle.bounds.left-=e.rectangle.bounds.width+4/a),this.showRoi||(e.text.visible=!1,e.rectangle.visible=!1)},contextmenu(t){let e=this.convertPoint(t.offsetX,t.offsetY),i=this.paper.project.hitTest(e,{stroke:!0,segments:!0,fill:!0});i&&(this.$emit("contextmenu",t,i.item.owner),this.selectedTool="choose")},keydown(t){switch(t.key){case"ArrowUp":t.ctrlKey||t.metaKey||this.move(null,this.position.offy-.95*this.viewport.getBounds().height);break;case"ArrowDown":t.ctrlKey||t.metaKey||this.move(null,this.position.offy+.95*this.viewport.getBounds().height);break;case"ArrowLeft":t.ctrlKey||t.metaKey||this.move(this.position.offx-.95*this.viewport.getBounds().width);break;case"ArrowRight":t.ctrlKey||t.metaKey||this.move(this.position.offx+.95*this.viewport.getBounds().width);break;case"Escape":this.fullPage&&this.handleFullScreen();break;case"F":case"f":this.selectedTool="freepen";break;case"R":case"r":break;case"=":this.buttonClick("zoom-in");break;case"-":this.buttonClick("zoom-out");break;case"1":this.buttonClick("home");break;case"2":this.buttonClick(2*this.scale);break;case"3":this.buttonClick(4*this.scale);break;case"4":this.buttonClick(10*this.scale);break;case"5":this.buttonClick(20*this.scale);break;case"6":this.buttonClick(40*this.scale);break;case"7":this.buttonClick("original");break;case"8":this.handleFullScreen();break;case"Escape":this.fullPage&&this.handleFullScreen();break;case"A":case"a":if(t.ctrlKey||t.metaKey){t.preventDefault();let e=this.convertPoint(0,0),i=this.convertPoint(this.offsetWidth,this.offsetHeight),s=this.roilist.filter(t=>t.path.x.every(t=>t>e.x&&t<i.x)&&t.path.y.every(t=>t>e.y&&t<i.y));s.length&&this.$emit("curROI",s,!1)}}},wheel(t){document.querySelector(".openseadragon-canvas").canvas;let e=t.wheelDeltaY>0?1.2:1/1.2;var i=this.viewport.pointFromPixel(new OpenSeadragon.Point(t.offsetX,t.offsetY)),s=this.position;this.move((s.offx-i.x)/e+i.x,(s.offy-i.y)/e+i.y,s.zoom*e)},getDistance(t,e){var i=Math.abs(e.pageX-t.pageX),s=Math.abs(e.pageY-t.pageY);return Math.sqrt(i*i+s*s)},esdscreenshot(t){let e=(i=document.querySelector(".openseadragon-canvas canvas"),s=document.createElement("canvas"),a=s.getContext("2d"),s.width=i.width,s.height=i.height,a.drawImage(i,0,0),s);var i,s,a;let n=document.querySelector(".canvas");e.getContext("2d").drawImage(n,0,0);let o=e.toDataURL("image/jpeg");var l="大体病变图"+(new Date).getTime()+".png";let r=o.split(","),c=window.atob(r[1]),h=r[0].match(/:(.*?);/)[1],u=new Uint8Array(c.length);for(var d=0;d<c.length;d++)u[d]=c.charCodeAt(d);let p=new Blob([u],{type:h}),v=new window.File([p],l,{type:"image/jpeg"}),m=v.size,g={id:Math.floor(1e7*Math.random())+"",filename:v.name,name:v.name,roilist:[],loaded:0,total:m,stain:"",state:4},f=new FormData;f.append("file",v),f.append("caseid",this.record.id),f.append("fileid",g.id),f.append("type","attachment"),f.type="attachment",f.path=v.path,this.record.attachments.unshift(g),this.uploadData.set(g,f),this.upload(g)},async upload(t){var e=this.uploadData.get(t);t.state=4,t.loaded=0,l.append(async()=>{if(!this.$parent._isDestroyed){if(e.path&&e.path.endsWith(".mrxs")){let i=window.require("fs"),s=window.require("path"),a=window.require("http"),n=e.path.slice(0,-5),{name:o}=s.parse(e.path),l=i.readdirSync(n).map(t=>n+"\\"+t),r=l.map(t=>i.statSync(t).size).reduce((t,e)=>t+e);t.total=r,t.state=0;for(let e of l){if(t.deleted)return;await new Promise(n=>{let{base:l}=s.parse(e),r=i.createReadStream(e),c=a.request({host:location.hostname,port:location.port,path:`/aipath/api/files/upload2?caseid=${this.record.id}&fileid=${t.id}&type=slice&filename=${encodeURIComponent(o+"\\"+l)}`,headers:{Cookie:document.cookie,"Content-Type":"application/octet-stream","Transfer-Encoding":"chunked",Connection:"keep-alive"}},n);r.on("data",t=>c.write(t)),r.on("end",e=>c.end()+(t.loaded+=r.bytesRead)),c.on("error",e=>{throw t.state=3,t.loaded=0,console.error(`problem with request: ${e.message}`),e})})}}return t.ajaxToken=Object(o.b)(`files/upload?caseid=${this.record.id}&fileid=${t.id}&type=${e.type}&filename=${t.name}&total=${t.total}`,e,{onUploadProgress:e=>{t.deleted?t.ajaxToken.cancel():(t.total=Math.max(t.total,e.total),t.loaded=Math.max(t.loaded,e.loaded),t.state=0)}}),t.ajaxToken.then(e=>{0==e.code?(t.state=1,Object.assign(t,e.data,{total:t.total,loaded:t.loaded}),this.save("auto")):5==e.code?t.state=5:t.state=2}).catch(e=>{t.state=3,t.loaded=0})}})},async save(t){var e=this.cleanRecord(this.record);this.record.update=e.update=(new Date).toISOString(),await Object(o.b)("records/update",{id:e.id,content:JSON.stringify(e)}).then(t=>{0===t.code?this.$message({message:"采图成功",type:"success"}):this.$message({message:t.message,type:"error"})})},cleanRecord:t=>Object.assign({},t,{slices:t.slices.filter(t=>1==t.state).map(({id:t,name:e,filename:i})=>({id:t,name:e,filename:i})),attachments:t.attachments.filter(t=>1==t.state)}),screenshot(e){let i=(0,window.electron.remote.require)("fs"),s=window.electron.remote.process.argv.filter(t=>-1!=t.indexOf("folder:"))[0].slice(8);s=s.replace('"',"\\");let a=document.querySelector(".openseadragon-canvas canvas"),n=document.querySelector(".canvas");a.getContext("2d").drawImage(n,0,0);let l=a.toDataURL("image/jpeg"),r=t.from(l.substring(l.lastIndexOf(",")+1,l.length),"base64"),c=Object(o.i)(new Date).replace(/[-\s:]/g,"_")+".jpg";i.writeFile(s+c,r,t=>{if(t)console.log(t);else{this.screenshotImages.push(c);let t="";if(this.slice.ki67&&this.slice.ki67.airesult){let e=0,i=0;for(let t in this.slice.ki67.airesult){let s=this.slice.ki67.airesult[t];e+=s.length,i+=s.filter(t=>3==t.type).length}t=(i/e*100).toFixed(2)+"%"}else t="";let e={images:Array.from(new Set(this.screenshotImages)),result:t+""};i.writeFile(s+"index.json",JSON.stringify(e,null,4),t=>{}),this.saved=!0,setTimeout(t=>this.saved=!1,1e3)}})},mapping(){var t=[];this.record.slices.filter(t=>-1===t.name.indexOf("痕")&&-1===t.name.indexOf("体")).forEach(e=>{t=[...t,...e.roilist]});var e=t.filter(t=>t.hasOwnProperty("esdMessage"));0!=e.length?this.esdDraw(e):this.$message({message:"未检查到ESD数据标注，无法映射",type:"error"})},esdDraw(t){var e=this.slice.roilist,i=!1;if(0!=e.length){for(var s={},a=0;a<e.length;a++)t.forEach((t,n)=>{if(e[a].name==t.name){i=!0;var o=new this.paper.Path({strokeWidth:1,strokeColor:"white",strokeScaling:!1,fillColor:"rgba(0,0,0,0.001)"}),l=[];o.add(new this.paper.Point(e[a].path.x[0],e[a].path.y[0])),o.add(new this.paper.Point(e[a].path.x[1],e[a].path.y[1])),t.esdMessage.forEach((t,e)=>{var i=o.length*t.startingPointDistance/t.totalLength,s=o.length*(t.startingPointDistance+t.intersectionDistance)/t.totalLength,a=o.getPointAt(i),n=o.getPointAt(s),r=new this.paper.Path({strokeWidth:5,strokeColor:t.color,strokeScaling:!1,fillColor:"rgba(0,0,0,0.001)"},100);r.add(new this.paper.Point(a)),r.add(new this.paper.Point(n)),l.length&&l.forEach((t,e)=>{if(r.getIntersections(t).length){var i=r.length/2,s=r.getNormalAt(i);s.length=.3*(e+1),r.translate(s)}}),l.push(r)}),o.remove(),s[e[a].id]=l}});this.$emit("addSignLineArr",s),i||this.$message({message:"未检查到相对应的ESD数据标注，请检查名称是否对应",type:"error"})}else this.$message({message:"未标记切痕，请先标记切痕",type:"error"})},spaceShoot(t){"Space"===t.code&&"input"!=t.target.tagName.toLowerCase()&&this.screenshot(t)},getSliceDistance(t){for(var e=0,i=0,s=0;s<t[0].index;s++)e+=this.lineA.curves[s].length;e+=t[0].time*this.lineA.curves[t[0].index].length;for(s=0;s<t[1].index;s++)i+=this.lineA.curves[s].length;return i+=t[1].time*this.lineA.curves[t[1].index].length,this.$emit("addMeasure",parseFloat(Math.round(100*e*this.mpp)/100),"defaultId","level_measure"),this.$emit("addMeasure",parseFloat(Math.round(100*(this.lineA.length-i)*this.mpp)/100),"defaultId","level_measure"),{intersectionDistance:i-e,startingPointDistance:e,iD:Math.round(100*(i-e)*this.mpp)/100+"μm",level_measure_arr:[parseFloat(Math.round(100*e*this.mpp)/100),parseFloat(Math.round(100*(this.lineA.length-i)*this.mpp)/100)]}},getNoIntersectionDistance(t){var e={};if(this.lineA.curves.forEach((i,s)=>{for(var a=i.segment1,n=1;n<=10;n++){var o=[a,i.getPointAt(i.length/10*n)],l=new this.paper.Path(o);l.style={strokeWidth:1,strokeColor:"yellow",strokeScaling:!1,fillColor:"rgba(0,0,0,0.001)"},l.rotate(90),l.scale(150),l.opacity=0,0!==l.getIntersections(t).length&&(e[s]?e[s].push(n):e[s]=[n]),a=i.getPointAt(i.length/10*n)}}),0!==Object.keys(e).length){var i=0,s=0;if(1===Object.keys(e).length){var a=Object.keys(e)[0];if(1===e[Object.keys(e)[0]].length)var n=e[Object.keys(e)[0]][0],o=e[Object.keys(e)[0]][0]+1;else n=e[Object.keys(e)[0]][0],o=e[Object.keys(e)[0]][e[Object.keys(e)].length-1];for(var l=0;l<a;l++)i+=this.lineA.curves[l].length;i+=n/10*this.lineA.curves[a].length;for(l=0;l<a;l++)s+=this.lineA.curves[l].length;s+=o/10*this.lineA.curves[a].length}else{var r=Object.keys(e)[0],c=Object.keys(e)[Object.keys(e).length-1];for(n=e[r][0],o=e[c][e[c].length-1],l=0;l<r;l++)i+=this.lineA.curves[l].length;i+=n/10*this.lineA.curves[r].length;for(l=0;l<c;l++)s+=this.lineA.curves[l].length;s+=o/10*this.lineA.curves[c].length}return this.$emit("addMeasure",parseFloat(Math.round(100*i*this.mpp)/100),"defaultId","level_measure"),this.$emit("addMeasure",parseFloat(Math.round(100*(this.lineA.length-s)*this.mpp)/100),"defaultId","level_measure"),{intersectionDistance:s-i,startingPointDistance:i,iD:Math.round(100*(s-i)*this.mpp)/100+"μm",level_measure_arr:[parseFloat(Math.round(100*i*this.mpp)/100),parseFloat(Math.round(100*(this.lineA.length-s)*this.mpp)/100)]}}this.$message({message:"映射失败，请微调位置重新圈出病变区域",type:"warning"})},nameFreePen(t){var e=[];this.record.slices.filter(t=>-1===t.name.indexOf("痕")&&-1===t.name.indexOf("体")).forEach(t=>{e=[...e,...t.roilist]}),t.name=e.filter(t=>"freepen"===t.method).length+1},contextmenuDisplay(t){2==t.button&&this.lineB&&(t.preventDefault(),this.$refs.circleOpt.style.display="block",this.$refs.circleOpt.style.top=t.offsetY-25+"px",this.$refs.circleOpt.style.left=t.offsetX+10+"px")},setCircleCol(t){var e=t.target.querySelector("i")?t.target.querySelector("i"):t.target;this.$emit("changeEsdRoiColoe",e.style.background,t.target.title,this.lineB.id),this.$refs.circleOpt.style.display="none",this.$emit("curROI",null,!1)},mouseDown(t){this.$refs.osd.querySelector(".openseadragon-canvas").focus(),this.$refs.circleOpt.style.display="none",t.preventDefault(),this.$emit("mousedown");let e=c(t);var i,s,a,n,o=t=>{var o=c(t,this.$refs.osd);if(new paper.Point(v.x-o.x,v.y-o.y).length>5&&(m=!0),f)if(t.touches&&2==t.touches.length){let e=this.viewport.deltaPointsFromPixels(new paper.Point((p.touches[0].clientX+p.touches[1].clientX-t.touches[0].clientX-t.touches[1].clientX)/2,(p.touches[0].clientY+p.touches[1].clientY-t.touches[0].clientY-t.touches[1].clientY)/2)),i=Math.hypot(p.touches[0].clientX-p.touches[1].clientX,p.touches[0].clientY-p.touches[1].clientY),s=Math.hypot(t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY);this.move(this.position.offx+e.x,this.position.offy+e.y,this.position.zoom*s/i)}else{let t=this.viewport.deltaPointsFromPixels(new paper.Point(d.x-o.x,d.y-o.y));this.move(this.position.offx+t.x,this.position.offy+t.y)}else{let t=this.convertPoint(o.x-e.x+e.offsetX,o.y-e.y+e.offsetY);switch(this.selectedTool){case"choose":for(let t in this.curRois){var l=this.dataMapPath[t];if(l.dragCenter||this.curRoi.owner.id==t)if(0!=this.curRois[t].editable){let t=this.convertPoint(0,0),e=this.convertPoint(o.x-d.x,o.y-d.y);if(e.x-=t.x,e.y-=t.y,"rectangle"===l.data.method)l.drag(e);else if("signArea"===l.data.method)for(var r in this.dataMapPath)this.dataMapPath[r].drag(e)}else f=!0}break;case"circlepen":case"freepen":this.curRoi.path.closed=!1,this.curRoi.path.fullySelected=!1,this.curRoi.path.add(t);break;case"rectangle":{let e=this.curRoi.path.segments[0].point;this.curRoi.path.removeSegments(),this.curRoi.path.addSegments([e,new this.paper.Point(t.x,e.y),t,new this.paper.Point(e.x,t.y)]);break}case"level_measure":case"verticl_measure":case"measure":{s&&s.remove(),i&&i.remove(),this.paper.activate(),(s=new this.paper.Path([g,t])).strokeWidth=3,s.dashArray=[4,10],s.strokeScaling=!1,s.strokeColor="yellow";let e=new this.paper.Point({x:t.x-g.x,y:t.y-g.y}),a=e.normalize(10/this.paper.view.zoom).rotate(Math.abs(e.angle)>90?90:-90);(i=new this.paper.PointText({point:{x:(t.x+g.x)/2+a.x,y:(g.y+t.y)/2+a.y},content:Math.round(100*e.length*this.mpp)/100+"μm",justification:"center",fontSize:14/this.paper.view.zoom})).rotate(Math.abs(e.angle)>90?180+e.angle:e.angle);break}case"signpen":{n&&n.remove(),a&&a.remove(),this.paper.activate(),(n=new this.paper.Path([g,t])).strokeWidth=1,n.strokeScaling=!1,n.strokeColor="white";let e=new this.paper.Point({x:t.x-g.x,y:t.y-g.y});(a=new this.paper.Path.RegularPolygon({center:[t.x,t.y],sides:3,radius:2,fillColor:"white"})).rotate(Math.abs(e.angle)>90?e.angle-150:e.angle-30)}}this.paper.view.draw()}d={x:o.x,y:o.y},p=t},l=!1,u=t=>{if(l=!0,window.removeEventListener("mousemove",o),window.removeEventListener("touchmove",o),window.removeEventListener("mouseup",u),window.removeEventListener("touchend",u),this.$refs.osd.removeEventListener("touchstart",_),t=t.changedTouches?h(t.changedTouches[0],this.$refs.osd):t,m){if(f)return;switch(this.selectedTool){case"freepen":{let e=this.curRoi.data;e.color="white",e.path=this.path2data(this.curRoi.path.segments),e.tD=Math.round(100*this.curRoi.path.length*this.mpp)/100+"μm",this.nameFreePen(e),delete this.dataMapPath[this.curRoi.id],this.curRoi.path.remove(),this.curRoi=null,this.$emit("draw",e),this.$emit("curROI",e,t.shiftKey),this.selectedTool="choose";break}case"circlepen":{let t=this.curRoi.data;if(t.path=this.path2data(this.curRoi.path.segments),t.color="#FF2400",this.lineA){var e=this.lineA.getIntersections(this.curRoi.path);if(0==e.length){(c=this.getNoIntersectionDistance(this.curRoi.path))&&(c.totalLength=this.lineA.length,setTimeout(()=>{c.id=t.id,c.color="#FF2400",c.title="高级别上皮内瘤变（包括原位癌）",this.roilist.forEach(t=>{t.id===this.lineA.owner.id&&this.$emit("addEsdMes",t.id,c)})},300))}else{if(1==e.length)return this.$message({message:"只产生了一个交点，请检查圈注",type:"warning"}),delete this.dataMapPath[this.curRoi.id],this.curRoi.path.remove(),this.curRoi=null,void(this.selectedTool="choose");var c;(c=this.getSliceDistance(e)).totalLength=this.lineA.length,setTimeout(()=>{c.id=t.id,c.color="#FF2400",c.title="高级别上皮内瘤变（包括原位癌）",this.roilist.forEach(t=>{t.id===this.lineA.owner.id&&this.$emit("addEsdMes",t.id,c)})},300)}}delete this.dataMapPath[this.curRoi.id],this.curRoi.path.remove(),this.curRoi=null,this.$emit("draw",t),this.selectedTool="choose";break}case"rectangle":{let e=this.curRoi.data;e.path=this.path2data(this.curRoi.path.segments),delete this.dataMapPath[this.curRoi.id],this.drawMpp?(this.userMpp=Math.sqrt((this.cellArea||200)/this.curRoi.path.area).toFixed(4),"NaN"===this.userMpp||"Infinity"===this.userMpp?(this.$alert("您画的roi太小,请选择矩形工具重新画一个"),this.curRoi.path.remove(),this.curRoi=null):(this.drawMpp=!1,this.knew=!0)):(this.curRoi.path.remove(),this.curRoi=null,this.$emit("draw",e),this.$emit("curROI",e,t.shiftKey)),this.selectedTool="choose";break}case"choose":Object.values(this.curRois).map(t=>{"signArea"===t.method?(this.roilist.filter(e=>e.id!=t.id).forEach(t=>{t.path=this.path2data(this.dataMapPath[t.id].path.segments),this.$emit("curROI",[t])}),t.path=this.path2data(this.dataMapPath[t.id].path.segments)):t.path=this.path2data(this.dataMapPath[t.id].path.segments)}),this.$emit("curROI",Object.values(this.curRois)),this.$emit("roiChanged");break;case"measure":{s.remove(),i.remove();let t=this.curRoi.data;t.path=this.path2data(s.segments),delete this.dataMapPath[this.curRoi.id],this.curRoi.path.remove(),this.curRoi=null,this.$emit("draw",t),this.$emit("addMeasure",parseFloat(i.content),t.id,"measure"),this.selectedTool="choose";break}case"level_measure":{s.remove(),i.remove();let t=this.curRoi.data;t.path=this.path2data(s.segments),delete this.dataMapPath[this.curRoi.id],this.curRoi.path.remove(),this.curRoi=null,this.$emit("draw",t),this.$emit("addMeasure",parseFloat(i.content),t.id,"level_measure"),this.selectedTool="choose";break}case"verticl_measure":{s.remove(),i.remove();let t=this.curRoi.data;t.path=this.path2data(s.segments),delete this.dataMapPath[this.curRoi.id],this.curRoi.path.remove(),this.curRoi=null,this.$emit("draw",t),this.$emit("addMeasure",parseFloat(i.content),t.id,"verticl_measure"),this.selectedTool="choose";break}case"signpen":{n.remove(),a.remove();let e=this.curRoi.data;e.color="white",e.path=this.path2data(n.segments),e.name=this.roilist.length+1,delete this.dataMapPath[this.curRoi.id],this.curRoi.path.remove(),this.curRoi=null,this.$emit("draw",e),this.$emit("curROI",e,t.shiftKey),this.selectedTool="choose";break}}}else{let e=this.convertPoint(t.offsetX,t.offsetY);if("choose"==this.selectedTool){let i=this.paper.project.hitTest(e,{stroke:!0,segments:!0,fill:!0,tolerance:2});if(i){if(r)return this.$emit("reverseRoi",null),this.$emit("curROI",null,t.shiftKey),void(r=!1);if("redArea"===i.item.owner.method)return;this.$emit("curROI",i.item.owner,t.shiftKey),(t={offsetX:t.offsetX,offsetY:t.offsetY,type:t.type}).preventDefault||(t.preventDefault=(t=>0)),t.currentTarget=this.$refs.osd,this.$emit("contextmenu",t,i.item.owner)}else this.$emit("curROI",null,t.shiftKey)}else"freepen"!=this.selectedTool&&"rectangle"!=this.selectedTool&&"circlepen"!=this.selectedTool&&"signpen"!=this.selectedTool||(delete this.dataMapPath[this.curRoi.id],this.curRoi.path.remove(),this.curRoi=null,t.shiftKey||(this.selectedTool="choose"))}};if(e.button)return;let d={x:e.x,y:e.y},p=t,v=d,m=!1,g=this.convertPoint(e.offsetX,e.offsetY),f=!1;switch(this.selectedTool){case"choose":{let e=this.paper.project.hitTest(g,{fill:!0,stroke:!0,segments:!0,tolerance:2}),i=Object.values(this.curRois).map(t=>this.dataMapPath[t.id]);i.some(t=>t.path==(e&&e.item))?(this.curRoi=e.item,i.map(t=>{"rectangle"===t.data.method&&t.checkPath(t,e)})):t.touches&&("stylus"==t.touches[0].touchType||t.touches[0].force<1)?(this.selectedTool="freepen",this.curRoi=this.newRoi({path:{x:[g.x],y:[g.y]},method:"freepen",color:this.penColor})):f=!0;break}case"freepen":case"circlepen":case"measure":case"level_measure":case"verticl_measure":case"signpen":case"rectangle":this.curRoi=this.newRoi({path:{x:[g.x],y:[g.y]},method:this.selectedTool})}window.addEventListener("touchmove",o),window.addEventListener("mousemove",o),window.addEventListener("mouseup",u),window.addEventListener("touchend",u);var _=t=>{l||u(t)};this.$refs.osd.addEventListener("touchstart",_)},mouseMove(t){if(this.roilist.forEach(t=>{"crashLine"===t.method&&this.$emit("delRoi",t)}),"crosscurve"===this.selectedTool){let e=this.convertPoint(t.offsetX,t.offsetY);this.$emit("draw",{method:"crashLine",path:{x:[e.x-2e3,e.x+2e3],y:[e.y,e.y]}}),this.$emit("draw",{method:"crashLine",path:{x:[e.x,e.x],y:[e.y-2e3,e.y+2e3]}})}},chooseSFB(t){if(0===t.flag)this.$emit("delRoi",this.dataMapPath["rectangle"+t.id].data);else{var e={id:"rectangle"+t.id,method:"rectangle",path:{x:[Math.round(this.dataMapPath[t.id].path.bounds.center.x-224.345/this.mpp),Math.round(this.dataMapPath[t.id].path.bounds.center.x+224.345/this.mpp),Math.round(this.dataMapPath[t.id].path.bounds.center.x+224.345/this.mpp),Math.round(this.dataMapPath[t.id].path.bounds.center.x-224.345/this.mpp)],y:[Math.round(this.dataMapPath[t.id].path.bounds.center.y-224.345/this.mpp),Math.round(this.dataMapPath[t.id].path.bounds.center.y-224.345/this.mpp),Math.round(this.dataMapPath[t.id].path.bounds.center.y+224.345/this.mpp),Math.round(this.dataMapPath[t.id].path.bounds.center.y+224.345/this.mpp)]}};this.$emit("draw",e)}}},mounted(){let t="/aipath/api/files/getLabel?caseid="+this.record.id+"&fileid="+this.slice.id,e=new Image;if(e.onerror=(()=>this.showLabel=!1),e.src=location.origin+t,this.initOSD(),this.$refs.osd.addEventListener("touchstart",this.mouseDown),this.$refs.navigator.addEventListener("mousedown",this.navstart),this.$refs.navigator.addEventListener("touchstart",this.navstart),window.electron){let t=window.electron.remote.process.argv;if(t.filter(t=>-1!=t.indexOf("No:")).length){t.filter(t=>-1!=t.indexOf("No:"))[0].substring(4)===window.curRecord.id&&(this.showScreenshot=!0)}window.addEventListener("keydown",this.spaceShoot)}0==this.roilist.length&&setTimeout(()=>{-1!==this.slice.name.indexOf("体")&&this.drawCloseRoi()},200)},destroyed(){window.removeEventListener("resize",this.resize),window.removeEventListener("keydown",this.spaceShoot),setTimeout(()=>{this.paper.view.remove(),this.osd.destroy()},1e3)},watch:{position:{handler(t){this.update(t)},deep:!0},selectedTool:{handler(t){switch(t){case"choose":this.$refs.osd.querySelector(".openseadragon-canvas").style.cursor="pointer";break;case"freepen":case"rectangle":case"level_measure":case"verticl_measure":case"measure":this.$refs.osd.querySelector(".openseadragon-canvas").style.cursor="crosshair";break;case"translate":if(!Object.values(this.curRois)[0])return this.$message({message:"没有选择要旋转的标记线",type:"warning"}),void(this.selectedTool="choose");this.$emit("reverseRoi",Object.values(this.curRois)[0]),this.selectedTool="choose",this.$emit("curROI",null,null);break;case"circlepen":if(!this.lineA)return this.$message({message:"没有选择要标注的电子切片",type:"warning"}),void(this.selectedTool="choose");this.$refs.osd.querySelector(".openseadragon-canvas").style.cursor="crosshair"}},deep:!0},"position.zoom":function(){this.$refs.circleOpt.style.display="none",setTimeout(t=>{for(let t in this.curRois)"spot"!=this.curRois[t].method&&this.drawArea(this.curRois[t])},90)},showRoi(t){t?this.$emit("changeShowLayer",!0):(this.$emit("changeShowLayer",!1),this.$refs.circleOpt.style.display="none");for(let e in this.dataMapPath)this.dataMapPath[e].path.visible=!!t,this.dataMapPath[e].path.selected=this.curRois[e]&&t,this.dataMapPath[e].text&&(this.dataMapPath[e].text.visible=!!t,this.dataMapPath[e].rectangle.visible=!!t),this.dataMapPath[e].signpenTip&&(this.dataMapPath[e].signpenTip.visible=!!t);for(let e in this.record.signLineArr)this.record.signLineArr[e].forEach(e=>{e.visible=!!t})},roilist(t,e){this.roilistChange(t,e),this.$refs.circleOpt.style.display="none"},centerRegion([t,e,i,s]){let a,n=1.5*(i-t),o=1.5*(s-e),l=this.slice.width,r=(t+i)/2,c=(e+s)/2;a=n/o>this.offsetWidth/this.offsetHeight?l/n:l/o*this.offsetHeight/this.offsetWidth,this.move(r/l,c/l,Math.min(a,this.position.zoom))},curRois(t){for(var e in this.lineA=null,this.lineB=null,t)"freepen"===t[e].method&&(this.lineA=this.dataMapPath[t[e].id].path),"circlepen"===t[e].method&&(this.lineB=this.dataMapPath[t[e].id].data);this.roilist.forEach(e=>{this.showRoi?(this.dataMapPath[e.id].path.selected=!!t[e.id],t[e.id]&&0!=t[e.id].editable&&this.paper.project.activeLayer.addChild(this.dataMapPath[e.id].path)):this.dataMapPath[e.id].path.selected=!1,this.dataMapPath[e.id].path.visible=!!this.showRoi});for(let t in this.dataMapPath)this.dataMapPath[t].text&&(this.dataMapPath[t].text.remove(),this.dataMapPath[t].rectangle.remove());for(let e in t)"spot"!=t[e].method&&this.drawArea(t[e])}},components:{"v-attactments":s.a},computed:{sliceType:function(){return-1===this.slice.filename.indexOf("痕")&&-1===this.slice.filename.indexOf("体")},mapAgain:function(){return-1!==this.slice.filename.indexOf("大体")&&0!=this.roilist.length}}}}).call(e,i("EuP9").Buffer)},"8VsA":function(t,e,i){t.exports=i.p+"static/img/删除.cc459b5.svg"},"8ZfD":function(t,e){},"8tH+":function(t,e){},"90z+":function(t,e){},"94hp":function(t,e,i){t.exports=i.p+"static/img/logo.50b0d33.svg"},"9Rlj":function(t,e){},"9u13":function(t,e){},"9ywP":function(t,e){},"9z/3":function(t,e){},ApPL:function(t,e,i){t.exports=i.p+"static/img/scan.4599a4a.gif"},B2xp:function(t,e,i){"use strict";var s={data:()=>({showTip:!1,setPsw:""}),methods:{confirmHandle(){this.setPsw?"dyj2017119"!==this.setPsw?this.showTip=!0:this.$emit("confirmBtn"):this.$message.error("密码不能为空")},cancelHandel(){this.setPsw="",this.$emit("cancelBtn")}},props:["title"]},a={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"set-psw"},[i("div",{staticClass:"header"},[t._v("\n      提示\n      "),i("span",{staticClass:"iconfont",on:{click:t.cancelHandel}})]),t._v(" "),i("p",[t._v(t._s(t.title))]),t._v(" "),i("input",{directives:[{name:"model",rawName:"v-model",value:t.setPsw,expression:"setPsw"}],attrs:{type:"password",placeholder:"请输入授权密码"},domProps:{value:t.setPsw},on:{input:function(e){e.target.composing||(t.setPsw=e.target.value)}}}),t._v(" "),t.showTip?i("div",{staticClass:"icons"},[t._v("密码错误")]):t._e(),t._v(" "),i("div",{staticClass:"footer"},[i("button",{staticClass:"save",on:{click:t.confirmHandle}},[t._v("确定")]),t._v(" "),i("button",{on:{click:t.cancelHandel}},[t._v(t._s(t.$t("confirm.quit")))])])])},staticRenderFns:[]};var n=i("VU/8")(s,a,!1,function(t){i("OvwT")},"data-v-411c5647",null);e.a=n.exports},BdLg:function(t,e){},Bzth:function(t,e,i){t.exports=i.p+"static/img/图片.ef2fefb.gif"},C7nT:function(t,e){},CIQl:function(t,e){},DRUA:function(t,e){},DXLA:function(t,e){},Dn4L:function(t,e){},EKta:function(t,e,i){"use strict";e.byteLength=function(t){var e=c(t),i=e[0],s=e[1];return 3*(i+s)/4-s},e.toByteArray=function(t){for(var e,i=c(t),s=i[0],o=i[1],l=new n(function(t,e,i){return 3*(e+i)/4-i}(0,s,o)),r=0,h=o>0?s-4:s,u=0;u<h;u+=4)e=a[t.charCodeAt(u)]<<18|a[t.charCodeAt(u+1)]<<12|a[t.charCodeAt(u+2)]<<6|a[t.charCodeAt(u+3)],l[r++]=e>>16&255,l[r++]=e>>8&255,l[r++]=255&e;2===o&&(e=a[t.charCodeAt(u)]<<2|a[t.charCodeAt(u+1)]>>4,l[r++]=255&e);1===o&&(e=a[t.charCodeAt(u)]<<10|a[t.charCodeAt(u+1)]<<4|a[t.charCodeAt(u+2)]>>2,l[r++]=e>>8&255,l[r++]=255&e);return l},e.fromByteArray=function(t){for(var e,i=t.length,a=i%3,n=[],o=0,l=i-a;o<l;o+=16383)n.push(h(t,o,o+16383>l?l:o+16383));1===a?(e=t[i-1],n.push(s[e>>2]+s[e<<4&63]+"==")):2===a&&(e=(t[i-2]<<8)+t[i-1],n.push(s[e>>10]+s[e>>4&63]+s[e<<2&63]+"="));return n.join("")};for(var s=[],a=[],n="undefined"!=typeof Uint8Array?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",l=0,r=o.length;l<r;++l)s[l]=o[l],a[o.charCodeAt(l)]=l;function c(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=t.indexOf("=");return-1===i&&(i=e),[i,i===e?0:4-i%4]}function h(t,e,i){for(var a,n,o=[],l=e;l<i;l+=3)a=(t[l]<<16&16711680)+(t[l+1]<<8&65280)+(255&t[l+2]),o.push(s[(n=a)>>18&63]+s[n>>12&63]+s[n>>6&63]+s[63&n]);return o.join("")}a["-".charCodeAt(0)]=62,a["_".charCodeAt(0)]=63},EPE3:function(t,e,i){t.exports=i.p+"static/img/继续.dce3e45.svg"},EYQp:function(t,e){},ElZe:function(t,e){},Eq5Q:function(t,e){},EuP9:function(t,e,i){"use strict";(function(t){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 */
var s=i("EKta"),a=i("ujcs"),n=i("sOR5");function o(){return r.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function l(t,e){if(o()<e)throw new RangeError("Invalid typed array length");return r.TYPED_ARRAY_SUPPORT?(t=new Uint8Array(e)).__proto__=r.prototype:(null===t&&(t=new r(e)),t.length=e),t}function r(t,e,i){if(!(r.TYPED_ARRAY_SUPPORT||this instanceof r))return new r(t,e,i);if("number"==typeof t){if("string"==typeof e)throw new Error("If encoding is specified then the first argument must be a string");return u(this,t)}return c(this,t,e,i)}function c(t,e,i,s){if("number"==typeof e)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer?function(t,e,i,s){if(e.byteLength,i<0||e.byteLength<i)throw new RangeError("'offset' is out of bounds");if(e.byteLength<i+(s||0))throw new RangeError("'length' is out of bounds");e=void 0===i&&void 0===s?new Uint8Array(e):void 0===s?new Uint8Array(e,i):new Uint8Array(e,i,s);r.TYPED_ARRAY_SUPPORT?(t=e).__proto__=r.prototype:t=d(t,e);return t}(t,e,i,s):"string"==typeof e?function(t,e,i){"string"==typeof i&&""!==i||(i="utf8");if(!r.isEncoding(i))throw new TypeError('"encoding" must be a valid string encoding');var s=0|v(e,i),a=(t=l(t,s)).write(e,i);a!==s&&(t=t.slice(0,a));return t}(t,e,i):function(t,e){if(r.isBuffer(e)){var i=0|p(e.length);return 0===(t=l(t,i)).length?t:(e.copy(t,0,0,i),t)}if(e){if("undefined"!=typeof ArrayBuffer&&e.buffer instanceof ArrayBuffer||"length"in e)return"number"!=typeof e.length||(s=e.length)!=s?l(t,0):d(t,e);if("Buffer"===e.type&&n(e.data))return d(t,e.data)}var s;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(t,e)}function h(t){if("number"!=typeof t)throw new TypeError('"size" argument must be a number');if(t<0)throw new RangeError('"size" argument must not be negative')}function u(t,e){if(h(e),t=l(t,e<0?0:0|p(e)),!r.TYPED_ARRAY_SUPPORT)for(var i=0;i<e;++i)t[i]=0;return t}function d(t,e){var i=e.length<0?0:0|p(e.length);t=l(t,i);for(var s=0;s<i;s+=1)t[s]=255&e[s];return t}function p(t){if(t>=o())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o().toString(16)+" bytes");return 0|t}function v(t,e){if(r.isBuffer(t))return t.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(t)||t instanceof ArrayBuffer))return t.byteLength;"string"!=typeof t&&(t=""+t);var i=t.length;if(0===i)return 0;for(var s=!1;;)switch(e){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":case void 0:return z(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return N(t).length;default:if(s)return z(t).length;e=(""+e).toLowerCase(),s=!0}}function m(t,e,i){var s=t[e];t[e]=t[i],t[i]=s}function g(t,e,i,s,a){if(0===t.length)return-1;if("string"==typeof i?(s=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),i=+i,isNaN(i)&&(i=a?0:t.length-1),i<0&&(i=t.length+i),i>=t.length){if(a)return-1;i=t.length-1}else if(i<0){if(!a)return-1;i=0}if("string"==typeof e&&(e=r.from(e,s)),r.isBuffer(e))return 0===e.length?-1:f(t,e,i,s,a);if("number"==typeof e)return e&=255,r.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?a?Uint8Array.prototype.indexOf.call(t,e,i):Uint8Array.prototype.lastIndexOf.call(t,e,i):f(t,[e],i,s,a);throw new TypeError("val must be string, number or Buffer")}function f(t,e,i,s,a){var n,o=1,l=t.length,r=e.length;if(void 0!==s&&("ucs2"===(s=String(s).toLowerCase())||"ucs-2"===s||"utf16le"===s||"utf-16le"===s)){if(t.length<2||e.length<2)return-1;o=2,l/=2,r/=2,i/=2}function c(t,e){return 1===o?t[e]:t.readUInt16BE(e*o)}if(a){var h=-1;for(n=i;n<l;n++)if(c(t,n)===c(e,-1===h?0:n-h)){if(-1===h&&(h=n),n-h+1===r)return h*o}else-1!==h&&(n-=n-h),h=-1}else for(i+r>l&&(i=l-r),n=i;n>=0;n--){for(var u=!0,d=0;d<r;d++)if(c(t,n+d)!==c(e,d)){u=!1;break}if(u)return n}return-1}function _(t,e,i,s){i=Number(i)||0;var a=t.length-i;s?(s=Number(s))>a&&(s=a):s=a;var n=e.length;if(n%2!=0)throw new TypeError("Invalid hex string");s>n/2&&(s=n/2);for(var o=0;o<s;++o){var l=parseInt(e.substr(2*o,2),16);if(isNaN(l))return o;t[i+o]=l}return o}function y(t,e,i,s){return B(z(e,t.length-i),t,i,s)}function b(t,e,i,s){return B(function(t){for(var e=[],i=0;i<t.length;++i)e.push(255&t.charCodeAt(i));return e}(e),t,i,s)}function R(t,e,i,s){return b(t,e,i,s)}function C(t,e,i,s){return B(N(e),t,i,s)}function w(t,e,i,s){return B(function(t,e){for(var i,s,a,n=[],o=0;o<t.length&&!((e-=2)<0);++o)i=t.charCodeAt(o),s=i>>8,a=i%256,n.push(a),n.push(s);return n}(e,t.length-i),t,i,s)}function k(t,e,i){return 0===e&&i===t.length?s.fromByteArray(t):s.fromByteArray(t.slice(e,i))}function x(t,e,i){i=Math.min(t.length,i);for(var s=[],a=e;a<i;){var n,o,l,r,c=t[a],h=null,u=c>239?4:c>223?3:c>191?2:1;if(a+u<=i)switch(u){case 1:c<128&&(h=c);break;case 2:128==(192&(n=t[a+1]))&&(r=(31&c)<<6|63&n)>127&&(h=r);break;case 3:n=t[a+1],o=t[a+2],128==(192&n)&&128==(192&o)&&(r=(15&c)<<12|(63&n)<<6|63&o)>2047&&(r<55296||r>57343)&&(h=r);break;case 4:n=t[a+1],o=t[a+2],l=t[a+3],128==(192&n)&&128==(192&o)&&128==(192&l)&&(r=(15&c)<<18|(63&n)<<12|(63&o)<<6|63&l)>65535&&r<1114112&&(h=r)}null===h?(h=65533,u=1):h>65535&&(h-=65536,s.push(h>>>10&1023|55296),h=56320|1023&h),s.push(h),a+=u}return function(t){var e=t.length;if(e<=$)return String.fromCharCode.apply(String,t);var i="",s=0;for(;s<e;)i+=String.fromCharCode.apply(String,t.slice(s,s+=$));return i}(s)}e.Buffer=r,e.SlowBuffer=function(t){+t!=t&&(t=0);return r.alloc(+t)},e.INSPECT_MAX_BYTES=50,r.TYPED_ARRAY_SUPPORT=void 0!==t.TYPED_ARRAY_SUPPORT?t.TYPED_ARRAY_SUPPORT:function(){try{var t=new Uint8Array(1);return t.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===t.foo()&&"function"==typeof t.subarray&&0===t.subarray(1,1).byteLength}catch(t){return!1}}(),e.kMaxLength=o(),r.poolSize=8192,r._augment=function(t){return t.__proto__=r.prototype,t},r.from=function(t,e,i){return c(null,t,e,i)},r.TYPED_ARRAY_SUPPORT&&(r.prototype.__proto__=Uint8Array.prototype,r.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&r[Symbol.species]===r&&Object.defineProperty(r,Symbol.species,{value:null,configurable:!0})),r.alloc=function(t,e,i){return function(t,e,i,s){return h(e),e<=0?l(t,e):void 0!==i?"string"==typeof s?l(t,e).fill(i,s):l(t,e).fill(i):l(t,e)}(null,t,e,i)},r.allocUnsafe=function(t){return u(null,t)},r.allocUnsafeSlow=function(t){return u(null,t)},r.isBuffer=function(t){return!(null==t||!t._isBuffer)},r.compare=function(t,e){if(!r.isBuffer(t)||!r.isBuffer(e))throw new TypeError("Arguments must be Buffers");if(t===e)return 0;for(var i=t.length,s=e.length,a=0,n=Math.min(i,s);a<n;++a)if(t[a]!==e[a]){i=t[a],s=e[a];break}return i<s?-1:s<i?1:0},r.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},r.concat=function(t,e){if(!n(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return r.alloc(0);var i;if(void 0===e)for(e=0,i=0;i<t.length;++i)e+=t[i].length;var s=r.allocUnsafe(e),a=0;for(i=0;i<t.length;++i){var o=t[i];if(!r.isBuffer(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(s,a),a+=o.length}return s},r.byteLength=v,r.prototype._isBuffer=!0,r.prototype.swap16=function(){var t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var e=0;e<t;e+=2)m(this,e,e+1);return this},r.prototype.swap32=function(){var t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var e=0;e<t;e+=4)m(this,e,e+3),m(this,e+1,e+2);return this},r.prototype.swap64=function(){var t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var e=0;e<t;e+=8)m(this,e,e+7),m(this,e+1,e+6),m(this,e+2,e+5),m(this,e+3,e+4);return this},r.prototype.toString=function(){var t=0|this.length;return 0===t?"":0===arguments.length?x(this,0,t):function(t,e,i){var s=!1;if((void 0===e||e<0)&&(e=0),e>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return S(this,e,i);case"utf8":case"utf-8":return x(this,e,i);case"ascii":return I(this,e,i);case"latin1":case"binary":return O(this,e,i);case"base64":return k(this,e,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return A(this,e,i);default:if(s)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),s=!0}}.apply(this,arguments)},r.prototype.equals=function(t){if(!r.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===r.compare(this,t)},r.prototype.inspect=function(){var t="",i=e.INSPECT_MAX_BYTES;return this.length>0&&(t=this.toString("hex",0,i).match(/.{2}/g).join(" "),this.length>i&&(t+=" ... ")),"<Buffer "+t+">"},r.prototype.compare=function(t,e,i,s,a){if(!r.isBuffer(t))throw new TypeError("Argument must be a Buffer");if(void 0===e&&(e=0),void 0===i&&(i=t?t.length:0),void 0===s&&(s=0),void 0===a&&(a=this.length),e<0||i>t.length||s<0||a>this.length)throw new RangeError("out of range index");if(s>=a&&e>=i)return 0;if(s>=a)return-1;if(e>=i)return 1;if(e>>>=0,i>>>=0,s>>>=0,a>>>=0,this===t)return 0;for(var n=a-s,o=i-e,l=Math.min(n,o),c=this.slice(s,a),h=t.slice(e,i),u=0;u<l;++u)if(c[u]!==h[u]){n=c[u],o=h[u];break}return n<o?-1:o<n?1:0},r.prototype.includes=function(t,e,i){return-1!==this.indexOf(t,e,i)},r.prototype.indexOf=function(t,e,i){return g(this,t,e,i,!0)},r.prototype.lastIndexOf=function(t,e,i){return g(this,t,e,i,!1)},r.prototype.write=function(t,e,i,s){if(void 0===e)s="utf8",i=this.length,e=0;else if(void 0===i&&"string"==typeof e)s=e,i=this.length,e=0;else{if(!isFinite(e))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e|=0,isFinite(i)?(i|=0,void 0===s&&(s="utf8")):(s=i,i=void 0)}var a=this.length-e;if((void 0===i||i>a)&&(i=a),t.length>0&&(i<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");s||(s="utf8");for(var n=!1;;)switch(s){case"hex":return _(this,t,e,i);case"utf8":case"utf-8":return y(this,t,e,i);case"ascii":return b(this,t,e,i);case"latin1":case"binary":return R(this,t,e,i);case"base64":return C(this,t,e,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return w(this,t,e,i);default:if(n)throw new TypeError("Unknown encoding: "+s);s=(""+s).toLowerCase(),n=!0}},r.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var $=4096;function I(t,e,i){var s="";i=Math.min(t.length,i);for(var a=e;a<i;++a)s+=String.fromCharCode(127&t[a]);return s}function O(t,e,i){var s="";i=Math.min(t.length,i);for(var a=e;a<i;++a)s+=String.fromCharCode(t[a]);return s}function S(t,e,i){var s=t.length;(!e||e<0)&&(e=0),(!i||i<0||i>s)&&(i=s);for(var a="",n=e;n<i;++n)a+=H(t[n]);return a}function A(t,e,i){for(var s=t.slice(e,i),a="",n=0;n<s.length;n+=2)a+=String.fromCharCode(s[n]+256*s[n+1]);return a}function T(t,e,i){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>i)throw new RangeError("Trying to access beyond buffer length")}function M(t,e,i,s,a,n){if(!r.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>a||e<n)throw new RangeError('"value" argument is out of bounds');if(i+s>t.length)throw new RangeError("Index out of range")}function j(t,e,i,s){e<0&&(e=65535+e+1);for(var a=0,n=Math.min(t.length-i,2);a<n;++a)t[i+a]=(e&255<<8*(s?a:1-a))>>>8*(s?a:1-a)}function F(t,e,i,s){e<0&&(e=4294967295+e+1);for(var a=0,n=Math.min(t.length-i,4);a<n;++a)t[i+a]=e>>>8*(s?a:3-a)&255}function P(t,e,i,s,a,n){if(i+s>t.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function E(t,e,i,s,n){return n||P(t,0,i,4),a.write(t,e,i,s,23,4),i+4}function L(t,e,i,s,n){return n||P(t,0,i,8),a.write(t,e,i,s,52,8),i+8}r.prototype.slice=function(t,e){var i,s=this.length;if(t=~~t,e=void 0===e?s:~~e,t<0?(t+=s)<0&&(t=0):t>s&&(t=s),e<0?(e+=s)<0&&(e=0):e>s&&(e=s),e<t&&(e=t),r.TYPED_ARRAY_SUPPORT)(i=this.subarray(t,e)).__proto__=r.prototype;else{var a=e-t;i=new r(a,void 0);for(var n=0;n<a;++n)i[n]=this[n+t]}return i},r.prototype.readUIntLE=function(t,e,i){t|=0,e|=0,i||T(t,e,this.length);for(var s=this[t],a=1,n=0;++n<e&&(a*=256);)s+=this[t+n]*a;return s},r.prototype.readUIntBE=function(t,e,i){t|=0,e|=0,i||T(t,e,this.length);for(var s=this[t+--e],a=1;e>0&&(a*=256);)s+=this[t+--e]*a;return s},r.prototype.readUInt8=function(t,e){return e||T(t,1,this.length),this[t]},r.prototype.readUInt16LE=function(t,e){return e||T(t,2,this.length),this[t]|this[t+1]<<8},r.prototype.readUInt16BE=function(t,e){return e||T(t,2,this.length),this[t]<<8|this[t+1]},r.prototype.readUInt32LE=function(t,e){return e||T(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},r.prototype.readUInt32BE=function(t,e){return e||T(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},r.prototype.readIntLE=function(t,e,i){t|=0,e|=0,i||T(t,e,this.length);for(var s=this[t],a=1,n=0;++n<e&&(a*=256);)s+=this[t+n]*a;return s>=(a*=128)&&(s-=Math.pow(2,8*e)),s},r.prototype.readIntBE=function(t,e,i){t|=0,e|=0,i||T(t,e,this.length);for(var s=e,a=1,n=this[t+--s];s>0&&(a*=256);)n+=this[t+--s]*a;return n>=(a*=128)&&(n-=Math.pow(2,8*e)),n},r.prototype.readInt8=function(t,e){return e||T(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},r.prototype.readInt16LE=function(t,e){e||T(t,2,this.length);var i=this[t]|this[t+1]<<8;return 32768&i?4294901760|i:i},r.prototype.readInt16BE=function(t,e){e||T(t,2,this.length);var i=this[t+1]|this[t]<<8;return 32768&i?4294901760|i:i},r.prototype.readInt32LE=function(t,e){return e||T(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},r.prototype.readInt32BE=function(t,e){return e||T(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},r.prototype.readFloatLE=function(t,e){return e||T(t,4,this.length),a.read(this,t,!0,23,4)},r.prototype.readFloatBE=function(t,e){return e||T(t,4,this.length),a.read(this,t,!1,23,4)},r.prototype.readDoubleLE=function(t,e){return e||T(t,8,this.length),a.read(this,t,!0,52,8)},r.prototype.readDoubleBE=function(t,e){return e||T(t,8,this.length),a.read(this,t,!1,52,8)},r.prototype.writeUIntLE=function(t,e,i,s){(t=+t,e|=0,i|=0,s)||M(this,t,e,i,Math.pow(2,8*i)-1,0);var a=1,n=0;for(this[e]=255&t;++n<i&&(a*=256);)this[e+n]=t/a&255;return e+i},r.prototype.writeUIntBE=function(t,e,i,s){(t=+t,e|=0,i|=0,s)||M(this,t,e,i,Math.pow(2,8*i)-1,0);var a=i-1,n=1;for(this[e+a]=255&t;--a>=0&&(n*=256);)this[e+a]=t/n&255;return e+i},r.prototype.writeUInt8=function(t,e,i){return t=+t,e|=0,i||M(this,t,e,1,255,0),r.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),this[e]=255&t,e+1},r.prototype.writeUInt16LE=function(t,e,i){return t=+t,e|=0,i||M(this,t,e,2,65535,0),r.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):j(this,t,e,!0),e+2},r.prototype.writeUInt16BE=function(t,e,i){return t=+t,e|=0,i||M(this,t,e,2,65535,0),r.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):j(this,t,e,!1),e+2},r.prototype.writeUInt32LE=function(t,e,i){return t=+t,e|=0,i||M(this,t,e,4,4294967295,0),r.TYPED_ARRAY_SUPPORT?(this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t):F(this,t,e,!0),e+4},r.prototype.writeUInt32BE=function(t,e,i){return t=+t,e|=0,i||M(this,t,e,4,4294967295,0),r.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):F(this,t,e,!1),e+4},r.prototype.writeIntLE=function(t,e,i,s){if(t=+t,e|=0,!s){var a=Math.pow(2,8*i-1);M(this,t,e,i,a-1,-a)}var n=0,o=1,l=0;for(this[e]=255&t;++n<i&&(o*=256);)t<0&&0===l&&0!==this[e+n-1]&&(l=1),this[e+n]=(t/o>>0)-l&255;return e+i},r.prototype.writeIntBE=function(t,e,i,s){if(t=+t,e|=0,!s){var a=Math.pow(2,8*i-1);M(this,t,e,i,a-1,-a)}var n=i-1,o=1,l=0;for(this[e+n]=255&t;--n>=0&&(o*=256);)t<0&&0===l&&0!==this[e+n+1]&&(l=1),this[e+n]=(t/o>>0)-l&255;return e+i},r.prototype.writeInt8=function(t,e,i){return t=+t,e|=0,i||M(this,t,e,1,127,-128),r.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),t<0&&(t=255+t+1),this[e]=255&t,e+1},r.prototype.writeInt16LE=function(t,e,i){return t=+t,e|=0,i||M(this,t,e,2,32767,-32768),r.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):j(this,t,e,!0),e+2},r.prototype.writeInt16BE=function(t,e,i){return t=+t,e|=0,i||M(this,t,e,2,32767,-32768),r.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):j(this,t,e,!1),e+2},r.prototype.writeInt32LE=function(t,e,i){return t=+t,e|=0,i||M(this,t,e,4,2147483647,-2147483648),r.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24):F(this,t,e,!0),e+4},r.prototype.writeInt32BE=function(t,e,i){return t=+t,e|=0,i||M(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),r.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):F(this,t,e,!1),e+4},r.prototype.writeFloatLE=function(t,e,i){return E(this,t,e,!0,i)},r.prototype.writeFloatBE=function(t,e,i){return E(this,t,e,!1,i)},r.prototype.writeDoubleLE=function(t,e,i){return L(this,t,e,!0,i)},r.prototype.writeDoubleBE=function(t,e,i){return L(this,t,e,!1,i)},r.prototype.copy=function(t,e,i,s){if(i||(i=0),s||0===s||(s=this.length),e>=t.length&&(e=t.length),e||(e=0),s>0&&s<i&&(s=i),s===i)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("sourceStart out of bounds");if(s<0)throw new RangeError("sourceEnd out of bounds");s>this.length&&(s=this.length),t.length-e<s-i&&(s=t.length-e+i);var a,n=s-i;if(this===t&&i<e&&e<s)for(a=n-1;a>=0;--a)t[a+e]=this[a+i];else if(n<1e3||!r.TYPED_ARRAY_SUPPORT)for(a=0;a<n;++a)t[a+e]=this[a+i];else Uint8Array.prototype.set.call(t,this.subarray(i,i+n),e);return n},r.prototype.fill=function(t,e,i,s){if("string"==typeof t){if("string"==typeof e?(s=e,e=0,i=this.length):"string"==typeof i&&(s=i,i=this.length),1===t.length){var a=t.charCodeAt(0);a<256&&(t=a)}if(void 0!==s&&"string"!=typeof s)throw new TypeError("encoding must be a string");if("string"==typeof s&&!r.isEncoding(s))throw new TypeError("Unknown encoding: "+s)}else"number"==typeof t&&(t&=255);if(e<0||this.length<e||this.length<i)throw new RangeError("Out of range index");if(i<=e)return this;var n;if(e>>>=0,i=void 0===i?this.length:i>>>0,t||(t=0),"number"==typeof t)for(n=e;n<i;++n)this[n]=t;else{var o=r.isBuffer(t)?t:z(new r(t,s).toString()),l=o.length;for(n=0;n<i-e;++n)this[n+e]=o[n%l]}return this};var D=/[^+\/0-9A-Za-z-_]/g;function H(t){return t<16?"0"+t.toString(16):t.toString(16)}function z(t,e){var i;e=e||1/0;for(var s=t.length,a=null,n=[],o=0;o<s;++o){if((i=t.charCodeAt(o))>55295&&i<57344){if(!a){if(i>56319){(e-=3)>-1&&n.push(239,191,189);continue}if(o+1===s){(e-=3)>-1&&n.push(239,191,189);continue}a=i;continue}if(i<56320){(e-=3)>-1&&n.push(239,191,189),a=i;continue}i=65536+(a-55296<<10|i-56320)}else a&&(e-=3)>-1&&n.push(239,191,189);if(a=null,i<128){if((e-=1)<0)break;n.push(i)}else if(i<2048){if((e-=2)<0)break;n.push(i>>6|192,63&i|128)}else if(i<65536){if((e-=3)<0)break;n.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;n.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return n}function N(t){return s.toByteArray(function(t){if((t=function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}(t).replace(D,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function B(t,e,i,s){for(var a=0;a<s&&!(a+i>=e.length||a>=t.length);++a)e[a+i]=t[a];return a}}).call(e,i("DuR2"))},F0Cz:function(t,e){},FVWE:function(t,e){},FcKU:function(t,e,i){t.exports=i.p+"static/img/自由排除-d.d759dc1.svg"},Fd67:function(t,e){},FdeP:function(t,e,i){t.exports=i.p+"static/img/point.4b98629.svg"},FsJv:function(t,e){},"Ga4/":function(t,e){},GiBN:function(t,e){},HJaG:function(t,e,i){t.exports=i.p+"static/img/关闭.a9102f6.png"},HS3L:function(t,e,i){t.exports=i.p+"static/img/logo.50b0d33.svg"},"I9+T":function(t,e,i){"use strict";i("jyVo");var s={data(){return{basic:this.$props.record.basic,isOpen:!1,checked:"basicMessage",isBig:!1}},methods:{toggleBig:function(){this.isBig=!this.isBig},download(t,e,i){window.location.href=`/aipath/api/files/attachment?caseid=${t}&fileid=${e}&filename=${i}`}},computed:{gender(){let t=window.localStorage.getItem("localeLanguage");return"zh"==t?{"男":"男","女":"女","其他":"其他"}:"en"==t?{"男":"M","女":"F","其他":"O"}:void 0}},props:["record"]},a={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"container"},[i("div",{staticClass:"open-message",attrs:{title:t.$t("basic.basic")},on:{click:function(e){t.isOpen=!t.isOpen}}}),t._v(" "),t.isOpen?i("div",{class:{"case-bigger":t.isBig,"case-message":!t.isBig}},[i("h1",[i("span",{class:{"cur-checked":"basicMessage"==t.checked},on:{click:function(e){t.checked="basicMessage"}}},[t._v(t._s(t.$t("basic.message")))]),t._v(" "),i("span",{class:{"cur-checked":"attachment"==t.checked},on:{click:function(e){t.checked="attachment"}}},[t._v(t._s(t.$t("basic.attactment")))]),t._v(" "),i("i",{staticClass:"close",on:{click:function(e){t.isOpen=!1}}}),i("i",{staticClass:"scale",class:{"bg-blue":t.isBig},on:{click:function(e){return t.toggleBig()}}})]),t._v(" "),i("div",{staticClass:"message-content"},["attachment"==t.checked?i("div",[i("ul",t._l(t.record.attachments.filter(function(t){return 1==t.state}),function(e){return i("li",{key:e.id},[i("a",{ref:"attachment",refInFor:!0,attrs:{title:e.name},on:{click:function(i){return t.download(t.record.id,e.id,e.name)}}},[t._v(t._s(e.name))])])}),0)]):t._e(),t._v(" "),"basicMessage"==t.checked?i("div",[i("div",{staticClass:"basics"},[i("h1",[t._v(t._s(t.$t("basic.basic")))]),t._v(" "),i("ul",[i("li",[i("dl",[i("dt",[t._v(t._s(t.$t("basic.age")))]),i("dd",[t._v(t._s(t.basic.age))])]),i("dl",[i("dt",[t._v(t._s(t.$t("basic.sex")))]),i("dd",[t._v(t._s(t.gender[t.basic.gender]))])])]),t._v(" "),i("li",[i("dl",{staticStyle:{width:"100%"}},[i("dt",{attrs:{title:t.$t("basic.cancerTypeTitle")}},[t._v(t._s(t.$t("basic.cancerType")))]),i("dd",[t._v(t._s(t.basic.cancerType))])])]),t._v(" "),i("li",[i("dl",{staticStyle:{width:"100%"}},[i("dt",{attrs:{title:t.$t("basic.familyHistoryTitle")}},[t._v(t._s(t.$t("basic.familyHistory")))]),i("dd",[t._v(t._s(t.basic.familyHistory))])])]),t._v(" "),i("li",[i("dl",{staticStyle:{width:"100%"}},[i("dt",{attrs:{title:t.$t("basic.medicalHistoryTitle")}},[t._v(t._s(t.$t("basic.medicalHistory")))]),i("dd",[t._v(t._s(t.basic.medicalHistory))])])])])]),t._v(" "),i("div",{staticClass:"basics"},[i("h1",[t._v(t._s(t.$t("basic.sample")))]),t._v(" "),i("ul",[i("li",[i("dl",{staticStyle:{width:"100%"}},[i("dt",{attrs:{title:t.$t("basic.samplePartTitle")}},[t._v(t._s(t.$t("basic.samplePart")))]),i("dd",[t._v(t._s(t.basic.samplePart))])])]),t._v(" "),i("li",[i("dl",{staticStyle:{width:"100%"}},[i("dt",{attrs:{title:t.$t("basic.sampleTypeTitle")}},[t._v(t._s(t.$t("basic.sampleType")))]),i("dd",[t._v(t._s(t.basic.sampleType))])])]),t._v(" "),i("li",[i("dl",{staticStyle:{width:"100%"}},[i("dt",[t._v(t._s(t.$t("basic.generallySeen")))]),i("dd",[t._v(t._s(t.basic.generallySeen))])])])])])]):t._e()])]):t._e()])},staticRenderFns:[]};var n=i("VU/8")(s,a,!1,function(t){i("l7ju")},"data-v-a17105bc",null);e.a=n.exports},IIUn:function(t,e){},IVJQ:function(t,e,i){t.exports=i.p+"static/img/scan.06a1e81.jpg"},"Ii/p":function(t,e){},Iiwt:function(t,e){},Ilek:function(t,e){},IrGs:function(t,e){},JCuE:function(t,i,s){"use strict";var a=s("jyVo"),n={data:()=>({}),methods:{userInfo:a.o,imgPreview(t){if(window.FileReader)var i=new FileReader;else this.$alert(e.message,{confirmButtonText:this.$t("signature.updateEquipment")});var s=document.getElementById("imageFile").files[0];s.size/1024/1024>5?this.$message.error("文件大小不能超过5MB"):(i.onload=function(t){document.getElementById("preview").src=t.target.result},i.readAsDataURL(s))},upload(){let t=new FormData;t.append("sign",this.$refs.file.files[0]),Object(a.b)("user/updateSign",t),this.$emit("close")},cancleUpload:function(){this.$emit("close")}}},o={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"sign-bg"},[i("div",{staticClass:"sign-content"},[i("div",{staticClass:"headerFloat"},[t._v("\n      "+t._s(t.$t("signature.title"))+"\n      "),i("span",{staticClass:"iconfont",on:{click:function(e){return t.cancleUpload()}}})]),t._v(" "),i("div",{staticClass:"img-content"},[i("div",{attrs:{id:"uploadimg"}},[i("div",{staticClass:"uploader-list",attrs:{id:"fileList"}},[i("img",{attrs:{id:"preview",src:"/aipath/api/user/sign?id="+t.userInfo().username+"&"+Math.random()}})]),t._v(" "),i("div",{staticClass:"imgPicker have-img"},[i("form",{attrs:{id:"imgFile"}},[t._v("\n            "+t._s(t.$t("signature.changeSignature"))+"\n            "),i("input",{ref:"file",attrs:{type:"file",id:"imageFile",name:"file",accept:"image/jpeg,image/png,image/bmp"},on:{change:function(e){return t.imgPreview(e.currentTarget)}}})])])])]),t._v(" "),i("div",{staticClass:"footer"},[i("button",{on:{click:function(e){return t.cancleUpload()}}},[t._v(t._s(t.$t("confirm.quit")))]),t._v(" "),i("button",{attrs:{id:"ctlBtn"},on:{click:function(e){return t.upload()}}},[t._v(t._s(t.$t("confirm.confirm")))])])])])},staticRenderFns:[]};var l=s("VU/8")(n,o,!1,function(t){s("Ga4/")},"data-v-69f0cfc4",null).exports,r=s("B2xp"),c={data:()=>({user:Object(a.o)(),isChange:!1,home:!1,oldPassword:"",newPassword:"",newPasswordSure:"",reg:/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{6,32}$/,showSettingAIParam:!1,showSetting:!1,labelcheck:4,ajustType:"tct",defaultTctThreshold:0,defaultLctThreshold:0,curParam:{},tctParam:{},lctParam:{},dnaParam:{},loading:!1,showTrial:!1,trialTimes:[],analyseThreshold:{},onTrial:0,demoModeValue:"1"==localStorage.getItem("demoMode")||!1,showMsg:!1,showTipTxt:!1,showTips:!1,showSetPsw:!1,showTip:!1,pwsType:"",setPsw:"",electron:window.electron,showBuble:!1,curTime:(new Date).getTime(),remainMemory:0,memoryRoot:null,clearTime:"",pickerOptions:{disabledDate:t=>t.getTime()>Date.now()-864e4},recordCount:0,showMemoryBox:!1,smoothImg:null,smoothValue:.01,all_use:0,correctData:{}}),methods:{changeTab(t){switch(this.ajustType=t,t){case"tct":this.curParam=this.tctParam,this.getAnalyseThreshold();break;case"lct":this.curParam=this.lctParam,this.getAnalyseThreshold();break;case"pdl1":this.getSmoothValue();break;case"dna":this.curParam=this.dnaParam,this.getAnalyseThreshold()}},modifySmoothValue(t){"plus"===t?this.smoothValue<.05?(this.smoothValue+=.01,this.getImg()):this.$message.warning("不能再加了"):this.smoothValue>.01?(this.smoothValue=Number((this.smoothValue-.01).toFixed(2)),this.getImg()):this.$message.warning("不能再减了")},downloadTem(){window.location.href=`/aipath/api/files/downloadTemplate?name=${encodeURIComponent("调参模板.xlsx")}`},imgPreview(t){var e=t.files[0];if(e.size/1024/1024>10)return void this.$message.error("文件大小不能超过10MB");let i=new FormData;i.append("file",e),Object(a.b)("ai/uploadDoc",i).then(t=>{t.code?this.$message.error(t.message):this.getImg(),this.$refs.smoothfile.value=""})},getImg(){Object(a.b)("ai/getFittingCurve",{smooth_value:this.smoothValue}).then(t=>{t.code?this.$message.error(t.message):this.smoothImg=t.img})},resetModelCalibration(){this.$confirm("模型将恢复到初始状态，操作后不可撤回，确定要重置吗？","提示").then(()=>{Object(a.b)("ai/resetModelCalibration").then(t=>{t.code?this.$message.error(t.message):this.$message.success("操作成功")})}).catch(t=>t)},resetSmooth(){Object(a.b)("ai/clearParameter").then(t=>{t.code?this.$message.error(t.message):(this.smoothImg=null,this.smoothValue=.01)})},getSmoothValue(){Object(a.b)("ai/getParameter").then(t=>{t.code?this.$message.error(t.message):(this.smoothImg=t.img,this.smoothValue=t.smooth_value)})},getMemory:()=>new Promise(t=>{Object(a.b)("manage/remainingSpace").then(({data:e})=>{t(e.remainingSpace)})}),timeChange(t){Object(a.b)("manage/recordCount",{closing_date:t}).then(({data:t})=>{this.recordCount=t.recordCount})},clearCase(){this.recordCount?this.$confirm("删除后数据无法恢复，确认继续吗？").then(()=>{Object(a.b)("manage/freeUpSpace",{closing_date:this.clearTime}).then(async()=>{this.remainMemory=await this.getMemory(),this.$emit("updateList"),this.clearTime="",this.recordCount=0,this.showMemoryBox=!1})}).catch(t=>t):this.$message.error("请选择病例")},timing(){this.curTime=(new Date).getTime(),this.user.is_test&&setTimeout(this.timing,864e5)},async openSeting(){"param"===this.pwsType?(this.ajustType="tct",this.tctParam=this.curParam=await this.getThreshold("tct"),this.changeTab("tct"),this.lctParam=await this.getThreshold("lct"),this.dnaParam=await this.getThreshold("dna"),this.showSettingAIParam=!0,this.showSetting=!1,this.showSetPsw=!1,this.setPsw=""):"control"===this.pwsType?(this.showSetting=!1,this.showSetPsw=!1,this.setPsw="",this.electron.remote.getCurrentWindow().toggleDevTools()):this.$message.error("出什么事了")},changeMode(t){console.log("changeMode")},setType(t){this.pwsType=t,this.showSetPsw=!0,this.showMsg=!1},async showTrialMan(){await this.getTrialTimes(),this.home=!1,this.showTrial=!0},getTrialTimes(){Object(a.b)("manage/get_trial_times").then(({data:t})=>{this.onTrial=t.onTrial;let e=JSON.parse(t.model_lis),i=JSON.parse(t.trialTimes);if(this.onTrial){this.trialTimes=[];for(let t in i)e.includes(t)&&this.trialTimes.push({key:t,times:i[t]})}})},settingOpen(){Object(a.b)("ai/getLabel").then(t=>{this.demoModeValue="1"==localStorage.getItem("demoMode")||!1,this.labelcheck=t.data,this.home=!1,this.showSetting=!0})},orcSave(){localStorage.correctData=JSON.stringify(this.correctData),Object(a.b)("ai/modifyLabel",{label:this.labelcheck}).then(t=>{this.demoModeValue?localStorage.setItem("demoMode","1"):localStorage.setItem("demoMode","0"),this.$emit("updateList"),this.$message.success("保存成功"),this.showSetting=!1}).catch(t=>{this.$message.error(t.message)})},async cancel(){this.showSettingAIParam=!1},apply(){this.$confirm('确定应用新参数吗？<span style="color:#f00">正在处理的切片将不受新参数影响。</span>',"提示",{cancelButtonText:"取消",confirmButtonText:"确定",dangerouslyUseHTMLString:!0,type:"warning"}).then(()=>{if("pdl1"!=this.ajustType){this.loading=!0;let t=Object.assign({},this.curParam,{algor_type:this.ajustType,threshold_value:this.curParam.threshold_value/100});Object(a.b)(`manage/saveAiThreshold?companyid=${this.user.company}`,t).then(t=>{this.loading=!1,this.$message.success("应用成功"),this.showSettingAIParam=!1,this.$emit("updateList")}).catch(t=>{this.loading=!1,this.$message.error(t.message)})}else this.loading=!0,Object(a.b)("ai/changeTps",{smooth_value:this.smoothValue,all_use:Number(this.all_use)}).then(t=>{this.loading=!1,this.$message.success("应用成功"),this.showSettingAIParam=!1,this.$emit("updateList")}).catch(t=>{this.loading=!1,this.$message.error(t.message)})}).catch(()=>{this.loading=!1})},seset(){Object(a.b)(`manage/getDefaultAiThreshold?companyid=${this.user.company}`,{algor_type:this.ajustType}).then(t=>{this.$set(this.curParam,"threshold_value",100*t.data),this.getAnalyseThreshold(),this.$message.success("设置成功")}).catch(t=>{this.loading=!1,this.$message.error(t.message)})},getThreshold(t){return new Promise(e=>{Object(a.b)(`manage/getAiThreshold?companyid=${this.user.company}`,{algor_type:t}).then(t=>{e(Object.assign({},t.data,{threshold_value:100*t.data.threshold_value}))}).catch(()=>e({}))})},getAnalyseThreshold(){Object(a.b)("ai/analyseThreshold",{threshold:this.curParam.threshold_value/100,type:this.ajustType,mode:this.curParam.threshold_range?"all":"part"}).then(t=>{this.analyseThreshold=t.data})},barChange(t){this.getAnalyseThreshold()},quit(){this.isStart?this.$alert("高通量运行状态下无法退出登录，请停止高通量后重试。","提示",{confirmButtonText:"确定",callback:t=>{this.home=!1}}):this.$confirm(this.$t("personal.confirmQiut"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{localStorage.setItem("demoMode","0"),document.cookie="jwt=; expires=Thu, 01 Jan 1970 00:00:00 GMT",this.$router.push("/login")}).catch(()=>{this.home=!1})},clearCache(){this.$confirm("确定清除缓存？",{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{Object(a.b)("files/delJunkFile").then(()=>{this.home=!1})}).catch(()=>{})},shutdown(){this.$confirm("确定关机吗",{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{Object(a.b)("manage/shutdown").then(t=>{this.$message({message:"服务器将在10秒后关闭,服务不再可用！",type:"warning"})})}).catch(()=>{this.home=!1})},reboot(){this.$confirm("确定重启吗",{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{Object(a.b)("manage/reboot").then(t=>{this.$message({message:"服务器将在立刻重启,服务不再可用！",type:"warning"})})}).catch(()=>{this.home=!1})},closeSign(){this.$emit("closeSign"),this.home=!1},noBg:function(){this.home=!1},toogleHome:function(){this.home=!this.home},changePsw(){this.isChange=!0,this.home=!1},confirmPsw(){this.oldPassword&&this.newPassword&&this.newPasswordSure&&this.reg.test(this.newPassword)&&this.oldPassword!=this.newPassword&&this.newPasswordSure==this.newPassword&&Object(a.b)("user/updatePassword",{password:this.oldPassword,newPassword:this.newPassword}).then(t=>{this.$alert(this.$t("changepassword.success"),{confirmButtonText:this.$t("confirm.confirm")}),this.isChange=!1,this.home=!1,this.oldPassword="",this.newPassword="",this.newPasswordSure=""}).catch(t=>{1==t.code?this.$alert(this.$t("changepassword.wrong"),{confirmButtonText:this.$t("confirm.confirm")}):3==t.code?this.$alert("旧密码错误",{confirmButtonText:this.$t("confirm.confirm")}):this.$alert(t.message,{confirmButtonText:this.$t("confirm.confirm")})})},qiutPsw(){this.isChange=!1,this.home=!1,this.oldPassword="",this.newPassword="",this.newPasswordSure=""},addImg:function(){this.home=!1,this.$emit("showSign")},backStage(){this.isStart?this.$alert("高通量运行状态下无法进入后台管理，请停止高通量后重试。","提示",{confirmButtonText:"确定",callback:t=>{this.home=!1}}):"sa"==this.user.role?this.$router.push("/manage"):"admin"==this.user.role&&this.$router.push({path:"/admin",query:{data:this.user.company}})}},async created(){this.getAnalyseThreshold(),this.getTrialTimes(),this.timing(),this.remainMemory=await this.getMemory(),this.memoryRoot=setInterval(async()=>{this.remainMemory=await this.getMemory()},3e5),localStorage.correctData?this.correctData=JSON.parse(localStorage.correctData):(this.correctData={x:0,y:0,z:0},localStorage.correctData=JSON.stringify({x:0,y:0,z:0}))},computed:{isNearExpires(){let t=this.user.time_out+" 23:59:59";return new Date(t).getTime()-this.curTime<864e6}},beforeDestroy(){clearTimeout(this.memoryRoot),this.memoryRoot=null},props:["showSign","isStart","config"],components:{"v-sign":l,PswPop:r.a}},h={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("ul",{staticClass:"conflict"},[i("li",[i("img",{staticStyle:{cursor:"pointer"},attrs:{src:s("94hp"),width:"186",alt:"迪英加"},on:{click:function(e){return t.$router.push("index")}}}),t._v(" "),t.user.is_test&&!t.isNearExpires?i("div",{staticClass:"status",on:{mouseenter:function(e){t.showBuble=!0},mouseleave:function(e){t.showBuble=!1}}},[t._v("试用中")]):t._e(),t._v(" "),t.user.is_test&&t.isNearExpires?i("div",{staticClass:"statusNearExpire",on:{mouseenter:function(e){t.showBuble=!0},mouseleave:function(e){t.showBuble=!1}}},[t._v("试用即将到期，您可拨打400-8910357获取帮助")]):t._e(),t._v(" "),t.showBuble?i("div",{staticClass:"buble"},[t._v("试用到期时间："+t._s(t.user.time_out))]):t._e()]),t._v(" "),i("li",{staticClass:"header-username"},[i("a",{on:{click:function(e){return t.toogleHome()}}},[t._v(t._s(t.user.username+"@"+t.user.company)),i("em")]),t._v(" "),i("div",{staticClass:"stage",on:{click:function(e){t.showMemoryBox=!t.showMemoryBox}}},[i("img",{attrs:{src:s("i1en")}}),t._v("剩余存储   "),i("span",{class:{warnning:t.remainMemory<5}},[t._v(t._s(t.remainMemory)+"%")])]),t._v(" "),t.home?i("div",{staticClass:"home"},[i("ul",[i("li",{on:{click:function(e){return t.changePsw()}}},[t._v(t._s(t.$t("personal.password")))]),t._v(" "),i("li",{on:{click:function(e){return t.addImg()}}},[t._v(t._s(t.$t("personal.signature")))]),t._v(" "),"sa"==t.user.role||"admin"==t.user.role?i("li",{on:{click:t.backStage}},[t._v("后台管理")]):t._e(),t._v(" "),i("li",{on:{click:t.settingOpen}},[t._v("系统设置")]),t._v(" "),t.user.cloud?t._e():i("li",{on:{click:t.shutdown}},[t._v("关闭服务器")]),t._v(" "),t.user.cloud?t._e():i("li",{on:{click:t.reboot}},[t._v("重启服务器")]),t._v(" "),t.onTrial?i("li",{on:{click:t.showTrialMan}},[t._v("试用管理")]):t._e(),t._v(" "),i("li",{on:{click:t.quit}},[t._v(t._s(t.$t("personal.quit")))])])]):t._e()]),t._v(" "),i("br",{staticStyle:{clear:"both"}})]),t._v(" "),t.home?i("div",{staticClass:"home-bg",on:{click:function(e){return t.noBg()}}}):t._e(),t._v(" "),t.showSign?i("v-sign",{on:{close:t.closeSign}}):t._e(),t._v(" "),i("transition",{attrs:{name:"fade"}},[t.isChange?i("div",{staticClass:"delete"},[i("div",{staticClass:"ctn"},[i("div",{staticClass:"header"},[t._v("\n          "+t._s(t.$t("changepassword.title"))+"\n          "),i("span",{staticClass:"iconfont",on:{click:function(e){return t.qiutPsw()}}})]),t._v(" "),i("div",{staticClass:"content-psw"},[i("dl",{staticClass:"p40"},[i("dt",[t._v(t._s(t.$t("changepassword.oldpsw")))]),t._v(" "),i("dd",[i("input",{directives:[{name:"model",rawName:"v-model",value:t.oldPassword,expression:"oldPassword"}],staticClass:"pws-text",attrs:{name:"txtPassword",autocomplete:"off",type:"password"},domProps:{value:t.oldPassword},on:{input:function(e){e.target.composing||(t.oldPassword=e.target.value)}}}),t._v(" "),""==t.oldPassword?i("div",{staticClass:"point"},[t._v(t._s(t.$t("changepassword.remindoldpsw")))]):t._e()])]),t._v(" "),i("dl",{staticClass:"p12"},[i("dt",[t._v(t._s(t.$t("changepassword.newpsw")))]),t._v(" "),i("dd",[i("input",{directives:[{name:"model",rawName:"v-model",value:t.newPassword,expression:"newPassword"}],staticClass:"pws-text",class:{red:t.newPassword&&(t.newPassword==t.oldPassword||!t.reg.test(t.newPassword))},attrs:{name:"txtPassword1",autocomplete:"off",type:"password"},domProps:{value:t.newPassword},on:{input:function(e){e.target.composing||(t.newPassword=e.target.value)}}}),t._v(" "),t.newPassword?t._e():i("div",{staticClass:"point"},[t._v(t._s(t.$t("changepassword.remindnewpsw")))]),t._v(" "),t.newPassword&&!t.reg.test(t.newPassword)?i("div",{staticClass:"point",staticStyle:{color:"#f6472a"}},[t._v(t._s(t.$t("changepassword.remindnewpsw")))]):t._e(),t._v(" "),t.newPassword&&t.reg.test(t.newPassword)&&t.newPassword==t.oldPassword?i("div",{staticClass:"point",staticStyle:{color:"#f6472a"}},[t._v(t._s(t.$t("changepassword.pswconfirm")))]):t._e()])]),t._v(" "),i("dl",{staticClass:"p12"},[i("dt",[t._v(t._s(t.$t("changepassword.confirmpsw")))]),t._v(" "),i("dd",[i("input",{directives:[{name:"model",rawName:"v-model",value:t.newPasswordSure,expression:"newPasswordSure"}],staticClass:"pws-text",class:{red:""!=t.newPasswordSure&&t.newPasswordSure!=t.newPassword},attrs:{name:"txtPassword2",autocomplete:"off",type:"password"},domProps:{value:t.newPasswordSure},on:{input:function(e){e.target.composing||(t.newPasswordSure=e.target.value)}}}),t._v(" "),t.newPasswordSure?t._e():i("div",{staticClass:"point top40"},[t._v(t._s(t.$t("changepassword.remindconfirmpsw")))]),t._v(" "),t.newPasswordSure&&t.newPasswordSure!=t.newPassword?i("div",{staticClass:"point top40",staticStyle:{color:"#f6472a"}},[t._v(t._s(t.$t("changepassword.inconsistentpsw")))]):t._e()])])]),t._v(" "),i("div",{staticClass:"footer"},[i("button",{on:{click:function(e){return t.confirmPsw()}}},[t._v(t._s(t.$t("confirm.confirm")))]),t._v(" "),i("button",{staticClass:"currentSure",on:{click:function(e){return t.qiutPsw()}}},[t._v(t._s(t.$t("confirm.quit")))])])])]):t._e()]),t._v(" "),i("transition",{attrs:{name:"fade"}},[t.showSettingAIParam?i("div",{staticClass:"delete"},[i("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticClass:"param",class:{higher:t.curParam.all_use&&"pdl1"!=t.ajustType,"pdl1-box":"pdl1"==t.ajustType},attrs:{"element-loading-text":"参数应用中…为确保数据安全，期间请勿关闭客户端和服务器","element-loading-background":"rgba(0, 0, 0, 0.8)"}},[i("div",{staticClass:"top-header"},[t._v("算法参数设置")]),t._v(" "),i("div",{staticClass:"center-header"},[i("div",{staticClass:"tips"},[t._v("通过调整参数可以改变AI判读倾向。应用成功后，AI将按照新参数标准进行，请谨慎操作！")]),t._v(" "),i("div",{staticClass:"tabs"},[i("div",{staticClass:"tabs-top"},[i("span",{class:{checked:"tct"===t.ajustType},on:{click:function(e){return e.stopPropagation(),t.changeTab("tct")}}},[t._v("TCT")]),t._v(" "),i("span",{class:{checked:"lct"===t.ajustType},on:{click:function(e){return e.stopPropagation(),t.changeTab("lct")}}},[t._v("LCT")]),t._v(" "),i("span",{class:{checked:"pdl1"===t.ajustType},on:{click:function(e){return e.stopPropagation(),t.changeTab("pdl1")}}},[t._v("PDL1")]),t._v(" "),i("span",{class:{checked:"dna"===t.ajustType},on:{click:function(e){return e.stopPropagation(),t.changeTab("dna")}}},[t._v("TBS+DNA")])]),t._v(" "),"pdl1"!=t.ajustType?i("div",[i("div",{staticClass:"tabs-content"},[i("div",{staticClass:"reset",on:{click:t.seset}},[t._v("恢复默认阈值")]),t._v(" "),i("div",{staticClass:"range"},[t._v("\n                  调参范围：\n                  "),i("el-radio",{attrs:{label:0},on:{change:t.getAnalyseThreshold},model:{value:t.curParam.threshold_range,callback:function(e){t.$set(t.curParam,"threshold_range",e)},expression:"curParam.threshold_range"}},[t._v("阴性和ASC-US、ASC-H切片")]),t._v(" "),i("el-radio",{attrs:{label:1},on:{change:t.getAnalyseThreshold},model:{value:t.curParam.threshold_range,callback:function(e){t.$set(t.curParam,"threshold_range",e)},expression:"curParam.threshold_range"}},[t._v("所有类型切片")])],1),t._v(" "),i("div",{staticClass:"block"},[i("div",{staticClass:"word",style:{left:"calc("+t.curParam.threshold_value+"% - 18px)"}},[t._v(t._s(t.curParam.threshold_value/100))]),t._v(" "),i("el-slider",{attrs:{"show-tooltip":!1},on:{change:t.barChange},model:{value:t.curParam.threshold_value,callback:function(e){t.$set(t.curParam,"threshold_value",e)},expression:"curParam.threshold_value"}}),t._v(" "),t.curParam.threshold_range?i("div",{staticClass:"tot long",style:{left:"calc("+t.curParam.threshold_value+"% - 63px)"}},[i("p",[t._v("阴性 "+t._s((100*t.analyseThreshold.ratio.NILM).toFixed(2))+"%")]),t._v(" "),i("p",[t._v("ASC-US "+t._s((100*t.analyseThreshold.ratio["ASC-US"]).toFixed(2))+"%")]),t._v(" "),i("p",[t._v("ASC-H "+t._s((100*t.analyseThreshold.ratio["ASC-H"]).toFixed(2))+"%")]),t._v(" "),i("p",[t._v("AGC "+t._s((100*t.analyseThreshold.ratio.AGC).toFixed(2))+"%")]),t._v(" "),i("p",[t._v("HSIL "+t._s((100*t.analyseThreshold.ratio.HSIL).toFixed(2))+"%")]),t._v(" "),i("p",[t._v("LSIL "+t._s((100*t.analyseThreshold.ratio.LSIL).toFixed(2))+"%")])]):i("div",{staticClass:"tot",style:{left:"calc("+t.curParam.threshold_value+"% - 63px)"}},[i("p",[t._v("阴性 "+t._s((100*t.analyseThreshold.ratio.NILM).toFixed(2))+"%")]),t._v(" "),i("p",[t._v("ASC-US "+t._s((100*t.analyseThreshold.ratio["ASC-US"]).toFixed(2))+"%")]),t._v(" "),i("p",[t._v("ASC-H "+t._s((100*t.analyseThreshold.ratio["ASC-H"]).toFixed(2))+"%")])])],1),t._v(" "),i("div",{staticClass:"end"},[i("span",[t._v(t._s(t.curParam.threshold_range?"阳性检出更多,阴性检出更少":"ASC-US、ASC-H检出更多，阴性检出更少"))]),t._v(" "),i("span",[t._v(t._s(t.curParam.threshold_range?"阳性检出更少,阴性检出更多":"ASC-US、ASC-H检出更少，阴性检出更多"))])])]),t._v(" "),i("div",{staticClass:"tabs-bot"},[i("el-checkbox",{model:{value:t.curParam.all_use,callback:function(e){t.$set(t.curParam,"all_use",e)},expression:"curParam.all_use"}},[t._v("已处理切片也应用新参数")]),t._v(" "),i("span",{staticClass:"sec"},[t._v(t._s("（预计耗时"+t.analyseThreshold.num_slide+"秒，一旦开始无法中断）"))]),t._v(" "),i("p",[t._v("勾选后，原AI结果可能被更改")]),t._v(" "),t.curParam.all_use?i("div",{staticClass:"c-res"},[i("h2",[t._v("应用结果预览：")]),t._v(" "),i("ul",[i("li",[i("h3",[t._v("敏感性："+t._s((100*t.analyseThreshold.sensitivity).toFixed(2))+"%")]),t._v(" "),i("h3",[t._v("敏感性(不含ASC-US)："+t._s((100*t.analyseThreshold.sensitivity_plus).toFixed(2))+"%")]),t._v(" "),i("h3",[t._v("特异性："+t._s((100*t.analyseThreshold.specificity).toFixed(2))+"%")])]),t._v(" "),i("li",[i("h3",[i("span",[t._v("总数（已处理）："+t._s(t.analyseThreshold.count.sum))])]),t._v(" "),i("h3",[t._v("阴性："+t._s(t.analyseThreshold.count.NILM))]),t._v(" "),i("h3",[t._v("HSIL："+t._s(t.analyseThreshold.count.HSIL))]),t._v(" "),i("h3",[t._v("ASC-H："+t._s(t.analyseThreshold.count["ASC-H"]))]),t._v(" "),i("h3",[t._v("LSIL："+t._s(t.analyseThreshold.count.LSIL))]),t._v(" "),i("h3",[t._v("ASC-US："+t._s(t.analyseThreshold.count["ASC-US"]))]),t._v(" "),i("h3",[t._v("AGC："+t._s(t.analyseThreshold.count.AGC))])]),t._v(" "),i("li",[i("h3",[i("span",[t._v("AI漏阳总数："+t._s(t.analyseThreshold.fn.sum))])]),t._v(" "),i("h3",[t._v("HSIL："+t._s(t.analyseThreshold.fn.HSIL))]),t._v(" "),i("h3",[t._v("ASC-H："+t._s(t.analyseThreshold.fn["ASC-H"]))]),t._v(" "),i("h3",[t._v("LSIL："+t._s(t.analyseThreshold.fn.LSIL))]),t._v(" "),i("h3",[t._v("ASC-US："+t._s(t.analyseThreshold.fn["ASC-US"]))]),t._v(" "),i("h3",[t._v("AGC："+t._s(t.analyseThreshold.fn.AGC))])])]),t._v(" "),i("div",{staticStyle:{"padding-top":"12px"}},[i("h4",[t._v("为使预览结果准确，请：1. 等待所有切片完成判读   2. 确保所有切片的"),i("span",{staticClass:"sec"},[t._v("医院标签正确填入复核结果栏")])]),t._v(" "),i("h4",[i("span",{staticClass:"sec"},[t._v("当前已复核总数为"+t._s(t.analyseThreshold.num_manual)+"。")])])])]):t._e()],1)]):i("div",[i("div",{staticClass:"tabs-content"},[i("div",{staticClass:"updown"},[t._v("\n                  拟合曲线\n                  "),t.smoothImg?i("div",{staticClass:"adjust"},[t._v("\n                    平滑度调整：\n                    "),i("button",{on:{click:function(e){return t.modifySmoothValue("plus")}}},[t._v("+")]),t._v(" "),i("button",{on:{click:function(e){return t.modifySmoothValue("reduce")}}},[t._v("-")])]):t._e(),t._v(" "),i("span",{on:{click:t.resetSmooth}},[t._v("恢复默认")]),t._v(" "),i("span",{on:{click:t.downloadTem}},[t._v("下载模版")]),t._v(" "),i("span",{staticClass:"upload-xls"},[t._v("\n                    上传调参依据\n                    "),i("input",{ref:"smoothfile",staticClass:"pdl1-file",attrs:{type:"file",accept:".xlsx,.xls"},on:{change:function(e){return t.imgPreview(e.currentTarget)}}})])]),t._v(" "),i("div",{staticClass:"img-box"},[t.smoothImg?i("img",{attrs:{src:t.smoothImg,alt:""}}):i("div",[i("div",{staticClass:"upload-box"}),t._v(" "),i("p",[t._v("请先上传调参依据")])])])]),t._v(" "),i("div",{staticClass:"tabs-bot"},["pdl1"===t.ajustType?i("el-checkbox",{model:{value:t.all_use,callback:function(e){t.all_use=e},expression:"all_use"}},[t._v("已处理切片也应用新参数")]):i("el-checkbox",{model:{value:t.curParam.all_use,callback:function(e){t.$set(t.curParam,"all_use",e)},expression:"curParam.all_use"}},[t._v("已处理切片也应用新参数")]),t._v(" "),i("span",{staticClass:"sec"},[t._v(t._s("（一旦开始无法中断，仅支持已处理的全场分析结果调参）"))]),t._v(" "),i("p",[t._v("勾选后，原AI结果可能被更改")])],1)])])]),t._v(" "),i("div",{staticClass:"top-footer"},[i("span",{staticClass:"apply",on:{click:function(e){return t.apply()}}},[t._v("应用")]),t._v(" "),i("span",{on:{click:function(e){return t.cancel()}}},[t._v("取消")])])])]):t._e()]),t._v(" "),i("transition",{attrs:{name:"fade"}},[t.showTrial?i("div",{staticClass:"setting trialctn"},[i("div",{staticClass:"header"},[t._v("\n          账号试用中\n          "),i("span",{staticClass:"iconfont",on:{click:function(e){t.showTrial=!1}}})]),t._v(" "),i("div",{staticClass:"trial"},[i("div",{staticClass:"msg"},[t._v("各算法模块有使用次数限制，可用次数耗尽将无法试用。")]),t._v(" "),i("table",[i("tr",[i("th",[t._v("算法模块")]),i("th",[t._v("可用次数")])]),t._v(" "),t._l(t.trialTimes,function(e){return i("tr",{key:e.key},[i("td",[t._v(t._s(e.key))]),i("td",[t._v(t._s(e.times))])])})],2)]),t._v(" "),i("div",{staticClass:"footer"},[i("button",{staticClass:"save",on:{click:function(e){t.showTrial=!1}}},[t._v("关闭")])])]):t._e()]),t._v(" "),i("transition",{attrs:{name:"fade"}},[t.showSetting?i("div",{staticClass:"zhezao"},[i("div",{staticClass:"setting"},[i("div",{staticClass:"header"},[t._v("\n          系统设置\n          "),i("span",{staticClass:"iconfont",on:{click:function(e){t.showSetting=!1}}})]),t._v(" "),i("div",{staticClass:"content-setting"},[i("div",{staticClass:"regn regn-hidden"},[t._v("切片标签识别\n            "),i("img",{attrs:{src:s("XA3p"),alt:""},on:{mouseenter:function(e){t.showMsg=!0},mouseleave:function(e){t.showMsg=!1}}}),t._v(" "),t.showMsg?i("span",[t._v("切片上传后自动识别，识别成功结果将保存为切片编号")]):t._e()]),t._v(" "),i("el-radio-group",{model:{value:t.labelcheck,callback:function(e){t.labelcheck=e},expression:"labelcheck"}},[i("el-radio",{attrs:{label:4}},[t._v("OCR识别")]),t._v(" "),i("el-radio",{attrs:{label:2}},[t._v("识别条形码")]),t._v(" "),i("el-radio",{attrs:{label:3}},[t._v("识别二维码")]),t._v(" "),i("el-radio",{attrs:{label:1}},[t._v("不识别")])],1),t._v(" "),i("div",{staticClass:"regn"},[t._v("演示模式\n            "),i("img",{attrs:{src:s("XA3p"),alt:""},on:{mouseenter:function(e){t.showTipTxt=!0},mouseleave:function(e){t.showTipTxt=!1}}}),t._v(" "),t.showTipTxt?i("span",{staticClass:"tip-txt"},[t._v("演示模式下，病例详情页可最小化，支持多标签切换浏览，但不支持切换病例（上/下一个）。")]):t._e()]),t._v(" "),i("div",{staticClass:"switch-btn"},[i("el-switch",{on:{change:t.changeMode},model:{value:t.demoModeValue,callback:function(e){t.demoModeValue=e},expression:"demoModeValue"}})],1),t._v(" "),t.config&&t.config.zeiss?i("div",[i("div",{staticClass:"regn"},[t._v("载物平台移动补偿\n              "),i("img",{attrs:{src:s("XA3p"),alt:""},on:{mouseenter:function(e){t.showTips=!0},mouseleave:function(e){t.showTips=!1}}}),t._v(" "),t.showTips?i("span",{staticClass:"tip-txt new-tip"},[t._v("当平台移动后的镜下视野与全场图位置有偏差时，可通过配置X Y Z轴偏差值来补偿矫正")]):t._e()]),t._v(" "),i("div",[t._v("\n              X："),i("el-input",{staticClass:"pos-rad",model:{value:t.correctData.x,callback:function(e){t.$set(t.correctData,"x",e)},expression:"correctData.x"}}),t._v("\n              Y："),i("el-input",{staticClass:"pos-rad",model:{value:t.correctData.y,callback:function(e){t.$set(t.correctData,"y",e)},expression:"correctData.y"}}),t._v("\n              Z："),i("el-input",{staticClass:"pos-rad",model:{value:t.correctData.z,callback:function(e){t.$set(t.correctData,"z",e)},expression:"correctData.z"}})],1)]):t._e(),t._v(" "),t.config&&t.config.zeiss?i("div",[i("div",{staticClass:"regn"},[t._v("模型校准")]),t._v(" "),i("div",{staticClass:"btn",on:{click:t.resetModelCalibration}},[t._v("校准重置")])]):t._e(),t._v(" "),i("div",{staticClass:"regn"},[t._v("算法调参")]),t._v(" "),i("div",{staticClass:"btn",on:{click:function(e){return t.setType("param")}}},[t._v("算法参数设置")]),t._v(" "),t.electron?i("div",{staticClass:"regn"},[t._v("控制台")]):t._e(),t._v(" "),t.electron?i("div",{staticClass:"btn",on:{click:function(e){return t.setType("control")}}},[t._v("进入控制台")]):t._e()],1),t._v(" "),i("div",{staticClass:"footer"},[i("button",{staticClass:"save",on:{click:t.orcSave}},[t._v("保存")]),t._v(" "),i("button",{on:{click:function(e){t.showSetting=!1}}},[t._v(t._s(t.$t("confirm.quit")))])])])]):t._e()]),t._v(" "),i("transition",{attrs:{name:"fade"}},[t.showSetPsw?i("PswPop",{attrs:{title:"该功能仅限授权人员访问",setPsw:t.setPsw,showTip:t.showTip},on:{confirmBtn:t.openSeting,cancelBtn:function(e){t.showSetPsw=!1}}}):t._e()],1),t._v(" "),i("transition",{attrs:{name:"fade"}},[t.showMemoryBox?i("div",{staticClass:"zhezao"},[i("div",{staticClass:"setting me-contetn"},[i("div",{staticClass:"header"},[t._v("\n            存储空间管理\n            "),i("span",{staticClass:"iconfont",on:{click:function(e){t.showMemoryBox=!1}}})]),t._v(" "),i("div",{staticClass:"content-setting"},[i("div",{staticClass:"progress"},[i("div",{staticClass:"per"},[i("div",{staticClass:"used-memory",class:{warnning:t.remainMemory<5},style:{width:100-t.remainMemory+"%"}})]),t._v("\n              当前剩余 "),i("span",{class:{warnning:t.remainMemory<5}},[t._v(t._s(t.remainMemory)+"%")]),t._v(" 可用\n            ")]),t._v(" "),i("p",{staticClass:"gray"},[t._v("服务器存储空间不足时将无法上传新的切片，建议删除病例切片腾出空间，也可以拨打客服热线400-8910357申请增加磁盘空间。")]),t._v(" "),i("div",{staticClass:"memorydiv"},[t._v("删除"),i("el-date-picker",{attrs:{type:"date","picker-options":t.pickerOptions},on:{change:t.timeChange},model:{value:t.clearTime,callback:function(e){t.clearTime=e},expression:"clearTime"}}),t._v("之前创建的所有病例（含切片、附件）")],1),t._v(" "),i("div",{staticClass:"memorydiv"},[t._v("共 "+t._s(t.recordCount)+" 条病例")])]),t._v(" "),i("div",{staticClass:"footer"},[i("button",{staticClass:"save",on:{click:t.clearCase}},[t._v("删除")]),t._v(" "),i("button",{on:{click:function(e){t.showMemoryBox=!1}}},[t._v(t._s(t.$t("confirm.quit")))])])])]):t._e()])],1)},staticRenderFns:[]};var u=s("VU/8")(c,h,!1,function(t){s("jLS6")},"data-v-2fcdfb88",null);i.a=u.exports},JoHU:function(t,e){},Js0x:function(t,e){},LC74:function(t,e){"function"==typeof Object.create?t.exports=function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(t,e){t.super_=e;var i=function(){};i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=t}},Lydp:function(t,e){},M9nz:function(t,e){},Mk6O:function(t,e,i){var s,a;a=function(t){var e=["N","E","A","D"];function i(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}function s(t,e){Object.defineProperty(this,"kind",{value:t,enumerable:!0}),e&&e.length&&Object.defineProperty(this,"path",{value:e,enumerable:!0})}function a(t,e,i){a.super_.call(this,"E",t),Object.defineProperty(this,"lhs",{value:e,enumerable:!0}),Object.defineProperty(this,"rhs",{value:i,enumerable:!0})}function n(t,e){n.super_.call(this,"N",t),Object.defineProperty(this,"rhs",{value:e,enumerable:!0})}function o(t,e){o.super_.call(this,"D",t),Object.defineProperty(this,"lhs",{value:e,enumerable:!0})}function l(t,e,i){l.super_.call(this,"A",t),Object.defineProperty(this,"index",{value:e,enumerable:!0}),Object.defineProperty(this,"item",{value:i,enumerable:!0})}function r(t,e,i){var s=t.slice((i||e)+1||t.length);return t.length=e<0?t.length+e:e,t.push.apply(t,s),t}function c(t){var e=typeof t;return"object"!==e?e:t===Math?"math":null===t?"null":Array.isArray(t)?"array":"[object Date]"===Object.prototype.toString.call(t)?"date":"function"==typeof t.toString&&/^\/.*\//.test(t.toString())?"regexp":"object"}function h(t){var e=0;if(0===t.length)return e;for(var i=0;i<t.length;i++){var s=t.charCodeAt(i);e=(e<<5)-e+s,e&=e}return e}function u(t){var e=0,i=c(t);if("array"===i){t.forEach(function(t){e+=u(t)});var s="[type: array, hash: "+e+"]";return e+h(s)}if("object"===i){for(var a in t)if(t.hasOwnProperty(a)){var n="[ type: object, key: "+a+", value hash: "+u(t[a])+"]";e+=h(n)}return e}var o="[ type: "+i+" ; value: "+t+"]";return e+h(o)}function d(t,e,i,s,r,h,p,v){i=i||[],r=r||[],p=p||[];var m=r.slice(0);if(void 0!==h&&null!==h){if(s){if("function"==typeof s&&s(m,h))return;if("object"==typeof s){if(s.prefilter&&s.prefilter(m,h))return;if(s.normalize){var g=s.normalize(m,h,t,e);g&&(t=g[0],e=g[1])}}}m.push(h)}"regexp"===c(t)&&"regexp"===c(e)&&(t=t.toString(),e=e.toString());var f,_,y,b,R=typeof t,C=typeof e,w="undefined"!==R||p&&p.length>0&&p[p.length-1].lhs&&Object.getOwnPropertyDescriptor(p[p.length-1].lhs,h),k="undefined"!==C||p&&p.length>0&&p[p.length-1].rhs&&Object.getOwnPropertyDescriptor(p[p.length-1].rhs,h);if(!w&&k)i.push(new n(m,e));else if(!k&&w)i.push(new o(m,t));else if(c(t)!==c(e))i.push(new a(m,t,e));else if("date"===c(t)&&t-e!=0)i.push(new a(m,t,e));else if("object"===R&&null!==t&&null!==e){for(f=p.length-1;f>-1;--f)if(p[f].lhs===t){b=!0;break}if(b)t!==e&&i.push(new a(m,t,e));else{if(p.push({lhs:t,rhs:e}),Array.isArray(t)){for(v&&(t.sort(function(t,e){return u(t)-u(e)}),e.sort(function(t,e){return u(t)-u(e)})),f=e.length-1,_=t.length-1;f>_;)i.push(new l(m,f,new n(void 0,e[f--])));for(;_>f;)i.push(new l(m,_,new o(void 0,t[_--])));for(;f>=0;--f)d(t[f],e[f],i,s,m,f,p,v)}else{var x=Object.keys(t),$=Object.keys(e);for(f=0;f<x.length;++f)y=x[f],(b=$.indexOf(y))>=0?(d(t[y],e[y],i,s,m,y,p,v),$[b]=null):d(t[y],void 0,i,s,m,y,p,v);for(f=0;f<$.length;++f)(y=$[f])&&d(void 0,e[y],i,s,m,y,p,v)}p.length=p.length-1}}else t!==e&&("number"===R&&isNaN(t)&&isNaN(e)||i.push(new a(m,t,e)))}function p(t,e,i,s,a){var n=[];if(d(t,e,n,s,null,null,null,a),i)for(var o=0;o<n.length;++o)i(n[o]);return n}function v(t,e,i,s){var a=s?function(t){t&&s.push(t)}:void 0,n=p(t,e,a,i);return s||(n.length?n:void 0)}function m(t,i,s){if(void 0===s&&i&&~e.indexOf(i.kind)&&(s=i),t&&s&&s.kind){for(var a=t,n=-1,o=s.path?s.path.length-1:0;++n<o;)void 0===a[s.path[n]]&&(a[s.path[n]]=void 0!==s.path[n+1]&&"number"==typeof s.path[n+1]?[]:{}),a=a[s.path[n]];switch(s.kind){case"A":s.path&&void 0===a[s.path[n]]&&(a[s.path[n]]=[]),function t(e,i,s){if(s.path&&s.path.length){var a,n=e[i],o=s.path.length-1;for(a=0;a<o;a++)n=n[s.path[a]];switch(s.kind){case"A":t(n[s.path[a]],s.index,s.item);break;case"D":delete n[s.path[a]];break;case"E":case"N":n[s.path[a]]=s.rhs}}else switch(s.kind){case"A":t(e[i],s.index,s.item);break;case"D":e=r(e,i);break;case"E":case"N":e[i]=s.rhs}return e}(s.path?a[s.path[n]]:a,s.index,s.item);break;case"D":delete a[s.path[n]];break;case"E":case"N":a[s.path[n]]=s.rhs}}}i(a,s),i(n,s),i(o,s),i(l,s),Object.defineProperties(v,{diff:{value:v,enumerable:!0},orderIndependentDiff:{value:function(t,e,i,s){var a=s?function(t){t&&s.push(t)}:void 0,n=p(t,e,a,i,!0);return s||(n.length?n:void 0)},enumerable:!0},observableDiff:{value:p,enumerable:!0},orderIndependentObservableDiff:{value:function(t,e,i,s,a,n,o){return d(t,e,i,s,a,n,o,!0)},enumerable:!0},orderIndepHash:{value:u,enumerable:!0},applyDiff:{value:function(t,e,i){t&&e&&p(t,e,function(s){i&&!i(t,e,s)||m(t,e,s)})},enumerable:!0},applyChange:{value:m,enumerable:!0},revertChange:{value:function(t,e,i){if(t&&e&&i&&i.kind){var s,a,n=t;for(a=i.path.length-1,s=0;s<a;s++)void 0===n[i.path[s]]&&(n[i.path[s]]={}),n=n[i.path[s]];switch(i.kind){case"A":!function t(e,i,s){if(s.path&&s.path.length){var a,n=e[i],o=s.path.length-1;for(a=0;a<o;a++)n=n[s.path[a]];switch(s.kind){case"A":t(n[s.path[a]],s.index,s.item);break;case"D":case"E":n[s.path[a]]=s.lhs;break;case"N":delete n[s.path[a]]}}else switch(s.kind){case"A":t(e[i],s.index,s.item);break;case"D":case"E":e[i]=s.lhs;break;case"N":e=r(e,i)}return e}(n[i.path[s]],i.index,i.item);break;case"D":case"E":n[i.path[s]]=i.lhs;break;case"N":delete n[i.path[s]]}}},enumerable:!0},isConflict:{value:function(){return"undefined"!=typeof $conflict},enumerable:!0}}),v.DeepDiff=v,t&&(t.DeepDiff=v);return v}(this),void 0===(s=function(){return a}.call(e,i,e,t))||(t.exports=s)},MwPA:function(t,e){},NmLI:function(t,e,i){t.exports=i.p+"static/img/打点.4615a77.svg"},Nx4E:function(t,e){},O32g:function(t,e){},O4Kg:function(t,e){},O7j2:function(t,e){},OMJi:function(t,e,i){(function(t,s){var a=/%[sdj%]/g;e.format=function(t){if(!f(t)){for(var e=[],i=0;i<arguments.length;i++)e.push(l(arguments[i]));return e.join(" ")}i=1;for(var s=arguments,n=s.length,o=String(t).replace(a,function(t){if("%%"===t)return"%";if(i>=n)return t;switch(t){case"%s":return String(s[i++]);case"%d":return Number(s[i++]);case"%j":try{return JSON.stringify(s[i++])}catch(t){return"[Circular]"}default:return t}}),r=s[i];i<n;r=s[++i])m(r)||!b(r)?o+=" "+r:o+=" "+l(r);return o},e.deprecate=function(i,a){if(_(t.process))return function(){return e.deprecate(i,a).apply(this,arguments)};if(!0===s.noDeprecation)return i;var n=!1;return function(){if(!n){if(s.throwDeprecation)throw new Error(a);s.traceDeprecation?console.trace(a):console.error(a),n=!0}return i.apply(this,arguments)}};var n,o={};function l(t,i){var s={seen:[],stylize:c};return arguments.length>=3&&(s.depth=arguments[2]),arguments.length>=4&&(s.colors=arguments[3]),v(i)?s.showHidden=i:i&&e._extend(s,i),_(s.showHidden)&&(s.showHidden=!1),_(s.depth)&&(s.depth=2),_(s.colors)&&(s.colors=!1),_(s.customInspect)&&(s.customInspect=!0),s.colors&&(s.stylize=r),h(s,t,s.depth)}function r(t,e){var i=l.styles[e];return i?"["+l.colors[i][0]+"m"+t+"["+l.colors[i][1]+"m":t}function c(t,e){return t}function h(t,i,s){if(t.customInspect&&i&&w(i.inspect)&&i.inspect!==e.inspect&&(!i.constructor||i.constructor.prototype!==i)){var a=i.inspect(s,t);return f(a)||(a=h(t,a,s)),a}var n=function(t,e){if(_(e))return t.stylize("undefined","undefined");if(f(e)){var i="'"+JSON.stringify(e).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return t.stylize(i,"string")}if(g(e))return t.stylize(""+e,"number");if(v(e))return t.stylize(""+e,"boolean");if(m(e))return t.stylize("null","null")}(t,i);if(n)return n;var o=Object.keys(i),l=function(t){var e={};return t.forEach(function(t,i){e[t]=!0}),e}(o);if(t.showHidden&&(o=Object.getOwnPropertyNames(i)),C(i)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return u(i);if(0===o.length){if(w(i)){var r=i.name?": "+i.name:"";return t.stylize("[Function"+r+"]","special")}if(y(i))return t.stylize(RegExp.prototype.toString.call(i),"regexp");if(R(i))return t.stylize(Date.prototype.toString.call(i),"date");if(C(i))return u(i)}var c,b="",k=!1,x=["{","}"];(p(i)&&(k=!0,x=["[","]"]),w(i))&&(b=" [Function"+(i.name?": "+i.name:"")+"]");return y(i)&&(b=" "+RegExp.prototype.toString.call(i)),R(i)&&(b=" "+Date.prototype.toUTCString.call(i)),C(i)&&(b=" "+u(i)),0!==o.length||k&&0!=i.length?s<0?y(i)?t.stylize(RegExp.prototype.toString.call(i),"regexp"):t.stylize("[Object]","special"):(t.seen.push(i),c=k?function(t,e,i,s,a){for(var n=[],o=0,l=e.length;o<l;++o)I(e,String(o))?n.push(d(t,e,i,s,String(o),!0)):n.push("");return a.forEach(function(a){a.match(/^\d+$/)||n.push(d(t,e,i,s,a,!0))}),n}(t,i,s,l,o):o.map(function(e){return d(t,i,s,l,e,k)}),t.seen.pop(),function(t,e,i){if(t.reduce(function(t,e){return 0,e.indexOf("\n")>=0&&0,t+e.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60)return i[0]+(""===e?"":e+"\n ")+" "+t.join(",\n  ")+" "+i[1];return i[0]+e+" "+t.join(", ")+" "+i[1]}(c,b,x)):x[0]+b+x[1]}function u(t){return"["+Error.prototype.toString.call(t)+"]"}function d(t,e,i,s,a,n){var o,l,r;if((r=Object.getOwnPropertyDescriptor(e,a)||{value:e[a]}).get?l=r.set?t.stylize("[Getter/Setter]","special"):t.stylize("[Getter]","special"):r.set&&(l=t.stylize("[Setter]","special")),I(s,a)||(o="["+a+"]"),l||(t.seen.indexOf(r.value)<0?(l=m(i)?h(t,r.value,null):h(t,r.value,i-1)).indexOf("\n")>-1&&(l=n?l.split("\n").map(function(t){return"  "+t}).join("\n").substr(2):"\n"+l.split("\n").map(function(t){return"   "+t}).join("\n")):l=t.stylize("[Circular]","special")),_(o)){if(n&&a.match(/^\d+$/))return l;(o=JSON.stringify(""+a)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.substr(1,o.length-2),o=t.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),o=t.stylize(o,"string"))}return o+": "+l}function p(t){return Array.isArray(t)}function v(t){return"boolean"==typeof t}function m(t){return null===t}function g(t){return"number"==typeof t}function f(t){return"string"==typeof t}function _(t){return void 0===t}function y(t){return b(t)&&"[object RegExp]"===k(t)}function b(t){return"object"==typeof t&&null!==t}function R(t){return b(t)&&"[object Date]"===k(t)}function C(t){return b(t)&&("[object Error]"===k(t)||t instanceof Error)}function w(t){return"function"==typeof t}function k(t){return Object.prototype.toString.call(t)}function x(t){return t<10?"0"+t.toString(10):t.toString(10)}e.debuglog=function(t){if(_(n)&&(n=Object({NODE_ENV:"production"}).NODE_DEBUG||""),t=t.toUpperCase(),!o[t])if(new RegExp("\\b"+t+"\\b","i").test(n)){var i=s.pid;o[t]=function(){var s=e.format.apply(e,arguments);console.error("%s %d: %s",t,i,s)}}else o[t]=function(){};return o[t]},e.inspect=l,l.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},l.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},e.isArray=p,e.isBoolean=v,e.isNull=m,e.isNullOrUndefined=function(t){return null==t},e.isNumber=g,e.isString=f,e.isSymbol=function(t){return"symbol"==typeof t},e.isUndefined=_,e.isRegExp=y,e.isObject=b,e.isDate=R,e.isError=C,e.isFunction=w,e.isPrimitive=function(t){return null===t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||"symbol"==typeof t||void 0===t},e.isBuffer=i("fC4T");var $=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function I(t,e){return Object.prototype.hasOwnProperty.call(t,e)}e.log=function(){var t,i;console.log("%s - %s",(t=new Date,i=[x(t.getHours()),x(t.getMinutes()),x(t.getSeconds())].join(":"),[t.getDate(),$[t.getMonth()],i].join(" ")),e.format.apply(e,arguments))},e.inherits=i("LC74"),e._extend=function(t,e){if(!e||!b(e))return t;for(var i=Object.keys(e),s=i.length;s--;)t[i[s]]=e[i[s]];return t}}).call(e,i("DuR2"),i("W2nU"))},OfXo:function(t,e,i){"use strict";var s=i("jyVo"),a={props:["results","choosemodel","errorListLength","queueMsg"],data:()=>({resultType:0,company:Object(s.o)().company,startIndex:0,curPdl1Type:"SP263"}),computed:{totalList(){return this.choosemodel&&(this.choosemodel.includes("tct")||this.choosemodel.includes("lct")||"dna"===this.choosemodel)?this.results.reportArr.filter(t=>t.result.type==this.resultType):"psl1"===this.choosemodel?this.newReportArr.filter(t=>t.result.type==this.resultType):this.results.reportArr.filter(t=>t.result.type==this.resultType)},loadList(){return this.totalList.slice(-10)},newReportArr(){if("SP263"===this.curPdl1Type){return this.results.reportArr.map(t=>(t.result.TPS<1?t.result.type=-1:t.result.TPS>=1&&t.result.TPS<25?t.result.type=1:t.result.type=0,t))}if("22C3"===this.curPdl1Type){return this.results.reportArr.map(t=>(t.result.TPS<1?t.result.type=-1:t.result.TPS>=1&&t.result.TPS<50?t.result.type=1:t.result.type=0,t))}if("28-8"===this.curPdl1Type){return this.results.reportArr.map(t=>(t.result.TPS<1?t.result.type=-1:t.result.TPS>=1&&t.result.TPS<5?t.result.type=1:t.result.TPS>=5&&t.result.TPS<10?t.result.type=0:t.result.type=2,t))}}},methods:{lazyload(){let t=this.$refs.lazyload.scrollTop/67,e=this.startIndex;t>11?e+=7:0==t&&(e-=7),e=Math.min(Math.max(e,0),this.totalList.length),this.$refs.lazyload.scrollTop+=67*(this.startIndex-e),this.startIndex=e},switchTab(t){this.$refs.lazyload.scrollTop=0,this.resultType=t}},mounted(){}},n={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticStyle:{position:"relative"}},[s("div",{staticClass:"result"},[s("h3",{staticClass:"title"},[t._v("扫描分析结果")]),t._v(" "),s("div",{staticClass:"result-box corner2"},[s("div",{staticClass:"total"},[s("div",{staticClass:"fl"},[t._v("上传完成"),s("span",{staticStyle:{"font-size":"28px",margin:"0 0 0 5px","font-weight":"bold"}},[t._v(t._s(t.results.sliceTotal))])]),t._v(" "),s("div",{staticClass:"fr",staticStyle:{background:"#37C342"}},[t._v("分析完成"),s("span",{staticStyle:{"font-size":"28px",margin:"0 0 0 5px","font-weight":"bold"}},[t._v(t._s(t.results.reportArr.length))])])]),t._v(" "),s("div",{staticClass:"error"},[t._v("上传异常"),s("span",[t._v(t._s(t.errorListLength))]),s("a",{on:{click:function(e){return t.$emit("open-list")}}},[t._v("查看")]),s("strong",[t._v("待分析切片"),s("em",[t._v(t._s(t.queueMsg))])])]),t._v(" "),t.choosemodel&&(t.choosemodel.includes("tct")||t.choosemodel.includes("lct")||"dna"===t.choosemodel)?s("div",{staticStyle:{padding:"0 12px"}},[s("h5",{staticClass:"left"},[t._v("\n                    已完成报告\n                ")]),t._v(" "),s("div",{staticClass:"report tctres"},[s("div",{staticClass:"fl",class:{negaTive:0==t.resultType},on:{click:function(e){return t.switchTab(0)}}},[t._v("\n                        阳性\n                        "),s("p",{staticStyle:{color:"#F23030"}},[t._v(t._s(t.results.reportArr.filter(function(t){return 0==t.result.type}).length))])]),t._v(" "),s("div",{staticClass:"fl",class:{posiTive:1==t.resultType},on:{click:function(e){return t.switchTab(1)}}},[t._v("\n                        阴性\n                        "),s("p",{staticStyle:{color:"#4AAA1A"}},[t._v(t._s(t.results.reportArr.filter(function(t){return 1==t.result.type}).length))])]),t._v(" "),s("div",{staticClass:"fl",class:{uncerTain:2==t.resultType},on:{click:function(e){return t.switchTab(2)}}},[t._v("\n                        处理异常\n                        "),s("p",{staticStyle:{color:"#E59741"}},[t._v(t._s(t.results.reportArr.filter(function(t){return 2==t.result.type}).length))])])]),t._v(" "),t.results.reportArr.filter(function(e){return e.result.type==t.resultType}).length?t._e():s("h4",[s("img",{attrs:{src:i("FdeP"),alt:""}}),t._v(" 您好！暂时没有当前类型分析结果！\n                ")]),t._v(" "),s("ul",{directives:[{name:"show",rawName:"v-show",value:t.results.reportArr.filter(function(e){return e.result.type==t.resultType}).length,expression:"results.reportArr.filter(o=>o.result.type==resultType).length"}],ref:"lazyload",staticClass:"result-list"},t._l(t.loadList,function(e){var i=e.result,a=e.caseid,n=e.fileid,o=e.filename;return s("li",{key:a,on:{dblclick:function(e){return t.$emit("click",a)}}},[s("div",{staticClass:"fl"},[s("img",{attrs:{src:"/aipath/api/files/thumbnail?caseid="+a+"&fileid="+n+"&companyid="+t.company}})]),t._v(" "),s("p",{staticClass:"fl",attrs:{title:o}},[t._v(" "+t._s(o)+" ")]),t._v(" "),s("p",{class:{fr:!0,positive:0==i.type,negative:1==i.type,uncertain:2==i.type}},[t._v(t._s(i.analy))])])}),0)]):t._e(),t._v(" "),"pdl1"===t.choosemodel?s("div",{staticStyle:{padding:"0 12px"}},[s("h5",{staticClass:"left"},[t._v("\n                    已完成分析结果\n                    "),s("el-select",{model:{value:t.curPdl1Type,callback:function(e){t.curPdl1Type=e},expression:"curPdl1Type"}},[s("el-option",{attrs:{value:"SP263"}},[t._v("SP263")]),t._v(" "),s("el-option",{attrs:{value:"22C3"}},[t._v("22C3")]),t._v(" "),s("el-option",{attrs:{value:"28-8"}},[t._v("28-8")])],1)],1),t._v(" "),s("div",{staticClass:"report"},[s("div",{staticClass:"fl",class:{negaTive:-1==t.resultType,small:"28-8"===t.curPdl1Type},on:{click:function(e){return t.switchTab(-1)}}},[t._v("\n                        <1%\n                        "),s("p",[t._v(t._s(t.newReportArr.filter(function(t){return-1==t.result.type}).length))])]),t._v(" "),s("div",{staticClass:"fl",class:{posiTive:1==t.resultType,small:"28-8"===t.curPdl1Type},on:{click:function(e){return t.switchTab(1)}}},[t._v("\n                        "+t._s("SP263"===t.curPdl1Type?"1%~25%":"22C3"===t.curPdl1Type?"1%~50%":"1%~5%")+"\n                        "),s("p",[t._v(t._s(t.newReportArr.filter(function(t){return 1==t.result.type}).length))])]),t._v(" "),s("div",{staticClass:"fl",class:{uncerTain:0==t.resultType,small:"28-8"===t.curPdl1Type},on:{click:function(e){return t.switchTab(0)}}},[t._v("\n                        "+t._s("SP263"===t.curPdl1Type?"≥25%":"22C3"===t.curPdl1Type?"≥50%":"5%~10%")+"\n                        "),s("p",[t._v(t._s(t.newReportArr.filter(function(t){return 0==t.result.type}).length))])]),t._v(" "),"28-8"===t.curPdl1Type?s("div",{staticClass:"fl small",class:{uncerTain:2==t.resultType},on:{click:function(e){return t.switchTab(2)}}},[t._v("\n                        ≥10%\n                        "),s("p",[t._v(t._s(t.newReportArr.filter(function(t){return t.result.TPS>=10}).length))])]):t._e()]),t._v(" "),t.newReportArr.filter(function(e){return e.result.type==t.resultType}).length?t._e():s("h4",[s("img",{attrs:{src:i("FdeP"),alt:""}}),t._v(" 您好！暂时没有当前类型分析结果！\n                ")]),t._v(" "),s("ul",{directives:[{name:"show",rawName:"v-show",value:t.newReportArr.filter(function(e){return e.result.type==t.resultType}).length,expression:"newReportArr.filter(o=>o.result.type==resultType).length"}],ref:"lazyload",staticClass:"result-list"},t._l(t.loadList,function(e){var i=e.result,a=e.caseid,n=e.fileid,o=e.filename;return s("li",{key:a,on:{dblclick:function(e){return t.$emit("click",a)}}},[s("div",{staticClass:"fl"},[s("img",{attrs:{src:"/aipath/api/files/thumbnail?caseid="+a+"&fileid="+n+"&companyid="+t.company}})]),t._v(" "),s("p",{staticClass:"fl",attrs:{title:o}},[t._v(" "+t._s(o)+" ")]),t._v(" "),s("p",{class:{fr:!0,positive:1==i.type,negative:-1==i.type,uncertain:0==i.type||2==t.resultType}},[t._v("TPS: "+t._s(i.TPS))])])}),0)]):t._e(),t._v(" "),"her2"===t.choosemodel?s("div",[s("div",{staticClass:"report her2"},[s("div",{staticClass:"fl",class:{negaTive:-1==t.resultType},on:{click:function(e){return t.switchTab(-1)}}},[s("p",[t._v("HER-2 0")]),t._v(" "),s("p",[s("span",{staticStyle:{color:"#69E317","font-size":"30px"}},[t._v(t._s(t.results.reportArr.filter(function(t){return"HER-2 0"==t.result.analy}).length))]),t._v("份\n                        ")])]),t._v(" "),s("div",{staticClass:"fl",class:{posiTive:1==t.resultType},on:{click:function(e){return t.switchTab(1)}}},[s("p",[t._v("HER-2 1+")]),t._v(" "),s("p",[s("span",{staticStyle:{color:"#F7EF1C","font-size":"30px"}},[t._v(t._s(t.results.reportArr.filter(function(t){return"HER-2 1+"==t.result.analy}).length))]),t._v("份\n                        ")])]),t._v(" "),s("div",{staticClass:"fl",class:{uncerTain:2==t.resultType},on:{click:function(e){return t.switchTab(2)}}},[s("p",[t._v("HER-2 2+")]),t._v(" "),s("p",[s("span",{staticStyle:{color:"#F7B61C","font-size":"30px"}},[t._v(t._s(t.results.reportArr.filter(function(t){return"HER-2 2+"==t.result.analy}).length))]),t._v("份\n                        ")])]),t._v(" "),s("div",{staticClass:"fl",class:{uncerTain:3==t.resultType},on:{click:function(e){return t.switchTab(3)}}},[s("p",[t._v("HER-2 3+")]),t._v(" "),s("p",[s("span",{staticStyle:{color:"#F7551C","font-size":"30px"}},[t._v(t._s(t.results.reportArr.filter(function(t){return"HER-2 3+"==t.result.analy}).length))]),t._v("份\n                        ")])])]),t._v(" "),t.results.reportArr.filter(function(e){return e.result.type==t.resultType}).length?t._e():s("h4",[s("img",{attrs:{src:i("FdeP"),alt:""}}),t._v(" 您好！暂时没有当前类型分析结果！\n                ")]),t._v(" "),s("ul",{directives:[{name:"show",rawName:"v-show",value:t.results.reportArr.filter(function(e){return e.result.type==t.resultType}).length,expression:"results.reportArr.filter(o=>o.result.type==resultType).length"}],ref:"lazyload",staticClass:"result-list"},t._l(t.loadList,function(e){var i=e.result,a=e.caseid,n=e.fileid,o=e.filename;return s("li",{key:a,on:{dblclick:function(e){return t.$emit("click",a)}}},[s("div",{staticClass:"fl"},[s("img",{attrs:{src:"/aipath/api/files/thumbnail?caseid="+a+"&fileid="+n+"&companyid="+t.company}})]),t._v(" "),s("p",{staticClass:"fl",attrs:{title:o}},[t._v(" "+t._s(o)+" ")]),t._v(" "),s("p",{class:{fr:!0}},[t._v(t._s(i.analy))])])}),0)]):t._e(),t._v(" "),t.loadList.length?s("div",{staticClass:"ti"},[t._v("只显示最近10条，请在病例列表中查看更多")]):t._e()])])])},staticRenderFns:[]};var o=i("VU/8")(a,n,!1,function(t){i("fft9")},"data-v-71486f6a",null);e.a=o.exports},Oj7S:function(t,e){},Otqi:function(t,e){},OvwT:function(t,e){},PAWB:function(t,e,i){"use strict";var s=i("jyVo"),a={data(){return{basic:this.record.basic,pickerOptions2:{disabledDate:t=>{var e=new Date(this.basic.sampleTime).getTime();return""!=e?Date.now()<t.getTime()||t.getTime()<e-864e5:t.getTime()>Date.now()}},pickerOptions1:{disabledDate:t=>{var e=new Date(this.basic.sampleCollectDate).getTime();return""!=e?t.getTime()>Date.now()||t.getTime()>e:t.getTime()>Date.now()}},demoModeValue:"1"===localStorage.getItem("demoMode")||!1}},mounted(){},methods:{noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},next(){this.$emit("next")}},props:["record"]},n={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"basic"},[i("div",{staticClass:"basic-index"},[i("span",[t._v(t._s(t.$t("basic.basic")))])]),t._v(" "),i("div",{staticClass:"content"},[i("div",{staticClass:"basicInformation"},[i("h4",[t._v(t._s(t.$t("basic.basic")))]),t._v(" "),i("dl",[i("dt",[t._v(t._s(t.$t("basic.name")))]),t._v(" "),i("dd",[i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.basic.name,expression:"basic.name"}],staticClass:"leftinput",attrs:{type:"text",maxlength:"32"},domProps:{value:t.basic.name},on:{input:[function(e){e.target.composing||t.$set(t.basic,"name",e.target.value)},t.noEmoji]}})])]),t._v(" "),i("dl",[i("dt",[t._v(t._s(t.$t("basic.age")))]),t._v(" "),i("dd",[i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.basic.age,expression:"basic.age"}],staticClass:"last",attrs:{type:"text",maxlength:"3"},domProps:{value:t.basic.age},on:{input:[function(e){e.target.composing||t.$set(t.basic,"age",e.target.value)},function(e){t.noEmoji,t.basic.age=t.basic.age.replace(/[^\d]/g,"")&&parseInt(t.basic.age.replace(/[^\d]/g,""))}]}})])]),t._v(" "),i("dl",[i("dt",[t._v(t._s(t.$t("basic.sex")))]),t._v(" "),i("dd",[i("el-radio",{attrs:{label:"男"},model:{value:t.basic.gender,callback:function(e){t.$set(t.basic,"gender",e)},expression:"basic.gender"}},[t._v(t._s(t.$t("basic.gender[0]")))]),t._v(" "),i("el-radio",{attrs:{label:"女"},model:{value:t.basic.gender,callback:function(e){t.$set(t.basic,"gender",e)},expression:"basic.gender"}},[t._v(t._s(t.$t("basic.gender[1]")))]),t._v(" "),i("el-radio",{attrs:{label:"其他"},model:{value:t.basic.gender,callback:function(e){t.$set(t.basic,"gender",e)},expression:"basic.gender"}},[t._v(t._s(t.$t("basic.gender[2]")))])],1)]),t._v(" "),i("dl",[i("dt",[t._v(t._s(t.$t("basic.cancerType")))]),t._v(" "),i("dd",[i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.basic.cancerType,expression:"basic.cancerType"}],staticClass:"cancerType",attrs:{maxlength:"32",placeholder:t.$t("basic.typeRemind")},domProps:{value:t.basic.cancerType},on:{input:[function(e){e.target.composing||t.$set(t.basic,"cancerType",e.target.value)},t.noEmoji]}})])]),t._v(" "),i("dl",[i("dt",[t._v(t._s(t.$t("basic.familyHistory")))]),t._v(" "),i("dd",[i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.basic.familyHistory,expression:"basic.familyHistory"}],staticClass:"familyHistory",attrs:{maxlength:"150"},domProps:{value:t.basic.familyHistory},on:{input:[function(e){e.target.composing||t.$set(t.basic,"familyHistory",e.target.value)},t.noEmoji]}})])]),t._v(" "),i("dl",[i("dt",[t._v(t._s(t.$t("basic.medicalHistory")))]),t._v(" "),i("dd",[i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.basic.medicalHistory,expression:"basic.medicalHistory"}],staticClass:"medicalHistory",attrs:{maxlength:"300"},domProps:{value:t.basic.medicalHistory},on:{input:[function(e){e.target.composing||t.$set(t.basic,"medicalHistory",e.target.value)},t.noEmoji]}})])])]),t._v(" "),i("div",{staticClass:"sampleInformation"},[i("h4",{staticClass:"samples"},[t._v(t._s(t.$t("basic.sample")))]),t._v(" "),i("dl",[i("dt",[t._v(t._s(t.$t("basic.caseid")))]),t._v(" "),i("dd",[i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.basic.caseid,expression:"basic.caseid"}],staticClass:"w360",attrs:{type:"text",maxlength:"45"},domProps:{value:t.basic.caseid},on:{input:[function(e){e.target.composing||t.$set(t.basic,"caseid",e.target.value)},t.noEmoji]}})])]),t._v(" "),i("dl",[i("dt",[t._v(t._s(t.$t("basic.samplePart")))]),t._v(" "),i("dd",[i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.basic.samplePart,expression:"basic.samplePart"}],staticClass:"w360",attrs:{type:"text",maxlength:"45"},domProps:{value:t.basic.samplePart},on:{input:[function(e){e.target.composing||t.$set(t.basic,"samplePart",e.target.value)},t.noEmoji],blur:function(e){t.basic.samplePart=t.basic.samplePart.replace(/\s*/g,"")}}})])]),t._v(" "),i("dl",[i("dt",[t._v(t._s(t.$t("basic.sampleTime")))]),t._v(" "),i("dd",[i("el-date-picker",{attrs:{type:"date",placeholder:t.$t("basic.timeRemind"),"value-format":"yyyy-MM-dd"},model:{value:t.basic.sampleTime,callback:function(e){t.$set(t.basic,"sampleTime",e)},expression:"basic.sampleTime"}})],1)]),t._v(" "),i("dl",[i("dt",[t._v(t._s(t.$t("basic.sampleCollectDate")))]),t._v(" "),i("dd",[i("el-date-picker",{staticStyle:{"margin-right":"0"},attrs:{type:"date",placeholder:t.$t("basic.collectRemind"),"value-format":"yyyy-MM-dd"},model:{value:t.basic.sampleCollectDate,callback:function(e){t.$set(t.basic,"sampleCollectDate",e)},expression:"basic.sampleCollectDate"}})],1)]),t._v(" "),i("dl",[i("dt",[t._v(t._s(t.$t("basic.sampleType")))]),t._v(" "),i("dd",[i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.basic.sampleType,expression:"basic.sampleType"}],staticClass:"w360",attrs:{type:"text",maxlength:"45"},domProps:{value:t.basic.sampleType},on:{input:[function(e){e.target.composing||t.$set(t.basic,"sampleType",e.target.value)},t.noEmoji],blur:function(e){t.basic.sampleType=t.basic.sampleType.replace(/\s*/g,"")}}})])]),t._v(" "),i("dl",[i("dt",[t._v(t._s(t.$t("basic.generallySeen")))]),t._v(" "),i("dd",[i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.basic.generallySeen,expression:"basic.generallySeen"}],staticClass:"generallySeen",staticStyle:{height:"100px"},attrs:{maxlength:"300"},domProps:{value:t.basic.generallySeen},on:{input:[function(e){e.target.composing||t.$set(t.basic,"generallySeen",e.target.value)},t.noEmoji]}})])])])]),t._v(" "),i("div",{staticClass:"footer"},[i("span",{on:{click:function(e){return t.$emit("save","auto")}}},[t._v("保存")]),t._v(" "),t.demoModeValue?t._e():i("span",{on:{click:function(e){return t.$emit("prev")}}},[t._v("上一个")]),t._v(" "),t.demoModeValue?t._e():i("span",{on:{click:function(e){return t.next()}}},[t._v("下一个")])])])},staticRenderFns:[]};var o=i("VU/8")(a,n,!1,function(t){i("Dn4L")},"data-v-2c7e5e44",null).exports,l=i("oMm1"),r={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"container"},[s("div",{staticClass:"basic-index"},[s("span",[t._v(t._s(t.$t("detail.files")))])]),t._v(" "),s("div",{staticClass:"slides left"},[s("div",{staticClass:"top"},[s("div",{staticClass:"slides-list"},[t._v("\n        "+t._s(t.$t("upload.slides"))+"\n        "),s("span",[t._v(t._s(this.record.slices.length))])]),t._v(" "),s("div",{staticClass:"new-slide"},[t._v("\n        "+t._s(t.$t("upload.addslice"))+"\n        "),s("input",{attrs:{type:"file",accept:t.uploadType,multiple:""},on:{change:function(e){return t.addFiles(e.currentTarget)}}})])]),t._v(" "),s("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"sliceTable",staticClass:"table",attrs:{data:t.loadList,size:"medium","element-loading-text":"请稍后...","element-loading-background":"rgba(0, 0, 0, 0.8)","row-class-name":function(t){return t.rowIndex%2?"row1":"row2"},"header-cell-class-name":"header",height:"calc(100% - 58px)"},on:{"row-click":function(e){t.currentRecord=e}}},[s("el-table-column",{attrs:{label:t.$t("upload.name")},scopedSlots:t._u([{key:"default",fn:function(e){return[s("input",{directives:[{name:"model",rawName:"v-model",value:e.row.name,expression:"scope.row.name"}],staticStyle:{background:"rgba(0,0,0,0.2)",border:"none",padding:"5px",width:"95%",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"},attrs:{title:e.row.name},domProps:{value:e.row.name},on:{input:function(i){i.target.composing||t.$set(e.row,"name",i.target.value)}}})]}}])}),t._v(" "),s("el-table-column",{attrs:{label:t.$t("upload.stainTypes"),width:"150"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("el-autocomplete",{attrs:{size:"small",debounce:10,"fetch-suggestions":t.stainTypes,placeholder:t.$t("upload.stainTypes")},on:{blur:function(t){e.row.stain=e.row.stain.replace(/\s*/g,"")}},nativeOn:{input:function(e){return t.noEmoji(e)}},model:{value:e.row.stain,callback:function(i){t.$set(e.row,"stain",i)},expression:"scope.row.stain"}})]}}])}),t._v(" "),s("el-table-column",{attrs:{label:t.$t("upload.total"),"min-width":"120"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("div",{staticClass:"progress"},[s("div",{staticClass:"inner",class:"bg"+e.row.state,style:"width:"+100*(e.row.loaded?e.row.loaded/e.row.total:0)+"%"})]),t._v(" "),s("div",{staticClass:"text"},[t._v(t._s(e.row.loaded?Math.floor(e.row.loaded/e.row.total*100):0)+"%")])]}}])}),t._v(" "),s("el-table-column",{attrs:{"min-width":"160"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("span",{class:"img"+e.row.state},[t._v(t._s(t.$t("upload.states["+e.row.state+"]")))]),t._v(" "),3==e.row.state?s("a",{staticStyle:{"font-size":"12px",color:"#2A9FF6"},on:{click:function(i){return t.upload(e.row)}}},[t._v(t._s(t.$t("upload.reupload")))]):t._e()]}}])},[s("template",{slot:"header"},[t._v("\n          状态\n          "),s("img",{staticStyle:{margin:"1px 0 0 2px",cursor:"pointer",verticalAlign:"top"},attrs:{src:i("QlC6"),alt:"",width:"20",height:"20",title:"重新上传"},on:{click:t.uploadAll}})])],2),t._v(" "),s("el-table-column",{attrs:{label:t.$t("upload.size")},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(t._s(Math.ceil(e.row.total/1e3/1e3))+"MB")]}}])}),t._v(" "),s("el-table-column",{attrs:{label:t.$t("upload.opration"),"min-width":"140"},scopedSlots:t._u([{key:"default",fn:function(e){return[t.userInfo.importable?s("a",{staticClass:"add-db",attrs:{title:"导入DB文件"}},[s("input",{attrs:{type:"file"},on:{change:function(i){return t.addDb(i.currentTarget,e.row)}}})]):t._e(),t._v(" "),t.userInfo.importable?s("a",{staticClass:"add-db ex-db",attrs:{title:"导出DB文件"},on:{click:function(i){return t.exportDb(e.row,"db")}}}):t._e(),t._v(" "),t.userInfo.exportJson?s("a",{staticClass:"add-db ex-db ex-json",attrs:{title:"导出JSON文件"},on:{click:function(i){return t.exportDb(e.row,"json")}}}):t._e(),t._v(" "),s("a",{staticClass:"del",on:{click:function(i){return t.del(e.row)}}},[s("img",{attrs:{src:i("8VsA"),title:t.$t("upload.delete")}})])]}}])})],1)],1),t._v(" "),s("div",{staticClass:"slides right"},[s("div",{staticClass:"top"},[s("div",{staticClass:"slides-list"},[t._v("\n        "+t._s(t.$t("upload.achment"))+"\n        "),s("span",[t._v(t._s(this.record.attachments.length))])]),t._v(" "),s("div",{staticClass:"new-slide"},[t._v("\n        "+t._s(t.$t("upload.addattachment"))+"\n        "),s("input",{attrs:{type:"file",multiple:""},on:{change:function(e){return t.addFiles(e.currentTarget,"attachment")}}})])]),t._v(" "),s("el-table",{ref:"table",staticClass:"table",attrs:{data:t.record.attachments,size:"medium","row-class-name":function(t){return t.rowIndex%2?"row1":"row2"},"header-cell-class-name":"header",height:"calc(100% - 58px)"},on:{"row-dblclick":function(e){return t.openWindow(e)},"row-click":function(e){t.currentRecord=e}}},[s("el-table-column",{attrs:{label:t.$t("upload.name")},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(t._s(e.row.name))]}}])}),t._v(" "),s("el-table-column",{attrs:{label:t.$t("upload.total"),"min-width":"120"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("div",{staticClass:"progress"},[s("div",{staticClass:"inner",class:"bg"+e.row.state,style:"width:"+e.row.loaded/e.row.total*100+"%"})]),t._v(" "),s("div",{staticClass:"text"},[t._v(t._s(Math.floor(e.row.loaded/e.row.total*100))+"%")])]}}])}),t._v(" "),s("el-table-column",{attrs:{label:t.$t("upload.state"),"min-width":"130"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("span",{class:"img"+e.row.state},[t._v(t._s(t.$t("upload.states["+e.row.state+"]")))]),t._v(" "),3==e.row.state?s("a",{staticStyle:{"font-size":"12px",color:"#2A9FF6"},on:{click:function(i){return t.upload(e.row)}}},[t._v(t._s(t.$t("upload.reupload")))]):t._e()]}}])}),t._v(" "),s("el-table-column",{attrs:{label:t.$t("upload.size")},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v(t._s(Math.ceil(e.row.total/1e3/1e3))+"MB")]}}])}),t._v(" "),s("el-table-column",{attrs:{label:t.$t("upload.opration"),"min-width":"80"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("a",{staticClass:"del",on:{click:function(i){return t.del(e.row)}}},[s("img",{attrs:{src:i("8VsA"),title:t.$t("upload.delete")}})])]}}])})],1)],1),t._v(" "),s("div",{staticClass:"footer"},[s("span",{on:{click:function(e){return t.$emit("save","auto")}}},[t._v("保存")]),t._v(" "),t.demoModeValue?t._e():s("span",{on:{click:function(e){return t.prev()}}},[t._v("上一个")]),t._v(" "),t.demoModeValue?t._e():s("span",{on:{click:function(e){return t.next()}}},[t._v("下一个")])]),t._v(" "),t.alertTitle?s("el-alert",{attrs:{title:t.alertTitle,type:"warning","show-icon":""}}):t._e()],1)},staticRenderFns:[]};var c=function(t){i("xaJR")},h=i("VU/8")(l.a,r,!1,c,"data-v-a1a3bb40",null).exports,u={data:()=>({show:!1,model_lis:JSON.parse(Object(s.o)().model_lis)}),methods:{choose(t){"pdl1db"!==this.curAI&&(localStorage.perToolType=this.curAI||"human"),this.$emit("chooseAI",t),this.show=!1},showmodel(t){return!!this.model_lis.some(e=>e==t)}},mounted(){},watch:{closeAi(){this.show=!1}},props:["curAI","closeAi"]},d={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[t.show?s("div",{staticClass:"algorithm"},[s("div",{staticClass:"Aibox"},[s("div",{staticClass:"basicProcessing normal"},[s("h4",[t._v("图像处理")]),t._v(" "),s("ul",[s("li",{on:{click:function(e){return e.stopPropagation(),t.choose("human")}}},[s("div",{class:{active:"human"==t.curAI,human:!0}}),t._v(" "),s("span",[t._v(t._s(t.$t("slice.aiTypes.human")))])]),t._v(" "),t._l(["cellseg","center","pdl1db"],function(e){return s("li",{key:e,on:{click:function(i){i.stopPropagation(),t.showmodel(e)&&t.choose(e)}}},[s("div",{class:[t.curAI==e?"active":"",t.showmodel(e)?"":"disabled",e]}),t._v(" "),s("span",[t._v(t._s(t.$t("slice.aiTypes."+e)))])])})],2),t._v(" "),s("h4",[t._v(t._s(t.$t("algorithm.scientific")))]),t._v(" "),s("ul",t._l(["tagging"],function(e){return s("li",{key:e,on:{click:function(i){i.stopPropagation(),t.showmodel(e)&&t.choose(e)}}},[s("div",{class:[t.curAI==e?"active":"",t.showmodel(e)?"":"disabled",e]}),t._v(" "),s("span",[t._v(t._s(t.$t("slice.aiTypes."+e)))])])}),0),t._v(" "),s("h4",[t._v("AI处理")]),t._v(" "),s("ul",t._l(["tct1","tct2","lct1","lct2","pdl1","ki67","ki67hot","er","pr","fish","her2","np","dna","cd30","bm"],function(e){return s("li",{key:e,on:{click:function(i){i.stopPropagation(),t.showmodel(e)&&t.choose(e)}}},[s("div",{class:[t.curAI==e?"active":"",t.showmodel(e)?"":"disabled",e]}),t._v(" "),s("span",[t._v(t._s(t.$t("slice.aiTypes."+e)))])])}),0)])])]):t._e(),t._v(" "),s("div",{staticClass:"showList",on:{click:function(e){e.stopPropagation(),t.show=!t.show}}},[t._v("\n        "+t._s(this.$t("slice.aiTypes."+this.curAI))+"\n        "),s("img",{staticClass:"showpoints",class:{show:t.show},attrs:{src:i("nwg3"),alt:""}})])])},staticRenderFns:[]};var p=i("VU/8")(u,d,!1,function(t){i("pm++")},"data-v-9cf45c0c",null).exports,v=i("SfvY"),m={methods:{changeImage(t){this.$set(t,"image",1-(t.image||0)),this.$emit("closecontextmenu"),this.$emit("roiChanged","image",[t])},checkall(){if(!this.roilist.length)return;let t=this.roilist.every(t=>!!t.image);this.roilist.forEach(e=>this.$set(e,"image",t?0:1)),this.$emit("roiChanged","image",this.roilist),this.$emit("closecontextmenu")},del(t){this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>this.$emit("delRoi",t),t=>t)},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")}},props:["roilist","currentRois","forbidden"]},g={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"roi"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:!!t.roilist.length&&t.roilist.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                ROI\n            ")])]),t._v(" "),i("div",{staticClass:"center"},[t._v("\n            "+t._s(t.$t("slice.remark"))+"\n        ")]),t._v(" "),i("div",{staticClass:"right"},[t._v("\n            "+t._s(t.$t("analyze.opration"))+"\n        ")])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.roilist,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){t.$emit("curROI",e,i.shiftKey),t.$emit("closecontextmenu")}}},[i("div",{staticClass:"left"},[i("div",{attrs:{title:"勾选后将放入报告"}},[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){return i.stopPropagation(),t.changeImage(e)}}}),t._v("\n                    "+t._s(s+1)+"\n                ")])]),t._v(" "),i("div",{staticClass:"center"},[i("input",{directives:[{name:"model",rawName:"v-model.lazy",value:e.remark,expression:"roi.remark",modifiers:{lazy:!0}}],attrs:{type:"text",disabled:t.forbidden,placeholder:t.$t("slice.input"),maxlength:"300",title:e.remark},domProps:{value:e.remark},on:{keydown:function(e){if(!e.type.indexOf("key")&&t._k(e.keyCode,"delete",[8,46],e.key,["Backspace","Delete","Del"]))return null;e.stopPropagation()},input:t.noEmoji,blur:function(i){return t.$emit("roiChanged","remark",[e])},change:function(i){return t.$set(e,"remark",i.target.value)}}})]),t._v(" "),i("div",{staticClass:"right"},[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])])}),0)])},staticRenderFns:[]};var f=i("VU/8")(m,g,!1,function(t){i("DRUA")},"data-v-24ebb68c",null).exports,_={data(){return{centerRegion:null,curRois:{},position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},curLevel:{},leftRoilist:[],rightRoilist:[],loading:!1}},methods:{async getRoi(t){let{x1:e,y1:i,x2:a,y2:n,z:o}=t;this.curLevel={x:[e,a],y:[i,n],z:o},this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel),this.$emit("save","noListUpdate")},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois||{},...i.map(t=>({[t.id]:t})))},async roiChanged(t,e){let i;i=e?e.map(e=>({id:e.id,[t]:e[t]})):Object.values(this.curRois).map(e=>({id:e.id,[t]:e[t]}));let a="image"==t||"remark"==t?null:this.$refs.osd.scope;a&&a.offset&&(this.curRois={},this.$refs.osd.scope=null),a?this.$message.error("不支持多选移动"):(this.loading=!0,await Object(s.c)(this.record.id,this.slice.id,"human",i,a),this.loading=!1),Object.keys(this.curRois).map(t=>{this.leftRoilist.some(e=>e.id==t)||(delete this.curRois[t],this.curRois=Object.assign({},this.curRois))}),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel)},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null,this.$refs.osd.scope=null},async draw(t,e){t.strokeColor="yellow",t.mark_type=1,t.id=await Object(s.e)(this.record.id,this.slice.id,t),t.id&&(this.leftRoilist=[...this.leftRoilist,t],this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel),this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),this.curROIChange(t,e))},async clickDraw(t,e){var i={path:{x:[t.x],y:[t.y]},method:"spot",radius:3/(this.slice.mppx||.242042),mark_type:1,fillColor:"yellow"};i.id=await Object(s.e)(this.record.id,this.slice.id,i),i.id&&(this.leftRoilist=[...this.leftRoilist,i],this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel),this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),this.curROIChange(i,e))},async delCurRoi(t){t?(this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,"human",[t.id],null),this.loading=!1,this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois)),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel),this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id)):await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})&&(this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,"human",Object.keys(this.curRois).map(t=>t),this.$refs.osd.scope),this.loading=!1,this.curRois={},this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel),this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id))},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},async mounted(){this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id)},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},y={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright"},[i("v-dragon",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"osd",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:t.leftRoilist,curRois:t.curRois,centerRegion:t.centerRegion,position:t.position,penColor:"yellow","element-loading-text":"处理中，请耐心等待","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.5)"},on:{curROI:t.curROIChange,roiChanged:t.roiChanged,draw:t.draw,clickDraw:t.clickDraw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},getRoi:t.getRoi}})],1),t._v(" "),i("div",{staticClass:"analylist"},[i("v-roi",{attrs:{roilist:t.rightRoilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}})],1)])},staticRenderFns:[]};var b=i("VU/8")(_,y,!1,function(t){i("z+oc")},"data-v-16cd72da",null).exports,R=i("8TD5"),C={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"osd",class:{"fixed-fullpage":t.fullPage},on:{keydown:t.keydown}},[t._t("default"),t._v(" "),s("div",{ref:"osd",staticClass:"osd",on:{mousemove:t.mouseMove,mousedown:t.mouseDown,mousewheel:t.wheel,contextmenu:t.contextmenuDisplay}}),t._v(" "),s("div",{staticClass:"btm_left"},[s("div",{staticClass:"zoom-in",attrs:{title:t.$t("analyze.zoomin")},on:{click:function(e){return t.buttonClick("zoom-in")}}}),t._v(" "),s("p",{staticClass:"showzoom",attrs:{title:t.position.zoom/t.scale+"X"}},[t._v(t._s((t.position.zoom/t.scale).toFixed(1))+"X")]),t._v(" "),s("div",{staticClass:"zoom-out",attrs:{title:t.$t("analyze.zoomout")},on:{click:function(e){return t.buttonClick("zoom-out")}}}),t._v(" "),s("div",{ref:"home",staticClass:"home",attrs:{title:t.$t("analyze.home")},on:{click:function(e){return t.buttonClick("home")}}}),t._v(" "),s("div",{attrs:{title:t.$t("analyze.2x")},on:{click:function(e){return t.buttonClick(2*t.scale)}}},[t._v("2X")]),t._v(" "),s("div",{attrs:{title:t.$t("analyze.4x")},on:{click:function(e){return t.buttonClick(4*t.scale)}}},[t._v("4X")]),t._v(" "),s("div",{attrs:{title:t.$t("analyze.10x")},on:{click:function(e){return t.buttonClick(10*t.scale)}}},[t._v("10X")]),t._v(" "),s("div",{attrs:{title:t.$t("analyze.20x")},on:{click:function(e){return t.buttonClick(20*t.scale)}}},[t._v("20X")]),t._v(" "),s("div",{attrs:{title:t.$t("analyze.40x")},on:{click:function(e){return t.buttonClick(40*t.scale)}}},[t._v("40X")]),t._v(" "),s("div",{attrs:{title:t.$t("analyze.original")},on:{click:function(e){return t.buttonClick("original")}}},[t._v("1:1")]),t._v(" "),s("div",{staticClass:"full-page",class:{"exit-full-page":t.fullPage},attrs:{title:t.fullPage?t.$t("analyze.exitfullpage"):t.$t("analyze.fullpage")},on:{click:function(e){return t.handleFullScreen()}}})]),t._v(" "),s("div",{staticClass:"btm"},[t.sliceType?s("div",{staticClass:"freepen",class:{bigContent:"freepen"==t.selectedTool},attrs:{title:t.$t("analyze.circlepen")},on:{click:function(e){t.selectedTool="freepen"}}}):t._e(),t._v(" "),s("div",{staticClass:"drag",class:{bigContent:"choose"==t.selectedTool},attrs:{title:t.$t("analyze.choose")},on:{click:function(e){t.selectedTool="choose"}}}),t._v(" "),t.sliceType?s("div",{staticClass:"measure",class:{bigContent:"measure"==t.selectedTool},attrs:{title:t.$t("analyze.measuredepth")},on:{click:function(e){t.selectedTool="measure"}}}):t._e(),t._v(" "),t.sliceType?s("div",{staticClass:"level_measure",class:{bigContent:"level_measure"==t.selectedTool},attrs:{title:t.$t("analyze.measurepMH")},on:{click:function(e){t.selectedTool="level_measure"}}}):t._e(),t._v(" "),t.sliceType?s("div",{staticClass:"verticl_measure",class:{bigContent:"verticl_measure"==t.selectedTool},attrs:{title:t.$t("analyze.measurepVM")},on:{click:function(e){t.selectedTool="verticl_measure"}}}):t._e(),t._v(" "),-1!==this.slice.filename.indexOf("痕")?s("div",{staticClass:"signpen",class:{bigContent:"signpen"==t.selectedTool},attrs:{title:t.$t("analyze.signpen")},on:{click:function(e){t.selectedTool="signpen"}}}):t._e(),t._v(" "),t.sliceType?s("div",{staticClass:"circlepen",class:{bigContent:"circlepen"==t.selectedTool},attrs:{title:t.$t("analyze.freepen")},on:{click:function(e){t.selectedTool="circlepen"}}}):t._e(),t._v(" "),-1!==this.slice.filename.indexOf("痕")?s("div",{staticClass:"translate",class:{bigContent:"translate"==t.selectedTool},attrs:{title:t.$t("analyze.translate")},on:{click:function(e){t.selectedTool="translate"}}}):t._e(),t._v(" "),-1!==this.slice.filename.indexOf("体")?s("div",{staticClass:"crosscurve",class:{bigContent:"crosscurve"==t.selectedTool},attrs:{title:t.$t("analyze.crosscurve")},on:{click:function(e){t.selectedTool="crosscurve"}}}):t._e(),t._v(" "),s("v-attactments",{attrs:{record:t.record}})],1),t._v(" "),s("div",{ref:"circleOpt",staticClass:"circle_option"},[s("span",{attrs:{id:"pointed"}}),t._v(" "),s("div",{attrs:{title:"高级别上皮内瘤变（包括原位癌）"},on:{click:t.setCircleCol}},[s("i",{staticClass:"intraepithelial_neo",staticStyle:{background:"#FF2400"},attrs:{title:"高级别上皮内瘤变（包括原位癌）"}}),t._v("高级别上皮内瘤变（包括原位癌）\n        ")]),t._v(" "),s("div",{attrs:{title:"腺癌混合型"},on:{click:t.setCircleCol}},[s("i",{staticClass:"adenocarcinoma_mix",staticStyle:{background:"#FC00FF"},attrs:{title:"腺癌混合型"}}),t._v("腺癌混合型\n        ")]),t._v(" "),s("div",{attrs:{title:"管状腺癌"},on:{click:t.setCircleCol}},[s("i",{staticClass:"tubular_ade",staticStyle:{background:"#FF9F38"},attrs:{title:"管状腺癌"}}),t._v("管状腺癌\n        ")]),t._v(" "),s("div",{attrs:{title:"乳头状腺癌"},on:{click:t.setCircleCol}},[s("i",{staticClass:"papillary_ade",staticStyle:{background:"#F9E219"},attrs:{title:"乳头状腺癌"}}),t._v("乳头状腺癌\n        ")]),t._v(" "),s("div",{attrs:{title:"粘液腺癌"},on:{click:t.setCircleCol}},[s("i",{staticClass:"mucinous_ade",staticStyle:{background:"#59F659"},attrs:{title:"粘液腺癌"}}),t._v("粘液腺癌\n        ")]),t._v(" "),s("div",{attrs:{title:"印戒细胞癌"},on:{click:t.setCircleCol}},[s("i",{staticClass:"signet_ring",staticStyle:{background:"#B799FF"},attrs:{title:"印戒细胞癌"}}),t._v("印戒细胞癌\n        ")]),t._v(" "),s("div",{attrs:{title:"脉管癌栓"},on:{click:t.setCircleCol}},[s("i",{staticClass:"vascular_tumor",staticStyle:{background:"#3EAFDD"},attrs:{title:"脉管癌栓"}}),t._v("脉管癌栓\n        ")]),t._v(" "),s("div",{attrs:{title:"神经侵犯"},on:{click:t.setCircleCol}},[s("i",{staticClass:"nerve_invasion",staticStyle:{background:"#4682D7"},attrs:{title:"神经侵犯"}}),t._v("神经侵犯\n        ")]),t._v(" "),s("div",{attrs:{title:"其他"},on:{click:t.setCircleCol}},[s("i",{staticClass:"other_ade",staticStyle:{background:"#44414D"},attrs:{title:"其他"}}),t._v("其他\n        ")])]),t._v(" "),t.showScreenshot?s("div",{staticClass:"screenshot",on:{click:function(e){return t.screenshot(e)}}},[t._v("采图")]):t._e(),t._v(" "),-1!==this.slice.filename.indexOf("痕")?s("div",{staticClass:"mapping",on:{click:function(e){return t.mapping()}}},[t._v("映射")]):t._e(),t._v(" "),t.mapAgain?s("div",{staticClass:"mapping",on:{click:function(e){return t.mappAgain()}}},[t._v("重新映射")]):t._e(),t._v(" "),t.mapAgain?s("div",{staticClass:"esdscreenshot",on:{click:function(e){return t.esdscreenshot(e)}}},[t._v("采图")]):t._e(),t._v(" "),s("div",{ref:"hideToolbar",staticStyle:{display:"none"}}),t._v(" "),s("canvas",{ref:"canvas",staticClass:"canvas"}),t._v(" "),s("div",{ref:"navigator",staticClass:"navigator",style:{"background-image":"url(/aipath/api/files/thumbnail?caseid="+encodeURIComponent(t.record.id)+"&fileid="+t.slice.id+"&companyid="+t.company+")",width:150*Math.min(this.slice.width/this.slice.height,1)+"px",height:150*Math.min(this.slice.height/this.slice.width,1)+"px"}},[s("div",{staticClass:"focus",style:{"margin-left":100*t.position.offx+"%","margin-top":100*t.position.offy+"%",width:100/this.position.zoom+"%",height:this.offsetHeight/this.offsetWidth/this.slice.height*this.slice.width*100/this.position.zoom+"%"}})]),t._v(" "),t.saved?s("div",{staticClass:"saved"},[t._v("保存成功")]):t._e(),t._v(" "),t.showLabel?s("img",{ref:"rotate",staticClass:"label",attrs:{title:"点击旋转",src:"/aipath/api/files/getLabel?caseid="+t.record.id+"&fileid="+t.slice.id},on:{click:t.rotate}}):t._e(),t._v(" "),t.showMppGuide?s("div",{staticClass:"mpp-box"},[s("h2",[t._v("请框选出一个中等大小细胞核。如示例图:")]),t._v(" "),s("img",{attrs:{src:i("dQmP"),alt:"图例"}}),t._v(" "),s("span",{on:{click:function(e){return t.drawCell()}}},[t._v("我知道了")]),t._v(" "),s("div",{staticClass:"closeBtn",on:{click:function(e){return t.$emit("closeMppGuide",!0)}}},[s("img",{attrs:{src:i("HJaG"),alt:"关闭",width:"19"}})])]):t._e(),t._v(" "),t.knew?s("div",{staticClass:"knew"},[s("h2",[t._v("确认开始处理？")]),t._v(" "),s("div",{staticClass:"confirm-buttons"},[s("span",{staticClass:"finishdraw",on:{click:function(e){t.$emit("changeMpp",t.userMpp),t.curRoi.path.remove(),t.curRoi=null,t.knew=!1}}},[t._v("\n            确认")]),t._v(" "),s("span",{on:{click:function(e){t.$emit("changeMpp",!1),t.curRoi.path.remove(),t.curRoi=null,t.knew=!1}}},[t._v("\n            取消")])])]):t._e()],2)},staticRenderFns:[]};var w=function(t){i("zdsT"),i("C7nT")},k=i("VU/8")(R.a,C,!1,w,"data-v-05dde13f",null).exports,x={data(){return{isShow:-1===this.slice.filename.indexOf("痕"),isDaTi:-1===this.slice.filename.indexOf("体"),esdRoiList:[],esdSliceList:[],inputValue:""}},methods:{checkall(){let t=this.roilist.every(t=>!!t.image);this.roilist.forEach(e=>this.$set(e,"image",t?0:1)),this.$emit("closecontextmenu")},del(t){this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>this.$emit("delRoi",t),t=>t)},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},inputKeydown(t,e){this.inputValue=e},inputBlur(t,e,i){""===e.toString().trim()&&(this.roilist[i].name=this.inputValue)},inputBlur2(t,e,i){""===e.toString().trim()&&(this.esdSliceList[i].name=this.inputValue)},selectRoi(t){var e,i=[];this.record.slices.filter(t=>-1===t.name.indexOf("痕")&&-1===t.name.indexOf("体")).forEach(t=>{i=[...i,...t.roilist]}),e=i.filter(t=>"rectangle"===t.method),0!==t.image&&void 0!==t.image||0===e.length?(this.$set(t,"image",1-(t.image||0)),this.$emit("closecontextmenu"),this.$emit("chooseSFB",{flag:t.image,id:t.id})):this.$message({message:"已经选择了镜下所见图，请检查",type:"warning"})}},props:["roilist","currentRois","slice","record"],watch:{slices:{handler(t){console.log(t)},deep:!0}},mounted(){this.esdRoiList=this.roilist.filter(t=>"circlepen"===t.method),this.esdSliceList=this.roilist.filter(t=>"freepen"===t.method)},beforeUpdate(){this.esdRoiList=this.roilist.filter(t=>"circlepen"===t.method),this.esdSliceList=this.roilist.filter(t=>"freepen"===t.method)}},$={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"roi"},[t.isDaTi?i("div",{directives:[{name:"show",rawName:"v-show",value:!t.isShow,expression:"!isShow"}]},[i("div",{staticClass:"topMark"},[t._m(0),t._v(" "),i("div",{staticClass:"center"},[t._v("\n                "+t._s(t.$t("slice.cutName"))+"\n            ")]),t._v(" "),i("div",{staticClass:"center"},[t._v("\n                "+t._s(t.$t("slice.cutRemark"))+"\n            ")]),t._v(" "),i("div",{staticClass:"center"},[t._v("\n                "+t._s(t.$t("slice.lesionRemark"))+"\n            ")]),t._v(" "),i("div",{staticClass:"right"},[t._v("\n                "+t._s(t.$t("analyze.opration"))+"\n            ")])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.roilist,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){t.$emit("curROI",e,i.shiftKey),t.$emit("closecontextmenu")}}},[t._m(1,!0),t._v(" "),i("div",{staticClass:"center"},[i("input",{directives:[{name:"model",rawName:"v-model",value:e.name,expression:"roi.name"}],attrs:{type:"text",placeholder:t.$t("slice.input"),maxlength:"300",title:e.name},domProps:{value:e.name},on:{blur:function(i){return t.inputBlur(i,e.name,s)},keydown:[function(i){return t.inputKeydown(i,e.name)},function(e){if(!e.type.indexOf("key")&&t._k(e.keyCode,"delete",[8,46],e.key,["Backspace","Delete","Del"]))return null;e.stopPropagation()}],input:[function(i){i.target.composing||t.$set(e,"name",i.target.value)},t.noEmoji]}})]),t._v(" "),i("div",{staticClass:"center"},[i("input",{directives:[{name:"model",rawName:"v-model.lazy",value:e.shearRemark,expression:"roi.shearRemark",modifiers:{lazy:!0}}],attrs:{type:"text",placeholder:t.$t("slice.input"),maxlength:"300",title:e.shearRemark},domProps:{value:e.shearRemark},on:{keydown:function(e){if(!e.type.indexOf("key")&&t._k(e.keyCode,"delete",[8,46],e.key,["Backspace","Delete","Del"]))return null;e.stopPropagation()},input:t.noEmoji,change:function(i){return t.$set(e,"shearRemark",i.target.value)}}})]),t._v(" "),i("div",{staticClass:"center"},[i("input",{directives:[{name:"model",rawName:"v-model.lazy",value:e.lesionRemark,expression:"roi.lesionRemark",modifiers:{lazy:!0}}],attrs:{type:"text",placeholder:t.$t("slice.input"),maxlength:"300",title:e.lesionRemark},domProps:{value:e.lesionRemark},on:{keydown:function(e){if(!e.type.indexOf("key")&&t._k(e.keyCode,"delete",[8,46],e.key,["Backspace","Delete","Del"]))return null;e.stopPropagation()},input:t.noEmoji,change:function(i){return t.$set(e,"lesionRemark",i.target.value)}}})]),t._v(" "),i("div",{staticClass:"right"},[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])])}),0)]):t._e(),t._v(" "),t.isDaTi?i("div",{directives:[{name:"show",rawName:"v-show",value:t.isShow,expression:"isShow"}]},[i("div",{staticClass:"topSlice"},[t._m(2),t._v(" "),i("div",{staticClass:"center"},[t._v("\n                "+t._s(t.$t("slice.tissueStrip"))+"\n            ")]),t._v(" "),i("div",{staticClass:"center"},[t._v("\n                "+t._s(t.$t("slice.regionalRemark"))+"\n            ")]),t._v(" "),i("div",{staticClass:"center"},[t._v("\n                "+t._s(t.$t("slice.lesionNumber"))+"\n            ")]),t._v(" "),i("div",{staticClass:"center"},[t._v("\n                "+t._s(t.$t("slice.lesionRemark"))+"\n            ")]),t._v(" "),i("div",{staticClass:"right"},[t._v("\n                "+t._s(t.$t("analyze.opration"))+"\n            ")])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.esdSliceList,function(e,s){return i("div",{key:s},[i("div",{staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){t.$emit("curROI",e,i.shiftKey),t.$emit("closecontextmenu")}}},[t._m(3,!0),t._v(" "),i("div",{staticClass:"center"},[i("input",{directives:[{name:"model",rawName:"v-model",value:e.name,expression:"roi.name"}],attrs:{type:"text",placeholder:t.$t("slice.input"),maxlength:"300",title:e.name},domProps:{value:e.name},on:{blur:function(i){return t.inputBlur2(i,e.name,s)},keydown:[function(i){return t.inputKeydown(i,e.name)},function(e){if(!e.type.indexOf("key")&&t._k(e.keyCode,"delete",[8,46],e.key,["Backspace","Delete","Del"]))return null;e.stopPropagation()}],input:[function(i){i.target.composing||t.$set(e,"name",i.target.value)},t.noEmoji]}})]),t._v(" "),i("div",{staticClass:"center"},[i("input",{directives:[{name:"model",rawName:"v-model.lazy",value:e.tD,expression:"roi.tD",modifiers:{lazy:!0}}],attrs:{type:"text",placeholder:t.$t("slice.input"),maxlength:"300",title:e.tD,disabled:"disabled"},domProps:{value:e.tD},on:{keydown:function(e){if(!e.type.indexOf("key")&&t._k(e.keyCode,"delete",[8,46],e.key,["Backspace","Delete","Del"]))return null;e.stopPropagation()},input:t.noEmoji,change:function(i){return t.$set(e,"tD",i.target.value)}}})]),t._v(" "),i("div",{staticClass:"center"}),t._v(" "),i("div",{staticClass:"center"}),t._v(" "),i("div",{staticClass:"right"},[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])]),t._v(" "),t._l(e.esdMessage,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){t.$emit("curROI",t.esdRoiList.find(function(t){return t.id==e.id}),i.shiftKey),t.$emit("closecontextmenu")}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){return i.stopPropagation(),t.selectRoi(e)}}})])]),t._v(" "),i("div",{staticClass:"center"}),t._v(" "),i("div",{staticClass:"center"}),t._v(" "),i("div",{staticClass:"center"},[i("input",{directives:[{name:"model",rawName:"v-model.lazy",value:e.name,expression:"esd.name",modifiers:{lazy:!0}}],attrs:{type:"text",placeholder:t.$t("slice.input"),maxlength:"300",title:e.name},domProps:{value:e.name},on:{keydown:function(e){if(!e.type.indexOf("key")&&t._k(e.keyCode,"delete",[8,46],e.key,["Backspace","Delete","Del"]))return null;e.stopPropagation()},input:t.noEmoji,change:function(i){return t.$set(e,"name",i.target.value)}}})]),t._v(" "),i("div",{staticClass:"center"},[i("input",{directives:[{name:"model",rawName:"v-model.lazy",value:e.iD,expression:"esd.iD",modifiers:{lazy:!0}}],attrs:{type:"text",placeholder:t.$t("slice.input"),maxlength:"300",title:e.iD,disabled:"disabled"},domProps:{value:e.iD},on:{keydown:function(e){if(!e.type.indexOf("key")&&t._k(e.keyCode,"delete",[8,46],e.key,["Backspace","Delete","Del"]))return null;e.stopPropagation()},input:t.noEmoji,change:function(i){return t.$set(e,"iD",i.target.value)}}})]),t._v(" "),i("div",{staticClass:"right"},[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){i.stopPropagation(),t.del(t.esdRoiList.find(function(t){return t.id==e.id}))}}})])])})],2)}),0)]):t._e()])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"left"},[e("div")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"left"},[e("div")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"left"},[e("div")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"left"},[e("div")])}]};var I=i("VU/8")(x,$,!1,function(t){i("QQWi")},"data-v-a3aec872",null).exports,O=(i("OMJi"),{data(){return{centerRegion:null,curRois:{},position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null}}},methods:{importJson(t){var e=this.$refs.importJson;e.onchange=(()=>{var t=new FileReader;t.readAsText(e.files[0],"UTF-8"),t.onload=(e=>{var i=JSON.parse(t.result);if(!i||!i.roilist||!i.roilist.length)return this.$alert("没有roi list");this.slice.roilist=i.roilist&&i.roilist.map(t=>({id:(Math.random()+"").substr(2,6),path:t.path,remark:t.remark,method:t.path.x.length>5?"freepen":"rectangle"}))})}),e.click()},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois||{},...i.map(t=>({[t.id]:t}))),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},changeEsdRoiColoe(t,e,i){this.slice.roilist.forEach(s=>{s.id===i&&(s.color=t),"freepen"==s.method&&s.esdMessage&&s.esdMessage.forEach(s=>{s.id==i&&(s.color=t,s.title=e)})})},draw(t){"rectangle"!==t.method&&(t.id=(Math.random()+"").substr(2,6)),this.slice.roilist=[...this.slice.roilist,t]},addMeasure(t,e,i){this.slice[i]?this.slice[i].push({length:t,id:e}):this.slice[i]=[{length:t,id:e}]},addEsdMes(t,e){this.slice.roilist.forEach(i=>{i.id===t&&"freepen"===i.method&&(i.esdMessage?i.esdMessage.push(e):this.$set(i,"esdMessage",[e]))})},clickDraw(t,e){var i=60,s=t.x,a=t.y,n={id:(Math.random()+"").substr(2,6),path:{x:[s-i,s+i,s+i,s-i],y:[a-i,a-i,a+i,a+i]},width:3,method:"rectangle"};this.slice.roilist=[...this.slice.roilist,n],this.curROIChange(n,e)},addSignLineArr(t){this.record.signLineArr=t},reverseRoi(t){if(t&&this.slice.roilist.map(e=>{e.id===t.id&&(e.path.x.reverse(),e.path.y.reverse())}),this.record.signLineArr){for(var e in this.record.signLineArr)this.record.signLineArr[e].forEach(t=>{t.remove()});this.$refs.esdDargon.mapping()}},chooseSFB(t){this.$refs.esdDargon.chooseSFB(t)},async delCurRoi(t){if(t){if("circlepen"===t.method){for(var e=0;e<this.slice.roilist.length;e++)"freepen"===this.slice.roilist[e].method&&(this.slice.roilist[e].esdMessage=this.slice.roilist[e].esdMessage.filter(e=>e.id!==t.id));var i=this.slice.roilist.find(e=>e.id==="rectangle"+t.id);i&&(this.slice.roilist=this.slice.roilist.filter(t=>t.id!=i.id))}"freepen"===t.method&&t.esdMessage&&0!==t.esdMessage.length&&t.esdMessage.forEach(t=>{for(var e=0;e<this.slice.roilist.length;e++)if(this.slice.roilist[e].id==t.id){this.slice.roilist.splice(e,1);var i=this.slice.roilist.find(e=>e.id==="rectangle"+t.id);i&&(this.slice.roilist=this.slice.roilist.filter(t=>t.id!=i.id))}}),"signpen"===t.method&&this.record.signLineArr&&this.record.signLineArr[t.id]&&this.record.signLineArr[t.id].forEach(t=>{t.remove()}),"measure"===t.method&&(this.slice.measure=this.slice.measure.filter(e=>e.id!=t.id)),"level_measure"===t.method&&(this.slice.level_measure=this.slice.level_measure.filter(e=>e.id!=t.id)),"verticl_measure"===t.method&&(this.slice.verticl_measure=this.slice.verticl_measure.filter(e=>e.id!=t.id)),this.slice.roilist=this.slice.roilist.filter(e=>e.id!=t.id),this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))}else{await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})&&(this.slice.roilist=this.slice.roilist.filter(t=>!this.curRois[t.id]),this.curRois={})}},async keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})&&this.slice.roilist.filter(t=>this.curRois[t.id]).forEach(t=>{this.delCurRoi(t)})}},mounted(){},props:["slice","record"],components:{"v-dragon":k,"v-roi":I}}),S={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown,keypress:function(e){return(e.type.indexOf("key")||9===e.keyCode)&&e.ctrlKey?t.importJson(e):null}}},[i("div",{staticClass:"analyright"},[i("v-dragon",{ref:"esdDargon",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:t.slice.roilist.map(function(t){return Object.assign({},t)}),curRois:t.curRois,centerRegion:t.centerRegion,position:t.position},on:{curROI:t.curROIChange,draw:t.draw,addMeasure:t.addMeasure,changeEsdRoiColoe:t.changeEsdRoiColoe,addEsdMes:t.addEsdMes,clickDraw:t.clickDraw,delRoi:function(e){return t.delCurRoi(e)},reverseRoi:function(e){return t.reverseRoi(e)},addSignLineArr:function(e){return t.addSignLineArr(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)}}})],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{staticClass:"noauto"},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),i("v-roi",{attrs:{record:t.record,roilist:t.slice.roilist,currentRois:t.curRois,slice:t.slice},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},chooseSFB:function(e){return t.chooseSFB(e)}}}),t._v(" "),i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("report.remark"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})])],1),t._v(" "),i("input",{ref:"importJson",staticStyle:{visibility:"hidden"},attrs:{type:"file"}})])},staticRenderFns:[]};var A=i("VU/8")(O,S,!1,function(t){i("xAxs")},"data-v-0978bfa3",null).exports,T={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,totalArea:"",showMppGuide:!1,drawMpp:null,parentId:"",leftRoilist:[],rightRoilist:[],cellsegList:[]}},methods:{async getRoi(t){let{x1:e,y1:i,x2:a,y2:n,z:o}=t;this.curLevel={x:[e,a],y:[i,n],z:o},this.leftRoilist=[...await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"cellseg")]},async roiChanged(t,e){let i;i=e?e.map(e=>({id:e.id,[t]:e[t],area_id:e.area_id})):Object.values(this.curRois).map(e=>({id:e.id,[t]:e[t],area_id:e.area_id})),await Object(s.c)(this.record.id,this.slice.id,this.slice.toolType,i,this.$refs.osd.scope),this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"cellseg"),this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"cellseg"),Object.keys(this.curRois).map(t=>{this.leftRoilist.some(e=>e.id==t)||(delete this.curRois[t],this.curRois=Object.assign({},this.curRois))})},exponentialToNormal:t=>t.split("e")[0]+"*10^"+t.split("e")[1].replace("+",""),isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;!t||"grey"==t.color&&this.totalArea>1e5?(i=[],this.totalArea=0):t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"red"==t.color||"grey"==t.color?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t})),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},getArea(t){if(t.area)return t.area;for(var e=0,i=0;i<t.x.length-2;i++){if(i+2<t.x.length)var s=[t.x[0],t.y[0]],a=[t.x[i+1],t.y[i+1]],n=[t.x[i+2],t.y[i+2]];e+=(Math.abs(s[0]*a[1])+Math.abs(a[0]*n[1])+Math.abs(n[0]*s[1])-Math.abs(s[0]*n[1])-Math.abs(a[0]*s[1])-Math.abs(n[0]*a[1]))/2}return t.area=Math.round(Math.abs(e)*Math.pow(this.slice.mppx||.242042,2))},draw(t){this.totalArea=this.getArea(t.path);for(var e=0;e<this.slice.cellseg.result.length;e++)this.totalArea+=this.getArea(this.slice.cellseg.result[e].path);if(t.id=(Math.random()+"").substr(2,6),"freepen"===t.method&&(t.simplify=2),this.auto){if(this.totalArea>1e5)return void this.$message({message:"ROI总面积不能大于0.1mm²",type:"warning"});this.slice.cellseg.result?this.slice.cellseg.result=[...this.slice.cellseg.result,t]:(this.slice.cellseg.result=[],this.slice.cellseg.result=[...this.slice.cellseg.result,t])}else this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){this.showbutton?t?(await Object(s.f)(this.record.id,this.slice.id,this.slice.toolType,[t.id],this.$refs.osd.scope),this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois)),1===t.mark_type&&(this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id)),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"cellseg")):await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})&&(await Object(s.f)(this.record.id,this.slice.id,this.slice.toolType,Object.keys(this.curRois),this.$refs.osd.scope),[...new Set(Object.values(this.curRois).map(t=>t.mark_type))].map(async t=>{1===t?this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id):this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"cellseg")}),this.curRois={},this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"cellseg")):this.$message.error("处理中无法删除")},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"cellseg",other:JSON.stringify((this.slice.cellseg.result?this.slice.cellseg.result:[]).map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.$set(this.slice,"type","cellseg"),-1!=t.data.rank)this.slice.cellseg.diagnosis=this.flag="error";else{Object.keys(t.data.result).filter(t=>!this.slice.cellseg.result.find(e=>e.id==t)).map(e=>delete t.data.result[e]);var e=Object.values(t.data.result).map((e,i)=>e.map(e=>e.fatherid=Object.keys(t.data.result)[i]))&&[...[].concat(...Object.values(t.data.result))].map(t=>({path:t,id:(Math.random()+"").substr(2,8),editable:!1,fatherid:t.fatherid}));this.$set(this.slice.cellseg,"airesult",e),this.$set(this.slice.cellseg,"diagnosis",1)}this.updateRecord()}else this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3)})},async startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.slice.cellseg.result&&0!=this.slice.cellseg.result.length?(this.$set(this.slice.cellseg,"airesult",[]),this.$set(this.slice.cellseg,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,this.auto=!0,Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.cellseg.airesult.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),await Object(s.n)(t,e,i,"cellseg",JSON.stringify(this.slice.cellseg.result.map(t=>({id:t.id,x:t.path.x,y:t.path.y})))),this.getAlgorithmResult()):this.$message({message:"请先绘制ROI,再进行处理",type:"warning"})},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"cellseg",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},beforeMount(){this.slice.cellseg||this.$set(this.slice,"cellseg",{})},async mounted(){this.slice.started&&this.slice.cellseg&&null===this.slice.cellseg.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()}),this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),this.cellsegList=await Object(s.l)(this.record.id,this.slice.id,"cellseg")},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},M={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright"},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:t.leftRoilist,curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:116},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},getRoi:t.getRoi,roiChanged:t.roiChanged,parentId:function(e){return t.parentId=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto&&this.slice.cellseg?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:t.cellsegList,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.rightRoilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),!this.slice.cellseg&&t.auto?i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[]};var j=i("VU/8")(T,M,!1,function(t){i("gpZe")},"data-v-06174bd4",null).exports,F={data:()=>({}),methods:{changeImage(t){this.$set(t,"image",1-(t.image||0)),this.$emit("roiChanged","image",[t])},checkall(){if(!this.ROIS.length)return;let t=this.ROIS.every(t=>!!t.image),e=this.ROIS.map(e=>{return{id:e.id,image:t?0:1}});this.$emit("roiChanged","image",e)},del(t){this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})}},props:["ROIS","currentRois","slice","ave"]},P={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"ki67rois"},[t.ROIS.length?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),t.ROIS?i("div",{staticClass:"table"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:t.ROIS.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                    ROI\n                ")])]),t._v(" "),i("div",{staticClass:"center"},[t._v(t._s(t.$t("slice.total")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.deleted")))])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.ROIS,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){return t.$emit("curROI",e,i.shiftKey)}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){return i.stopPropagation(),t.changeImage(e)}}}),t._v("\n                        "+t._s(s+1)+"\n                    ")])]),t._v(" "),i("div",{staticClass:"center"},[t._v(t._s(e.aiResult.total))]),t._v(" "),i("div",[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])])}),0)]):t._e(),t._v(" "),t.ROIS?i("div",{staticClass:"ki67btm"},[t._v("总数：\n        "),i("span",[t._v("\n            "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.total}).reduce(function(t,e){return t+e},0))+"\n        ")])]):t._e()])},staticRenderFns:[]};var E=i("VU/8")(F,P,!1,function(t){i("F0Cz"),i("UIaW")},null,null).exports;var L={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,showMppGuide:!1,drawMpp:null,parentId:null,curLevel:{},leftRoilist:[],rightRoilist:[],aiFatherRois:[],loading:!1}},methods:{async getRoi(t){let{x1:e,y1:i,x2:a,y2:n,z:o}=t;this.curLevel={x:[e,a],y:[i,n],z:o},this.leftRoilist=[...await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"celldet")]},isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.filter(t=>!t.aiResult||!t.aiResult.whole_slide).map(t=>"grey"==t.strokeColor?{[t.id]:Object.assign({},t,{editable:0})}:{[t.id]:t}))},async roiChanged(t,e){let i;i=e?e.map(e=>({id:e.id,[t]:e[t],area_id:e.area_id})):Object.values(this.curRois).map(e=>({id:e.id,[t]:e[t],area_id:e.area_id}));let a="image"==t||"remark"==t?null:this.$refs.osd.scope;a&&a.offset&&(this.curRois={},this.$refs.osd.scope=null),a?this.$message.error("不支持多选移动"):await Object(s.c)(this.record.id,this.slice.id,"celldet",i,a),this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"celldet"),this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"celldet"),Object.keys(this.curRois).map(t=>{this.leftRoilist.some(e=>e.id==t)||(delete this.curRois[t],this.curRois=Object.assign({},this.curRois))})},listChangeCurrent(){if(Object.keys(this.curRois).length){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null,this.$refs.osd.scope=null}},async draw(t,e){t.strokeColor="yellow",t.mark_type=1,this.auto&&(t.strokeColor="grey",t.mark_type=3,t.ai_type="celldet",t.editable=0),t.id=await Object(s.e)(this.record.id,this.slice.id,t),t.id&&(this.curROIChange(t,e),this.leftRoilist=[...this.leftRoilist,t],this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"celldet"),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"celldet"),Object.keys(this.curRois).map(t=>{this.leftRoilist.some(e=>e.id==t)||(delete this.curRois[t],this.curRois=Object.assign({},this.curRois))}))},async delCurRoi(t){if(this.showbutton)if(t){for(var e in this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,"celldet",[t.id],null),this.loading=!1,this.curRois)this.curRois[e].area_id==t.id&&(delete this.curRois[e],this.curRois=Object.assign({},this.curRois));this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois)),3===t.mark_type&&(this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"celldet")),1===t.mark_type&&(this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id)),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"celldet")}else{await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})&&(this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,"celldet",Object.keys(this.curRois),this.$refs.osd.scope),this.loading=!1,[...new Set(Object.values(this.curRois).map(t=>t.mark_type))].map(async t=>{1===t?this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id):this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"celldet")}),this.curRois={},this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"celldet"))}else this.$message.error("处理中无法删除")},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){let a=this.aiFatherRois.filter(t=>!t.aiResult.whole_slide).map(t=>({id:t.id,x:t.path.x,y:t.path.y}));Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"celldet",other:JSON.stringify(a)}).then(async t=>{this.lineup=t.data.rank,t.data.done?(this.showbutton=!0,this.loopHandler=0,-1==t.data.rank&&(this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"celldet"),this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"celldet")),this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{celldetStarted:!1}))):(this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3))})},startAnalyze(){this.aiFatherRois.length&&this.aiFatherRois.some(t=>t.aiResult.whole_slide)?this.$confirm("一旦开始，将清空当前的全场图算法结果，确认要开始吗？",{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(async()=>{let t=this.aiFatherRois.filter(t=>t.aiResult.whole_slide).map(t=>t.id);this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,"celldet",t,this.$refs.osd.scope),this.loading=!1,this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"celldet"),this.start()}).catch(()=>{}):this.start()},async start(t=this.record.id,e=this.slice.id,i=this.slice.filename){let a=this.aiFatherRois.filter(t=>!t.aiResult.whole_slide).map(t=>({id:t.id,x:t.path.x,y:t.path.y}));this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{celldetStarted:!0})),this.showbutton=!1,this.auto=!0,this.aiFatherRois.map(t=>t.image=1),await Object(s.c)(this.record.id,this.slice.id,"celldet",this.aiFatherRois.map(t=>({id:t.id,image:t.image})),null),await Object(s.n)(t,e,i,"celldet",JSON.stringify(a)),this.curRois={},this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"celldet"),this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"celldet"),Object.values(this.curRois).map(t=>this.leftRoilist.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),this.getAlgorithmResult()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"celldet",other:""}).then(async t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{celldetStarted:!1})),this.aiFatherRois.map(t=>t.image=0),await Object(s.c)(this.record.id,this.slice.id,"celldet",this.aiFatherRois.map(t=>({id:t.id,image:t.image})),null))}).catch(t=>console.log(t))},updateRecord(){this.$emit("save")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},async mounted(){this.slice.ai_dict.celldetStarted&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()}),this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"celldet")},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save"),this.startAnalyze())}}},computed:{getCommonAnnotation(){var t=Object.values(this.curRois);return t[0]&&t.every(t=>t.jgResult)&&t.every(e=>e.jgResult==t[0].jgResult)?t[0].jgResult.split(",")[0]:""}},props:["slice","record"],components:{"v-dragon":v.a,"v-analyroi":E,"v-roi":f}},D={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright"},[i("v-dragon",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"osd",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:t.leftRoilist,curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:110,"element-loading-text":"处理中，请耐心等待","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.5)"},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},getRoi:t.getRoi,roiChanged:t.roiChanged,parentId:function(e){return t.parentId=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("div",{staticClass:"quality"},[t._m(0),t._v(" "),i("div",{staticClass:"quality-detail"},[i("p",[t._v("清 晰 度："+t._s(t.slice.clarity?(100*t.slice.clarity).toFixed(2)+"%":"-"))]),t._v(" "),i("p",[t._v("扫描倍数："+t._s(t.slice.objective_rate||"-"))])])]),t._v(" "),i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v("AI处理")]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v("手动处理")])]),t._v(" "),t.auto?i("v-analyroi",{staticClass:"table",attrs:{slice:t.slice,ROIS:t.aiFatherRois,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.rightRoilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"title"},[e("span",[this._v("AI质控")])])}]};var H=i("VU/8")(L,D,!1,function(t){i("FsJv")},"data-v-327f71c0",null).exports,z={data(){return{company:Object(s.o)().company,locked:!0,centerRegion:null,curRois:{},slice2:this.record.slices.find(t=>t.id==this.slice.id2),curLevel:{},leftRoilist:[],rightRoilist:[],loading:!1,showRotateSet:!1,defaultRotate:0,currentAngle:0}},computed:{getCommonAnnotation(){var t=Object.values(this.curRois);return t[0]&&t.every(e=>e.jgResult==t[0].jgResult)?t[0].jgResult:""}},methods:{closeRotateSet(){this.showRotateSet=!1},lockOrnot(){!this.locked||this.showRotateSet?this.showRotateSet=!this.showRotateSet:this.$message.error("请先解锁")},rotate(t){this.locked?this.$message.error("请先解锁"):(this.currentAngle=t,this.$refs.osd2.viewport.setRotation(t),Object(s.b)("files/alterAngle",{caseid:this.record.id,fileid:this.slice2.id,currentAngle:this.currentAngle}).then(t=>{t.code&&this.$message.error(t.msg)}))},async getRoi(t){let{x1:e,y1:i,x2:a,y2:n,z:o}=t;this.curLevel={x:[e,a],y:[i,n],z:o},this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel),this.$emit("save","noListUpdate")},setPosition(t,e,i,s){var[a,n]=1==s?[this.slice.position,this.slice.position2]:[this.slice.position2,this.slice.position];if(this.locked&&a&&n&&a.zoom){var o=n.zoom/a.zoom;if(1==s){let s=(t-a.offx)*Math.cos(this.currentAngle*(Math.PI/180))/o,l=(e-a.offy)*Math.cos(this.currentAngle*(Math.PI/180))/o;Object.assign(n,{offx:s+(e-a.offy)*Math.sin(this.currentAngle*(Math.PI/180))+n.offx,offy:l+(a.offx-t)*Math.sin(this.currentAngle*(Math.PI/180))+n.offy,zoom:i*o})}else{let s=(t-a.offx)*Math.cos(this.currentAngle*(Math.PI/180))/o,l=(e-a.offy)*Math.cos(this.currentAngle*(Math.PI/180))/o;Object.assign(n,{offx:s-(e-a.offy)*Math.sin(this.currentAngle*(Math.PI/180))+n.offx,offy:l-(a.offx-t)*Math.sin(this.currentAngle*(Math.PI/180))+n.offy,zoom:i*o})}}Object.assign(a,{offx:t,offy:e,zoom:i})},showSlide(t){this.slice.id2=t,this.slice2=this.record.slices.find(e=>e.id==t);var{offx:e,offy:i,zoom:s}=this.slice.position;this.$set(this.slice,"position2",{offx:e,offy:i,zoom:s}),this.setAngle()},setAngle(){Object(s.b)("files/getAngle",{caseid:this.record.id,fileid:this.slice2.id}).then(t=>{t.code?this.$message.error(t.msg):(this.defaultRotate=t.data.aiAngle,this.currentAngle=t.data.currentAngle,this.$refs.osd2.viewport.setRotation(this.currentAngle))})},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois||{},...i.map(t=>({[t.id]:t})))},async roiChanged(t,e){let i;i=e?e.map(e=>({id:e.id,[t]:e[t]})):Object.values(this.curRois).map(e=>({id:e.id,[t]:e[t]}));let a="image"==t||"remark"==t?null:this.$refs.osd.scope;a&&a.offset&&(this.curRois={},this.$refs.osd.scope=null),a?this.$message.error("不支持多选移动"):(this.loading=!0,await Object(s.c)(this.record.id,this.slice.id,"human",i,a),this.loading=!1),Object.keys(this.curRois).map(t=>{this.leftRoilist.some(e=>e.id==t)||(delete this.curRois[t],this.curRois=Object.assign({},this.curRois))}),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel)},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null,this.$refs.osd.scope=null},async draw(t,e){t.strokeColor="yellow",t.mark_type=1,t.id=await Object(s.e)(this.record.id,this.slice.id,t),t.id&&(this.leftRoilist=[...this.leftRoilist,t],this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel),this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),this.curROIChange(t,e))},async clickDraw(t,e){var i={path:{x:[t.x],y:[t.y]},method:"spot",radius:3/(this.slice.mppx||.242042),mark_type:1,fillColor:"yellow"};i.id=await Object(s.e)(this.record.id,this.slice.id,i),i.id&&(this.leftRoilist=[...this.leftRoilist,i],this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel),this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),this.curROIChange(i,e))},async delCurRoi(t){t?(this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,"human",[t.id],this.$refs.osd.scope),this.loading=!1,this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois)),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel),this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id)):await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})&&(this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,"human",Object.keys(this.curRois).map(t=>t),this.$refs.osd.scope),this.loading=!1,this.curRois={},this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel),this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id))},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},watch:{},async mounted(){this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),document.addEventListener("click",this.closeRotateSet),this.slice2&&this.setAngle()},beforeDestroy(){document.removeEventListener("click",this.closeRotateSet)},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},N={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{ref:"doubleScreen",staticClass:"analyright"},[i("div",{staticClass:"left-list"},[i("v-dragon",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"osd",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:t.leftRoilist,curRois:t.curRois,centerRegion:t.centerRegion,position:t.slice.position,penColor:"yellow","element-loading-text":"处理中，请耐心等待","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.5)"},on:{curROI:t.curROIChange,roiChanged:t.roiChanged,draw:t.draw,clickDraw:t.clickDraw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){return t.setPosition(e,i,s,1)},getRoi:t.getRoi}})],1),t._v(" "),i("div",{staticClass:"left-list right-list"},[t.slice2?t._e():i("ul",{staticClass:"img-list"},[t._l(t.record.slices.filter(function(t){return t.width}),function(e){return i("li",{key:e.id,style:"background-image:url(/aipath/api/files/thumbnail?caseid="+encodeURIComponent(t.record.id)+"&fileid="+e.id+"&companyid="+t.company+");",on:{click:function(i){return t.showSlide(e.id)}}},[i("p",{attrs:{title:e.name}},[t._v(t._s(e.name))])])}),t._v(" "),i("li",{staticClass:"itemempty"}),t._v(" "),i("li",{staticClass:"itemempty"}),t._v(" "),i("li",{staticClass:"itemempty"})],2),t._v(" "),t.slice2?i("v-dragon",{ref:"osd2",staticClass:"dragon",attrs:{record:t.record,slice:t.slice2,roilist:t.leftRoilist,currentAngle:t.currentAngle,curRois:t.curRois,centerRegion:t.centerRegion,position:t.slice.position2,penColor:"yellow"},on:{curROI:t.curROIChange,draw:t.draw,roiChanged:t.roiChanged,clickDraw:t.clickDraw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){return t.setPosition(e,i,s,2)},getRoi:t.getRoi}},[i("div",{staticClass:"rotare-slide",on:{click:function(e){return e.stopPropagation(),t.lockOrnot(e)}}},[i("div",{staticClass:"img",class:{checked:t.showRotateSet}}),t._v(" "),t.showRotateSet?i("div",{staticClass:"rotate-set",on:{click:function(t){t.stopPropagation()}}},[i("h2",[t._v("图像旋转")]),t._v(" "),i("div",{staticClass:"slide-set"},[i("el-slider",{attrs:{"show-tooltip":!1,max:360},on:{change:function(e){return t.rotate(e)}},model:{value:t.currentAngle,callback:function(e){t.currentAngle=e},expression:"currentAngle"}}),t._v(" "),i("div",{staticClass:"rotate-value"},[i("div",{staticClass:"simble",on:{click:function(e){return t.rotate(t.currentAngle-1)}}},[t._v("-")]),t._v(" "),i("div",{staticClass:"ankle"},[t._v(t._s(t.currentAngle)+"°")]),t._v(" "),i("div",{staticClass:"simble",on:{click:function(e){return t.rotate(t.currentAngle+1)}}},[t._v("+")])]),t._v(" "),i("div",{staticClass:"slide-reset",on:{click:function(e){return t.rotate(t.defaultRotate)}}},[t._v("复位")])],1)]):t._e()])]):t._e(),t._v(" "),t.slice2?i("div",{staticClass:"goback",on:{click:function(e){t.slice2=null,t.curRois={}}}},[t._v("重选切片")]):t._e()],1),t._v(" "),i("div",{staticClass:"locked",class:{unlock:!t.locked},attrs:{title:t.locked?"解锁":"锁定"},on:{click:function(e){t.locked=!t.locked}}})]),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{staticClass:"noauto"},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.rightRoilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}})],1)])},staticRenderFns:[]};var B=i("VU/8")(z,N,!1,function(t){i("Xiz7")},"data-v-390f7465",null).exports;let G;const U={data(){return{curLevel:{},leftRoilist:[],rightRoilist:[],aiFatherRois:[],curRois:{},ki67Anno:null,showMppGuide:!1,drawMpp:null,showbutton:!0,auto:!0,lineup:null,loopHandler:0,centerRegion:null,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},parentId:null,loading:!1,currentItem:"",newover:""}},methods:{async getRoi(t){let{x1:e,y1:i,x2:a,y2:n,z:o}=t;this.curLevel={x:[e,a],y:[i,n],z:o},this.leftRoilist=[...await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg)],this.$emit("save","noListUpdate")},reCheck(t){this.$set(this.slice,"check_result",t),this.slice.alg!=this.alg&&(this.$set(this.slice,"alg",this.alg),this.$set(this.slice,"ai_suggest",null)),this.$emit("save")},showMenu(t,e){if((!t.type||t.button)&&(t.preventDefault(),!(0==Object.keys(this.curRois).length||Object.keys(this.curRois).every(t=>t!=e.id)||this.aiFatherRois.some(t=>t.id==e.id)||this.rightRoilist.some(t=>t.id==e.id)))){var i=t.currentTarget,s=t.offsetX,a=t.offsetY,n=i.offsetWidth,o=i.offsetHeight;this.ki67Anno={},this.ki67Anno.hd=s>n/2?"right":"left",this.ki67Anno.vd=a>o/2?"bottom":"top",this.menuPosition={x:s,y:a},this.curRois[e.id]&&(this.labeltree.forEach(t=>{t.id==e.type?this.currentItem=t.id+":"+t.id:t.children&&t.children.forEach(i=>{i.id==e.type&&(this.currentItem=t.id+":"+i.id)})}),this.newover=this.currentItem.substring(0,this.currentItem.lastIndexOf(":")))}},async setAnnotation(t){for(var e in this.ki67Anno=null,this.curRois){let i=this.curRois[e];this.curRois[e]=Object.assign({},i,{type:t,fillColor:this.roiTypeOpitions[t]})}G=t;var i=Object.assign({},this.curRois),a=Object.assign({},a,...Object.values(i).filter(t=>"grey"!=t.strokeColor).map(t=>({[t.id]:t})));this.leftRoilist=this.leftRoilist.map(t=>(a[t.id]&&(t=a[t.id]),t)),this.curRois={},this.loading=!0,await Object(s.c)(this.record.id,this.slice.id,this.alg,Object.values(a).map(e=>({id:e.id,type:t,fillColor:e.fillColor,area_id:e.area_id})),Object.assign({},this.$refs.osd.scope,{color:Object.values(a)[0].fillColor,type:t})),this.loading=!1,this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,this.alg),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg)},isDrawMpp(){this.startAnalyze()},startAnalyze(){this.aiFatherRois.length&&this.aiFatherRois.some(t=>t.aiResult.whole_slide)?this.$confirm("一旦开始，将清空当前的全场图算法结果，确认要开始吗？",{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(async()=>{this.start()}).catch(()=>{}):this.start()},async start(t=this.record.id,e=this.slice.id,i=this.slice.filename){let a=this.aiFatherRois.filter(t=>!t.aiResult.whole_slide).map(t=>({id:t.id,x:t.path.x,y:t.path.y}));this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{[this.alg+"Started"]:!0})),this.$set(this.slice,"alg",this.alg),this.$set(this.slice,"ai_suggest",null),this.$set(this.slice,"check_result",null),this.showbutton=!1,this.auto=!0,this.aiFatherRois.length&&"fishTissue"!=this.alg&&(this.aiFatherRois.map(t=>t.image=1),await Object(s.c)(t,e,this.alg,this.aiFatherRois.map(t=>({id:t.id,image:t.image})),null)),await Object(s.n)(t,e,i,this.alg,JSON.stringify(a),this.model_type),this.curRois={},this.leftRoilist=await Object(s.k)(t,e,this.curLevel,this.alg),this.aiFatherRois=await Object(s.l)(t,e,this.alg),Object.values(this.curRois).map(t=>this.leftRoilist.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),this.getAlgorithmResult()},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){let a=this.aiFatherRois.filter(t=>!t.aiResult.whole_slide).map(t=>({id:t.id,x:t.path.x,y:t.path.y}));Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:this.alg,other:JSON.stringify(a)}).then(async i=>{this.lineup=i.data.rank,i.data.done?(this.showbutton=!0,this.loopHandler=0,-1==i.data.rank&&(this.leftRoilist=await Object(s.k)(t,e,this.curLevel,this.alg),this.aiFatherRois=await Object(s.l)(t,e,this.alg),"pdl1"===this.alg&&this.getScreenCount()),this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{[this.alg+"Started"]:!1})),"fishTissue"!=this.alg&&this.$set(this.slice,"ai_suggest",this.ave+"%")):(this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3))})},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],["tct1","tct2","lct1","lct2"].includes(this.alg)?this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>({[t.id]:t}))):this.curRois=Object.assign({},e&&this.curRois,...i.filter(t=>!t.aiResult||!t.aiResult.whole_slide).map(t=>({[t.id]:t})))},async roiChanged(t,e){let i;i=e?e.map(e=>e.dna_index?{id:e.id,[t]:e[t],area_id:e.area_id,iconType:"dnaIcon"}:{id:e.id,[t]:e[t],area_id:e.area_id}):Object.values(this.curRois).map(e=>({id:e.id,[t]:e[t],area_id:e.area_id}));let a="image"==t||"remark"==t?null:this.$refs.osd.scope;a&&a.offset&&(this.curRois={},this.$refs.osd.scope=null),a?this.$message.error("不支持多选移动"):("image"!==t&&"remark"!==t&&(this.loading=!0),await Object(s.c)(this.record.id,this.slice.id,this.alg,i,a),this.loading=!1),["tct1","tct2","lct1","lct2","fishTissue","dna"].includes(this.alg)?this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg):(this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,this.alg),this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg)),this.IsOutFrame()},IsOutFrame(){Object.keys(this.curRois).map(t=>{this.leftRoilist.some(e=>e.id==t)||(delete this.curRois[t],this.curRois=Object.assign({},this.curRois))})},listChangeCurrent(){if(Object.keys(this.curRois).length){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null,this.$refs.osd.scope=null}},async draw(t,e){t.strokeColor="yellow",t.mark_type=1,this.auto&&(t.strokeColor="grey",t.mark_type=3,t.ai_type=this.alg,"ki67hot"!=this.slice.toolType&&(t.editable=0));let i=t.method.includes("Reverse");this.aiFatherRois.some(t=>t.aiResult.whole_slide)&&!i&&this.auto?this.$message({message:"进行roi框选分析之前请先删除全场图分析结果",type:"warning"}):(t.id=await Object(s.e)(this.record.id,this.slice.id,t),t.id&&(this.curROIChange(t,e),this.leftRoilist=[...this.leftRoilist,t],this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,this.alg),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg),this.IsOutFrame()))},async clickDraw(t,e){if(this.auto){if(!this.showbutton)return void this.$message({message:"计算中不能标注",type:"warning"});let a,n=this.leftRoilist.find(t=>t.id===this.parentId);if((a=this.aiFatherRois.some(t=>t.aiResult.whole_slide)?this.aiFatherRois.find(t=>t.aiResult.whole_slide):this.aiFatherRois.find(t=>t.id===this.parentId))||n&&2==n.mark_type){let o="cd30"===this.alg?4.131514365275448:1/(this.slice.mppx||.242042);if((i={path:{x:[t.x],y:[t.y]},method:"spot",radius:o,area_id:a?a.id:n.area_id,mark_type:2,ai_type:this.alg,type:"number"==typeof G?G:this.defaultType,fillColor:"number"==typeof G?this.roiTypeOpitions[G]:this.defaultColor}).id=await Object(s.e)(this.record.id,this.slice.id,i),!i.id)return;e?Object.assign(this.curRois,{[i.id]:i}):this.curRois={[i.id]:i},this.leftRoilist=[...this.leftRoilist,i],this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,this.alg)}else this.$message({message:"只能在处理ROI区域内打点",type:"warning"})}else{var i;if((i={path:{x:[t.x],y:[t.y]},method:"spot",radius:3/(this.slice.mppx||.242042),mark_type:1,fillColor:"yellow"}).id=await Object(s.e)(this.record.id,this.slice.id,i),!i.id)return;this.curROIChange(i,e),this.leftRoilist=[...this.leftRoilist,i],this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id)}},async delCurRoi(t){if(this.showbutton)if(t){for(var e in this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,this.alg,[t.id],null),this.loading=!1,this.curRois)this.curRois[e].area_id==t.id&&(delete this.curRois[e],this.curRois=Object.assign({},this.curRois));this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois)),3===t.mark_type&&(this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,this.alg),this.aiFatherRois.length||(this.$set(this.slice,"check_result",null),this.$emit("save"))),1===t.mark_type&&(this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id)),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg)}else{await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})&&(this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,this.alg,Object.keys(this.curRois),this.$refs.osd.scope),this.loading=!1,[...new Set(Object.values(this.curRois).map(t=>t.mark_type))].map(async t=>{1===t?this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id):this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,this.alg)}),this.curRois={},this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg))}else this.$message.error("处理中无法删除")},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:this.alg,other:""}).then(async t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{[this.alg+"Started"]:!1})),this.aiFatherRois.length&&"fishTissue"!=this.alg&&(this.aiFatherRois.map(t=>t.image=0),await Object(s.c)(this.record.id,this.slice.id,this.alg,this.aiFatherRois.map(t=>({id:t.id,image:t.image})),null)))}).catch(t=>console.log(t))},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},async mounted(){this.slice.ai_dict[[this.alg+"Started"]]&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()}),["tct1","tct2","lct1","lct2"].includes(this.alg)||(this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,this.alg))},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save"),this.startAnalyze())}}},computed:{alg(){return"fish"===this.slice.toolType?"fishTissue":this.slice.toolType},userInfo:()=>Object(s.o)()},props:["slice","record"],beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0}},V={data:()=>({auto:"one",leftRoilist:[],aiRoilist:[],humanRoilist:[],options:["HSIL","ASC-H","LSIL","ASC-US","AGC"],showType:"HSIL",showHumanType:"HSIL",aiResult:{},humanResult:{},cells:{},docResult:{microbe:[],background:[],tps:[],diagnosis:""},showTips:!1,labeltree:[{id:"阳性",label:"阳性",children:[{id:"ASC-US 单个细胞",label:"ASC-US 单个细胞",children:[{id:"ASC-US 单个细胞;核增大到2.5-3倍",label:"核增大到2.5-3倍"},{id:"ASC-US 单个细胞;核膜不规则",label:"核膜不规则"},{id:"ASC-US 单个细胞;核轻度深染",label:"核轻度深染"},{id:"ASC-US 单个细胞;非典型角化细胞",label:"非典型角化细胞"},{id:"ASC-US 单个细胞;核染色质呈粗颗粒状",label:"核染色质呈粗颗粒状"},{id:"ASC-US 单个细胞;不完全挖空化细胞",label:"不完全挖空化细胞"},{id:"ASC-US 单个细胞;无",label:"无"}]},{id:"ASC-US细胞团",label:"ASC-US细胞团",children:[{id:"ASC-US细胞团;核增大到2.5-3倍",label:"核增大到2.5-3倍"},{id:"ASC-US细胞团;核膜不规则",label:"核膜不规则"},{id:"ASC-US细胞团;核轻度深染",label:"核轻度深染"},{id:"ASC-US细胞团;非典型角化细胞",label:"非典型角化细胞"},{id:"ASC-US细胞团;核染色质呈粗颗粒状",label:"核染色质呈粗颗粒状"},{id:"ASC-US细胞团;不完全挖空化细胞",label:"不完全挖空化细胞"},{id:"ASC-US细胞团;无",label:"无"}]},{id:"ASC-H 单个细胞",label:"ASC-H 单个细胞",children:[{id:"ASC-H 单个细胞;核浆比大",label:"核浆比大"},{id:"ASC-H 单个细胞;核染色质加深",label:"核染色质加深"},{id:"ASC-H 单个细胞;核膜不规则",label:"核膜不规则"},{id:"ASC-H 单个细胞;核染色质呈粗颗粒状",label:"核染色质呈粗颗粒状"},{id:"ASC-H 单个细胞;非典型角化细胞",label:"非典型角化细胞"},{id:"ASC-H 单个细胞;无",label:"无"}]},{id:"ASC-H 细胞团",label:"ASC-H 细胞团",children:[{id:"ASC-H 细胞团;核染色质加深",label:"核染色质加深"},{id:"ASC-H 细胞团;核膜不规则",label:"核膜不规则"},{id:"ASC-H 细胞团;核染色质呈粗颗粒状",label:"核染色质呈粗颗粒状"},{id:"ASC-H 细胞团;细胞的大小形态不一，排列紊乱",label:"细胞的大小形态不一，排列紊乱"},{id:"ASC-H 细胞团;核浆比大",label:"核浆比大"},{id:"ASC-H 细胞团;非典型角化细胞",label:"非典型角化细胞"},{id:"ASC-H 细胞团;无",label:"无"}]},{id:"LSIL 单个细胞",label:"LSIL 单个细胞",children:[{id:"LSIL 单个细胞;核增大大于3倍",label:"核增大大于3倍"},{id:"LSIL 单个细胞;异形双核或多核",label:"异形双核或多核"},{id:"LSIL 单个细胞;核染色质呈粗颗粒状",label:"核染色质呈粗颗粒状"},{id:"LSIL 单个细胞;核膜不规则",label:"核膜不规则"},{id:"LSIL 单个细胞;挖空细胞",label:"挖空细胞"},{id:"LSIL 单个细胞;核染色质加深",label:"核染色质加深"},{id:"LSIL 单个细胞;非典型角化细胞",label:"非典型角化细胞"},{id:"LSIL 单个细胞;无",label:"无"}]},{id:"LSIL细胞团",label:"LSIL细胞团",children:[{id:"LSIL细胞团;核增大大于3倍",label:"核增大大于3倍"},{id:"LSIL细胞团;异形双核或多核",label:"异形双核或多核"},{id:"LSIL细胞团;核染色质呈粗颗粒状",label:"核染色质呈粗颗粒状"},{id:"LSIL细胞团;核膜不规则",label:"核膜不规则"},{id:"LSIL细胞团;挖空细胞",label:"挖空细胞"},{id:"LSIL细胞团;核染色质加深",label:"核染色质加深"},{id:"LSIL细胞团;非典型角化细胞",label:"非典型角化细胞"},{id:"LSIL细胞团;无",label:"无"}]},{id:"HSIL 单个细胞",label:"HSIL 单个细胞",children:[{id:"HSIL 单个细胞;核浆比大",label:"核浆比大"},{id:"HSIL 单个细胞;核膜不规则",label:"核膜不规则"},{id:"HSIL 单个细胞;核染色质呈粗颗粒状",label:"核染色质呈粗颗粒状"},{id:"HSIL 单个细胞;核染色质加深",label:"核染色质加深"},{id:"HSIL 单个细胞;非典型角化细胞",label:"非典型角化细胞"},{id:"HSIL 单个细胞;无",label:"无"}]},{id:"HSIL 细胞团",label:"HSIL 细胞团",children:[{id:"HSIL 细胞团;核浆比大",label:"核浆比大"},{id:"HSIL 细胞团;核膜不规则",label:"核膜不规则"},{id:"HSIL 细胞团;核染色质呈粗颗粒状",label:"核染色质呈粗颗粒状"},{id:"HSIL 细胞团;细胞的大小形态不一，排列紊乱",label:"细胞的大小形态不一，排列紊乱"},{id:"HSIL 细胞团;核染色质加深",label:"核染色质加深"},{id:"HSIL 细胞团;非典型角化细胞",label:"非典型角化细胞"},{id:"HSIL 细胞团;无",label:"无"}]},{id:"AGC 单个细胞",label:"AGC 单个细胞",children:[{id:"AGC 单个细胞;核染色质加深",label:"核染色质加深"},{id:"AGC 单个细胞;核膜不规则",label:"核膜不规则"},{id:"AGC 单个细胞;核位上移",label:"核位上移"},{id:"AGC 单个细胞;核仁增大/多核仁",label:"核仁增大/多核仁"},{id:"AGC 单个细胞;无",label:"无"}]},{id:"AGC 细胞团",label:"AGC 细胞团",children:[{id:"AGC 细胞团;细胞团呈菊形团/羽毛状排列",label:"细胞团呈菊形团/羽毛状排列"},{id:"AGC 细胞团;细胞团呈三维簇团结构",label:"细胞团呈三维簇团结构"},{id:"AGC 细胞团;核染色质加深",label:"核染色质加深"},{id:"AGC 细胞团;核膜不规则",label:"核膜不规则"},{id:"AGC 细胞团;胞浆有空泡",label:"胞浆有空泡"},{id:"AGC 细胞团;核大小不一",label:"核大小不一"},{id:"AGC 细胞团;失去极向，排列紊乱",label:"失去极向，排列紊乱"},{id:"AGC 细胞团;核仁增大/多核仁",label:"核仁增大/多核仁"},{id:"AGC 细胞团;腺腔样排列",label:"腺腔样排列"},{id:"AGC 细胞团;无",label:"无"}]}]},{id:"阴性",label:"阴性",children:[{id:"单个细胞",label:"单个细胞",children:[{id:"单个细胞;鳞状上皮细胞",label:"鳞状上皮细胞"},{id:"单个细胞;腺上皮细胞",label:"腺上皮细胞"},{id:"单个细胞;裸核",label:"裸核"},{id:"单个细胞;化生细胞",label:"化生细胞"},{id:"单个细胞;修复细胞",label:"修复细胞"},{id:"单个细胞;角化细胞",label:"角化细胞"},{id:"单个细胞;萎缩细胞",label:"萎缩细胞"},{id:"单个细胞;无",label:"无"}]},{id:"细胞团",label:"细胞团",children:[{id:"细胞团;鳞状上皮细胞",label:"鳞状上皮细胞"},{id:"细胞团;腺上皮细胞",label:"腺上皮细胞"},{id:"细胞团;化生细胞",label:"化生细胞"},{id:"细胞团;修复细胞",label:"修复细胞"},{id:"细胞团;萎缩细胞",label:"萎缩细胞"},{id:"细胞团;裸核",label:"裸核"},{id:"细胞团;无",label:"无"}]}]},{id:"微生物",label:"微生物",children:[{id:"滴虫",label:"滴虫"},{id:"霉菌",label:"霉菌"},{id:"线索",label:"线索"},{id:"放线菌",label:"放线菌"},{id:"疱疹",label:"疱疹"}]},{id:"异物",label:"异物"},{id:"炎性细胞",label:"炎性细胞",children:[{id:"单个炎性细胞",label:"单个炎性细胞"},{id:"炎性细胞团",label:"炎性细胞团"}]},{id:"不确定",label:"不确定"}],roiTypeOpitions:{HSIL:"#FF8A01","ASC-H":"#FF8A01",LSIL:"#FF8A01","ASC-US":"#FF8A01",AGC:"#FF8A01","阴性":"#039D12","异物":"#039D12","滴虫":"#0000FF","霉菌":"#0000FF","线索":"#0000FF","放线菌":"#0000FF","疱疹":"#0000FF","不确定":"yellow"},contextmenuPosition:null,observer:null,remark:null,curModule:"cellresult",clickTimer:null}),methods:{goTocurRoi(t,e){this.curROIChange(t,e),this.listChangeCurrent()},showMenu(t,e,i){if((!t.type||t.button)&&(t.preventDefault(),0!=Object.keys(this.curRois).length&&!Object.keys(this.curRois).every(t=>t!=e.id))){var s=t.currentTarget,a=(t.offsetX,t.offsetY+60),n=(s.offsetWidth,s.offsetHeight);this.contextmenuPosition={},this.contextmenuPosition.hd="left",this.contextmenuPosition.vd=a>n/2?"bottom":"top",this.menuPosition={x:i.x,y:i.y},this.currentItem="",this.curRois[e.id]&&(this.labeltree.forEach(t=>{e.doctorDiagnosis.includes(t.id)?this.currentItem=t.id+":"+[t.id]:t.children&&t.children.forEach(i=>{if(e.doctorDiagnosis.includes(i.id))this.currentItem=t.id+":"+[i.id];else if(i.children){let s=[];i.children.forEach(a=>{e.doctorDiagnosis.includes(a.id)&&(s.push(a.id),this.currentItem=t.id+":"+i.id+":"+s)})}})}),this.newover=this.currentItem.substring(0,this.currentItem.lastIndexOf(":")))}},async setAnnotation(t){this.remark=t,"string"==typeof t&&(this.remark=[t],this.contextmenuPosition=null,this.currentItem="")},setShowType(){let t=this.aiResult.cells,e="HSIL";return t.HSIL.num?e="HSIL":t["ASC-H"].num?e="ASC-H":t.LSIL.num?e="LSIL":t.ASCUS.num?e="ASCUS":t.AGC.num?e="AGC":t["滴虫"].num?e="滴虫":t["霉菌"].num?e="霉菌":t["线索"].num?e="线索":t["放线菌"].num?e="放线菌":t["疱疹"].num&&(e="疱疹"),e},getRoiColor(){return["单个细胞","细胞团"].includes(this.remark[0].split(";")[0])?"green":["ASC-US 单个细胞","ASC-US细胞团","ASC-H 单个细胞","ASC-H 细胞团","LSIL 单个细胞","LSIL细胞团","HSIL 单个细胞","HSIL 细胞团","AGC 单个细胞","AGC 细胞团"].includes(this.remark[0].split(";")[0])?"orange":["单个炎性细胞","炎性细胞团"].includes(this.remark[0].split(";")[0])?"green":{"异物":"#039D12","滴虫":"#0000FF","霉菌":"#0000FF","线索":"#0000FF","放线菌":"#0000FF","疱疹":"#0000FF","不确定":"yellow"}[this.remark[0]]},async changRoiType(){for(var t in this.curRois){let e=this.curRois[t];if(e.dashed)this.curRois[t]=Object.assign({},e,{strokeColor:this.getRoiColor(),doctorDiagnosis:this.remark});else{let t=Object.assign({},{path:e.path,dashed:1,doctorDiagnosis:this.remark,strokeColor:this.getRoiColor(),ai_type:"human_tl",mark_type:1,method:"rectangle"});await Object(s.e)(this.record.id,this.slice.id,t)}}var e=Object.assign({},this.curRois),i=Object.assign({},i,...Object.values(e).filter(t=>t.dashed).map(t=>({[t.id]:t})));this.curRois={},Object.keys(i).length&&(this.loading=!0,await Object(s.c)(this.record.id,this.slice.id,"human_tl",Object.values(i).map(t=>({id:t.id,strokeColor:t.strokeColor,doctorDiagnosis:t.doctorDiagnosis}))),this.loading=!1),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg),this.humanResult=await this.getHumanResult(),this.humanRoilist=this.humanResult[this.showHumanType].data,this.remark=null},changeImage(t){this.$set(t,"image",1-(t.image||0)),this.roiChanged("image",[t])},change(t,e){"阴性"===t&&(this.docResult.tps=[]),this.docResult[e]=t,this.check()},accept(){this.docResult=Object.assign({},{microbe:this.aiResult.microbe,tps:[this.aiResult.diagnosis[1]],diagnosis:this.aiResult.diagnosis[0],background:[]}),this.check()},clearCheckReslut(){this.$confirm("确认清空复核结果？","提示",{cancelTextButtom:"取消",confirmTextButtom:"确定"}).then(()=>{this.docResult={microbe:[],background:[],tps:[],diagnosis:""},this.check()}).catch(()=>!1)},check(){this.$set(this.slice,"check_result",this.docResult.diagnosis+" "+this.docResult.tps.join("+")+" "+this.docResult.microbe.join(",")+" "+this.docResult.background.join(",")),this.$set(this.slice,"alg",this.slice.toolType),this.$emit("save","noListUpdate")},async toogleType(t){this.showType=t,this.aiRoilist=this.aiResult.cells[t].data,this.$nextTick(()=>{let t=this.$refs.aiRoilist;t&&(t.scrollTop=0,t.removeEventListener("scroll",this.scrollHander),t.addEventListener("scroll",this.scrollHander))}),this.startOberserve()},async toogleHumanType(t){this.showHumanType=t,this.humanRoilist=this.humanResult[t].data},async getRoi(t){let{x1:e,y1:i,x2:a,y2:n,z:o}=t;this.curLevel={x:[e,a],y:[i,n],z:o},this.leftRoilist.length||(this.leftRoilist=[...await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg)]),this.leftRoilist=[...await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg)]},async draw(t,e){t.strokeColor="yellow",t.mark_type=1,t.dashed=1,t.ai_type="human_tl",t.doctorDiagnosis="无",t.id=await Object(s.e)(this.record.id,this.slice.id,t),t.id&&(this.curROIChange(t,e),this.leftRoilist=[...this.leftRoilist,t],this.humanResult=await this.getHumanResult(),this.humanRoilist=this.humanResult[this.showHumanType].data,this.IsOutFrame())},async delCurRoi(t){if(t)this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,"human_tl",[t.id],null),this.loading=!1,this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois)),this.humanResult=await this.getHumanResult(),this.humanRoilist=this.humanResult[this.showHumanType].data,this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.slice.toolType);else if(await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})){let t=Object.values(this.curRois).filter(t=>t.dashed).map(t=>t.id);if(!t.length)return;this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,"human_tl",t,this.$refs.osd.scope),this.loading=!1,this.humanResult=await this.getHumanResult(),this.humanRoilist=this.humanResult[this.showHumanType].data,this.curRois={},this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.slice.toolType)}},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:this.slice.toolType,other:this.config&&this.config.mode?"cs":""}).then(async t=>{this.lineup=t.data.rank,t.data.done?(this.showbutton=!0,this.loopHandler=0,-1==t.data.rank&&(this.aiResult=await this.getAiResult(),this.showType=this.setShowType(),this.aiRoilist=this.aiResult.cells[this.showType].data,this.cells=this.aiResult.cells,this.$set(this.slice,"ai_suggest",this.aiResult.diagnosis[0]+" "+this.aiResult.diagnosis[1]+" "+this.aiResult.microbe.join(",")),this.$set(this.slice,"cell_num",this.aiResult.cell_num),this.$set(this.slice,"slide_quality",this.aiResult.slide_quality)),this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{[this.slice.toolType+"Started"]:!1})),this.startOberserve()):(this.showbutton=!1,this.loopHandler=setTimeout(()=>{this.getAlgorithmResult()},5e3))})},async getAiResult(){return new Promise(t=>{Object(s.b)(`slice/getROIList?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,ai_type:this.slice.toolType,other:this.config&&this.config.mode?"cs":""}).then(({data:e})=>{e.ROIS.length?t(e.ROIS[0].aiResult):t({})}).catch(e=>t({}))})},async getHumanResult(){return new Promise(t=>{Object(s.b)(`slice/getROIList?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,ai_type:"human_tl",other:this.config&&this.config.mode?"cs":""}).then(({data:e})=>{t(e.ROIS)}).catch(e=>t({}))})},async startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{[this.slice.toolType+"Started"]:!0})),this.$set(this.slice,"alg",this.slice.toolType),this.$set(this.slice,"ai_suggest",null),this.$set(this.slice,"check_result",null),this.$set(this.slice,"cell_num",null),this.$set(this.slice,"slide_quality",""),this.removeObserver(),this.showbutton=!1,this.auto="one",await Object(s.n)(t,e,i,this.slice.toolType,this.config&&this.config.mode?"cs":""),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.slice.toolType),this.aiResult=await this.getAiResult(),this.humanResult=await this.getHumanResult(),this.aiRoilist=this.aiResult.cells[this.showType].data||[],this.humanRoilist=this.humanResult[this.showHumanType].data||[],Object.values(this.curRois).map(t=>this.leftRoilist.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),this.getAlgorithmResult()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:this.slice.toolType,other:this.config&&this.config.mode?"cs":""}).then(async t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{[this.slice.toolType+"Started"]:!1})),this.aiResult=await this.getAiResult(),this.cells=this.aiResult.cells)}).catch(t=>console.log(t))},scrollHander(){let t=this.$refs.aiRoilist;t.scrollTop+t.clientHeight==t.scrollHeight&&this.cells[this.showType].num>100?this.showTips=!0:this.showTips=!1},startOberserve(){this.observer&&this.removeObserver(),this.$nextTick(()=>{if(this.aiRoilist.length){document.querySelectorAll(".img-content img").forEach(t=>{this.observer&&this.observer.observe(t)})}})},removeObserver(){document.querySelectorAll(".img-content img").forEach(t=>{this.observer.disconnect(t)})},changeTab(t){this.auto!==t&&(this.auto=t,"one"===t&&this.startOberserve())}},async mounted(){if(this.aiResult=await this.getAiResult(),this.humanResult=await this.getHumanResult(),this.showType=this.setShowType(),this.aiRoilist=this.aiResult.cells[this.showType].data||[],this.humanRoilist=this.humanResult[this.showHumanType].data||[],this.cells=this.aiResult.cells,this.slice.alg===this.slice.toolType&&this.slice.check_result){let t=this.slice.check_result.split(" ");this.docResult={diagnosis:t[0],microbe:t[2]?t[2].split(","):[],tps:t[1]?t[1].split("+"):[],background:t[3]?t[3].split(","):[]}}this.observer=new IntersectionObserver(t=>{t.forEach(t=>{t.intersectionRatio>0&&!t.target.src&&(t.target.src=t.target.dataset.src)})}),this.startOberserve(),this.$nextTick(()=>{let t=this.$refs.aiRoilist;t&&t.removeEventListener("scroll",this.scrollHander),t&&t.addEventListener("scroll",this.scrollHander)})},props:["slice","record"],beforeDestroy(){let t=this.$refs.aiRoilist;t&&t.removeEventListener("scroll",this.scrollHander),this.removeObserver(),this.aiResult=this.humanResult=this.humanRoilist=[]},watch:{contextmenuPosition:{handler(){!this.contextmenuPosition&&this.remark&&this.changRoiType()}}}},Y={data:()=>({auto:"one",leftRoilist:[],aiRoilist:[],humanRoilist:[],options:["HSIL","ASC-H","LSIL","ASC-US","AGC"],showType:"HSIL",showHumanType:"HSIL",aiResult:{},humanResult:{},cells:{},docResult:{microbe:[],background:[],tps:[],diagnosis:"",dnaResult:""},showTips:!1,labeltree:[{id:"阳性",label:"阳性",children:[{id:"HSIL",label:"HSIL"},{id:"ASC-H",label:"ASC-H"},{id:"LSIL",label:"LSIL"},{id:"ASC-US",label:"ASC-US"},{id:"AGC",label:"AGC"}]},{id:"阴性",label:"阴性"},{id:"微生物",label:"微生物",children:[{id:"滴虫",label:"滴虫"},{id:"霉菌",label:"霉菌"},{id:"线索",label:"线索"},{id:"放线菌",label:"放线菌"},{id:"疱疹",label:"疱疹"}]},{id:"异物",label:"异物"},{id:"不确定",label:"不确定"}],roiTypeOpitions:{HSIL:"#FF8A01","ASC-H":"#FF8A01",LSIL:"#FF8A01","ASC-US":"#FF8A01",AGC:"#FF8A01","阴性":"#039D12","异物":"#039D12","滴虫":"#0000FF","霉菌":"#0000FF","线索":"#0000FF","放线菌":"#0000FF","疱疹":"#0000FF","不确定":"yellow"},contextmenuPosition:null,observer:null,curModule:"cellresult",clickTimer:null}),methods:{goTocurRoi(t,e){this.curROIChange(t,e),this.listChangeCurrent()},showMenu(t,e){if((!t.type||t.button)&&(t.preventDefault(),0!=Object.keys(this.curRois).length&&!Object.keys(this.curRois).every(t=>t!=e.id))){var i=t.currentTarget,s=t.offsetX,a=t.offsetY,n=i.offsetWidth,o=i.offsetHeight;if(this.contextmenuPosition={},this.contextmenuPosition.hd=s>n/2?"right":"left",this.contextmenuPosition.vd=a>o/2?"bottom":"top",this.menuPosition={x:s,y:a},this.curRois[e.id]){let t=this.labeltree.find(t=>t.id==e.doctorDiagnosis),i=this.labeltree.filter(t=>t.children);if(t)this.currentItem=t.id+":"+t.id;else{let t=[];i.forEach(e=>{t.push(e.children.map(t=>Object.assign({},t,{fatherId:e.id})))});let s=t.flat().find(t=>t.id==e.doctorDiagnosis);this.currentItem=s?s.fatherId+":"+e.doctorDiagnosis:e.doctorDiagnosis+":"+e.doctorDiagnosis}this.newover=this.currentItem.substring(0,this.currentItem.lastIndexOf(":"))}}},async setAnnotation(t){for(var e in this.contextmenuPosition=null,this.curRois){let i=this.curRois[e];if(i.dashed)this.curRois[e]=Object.assign({},i,{strokeColor:this.roiTypeOpitions[t],doctorDiagnosis:t});else{let e=Object.assign({},{path:i.path,dashed:1,doctorDiagnosis:t,strokeColor:this.roiTypeOpitions[t],ai_type:"human_tl",mark_type:1,method:"rectangle"});await Object(s.e)(this.record.id,this.slice.id,e)}}var i=Object.assign({},this.curRois),a=Object.assign({},a,...Object.values(i).filter(t=>t.dashed).map(t=>({[t.id]:t})));this.curRois={},Object.keys(a).length&&(this.loading=!0,await Object(s.c)(this.record.id,this.slice.id,"human_tl",Object.values(a).map(t=>({id:t.id,strokeColor:t.strokeColor,doctorDiagnosis:t.doctorDiagnosis}))),this.loading=!1),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg),this.humanResult=await this.getHumanResult(),this.humanRoilist=this.humanResult[this.showHumanType].data},setShowType(){let t=this.aiResult.cells,e="HSIL";return t.HSIL.num?e="HSIL":t["ASC-H"].num?e="ASC-H":t.LSIL.num?e="LSIL":t.ASCUS.num?e="ASCUS":t.AGC.num?e="AGC":t["滴虫"].num?e="滴虫":t["霉菌"].num?e="霉菌":t["线索"].num?e="线索":t["放线菌"].num?e="放线菌":t["疱疹"].num&&(e="疱疹"),e},changeImage(t){this.$set(t,"image",1-(t.image||0)),this.roiChanged("image",[t])},changeImages(t){let e;e=t.map(t=>(this.$set(t,"image",1-(t.image||0)),t)),this.roiChanged("image",e)},change(t,e){"阴性"===t&&(this.docResult.tps=[]),this.docResult[e]=t,this.check()},accept(t){"dna"==t?this.docResult.dnaResult=this.aiResult.dna_diagnosis:this.docResult=Object.assign({},{microbe:this.aiResult.microbe,tps:[this.aiResult.diagnosis[1]],diagnosis:this.aiResult.diagnosis[0],background:[],dnaResult:this.docResult.dnaResult}),this.check()},clearCheckReslut(t){this.$confirm("确认清空复核结果？","提示",{cancelTextButtom:"取消",confirmTextButtom:"确定"}).then(()=>{"dna"==t?this.docResult.dnaResult="":this.docResult={microbe:[],background:[],tps:[],diagnosis:"",dnaResult:this.docResult.dnaResult},this.check()}).catch(()=>!1)},check(){this.$set(this.slice,"check_result",this.docResult.diagnosis+" "+this.docResult.tps.join("+")+" "+this.docResult.microbe.join(",")+" "+this.docResult.background.join(",")+";"+this.docResult.dnaResult),this.$set(this.slice,"alg",this.slice.toolType),this.$emit("save","noListUpdate")},async toogleType(t){this.showType=t,this.aiRoilist=this.aiResult.cells[t].data,this.$nextTick(()=>{let t=this.$refs.aiRoilist;t&&(t.scrollTop=0,t.removeEventListener("scroll",this.scrollHander),t.addEventListener("scroll",this.scrollHander))}),this.startOberserve()},async toogleHumanType(t){this.showHumanType=t,this.humanRoilist=this.humanResult[t].data},async getRoi(t){let{x1:e,y1:i,x2:a,y2:n,z:o}=t;this.curLevel={x:[e,a],y:[i,n],z:o},this.leftRoilist.length||(this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.slice.toolType)),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.slice.toolType)},async draw(t,e){t.strokeColor="yellow",t.mark_type=1,t.dashed=1,t.ai_type="human_tl",t.doctorDiagnosis="无",t.id=await Object(s.e)(this.record.id,this.slice.id,t),t.id&&(this.curROIChange(t,e),this.leftRoilist=[...this.leftRoilist,t],this.humanResult=await this.getHumanResult(),this.humanRoilist=this.humanResult[this.showHumanType].data,this.IsOutFrame())},async delCurRoi(t){if(t)this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,"human_tl",[t.id],null),this.loading=!1,this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois)),this.humanResult=await this.getHumanResult(),this.humanRoilist=this.humanResult[this.showHumanType].data,this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.slice.toolType);else if(await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})){let t=Object.values(this.curRois).filter(t=>t.dashed).map(t=>t.id);if(!t.length)return;this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,"human_tl",t,this.$refs.osd.scope),this.loading=!1,this.humanResult=await this.getHumanResult(),this.humanRoilist=this.humanResult[this.showHumanType].data,this.curRois={},this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.slice.toolType)}},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:this.slice.toolType,other:this.config&&this.config.mode?"cs":""}).then(async t=>{this.lineup=t.data.rank,t.data.done?(this.showbutton=!0,this.loopHandler=0,-1==t.data.rank&&(this.aiResult=await this.getAiResult(),this.showType=this.setShowType(),this.aiRoilist=this.aiResult.cells[this.showType].data,this.cells=this.aiResult.cells,this.$set(this.slice,"ai_suggest",this.aiResult.diagnosis[0]+" "+this.aiResult.diagnosis[1]+" "+this.aiResult.microbe.join(",")),this.$set(this.slice,"cell_num",this.aiResult.cell_num),this.$set(this.slice,"slide_quality",this.aiResult.slide_quality)),this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{[this.slice.toolType+"Started"]:!1})),this.startOberserve()):(this.showbutton=!1,this.loopHandler=setTimeout(()=>{this.getAlgorithmResult()},5e3))})},async getAiResult(){return new Promise(t=>{Object(s.b)(`slice/getROIList?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,ai_type:this.slice.toolType,other:this.config&&this.config.mode?"cs":""}).then(({data:e})=>{e.ROIS.length?t(e.ROIS[0].aiResult):t({})}).catch(e=>t({}))})},async getHumanResult(){return new Promise(t=>{Object(s.b)(`slice/getROIList?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,ai_type:"human_tl",other:this.config&&this.config.mode?"cs":""}).then(({data:e})=>{t(e.ROIS)}).catch(e=>t({}))})},async startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{[this.slice.toolType+"Started"]:!0})),this.$set(this.slice,"alg",this.slice.toolType),this.$set(this.slice,"ai_suggest",null),this.$set(this.slice,"check_result",null),this.$set(this.slice,"cell_num",null),this.$set(this.slice,"slide_quality",""),this.removeObserver(),this.showbutton=!1,this.auto="one",await Object(s.n)(t,e,i,this.slice.toolType,this.config&&this.config.mode?"cs":""),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.slice.toolType),this.aiResult=await this.getAiResult(),this.humanResult=await this.getHumanResult(),this.aiRoilist=this.aiResult.cells[this.showType].data||[],this.humanRoilist=this.humanResult[this.showHumanType].data||[],Object.values(this.curRois).map(t=>this.leftRoilist.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),this.getAlgorithmResult()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:this.slice.toolType,other:this.config&&this.config.mode?"cs":""}).then(async t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{[this.slice.toolType+"Started"]:!1})),this.aiResult=await this.getAiResult(),this.cells=this.aiResult.cells)}).catch(t=>console.log(t))},scrollHander(){let t=this.$refs.aiRoilist;t.scrollTop+t.clientHeight==t.scrollHeight&&this.cells[this.showType].num>100?this.showTips=!0:this.showTips=!1},startOberserve(){this.observer&&this.removeObserver(),this.$nextTick(()=>{if(this.aiRoilist.length){document.querySelectorAll(".img-content img").forEach(t=>{this.observer.observe(t)})}})},removeObserver(){document.querySelectorAll(".img-content img").forEach(t=>{this.observer.disconnect(t)})},changeTab(t){this.auto!==t&&(this.auto=t,"one"===t&&this.startOberserve())}},async mounted(){if(this.aiResult=await this.getAiResult(),this.humanResult=await this.getHumanResult(),this.showType=this.setShowType(),this.aiRoilist=this.aiResult.cells[this.showType].data||[],this.humanRoilist=this.humanResult[this.showHumanType].data||[],this.cells=this.aiResult.cells,this.slice.alg===this.slice.toolType&&this.slice.check_result){let t=this.slice.check_result.split(";");if(t[0]){let e=t[0].split(" ");this.docResult={diagnosis:e[0],microbe:e[2]?e[2].split(","):[],tps:e[1]?e[1].split("+"):[],background:e[3]?e[3].split(","):[],dnaResult:t[1]}}else t[1]&&(this.docResult={microbe:[],background:[],tps:[],diagnosis:"",dnaResult:t[1]})}this.observer=new IntersectionObserver(t=>{t.forEach(t=>{t.intersectionRatio>0&&!t.target.src&&(t.target.src=t.target.dataset.src)})}),this.startOberserve(),this.$nextTick(()=>{let t=this.$refs.aiRoilist;t&&t.removeEventListener("scroll",this.scrollHander),t&&t.addEventListener("scroll",this.scrollHander)})},props:["slice","record"],beforeDestroy(){let t=this.$refs.aiRoilist;t&&t.removeEventListener("scroll",this.scrollHander),this.removeObserver()}};var J={name:"v-menus",props:["menus","currentItem","pos","newover"],data(){var t={position:{},over:this.newover.substring(0,this.newover.indexOf(":"))||this.newover,curWidth:0};return this.pos&&"top"==this.pos.vd?t.position.top=0:this.pos&&"bottom"==this.pos.vd&&(t.position.bottom=0),this.pos&&"left"==this.pos.hd?t.position.left=0:this.pos&&"right"==this.pos.hd&&(t.position.right=0),t},methods:{mouseOver(t){this.over=t}},updated(){this.curWidth=this.$refs[this.over].clientWidth+5},watch:{over:{immediate:!0,handler(){this.$nextTick(()=>{this.curWidth=this.$refs[this.over].clientWidth+5})}}},components:{"v-menus":X}},W={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{ref:t.over,staticClass:"container",style:t.position},t._l(t.menus,function(e,s){return i("div",{key:s,staticClass:"item",class:t.over==e.id?"active":"",on:{mouseover:function(i){return t.mouseOver(e.id)},mousedown:function(t){return t.stopPropagation(),t},click:function(i){i.stopPropagation(),(!e.children||!e.children.length)&&t.$emit("chosen",e.id)}}},[t.currentItem&&t.currentItem.split(":")[0]==e.id?i("span",{staticClass:"left"}):t._e(),t._v("\n        "+t._s(e.label)+"\n        "),e.id==t.over&&e.children?i("v-menus",{key:s,style:{transform:"translate("+("left"==t.pos.hd?t.curWidth+"px":-t.curWidth+"px")+",0"},attrs:{newover:t.currentItem&&t.currentItem.split(":").length>2?t.currentItem.substring(t.currentItem.indexOf(":")+1):t.currentItem.split(":")[0],menus:e.children,currentItem:t.currentItem&&t.currentItem.split(":").slice(1).join(":"),pos:t.pos},on:{chosen:function(e){return t.$emit("chosen",e)}}}):t._e(),t._v(" "),e.children&&e.children.length?i("span",{staticClass:"right"}):t._e()],1)}),0)},staticRenderFns:[]};var X=i("VU/8")(J,W,!1,function(t){i("IrGs")},"data-v-1419e1ec",null).exports,q={name:"v-menus",props:["menus","currentItem","pos","newover"],data(){var t={position:{},over:this.newover.substring(0,this.newover.indexOf(":"))||this.newover,curWidth:0,curTop:0,checked:[]};return this.pos&&"top"==this.pos.vd?t.position.top=0:this.pos&&"bottom"==this.pos.vd&&(t.position.top=0),this.pos&&"left"==this.pos.hd?t.position.left=0:this.pos&&"right"==this.pos.hd&&(t.position.right=0),t},methods:{mouseOver(t){this.over=t},checkHandel(t){t.includes(";")?(this.checked.includes(t)?this.checked=this.checked.filter(e=>e!=t):this.checked.push(t),this.$emit("chosen",this.checked)):this.$emit("chosen",t)}},updated(){this.curWidth=this.$refs[this.over].clientWidth+5;let t=this.$refs[this.over].querySelector(".active").offsetTop;this.curTop=t},watch:{over:{immediate:!0,handler(){this.$nextTick(()=>{this.curWidth=this.$refs[this.over].clientWidth+5})}}},components:{"v-menus":X}},K={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{ref:t.over,staticClass:"container",style:t.position},t._l(t.menus,function(e,s){return i("div",{key:s,staticClass:"item",class:{active:t.over==e.id,checked:t.checked.includes(e.id)},on:{mouseover:function(i){return t.mouseOver(e.id)},mousedown:function(t){return t.stopPropagation(),t},click:function(i){i.stopPropagation(),(!e.children||!e.children.length)&&t.checkHandel(e.id)}}},[t.currentItem&&t.currentItem.split(":")[0].split(",").includes(e.id)?i("span",{staticClass:"left"}):t._e(),t._v("\n        "+t._s(e.label)+"\n        "),e.id==t.over&&e.children?i("v-menus",{key:s,style:{transform:"translate("+("left"==t.pos.hd?t.curWidth+"px":-t.curWidth+"px")+",-"+t.curTop+"px"},attrs:{newover:t.currentItem&&t.currentItem.split(":").length>2?t.currentItem.substring(t.currentItem.indexOf(":")+1):t.currentItem.split(":")[0],menus:e.children,currentItem:t.currentItem&&t.currentItem.split(":").slice(1).join(":"),pos:t.pos},on:{chosen:function(e){return t.$emit("chosen",e)}}}):t._e(),t._v(" "),e.children&&e.children.length?i("span",{staticClass:"right"}):t._e()],1)}),0)},staticRenderFns:[]};var Z=i("VU/8")(q,K,!1,function(t){i("obDR")},"data-v-7a8cd35a",null).exports,Q={mixins:[U,V],props:["slice","record","config"],components:{"v-dragon":v.a,"v-roi":f,"v-menus":Z}},tt={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",staticStyle:{width:"100%"},attrs:{tabIndex:0},on:{keydown:t.keydown,mousewheel:function(e){t.contextmenuPosition=null},mousedown:function(e){t.contextmenuPosition=null}}},[i("div",{staticClass:"analyright"},[i("v-dragon",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"osd",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:[].concat(t.leftRoilist),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:1962,"element-loading-text":"处理中，请耐心等待","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.5)"},on:{curROI:t.curROIChange,roiChanged:t.roiChanged,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},contextmenu:function(e,i,s){return t.showMenu(e,i,s)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},getRoi:t.getRoi}},[t.contextmenuPosition?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+"px",top:t.menuPosition.y+"px"}},[i("v-menus",{attrs:{pos:t.contextmenuPosition,menus:t.labeltree,currentItem:t.currentItem,newover:t.newover},on:{chosen:function(e){return t.setAnnotation(e)}}})],1):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("div",{staticClass:"quality"},[t._m(0),t._v(" "),i("div",{staticClass:"quality-detail"},[i("p",[t._v("切片质量："),i("em",[t._v(t._s({1:"合格",0:"不合格"}[t.aiResult.slide_quality]||"-"))])]),t._v(" "),i("p",[t._v("清 晰 度："+t._s(t.slice.clarity?(100*t.slice.clarity).toFixed(2)+"%":"-"))]),t._v(" "),i("p",[t._v("扫描倍数："+t._s(t.slice.objective_rate||"-"))]),t._v(" "),i("p",[t._v("细 胞 量："+t._s("number"==typeof t.aiResult.cell_num?t.aiResult.cell_num:"-"))])])]),t._v(" "),i("div",{staticClass:"quality q-center",style:{height:"two"==t.auto?"calc(100% - 110px)":t.aiResult.diagnosis&&t.aiResult.diagnosis.length&&!t.aiResult.aiNotCompleted?"calc(100% - 290px)":"calc(100% - 110px)"}},[i("div",{staticClass:"title"},[i("span",{class:"one"==t.auto?"auto":"",on:{click:function(e){return t.changeTab("one")}}},[t._v("AI处理")]),t._v(" "),i("span",{class:"two"==t.auto?"auto":"",on:{click:function(e){return t.changeTab("two")}}},[t._v("手工标注")])]),t._v(" "),t.aiResult.diagnosis&&!t.aiResult.aiNotCompleted&&"one"==t.auto?i("div",{staticClass:"noroi"},[Object.keys(t.cells).length?i("div",{staticClass:"quality-detail short"},[i("p",{class:{checked:"HSIL"==t.showType},on:{click:function(e){return t.toogleType("HSIL")}}},[i("span",[t._v(t._s("阴性"==t.aiResult.diagnosis[0]?"可疑1":"HSIL"))]),t._v(t._s(t.cells.HSIL.num))]),t._v(" "),i("p",{class:{checked:"滴虫"==t.showType},on:{click:function(e){return t.toogleType("滴虫")}}},[i("span",[t._v("滴虫")]),t._v(t._s(t.cells["滴虫"].num))]),t._v(" "),i("p",{class:{checked:"ASC-H"==t.showType},on:{click:function(e){return t.toogleType("ASC-H")}}},[i("span",[t._v(t._s("阴性"==t.aiResult.diagnosis[0]?"可疑2":"ASC-H"))]),t._v(t._s(t.cells["ASC-H"].num))]),t._v(" "),i("p",{class:{checked:"霉菌"==t.showType},on:{click:function(e){return t.toogleType("霉菌")}}},[i("span",[t._v("霉菌")]),t._v(t._s(t.cells["霉菌"].num))]),t._v(" "),i("p",{class:{checked:"LSIL"==t.showType},on:{click:function(e){return t.toogleType("LSIL")}}},[i("span",[t._v(t._s("阴性"==t.aiResult.diagnosis[0]?"可疑3":"LSIL"))]),t._v(t._s(t.cells.LSIL.num))]),t._v(" "),i("p",{class:{checked:"线索"==t.showType},on:{click:function(e){return t.toogleType("线索")}}},[i("span",[t._v("线索")]),t._v(t._s(t.cells["线索"].num))]),t._v(" "),i("p",{class:{checked:"ASCUS"==t.showType},on:{click:function(e){return t.toogleType("ASCUS")}}},[i("span",[t._v(t._s("阴性"==t.aiResult.diagnosis[0]?"可疑4":"ASC-US"))]),t._v(t._s(t.cells.ASCUS.num))]),t._v(" "),i("p",{class:{checked:"放线菌"==t.showType},on:{click:function(e){return t.toogleType("放线菌")}}},[i("span",[t._v("放线菌")]),t._v(t._s(t.cells["放线菌"].num))]),t._v(" "),i("p",{class:{checked:"AGC"==t.showType},on:{click:function(e){return t.toogleType("AGC")}}},[i("span",[t._v(t._s("阴性"==t.aiResult.diagnosis[0]?"可疑5":"AGC"))]),t._v(t._s(t.cells.AGC.num))]),t._v(" "),i("p",{class:{checked:"疱疹"==t.showType},on:{click:function(e){return t.toogleType("疱疹")}}},[i("span",[t._v("疱疹")]),t._v(t._s(t.cells["疱疹"].num))])]):t._e(),t._v(" "),i("div",{staticClass:"list-container"},[t.aiRoilist.length?i("div",{staticClass:"list"},[i("div",{ref:"aiRoilist",staticClass:"roi-container"},[i("p",[t._v("ROI勾选后将带入报告。")]),t._v(" "),t._l(t.aiRoilist,function(e){return i("div",{key:e.id,staticClass:"img-content",class:{"check-img":t.curRois[e.id]},on:{click:function(i){return t.goTocurRoi(e,i.shiftKey)}}},[i("img",{attrs:{"data-src":"/aipath/api/files/ROI?caseid="+t.record.id+"&fileid="+t.slice.id+"&filename="+encodeURIComponent(t.slice.filename)+"&roi=[["+Math.min.apply(Math,e.path.x)+","+Math.min.apply(Math,e.path.y)+"],["+Math.max.apply(Math,e.path.x)+","+Math.max.apply(Math,e.path.y)+"]] &roiid="+e.id,alt:""}}),t._v(" "),i("span",{class:{blue:e.image},on:{click:function(i){return i.stopPropagation(),t.changeImage(e)}}})])})],2),t._v(" "),t.showTips?i("div",{staticClass:"viewpop"},[t._v("只展示置信度最高的前100个视野")]):t._e()]):i("h3",[t._v("处理结果为空～")])])]):t._e(),t._v(" "),"two"==t.auto?i("div",{staticClass:"noroi manunal"},[i("div",{staticClass:"quality-detail short"},[i("p",{class:{checked:"HSIL"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("HSIL")}}},[i("span",[t._v("HSIL")]),t._v(t._s(t.humanResult.HSIL.data.length))]),t._v(" "),i("p",{class:{checked:"滴虫"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("滴虫")}}},[i("span",[t._v("滴虫")]),t._v(t._s(t.humanResult["滴虫"].data.length))]),t._v(" "),i("p",{class:{checked:"ASC-H"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("ASC-H")}}},[i("span",[t._v("ASC-H")]),t._v(t._s(t.humanResult["ASC-H"].data.length))]),t._v(" "),i("p",{class:{checked:"霉菌"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("霉菌")}}},[i("span",[t._v("霉菌")]),t._v(t._s(t.humanResult["霉菌"].data.length))]),t._v(" "),i("p",{class:{checked:"LSIL"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("LSIL")}}},[i("span",[t._v("LSIL")]),t._v(t._s(t.humanResult.LSIL.data.length))]),t._v(" "),i("p",{class:{checked:"线索"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("线索")}}},[i("span",[t._v("线索")]),t._v(t._s(t.humanResult["线索"].data.length))]),t._v(" "),i("p",{class:{checked:"ASC-US"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("ASC-US")}}},[i("span",[t._v("ASC-US")]),t._v(t._s(t.humanResult["ASC-US"].data.length))]),t._v(" "),i("p",{class:{checked:"放线菌"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("放线菌")}}},[i("span",[t._v("放线菌")]),t._v(t._s(t.humanResult["放线菌"].data.length))]),t._v(" "),i("p",{class:{checked:"AGC"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("AGC")}}},[i("span",[t._v("AGC")]),t._v(t._s(t.humanResult.AGC.data.length))]),t._v(" "),i("p",{class:{checked:"疱疹"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("疱疹")}}},[i("span",[t._v("疱疹")]),t._v(t._s(t.humanResult["疱疹"].data.length))]),t._v(" "),i("p",{class:{checked:"阴性"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("阴性")}}},[i("span",[t._v("阴性")]),t._v(t._s(t.humanResult["阴性"].data.length))]),t._v(" "),i("p",{class:{checked:"异物"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("异物")}}},[i("span",[t._v("异物")]),t._v(t._s(t.humanResult["异物"].data.length))]),t._v(" "),i("p",{class:{checked:"无"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("无")}}},[i("span",[t._v("无")]),t._v(t._s(t.humanResult["无"].data.length))]),t._v(" "),i("p",{class:{checked:"不确定"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("不确定")}}},[i("span",[t._v("不确定")]),t._v(t._s(t.humanResult["不确定"].data.length))])]),t._v(" "),i("div",{staticClass:"quality-detail short only"},[i("p",{class:{checked:"AI假阴"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("AI假阴")}}},[i("span",[t._v("AI假阴")]),t._v(t._s(t.humanResult["AI假阴"].data.length))]),t._v(" "),i("p",{class:{checked:"AI假阳"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("AI假阳")}}},[i("span",[t._v("AI假阳")]),t._v(t._s(t.humanResult["AI假阳"].data.length))])]),t._v(" "),i("v-roi",{staticClass:"checkroi",attrs:{roilist:t.humanRoilist,currentRois:t.curRois,forbidden:!0},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}})],1):t._e()]),t._v(" "),"one"==t.auto&&t.aiResult.diagnosis&&t.aiResult.diagnosis.length&&!t.aiResult.aiNotCompleted?i("div",[i("div",{staticClass:"advice"},[t._v("\n                AI建议："),i("i",{style:{"font-style":"normal",color:"阴性"==t.aiResult.diagnosis[0]?"#17DE6B":"阳性"==t.aiResult.diagnosis[0]?"#F23030":"#fff"}},[t._v(t._s(t.aiResult.diagnosis[0]+" "+t.aiResult.diagnosis[1]))]),t._v(" "),i("span",{attrs:{title:t.aiResult.microbe.join(",")}},[t._v("微生物提示："+t._s(t.aiResult.microbe.join(",")))])]),t._v(" "),i("div",{staticClass:"quality"},[i("div",{staticClass:"title"},[i("span",[t._v("医生复核")]),t._v(" "),i("div",{staticClass:"accept",on:{click:t.accept}},[t._v("采纳AI建议")]),t._v(" "),i("div",{staticClass:"accept",staticStyle:{width:"45px"},on:{click:t.clearCheckReslut}},[t._v("清空")])]),t._v(" "),i("div",{staticClass:"quality-detail"},[i("div",{staticClass:"result"},[t._v("\n                        诊断结果:\n                        "),i("el-radio",{staticClass:"pos",attrs:{label:"阴性"},on:{change:function(e){return t.change(e,"diagnosis")}},model:{value:t.docResult.diagnosis,callback:function(e){t.$set(t.docResult,"diagnosis",e)},expression:"docResult.diagnosis"}},[t._v("阴性")]),t._v(" "),i("el-radio",{staticClass:"neg",attrs:{label:"阳性"},on:{change:function(e){return t.change(e,"diagnosis")}},model:{value:t.docResult.diagnosis,callback:function(e){t.$set(t.docResult,"diagnosis",e)},expression:"docResult.diagnosis"}},[t._v("阳性")]),t._v(" "),"阳性"==t.docResult.diagnosis?i("el-select",{attrs:{"popper-class":"hpf",placeholder:"请选择",multiple:"","collapse-tags":""},on:{change:function(e){return t.change(e,"tps")}},model:{value:t.docResult.tps,callback:function(e){t.$set(t.docResult,"tps",e)},expression:"docResult.tps"}},t._l(t.options,function(e){return i("el-option",{key:e,attrs:{label:e,value:e}},[i("span",{staticClass:"checkbox-icon"}),t._v(" "),i("span",{staticStyle:{"margin-left":"15px",lineHeight:"40px"}},[t._v(t._s(e))])])}),1):t._e(),t._v(" "),i("el-radio",{attrs:{label:"不确定"},on:{change:function(e){return t.change(e,"diagnosis")}},model:{value:t.docResult.diagnosis,callback:function(e){t.$set(t.docResult,"diagnosis",e)},expression:"docResult.diagnosis"}},[t._v("不确定")])],1),t._v(" "),i("div",{staticClass:"result"},[t._v("\n                        微生物提示:\n                        "),i("el-checkbox-group",{on:{change:function(e){return t.change(e,"microbe")}},model:{value:t.docResult.microbe,callback:function(e){t.$set(t.docResult,"microbe",e)},expression:"docResult.microbe"}},[i("el-checkbox",{attrs:{label:"滴虫"}}),t._v(" "),i("el-checkbox",{attrs:{label:"霉菌"}}),t._v(" "),i("el-checkbox",{attrs:{label:"线索"}}),t._v(" "),i("el-checkbox",{attrs:{label:"放线菌"}}),t._v(" "),i("el-checkbox",{attrs:{label:"疱疹"}})],1)],1),t._v(" "),i("div",{staticClass:"result"},[t._v("\n                        切片背景:\n                        "),i("el-checkbox-group",{on:{change:function(e){return t.change(e,"background")}},model:{value:t.docResult.background,callback:function(e){t.$set(t.docResult,"background",e)},expression:"docResult.background"}},[i("el-checkbox",{attrs:{label:"萎缩"}}),t._v(" "),i("el-checkbox",{attrs:{label:"炎症"}}),t._v(" "),i("el-checkbox",{attrs:{label:"修复"}}),t._v(" "),i("el-checkbox",{attrs:{label:"出血"}}),t._v(" "),i("el-checkbox",{attrs:{label:"化生"}})],1)],1)])])]):t._e(),t._v(" "),t.aiResult.aiNotCompleted&&"one"==t.auto&&t.showbutton?i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]):t._e(),t._v(" "),t.showbutton||"one"!=t.auto?t._e():i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:function(e){return t.canceltesk()}}},[t._v(t._s(t.$t("slice.cancelTasks")))])])])])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"title"},[e("span",[this._v("AI质控")])])}]};var et=i("VU/8")(Q,tt,!1,function(t){i("fbUa"),i("5wHl")},"data-v-5100aa24",null).exports,it={props:{dnaAiResult:{type:Object,default:function(){return{controlIOD:""}}},record:{type:Object,default:function(){return{id:""}}},slice:{type:Object,default:function(){return{id:""}}},curRois:{type:Object,default:function(){return{}}},docDNAResult:{type:Object,default:()=>{}}},data(){return{showTips:!0,checkValue:"",options:["标本不满意:上皮细胞数目太少","标本不满意","其它","有效检测细胞不足","未见DNA倍体异常细胞","可见少量DNA倍体异常细胞（1-2个）","可见DNA倍体异常细胞（≥3个）","可见少量细胞增生（5%-10%）","可见细胞异常增生（≥10%）","可见异倍体细胞峰"],currentRoi:{},dnaCheckResult:this.$props.docDNAResult.dnaResult,showBig:!1}},methods:{showBigPic(t){console.log(t)},checkAll(){let t=this.dnaAiRoilist.filter(t=>!t.image);this.$emit("changeImages",t)},reverseCheck(){this.$emit("changeImages",this.dnaAiRoilist)},changeImage(t){this.$emit("changeImage",t)},curROIChange(t){this.currentRoi=t,this.$emit("curROIChange",t,!1)},listChangeCurrent(){this.$emit("listChangeCurrent")},accept(){this.$emit("accept","dna")},clearCheckReslut(){this.$emit("clearCheckReslut","dna")},change(t,e){this.$emit("change",t,e)}},mounted(){let t=this.dnaAiRoilist.filter(t=>this.curRois[t.id]);this.currentRoi=t.length?t[0]:{}},computed:{dnaAiRoilist(){return this.$props.dnaAiResult.nuclei||[]}},watch:{docDNAResult:{immediate:!0,deep:!0,handler(t){this.docDNAResult=t,this.dnaCheckResult=this.docDNAResult.dnaResult}},curRois:{immediate:!0,deep:!0,handler(t){let e=this.dnaAiRoilist.filter(t=>this.curRois[t.id]);this.currentRoi=e.length?e[0]:{}}}}},st={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"dna-content"},[t.dnaAiResult.dna_diagnosis?i("div",{staticClass:"quality height100"},[i("div",{staticClass:"quality"},[t._m(0),t._v(" "),i("div",{staticClass:"quality-pic"},[i("div",{staticClass:"pic-main"},[i("img",{staticClass:"img1",attrs:{src:"/aipath/api/files/getImage?caseid="+t.record.id+"&fileid="+t.slice.id+"&filename="+encodeURIComponent(t.slice.filename)+"&type=histplot&date="+(new Date).getTime(),alt:""},on:{click:function(e){return e.stopPropagation(),t.showBigPic("histplot")}}})]),t._v(" "),i("div",{staticClass:"pic-main pic-main1"},[i("img",{staticClass:"img2",attrs:{src:"/aipath/api/files/getImage?caseid="+t.record.id+"&fileid="+t.slice.id+"&filename="+encodeURIComponent(t.slice.filename)+"&type=scatterplot&date="+(new Date).getTime(),alt:""},on:{click:function(e){return e.stopPropagation(),t.showBigPic("scatterplot")}}})]),t._v(" "),i("div",{staticClass:"data-count",staticStyle:{color:"rgb(112,182,3)"}},[t._v("\n\t\t\t\t\t\t正常二倍体细胞: "+t._s(t.dnaAiResult.num_normal)+"\n\t\t\t\t\t")]),t._v(" "),i("div",{staticClass:"data-count",staticStyle:{color:"rgb(245,154,35)"}},[t._v("\n\t\t\t\t\t\t增生细胞: "+t._s(t.dnaAiResult.num_abnormal_low)+"\n\t\t\t\t\t")]),t._v(" "),i("div",{staticClass:"data-count",staticStyle:{color:"rgb(217,0,27)"}},[t._v("\n\t\t\t\t\t\t多倍体细胞: "+t._s(t.dnaAiResult.num_abnormal_high-t.dnaAiRoilist.filter(function(t){return!t.image&&t.dna_index>=2.5}).length)+"\n\t\t\t\t\t")]),t._v(" "),i("div",{staticClass:"data-count"},[t._v("\n\t\t\t\t\t\t上皮细胞: "+t._s(t.dnaAiResult.num_normal+t.dnaAiResult.num_abnormal_low+t.dnaAiResult.num_abnormal_high)+"\n\t\t\t\t\t")])])]),t._v(" "),i("div",{staticClass:"list-container"},[t.dnaAiRoilist&&t.dnaAiRoilist.length?i("div",{staticClass:"list"},[i("div",{staticClass:"list-container-head"},[i("div",{staticClass:"list-container-head-txt"},[t._v("\n\t\t\t\t\t\t\t前30个已勾选细胞核将带入报告。\n\t\t\t\t\t\t")]),t._v(" "),i("div",{staticClass:"list-container-btn"},[i("div",{staticClass:"container-btn",attrs:{"data-value":"all"},on:{click:function(e){return e.stopPropagation(),t.checkAll(e)}}},[t._v("\n\t\t\t\t\t\t\t\t全选\n\t\t\t\t\t\t\t")]),t._v(" "),i("div",{staticClass:"container-btn",attrs:{"data-value":"empty"},on:{click:function(e){return e.stopPropagation(),t.reverseCheck(e)}}},[t._v("\n\t\t\t\t\t\t\t\t反选\n\t\t\t\t\t\t\t")])])]),t._v(" "),i("div",{ref:"dnaAiRoilist",staticClass:"roi-container"},t._l(t.dnaAiRoilist,function(e){return i("div",{key:e.id,staticClass:"img-content",class:{"check-img":t.curRois[e.id]},on:{click:function(i){return t.$emit("goTocurRoi",e,!1)}}},[i("img",{attrs:{src:"/aipath/api/files/ROI?caseid="+t.record.id+"&fileid="+t.slice.id+"&filename="+encodeURIComponent(t.slice.filename)+"&roi=[["+Math.min.apply(Math,e.path.x)+","+Math.min.apply(Math,e.path.y)+"],["+Math.max.apply(Math,e.path.x)+","+Math.max.apply(Math,e.path.y)+"]] &roiid="+e.id,alt:""}}),t._v(" "),i("div",{staticClass:"roi-percent",class:{"red-color":e.dna_index-0>=2.5}},[t._v(t._s(e.dna_index))]),t._v(" "),i("span",{class:{blue:e.image},on:{click:function(i){return i.stopPropagation(),t.changeImage(e)}}})])}),0),t._v(" "),i("div",{staticClass:"cells-result"},[i("p",[i("span",[t._v("核面积：")]),i("em",[t._v(t._s(t.currentRoi.area?t.currentRoi.area+"um²":"-"))])]),t._v(" "),i("p",[i("span",[t._v("光密度：")]),i("em",[t._v(t._s(t.currentRoi.dna_amount||"-"))])])])]):t._e()]),t._v(" "),i("div",{staticClass:"advice"},[t._v("\n\t\t\t\tAI建议：\n\t\t\t\t"),i("span",{attrs:{title:"未见DNA倍体异常细胞"}},[t._v(t._s(t.dnaAiResult.dna_diagnosis)+" ")])]),t._v(" "),i("div",{staticClass:"quality"},[i("div",{staticClass:"title"},[i("span",[t._v("医生复核")]),t._v(" "),i("div",{staticClass:"accept",on:{click:t.accept}},[t._v("采纳AI建议")]),t._v(" "),i("div",{staticClass:"accept",staticStyle:{width:"45px"},on:{click:t.clearCheckReslut}},[t._v("\n\t\t\t\t\t\t清空\n\t\t\t\t\t")])]),t._v(" "),i("div",{staticClass:"quality-detail",staticStyle:{borderbottom:"1px solid #424242"}},[i("div",{staticClass:"result"},[t._v("\n\t\t\t\t\t\t诊断结果:\n\t\t\t\t\t\t"),i("el-select",{attrs:{"popper-class":"hpf",placeholder:"请选择","collapse-tags":""},on:{change:function(e){return t.change(e,"dnaResult")}},model:{value:t.dnaCheckResult,callback:function(e){t.dnaCheckResult=e},expression:"dnaCheckResult"}},t._l(t.options,function(t){return i("el-option",{key:t,attrs:{label:t,value:t}})}),1)],1)])])]):i("div",{staticClass:"no-result"},[t._v(t._s(t.$t("slice.noanalysis")))])])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"title"},[e("span",[this._v("细胞数量分布")]),this._v(" "),e("span",[this._v("核面积分布")])])}]};var at=i("VU/8")(it,st,!1,function(t){i("+yoz")},"data-v-61507756",null).exports,nt={mixins:[U,Y],props:["slice","record","config"],components:{"v-dragon":v.a,"v-roi":f,"v-menus":X,"v-dnaresult":at},mounted(){},methods:{changeModule(t){let e=t.target.getAttribute("data-value");switch(e){case"cellresult":case"dnaresult":this.curModule=e}}}},ot={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",staticStyle:{width:"100%"},attrs:{tabIndex:0},on:{keydown:t.keydown,mousewheel:function(e){t.contextmenuPosition=null},mousedown:function(e){t.contextmenuPosition=null}}},[i("div",{staticClass:"analyright"},[i("v-dragon",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"osd",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:[].concat(t.leftRoilist),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:1962,"element-loading-text":"处理中，请耐心等待","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.5)"},on:{curROI:t.curROIChange,roiChanged:t.roiChanged,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},contextmenu:function(e,i){return t.showMenu(e,i)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},getRoi:t.getRoi}},[t.contextmenuPosition?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+"px",top:t.menuPosition.y+"px"}},[i("v-menus",{attrs:{pos:t.contextmenuPosition,menus:t.labeltree,currentItem:t.currentItem,newover:t.newover},on:{chosen:function(e){return t.setAnnotation(e)}}})],1):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){t.curModule="cellresult",t.isDrawMpp()}}},[t._v("\n\t\t\t\t"+t._s(t.$t("slice.start"))+"\n\t\t\t")]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("ul",{staticClass:"tab-class-content",on:{click:function(e){return t.changeModule(e)}}},[i("li",{class:{"cur-module":"cellresult"==t.curModule},attrs:{"data-value":"cellresult"}},[t._v("\n\t\t\t\t\t宫颈细胞学\n\t\t\t\t")]),t._v(" "),i("li",{class:{"cur-module":"dnaresult"==t.curModule},attrs:{"data-value":"dnaresult"}},[t._v("\n\t\t\t\t\tDNA倍体\n\t\t\t\t")])]),t._v(" "),"dnaresult"==t.curModule?i("v-dnaresult",{attrs:{dnaAiResult:t.aiResult,docDNAResult:t.docResult,record:t.record,slice:t.slice,curRois:t.curRois},on:{changeImage:t.changeImage,changeImages:t.changeImages,curROIChange:t.curROIChange,listChangeCurrent:t.listChangeCurrent,accept:t.accept,clearCheckReslut:t.clearCheckReslut,change:function(e,i){return t.change(e,i)},goTocurRoi:t.goTocurRoi}}):i("div",{staticClass:"dna-tbs"},[i("div",{staticClass:"quality"},[i("div",{staticClass:"title"},[i("span",[t._v("AI质控")])]),t._v(" "),i("div",{staticClass:"quality-detail"},[i("p",[t._v("切片质量："),i("em",[t._v(t._s({1:"合格",0:"不合格"}[t.aiResult.slide_quality]||"-"))])]),t._v(" "),i("p",[t._v("清 晰 度："+t._s(t.slice.clarity?(100*t.slice.clarity).toFixed(2)+"%":"-"))]),t._v(" "),i("p",[t._v("扫描倍数："+t._s(t.slice.objective_rate||"-"))]),t._v(" "),i("p",[t._v("细 胞 量："+t._s("number"==typeof t.aiResult.cell_num?t.aiResult.cell_num:"-"))])])]),t._v(" "),i("div",{staticClass:"quality q-center",style:{height:"two"==t.auto?"calc(100% - 110px)":t.aiResult.diagnosis&&t.aiResult.diagnosis.length&&!t.aiResult.aiNotCompleted?"calc(100% - 289px)":"calc(100% - 110px)"}},[i("div",{staticClass:"title"},[i("span",{class:"one"==t.auto?"auto":"",on:{click:function(e){return t.changeTab("one")}}},[t._v("AI处理")]),t._v(" "),i("span",{class:"two"==t.auto?"auto":"",on:{click:function(e){return t.changeTab("two")}}},[t._v("手工标注")])]),t._v(" "),t.aiResult.diagnosis&&!t.aiResult.aiNotCompleted&&"one"==t.auto?i("div",{staticClass:"noroi"},[Object.keys(t.cells).length?i("div",{staticClass:"quality-detail short"},[i("p",{class:{checked:"HSIL"==t.showType},on:{click:function(e){return t.toogleType("HSIL")}}},[i("span",[t._v(t._s("阴性"==t.aiResult.diagnosis[0]?"可疑1":"HSIL"))]),t._v(t._s(t.cells.HSIL.num)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"滴虫"==t.showType},on:{click:function(e){return t.toogleType("滴虫")}}},[i("span",[t._v("滴虫")]),t._v(t._s(t.cells["滴虫"].num)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"ASC-H"==t.showType},on:{click:function(e){return t.toogleType("ASC-H")}}},[i("span",[t._v(t._s("阴性"==t.aiResult.diagnosis[0]?"可疑2":"ASC-H"))]),t._v(t._s(t.cells["ASC-H"].num)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"霉菌"==t.showType},on:{click:function(e){return t.toogleType("霉菌")}}},[i("span",[t._v("霉菌")]),t._v(t._s(t.cells["霉菌"].num)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"LSIL"==t.showType},on:{click:function(e){return t.toogleType("LSIL")}}},[i("span",[t._v(t._s("阴性"==t.aiResult.diagnosis[0]?"可疑3":"LSIL"))]),t._v(t._s(t.cells.LSIL.num)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"线索"==t.showType},on:{click:function(e){return t.toogleType("线索")}}},[i("span",[t._v("线索")]),t._v(t._s(t.cells["线索"].num)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"ASCUS"==t.showType},on:{click:function(e){return t.toogleType("ASCUS")}}},[i("span",[t._v(t._s("阴性"==t.aiResult.diagnosis[0]?"可疑4":"ASC-US"))]),t._v(t._s(t.cells.ASCUS.num)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"放线菌"==t.showType},on:{click:function(e){return t.toogleType("放线菌")}}},[i("span",[t._v("放线菌")]),t._v(t._s(t.cells["放线菌"].num)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"AGC"==t.showType},on:{click:function(e){return t.toogleType("AGC")}}},[i("span",[t._v(t._s("阴性"==t.aiResult.diagnosis[0]?"可疑5":"AGC"))]),t._v(t._s(t.cells.AGC.num)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"疱疹"==t.showType},on:{click:function(e){return t.toogleType("疱疹")}}},[i("span",[t._v("疱疹")]),t._v(t._s(t.cells["疱疹"].num)+"\n\t\t\t\t\t\t\t")])]):t._e(),t._v(" "),i("div",{staticClass:"list-container"},[t.aiRoilist.length?i("div",{staticClass:"list"},[i("div",{ref:"aiRoilist",staticClass:"roi-container"},[i("p",[t._v("ROI勾选后将带入报告。")]),t._v(" "),t._l(t.aiRoilist,function(e){return i("div",{key:e.id,staticClass:"img-content",class:{"check-img":t.curRois[e.id]},on:{click:function(i){return t.goTocurRoi(e,i.shiftKey)}}},[i("img",{attrs:{src:"/aipath/api/files/ROI?caseid="+t.record.id+"&fileid="+t.slice.id+"&filename="+encodeURIComponent(t.slice.filename)+"&roi=[["+Math.min.apply(Math,e.path.x)+","+Math.min.apply(Math,e.path.y)+"],["+Math.max.apply(Math,e.path.x)+","+Math.max.apply(Math,e.path.y)+"]] &roiid="+e.id,alt:""}}),t._v(" "),i("span",{class:{blue:e.image},on:{click:function(i){return i.stopPropagation(),t.changeImage(e)}}})])})],2),t._v(" "),t.showTips?i("div",{staticClass:"viewpop"},[t._v("\n\t\t\t\t\t\t\t\t\t只展示置信度最高的前100个视野\n\t\t\t\t\t\t\t\t")]):t._e()]):i("h3",[t._v("处理结果为空～")])])]):t._e(),t._v(" "),"two"==t.auto?i("div",{staticClass:"noroi manunal"},[i("div",{staticClass:"quality-detail short"},[i("p",{class:{checked:"HSIL"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("HSIL")}}},[i("span",[t._v("HSIL")]),t._v(t._s(t.humanResult.HSIL.data.length)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"滴虫"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("滴虫")}}},[i("span",[t._v("滴虫")]),t._v(t._s(t.humanResult["滴虫"].data.length)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"ASC-H"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("ASC-H")}}},[i("span",[t._v("ASC-H")]),t._v(t._s(t.humanResult["ASC-H"].data.length)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"霉菌"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("霉菌")}}},[i("span",[t._v("霉菌")]),t._v(t._s(t.humanResult["霉菌"].data.length)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"LSIL"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("LSIL")}}},[i("span",[t._v("LSIL")]),t._v(t._s(t.humanResult.LSIL.data.length)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"线索"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("线索")}}},[i("span",[t._v("线索")]),t._v(t._s(t.humanResult["线索"].data.length)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"ASC-US"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("ASC-US")}}},[i("span",[t._v("ASC-US")]),t._v(t._s(t.humanResult["ASC-US"].data.length)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"放线菌"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("放线菌")}}},[i("span",[t._v("放线菌")]),t._v(t._s(t.humanResult["放线菌"].data.length)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"AGC"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("AGC")}}},[i("span",[t._v("AGC")]),t._v(t._s(t.humanResult.AGC.data.length)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"疱疹"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("疱疹")}}},[i("span",[t._v("疱疹")]),t._v(t._s(t.humanResult["疱疹"].data.length)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"阴性"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("阴性")}}},[i("span",[t._v("阴性")]),t._v(t._s(t.humanResult["阴性"].data.length)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"异物"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("异物")}}},[i("span",[t._v("异物")]),t._v(t._s(t.humanResult["异物"].data.length)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"无"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("无")}}},[i("span",[t._v("无")]),t._v(t._s(t.humanResult["无"].data.length)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"不确定"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("不确定")}}},[i("span",[t._v("不确定")]),t._v(t._s(t.humanResult["不确定"]&&t.humanResult["不确定"].data.length)+"\n\t\t\t\t\t\t\t")])]),t._v(" "),i("div",{staticClass:"quality-detail short only"},[i("p",{class:{checked:"AI假阴"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("AI假阴")}}},[i("span",[t._v("AI假阴")]),t._v(t._s(t.humanResult["AI假阴"].data.length)+"\n\t\t\t\t\t\t\t")]),t._v(" "),i("p",{class:{checked:"AI假阳"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("AI假阳")}}},[i("span",[t._v("AI假阳")]),t._v(t._s(t.humanResult["AI假阳"].data.length)+"\n\t\t\t\t\t\t\t")])]),t._v(" "),i("v-roi",{staticClass:"checkroi",attrs:{roilist:t.humanRoilist,currentRois:t.curRois,forbidden:!0},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}})],1):t._e()]),t._v(" "),"one"==t.auto&&t.aiResult.diagnosis&&t.aiResult.diagnosis.length&&!t.aiResult.aiNotCompleted?i("div",[i("div",{staticClass:"advice"},[t._v("\n\t\t\t\t\t\tAI建议："),i("i",{style:{"font-style":"normal",color:"阴性"==t.aiResult.diagnosis[0]?"#17DE6B":"阳性"==t.aiResult.diagnosis[0]?"#F23030":"#fff"}},[t._v(t._s(t.aiResult.diagnosis[0]+" "+t.aiResult.diagnosis[1]))]),t._v(" "),i("span",{attrs:{title:t.aiResult.microbe.join(",")}},[t._v("微生物提示："+t._s(t.aiResult.microbe.join(",")))])]),t._v(" "),i("div",{staticClass:"quality"},[i("div",{staticClass:"title"},[i("span",[t._v("医生复核")]),t._v(" "),i("div",{staticClass:"accept",on:{click:t.accept}},[t._v("采纳AI建议")]),t._v(" "),i("div",{staticClass:"accept",staticStyle:{width:"45px"},on:{click:t.clearCheckReslut}},[t._v("\n\t\t\t\t\t\t\t\t清空\n\t\t\t\t\t\t\t")])]),t._v(" "),i("div",{staticClass:"quality-detail"},[i("div",{staticClass:"result"},[t._v("\n\t\t\t\t\t\t\t\t诊断结果:\n\t\t\t\t\t\t\t\t"),i("el-radio",{staticClass:"pos",attrs:{label:"阴性"},on:{change:function(e){return t.change(e,"diagnosis")}},model:{value:t.docResult.diagnosis,callback:function(e){t.$set(t.docResult,"diagnosis",e)},expression:"docResult.diagnosis"}},[t._v("阴性")]),t._v(" "),i("el-radio",{staticClass:"neg",attrs:{label:"阳性"},on:{change:function(e){return t.change(e,"diagnosis")}},model:{value:t.docResult.diagnosis,callback:function(e){t.$set(t.docResult,"diagnosis",e)},expression:"docResult.diagnosis"}},[t._v("阳性")]),t._v(" "),"阳性"==t.docResult.diagnosis?i("el-select",{attrs:{"popper-class":"hpf",placeholder:"请选择",multiple:"","collapse-tags":""},on:{change:function(e){return t.change(e,"tps")}},model:{value:t.docResult.tps,callback:function(e){t.$set(t.docResult,"tps",e)},expression:"docResult.tps"}},t._l(t.options,function(e){return i("el-option",{key:e,attrs:{label:e,value:e}},[i("span",{staticClass:"checkbox-icon"}),t._v(" "),i("span",{staticStyle:{"margin-left":"15px",lineheight:"40px"}},[t._v(t._s(e))])])}),1):t._e(),t._v(" "),i("el-radio",{attrs:{label:"不确定"},on:{change:function(e){return t.change(e,"diagnosis")}},model:{value:t.docResult.diagnosis,callback:function(e){t.$set(t.docResult,"diagnosis",e)},expression:"docResult.diagnosis"}},[t._v("不确定")])],1),t._v(" "),i("div",{staticClass:"result"},[t._v("\n\t\t\t\t\t\t\t\t微生物提示:\n\t\t\t\t\t\t\t\t"),i("el-checkbox-group",{on:{change:function(e){return t.change(e,"microbe")}},model:{value:t.docResult.microbe,callback:function(e){t.$set(t.docResult,"microbe",e)},expression:"docResult.microbe"}},[i("el-checkbox",{attrs:{label:"滴虫"}}),t._v(" "),i("el-checkbox",{attrs:{label:"霉菌"}}),t._v(" "),i("el-checkbox",{attrs:{label:"线索"}}),t._v(" "),i("el-checkbox",{attrs:{label:"放线菌"}}),t._v(" "),i("el-checkbox",{attrs:{label:"疱疹"}})],1)],1),t._v(" "),i("div",{staticClass:"result"},[t._v("\n\t\t\t\t\t\t\t\t切片背景:\n\t\t\t\t\t\t\t\t"),i("el-checkbox-group",{on:{change:function(e){return t.change(e,"background")}},model:{value:t.docResult.background,callback:function(e){t.$set(t.docResult,"background",e)},expression:"docResult.background"}},[i("el-checkbox",{attrs:{label:"萎缩"}}),t._v(" "),i("el-checkbox",{attrs:{label:"炎症"}}),t._v(" "),i("el-checkbox",{attrs:{label:"修复"}}),t._v(" "),i("el-checkbox",{attrs:{label:"出血"}}),t._v(" "),i("el-checkbox",{attrs:{label:"化生"}})],1)],1)])])]):t._e(),t._v(" "),t.aiResult.diagnosis&&t.aiResult.diagnosis.length&&t.aiResult.diagnosis[0]||"one"!=t.auto||!t.showbutton?t._e():i("div",{staticClass:"ifshowtables"},[t._v("\n\t\t\t\t\t"+t._s(t.$t("slice.noanalysis"))+"\n\t\t\t\t")]),t._v(" "),t.showbutton||"one"!=t.auto?t._e():i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v("\n\t\t\t\t\t\t\t"+t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4c9ffa","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position"))+"\n\t\t\t\t\t\t")]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:function(e){return t.canceltesk()}}},[t._v("\n\t\t\t\t\t\t"+t._s(t.$t("slice.cancelTasks"))+"\n\t\t\t\t\t")])])])],1)])},staticRenderFns:[]};var lt=i("VU/8")(nt,ot,!1,function(t){i("7pAx"),i("22EN")},"data-v-0ab09236",null).exports,rt={mixins:[U,V],props:["slice","record","config"],components:{"v-dragon":v.a,"v-roi":f,"v-menus":X}},ct={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",staticStyle:{width:"100%"},attrs:{tabIndex:0},on:{keydown:t.keydown,mousewheel:function(e){t.contextmenuPosition=null},mousedown:function(e){t.contextmenuPosition=null}}},[i("div",{staticClass:"analyright"},[i("v-dragon",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"osd",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:[].concat(t.leftRoilist),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:1962,"element-loading-text":"处理中，请耐心等待","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.5)"},on:{curROI:t.curROIChange,roiChanged:t.roiChanged,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},contextmenu:function(e,i){return t.showMenu(e,i)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},getRoi:t.getRoi}},[t.contextmenuPosition?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+"px",top:t.menuPosition.y+"px"}},[i("v-menus",{attrs:{pos:t.contextmenuPosition,menus:t.labeltree,currentItem:t.currentItem,newover:t.newover},on:{chosen:function(e){return t.setAnnotation(e)}}})],1):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("div",{staticClass:"quality"},[t._m(0),t._v(" "),i("div",{staticClass:"quality-detail"},[i("p",[t._v("切片质量："),i("em",[t._v(t._s({1:"合格",0:"不合格"}[t.aiResult.slide_quality]||"-"))])]),t._v(" "),i("p",[t._v("清 晰 度："+t._s(t.slice.clarity?(100*t.slice.clarity).toFixed(2)+"%":"-"))]),t._v(" "),i("p",[t._v("扫描倍数："+t._s(t.slice.objective_rate||"-"))]),t._v(" "),i("p",[t._v("细 胞 量："+t._s("number"==typeof t.aiResult.cell_num?t.aiResult.cell_num:"-"))])])]),t._v(" "),i("div",{staticClass:"quality q-center",style:{height:"two"==t.auto?"calc(100% - 110px)":t.aiResult.diagnosis&&t.aiResult.diagnosis.length&&!t.aiResult.aiNotCompleted?"calc(100% - 290px)":"calc(100% - 110px)"}},[i("div",{staticClass:"title"},[i("span",{class:"one"==t.auto?"auto":"",on:{click:function(e){return t.changeTab("one")}}},[t._v("AI处理")]),t._v(" "),i("span",{class:"two"==t.auto?"auto":"",on:{click:function(e){return t.changeTab("two")}}},[t._v("手动处理")])]),t._v(" "),t.aiResult.diagnosis&&!t.aiResult.aiNotCompleted&&"one"==t.auto?i("div",{staticClass:"noroi"},[Object.keys(t.cells).length?i("div",{staticClass:"quality-detail short"},[i("p",{class:{checked:"HSIL"==t.showType},on:{click:function(e){return t.toogleType("HSIL")}}},[i("span",[t._v(t._s("阴性"==t.aiResult.diagnosis[0]?"可疑1":"HSIL"))]),t._v(t._s(t.cells.HSIL.num))]),t._v(" "),i("p",{class:{checked:"滴虫"==t.showType},on:{click:function(e){return t.toogleType("滴虫")}}},[i("span",[t._v("滴虫")]),t._v(t._s(t.cells["滴虫"].num))]),t._v(" "),i("p",{class:{checked:"ASC-H"==t.showType},on:{click:function(e){return t.toogleType("ASC-H")}}},[i("span",[t._v(t._s("阴性"==t.aiResult.diagnosis[0]?"可疑2":"ASC-H"))]),t._v(t._s(t.cells["ASC-H"].num))]),t._v(" "),i("p",{class:{checked:"霉菌"==t.showType},on:{click:function(e){return t.toogleType("霉菌")}}},[i("span",[t._v("霉菌")]),t._v(t._s(t.cells["霉菌"].num))]),t._v(" "),i("p",{class:{checked:"LSIL"==t.showType},on:{click:function(e){return t.toogleType("LSIL")}}},[i("span",[t._v(t._s("阴性"==t.aiResult.diagnosis[0]?"可疑3":"LSIL"))]),t._v(t._s(t.cells.LSIL.num))]),t._v(" "),i("p",{class:{checked:"线索"==t.showType},on:{click:function(e){return t.toogleType("线索")}}},[i("span",[t._v("线索")]),t._v(t._s(t.cells["线索"].num))]),t._v(" "),i("p",{class:{checked:"ASCUS"==t.showType},on:{click:function(e){return t.toogleType("ASCUS")}}},[i("span",[t._v(t._s("阴性"==t.aiResult.diagnosis[0]?"可疑4":"ASC-US"))]),t._v(t._s(t.cells.ASCUS.num))]),t._v(" "),i("p",{class:{checked:"放线菌"==t.showType},on:{click:function(e){return t.toogleType("放线菌")}}},[i("span",[t._v("放线菌")]),t._v(t._s(t.cells["放线菌"].num))]),t._v(" "),i("p",{class:{checked:"AGC"==t.showType},on:{click:function(e){return t.toogleType("AGC")}}},[i("span",[t._v(t._s("阴性"==t.aiResult.diagnosis[0]?"可疑5":"AGC"))]),t._v(t._s(t.cells.AGC.num))]),t._v(" "),i("p",{class:{checked:"疱疹"==t.showType},on:{click:function(e){return t.toogleType("疱疹")}}},[i("span",[t._v("疱疹")]),t._v(t._s(t.cells["疱疹"].num))])]):t._e(),t._v(" "),i("div",{staticClass:"list-container"},[t.aiRoilist.length?i("div",{staticClass:"list"},[i("div",{ref:"aiRoilist",staticClass:"roi-container"},[i("p",[t._v("ROI勾选后将带入报告。")]),t._v(" "),t._l(t.aiRoilist,function(e){return i("div",{key:e.id,staticClass:"img-content",class:{"check-img":t.curRois[e.id]},on:{click:function(i){return t.goTocurRoi(e,i.shiftKey)}}},[i("img",{attrs:{"data-src":"/aipath/api/files/ROI?caseid="+t.record.id+"&fileid="+t.slice.id+"&filename="+encodeURIComponent(t.slice.filename)+"&roi=[["+Math.min.apply(Math,e.path.x)+","+Math.min.apply(Math,e.path.y)+"],["+Math.max.apply(Math,e.path.x)+","+Math.max.apply(Math,e.path.y)+"]] &roiid="+e.id,alt:""}}),t._v(" "),i("span",{class:{blue:e.image},on:{click:function(i){return i.stopPropagation(),t.changeImage(e)}}})])})],2),t._v(" "),t.showTips?i("div",{staticClass:"viewpop"},[t._v("只展示置信度最高的前100个视野")]):t._e()]):i("h3",[t._v("处理结果为空～")])])]):t._e(),t._v(" "),"two"==t.auto?i("div",{staticClass:"noroi manunal"},[i("div",{staticClass:"quality-detail short"},[i("p",{class:{checked:"HSIL"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("HSIL")}}},[i("span",[t._v("HSIL")]),t._v(t._s(t.humanResult.HSIL.data.length))]),t._v(" "),i("p",{class:{checked:"滴虫"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("滴虫")}}},[i("span",[t._v("滴虫")]),t._v(t._s(t.humanResult["滴虫"].data.length))]),t._v(" "),i("p",{class:{checked:"ASC-H"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("ASC-H")}}},[i("span",[t._v("ASC-H")]),t._v(t._s(t.humanResult["ASC-H"].data.length))]),t._v(" "),i("p",{class:{checked:"霉菌"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("霉菌")}}},[i("span",[t._v("霉菌")]),t._v(t._s(t.humanResult["霉菌"].data.length))]),t._v(" "),i("p",{class:{checked:"LSIL"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("LSIL")}}},[i("span",[t._v("LSIL")]),t._v(t._s(t.humanResult.LSIL.data.length))]),t._v(" "),i("p",{class:{checked:"线索"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("线索")}}},[i("span",[t._v("线索")]),t._v(t._s(t.humanResult["线索"].data.length))]),t._v(" "),i("p",{class:{checked:"ASC-US"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("ASC-US")}}},[i("span",[t._v("ASC-US")]),t._v(t._s(t.humanResult["ASC-US"].data.length))]),t._v(" "),i("p",{class:{checked:"放线菌"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("放线菌")}}},[i("span",[t._v("放线菌")]),t._v(t._s(t.humanResult["放线菌"].data.length))]),t._v(" "),i("p",{class:{checked:"AGC"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("AGC")}}},[i("span",[t._v("AGC")]),t._v(t._s(t.humanResult.AGC.data.length))]),t._v(" "),i("p",{class:{checked:"疱疹"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("疱疹")}}},[i("span",[t._v("疱疹")]),t._v(t._s(t.humanResult["疱疹"].data.length))]),t._v(" "),i("p",{class:{checked:"无"==t.showHumanType},on:{click:function(e){return t.toogleHumanType("无")}}},[i("span",[t._v("无")]),t._v(t._s(t.humanResult["无"].data.length))])]),t._v(" "),i("v-roi",{staticClass:"checkroi",attrs:{roilist:t.humanRoilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}})],1):t._e()]),t._v(" "),"one"==t.auto&&t.aiResult.diagnosis&&t.aiResult.diagnosis.length&&!t.aiResult.aiNotCompleted?i("div",[i("div",{staticClass:"advice"},[t._v("\n                AI建议："),i("i",{style:{"font-style":"normal",color:"阴性"==t.aiResult.diagnosis[0]?"#17DE6B":"阳性"==t.aiResult.diagnosis[0]?"#F23030":"#fff"}},[t._v(t._s(t.aiResult.diagnosis[0]+" "+t.aiResult.diagnosis[1]))]),t._v(" "),i("span",{attrs:{title:t.aiResult.microbe.join(",")}},[t._v("微生物提示："+t._s(t.aiResult.microbe.join(",")))])]),t._v(" "),i("div",{staticClass:"quality"},[i("div",{staticClass:"title"},[i("span",[t._v("医生复核")]),t._v(" "),i("div",{staticClass:"accept",on:{click:t.accept}},[t._v("采纳AI建议")]),t._v(" "),i("div",{staticClass:"accept",staticStyle:{width:"45px"},on:{click:t.clearCheckReslut}},[t._v("清空")])]),t._v(" "),i("div",{staticClass:"quality-detail"},[i("div",{staticClass:"result"},[t._v("\n                        诊断结果:\n                        "),i("el-radio",{staticClass:"pos",attrs:{label:"阴性"},on:{change:function(e){return t.change(e,"diagnosis")}},model:{value:t.docResult.diagnosis,callback:function(e){t.$set(t.docResult,"diagnosis",e)},expression:"docResult.diagnosis"}},[t._v("阴性")]),t._v(" "),i("el-radio",{staticClass:"neg",attrs:{label:"阳性"},on:{change:function(e){return t.change(e,"diagnosis")}},model:{value:t.docResult.diagnosis,callback:function(e){t.$set(t.docResult,"diagnosis",e)},expression:"docResult.diagnosis"}},[t._v("阳性")]),t._v(" "),"阳性"==t.docResult.diagnosis?i("el-select",{attrs:{"popper-class":"hpf",placeholder:"请选择",multiple:"","collapse-tags":""},on:{change:function(e){return t.change(e,"tps")}},model:{value:t.docResult.tps,callback:function(e){t.$set(t.docResult,"tps",e)},expression:"docResult.tps"}},t._l(t.options,function(e){return i("el-option",{key:e,attrs:{label:e,value:e}},[i("span",{staticClass:"checkbox-icon"}),t._v(" "),i("span",{staticStyle:{"margin-left":"15px",lineHeight:"40px"}},[t._v(t._s(e))])])}),1):t._e(),t._v(" "),i("el-radio",{attrs:{label:"不确定"},on:{change:function(e){return t.change(e,"diagnosis")}},model:{value:t.docResult.diagnosis,callback:function(e){t.$set(t.docResult,"diagnosis",e)},expression:"docResult.diagnosis"}},[t._v("不确定")])],1),t._v(" "),i("div",{staticClass:"result"},[t._v("\n                        微生物提示:\n                        "),i("el-checkbox-group",{on:{change:function(e){return t.change(e,"microbe")}},model:{value:t.docResult.microbe,callback:function(e){t.$set(t.docResult,"microbe",e)},expression:"docResult.microbe"}},[i("el-checkbox",{attrs:{label:"滴虫"}}),t._v(" "),i("el-checkbox",{attrs:{label:"霉菌"}}),t._v(" "),i("el-checkbox",{attrs:{label:"线索"}}),t._v(" "),i("el-checkbox",{attrs:{label:"放线菌"}}),t._v(" "),i("el-checkbox",{attrs:{label:"疱疹"}})],1)],1),t._v(" "),i("div",{staticClass:"result"},[t._v("\n                        切片背景:\n                        "),i("el-checkbox-group",{on:{change:function(e){return t.change(e,"background")}},model:{value:t.docResult.background,callback:function(e){t.$set(t.docResult,"background",e)},expression:"docResult.background"}},[i("el-checkbox",{attrs:{label:"萎缩"}}),t._v(" "),i("el-checkbox",{attrs:{label:"炎症"}}),t._v(" "),i("el-checkbox",{attrs:{label:"修复"}})],1)],1)])])]):t._e(),t._v(" "),t.aiResult.aiNotCompleted&&"one"==t.auto&&t.showbutton?i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]):t._e(),t._v(" "),t.showbutton||"one"!=t.auto?t._e():i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:function(e){return t.canceltesk()}}},[t._v(t._s(t.$t("slice.cancelTasks")))])])])])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"title"},[e("span",[this._v("AI质控")])])}]};i("VU/8")(rt,ct,!1,function(t){i("MwPA"),i("T0JB")},"data-v-7c49d56c",null).exports;var ht={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,content:"",showMppGuide:!1,drawMpp:null}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},curROIChange(t,e){var i;t&&t.label?this.content=t.label.split(".")[0]+"%":this.content=null,t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"black"==t.color?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t})),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},roiChanged(){for(var t in this.curRois)this.curRois[t]=Object.assign({},this.curRois[t]);var e=Object.assign({},this.curRois);this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var i=e[t.id];return i?(delete e[t.id],i):t}).concat(Object.values(e))),this.slice.tct_det&&(this.slice.tct_det.result=this.slice.tct_det.result.filter(t=>!this.curRois[t.id]))},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},draw(t){t.id=(Math.random()+"").substr(2,6),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.tct_det&&(this.slice.tct_det.result=this.slice.tct_det.result.filter(t=>!e[t.id])),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"tct_det",other:""}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.slice.tct_det&&0==this.slice.tct_det.result.length){if(-1==t.data.rank)if(0==Object.keys(t.data.result).length)this.$set(this.slice.tct_det,"diagnosis","unsure");else{var e,i=t.data.result.cells&&t.data.result.cells.slice(0,30).map(t=>({id:(Math.random()+"").substr(2,8),path:{x:t.x,y:t.y},label:t.label,remark:t.label.split(".")[0]+"%"}));this.$set(this.slice.tct_det,"result",i),e=t.data.result.diagnosis.startsWith("n")?"阴性":t.data.result.diagnosis.startsWith("p")?"阳性":t.data.result.diagnosis.startsWith("u")?"不确定":"不满意",this.$set(this.slice.tct_det,"diagnosis",e)}else this.$set(this.slice.tct_det,"diagnosis","unsure");this.$set(this.slice,"type","tct_det"),this.updateRecord()}}else this.showbutton=!1,this.loopHandler=setTimeout(()=>{this.getAlgorithmResult()},5e3)})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice,"tct_det",{}),this.$set(this.slice.tct_det,"result",[]),this.$set(this.slice.tct_det,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.auto=!0,this.showbutton=!1,Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.tct_det.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"tct_det",other:""}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"tct_det",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},beforeMount(){this.slice.tct_det&&this.slice.tct_det.airesult&&!this.slice.tct_det.result&&(this.slice.tct_det.result=[],delete this.slice.tct_det.airesult)},mounted(){this.slice.started&&this.slice.tct_det&&null===this.slice.tct_det.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},ut={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright"},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.filter(function(t){return t.path}).map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})}).concat((this.slice.tct_det?this.slice.tct_det.result:[]).map(function(t){return Object.assign({},t,{id:t.id,path:t.path,color:"red",method:"rectangle",editable:!0,selectable:!1})})),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,content:t.content,showMppGuide:t.showMppGuide,cellArea:1962},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged,position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.slice.tct_det&&t.auto?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:this.slice.tct_det?this.slice.tct_det.result:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist.filter(function(t){return t.path}),currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),!this.slice.tct_det&&t.auto?i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]):t._e(),t._v(" "),t.slice.tct_det&&t.auto?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                    "+t._s(t.$t("slice.AiResult"))+"\n                ")]),t._v(" "),i("div",{class:{error:"error"==this.slice.tct_det.diagnosis}},[t._v("\n                    "+t._s({negative:"阴性",positive:"阳性",unsure:"不合格"}[t.slice.tct_det.check||t.slice.tct_det.diagnosis])+"\n                ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),i("div")]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.tct_det.computer,callback:function(e){t.$set(t.slice.tct_det,"computer",e)},expression:"slice.tct_det.computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[]};var dt=i("VU/8")(ht,ut,!1,function(t){i("dVh8"),i("fT8I")},"data-v-225d6532",null).exports,pt={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,content:"",showMppGuide:!1,drawMpp:null}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},curROIChange(t,e){var i;t&&t.label?this.content=t.label.split(".")[0]+"%":this.content=null,t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"black"==t.color?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t})),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},roiChanged(){for(var t in this.curRois)this.curRois[t]=Object.assign({},this.curRois[t]);var e=Object.assign({},this.curRois);this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var i=e[t.id];return i?(delete e[t.id],i):t}).concat(Object.values(e))),this.slice.lct_det&&(this.slice.lct_det.result=this.slice.lct_det.result.filter(t=>!this.curRois[t.id]))},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},draw(t){t.id=(Math.random()+"").substr(2,6),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.lct_det&&(this.slice.lct_det.result=this.slice.lct_det.result.filter(t=>!e[t.id])),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"lct_det",other:""}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.slice.lct_det&&0==this.slice.lct_det.result.length){if(-1==t.data.rank)if(0==Object.keys(t.data.result).length)this.$set(this.slice.lct_det,"diagnosis","U");else{var e,i=t.data.result.cells&&t.data.result.cells.slice(0,30).map(t=>({id:(Math.random()+"").substr(2,8),path:{x:t.x,y:t.y},label:t.label,remark:t.label.split(".")[0]+"%"}));this.$set(this.slice.lct_det,"result",i),e=t.data.result.diagnosis.startsWith("n")?"阴性":t.data.result.diagnosis.startsWith("p")?"阳性":t.data.result.diagnosis.startsWith("U")?"不确定":"不满意",this.$set(this.slice.lct_det,"diagnosis",e)}else this.$set(this.slice.lct_det,"diagnosis","U");this.$set(this.slice,"type","lct_det"),this.updateRecord()}}else this.showbutton=!1,this.loopHandler=setTimeout(()=>{this.getAlgorithmResult()},5e3)})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice,"lct_det",{}),this.$set(this.slice.lct_det,"result",[]),this.$set(this.slice.lct_det,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.auto=!0,this.showbutton=!1,Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.lct_det.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"lct_det",other:""}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"lct_det",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},beforeMount(){this.slice.lct_det&&this.slice.lct_det.airesult&&!this.slice.lct_det.result&&(this.slice.lct_det.result=[],delete this.slice.lct_det.airesult)},mounted(){this.slice.started&&this.slice.lct_det&&null===this.slice.lct_det.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},vt={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright"},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.filter(function(t){return t.path}).map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})}).concat((this.slice.lct_det?this.slice.lct_det.result:[]).map(function(t){return Object.assign({},t,{id:t.id,path:t.path,color:"red",method:"rectangle",editable:!0,selectable:!1})})),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,content:t.content,showMppGuide:t.showMppGuide,cellArea:1962},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged,position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.slice.lct_det&&t.auto?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:this.slice.lct_det?this.slice.lct_det.result:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist.filter(function(t){return t.path}),currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),!this.slice.lct_det&&t.auto?i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]):t._e(),t._v(" "),t.slice.lct_det&&t.auto?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                    "+t._s(t.$t("slice.AiResult"))+"\n                ")]),t._v(" "),i("div",{class:{error:"error"==this.slice.lct_det.diagnosis}},[i("input",{directives:[{name:"model",rawName:"v-model",value:t.slice.lct_det.diagnosis,expression:"slice.lct_det.diagnosis"}],attrs:{type:"text"},domProps:{value:t.slice.lct_det.diagnosis},on:{input:function(e){e.target.composing||t.$set(t.slice.lct_det,"diagnosis",e.target.value)}}})])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),i("div")]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.lct_det.computer,callback:function(e){t.$set(t.slice.lct_det,"computer",e)},expression:"slice.lct_det.computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[]};var mt=i("VU/8")(pt,vt,!1,function(t){i("ylzz"),i("q0G1")},"data-v-4fa2927a",null).exports,gt={name:"v-menus",props:["menus","currentItem","pos","newover"],data(){var t={position:{},over:this.newover};return this.pos&&"top"==this.pos.vd?t.position.top=0:this.pos&&"bottom"==this.pos.vd&&(t.position.bottom=0),this.pos&&"left"==this.pos.hd?t.position.left=0:this.pos&&"right"==this.pos.hd&&(t.position.right=0),t},methods:{mouseOver(t){this.over=t}},mounted(){},computed:{curWidth:()=>document.querySelector(".ms").clientWidth+5},components:{"v-menus":_t}},ft={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"container ms",style:t.position},t._l(t.menus,function(e,s){return i("div",{key:s,staticClass:"item",class:t.over==e.id?"active":"",on:{mouseover:function(i){return t.mouseOver(e.id)},mousedown:function(t){return t.stopPropagation(),t},click:function(i){i.stopPropagation(),!e.children&&t.$emit("chosen",[e.id,e.label])}}},[t.currentItem&&t.currentItem.split(":")[0]==e.id?i("span",{staticClass:"left",attrs:{id:t.currentItem,menuid:e.id}}):t._e(),t._v("\n        "+t._s(e.label)+"\n        "),e.id==t.over&&e.children?i("v-menus",{key:s,style:{transform:"translate("+("left"==t.pos.hd?t.curWidth+"px":-t.curWidth+"px")+",0"},attrs:{menus:e.children,newover:t.currentItem.split(":")[0],currentItem:t.currentItem&&t.currentItem.split(":")[1]+":",pos:t.pos},on:{chosen:function(i){return t.$emit("chosen",e.id+":"+i)}}}):t._e(),t._v(" "),e.children?i("span",{staticClass:"right"}):t._e()],1)}),0)},staticRenderFns:[]};var _t=i("VU/8")(gt,ft,!1,function(t){i("RiVg")},"data-v-bfc5b85a",null).exports,yt={data(){return{loopHandler:0,auto:"two",centerRegion:null,curRois:{},showbutton:!0,labeltree:[{id:"阴性",label:"阴性",children:[{id:"tct11",label:"阴性亚型不确定"},{id:"tct12",label:"鳞状上皮表层/中层细胞"},{id:"tct13",label:"基底细胞"},{id:"tct14",label:"颈管细胞"},{id:"tct15",label:"鳞状上皮化生"},{id:"tct16",label:"萎缩细胞"},{id:"tct17",label:"修复细胞"},{id:"tct18",label:"炎症细胞"},{id:"tct19",label:"其他非肿瘤细胞变化"},{id:"tct110",label:"子宫内膜细胞"},{id:"tct111",label:"异物"},{id:"tct112",label:"裸核"},{id:"tct113",label:"有丝分裂"},{id:"tct114",label:"角化细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"阳性",label:"阳性",children:[{id:"tct21",label:"阳性亚型不确定"},{id:"tct22",label:"ASCUS"},{id:"tct23",label:"ASC-H"},{id:"tct24",label:"LSIL"},{id:"tct25",label:"HSIL"},{id:"tct26",label:"SCC"},{id:"tct27",label:"AIS"},{id:"tct28",label:"非典型腺细胞"},{id:"tct29",label:"非典型子宫颈管细胞-倾向于肿瘤"},{id:"tct230",label:"非典型子宫颈管细胞-非特异"},{id:"tct231",label:"非典型子宫内膜细胞"},{id:"tct232",label:"腺癌"},{id:"tct233",label:"其他恶性肿瘤细胞"},{id:"tct234",label:"裸核"},{id:"tct235",label:"有丝分裂"},{id:"tct236",label:"角化细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"微生物",label:"微生物",children:[{id:"tct31",label:"微生物亚型不确定"},{id:"tct32",label:"毛滴虫"},{id:"tct33",label:"霉菌"},{id:"tct34",label:"线索细胞"},{id:"tct35",label:"放线菌"},{id:"tct36",label:"疱疹"},{id:"tct37",label:"巨细胞病毒"}].map(t=>({id:t.id,label:t.label}))},{id:"不确定",label:"不确定"}],tctAnno:null,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,addAnnRoi:!1,RoiWidth:null,PatchWidth:null,pathseg:!0,getroi:!0,showMppGuide:!1,drawMpp:null}},computed:{getCommonAnnotation(){var t=Object.values(this.curRois);return t[0]&&t.every(t=>t.jgResult)&&t.every(e=>e.jgResult==t[0].jgResult)?t[0].jgResult.split(",")[0]:""}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},mouseDown(){this.tctAnno=null},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>({[t.id]:t})))},clickDraw(t,e){var i=320,s=t.x,a=t.y,n={id:(Math.random()+"").substr(2,9),path:{x:[s-i,s+i,s+i,s-i],y:[a-i,a-i,a+i,a+i]},width:2,method:"rectangle"};this.slice.roilist=[...this.slice.roilist,n],this.curROIChange(n,e)},draw(t,e){t.id=(Math.random()+"").substr(2,9),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.tct&&(this.slice.tct.result=this.slice.tct.result.filter(t=>!e[t.id])),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id]),this.tctAnno=null},roiChanged(){for(var t in this.curRois)this.curRois[t]=Object.assign({},this.curRois[t]);var e=Object.assign({},this.curRois);this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var i=e[t.id];return i?(delete e[t.id],i):t}).concat(Object.values(e))),this.slice.tct&&(this.slice.tct.result=this.slice.tct.result.filter(t=>!this.curRois[t.id]))},setAnnotation(t){var e;for(var i in e="string"!=typeof t?t[0]+","+t[1]:t,this.tctAnno=null,this.curRois){let t=this.curRois[i];this.curRois[i]=Object.assign({},t,{jgResult:e,remark:e.split(",")[e.split(",").length-1]})}var s=Object.assign({},this.curRois);this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var e=s[t.id];return e?(delete s[t.id],e):t}).concat(Object.values(s))),this.slice.tct&&(this.slice.tct.result=this.slice.tct.result.filter(t=>!this.curRois[t.id]))},showMenu(t,e){if((!t.type||t.button)&&(this.showleft=!1,this.showtcttop=!1,t.preventDefault(),0!=Object.keys(this.curRois).length&&!Object.keys(this.curRois).every(t=>t!=e.id))){var i=t.currentTarget;t.offsetX,t.offsetY,i.offsetWidth,i.offsetHeight;this.tctAnno={}}},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"tct",other:""}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.slice.tct&&0==this.slice.tct.result.length){if(-1==t.data.rank)if(0==Object.keys(t.data.result).length)this.$set(this.slice.tct,"diagnosis","unsure");else{var e,i=t.data.result.cells&&t.data.result.cells.slice(0,100).map(t=>({id:(Math.random()+"").substr(2,6),editable:!1,path:{x:t.contourPoints.slice(0,-1).map(t=>t[0]),y:t.contourPoints.slice(0,-1).map(t=>t[1])}}));this.$set(this.slice.tct,"result",i),e=t.data.result.diagnosis.startsWith("n")?"阴性":t.data.result.diagnosis.startsWith("p")?"阳性":t.data.result.diagnosis.startsWith("u")?"不确定":"不满意",this.$set(this.slice.tct,"diagnosis",e)}else this.$set(this.slice.tct,"diagnosis","unsure");this.$set(this.slice,"type","tct"),this.updateRecord()}}else this.showbutton=!1,this.loopHandler=setTimeout(()=>{this.getAlgorithmResult()},5e3)})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice,"tct",{}),this.$set(this.slice.tct,"result",[]),this.slice.started=!0,this.record.started=!0,this.$set(this.slice.tct,"diagnosis",null),this.showbutton=!1,Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.tct.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"tct",other:""}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"tct",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()},PathSeg(){this.pathseg=!1,Object(s.b)("script/cutwsi",{caseid:this.record.id,fileid:this.slice.id,filename:this.slice.filename,size:this.PatchWidth||1024}).then(t=>{console.log(t)}).catch(t=>{console.log(t)})},GetRoi(){this.getroi=!1,Object(s.b)("script/extractAnnots",{caseid:this.record.id,fileid:this.slice.id,filename:this.slice.filename,size:this.RoiWidth||1024}).then(t=>{console.log(t)}).catch(t=>{console.log(t)})}},mounted(){this.slice.started&&this.slice.tct&&null===this.slice.tct.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},"slice.roilist":{handler(t){t.length>300&&(this.addAnnRoi=!0,setTimeout(()=>this.addAnnRoi=!1,2500),Object.values(this.curRois).map(t=>delete this.curRois[t.id]),t.pop())}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},props:["slice","record","showBatch"],components:{"v-menus":_t,"v-dragon":v.a,"v-roi":f}},bt={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",staticStyle:{width:"100%"}},[i("div",{ref:"osd",staticClass:"analyright",attrs:{tabIndex:0},on:{mousewheel:function(e){t.tctAnno=null},keydown:t.keydown}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})}).concat((this.slice.tct?this.slice.tct.result:[]).map(function(t){return Object.assign({},t,{color:"red",method:"rectangle",editable:!0})})),penColor:"yellow",curRois:t.curRois,centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:1962},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},contextmenu:function(e,i){return t.showMenu(e,i)},roiChanged:t.roiChanged,clickDraw:t.clickDraw,mousedown:t.mouseDown,position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}},[t.tctAnno?i("div",{staticStyle:{position:"absolute",right:"210px",top:"0px",bottom:"calc(100% - 144px)"}},[i("v-menus",{attrs:{pos:t.tctAnno,menus:t.labeltree,currentItem:t.getCommonAnnotation},on:{chosen:t.setAnnotation}})],1):t._e(),t._v(" "),t.addAnnRoi?i("div",{staticClass:"addannroi"},[t._v("标注roi数量不能超出300个")]):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist",on:{click:function(e){t.tctAnno=null}}},[i("h2",[i("span",{class:"one"==t.auto?"auto":"",on:{click:function(e){t.auto="one"}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:"two"==t.auto?"auto":"",on:{click:function(e){t.auto="two"}}},[t._v(t._s(t.$t("analyze.roi")))]),t._v(" "),t.showBatch?i("span",{class:"three"==t.auto?"auto":"",on:{click:function(e){t.auto="three"}}},[t._v("标注工具")]):t._e()]),t._v(" "),this.slice.tct&&"one"==t.auto?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:this.slice.tct?this.slice.tct.result:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},closecontextmenu:function(e){t.tctAnno=null}}}):t._e(),t._v(" "),"two"==t.auto?i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},closecontextmenu:function(e){t.tctAnno=null}}}):t._e(),t._v(" "),t.showbutton||"one"!=t.auto?t._e():i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]),t._v(" "),this.slice.tct||"one"!=t.auto?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),"three"==t.auto?i("div",{staticClass:"showbatch"},[i("div",{staticClass:"input"},[i("div",[i("input",{directives:[{name:"model",rawName:"v-model",value:t.PatchWidth,expression:"PatchWidth"}],attrs:{type:"text",placeholder:"Patch分割边长"},domProps:{value:t.PatchWidth},on:{input:[function(e){e.target.composing||(t.PatchWidth=e.target.value)},function(e){t.PatchWidth=t.PatchWidth.replace(/[^\d]/g,"")&&parseInt(t.PatchWidth.replace(/[^\d]/g,""))}]}}),t._v(" "),i("span",[t._v("px")])]),t._v(" "),t.pathseg?i("span",{class:{pathseg:t.pathseg},on:{click:function(e){return t.PathSeg()}}},[t._v("Patch分割")]):i("span",{class:{pathseging:!t.pathseg}},[t._v("分割中...")])]),t._v(" "),i("div",{staticClass:"input"},[i("div",[i("input",{directives:[{name:"model",rawName:"v-model",value:t.RoiWidth,expression:"RoiWidth"}],attrs:{type:"text",placeholder:"ROI提取边长"},domProps:{value:t.RoiWidth},on:{input:[function(e){e.target.composing||(t.RoiWidth=e.target.value)},function(e){t.RoiWidth=t.RoiWidth.replace(/[^\d]/g,"")&&parseInt(t.RoiWidth.replace(/[^\d]/g,""))}]}}),t._v(" "),i("span",[t._v("px")])]),t._v(" "),t.getroi?i("span",{class:{getroi:t.getroi},on:{click:function(e){return t.GetRoi()}}},[t._v("ROI提取")]):i("span",{class:{getroiing:!t.getroi}},[t._v("提取中...")])]),t._v(" "),i("div",[i("a",{attrs:{href:"/aipath/api/script/getSummary?caseid="+t.record.id+"&id="+(Math.random()+"").substr(2,8)}},[t._v("统计当前病例")]),t._v(" "),i("a",{attrs:{href:"/aipath/api/script/getSummary?caseid=all&id="+(Math.random()+"").substr(2,8)}},[t._v("统计全部病例")])])]):t._e(),t._v(" "),this.slice.tct&&"one"==t.auto?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                    "+t._s(t.$t("slice.AiResult"))+"\n                ")]),t._v(" "),i("div",{class:{error:"error"==this.slice.tct.diagnosis}},[t._v("\n                    "+t._s({negative:"阴性",positive:"阳性",unsure:"不合格"}[t.slice.tct.check||t.slice.tct.diagnosis])+"\n                ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),t._m(0)]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.tct.computer,callback:function(e){t.$set(t.slice.tct,"computer",e)},expression:"slice.tct.computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),"two"==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)}}})]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",[e("div",[this._v("100%")])])}]};var Rt=i("VU/8")(yt,bt,!1,function(t){i("O32g"),i("fwhK")},"data-v-09b53c29",null).exports,Ct={name:"v-menus",props:["menus","currentItem","pos"],data(){var t={position:{},over:""};return"top"==this.pos.vd?t.position.top=0:t.position.bottom=0,"left"==this.pos.hd?t.position.left=0:t.position.right=0,t},methods:{mouseOver(t){this.over=t}},components:{"v-menus":kt}},wt={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"container",style:t.position},t._l(t.menus,function(e,s){return i("div",{key:s,staticClass:"item",class:{left:t.currentItem&&t.currentItem.split(":")[0]==e.id,nochildren:!e.children},on:{mousedown:function(t){return t.stopPropagation(),t},click:function(i){i.stopPropagation(),!e.children&&t.$emit("chosen",[e.id,e.label])}}},[t._v("\n        "+t._s(e.label)+"\n        "),t._l(e.children,function(e,s){return i("div",{key:s,class:t.over==e.id?"active":"",on:{mouseover:function(i){return t.mouseOver(e.id)},mousedown:function(t){return t.stopPropagation(),t},click:function(i){i.stopPropagation(),!e.children&&t.$emit("chosen",[e.id,e.label])}}},[i("span",{staticClass:"choose",class:{left:t.currentItem&&t.currentItem.split(":")[0]==e.id}}),t._v(" "),i("p",[t._v(t._s(e.label))]),t._v(" "),e.children?i("span",{staticClass:"more"}):t._e(),t._v(" "),e.id==t.over&&e.children?i("v-menus",{key:s,staticClass:"secondlevel",style:{transform:"translate("+("left"==t.pos.hd?"100%":"-100%")+",0",top:"",bottom:""},attrs:{pos:t.pos,menus:e.children,currentItem:t.currentItem&&t.currentItem.split(":").slice(1).join(":")},on:{chosen:function(i){return t.$emit("chosen",e.id+":"+i)}}}):t._e()],1)})],2)}),0)},staticRenderFns:[]};var kt=i("VU/8")(Ct,wt,!1,function(t){i("xVoh")},"data-v-991799bc",null).exports,xt={data(){return{loopHandler:0,auto:"two",centerRegion:null,curRois:{},showbutton:!0,labeltree:[{id:"NILM",label:"",children:[{id:"不确定",label:"不确定"},{id:"鳞状上皮细胞",label:"鳞状上皮细胞",children:[{id:"成熟性",label:"成熟性",children:[{id:"成熟性单细胞",label:"单细胞"},{id:"成熟性团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"不成熟",label:"不成熟",children:[{id:"不成熟单细胞",label:"单细胞"},{id:"不成熟团细胞",label:"团细胞"},{id:"不成熟萎缩反应性改变",label:"萎缩反应性改变"}].map(t=>({id:t.id,label:t.label}))},{id:"伴炎症反应性改变",label:"伴炎症反应性改变",children:[{id:"伴炎症反应性改变单细胞",label:"单细胞"},{id:"伴炎症反应性改变团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"正常角化或过度角化",label:"正常角化或过度角化",children:[{id:"正常角化",label:"正常角化",children:[{id:"正常角化单细胞",label:"单细胞"},{id:"正常角化团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"过度角化",label:"过度角化",children:[{id:"过度角化单细胞",label:"单细胞"},{id:"过度角化团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))}]},{id:"伴其他反应性改变",label:"伴其他反应性改变",children:[{id:"伴其他反应性改变单细胞",label:"单细胞"},{id:"伴其他反应性改变团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))}]},{id:"鳞状化生细胞",label:"鳞状化生细胞",children:[{id:"成熟型",label:"成熟型",children:[{id:"成熟型单细胞",label:"单细胞"},{id:"成熟型团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"非成熟型",label:"非成熟型",children:[{id:"非成熟型单细胞",label:"单细胞"},{id:"非成熟型团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))}]},{id:"修复细胞",label:"修复细胞",children:[{id:"修复细胞单细胞",label:"单细胞"},{id:"修复细胞团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"炎症细胞",label:"炎症细胞",children:[{id:"中心粒细胞",label:"中心粒细胞",children:[{id:"中心粒细胞单细胞",label:"单细胞"},{id:"中心粒细胞团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"淋巴细胞",label:"淋巴细胞",children:[{id:"淋巴细胞单细胞",label:"单细胞"},{id:"淋巴细胞团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))}]},{id:"颈管柱状上皮细胞",label:"颈管柱状上皮细胞",children:[{id:"正常",label:"正常",children:[{id:"正常单细胞",label:"单细胞"},{id:"正常团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"伴炎症反应",label:"伴炎症反应",children:[{id:"伴炎症反应单细胞",label:"单细胞"},{id:"伴炎症反应 团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))}]},{id:"子宫内膜细胞",label:"子宫内膜细胞",children:[{id:"<45y",label:"<45y",children:[{id:"<45y单细胞",label:"单细胞"},{id:"<45y团细胞",label:"团细胞"},{id:"<45y子宫下段和直接采样",label:"子宫下段和直接采样"},{id:"<45y宫内节育器",label:"宫内节育器"}].map(t=>({id:t.id,label:t.label}))},{id:">45y",label:">45y",children:[{id:">45y单细胞",label:"单细胞"},{id:">45y团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))}]},{id:"输卵管上皮化生",label:"输卵管上皮化生",children:[{id:"输卵管上皮化生单细胞",label:"单细胞"},{id:"输卵管上皮化生团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"不能分型腺上皮细胞",label:"不能分型腺上皮细胞",children:[{id:"不能分型腺上皮细胞单细胞",label:"单细胞"},{id:"不能分型腺上皮细胞团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"裸核",label:"裸核",children:[{id:"裸核单细胞",label:"单细胞"},{id:"裸核团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"特异性感染",label:"特异性感染",children:[{id:"滴虫",label:"滴虫",children:[{id:"滴虫单细胞",label:"单细胞"},{id:"滴虫团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"真菌",label:"真菌"},{id:"放线菌",label:"放线菌"},{id:"疱疹",label:"疱疹"},{id:"巨细胞病毒",label:"巨细胞病毒"},{id:"线索细胞",label:"线索细胞"}]},{id:"不能分型细胞团",label:"不能分型细胞团"},{id:"细胞碎片或非细胞成分",label:"细胞碎片或非细胞成分"}]},{id:"上皮细胞异常",label:"",children:[{id:"ASCUS",label:"ASCUS",children:[{id:"角化不良",label:"角化不良",children:[{id:"角化不良单细胞",label:"单细胞"},{id:"角化不良团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"不典型成熟化生",label:"不典型成熟化生",children:[{id:"不典型成熟化生单细胞",label:"单细胞"},{id:"不典型成熟化生团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"其他1",label:"其他",children:[{id:"其他单细胞",label:"单细胞"},{id:"其他团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))}]},{id:"ASC-H",label:"AS-CH",children:[{id:"不典型不成熟化生",label:"不典型不成熟化生",children:[{id:"不典型不成熟化生单细胞",label:"单细胞"},{id:"不典型不成熟化生团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"密集细胞团",label:"密集细胞团"},{id:"其他2",label:"其他",children:[{id:"其他单细胞",label:"单细胞"},{id:"其他团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))}]},{id:"LSIL",label:"LSIL",children:[{id:"HPV",label:"HPV",children:[{id:"HPV单细胞",label:"单细胞"},{id:"HPV团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"CIN1",label:"CIN1",children:[{id:"CIN1单细胞",label:"单细胞"},{id:"CIN1团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"HPV+CIN1",label:"HPV+CIN1",children:[{id:"HPV+CIN1单细胞",label:"单细胞"},{id:"HPV+CIN1团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))}]},{id:"HSIL",label:"HSIL",children:[{id:"HSIL单细胞",label:"单细胞"},{id:"HSIL团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"SCC",label:"SCC",children:[{id:"SCC单细胞",label:"单细胞"},{id:"SCC团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"HSIL不除外SCC",label:"HSIL不除外SCC",children:[{id:"HSIL不除外SCC单细胞",label:"单细胞"},{id:"HSIL不除外SCC团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"AGC-NOS",label:"AGC-NOS",children:[{id:"颈管",label:"颈管",children:[{id:"颈管单细胞",label:"单细胞"},{id:"颈管团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"内膜",label:"内膜",children:[{id:"内膜单细胞",label:"单细胞"},{id:"内膜团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"不能明确部位",label:"不能明确部位",children:[{id:"不能明确部位单细胞",label:"单细胞"},{id:"不能明确部位团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))}]},{id:"AGC-N及以上",label:"AGC-N及以上",children:[{id:"AGC-N或AIS",label:"AGC-N或AIS"},{id:"腺癌",label:"腺癌",children:[{id:"颈管腺癌",label:"颈管",children:[{id:"颈管腺癌单细胞",label:"单细胞"},{id:"颈管腺癌团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"内膜腺癌",label:"内膜",children:[{id:"内膜腺癌单细胞",label:"单细胞"},{id:"内膜腺癌团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))},{id:"不能明确部位腺癌",label:"不能明确部位",children:[{id:"不能明确部位腺癌单细胞",label:"单细胞"},{id:"不能明确部位腺癌团细胞",label:"团细胞"}].map(t=>({id:t.id,label:t.label}))}]},{id:"转移性腺癌",label:"转移性腺癌"}]},{id:"上皮细胞异常不能分型",label:"不能分型",children:[{id:"低级别或低风险",label:"低级别或低风险"},{id:"高级别或以上",label:"高级别或以上"},{id:"阳性背景",label:"阳性背景"}]}]}],tctAnno:null,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,addAnnRoi:!1,RoiWidth:null,PatchWidth:null,pathseg:!0,getroi:!0,showMppGuide:!1,drawMpp:null}},computed:{getCommonAnnotation(){var t=Object.values(this.curRois);return t[0]&&t.every(t=>t.jgResult)&&t.every(e=>e.jgResult==t[0].jgResult)?t[0].jgResult.split(",")[0]:""}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"black"==t.color?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t}))},clickDraw(t,e){var i=320,s=t.x,a=t.y,n={id:(Math.random()+"").substr(2,9),path:{x:[s-i,s+i,s+i,s-i],y:[a-i,a-i,a+i,a+i]},width:2,method:"rectangle"};this.slice.roilist=[...this.slice.roilist,n],this.curROIChange(n,e)},draw(t,e){t.id=(Math.random()+"").substr(2,9),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.lct_det&&(this.slice.lct_det.result=this.slice.lct_det.result.filter(t=>!e[t.id])),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id]),this.tctAnno=null},roiChanged(){for(var t in this.curRois)this.curRois[t]=Object.assign({},this.curRois[t]);var e=Object.assign({},this.curRois);this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var i=e[t.id];return i?(delete e[t.id],i):t}).concat(Object.values(e))),this.slice.lct_det&&(this.slice.lct_det.result=this.slice.lct_det.result.filter(t=>!this.curRois[t.id]))},setAnnotation(t){var e;for(var i in e="string"!=typeof t[0]?t[0][0]+","+t[0][1]:t[0],this.curRois){let t=this.curRois[i];this.curRois[i]=Object.assign({},t,{jgResult:e,remark:e.split(",")[0].split(":")[0]})}var s=Object.assign({},this.curRois);this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var e=s[t.id];return e?(delete s[t.id],e):t}).concat(Object.values(s))),this.slice.lct_det&&(this.slice.lct_det.result=this.slice.lct_det.result.filter(t=>!this.curRois[t.id])),this.tctAnno=null},showMenu(t,e){if((!t.type||t.button)&&(this.showleft=!1,this.showtop=!1,t.preventDefault(),0!=Object.keys(this.curRois).length&&!Object.keys(this.curRois).every(t=>t!=e.id))){var i=t.currentTarget;t.offsetX,t.offsetY,i.offsetWidth,i.offsetHeight;this.tctAnno={}}},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"lct_det",other:""}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.slice.lct_det&&0==this.slice.lct_det.result.length){if(-1==t.data.rank){var e,i=t.data.result.cells&&t.data.result.cells.map(t=>({id:(Math.random()+"").substr(2,8),path:{x:t.x,y:t.y},label:t.label}));this.$set(this.slice.lct_det,"result",i),e=t.data.result.diagnosis.startsWith("n")?"阴性":t.data.result.diagnosis.startsWith("p")?"阳性":t.data.result.diagnosis.startsWith("u")?"不确定":"不满意",this.$set(this.slice.lct_det,"diagnosis",e)}else this.$set(this.slice.lct_det,"diagnosis","unsure");this.$set(this.slice,"type","lct_det"),this.updateRecord()}}else this.showbutton=!1,this.loopHandler=setTimeout(()=>{this.getAlgorithmResult()},5e3)})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice,"lct_det",{}),this.$set(this.slice.lct_det,"result",[]),this.$set(this.slice.lct_det,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.lct_det.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"lct_det",other:""}).then(t=>{this.getAlgorithmResult(),this.slice.lct_det.taskid=t.data.task_id}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"lct_det",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()},PathSeg(){this.pathseg=!1,Object(s.b)("script/cutwsi",{caseid:this.record.id,fileid:this.slice.id,filename:this.slice.filename,size:this.PatchWidth||1024}).then(t=>{console.log(t)}).catch(t=>{console.log(t)})},GetRoi(){this.getroi=!1,Object(s.b)("script/extractAnnots",{caseid:this.record.id,fileid:this.slice.id,filename:this.slice.filename,size:this.RoiWidth||1024}).then(t=>{console.log(t)}).catch(t=>{console.log(t)})}},beforeMount(){this.slice.lct_det&&this.slice.lct_det.airesult&&!this.slice.lct_det.result&&(this.slice.lct_det.result=[],delete this.slice.lct_det.airesult)},mounted(){this.slice.started&&this.slice.lct_det&&null===this.slice.lct_det.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},updated(){if(this.slice.roilist.map(t=>t.remark).filter(t=>!!t).some(t=>"?"==t||"？"==t||"不确定"==t||"输卵管上皮化生"==t||"不能分型腺上皮细胞"==t)){if(""==this.slice.name.split("zk-")[0])return;this.$set(this.slice,"name","zk-"+this.slice.name)}else{if(""!=this.slice.name.split("zk-")[0])return;this.$set(this.slice,"name",this.slice.name.split("zk-")[1])}},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},"slice.roilist":{handler(t){t.length>300&&(this.addAnnRoi=!0,setTimeout(()=>this.addAnnRoi=!1,2500),Object.values(this.curRois).map(t=>delete this.curRois[t.id]),t.pop())}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},props:["slice","record","showBatch"],components:{"v-menus":kt,"v-dragon":v.a,"v-roi":f}},$t={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",staticStyle:{width:"100%"},attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright",on:{mousewheel:function(e){t.tctAnno=null}}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.filter(function(t){return t.path}).map(function(t){return Object.assign({method:"rectangle"},t,{color:{"不确定":"purple","输卵管上皮化生":"purple","不能分型腺上皮细胞":"purple","?":"purple","？":"purple"}[t.remark]})}).concat((this.slice.lct_det?this.slice.lct_det.result:[]).map(function(t){return Object.assign({},t,{id:t.id,path:t.path,color:"red",method:"rectangle",editable:!0,selectable:!1})})),penColor:"yellow",curRois:t.curRois,centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:1962},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},contextmenu:function(e,i){return t.showMenu(e,i)},roiChanged:t.roiChanged,clickDraw:t.clickDraw,mousedown:function(e){t.tctAnno=null},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}},[t.tctAnno?i("div",{staticStyle:{position:"absolute",right:"0",top:"0px",bottom:"calc(100% - 550px)"}},[i("v-menus",{attrs:{pos:t.tctAnno,menus:t.labeltree,currentItem:t.getCommonAnnotation},on:{chosen:function(e){return t.setAnnotation(arguments)}}})],1):t._e(),t._v(" "),t.addAnnRoi?i("div",{staticClass:"addannroi"},[t._v("标注roi数量不能超出300个")]):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist",on:{click:function(e){t.tctAnno=null}}},[i("h2",[i("span",{class:"one"==t.auto?"auto":"",on:{click:function(e){t.auto="one"}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:"two"==t.auto?"auto":"",on:{click:function(e){t.auto="two"}}},[t._v(t._s(t.$t("analyze.roi")))]),t._v(" "),t.showBatch?i("span",{class:"three"==t.auto?"auto":"",on:{click:function(e){t.auto="three"}}},[t._v("标注工具")]):t._e()]),t._v(" "),"one"==t.auto&&this.slice.lct_det?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:this.slice.lct_det?this.slice.lct_det.result:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},closecontextmenu:function(e){t.tctAnno=null}}}):t._e(),t._v(" "),"two"==t.auto?i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist.filter(function(t){return t.path}),currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},closecontextmenu:function(e){t.tctAnno=null}}}):t._e(),t._v(" "),t.showbutton||"one"!=t.auto?t._e():i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]),t._v(" "),this.slice.lct_det||"one"!=t.auto?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),this.slice.lct_det&&"one"==t.auto?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                    "+t._s(t.$t("slice.AiResult"))+"\n                ")]),t._v(" "),i("div",{class:{error:"error"==this.slice.lct_det.diagnosis}},[t._v("\n                    "+t._s({negative:"阴性",positive:"阳性",unsure:"不合格"}[t.slice.lct_det.check||t.slice.lct_det.diagnosis])+"\n                ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),t._m(0)]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.lct_det.computer,callback:function(e){t.$set(t.slice.lct_det,"computer",e)},expression:"slice.lct_det.computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),"three"==t.auto?i("div",{staticClass:"showbatch"},[i("div",{staticClass:"input"},[i("div",[i("input",{directives:[{name:"model",rawName:"v-model",value:t.PatchWidth,expression:"PatchWidth"}],attrs:{type:"text",placeholder:"Patch分割边长"},domProps:{value:t.PatchWidth},on:{input:[function(e){e.target.composing||(t.PatchWidth=e.target.value)},function(e){t.PatchWidth=t.PatchWidth.replace(/[^\d]/g,"")&&parseInt(t.PatchWidth.replace(/[^\d]/g,""))}]}}),t._v(" "),i("span",[t._v("px")])]),t._v(" "),t.pathseg?i("span",{class:{pathseg:t.pathseg},on:{click:function(e){return t.PathSeg()}}},[t._v("Patch分割")]):i("span",{class:{pathseging:!t.pathseg}},[t._v("分割中...")])]),t._v(" "),i("div",{staticClass:"input"},[i("div",[i("input",{directives:[{name:"model",rawName:"v-model",value:t.RoiWidth,expression:"RoiWidth"}],attrs:{type:"text",placeholder:"ROI提取边长"},domProps:{value:t.RoiWidth},on:{input:[function(e){e.target.composing||(t.RoiWidth=e.target.value)},function(e){t.RoiWidth=t.RoiWidth.replace(/[^\d]/g,"")&&parseInt(t.RoiWidth.replace(/[^\d]/g,""))}]}}),t._v(" "),i("span",[t._v("px")])]),t._v(" "),t.getroi?i("span",{class:{getroi:t.getroi},on:{click:function(e){return t.GetRoi()}}},[t._v("ROI提取")]):i("span",{class:{getroiing:!t.getroi}},[t._v("提取中...")])]),t._v(" "),i("div",[i("a",{attrs:{href:"/aipath/api/script/getSummary?caseid="+t.record.id+"&id="+(Math.random()+"").substr(2,8)}},[t._v("统计当前病例")]),t._v(" "),i("a",{attrs:{href:"/aipath/api/script/getSummary?caseid=all&id="+(Math.random()+"").substr(2,8)}},[t._v("统计全部病例")])])]):t._e(),t._v(" "),"two"==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)}}})]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",[e("div",[this._v("100%")])])}]};var It=i("VU/8")(xt,$t,!1,function(t){i("ufj2"),i("5C63")},"data-v-5cd0d7cd",null).exports,Ot={data(){return{checkResult:this.slice.alg===this.slice.toolType&&this.slice.check_result.slice(0,this.slice.check_result.length-1)||null}},methods:{changeResult(t){this.checkResult=t,this.$emit("acceptAI",t)},changeImage(t){this.$set(t,"image",1-(t.image||0)),this.$emit("roiChanged","image",[t])},checkall(){if(!this.ROIS.length)return;let t=this.ROIS.every(t=>!!t.image),e=this.ROIS.map(e=>{return{id:e.id,image:t?0:1}});this.$emit("roiChanged","image",e)},del(t){this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})}},props:["ROIS","currentRois","slice","ave"]},St={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"ki67arearois"},[t.ROIS?i("div",{staticClass:"table"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:t.ROIS.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                    ROI\n                ")])]),t._v(" "),i("div",[t._v("阳性肿瘤")]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.total")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.index")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.deleted")))])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.ROIS,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){t.$emit("curROI",e,i.shiftKey),t.$emit("closecontextmenu")}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){return i.stopPropagation(),t.changeImage(e)}}}),t._v("\n                        "+t._s(s+1)+"\n                    ")])]),t._v(" "),i("div",[t._v(t._s(e.aiResult.pos_tumor))]),t._v(" "),i("div",[t._v(t._s(e.aiResult.total))]),t._v(" "),i("div",[t._v(t._s((100*e.aiResult.index).toFixed(2)+"%"))]),t._v(" "),i("div",[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])])}),0)]):t._e(),t._v(" "),t.ROIS?i("div",{staticClass:"areabtm"},[i("div",{staticClass:"result",staticStyle:{color:"red"}},[i("div",[t._v("\n                阳性肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.pos_tumor}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result",staticStyle:{color:"green"}},[i("div",[t._v("\n                阴性肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.neg_tumor}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result",staticStyle:{color:"#C280FF"}},[i("div",[t._v("\n                非肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.normal_cell}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result"},[i("div",[t._v("\n                综合指数\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ave)+"%\n            ")])])]):t._e(),t._v(" "),i("div",{staticClass:"recheck"},[i("div",{staticClass:"doc-check"},[i("i",[t._v("医生复核")]),t._v(" "),i("span",{on:{click:function(e){return t.changeResult("")}}},[t._v("清空")]),t._v(" "),i("span",{on:{click:function(e){return t.changeResult(t.ave)}}},[t._v("采纳AI建议")])]),t._v(" "),i("div",{staticClass:"check-result"},[t._v("指数"),i("input",{directives:[{name:"model",rawName:"v-model",value:t.checkResult,expression:"checkResult"}],domProps:{value:t.checkResult},on:{blur:function(e){return t.changeResult(t.checkResult)},input:function(e){e.target.composing||(t.checkResult=e.target.value)}}}),t._v("%")])])])},staticRenderFns:[]};var At=i("VU/8")(Ot,St,!1,function(t){i("7NZ2"),i("vI3O")},null,null).exports,Tt={data:()=>({roiTypeOpitions:{0:"green",1:"red",2:"#C280FF"},defaultColor:"red",defaultType:1,labeltree:[{id:1,label:"阳性肿瘤"},{id:0,label:"阴性肿瘤"},{id:2,label:"非肿瘤"}]}),computed:{ave(){return(this.aiFatherRois.filter(t=>t.image).map(t=>t.aiResult.pos_tumor).reduce((t,e)=>t+e,0)/(this.aiFatherRois.filter(t=>t.image).map(t=>t.aiResult.total).reduce((t,e)=>t+e,0)||1)*100).toFixed(2)}},props:["slice","record"],components:{"v-dragon":v.a,"v-analyroi":At,"v-roi":f,"v-menus":X},mixins:[U]},Mt={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright",on:{mousewheel:function(e){t.ki67Anno=null},mousedown:function(e){t.ki67Anno=null}}},[i("v-dragon",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"osd",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:t.leftRoilist,curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:110,"element-loading-text":"处理中，请耐心等待","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.5)"},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},clickDraw:t.clickDraw,getRoi:function(e){return t.getRoi(e)},roiChanged:t.roiChanged,parentId:function(e){return t.parentId=e},contextmenu:function(e,i){return t.showMenu(e,i)}}},[t.ki67Anno?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+"px",top:t.menuPosition.y+"px"}},[i("v-menus",{attrs:{pos:t.ki67Anno,menus:t.labeltree,currentItem:t.currentItem,newover:t.newover},on:{chosen:function(e){return t.setAnnotation(e)}}})],1):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("div",{staticClass:"quality"},[t._m(0),t._v(" "),i("div",{staticClass:"quality-detail"},[i("p",[t._v("清 晰 度："+t._s(t.slice.clarity?(100*t.slice.clarity).toFixed(2)+"%":"-"))]),t._v(" "),i("p",[t._v("扫描倍数："+t._s(t.slice.objective_rate||"-"))])])]),t._v(" "),i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v("AI处理")]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v("手动处理")])]),t._v(" "),t.auto?i("v-analyroi",{staticClass:"table",attrs:{slice:t.slice,ROIS:t.aiFatherRois,ave:t.ave,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged,acceptAI:function(e){return t.reCheck(e?e+"%":"")},closecontextmenu:function(e){t.ki67Anno=null}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.rightRoilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"title"},[e("span",[this._v("AI质控")])])}]};var jt=i("VU/8")(Tt,Mt,!1,function(t){i("+EpN")},"data-v-56b6e3b7",null).exports,Ft={data(){return{checkResult:this.slice.alg===this.slice.toolType&&this.slice.check_result.slice(0,this.slice.check_result.length-1)||null}},methods:{changeResult(t){this.checkResult=t,this.$emit("acceptAI",t)},changeImage(t){this.$set(t,"image",1-(t.image||0)),this.$emit("roiChanged","image",[t])},checkall(){if(!this.ROIS.length)return;let t=this.ROIS.every(t=>!!t.image),e=this.ROIS.map(e=>{return{id:e.id,image:t?0:1}});this.$emit("roiChanged","image",e)},del(t){this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})}},props:["ROIS","currentRois","slice","ave"]},Pt={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"ki67hotrois"},[t.ROIS?i("div",{staticClass:"table"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:t.ROIS.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                    ROI\n                ")])]),t._v(" "),i("div",[t._v("阳性肿瘤")]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.total")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.index")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.deleted")))])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.ROIS,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){t.$emit("curROI",e,i.shiftKey),t.$emit("closecontextmenu")}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){return i.stopPropagation(),t.changeImage(e)}}}),t._v("\n                        "+t._s(s+1)+"\n                    ")])]),t._v(" "),i("div",[t._v(t._s(e.aiResult.pos_tumor))]),t._v(" "),i("div",[t._v(t._s(e.aiResult.total))]),t._v(" "),i("div",[t._v(t._s((100*e.aiResult.index).toFixed(2)+"%"))]),t._v(" "),i("div",[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])])}),0)]):t._e(),t._v(" "),t.ROIS?i("div",{staticClass:"areabtm"},[i("div",{staticClass:"result",staticStyle:{color:"red"}},[i("div",[t._v("\n                阳性肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.pos_tumor}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result",staticStyle:{color:"green"}},[i("div",[t._v("\n                阴性肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.neg_tumor}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result",staticStyle:{color:"#C280FF"}},[i("div",[t._v("\n                非肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.normal_cell}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result"},[i("div",[t._v("\n                综合指数\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ave)+"%\n            ")])])]):t._e(),t._v(" "),i("div",{staticClass:"recheck"},[i("div",{staticClass:"doc-check"},[i("i",[t._v("医生复核")]),t._v(" "),i("span",{on:{click:function(e){return t.changeResult("")}}},[t._v("清空")]),t._v(" "),i("span",{on:{click:function(e){return t.changeResult(t.ave)}}},[t._v("采纳AI建议")])]),t._v(" "),i("div",{staticClass:"check-result"},[t._v("指数"),i("input",{directives:[{name:"model",rawName:"v-model",value:t.checkResult,expression:"checkResult"}],domProps:{value:t.checkResult},on:{blur:function(e){return t.changeResult(t.checkResult)},input:function(e){e.target.composing||(t.checkResult=e.target.value)}}}),t._v("%")])])])},staticRenderFns:[]};var Et=i("VU/8")(Ft,Pt,!1,function(t){i("Otqi"),i("pbmt")},null,null).exports,Lt={data:()=>({labeltree:[{id:1,label:"阳性肿瘤"},{id:0,label:"阴性肿瘤"},{id:2,label:"非肿瘤"}],roiTypeOpitions:{0:"green",1:"red",2:"#C280FF"},defaultColor:"red",defaultType:1,moveRois:{}}),methods:{moveRoi(t,e){var i;t?t.length?i=t:e&&this.moveRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.moveRois=Object.assign({},e&&this.moveRois,...i.filter(t=>!t.aiResult||!t.aiResult.whole_slide).map(t=>({[t.id]:t}))),this.curRois={}},moveToCenter(){if(Object.keys(this.moveRois).length){var t=[].concat.apply([],Object.values(this.moveRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.moveRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null,this.$refs.osd.scope=null}}},computed:{ave(){return(this.aiFatherRois.filter(t=>t.image).map(t=>t.aiResult.pos_tumor).reduce((t,e)=>t+e,0)/(this.aiFatherRois.filter(t=>t.image).map(t=>t.aiResult.total).reduce((t,e)=>t+e,0)||1)*100).toFixed(2)}},props:["slice","record"],components:{"v-dragon":v.a,"v-analyroi":Et,"v-roi":f,"v-menus":X},mixins:[U]},Dt={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright",on:{mousewheel:function(e){t.ki67Anno=null},mousedown:function(e){t.ki67Anno=null}}},[i("v-dragon",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"osd",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:t.leftRoilist,curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:110,"element-loading-text":"处理中，请耐心等待","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.5)"},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},clickDraw:t.clickDraw,getRoi:function(e){return t.getRoi(e)},roiChanged:t.roiChanged,parentId:function(e){return t.parentId=e},contextmenu:function(e,i){return t.showMenu(e,i)}}},[t.ki67Anno?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+"px",top:t.menuPosition.y+"px"}},[i("v-menus",{attrs:{pos:t.ki67Anno,menus:t.labeltree,currentItem:t.currentItem,newover:t.newover},on:{chosen:function(e){return t.setAnnotation(e)}}})],1):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("div",{staticClass:"quality"},[t._m(0),t._v(" "),i("div",{staticClass:"quality-detail"},[i("p",[t._v("清 晰 度："+t._s(t.slice.clarity?(100*t.slice.clarity).toFixed(2)+"%":"-"))]),t._v(" "),i("p",[t._v("扫描倍数："+t._s(t.slice.objective_rate||"-"))])])]),t._v(" "),i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v("AI处理")]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v("手动处理")])]),t._v(" "),t.auto?i("v-analyroi",{attrs:{slice:t.slice,ROIS:t.aiFatherRois,ave:t.ave,currentRois:t.moveRois},on:{curROI:function(e,i){return t.moveRoi(e,i)+t.moveToCenter()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged,acceptAI:function(e){return t.reCheck(e?e+"%":"")},closecontextmenu:function(e){t.ki67Anno=null}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.rightRoilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"title"},[e("span",[this._v("AI质控")])])}]};var Ht=i("VU/8")(Lt,Dt,!1,function(t){i("ygU+")},"data-v-580cb1b3",null).exports,zt={data:()=>({}),methods:{getCount(t,e){return this.sRois[t.id]?this.sRois[t.id].filter(t=>t.type==e).length:0},checkall(){let t=this.ROIS.every(t=>!!t.image);this.ROIS.forEach(e=>this.$set(e,"image",!t)),this.$emit("closecontextmenu")},change(t,e,i){this.$emit("closecontextmenu"),this.$set(t,"image",i)},del(t){this.$emit("closecontextmenu"),this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})}},props:["showbutton","ROIS","currentRois","sRois","slice"]},Nt={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"tctrois"},[t.ROIS?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),t.ROIS?i("div",{staticClass:"table"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:t.ROIS.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                    ROI\n                ")])]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.heterogeneousRegion")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.total")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.index")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.deleted")))])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.ROIS,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){t.$emit("closecontextmenu"),t.$emit("curROI",e,i.shiftKey)}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){i.stopPropagation(),t.change(e,"image",1-(e.image||0))}}}),t._v("\n                        "+t._s(s+1)+"\n                    ")])]),t._v(" "),i("div",[t._v(t._s(t.getCount(e,3)||"0"))]),t._v(" "),i("div",[t._v(t._s(t.getCount(e,1)+t.getCount(e,3)||"0"))]),t._v(" "),i("div",[t._v(t._s((t.getCount(e,3)/(t.getCount(e,1)+t.getCount(e,3)||1)*100).toFixed(1)+"%"))]),t._v(" "),i("div",[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])])}),0)]):t._e(),t._v(" "),t.ROIS?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                "+t._s(t.$t("slice.AiResult"))+"\n            ")]),t._v(" "),i("div",{class:{error:"error"==t.slice.ki67.diagnosis}},[t._v("\n                "+t._s((t.ROIS.filter(function(t){return t.image}).map(function(e){return t.getCount(e,3)}).reduce(function(t,e){return t+e},0)/(t.ROIS.filter(function(t){return t.image}).map(function(e){return t.getCount(e,1)+t.getCount(e,3)}).reduce(function(t,e){return t+e},0)||1)*100).toFixed(1)+"%")+"\n            ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),i("div",["error"!=t.slice.ki67.diagnosis&&null!=t.slice.ki67.diagnosis?i("div",[t._v("100"),i("span",[t._v("%")])]):t._e(),t._v(" "),"error"==t.slice.ki67.diagnosis?i("div",[t._v("0")]):t._e()])]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.ki67.computer,callback:function(e){t.$set(t.slice.ki67,"computer",e)},expression:"slice.ki67.computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e()])},staticRenderFns:[]};var Bt=i("VU/8")(zt,Nt,!1,function(t){i("rNPa"),i("FVWE")},null,null).exports;let Gt;var Ut={data(){return{loopHandler:0,result:{},auto:!1,centerRegion:null,curRois:{},showbutton:!0,ki67Anno:null,labeltree:[{id:"ki67negativetumorregion",label:"阴性肿瘤区域"},{id:"ki67negativelymphregion",label:"阴性淋巴区域"},{id:"ki67positiontumorregion",label:"阳性肿瘤区域"},{id:"ki67positionlymphregion",label:"阳性淋巴区域"},{id:"mucousnecrosisregion",label:"粘液坏死区域"},{id:"interstitialregion",label:"间质区域"},{id:"normalbreastregion",label:"正常乳腺区域"},{id:"ki67regionnone",label:"其它"},{id:"下载Roi",label:"下载Roi"}],position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,addAnnRoi:!1,menuPosition:{},totalArea:"",showMppGuide:!1,drawMpp:null}},computed:{getCommonAnnotation(){var t=Object.values(this.curRois);return t[0]&&t.every(t=>t.jgResult)&&t.every(e=>e.jgResult==t[0].jgResult)?t[0].jgResult.split(",")[0]:""}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},mouseDown(t){this.ki67Anno=null},checkjgResult:t=>(""+t).split(",")[0],noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;!t||"grey"==t.color&&this.totalArea>5e5?(i=[],this.totalArea=0):t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"grey"==t.color?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t}))},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},getArea(t){for(var e=0,i=0;i<t.x.length-2;i++){if(i+2<t.x.length)var s=[t.x[0],t.y[0]],a=[t.x[i+1],t.y[i+1]],n=[t.x[i+2],t.y[i+2]];e+=(Math.abs(s[0]*a[1])+Math.abs(a[0]*n[1])+Math.abs(n[0]*s[1])-Math.abs(s[0]*n[1])-Math.abs(a[0]*s[1])-Math.abs(n[0]*a[1]))/2}return e=Math.round(Math.abs(e)*Math.pow(this.slice.mppx||.242042,2))},draw(t){this.totalArea=this.getArea(t.path);for(var e=0;e<this.slice.ki67.result.length;e++)this.totalArea+=this.getArea(this.slice.ki67.result[e].path);if(this.auto){if(t.id=(Math.random()+"").substr(2,6),"freepen"===t.method&&(t.simplify=5),this.totalArea>5e5)return void this.$message({message:"ROI总面积不能大于0.5mm²",type:"warning"});t=Object.assign({},t,{image:""});var i=[...this.slice.ki67.result,t];this.$set(this.slice.ki67,"result",i)}else t.id=(Math.random()+"").substr(2,9),"freepen"===t.method&&(t.simplify=2),this.slice.roilist=[...this.slice.roilist,t]},clearSimplify(t){this.$set(this.slice,"roilist",this.slice.roilist.map(e=>(e.id===t.id&&(e.path.x=t.x,e.path.y=t.y,e.simplify&&delete e.simplify),e))),this.$set(this.slice.ki67,"result",this.slice.ki67.result.map(e=>(e.id===t.id&&(e.path.x=t.x,e.path.y=t.y,e.simplify&&delete e.simplify),e)))},async delCurRoi(t){let e={};for(var i of(t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),Object.keys(e)))console.log(i),6==i.length?(this.slice.ki67.result=this.slice.ki67.result.filter(t=>t.id!=i),delete this.slice.ki67.airesult[i]):this.slice.ki67.result.map(t=>{void 0!=this.slice.ki67.airesult[t.id]&&(this.slice.ki67.airesult[t.id]=this.slice.ki67.airesult[t.id].filter(t=>!e[t.id]))});this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},roiChanged(){for(var t in this.curRois)this.curRois[t]=Object.assign({},this.curRois[t]);var e=Object.assign({},this.curRois),i=Object.assign({},i,...Object.values(e).filter(t=>"grey"!=t.color).map(t=>({[t.id]:t})));this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var e=i[t.id];return e?(delete i[t.id],e):t}).concat(Object.values(i))),this.slice.ki67.result.map(t=>{this.slice.ki67.airesult[t.id]=(this.slice.ki67.airesult[t.id]||[]).filter(t=>!i[t.id])})},setAnnotation(t){if(this.ki67Anno=null,"下载Roi"!=t[0]){var e;for(var i in e="string"!=typeof t?t[0]+","+t[1]:t,this.curRois){let t=this.curRois[i];this.curRois[i]=Object.assign({},t,{jgResult:e,remark:e.split(",")[e.split(",").length-1]})}Gt=e;var s=Object.assign({},this.curRois),a=Object.assign({},a,...Object.values(s).filter(t=>"grey"!=t.color).map(t=>({[t.id]:t})));this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var e=a[t.id];return e?(delete a[t.id],e):t}).concat(Object.values(a))),this.slice.ki67.result.map(t=>{this.slice.ki67.airesult[t.id]=(this.slice.ki67.airesult[t.id]||[]).filter(t=>!a[t.id])}),this.curRois={}}else{let t=Object.values(this.curRois)[0].path,e={};if(t.x.length<=4)e[0]=[],e[1]=[],e[0].push(t.x[0]),e[0].push(t.y[0]),e[1].push(t.x[2]),e[1].push(t.y[2]);else{e[0]=[],e[1]=[];var n=Math.max.apply(Math,t.x),o=Math.min.apply(Math,t.x),l=Math.max.apply(Math,t.y),r=Math.min.apply(Math,t.y);e[0].push(o),e[0].push(r),e[1].push(n),e[1].push(l)}window.open("/aipath/api/files/screenshot?caseid="+this.record.id+"&fileid="+this.slice.id+"&filename="+encodeURIComponent(this.slice.filename)+"&roi=[["+e[0][0]+","+e[0][1]+"],["+e[1][0]+","+e[1][1]+"]] &roiid="+Object.keys(this.curRois)[0])}},showMenu(t,e){if((!t.type||t.button)&&(t.preventDefault(),0!=Object.keys(this.curRois).length&&!Object.keys(this.curRois).every(t=>t!=e.id)&&!this.slice.ki67.result.some(t=>t.id==e.id))){var i=t.currentTarget,s=t.offsetX,a=t.offsetY,n=i.offsetWidth,o=i.offsetHeight;this.ki67Anno={},this.ki67Anno.hd=s>n/2?"right":"left",this.ki67Anno.vd=a>o/2?"bottom":"top",this.menuPosition={x:s,y:a}}},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"ki67",other:JSON.stringify(this.slice.ki67.result.map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{this.lineup=t.data.rank,t.data.done?(this.showbutton=!0,this.loopHandler=0,this.$set(this.slice,"type","ki67"),-1!=t.data.rank?(this.flag="error",this.$set(this.slice.ki67,"diagnosis","error")):(Object.keys(t.data.result).filter(t=>!this.slice.ki67.result.find(e=>e.id==t)).map(e=>delete t.data.result[e]),this.slice.ki67.airesult=t.data.result,[].concat.apply([],Object.values(this.slice.ki67.airesult)).forEach(t=>t.id=(""+Math.random()).substr(2,8)),this.$set(this.slice.ki67,"diagnosis",1)),this.updateRecord()):(this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3))})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){0!=this.slice.ki67.result.length?(this.$set(this.slice.ki67,"airesult",{}),this.$set(this.slice.ki67,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,this.auto=!0,this.slice.ki67.result.map(t=>t.image=!0),Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.ki67.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"ki67",other:JSON.stringify(this.slice.ki67.result.map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()):this.$message({message:"请先绘制ROI,再进行处理",type:"warning"})},updateRecord(){this.$emit("save","auto")},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"ki67",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.slice.ki67.result.map(t=>t.image=!1),this.updateRecord())}).catch(t=>console.log(t))},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},beforeMount(){this.slice.ki67||(this.$set(this.slice,"ki67",{}),this.$set(this.slice.ki67,"result",[]),this.$set(this.slice.ki67,"airesult",{})),this.slice.ki67&&!this.slice.ki67.airesult&&this.$set(this.slice.ki67,"airesult",{});let t=[];this.slice.roilist.forEach(e=>{const i=t.findIndex(t=>e.id===t.id);-1!==i?t[i].value=t[i].value+e.value:t.push(e)}),this.slice.roilist=t,this.$emit("save","auto")},mounted(){this.slice.started&&this.slice.ki67&&null===this.slice.ki67.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},"slice.roilist":{handler(t){t.filter(t=>!!t.jgResult).length>1500&&(this.addAnnRoi=!0,setTimeout(()=>this.addAnnRoi=!1,2500),Object.values(this.curRois).map(t=>delete this.curRois[t.id]),t.pop())}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},props:["slice","record"],components:{"v-menus":_t,"v-dragon":v.a,"v-analyroi":Bt,"v-roi":f}},Vt={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt"},[i("div",{staticClass:"analyright",attrs:{tabIndex:0},on:{mousewheel:function(e){t.ki67Anno=null},keydown:t.keydown}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:(this.slice.ki67?this.slice.ki67.result:[]).map(function(t){return Object.assign({method:"rectangle"},t,{editable:!1,color:"grey"})}).concat((this.slice.ki67?[].concat.apply([],Object.values(this.slice.ki67.airesult)):[]).map(function(t){return{id:t.id,path:{x:t.x,y:t.y},color:{0:"purple",1:"green",2:"yellow",3:"red"}[t.type],method:"rectangle",editable:!0,selectable:!1,width:1}}),this.slice.roilist.map(function(e){return Object.assign({method:"rectangle"},e,{color:{ki67positiontumorregion:"red",ki67negativetumorregion:"green",ki67negativelymphregion:"purple",ki67positionlymphregion:"blue",interstitialregion:"orange",normalbreastregion:"pink",mucousnecrosisregion:"#000",ki67regionnone:"#11e6e6"}[t.checkjgResult(e.jgResult)]||"yellow"})})),curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:116},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},contextmenu:function(e,i){return t.showMenu(e,i)},roiChanged:t.roiChanged,mousedown:t.mouseDown,position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},clearSimplify:t.clearSimplify}},[t.ki67Anno?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+"px",top:t.menuPosition.y+"px"}},[i("v-menus",{attrs:{pos:t.ki67Anno,menus:t.labeltree,currentItem:t.getCommonAnnotation},on:{chosen:t.setAnnotation}})],1):t._e(),t._v(" "),t.addAnnRoi?i("div",{staticClass:"addannroi"},[t._v("标注roi数量不能超出1500个")]):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist",on:{click:function(e){t.ki67Anno=null}}},[i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto?i("v-analyroi",{staticClass:"table ki67table",attrs:{ROIS:this.slice.ki67?this.slice.ki67.result:[],sRois:this.slice.ki67?this.slice.ki67.airesult:{},slice:t.slice,showbutton:t.showbutton,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},closecontextmenu:function(e){t.ki67Anno=null}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[]};var Yt=i("VU/8")(Ut,Vt,!1,function(t){i("GiBN")},"data-v-28c221a8",null).exports,Jt={data(){return{centerRegion:null,curRois:{},roilist:[],labeltree:[{id:"阳性肿瘤区域",label:"阳性肿瘤区域"},{id:"阴性肿瘤区域",label:"阴性肿瘤区域"},{id:"组织细胞区域",label:"组织细胞区域"},{id:"淋巴细胞区域",label:"淋巴细胞区域"},{id:"坏死细胞区域",label:"坏死细胞区域"},{id:"免疫细胞区域",label:"免疫细胞区域"},{id:"不确定",label:"不确定"}],pdl1Anno:null,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},menuPosition:{}}},computed:{getCommonAnnotation(){var t=Object.values(this.curRois);return t[0]&&t.every(t=>t.jgResult)&&t.every(e=>e.jgResult==t[0].jgResult)?t[0].jgResult.split(",")[0]:""}},methods:{mouseDown(t){this.pdl1Anno=null},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois||{},...i.map(t=>({[t.id]:t}))),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},draw(t){t.id=(Math.random()+"").substr(2,9),"freepen"===t.method&&(t.simplify=5),this.slice.roilist=[...this.slice.roilist,t]},clearSimplify(t){this.$set(this.slice,"roilist",this.slice.roilist.map(e=>(e.id===t.id&&(e.path.x=t.x,e.path.y=t.y,e.simplify&&delete e.simplify),e)))},async delCurRoi(t){t?(this.slice.roilist=this.slice.roilist.filter(e=>e.id!=t.id),this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})&&(this.slice.roilist=this.slice.roilist.filter(t=>!this.curRois[t.id]),this.curRois={});this.pdl1Anno=null},setAnnotation(t){var e;for(var i in e="string"!=typeof t?t[0]+","+t[1]:t,this.pdl1Anno=null,this.curRois){let t=this.curRois[i];this.curRois[i]=Object.assign({},t,{jgResult:e,remark:e.split(",")[e.split(",").length-1]})}var s=Object.assign({},this.curRois);this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var e=s[t.id];return e?(delete s[t.id],e):t}).concat(Object.values(s)))},checkjgResult:t=>t.jgResult?t.jgResult.split(",")[1]:"",showMenu(t,e){if((!t.type||t.button)&&(t.preventDefault(),0!=Object.keys(this.curRois).length&&!Object.keys(this.curRois).every(t=>t!=e.id))){var i=t.currentTarget,s=t.offsetX,a=t.offsetY,n=i.offsetWidth,o=i.offsetHeight;this.pdl1Anno={},this.pdl1Anno.hd=s>n/2?"right":"left",this.pdl1Anno.vd=a>o/2?"bottom":"top",this.menuPosition={x:s,y:a}}},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},props:["slice","record"],components:{"v-menus":_t,"v-dragon":v.a,"v-roi":f}},Wt={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright",on:{mousewheel:function(e){t.pdl1Anno=null}}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.map(function(e){return Object.assign({method:"rectangle",color:"yellow"},e,{color:{"阳性肿瘤区域":"red","阴性肿瘤区域":"yellow","组织细胞区域":"green","淋巴细胞区域":"purple","坏死细胞区域":"#666","免疫细胞区域":"orange","不确定":"#ec18a4"}[t.checkjgResult(e)]})}),curRois:t.curRois,centerRegion:t.centerRegion,position:t.position},on:{curROI:t.curROIChange,draw:t.draw,contextmenu:function(e,i){return t.showMenu(e,i)},delRoi:function(e){return t.delCurRoi(e)},mousedown:t.mouseDown,position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},clearSimplify:t.clearSimplify}},[t.pdl1Anno?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+5+"px",top:t.menuPosition.y+5+"px"}},[i("v-menus",{attrs:{pos:t.pdl1Anno,menus:t.labeltree,currentItem:t.getCommonAnnotation},on:{chosen:t.setAnnotation}})],1):t._e()])],1),t._v(" "),i("div",{staticClass:"analylist",on:{click:function(e){t.pdl1Anno=null}}},[i("h2",[i("span",{staticClass:"noauto"},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},closecontextmenu:function(e){t.pdl1Anno=null}}}),t._v(" "),i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})])],1)])},staticRenderFns:[]};var Xt=i("VU/8")(Jt,Wt,!1,function(t){i("ZULA")},"data-v-d1a134de",null).exports;let qt;var Kt={data(){return{centerRegion:null,curRois:{},roilist:[],labeltree:[{id:"阳性肿瘤细胞",label:"阳性肿瘤细胞"},{id:"阴性肿瘤细胞",label:"阴性肿瘤细胞"},{id:"阳性组织细胞",label:"阳性组织细胞"},{id:"阴性组织细胞",label:"阴性组织细胞"},{id:"阳性淋巴细胞",label:"阳性淋巴细胞"},{id:"阴性淋巴细胞",label:"阴性淋巴细胞"},{id:"纤维间质细胞",label:"纤维间质细胞"},{id:"其他难以区分的阳性免疫细胞",label:"其他难以区分的阳性免疫细胞"},{id:"其他难以区分的阴性免疫细胞",label:"其他难以区分的阴性免疫细胞"},{id:"正常肺泡细胞",label:"正常肺泡细胞"},{id:"碳末沉渣",label:"碳末沉渣"},{id:"软骨细胞",label:"软骨细胞"}],pdl1Anno:null,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},menuPosition:{}}},computed:{getCommonAnnotation(){var t=Object.values(this.curRois);return t[0]&&t.every(t=>t.jgResult)&&t.every(e=>e.jgResult==t[0].jgResult)?t[0].jgResult.split(",")[0]:""}},methods:{clickDraw(t,e){var i,s=t.x,a=t.y;i=void 0!=qt?{id:(Math.random()+"").substr(2,9),path:{x:[s],y:[a]},method:"spot",radius:8,remark:qt.split(",")[1],jgResult:qt.split(",")[0]}:{id:(Math.random()+"").substr(2,9),path:{x:[s],y:[a]},method:"spot",radius:8},this.slice.roilist=[...this.slice.roilist,i],e?Object.assign(this.curRois,{[i.id]:i}):this.curRois={[i.id]:i}},checkjgResult:t=>(""+t).split(",")[0],mouseDown(t){this.pdl1Anno=null},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois||{},...i.map(t=>({[t.id]:t}))),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},draw(t){t.id=(Math.random()+"").substr(2,9),"freepen"===t.method&&(t.simplify=1),this.slice.roilist=[...this.slice.roilist,t]},clearSimplify(t){this.$set(this.slice,"roilist",this.slice.roilist.map(e=>(e.id===t.id&&(e.path.x=t.x,e.path.y=t.y,e.simplify&&delete e.simplify),e)))},async delCurRoi(t){t?(this.slice.roilist=this.slice.roilist.filter(e=>e.id!=t.id),this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})&&(this.slice.roilist=this.slice.roilist.filter(t=>!this.curRois[t.id]),this.curRois={});this.pdl1Anno=null},setAnnotation(t){var e;for(var i in e="string"!=typeof t?t[0]+","+t[1]:t,this.pdl1Anno=null,this.curRois){let t=this.curRois[i];this.curRois[i]=Object.assign({},t,{jgResult:e,remark:e.split(",")[e.split(",").length-1]})}qt=e;var s=Object.assign({},this.curRois);this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var e=s[t.id];return e?(delete s[t.id],e):t}).concat(Object.values(s)))},showMenu(t,e){if((!t.type||t.button)&&(t.preventDefault(),0!=Object.keys(this.curRois).length&&!Object.keys(this.curRois).every(t=>t!=e.id))){var i=t.currentTarget,s=t.offsetX,a=t.offsetY,n=i.offsetWidth,o=i.offsetHeight;this.pdl1Anno={},this.pdl1Anno.hd=s>n/2?"right":"left",this.pdl1Anno.vd=a>o/2?"bottom":"top",this.menuPosition={x:s,y:a}}},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},beforeMount(){let t=[];this.slice.roilist.forEach(e=>{const i=t.findIndex(t=>e.id===t.id);-1!==i?t[i].value=t[i].value+e.value:t.push(e)}),this.slice.roilist=t},props:["slice","record"],components:{"v-menus":_t,"v-dragon":v.a,"v-roi":f}},Zt={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright",on:{mousewheel:function(e){t.pdl1Anno=null}}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.map(function(e){return Object.assign({method:"rectangle",color:"yellow"},e,{color:{"阳性肿瘤细胞":"#fd0002","阴性肿瘤细胞":"#92d14c","阳性组织细胞":"#ffc000","阴性组织细胞":"#04b1fd","阳性淋巴细胞":"#fdff01","阴性淋巴细胞":"#006fc3","纤维间质细胞":"#fec2cc","其他难以区分的阳性免疫细胞":"#fb21fc","其他难以区分的阴性免疫细胞":"#7c7a7b","正常肺泡细胞":"#722fa0","碳末沉渣":"#029c90","软骨细胞":"#010103"}[t.checkjgResult(e.jgResult)]||"yellow"})}),curRois:t.curRois,centerRegion:t.centerRegion,position:t.position},on:{curROI:t.curROIChange,draw:t.draw,contextmenu:function(e,i){return t.showMenu(e,i)},clickDraw:t.clickDraw,delRoi:function(e){return t.delCurRoi(e)},mousedown:t.mouseDown,position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},clearSimplify:t.clearSimplify}},[t.pdl1Anno?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+"px",top:t.menuPosition.y+"px"}},[i("v-menus",{attrs:{pos:t.pdl1Anno,menus:t.labeltree,currentItem:t.getCommonAnnotation},on:{chosen:t.setAnnotation}})],1):t._e()])],1),t._v(" "),i("div",{staticClass:"analylist",on:{click:function(e){t.pdl1Anno=null}}},[i("h2",[i("span",{staticClass:"noauto"},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},closecontextmenu:function(e){t.pdl1Anno=null}}}),t._v(" "),i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})])],1)])},staticRenderFns:[]};var Qt=i("VU/8")(Kt,Zt,!1,function(t){i("RR5D")},"data-v-66730859",null).exports,te={data(){return{centerRegion:null,curRois:{},roilist:[],labeltree:[{id:"negativetimor",label:"阴性肿瘤"},{id:"negativeUnsuer",label:"阴性其他"},{id:"positiontumor",label:"阳性肿瘤"},{id:"positionUnsuer",label:"阳性其他"},{id:"none",label:"无"}],pathAnno:null,showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null}}},computed:{getCommonAnnotation(){var t=Object.values(this.curRois);return t[0]&&t.every(e=>e.jgResult==t[0].jgResult)?t[0].jgResult:""}},methods:{mouseDown(t){this.pathAnno=null},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois||{},...i.map(t=>({[t.id]:t}))),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},draw(t){t.id=(Math.random()+"").substr(2,9),"freepen"===t.method&&(t.simplify=5),this.slice.roilist=[...this.slice.roilist,t]},clearSimplify(t){this.$set(this.slice,"roilist",this.slice.roilist.map(e=>(e.id===t.id&&(e.path.x=t.x,e.path.y=t.y,e.simplify&&delete e.simplify),e)))},clickDraw(t,e){var i=60,s=t.x,a=t.y,n={id:(Math.random()+"").substr(2,9),path:{x:[s-i,s+i,s+i,s-i],y:[a-i,a-i,a+i,a+i]},width:3,method:"rectangle"};this.slice.roilist=[...this.slice.roilist,n],this.curROIChange(n,e)},async delCurRoi(t){t?(this.slice.roilist=this.slice.roilist.filter(e=>e.id!=t.id),this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})&&(this.slice.roilist=this.slice.roilist.filter(t=>!this.curRois[t.id]),this.curRois={})},setAnnotation(t){for(var e in this.pathAnno=null,this.curRois){let i=this.curRois[e];this.curRois[e]=Object.assign({},i,{jgResult:t,remark:t.split(":")[1]||t})}var i=Object.assign({},this.curRois);this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var e=i[t.id];return e?(delete i[t.id],e):t}).concat(Object.values(i)))},showMenu(t,e){if((!t.type||t.button)&&(t.preventDefault(),0!=Object.keys(this.curRois).length&&!Object.keys(this.curRois).every(t=>t!=e.id))){var i=t.currentTarget,s=t.offsetX,a=t.offsetY,n=i.offsetWidth,o=i.offsetHeight;this.pathAnno={},s>n/2?this.pathAnno.right=n-s+"px":this.pathAnno.left=s+"px",a>o/2?this.pathAnno.bottom=o-a+"px":this.pathAnno.top=a+"px"}},startAnalyze(){this.showbutton=!1},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},mounted(){},props:["slice","record"],components:{"v-menus":_t,"v-dragon":v.a,"v-roi":f}},ee={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright",on:{mousewheel:function(e){t.pathAnno=null}}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})}),curRois:t.curRois,centerRegion:t.centerRegion,position:t.position},on:{curROI:t.curROIChange,draw:t.draw,clickDraw:t.clickDraw,contextmenu:function(e,i){return t.showMenu(e,i)},delRoi:function(e){return t.delCurRoi(e)},mousedown:t.mouseDown,position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},clearSimplify:t.clearSimplify}},[t.pathAnno?i("div",{staticStyle:{position:"absolute",width:"200px","min-height":"36px",background:"white","z-index":"9"},style:t.pathAnno},[i("v-menus",{attrs:{menus:t.labeltree,currentItem:t.getCommonAnnotation},on:{chosen:t.setAnnotation}})],1):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist",on:{click:function(e){t.pathAnno=null}}},[i("h2",[i("span",{staticClass:"noauto"},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},closecontextmenu:function(e){t.pathAnno=null}}}),t._v(" "),i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})])],1)])},staticRenderFns:[]};var ie=i("VU/8")(te,ee,!1,function(t){i("PZiJ")},"data-v-765b2e74",null).exports,se={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,showMppGuide:!1,drawMpp:null}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"red"==t.color?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t})),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},draw(t){t.id=(Math.random()+"").substr(2,9),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.thyroid&&(this.slice.thyroid.result=this.slice.thyroid.result.filter(t=>!e[t.id])),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"thyroid",other:""}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.slice.thyroid&&0==this.slice.thyroid.result.length){if(-1==t.data.rank)if(0==Object.keys(t.data.result).length)this.$set(this.slice.thyroid,"diagnosis","U");else{var e,i=t.data.result.cnts_desp&&t.data.result.cnts_desp.slice(0,t.data.result.cnts_desp.length).map(t=>({id:(Math.random()+"").substr(2),editable:!1,path:{x:t.cnt.map(t=>t[0]),y:t.cnt.map(t=>t[1])}}));e="Benign"==t.data.result.flag?"N":"Malignant"==t.data.result.flag?"P":"U",this.$set(this.slice.thyroid,"result",i),this.$set(this.slice.thyroid,"diagnosis",e)}else this.$set(this.slice.thyroid,"diagnosis","U");this.$set(this.slice,"type","thyroid"),this.updateRecord()}}else this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3)})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice,"thyroid",{}),this.$set(this.slice.thyroid,"result",[]),this.$set(this.slice.thyroid,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,this.auto=!0,Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.thyroid.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"thyroid",other:""}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"thyroid",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},mounted(){this.slice.started&&this.slice.thyroid&&null===this.slice.thyroid.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},ae={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright"},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})}).concat((this.slice.thyroid?this.slice.thyroid.result:[]).map(function(t){return Object.assign({},t,{color:"red",method:"rectangle",editable:!1})})),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto&&t.slice.thyroid?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:this.slice.thyroid?this.slice.thyroid.result:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),!t.slice.thyroid&&t.auto?i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]):t._e(),t._v(" "),t.slice.thyroid&&t.auto?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                    "+t._s(t.$t("slice.AiResult"))+"\n                ")]),t._v(" "),i("div",{class:{error:"error"==this.slice.thyroid.diagnosis}},[t._v("\n                    "+t._s(this.slice.thyroid.diagnosis)+"\n                ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),t._m(0)]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.thyroid.computer,callback:function(e){t.$set(t.slice.thyroid,"computer",e)},expression:"slice.thyroid.computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",[e("div",[this._v("100%")])])}]};var ne=i("VU/8")(se,ae,!1,function(t){i("yiVy"),i("mlws")},"data-v-29ab7c1c",null).exports,oe={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,showMppGuide:!1,drawMpp:null}},filters:{showdiagnosis(t){if(void 0!=t)switch(t){case"Benign":return"N";case"Malignant":return"P";case"Unsure":return"U";case"PreCancer":return"A";default:return"U"}}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>({[t.id]:t}))),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},draw(t){t.id=(Math.random()+"").substr(2,6),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"mucosa",other:""}).then(t=>{this.lineup=t.data.rank,t.data.done?(this.showbutton=!0,this.loopHandler=0,this.slice.mucosa&&(this.$set(this.slice,"type","mucosa"),this.$set(this.slice.mucosa,"diagnosis",t.data.result.flag),this.updateRecord())):(this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3))})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.slice.mucosa={},this.$set(this.slice.mucosa,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,this.auto=!0,Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"mucosa",other:""}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"mucosa",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},mounted(){this.slice.started&&this.slice.mucosa&&null===this.slice.mucosa.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},le={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt"},[i("div",{staticClass:"analyright",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:[].concat(this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})})),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:1==t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:0==t.auto?"noauto":"",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto&&this.slice.mucosa?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),!t.slice.mucosa&&t.auto?i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]):t._e(),t._v(" "),t.slice.mucosa&&t.auto?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                    "+t._s(t.$t("slice.AiResult"))+"\n                ")]),t._v(" "),i("div",{class:{error:"error"==this.slice.mucosa.diagnosis}},[t._v("\n                    "+t._s(t._f("showdiagnosis")(this.slice.mucosa.diagnosis))+"\n                ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),t._m(0)]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.company,callback:function(e){t.$set(t.slice,"company",e)},expression:"slice.company"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",[e("div",[this._v("100%")])])}]};var re=i("VU/8")(oe,le,!1,function(t){i("EYQp"),i("0Zwn")},"data-v-c11e7ba8",null).exports,ce={data(){return{loopHandler:0,auto:"one",centerRegion:null,curRois:{},showbutton:!0,radio:null,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,showMppGuide:!1,drawMpp:null}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},keypress(t){if(t.ctrlKey&&"KeyB"==t.code){let t=window.prompt("人工结果？");this.record.analy=this.slice.tct.diagnosis=t}},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>({[t.id]:t})))},roiChanged(){for(var t in this.curRois)this.curRois[t]=Object.assign({},this.curRois[t]);var e=Object.assign({},this.curRois);this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var i=e[t.id];return i?(delete e[t.id],i):t}).concat(Object.values(e))),this.slice.tct&&(this.slice.tct.result=this.slice.tct.result.filter(t=>!this.curRois[t.id]))},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},draw(t){t.id=(Math.random()+"").substr(2,6),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.tct&&(this.slice.tct.result=this.slice.tct.result.filter(t=>!e[t.id])),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"tct",other:""}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.slice.tct&&0==this.slice.tct.result.length){if(-1==t.data.rank)if(0==Object.keys(t.data.result).length)this.$set(this.slice.tct,"diagnosis","U");else{var e,i=t.data.result.cells&&t.data.result.cells.slice(0,30).map(t=>({id:(Math.random()+"").substr(2,6),path:{x:t.contourPoints.slice(0,-1).map(t=>t[0]),y:t.contourPoints.slice(0,-1).map(t=>t[1])}}));this.$set(this.slice.tct,"result",i);try{e=t.data.result.diagnosis[0].toLowerCase()}catch(t){}e={n:"阴性",p:"阳性",u:"不确定"}[e]||"不满意",this.$set(this.slice.tct,"diagnosis",e)}else this.$set(this.slice.tct,"diagnosis","U");this.$set(this.slice,"type","tct"),this.updateRecord()}}else this.showbutton=!1,this.loopHandler=setTimeout(()=>{this.getAlgorithmResult()},5e3)})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice,"tct",{}),this.$set(this.slice.tct,"result",[]),this.slice.started=!0,this.record.started=!0,this.$set(this.slice.tct,"diagnosis",null),this.showbutton=!1,this.auto="one",Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.tct.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"tct",other:""}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"tct"}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},mounted(){this.slice.started&&this.slice.tct&&null===this.slice.tct.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},"slice.tct.computer":{async handler(t){await Object(s.b)("ai/edit",{caseid:this.record.id,fileid:this.slice.id,filename:this.slice.filename,type:"tct",result:t}),this.slice.tct.diagnosis={negative:"阴性",positive:"阳性",unsure:"不确定"}[t],this.$emit("save","auto")}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},he={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",staticStyle:{width:"100%"},attrs:{tabIndex:0},on:{keydown:t.keydown,keypress:t.keypress}},[i("div",{staticClass:"analyright"},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})}).concat((this.slice.tct?this.slice.tct.result:[]).map(function(t){return Object.assign({},t,{color:"red",method:"rectangle",editable:!0,selectable:!1})})),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,roiChanged:t.roiChanged,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:"one"==t.auto?"auto":"",on:{click:function(e){t.auto="one"}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:"two"==t.auto?"auto":"",on:{click:function(e){t.auto="two"}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),this.slice.tct&&"one"==t.auto?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:this.slice.tct?this.slice.tct.result:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),"two"==t.auto?i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.showbutton||"one"!=t.auto?t._e():i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]),t._v(" "),this.slice.tct||"one"!=t.auto?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),this.slice.tct&&"one"==t.auto?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                    "+t._s(t.$t("slice.AiResult"))+"\n                ")]),t._v(" "),i("div",{class:{error:"error"==this.slice.tct.diagnosis}},[i("input",{directives:[{name:"model",rawName:"v-model",value:t.slice.tct.diagnosis,expression:"slice.tct.diagnosis"}],attrs:{type:"text"},domProps:{value:t.slice.tct.diagnosis},on:{input:function(e){e.target.composing||t.$set(t.slice.tct,"diagnosis",e.target.value)}}})])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),t._m(0)]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.tct.computer,callback:function(e){t.$set(t.slice.tct,"computer",e)},expression:"slice.tct.computer"}},[i("el-radio",{attrs:{label:"positive"}},[t._v("阳性")]),t._v(" "),i("el-radio",{attrs:{label:"negative"}},[t._v("阴性")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("不确定")])],1)],1)]):t._e(),t._v(" "),"two"==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",[e("div",[this._v("100%")])])}]};var ue=i("VU/8")(ce,he,!1,function(t){i("Oj7S"),i("qU0u")},"data-v-104055a6",null).exports,de={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,showMppGuide:!1,drawMpp:null}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"black"==t.color?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t})),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},draw(t){t.id=(Math.random()+"").substr(2,9),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.embolus&&(this.slice.embolus.result=this.slice.embolus.result.filter(t=>!e[t.id])),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"embolus",other:""}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.slice.embolus&&0==this.slice.embolus.result.length){var e;if(-1==t.data.rank)if(0==Object.keys(t.data.result).length)this.$set(this.slice.embolus,"diagnosis",0);else e=t.data.result[-1]&&t.data.result[-1].map(t=>({id:(Math.random()+"").substr(2,8),path:{x:t.x,y:t.y}})),this.$set(this.slice.embolus,"result",e),this.$set(this.slice.embolus,"diagnosis",e.length);else this.$set(this.slice.embolus,"diagnosis",0);this.$set(this.slice,"type","embolus")}this.updateRecord()}else this.showbutton=!1,this.loopHandler=setTimeout(()=>{this.getAlgorithmResult()},5e3)})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice,"embolus",{}),this.$set(this.slice.embolus,"result",[]),this.$set(this.slice.embolus,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.auto=!0,this.showbutton=!1,Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.embolus.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"embolus",other:""}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"embolus",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},mounted(){this.slice.started&&this.slice.embolus&&null===this.slice.embolus.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},pe={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright"},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})}).concat((this.slice.embolus?this.slice.embolus.result:[]).map(function(t){return Object.assign({},t,{color:"red",method:"rectangle",editable:!1,selectable:!1})})),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.slice.embolus&&t.auto?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:this.slice.embolus?this.slice.embolus.result:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),!this.slice.embolus&&t.auto?i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]):t._e(),t._v(" "),t.slice.embolus&&t.auto?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                    "+t._s(t.$t("slice.AiResult"))+"\n                ")]),t._v(" "),i("div",{class:{error:"error"==this.slice.embolus.diagnosis}},[t._v("\n                    "+t._s(this.slice.embolus.result.length||0)+"\n                ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),i("div",["error"!=t.slice.embolus.diagnosis&&null!=t.slice.embolus.diagnosis?i("div",[t._v("100"),i("span",[t._v("%")])]):t._e(),t._v(" "),"error"==t.slice.embolus.diagnosis?i("div",[t._v("0")]):t._e()])]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.embolus.computer,callback:function(e){t.$set(t.slice.embolus,"computer",e)},expression:"slice.embolus.computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[]};var ve=i("VU/8")(de,pe,!1,function(t){i("lNFS"),i("9ywP")},"data-v-10f6e95a",null).exports,me={data:()=>({options:[{value:"",label:"0 HPF"},{value:"选项1",label:"5 HPF"},{value:"选项2",label:"10 HPF"},{value:"选项3",label:"50 HPF"}],value:"",hpf:0,warningHpf:!1,warningWords:""}),methods:{getArea(t){for(var e=0,i=0;i<t.path.x.length-2;i++){if(i+2<t.path.x.length)var s=[t.path.x[0],t.path.y[0]],a=[t.path.x[i+1],t.path.y[i+1]],n=[t.path.x[i+2],t.path.y[i+2]];e+=(Math.abs(s[0]*a[1])+Math.abs(a[0]*n[1])+Math.abs(n[0]*s[1])-Math.abs(s[0]*n[1])-Math.abs(a[0]*s[1])-Math.abs(n[0]*a[1]))/2}return e=(Math.round(Math.abs(e)*Math.pow(this.slice.mppx||.242042,2))/1e6).toFixed(2)},getCount(t){return this.sRois[t.id]?this.sRois[t.id].length:0},checkall(){let t=this.ROIS.every(t=>!!t.image);this.ROIS.forEach(e=>this.$set(e,"image",!t))},change(t,e,i){this.$set(t,"image",i)},del(t){this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})}},updated(){var t=this.ROIS.filter(t=>!!t.image).map(t=>this.getArea(t)).reduce((t,e)=>Number(t)+Number(e),0)/.192;t<Object.values(this.options.filter(t=>t.value==this.value)[0])[1].split(" ")[0]&&(this.value=t>=10&&t<50?"选项2":t>=5&&t<10?"选项1":"")},watch:{value(t){var e=this.ROIS.filter(t=>!!t.image).map(t=>this.getArea(t)).reduce((t,e)=>Number(t)+Number(e),0)/.192;this.hpf=Object.values(this.options.filter(e=>e.value==t)[0])[1].split(" ")[0],this.ROIS.every(t=>1!=t.image)||this.ROIS.every(t=>0==t.image)?(this.warningWords="请勾选ROI计算",this.value="",this.warningHpf=!0,setTimeout(()=>{this.warningHpf=!1},3e3)):e<this.hpf&&(this.warningWords="ROI面积必须大于你选的5、10或50个高倍视野总面积时才能换算",this.warningHpf=!0,setTimeout(()=>{this.warningHpf=!1},3e3),this.value="")}},props:["ROIS","currentRois","sRois","slice"]},ge={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"mitroi"},[t.ROIS?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),t.ROIS?i("div",{staticClass:"table"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:t.ROIS.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                    ROI\n                ")])]),t._v(" "),i("div",[t._v("个数")]),t._v(" "),t._m(0),t._v(" "),i("div",[t._v("HPF")]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.deleted")))])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.ROIS,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){return t.$emit("curROI",e,i.shiftKey)}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){i.stopPropagation(),t.change(e,"image",1-(e.image||0))}}}),t._v("\n                        "+t._s(s+1)+"\n                    ")])]),t._v(" "),i("div",[t._v(t._s(t.getCount(e)||0))]),t._v(" "),i("div",{staticStyle:{width:"40%"}},[t._v(t._s(t.getArea(e)))]),t._v(" "),i("div",[t._v(t._s((t.getArea(e)/.192).toFixed(2)))]),t._v(" "),i("div",[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])])}),0)]):t._e(),t._v(" "),t.ROIS?i("div",{staticClass:"nuclearbtm"},[i("div",{staticClass:"nuclear "},[i("div",{staticClass:"AiResulttop"},[i("span",[t._v("总个数:"+t._s(t.ROIS.filter(function(t){return!!t.image}).map(function(e){return t.getCount(e)}).reduce(function(t,e){return t+e},0)))]),t._v(" "),i("span",[t._v("总面积:"+t._s(t.ROIS.filter(function(t){return!!t.image}).map(function(e){return t.getArea(e)}).reduce(function(t,e){return Number(t)+Number(e)},0).toFixed(2))+"mm"),i("sup",[t._v("2")])]),t._v(" "),i("span",[t._v("总HPF:"+t._s((t.ROIS.filter(function(t){return!!t.image}).map(function(e){return t.getArea(e)}).reduce(function(t,e){return Number(t)+Number(e)},0)/.192).toFixed(2)))])]),t._v(" "),i("div",{staticClass:"about"},[t._v("\n                相当于  "+t._s((t.ROIS.filter(function(t){return!!t.image}).map(function(e){return t.getCount(e)}).reduce(function(t,e){return t+e},0)/(t.ROIS.filter(function(t){return!!t.image}).map(function(e){return t.getArea(e)}).reduce(function(t,e){return Number(t)+Number(e)},0)/.192)*t.hpf||0).toFixed(2))+"\n                      /  \n                    "),i("el-select",{attrs:{"popper-class":"hpf",placeholder:"请选择"},model:{value:t.value,callback:function(e){t.value=e},expression:"value"}},t._l(t.options,function(t){return i("el-option",{key:t.value,attrs:{label:t.label,value:t.value}})}),1)],1)]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),i("div",["error"!=t.slice.mitosis.diagnosis&&null!=t.slice.mitosis.diagnosis?i("div",[t._v("100"),i("span",[t._v("%")])]):t._e(),t._v(" "),"error"==t.slice.mitosis.diagnosis?i("div",[t._v("0")]):t._e()])]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.mitosis.computer,callback:function(e){t.$set(t.slice.mitosis,"computer",e)},expression:"slice.mitosis .computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),i("transition",{attrs:{name:"fade"}},[t.warningHpf?i("div",{staticClass:"warninghpf"},[t._v("\n            "+t._s(t.warningWords)+"\n        ")]):t._e()])],1)},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticStyle:{width:"40%"}},[this._v("面积( "),e("span",[this._v("mm"),e("sup",[this._v("2")])]),this._v(" )")])}]};var fe=i("VU/8")(me,ge,!1,function(t){i("koDA"),i("aN2i")},null,null).exports,_e={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,showMppGuide:!1,drawMpp:null}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i,s=[].concat(...Object.values(this.slice.mitosis.airesult));t&&s.some(e=>e.id==t.id)||(t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"grey"==t.color?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t})),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)}))},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},draw(t){if(t.id=(Math.random()+"").substr(2,6),this.auto){t=Object.assign({},t,{image:""});var e=[...this.slice.mitosis.result,t];this.$set(this.slice.mitosis,"result",e)}else this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};for(var i of(t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),Object.keys(e)))6==i.length?(this.slice.mitosis.result=this.slice.mitosis.result.filter(t=>t.id!=i),delete this.slice.mitosis.airesult[i]):this.slice.mitosis.result.map(t=>{void 0!=this.slice.mitosis.airesult[t.id]&&(this.slice.mitosis.airesult[t.id]=this.slice.mitosis.airesult[t.id].filter(t=>!e[t.id]))});this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"mitosis",other:JSON.stringify(this.slice.mitosis.result.map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{this.lineup=t.data.rank,t.data.done?(this.showbutton=!0,this.loopHandler=0,this.$set(this.slice,"type","mitosis"),-1!=t.data.rank?this.slice.mitosis.diagnosis=this.flag="error":(Object.keys(t.data.result).filter(t=>!this.slice.mitosis.result.find(e=>e.id==t)).map(e=>delete t.data.result[e]),this.slice.mitosis.airesult=t.data.result,[].concat.apply([],Object.values(this.slice.mitosis.airesult)).forEach(t=>t.id=(""+Math.random()).substr(2,8)),this.$set(this.slice.mitosis,"diagnosis",1)),this.updateRecord()):(this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3))})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){0!=this.slice.mitosis.result.length?(this.$set(this.slice.mitosis,"airesult",{}),this.$set(this.slice.mitosis,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,this.auto=!0,this.slice.mitosis.result.map(t=>t.image=!0),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"mitosis",other:JSON.stringify(this.slice.mitosis.result.map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()):this.$message({message:"请先绘制ROI,再进行处理",type:"warning"})},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"mitosis",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.slice.mitosis.result.map(t=>t.image=!1),this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},beforeMount(){this.slice.mitosis||(this.$set(this.slice,"mitosis",{}),this.$set(this.slice.mitosis,"result",[]),this.$set(this.slice.mitosis,"airesult",{})),this.slice.mitosis&&!this.slice.mitosis.airesult&&this.$set(this.slice.mitosis,"airesult",{})},mounted(){this.slice.started&&this.slice.mitosis&&null===this.slice.mitosis.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},props:["slice","record"],components:{"v-dragon":v.a,"v-analyroi":fe,"v-roi":f}},ye={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright"},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:(this.slice.mitosis?[].concat.apply([],Object.values(this.slice.mitosis.airesult)):[]).map(function(t){return{id:t.id,path:{x:t.x,y:t.y},color:"#00ff00",method:"rectangle",editable:!1,selectable:!1,width:3}}).concat(this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})}),(this.slice.mitosis?this.slice.mitosis.result:[]).map(function(t){return Object.assign({method:"rectangle"},t,{editable:!1,selectable:!1,color:"grey"})})),curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto?i("v-analyroi",{staticClass:"table ki67table",attrs:{slice:t.slice,ROIS:this.slice.mitosis?this.slice.mitosis.result:[],sRois:this.slice.mitosis?this.slice.mitosis.airesult:{},currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[]};var be=i("VU/8")(_e,ye,!1,function(t){i("cnSL")},"data-v-6b1e89df",null).exports,Re={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,showMppGuide:!1,drawMpp:null}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"black"==t.color?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t})),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},draw(t){t.id=(Math.random()+"").substr(2,6),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.kidney&&(this.slice.kidney.result=this.slice.kidney.result.filter(t=>!e[t.id])),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"embolus",other:""}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.slice.kidney&&0==this.slice.kidney.result.length){var e;if(-1==t.data.rank)if(0==Object.keys(t.data.result).length)this.$set(this.slice.kidney,"diagnosis",0);else e=t.data.result[-1]&&t.data.result[-1].map(t=>({id:(Math.random()+"").substr(2,8),path:{x:t.x,y:t.y}})),this.$set(this.slice.kidney,"result",e),this.$set(this.slice.kidney,"diagnosis",e.length);else this.$set(this.slice.kidney,"diagnosis",0);this.$set(this.slice,"type","kidney")}this.updateRecord()}else this.showbutton=!1,this.loopHandler=setTimeout(()=>{this.getAlgorithmResult()},5e3)})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice,"kidney",{}),this.$set(this.slice.kidney,"result",[]),this.$set(this.slice.kidney,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.auto=!0,this.showbutton=!1,Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.kidney.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"embolus",other:""}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"embolus",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},mounted(){this.slice.started&&this.slice.kidney&&null===this.slice.kidney.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},Ce={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright"},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})}).concat((this.slice.kidney?this.slice.kidney.result:[]).map(function(t){return Object.assign({},t,{color:"red",method:"rectangle",editable:!1,selectable:!1})})),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.slice.kidney&&t.auto?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:this.slice.kidney?this.slice.kidney.result:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),!this.slice.kidney&&t.auto?i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]):t._e(),t._v(" "),t.slice.kidney&&t.auto?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                    "+t._s(t.$t("slice.AiResult"))+"\n                ")]),t._v(" "),i("div",{class:{error:"error"==this.slice.kidney.diagnosis}},[t._v("\n                    "+t._s(this.slice.kidney.result.length||0)+"\n                ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),i("div",["error"!=t.slice.kidney.diagnosis&&null!=t.slice.kidney.diagnosis?i("div",[t._v("100"),i("span",[t._v("%")])]):t._e(),t._v(" "),"error"==t.slice.kidney.diagnosis?i("div",[t._v("0")]):t._e()])]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.kidney.computer,callback:function(e){t.$set(t.slice.kidney,"computer",e)},expression:"slice.kidney.computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[]};var we=i("VU/8")(Re,Ce,!1,function(t){i("qNVf"),i("UaiW")},"data-v-076a98a8",null).exports,ke={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,showMppGuide:!1,drawMpp:null}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"black"==t.color?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t})),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},draw(t){t.id=(Math.random()+"").substr(2,6),"freepen"===t.method&&"yellow"===t.color&&(t.simplify=10),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.bacillus&&(this.slice.bacillus.result=this.slice.bacillus.result.filter(t=>!e[t.id])),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"embolus",other:""}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.slice.bacillus&&0==this.slice.bacillus.result.length){var e;if(-1==t.data.rank)if(0==Object.keys(t.data.result).length)this.$set(this.slice.bacillus,"diagnosis",0);else e=t.data.result[-1]&&t.data.result[-1].map(t=>({id:(Math.random()+"").substr(2,8),path:{x:t.x,y:t.y}})),this.$set(this.slice.bacillus,"result",e),this.$set(this.slice.bacillus,"diagnosis",e.length);else this.$set(this.slice.bacillus,"diagnosis",0);this.$set(this.slice,"type","embolus")}this.updateRecord()}else this.showbutton=!1,this.loopHandler=setTimeout(()=>{this.getAlgorithmResult()},5e3)})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice,"bacillus",{}),this.$set(this.slice.bacillus,"result",[]),this.$set(this.slice.bacillus,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.auto=!0,this.showbutton=!1,Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.bacillus.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"embolus",other:""}).then(t=>this.getAlgorithmResult()).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"embolus"}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},mounted(){this.slice.started&&this.slice.bacillus&&null===this.slice.bacillus.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},xe={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright"},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})}).concat((this.slice.bacillus?this.slice.bacillus.result:[]).map(function(t){return Object.assign({},t,{color:"red",method:"rectangle",editable:!1,selectable:!1})})),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.slice.bacillus&&t.auto?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:this.slice.bacillus?this.slice.bacillus.result:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),!this.slice.bacillus&&t.auto?i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]):t._e(),t._v(" "),t.slice.bacillus&&t.auto?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                    "+t._s(t.$t("slice.AiResult"))+"\n                ")]),t._v(" "),i("div",{class:{error:"error"==this.slice.bacillus.diagnosis}},[t._v("\n                    "+t._s(this.slice.bacillus.result.length||0)+"\n                ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),i("div",["error"!=t.slice.bacillus.diagnosis&&null!=t.slice.bacillus.diagnosis?i("div",[t._v("100"),i("span",[t._v("%")])]):t._e(),t._v(" "),"error"==t.slice.bacillus.diagnosis?i("div",[t._v("0")]):t._e()])]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.bacillus.computer,callback:function(e){t.$set(t.slice.bacillus,"computer",e)},expression:"slice.bacillus.computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[]};var $e=i("VU/8")(ke,xe,!1,function(t){i("CIQl"),i("Yd62")},"data-v-5c41a731",null).exports,Ie={data:()=>({}),methods:{getCount(t,e){return this.sRois[t.id]?this.sRois[t.id].filter(t=>t.type==e).length:0},checkall(){this.$emit("closecontextmenu");let t=this.ROIS.every(t=>!!t.image);this.ROIS.forEach(e=>this.$set(e,"image",!t))},change(t,e,i){this.$emit("closecontextmenu"),this.$set(t,"image",i)},del(t){this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})}},props:["ROIS","currentRois","sRois","slice"]},Oe={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"tctrois"},[t.ROIS?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),t.ROIS?i("div",{staticClass:"table"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:t.ROIS.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                    ROI\n                ")])]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.heterogeneousRegion")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.total")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.index")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.deleted")))])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.ROIS,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){t.$emit("closecontextmenu"),t.$emit("curROI",e,i.shiftKey)}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){i.stopPropagation(),t.change(e,"image",1-(e.image||0))}}}),t._v("\n                        "+t._s(s+1)+"\n                    ")])]),t._v(" "),i("div",[t._v(t._s(t.getCount(e,2)||"0"))]),t._v(" "),i("div",[t._v(t._s(t.getCount(e,1)+t.getCount(e,2)||"0"))]),t._v(" "),i("div",[t._v(t._s((t.getCount(e,2)/(t.getCount(e,1)+t.getCount(e,2)||1)*100).toFixed(1)+"%"))]),t._v(" "),i("div",[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])])}),0)]):t._e(),t._v(" "),t.ROIS?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                "+t._s(t.$t("slice.AiResult"))+"\n            ")]),t._v(" "),i("div",{class:{error:"error"==this.slice.er.diagnosis}},[t._v("\n                "+t._s((this.ROIS.filter(function(t){return t.image}).map(function(e){return t.getCount(e,2)}).reduce(function(t,e){return t+e},0)/(this.ROIS.filter(function(t){return t.image}).map(function(e){return t.getCount(e,1)+t.getCount(e,2)}).reduce(function(t,e){return t+e},0)||1)*100).toFixed(1)+"%")+"\n            ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),i("div",["error"!=t.slice.er.diagnosis&&null!=t.slice.er.diagnosis?i("div",[t._v("100"),i("span",[t._v("%")])]):t._e(),t._v(" "),"error"==t.slice.er.diagnosis?i("div",[t._v("0")]):t._e()])]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.er.computer,callback:function(e){t.$set(t.slice.er,"computer",e)},expression:"slice.er.computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e()])},staticRenderFns:[]};var Se=i("VU/8")(Ie,Oe,!1,function(t){i("yd85"),i("hJXG")},null,null).exports,Ae={data(){return{loopHandler:0,result:{},auto:!1,centerRegion:null,curRois:{},showbutton:!0,er_prAnno:null,labeltree:[{id:"prnegativetumor",label:"阴性肿瘤"},{id:"prnegativenormal",label:"阴性正常"},{id:"prpositiontumor",label:"阳性肿瘤"}],position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,addAnnRoi:!1,menuPosition:{},totalArea:"",showMppGuide:!1,drawMpp:null}},computed:{getCommonAnnotation(){var t=Object.values(this.curRois);return t[0]&&t.every(t=>t.jgResult)&&t.every(e=>e.jgResult==t[0].jgResult)?t[0].jgResult.split(",")[0]:""}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},mouseDown(t){this.er_prAnno=null},checkjgResult:t=>(""+t).split(",")[0],noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;!t||"grey"==t.color&&this.totalArea>5e5?(i=[],this.totalArea=0):t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"grey"==t.color?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t}))},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},clickDraw(t,e){var i=10,s=t.x,a=t.y,n={id:(Math.random()+"").substr(2,6),path:{x:[s-i,s+i,s+i,s-i],y:[a-i,a-i,a+i,a+i]},width:2,method:"rectangle"};this.slice.roilist=[...this.slice.roilist,n],e?Object.assign(this.curRois,{[n.id]:n}):this.curRois={[n.id]:n}},getArea(t){for(var e=0,i=0;i<t.x.length-2;i++){if(i+2<t.x.length)var s=[t.x[0],t.y[0]],a=[t.x[i+1],t.y[i+1]],n=[t.x[i+2],t.y[i+2]];e+=(Math.abs(s[0]*a[1])+Math.abs(a[0]*n[1])+Math.abs(n[0]*s[1])-Math.abs(s[0]*n[1])-Math.abs(a[0]*s[1])-Math.abs(n[0]*a[1]))/2}return e=Math.round(Math.abs(e)*Math.pow(this.slice.mppx||.242042,2))},draw(t){this.totalArea=this.getArea(t.path);for(var e=0;e<this.slice.er.result.length;e++)this.totalArea+=this.getArea(this.slice.er.result[e].path);if(t.id=(Math.random()+"").substr(2,6),"freepen"===t.method&&(t.simplify=5),this.auto){if(this.totalArea>5e5)return void this.$message({message:"ROI总面积不能大于0.5mm²",type:"warning"});t=Object.assign({},t,{image:""});var i=[...this.slice.er.result,t];this.$set(this.slice.er,"result",i)}else this.slice.roilist=[...this.slice.roilist,t]},clearSimplify(t){this.$set(this.slice,"roilist",this.slice.roilist.map(e=>(e.id===t.id&&(e.path.x=t.x,e.path.y=t.y,e.simplify&&delete e.simplify),e))),this.$set(this.slice.ki67,"result",this.slice.er.result.map(e=>(e.id===t.id&&(e.path.x=t.x,e.path.y=t.y,e.simplify&&delete e.simplify),e)))},async delCurRoi(t){let e={};for(var i of(t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),Object.keys(e)))6==i.length?(this.slice.er.result=this.slice.er.result.filter(t=>t.id!=i),delete this.slice.er.airesult[i]):this.slice.er.result.map(t=>{void 0!=this.slice.er.airesult[t.id]&&(this.slice.er.airesult[t.id]=this.slice.er.airesult[t.id].filter(t=>!e[t.id]))});this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id]),this.er_prAnno=!1},roiChanged(){for(var t in this.curRois)this.curRois[t]=Object.assign({},this.curRois[t]);var e=Object.assign({},this.curRois),i=Object.assign({},i,...Object.values(e).filter(t=>"grey"!=t.color).map(t=>({[t.id]:t})));this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var e=i[t.id];return e?(delete i[t.id],e):t}).concat(Object.values(i))),this.slice.er.result.map(t=>{this.slice.er.airesult[t.id]=(this.slice.er.airesult[t.id]||[]).filter(t=>!i[t.id])})},setAnnotation(t){var e;for(var i in this.er_prAnno=null,e="string"!=typeof t?t[0]+","+t[1]:t,this.curRois){let t=this.curRois[i];this.curRois[i]=Object.assign({},t,{jgResult:e,remark:e.split(",")[e.split(",").length-1]})}var s=Object.assign({},this.curRois),a=Object.assign({},a,...Object.values(s).filter(t=>"grey"!=t.color).map(t=>({[t.id]:t})));this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var e=a[t.id];return e?(delete a[t.id],e):t}).concat(Object.values(a))),this.slice.er.result.map(t=>{this.slice.er.airesult[t.id]=(this.slice.er.airesult[t.id]||[]).filter(t=>!a[t.id])})},showMenu(t,e){if((!t.type||t.button)&&(t.preventDefault(),0!=Object.keys(this.curRois).length&&!Object.keys(this.curRois).every(t=>t!=e.id)&&!this.slice.er.result.some(t=>t.id==e.id))){var i=t.currentTarget,s=t.offsetX,a=t.offsetY,n=i.offsetWidth,o=i.offsetHeight;this.er_prAnno={},this.er_prAnno.hd=s>n/2?"right":"left",this.er_prAnno.vd=a>o/2?"bottom":"top",this.menuPosition={x:s,y:a}}},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"er",other:JSON.stringify(this.slice.er.result.map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{this.lineup=t.data.rank,t.data.done?(this.showbutton=!0,this.loopHandler=0,-1!=t.data.rank?(this.flag="error",this.$set(this.slice.er,"diagnosis","error")):(Object.keys(t.data.result).filter(t=>!this.slice.er.result.find(e=>e.id==t)).map(e=>delete t.data.result[e]),this.slice.er.airesult=t.data.result,[].concat.apply([],Object.values(this.slice.er.airesult)).forEach(t=>t.id=(""+Math.random()).substr(2,8)),this.$set(this.slice.er,"diagnosis",1)),this.$set(this.slice,"type","er"),this.updateRecord()):(this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3))})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){0!=this.slice.er.result.length?(this.$set(this.slice.er,"airesult",{}),this.$set(this.slice.er,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,this.auto=!0,this.slice.er.result.map(t=>t.image=!0),Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.er.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"er",other:JSON.stringify(this.slice.er.result.map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()):this.$message({message:"请先绘制ROI,再进行处理",type:"warning"})},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"er",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.slice.er.result.map(t=>t.image=!1),this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},beforeMount(){this.slice.er||(this.$set(this.slice,"er",{}),this.$set(this.slice.er,"result",[]),this.$set(this.slice.er,"airesult",{})),this.slice.er&&!this.slice.er.airesult&&this.$set(this.slice.er,"airesult",{})},mounted(){this.slice.started&&this.slice.er&&null===this.slice.er.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},"slice.roilist":{handler(t){t.length>300&&(this.addAnnRoi=!0,setTimeout(()=>this.addAnnRoi=!1,2500),Object.values(this.curRois).map(t=>delete this.curRois[t.id]),t.pop())}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},props:["slice","record"],components:{"v-dragon":v.a,"v-analyroi":Se,"v-roi":f,"v-menus":_t}},Te={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt"},[i("div",{staticClass:"analyright",attrs:{tabIndex:0},on:{mousewheel:function(e){t.er_prAnno=null},keydown:t.keydown}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:(this.slice.er?this.slice.er.result:[]).map(function(t){return Object.assign({method:"rectangle"},t,{editable:!1,selectable:!1,color:"grey"})}).concat((this.slice.er?[].concat.apply([],Object.values(this.slice.er.airesult)):[]).map(function(t){return{id:t.id,path:{x:t.x,y:t.y},color:{0:"purple",1:"green",2:"red"}[t.type],method:"rectangle",editable:!0,selectable:!1,width:1}}),this.slice.roilist.map(function(e){return Object.assign({method:"rectangle"},e,{color:{prnegativetumor:"green",prnegativenormal:"purple",prpositiontumor:"red"}[t.checkjgResult(e.jgResult)]||"yellow"})})),curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},contextmenu:function(e,i){return t.showMenu(e,i)},clickDraw:t.clickDraw,roiChanged:t.roiChanged,mousedown:t.mouseDown,position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},clearSimplify:t.clearSimplify}},[t.er_prAnno?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+5+"px",top:t.menuPosition.y+5+"px"}},[i("v-menus",{attrs:{pos:t.er_prAnno,menus:t.labeltree,currentItem:t.getCommonAnnotation},on:{chosen:t.setAnnotation}})],1):t._e(),t._v(" "),t.addAnnRoi?i("div",{staticClass:"addannroi"},[t._v("标注roi数量不能超出300个")]):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist",on:{click:function(e){t.er_prAnno=null}}},[i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto?i("v-analyroi",{staticClass:"table",attrs:{slice:t.slice,ROIS:this.slice.er?this.slice.er.result:[],sRois:this.slice.er?this.slice.er.airesult:{},currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},closecontextmenu:function(e){t.er_prAnno=null}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[]};var Me=i("VU/8")(Ae,Te,!1,function(t){i("xFpc")},"data-v-65bc2d0f",null).exports,je={data:()=>({}),methods:{getCount(t,e){return this.sRois[t.id]?this.sRois[t.id].filter(t=>t.type==e).length:0},checkall(){this.$emit("closecontextmenu");let t=this.ROIS.every(t=>!!t.image);this.ROIS.forEach(e=>this.$set(e,"image",!t))},change(t,e,i){this.$emit("closecontextmenu"),this.$set(t,"image",i)},del(t){this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})}},props:["ROIS","currentRois","sRois","slice"]},Fe={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"tctrois"},[t.ROIS?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),t.ROIS?i("div",{staticClass:"table"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:t.ROIS.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                    ROI\n                ")])]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.heterogeneousRegion")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.total")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.index")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.deleted")))])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.ROIS,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){t.$emit("closecontextmenu"),t.$emit("curROI",e,i.shiftKey)}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){i.stopPropagation(),t.change(e,"image",1-(e.image||0))}}}),t._v("\n                        "+t._s(s+1)+"\n                    ")])]),t._v(" "),i("div",[t._v(t._s(t.getCount(e,2)||"0"))]),t._v(" "),i("div",[t._v(t._s(t.getCount(e,1)+t.getCount(e,2)||"0"))]),t._v(" "),i("div",[t._v(t._s((t.getCount(e,2)/(t.getCount(e,1)+t.getCount(e,2)||1)*100).toFixed(1)+"%"))]),t._v(" "),i("div",[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])])}),0)]):t._e(),t._v(" "),t.ROIS?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                "+t._s(t.$t("slice.AiResult"))+"\n            ")]),t._v(" "),i("div",{class:{error:"error"==this.slice.pr.diagnosis}},[t._v("\n                "+t._s((this.ROIS.filter(function(t){return t.image}).map(function(e){return t.getCount(e,2)}).reduce(function(t,e){return t+e},0)/(this.ROIS.filter(function(t){return t.image}).map(function(e){return t.getCount(e,1)+t.getCount(e,2)}).reduce(function(t,e){return t+e},0)||1)*100).toFixed(1)+"%")+"\n            ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),i("div",["error"!=t.slice.pr.diagnosis&&null!=t.slice.pr.diagnosis?i("div",[t._v("100"),i("span",[t._v("%")])]):t._e(),t._v(" "),"error"==t.slice.pr.diagnosis?i("div",[t._v("0")]):t._e()])]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.pr.computer,callback:function(e){t.$set(t.slice.pr,"computer",e)},expression:"slice.pr.computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e()])},staticRenderFns:[]};var Pe=i("VU/8")(je,Fe,!1,function(t){i("PVWf"),i("X3Zj")},null,null).exports,Ee={data(){return{loopHandler:0,result:{},auto:!1,centerRegion:null,curRois:{},showbutton:!0,er_prAnno:null,labeltree:[{id:"prnegativetumor",label:"阴性肿瘤"},{id:"prnegativenormal",label:"阴性正常"},{id:"prpositiontumor",label:"阳性肿瘤"}],position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,addAnnRoi:!1,menuPosition:{},totalArea:"",showMppGuide:!1,drawMpp:null}},computed:{getCommonAnnotation(){var t=Object.values(this.curRois);return t[0]&&t.every(t=>t.jgResult)&&t.every(e=>e.jgResult==t[0].jgResult)?t[0].jgResult.split(",")[0]:""}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},mouseDown(t){this.er_prAnno=null},checkjgResult:t=>(""+t).split(",")[0],noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;!t||"grey"==t.color&&this.totalArea>5e5?(i=[],this.totalArea=0):t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"grey"==t.color?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t}))},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},clickDraw(t,e){var i=10,s=t.x,a=t.y,n={id:(Math.random()+"").substr(2,6),path:{x:[s-i,s+i,s+i,s-i],y:[a-i,a-i,a+i,a+i]},width:2,method:"rectangle"};this.slice.roilist=[...this.slice.roilist,n],e?Object.assign(this.curRois,{[n.id]:n}):this.curRois={[n.id]:n}},getArea(t){for(var e=0,i=0;i<t.x.length-2;i++){if(i+2<t.x.length)var s=[t.x[0],t.y[0]],a=[t.x[i+1],t.y[i+1]],n=[t.x[i+2],t.y[i+2]];e+=(Math.abs(s[0]*a[1])+Math.abs(a[0]*n[1])+Math.abs(n[0]*s[1])-Math.abs(s[0]*n[1])-Math.abs(a[0]*s[1])-Math.abs(n[0]*a[1]))/2}return e=Math.round(Math.abs(e)*Math.pow(this.slice.mppx||.242042,2))},draw(t){this.totalArea=this.getArea(t.path);for(var e=0;e<this.slice.pr.result.length;e++)this.totalArea+=this.getArea(this.slice.pr.result[e].path);if(t.id=(Math.random()+"").substr(2,6),"freepen"===t.method&&(t.simplify=5),this.auto){if(this.totalArea>5e5)return void this.$message({message:"ROI总面积不能大于0.5mm²",type:"warning"});t=Object.assign({},t,{image:""});var i=[...this.slice.pr.result,t];this.$set(this.slice.pr,"result",i)}else this.slice.roilist=[...this.slice.roilist,t]},clearSimplify(t){this.$set(this.slice,"roilist",this.slice.roilist.map(e=>(e.id===t.id&&(e.path.x=t.x,e.path.y=t.y,e.simplify&&delete e.simplify),e))),this.$set(this.slice.pr,"result",this.slice.ki67.pr.map(e=>(e.id===t.id&&(e.path.x=t.x,e.path.y=t.y,e.simplify&&delete e.simplify),e)))},async delCurRoi(t){let e={};for(var i of(t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),Object.keys(e)))6==i.length?(this.slice.pr.result=this.slice.pr.result.filter(t=>t.id!=i),delete this.slice.pr.airesult[i]):this.slice.pr.result.map(t=>{void 0!=this.slice.pr.airesult[t.id]&&(this.slice.pr.airesult[t.id]=this.slice.pr.airesult[t.id].filter(t=>!e[t.id]))});this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id]),this.er_prAnno=!1},roiChanged(){for(var t in this.curRois)this.curRois[t]=Object.assign({},this.curRois[t]);var e=Object.assign({},this.curRois),i=Object.assign({},i,...Object.values(e).filter(t=>"grey"!=t.color).map(t=>({[t.id]:t})));this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var e=i[t.id];return e?(delete i[t.id],e):t}).concat(Object.values(i))),this.slice.pr.result.map(t=>{this.slice.pr.airesult[t.id]=(this.slice.pr.airesult[t.id]||[]).filter(t=>!i[t.id])})},setAnnotation(t){var e;for(var i in this.er_prAnno=null,e="string"!=typeof t?t[0]+","+t[1]:t,this.curRois){let t=this.curRois[i];this.curRois[i]=Object.assign({},t,{jgResult:e,remark:e.split(",")[e.split(",").length-1]})}var s=Object.assign({},this.curRois),a=Object.assign({},a,...Object.values(s).filter(t=>"grey"!=t.color).map(t=>({[t.id]:t})));this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var e=a[t.id];return e?(delete a[t.id],e):t}).concat(Object.values(a))),this.slice.pr.result.map(t=>{this.slice.pr.airesult[t.id]=(this.slice.pr.airesult[t.id]||[]).filter(t=>!a[t.id])})},showMenu(t,e){if((!t.type||t.button)&&(t.preventDefault(),0!=Object.keys(this.curRois).length&&!Object.keys(this.curRois).every(t=>t!=e.id)&&!this.slice.pr.result.some(t=>t.id==e.id))){var i=t.currentTarget,s=t.offsetX,a=t.offsetY,n=i.offsetWidth,o=i.offsetHeight;this.er_prAnno={},this.er_prAnno.hd=s>n/2?"right":"left",this.er_prAnno.vd=a>o/2?"bottom":"top",this.menuPosition={x:s,y:a}}},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"pr",other:JSON.stringify(this.slice.pr.result.map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{this.lineup=t.data.rank,t.data.done?(this.showbutton=!0,this.loopHandler=0,-1!=t.data.rank?(this.flag="error",this.$set(this.slice.pr,"diagnosis","error")):(Object.keys(t.data.result).filter(t=>!this.slice.pr.result.find(e=>e.id==t)).map(e=>delete t.data.result[e]),this.slice.pr.airesult=t.data.result,[].concat.apply([],Object.values(this.slice.pr.airesult)).forEach(t=>t.id=(""+Math.random()).substr(2,8)),this.$set(this.slice.pr,"diagnosis",1)),this.$set(this.slice,"type","pr"),this.updateRecord()):(this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3))})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){0!=this.slice.pr.result.length?(this.$set(this.slice.pr,"airesult",{}),this.$set(this.slice.pr,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,this.auto=!0,this.slice.pr.result.map(t=>t.image=!0),Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.pr.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"pr",other:JSON.stringify(this.slice.pr.result.map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()):this.$message({message:"请先绘制ROI,再进行处理",type:"warning"})},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"or",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.slice.pr.result.map(t=>t.image=!1),this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},beforeMount(){this.slice.pr||(this.$set(this.slice,"pr",{}),this.$set(this.slice.pr,"result",[]),this.$set(this.slice.pr,"airesult",{})),this.slice.pr&&!this.slice.pr.airesult&&this.$set(this.slice.pr,"airesult",{})},mounted(){this.slice.started&&this.slice.pr&&null===this.slice.pr.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},"slice.roilist":{handler(t){t.length>300&&(this.addAnnRoi=!0,setTimeout(()=>this.addAnnRoi=!1,2500),Object.values(this.curRois).map(t=>delete this.curRois[t.id]),t.pop())}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},props:["slice","record"],components:{"v-dragon":v.a,"v-analyroi":Pe,"v-roi":f,"v-menus":_t}},Le={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright",on:{mousewheel:function(e){t.er_prAnno=null}}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:(this.slice.pr?this.slice.pr.result:[]).map(function(t){return Object.assign({method:"rectangle"},t,{editable:!1,selectable:!1,color:"grey"})}).concat((this.slice.pr?[].concat.apply([],Object.values(this.slice.pr.airesult)):[]).map(function(t){return{id:t.id,path:{x:t.x,y:t.y},color:{0:"purple",1:"green",2:"red"}[t.type],method:"rectangle",editable:!0,selectable:!1,width:1}}),this.slice.roilist.map(function(e){return Object.assign({method:"rectangle"},e,{color:{prnegativetumor:"green",prnegativenormal:"purple",prpositiontumor:"red"}[t.checkjgResult(e.jgResult)]||"yellow"})})),curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},contextmenu:function(e,i){return t.showMenu(e,i)},clickDraw:t.clickDraw,roiChanged:t.roiChanged,mousedown:t.mouseDown,position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},clearSimplify:t.clearSimplify}},[t.er_prAnno?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+5+"px",top:t.menuPosition.y+5+"px"}},[i("v-menus",{attrs:{pos:t.er_prAnno,menus:t.labeltree,currentItem:t.getCommonAnnotation},on:{chosen:t.setAnnotation}})],1):t._e(),t._v(" "),t.addAnnRoi?i("div",{staticClass:"addannroi"},[t._v("标注roi数量不能超出300个")]):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist",on:{click:function(e){t.er_prAnno=null}}},[i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto?i("v-analyroi",{staticClass:"table",attrs:{slice:t.slice,ROIS:this.slice.pr?this.slice.pr.result:[],sRois:this.slice.pr?this.slice.pr.airesult:{},currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},closecontextmenu:function(e){t.er_prAnno=null}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[]};var De=i("VU/8")(Ee,Le,!1,function(t){i("vCUm")},"data-v-3d8f65e1",null).exports,He={data:()=>({}),methods:{getCount(t,e){return this.sRois[t.id]?this.sRois[t.id].filter(t=>t.type==e).length:0},checkall(){let t=this.ROIS.every(t=>!!t.image);this.ROIS.forEach(e=>this.$set(e,"image",!t))},change(t,e,i){this.$set(t,"image",i)},del(t){this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})}},props:["ROIS","currentRois","sRois","slice"]},ze={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"ck56-tctrois"},[t.ROIS.length?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),t.ROIS?i("div",{staticClass:"table"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:t.ROIS.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                    ROI\n                ")])]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.heterogeneousRegion")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.total")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.index")))]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.deleted")))])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.ROIS,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){return t.$emit("curROI",e,i.shiftKey)}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){i.stopPropagation(),t.change(e,"image",1-(e.image||0))}}}),t._v("\n                        "+t._s(s+1)+"\n                    ")])]),t._v(" "),i("div",[t._v(t._s(t.getCount(e,3)||"0"))]),t._v(" "),i("div",[t._v(t._s(t.getCount(e,1)+t.getCount(e,3)||"0"))]),t._v(" "),i("div",[t._v(t._s((t.getCount(e,3)/(t.getCount(e,1)+t.getCount(e,3)||1)*100).toFixed(1)+"%"))]),t._v(" "),i("div",[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])])}),0)]):t._e(),t._v(" "),t.ROIS?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                "+t._s(t.$t("slice.AiResult"))+"\n            ")]),t._v(" "),i("div",{class:{error:"error"==t.slice.ck56.diagnosis}},[t._v("\n                "+t._s((t.ROIS.filter(function(t){return t.image}).map(function(e){return t.getCount(e,3)}).reduce(function(t,e){return t+e},0)/(t.ROIS.filter(function(t){return t.image}).map(function(e){return t.getCount(e,1)+t.getCount(e,3)}).reduce(function(t,e){return t+e},0)||1)*100).toFixed(1)+"%")+"\n            ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),i("div",["error"!=t.slice.ck56.diagnosis&&null!=t.slice.ck56.diagnosis?i("div",[t._v("100"),i("span",[t._v("%")])]):t._e(),t._v(" "),"error"==t.slice.ck56.diagnosis?i("div",[t._v("0")]):t._e()])]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.ck56.computer,callback:function(e){t.$set(t.slice.ck56,"computer",e)},expression:"slice.ck56.computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e()])},staticRenderFns:[]};var Ne=i("VU/8")(He,ze,!1,function(t){i("TQNe"),i("Iiwt")},null,null).exports,Be={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,totalArea:"",showMppGuide:!1,drawMpp:null}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;!t||"grey"==t.color&&this.totalArea>5e5?(i=[],this.totalArea=0):t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"grey"==t.color?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t})),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},getArea(t){for(var e=0,i=0;i<t.x.length-2;i++){if(i+2<t.x.length)var s=[t.x[0],t.y[0]],a=[t.x[i+1],t.y[i+1]],n=[t.x[i+2],t.y[i+2]];e+=(Math.abs(s[0]*a[1])+Math.abs(a[0]*n[1])+Math.abs(n[0]*s[1])-Math.abs(s[0]*n[1])-Math.abs(a[0]*s[1])-Math.abs(n[0]*a[1]))/2}return e=Math.round(Math.abs(e)*Math.pow(this.slice.mppx||.242042,2))},draw(t){this.totalArea=this.getArea(t.path);for(var e=0;e<this.slice.ck56.result.length;e++)this.totalArea+=this.getArea(this.slice.ck56.result[e].path);if(t.id=(Math.random()+"").substr(2,6),this.auto){if(this.totalArea>5e5)return void this.$message({message:"ROI总面积不能大于0.5mm²",type:"warning"});t=Object.assign({},t,{image:""});var i=[...this.slice.ck56.result,t];this.$set(this.slice.ck56,"result",i)}else this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};for(var i of(t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),Object.keys(e)))6==i.length?(this.slice.ck56.result=this.slice.ck56.result.filter(t=>t.id!=i),delete this.slice.ck56.airesult[i]):this.slice.ck56.result.map(t=>{void 0!=this.slice.ck56.airesult[t.id]&&(this.slice.ck56.airesult[t.id]=this.slice.ck56.airesult[t.id].filter(t=>!e[t.id]))});this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"ck56",other:JSON.stringify(this.slice.ck56.result.map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{this.lineup=t.data.rank,t.data.done?(this.showbutton=!0,this.loopHandler=0,this.$set(this.slice,"type","ck56"),-1!=t.data.rank?(this.flag="error",this.$set(this.slice.ck56,"diagnosis","error")):(Object.keys(t.data.result).filter(t=>!this.slice.ck56.result.find(e=>e.id==t)).map(e=>delete t.data.result[e]),this.slice.ck56.airesult=t.data.result,[].concat.apply([],Object.values(this.slice.ck56.airesult)).forEach(t=>t.id=(""+Math.random()).substr(2,8)),this.$set(this.slice.ck56,"diagnosis",1)),this.updateRecord()):(this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3))})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){0!=this.slice.ck56.result.length?(this.$set(this.slice.ck56,"airesult",{}),this.$set(this.slice.ck56,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,this.auto=!0,this.slice.ck56.result.map(t=>t.image=!0),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"ck56",other:JSON.stringify(this.slice.ck56.result.map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()):this.$message({message:"请先绘制ROI,再进行处理",type:"warning"})},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"ck56",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.slice.ck56.result.map(t=>t.image=!1),this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},beforeMount(){this.slice.ck56||(this.$set(this.slice,"ck56",{}),this.$set(this.slice.ck56,"result",[]),this.$set(this.slice.ck56,"airesult",{})),this.slice.ck56&&!this.slice.ck56.airesult&&this.$set(this.slice.ck56,"airesult",{})},mounted(){this.slice.started&&this.slice.ck56&&null===this.slice.ck56.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},props:["slice","record"],components:{"v-dragon":v.a,"v-analyroi":Ne,"v-roi":f}},Ge={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright"},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:{"阳性肿瘤":"red"}[t.jgResult]||"yellow"})}).concat((this.slice.ck56?this.slice.ck56.result:[]).map(function(t){return Object.assign({method:"rectangle"},t,{editable:!1,selectable:!1,color:"grey"})}),(this.slice.ck56?[].concat.apply([],Object.values(this.slice.ck56.airesult)):[]).filter(function(t){return 0!=t.type}).filter(function(t){return 2!=t.type}).map(function(e){return{id:e.id,color:{0:"yellow",1:"green",2:"blue",3:"red"}[e.type],path:{x:[(e.x[0]+e.x[2])/2],y:[(e.y[0]+e.y[2])/2]},method:"spot",editable:!0,selectable:!1,radius:1/(t.slice.mppx||.242042)}})),curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto?i("v-analyroi",{staticClass:"table",attrs:{slice:t.slice,ROIS:this.slice.ck56?this.slice.ck56.result:[],sRois:this.slice.ck56?this.slice.ck56.airesult:{},currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[]};var Ue=i("VU/8")(Be,Ge,!1,function(t){i("O4Kg")},"data-v-9bc15a04",null).exports,Ve={data:()=>({index:0,options:[{value:"HER-2 0",label:"HER-2 0"},{value:"HER-2 1+",label:"HER-2 1+"},{value:"HER-2 2+",label:"HER-2 2+"},{value:"HER-2 3+",label:"HER-2 3+"}],checkResult:null}),methods:{changeResult(t){this.checkResult=t,this.$emit("update",t)},changeImage(t){this.$set(t,"image",1-(t.image||0)),this.$emit("roiChanged","image",[t])},checkall(){if(!this.ROIS.length)return;let t=this.ROIS.every(t=>!!t.image),e=this.ROIS.map(e=>{return{id:e.id,image:t?0:1}});this.$emit("roiChanged","image",e)},del(t){this.$emit("closecontextmenu"),this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})},totalRoi(t){return this.checkedRois.map(e=>e.aiResult[t][0]).reduce((t,e)=>t+e,0)}},mounted(){"her2"===this.slice.alg&&this.slice.check_result&&(this.checkResult=this.slice.check_result)},computed:{checkedRois(){return this.ROIS.filter(t=>t.image)},positiveTotal(){return this.checkedRois.map(t=>t.aiResult["肿瘤细胞总数"]).reduce((t,e)=>t+e,0)}},watch:{"slice.check_result":{handler(t){"her2"===this.slice.alg&&(this.checkResult=t)}}},props:["ROIS","currentRois","ave","slice"]},Ye={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"her2rois"},[t.ROIS?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),t.ROIS?i("div",{staticClass:"hertable"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:0==t.ROIS.length?"":t.ROIS.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                    ROI\n                ")])]),t._v(" "),i("div",{staticClass:"long"},[t._v("分级结果")]),t._v(" "),i("div",{staticClass:"option"},[t._v(t._s(t.$t("slice.deleted")))])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.ROIS,function(e,s){return i("div",{key:s},[i("div",{staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){t.$emit("closecontextmenu"),t.$emit("curROI",e,i.shiftKey)}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){return i.stopPropagation(),t.changeImage(e)}}}),t._v("\n                            "+t._s(e.aiResult.whole_slide?"全场图":s+1)+"\n                        ")])]),t._v(" "),i("div",{staticClass:"long"},[t._v(t._s(e.aiResult["分级结果"]))]),t._v(" "),i("div",{staticClass:"option"},[i("em",{staticClass:"eidt",attrs:{title:"详情"},on:{click:function(e){e.stopPropagation(),t.index===s?t.index=null:t.index=s}}}),t._v(" "),i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])]),t._v(" "),t.index===s?i("div",{staticClass:"roi-detail"},[i("p",[t._v("微弱的不完整膜阳性肿瘤细胞："+t._s(e.aiResult["微弱的不完整膜阳性肿瘤细胞"][0]))]),t._v(" "),i("p",[t._v("弱中等的完整膜阳性肿瘤细胞："+t._s(e.aiResult["弱中等的完整膜阳性肿瘤细胞"][0]))]),t._v(" "),i("p",[t._v("中强度的不完整膜阳性肿瘤细胞："+t._s(e.aiResult["中强度的不完整膜阳性肿瘤细胞"][0]))]),t._v(" "),i("p",[t._v("强度的完整膜阳性肿瘤细胞："+t._s(e.aiResult["强度的完整膜阳性肿瘤细胞"][0]))]),t._v(" "),i("p",[t._v("阳性肿瘤细胞："+t._s(e.aiResult["阳性肿瘤细胞"][0]))])]):t._e()])}),0)]):t._e(),t._v(" "),t.ROIS?i("div",{staticClass:"herbtm"},[i("table",[t._m(0),t._v(" "),i("tr",[t._m(1),t._v(" "),i("td",{staticStyle:{color:"#FFC1C1"},attrs:{width:"50"}},[t._v(t._s(t.totalRoi("微弱的不完整膜阳性肿瘤细胞")))]),t._v(" "),i("td",[t._v(t._s((t.totalRoi("微弱的不完整膜阳性肿瘤细胞")/(t.positiveTotal||1)*100).toFixed(2))+"%")])]),t._v(" "),i("tr",[t._m(2),t._v(" "),i("td",{staticStyle:{color:"#FC7915"},attrs:{width:"50"}},[t._v(t._s(t.totalRoi("弱中等的完整膜阳性肿瘤细胞")))]),t._v(" "),i("td",[t._v(t._s((t.totalRoi("弱中等的完整膜阳性肿瘤细胞")/(t.positiveTotal||1)*100).toFixed(2))+"%")])]),t._v(" "),i("tr",[t._m(3),t._v(" "),i("td",{staticStyle:{color:"#9974FE"},attrs:{width:"50"}},[t._v(t._s(t.totalRoi("中强度的不完整膜阳性肿瘤细胞")))]),t._v(" "),i("td",[t._v(t._s((t.totalRoi("中强度的不完整膜阳性肿瘤细胞")/(t.positiveTotal||1)*100).toFixed(2))+"%")])]),t._v(" "),i("tr",[t._m(4),t._v(" "),i("td",{staticStyle:{color:"#FF0000"},attrs:{width:"50"}},[t._v(t._s(t.totalRoi("强度的完整膜阳性肿瘤细胞")))]),t._v(" "),i("td",[t._v(t._s((t.totalRoi("强度的完整膜阳性肿瘤细胞")/(t.positiveTotal||1)*100).toFixed(2))+"%")])]),t._v(" "),i("tr",[t._m(5),t._v(" "),i("td",{attrs:{width:"50"}},[t._v(t._s(t.totalRoi("完整膜阳性肿瘤细胞")))]),t._v(" "),i("td",[t._v(t._s((t.totalRoi("完整膜阳性肿瘤细胞")/(t.positiveTotal||1)*100).toFixed(2))+"%")])]),t._v(" "),i("tr",[t._m(6),t._v(" "),i("td",{attrs:{width:"50"}},[t._v(t._s(t.totalRoi("阳性肿瘤细胞")))]),t._v(" "),i("td",[t._v(t._s((t.totalRoi("阳性肿瘤细胞")/(t.positiveTotal||1)*100).toFixed(2))+"%")])]),t._v(" "),i("tr",[t._m(7),t._v(" "),i("td",{staticStyle:{color:"#3D901F"},attrs:{width:"50"}},[t._v(t._s(this.checkedRois.map(function(t){return t.aiResult["阴性肿瘤细胞"]}).reduce(function(t,e){return t+e},0)))]),t._v(" "),i("td",[t._v("--")])]),t._v(" "),i("tr",[t._m(8),t._v(" "),i("td",{attrs:{width:"50"}},[t._v(t._s(t.positiveTotal))]),t._v(" "),i("td",[t._v("--")])]),t._v(" "),i("tr",[t._m(9),t._v(" "),i("td",{staticStyle:{color:"#A8FC8E"},attrs:{width:"50"}},[t._v(t._s(this.checkedRois.map(function(t){return t.aiResult["其他"]}).reduce(function(t,e){return t+e},0)))]),t._v(" "),i("td",[t._v("--")])])]),t._v(" "),i("div",{staticClass:"level"},[t._v("\n           HER-2分级："),i("span",[t._v(t._s(t.ave))])])]):t._e(),t._v(" "),i("div",{staticClass:"recheck"},[i("div",{staticClass:"doc-check"},[i("i",[t._v("医生复核")]),t._v(" "),i("span",{on:{click:function(e){return t.changeResult("")}}},[t._v("清空")]),t._v(" "),i("span",{on:{click:function(e){return t.changeResult(t.ave)}}},[t._v("采纳AI建议")])]),t._v(" "),i("div",{staticClass:"check-result"},[t._v("\n            请选择\n            "),i("el-select",{on:{change:t.changeResult},model:{value:t.checkResult,callback:function(e){t.checkResult=e},expression:"checkResult"}},t._l(t.options,function(t){return i("el-option",{key:t.value,attrs:{value:t.value,label:t.label}})}),1)],1)])])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("tr",[e("th",[this._v("细胞")]),e("th",[this._v("总数")]),e("th",[this._v("占肿瘤细胞")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("td",{attrs:{title:"微弱的不完整膜阳性肿瘤细胞"}},[e("div",{staticClass:"tolong"},[this._v("微弱的不完整膜阳性肿瘤细胞")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("td",{attrs:{title:"弱中等的完整膜阳性肿瘤细胞"}},[e("div",{staticClass:"tolong"},[this._v("弱中等的完整膜阳性肿瘤细胞")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("td",{attrs:{title:"中强度的不完整膜阳性肿瘤细胞"}},[e("div",{staticClass:"tolong"},[this._v("中强度的不完整膜阳性肿瘤细胞")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("td",{attrs:{title:"强度的完整膜阳性肿瘤细胞"}},[e("div",{staticClass:"tolong"},[this._v("强度的完整膜阳性肿瘤细胞")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("td",{attrs:{title:"完整膜阳性肿瘤细胞"}},[e("div",{staticClass:"tolong"},[this._v("完整膜阳性肿瘤细胞")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("td",{attrs:{title:"阳性肿瘤细胞"}},[e("div",{staticClass:"tolong"},[this._v("阳性肿瘤细胞")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("td",{attrs:{title:"阴性肿瘤细胞"}},[e("div",{staticClass:"tolong"},[this._v("阴性肿瘤细胞")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("td",{attrs:{title:"肿瘤细胞总数"}},[e("div",{staticClass:"tolong"},[this._v("肿瘤细胞总数")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("td",{attrs:{title:"其他"}},[e("div",{staticClass:"tolong"},[this._v("其他")])])}]};var Je=i("VU/8")(Ve,Ye,!1,function(t){i("O7j2"),i("YhIh")},null,null).exports,We={data:()=>({labeltree:[{id:1,label:"微弱的不完整膜阳性肿瘤细胞"},{id:2,label:"弱中等的完整膜阳性肿瘤细胞"},{id:3,label:"中强度的不完整膜阳性肿瘤细胞"},{id:4,label:"强度的完整膜阳性肿瘤细胞"},{id:7,label:"阴性肿瘤细胞"},{id:13,label:"其他",children:[{id:9,label:"组织细胞"},{id:10,label:"淋巴细胞"},{id:11,label:"纤维细胞"},{id:12,label:"其他非肿瘤细胞"}]}],roiTypeOpitions:{1:"#FFC1C1",2:"#FC7915",3:"#9974FE",4:"#FF0000",7:"#3D901F",9:"#A8FC8E",10:"#A8FC8E",11:"#A8FC8E",12:"#A8FC8E"},defaultColor:"#FFC1C1",defaultType:1}),computed:{ave(){let t=this.aiFatherRois.filter(t=>t.image),e=t.map(t=>t.aiResult["阳性肿瘤细胞"][0]).reduce((t,e)=>t+e,0),i=t.map(t=>t.aiResult["完整膜阳性肿瘤细胞"][0]).reduce((t,e)=>t+e,0),s=t.map(t=>t.aiResult["强度的完整膜阳性肿瘤细胞"][0]).reduce((t,e)=>t+e,0),a=t.map(t=>t.aiResult["微弱的不完整膜阳性肿瘤细胞"][0]).reduce((t,e)=>t+e,0),n=t.map(t=>t.aiResult["中强度的不完整膜阳性肿瘤细胞"][0]).reduce((t,e)=>t+e,0),o=t.map(t=>t.aiResult["弱中等的完整膜阳性肿瘤细胞"][0]).reduce((t,e)=>t+e,0),l=t.map(t=>t.aiResult["肿瘤细胞总数"]).reduce((t,e)=>t+e,0);return a>=s?o+=n:a+=n,n=0,s/l>.1?"HER-2 3+":i/l>.1&&s/l<.1||s/l>=.005&&s/l<=.1?"HER-2 2+":o/l>=.02&&o/l<=.1||(a+n)/l>.1&&i/l<=.1?"HER-2 1+":e/l<.01||(a+n)/l<=.1?"HER-2 0":void 0}},components:{"v-dragon":v.a,"v-analyroi":Je,"v-roi":f,"v-menus":X},mixins:[U]},Xe={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright",on:{mousewheel:function(e){t.ki67Anno=null},mousedown:function(e){t.ki67Anno=null}}},[i("v-dragon",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"osd",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:t.leftRoilist,curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:110,"element-loading-text":"处理中，请耐心等待","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.5)"},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},clickDraw:t.clickDraw,getRoi:function(e){return t.getRoi(e)},roiChanged:t.roiChanged,parentId:function(e){return t.parentId=e},contextmenu:function(e,i){return t.showMenu(e,i)}}},[t.ki67Anno?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+"px",top:t.menuPosition.y+"px"}},[i("v-menus",{attrs:{pos:t.ki67Anno,menus:t.labeltree,currentItem:t.currentItem,newover:t.newover},on:{chosen:function(e){return t.setAnnotation(e)}}})],1):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("div",{staticClass:"quality"},[t._m(0),t._v(" "),i("div",{staticClass:"quality-detail"},[i("p",[t._v("清 晰 度："+t._s(t.slice.clarity?(100*t.slice.clarity).toFixed(2)+"%":"-"))]),t._v(" "),i("p",[t._v("扫描倍数："+t._s(t.slice.objective_rate||"-"))])])]),t._v(" "),i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v("AI处理")]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v("手动处理")])]),t._v(" "),t.auto?i("v-analyroi",{staticClass:"table",attrs:{slice:t.slice,ROIS:t.aiFatherRois,ave:t.ave,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged,update:function(e){return t.reCheck(e)},closecontextmenu:function(e){t.ki67Anno=null}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.rightRoilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"title"},[e("span",[this._v("AI质控")])])}]};var qe=i("VU/8")(We,Xe,!1,function(t){i("3IMj")},"data-v-464ac65f",null).exports,Ke={data(){return{checkResult:this.slice.alg===this.slice.toolType&&this.slice.check_result.slice(0,this.slice.check_result.length-1)||null}},computed:{aiResult(){return this.ROIS[0].aiResult}},methods:{changeResult(t){this.checkResult=t,this.$emit("acceptAI",t)},changeImage(t){this.$set(t,"image",1-(t.image||0)),this.$emit("roiChanged","image",[t])},checkall(){if(!this.ROIS.length)return;let t=this.ROIS.every(t=>!!t.image),e=this.ROIS.map(e=>{return{id:e.id,image:t?0:1}});this.$emit("roiChanged","image",e)},del(t){this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})}},props:["ROIS","currentRois","slice","ave"]},Ze={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"pdl1rois"},[t.ROIS?i("div",{staticClass:"pal1table"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:0==t.ROIS.length?"":t.ROIS.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                    ROI\n                ")])]),t._v(" "),i("div",{staticClass:"long"},[t._v("阳性肿瘤")]),t._v(" "),i("div",{staticClass:"total"},[t._v(t._s(t.$t("slice.total")))]),t._v(" "),i("div",{staticClass:"tps"},[t._v("TPS")]),t._v(" "),i("div",{staticClass:"option"},[t._v(t._s(t.$t("slice.deleted")))])]),t._v(" "),i("div",{staticClass:"rois"},[t._l(t.ROIS,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){return t.$emit("curROI",e,i.shiftKey)}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){return i.stopPropagation(),t.changeImage(e)}}}),t._v("\n                        "+t._s(s+1)+"\n                    ")])]),t._v(" "),i("div",{staticClass:"long",attrs:{title:e.aiResult.pos_tumor}},[t._v(t._s(e.aiResult.pos_tumor))]),t._v(" "),i("div",{staticClass:"total",attrs:{title:e.aiResult.neg_tumor+e.aiResult.pos_tumor}},[t._v("\n                    "+t._s(e.aiResult.neg_tumor+e.aiResult.pos_tumor)+"\n                ")]),t._v(" "),i("div",{staticClass:"tps"},[t._v(t._s((100*e.aiResult.tps).toFixed(2)+"%")+"\n                ")]),t._v(" "),i("div",{staticClass:"option"},[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])])}),t._v(" "),t.ROIS.some(function(t){return t.aiResult.whole_slide})?i("div",{staticClass:"qure"},[i("div",{staticClass:"roi-detail",on:{click:function(e){return t.$emit("movetoCenter","lefttop")}}},[t._m(0),t._v(" "),i("div",{staticClass:"long",attrs:{title:t.aiResult[1].pos_tumor}},[t._v(t._s(t.aiResult[1].pos_tumor))]),t._v(" "),i("div",{staticClass:"total",attrs:{title:t.aiResult[1].pos_tumor+t.aiResult[1].neg_tumor}},[t._v("\n                        "+t._s(t.aiResult[1].pos_tumor+t.aiResult[1].neg_tumor)+"\n                    ")]),t._v(" "),i("div",{staticClass:"tps"},[t._v(t._s((t.aiResult[1].pos_tumor/(t.aiResult[1].pos_tumor+t.aiResult[1].neg_tumor||1)*100).toFixed(2)+"%"))]),t._v(" "),i("div",{staticClass:"option"})]),t._v(" "),i("div",{staticClass:"roi-detail",on:{click:function(e){return t.$emit("movetoCenter","righttop")}}},[t._m(1),t._v(" "),i("div",{staticClass:"long",attrs:{title:t.aiResult[2].pos_tumor}},[t._v(t._s(t.aiResult[2].pos_tumor))]),t._v(" "),i("div",{staticClass:"total",attrs:{title:t.aiResult[2].pos_tumor+t.aiResult[2].neg_tumor}},[t._v("\n                        "+t._s(t.aiResult[2].pos_tumor+t.aiResult[2].neg_tumor)+"\n                    ")]),t._v(" "),i("div",{staticClass:"tps"},[t._v(t._s((t.aiResult[2].pos_tumor/(t.aiResult[2].pos_tumor+t.aiResult[2].neg_tumor||1)*100).toFixed(2)+"%"))]),t._v(" "),i("div",{staticClass:"option"})]),t._v(" "),i("div",{staticClass:"roi-detail",on:{click:function(e){return t.$emit("movetoCenter","leftbottom")}}},[t._m(2),t._v(" "),i("div",{staticClass:"long",attrs:{title:t.aiResult[3].pos_tumor}},[t._v(t._s(t.aiResult[3].pos_tumor))]),t._v(" "),i("div",{staticClass:"total",attrs:{title:t.aiResult[3].pos_tumor+t.aiResult[3].neg_tumor}},[t._v("\n                        "+t._s(t.aiResult[3].pos_tumor+t.aiResult[3].neg_tumor)+"\n                    ")]),t._v(" "),i("div",{staticClass:"tps"},[t._v(t._s((t.aiResult[3].pos_tumor/(t.aiResult[3].pos_tumor+t.aiResult[3].neg_tumor||1)*100).toFixed(2)+"%"))]),t._v(" "),i("div",{staticClass:"option"})]),t._v(" "),i("div",{staticClass:"roi-detail",on:{click:function(e){return t.$emit("movetoCenter","rightbottom")}}},[t._m(3),t._v(" "),i("div",{staticClass:"long",attrs:{title:t.aiResult[4].pos_tumor}},[t._v(t._s(t.aiResult[4].pos_tumor))]),t._v(" "),i("div",{staticClass:"total",attrs:{title:t.aiResult[4].pos_tumor+t.aiResult[4].neg_tumor}},[t._v("\n                        "+t._s(t.aiResult[4].pos_tumor+t.aiResult[4].neg_tumor)+"\n                    ")]),t._v(" "),i("div",{staticClass:"tps"},[t._v(t._s((t.aiResult[4].pos_tumor/(t.aiResult[4].pos_tumor+t.aiResult[4].neg_tumor||1)*100).toFixed(2)+"%"))]),t._v(" "),i("div",{staticClass:"option"})])]):t._e()],2)]):t._e(),t._v(" "),t.ROIS?i("div",{staticClass:"pdl1btm"},[i("div",{staticClass:"result",staticStyle:{color:"red"}},[i("div",[t._v("\n                阳性肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.pos_tumor}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result",staticStyle:{color:"green"}},[i("div",[t._v("\n                阴性肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.neg_tumor}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result",staticStyle:{color:"yellow"}},[i("div",[t._v("\n                阳性非肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.pos_norm}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result",staticStyle:{color:"#9117d0"}},[i("div",[t._v("\n                阴性非肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.neg_norm}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result"},[i("div",[t._v("\n                细胞总数\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.total}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result"},[i("div",[t._v("\n                TPS\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ave)+"%\n            ")])])]):t._e(),t._v(" "),i("div",{staticClass:"recheck"},[i("div",{staticClass:"doc-check"},[i("i",[t._v("医生复核")]),t._v(" "),i("span",{on:{click:function(e){return t.changeResult("")}}},[t._v("清空")]),t._v(" "),i("span",{on:{click:function(e){return t.changeResult(t.ave)}}},[t._v("采纳AI建议")])]),t._v(" "),i("div",{staticClass:"check-result"},[t._v("指数"),i("input",{directives:[{name:"model",rawName:"v-model",value:t.checkResult,expression:"checkResult"}],domProps:{value:t.checkResult},on:{blur:function(e){return t.changeResult(t.checkResult)},input:function(e){e.target.composing||(t.checkResult=e.target.value)}}}),t._v("%")])])])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"left"},[e("div",[this._v("1象限")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"left"},[e("div",[this._v("2象限")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"left"},[e("div",[this._v("3象限")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"left"},[e("div",[this._v("4象限")])])}]};var Qe=i("VU/8")(Ke,Ze,!1,function(t){i("Re+S"),i("kqDl")},null,null).exports,ti={data:()=>({labeltree:[{id:3,label:"阳性肿瘤"},{id:1,label:"阴性肿瘤"},{id:2,label:"阳性非肿瘤"},{id:0,label:"阴性非肿瘤"}],roiTypeOpitions:{0:"purple",2:"yellow",3:"red",1:"green"},defaultColor:"red",defaultType:3,moveStatus:"countEnd",isMaxlvl:!1,screenCount:[],curCount:{}}),methods:{movetoCenter(t){let e=this.slice.width/this.slice.height,i=this.$refs.osd;switch(t){case"lefttop":i.move(.25,.25/e,Math.min(i.offsetHeight/i.offsetWidth*e*2,2));break;case"righttop":i.move(.75,.25/e,Math.min(i.offsetHeight/i.offsetWidth*e*2,2));break;case"leftbottom":i.move(.25,.75/e,Math.min(i.offsetHeight/i.offsetWidth*e*2,2));break;case"rightbottom":i.move(.75,.75/e,Math.min(i.offsetHeight/i.offsetWidth*e*2,2))}},changeMoveStatus(t){this.moveStatus=t,"moveEnd"==t&&this.slice.ai_suggest&&this.getScreenCount()},getScreenCount(){Object(s.b)(`slice/getScreenCount?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,position:JSON.stringify(this.curLevel),ai_type:"pdl1"}).then(({data:t})=>{this.isMaxlvl=t.isMaxlvl,this.moveStatus="countEnd",!t.isMaxlvl&&this.fullField?this.screenCount=Object.values(t.result):this.curCount=t.result})}},computed:{fullField(){return this.aiFatherRois.some(t=>t.aiResult.whole_slide)},ave(){return(this.aiFatherRois.filter(t=>t.image).map(t=>t.aiResult.pos_tumor).reduce((t,e)=>t+e,0)/((this.aiFatherRois.filter(t=>t.image).map(t=>t.aiResult.pos_tumor).reduce((t,e)=>t+e,0)||0)+this.aiFatherRois.filter(t=>t.image).map(t=>t.aiResult.neg_tumor).reduce((t,e)=>t+e,0)||1)*100).toFixed(2)}},props:["slice","record"],components:{"v-dragon":v.a,"v-analyroi":Qe,"v-roi":f,"v-menus":X},mixins:[U]},ei={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright",class:{showall:t.fullField&&!t.isMaxlvl},on:{mousewheel:function(e){t.ki67Anno=null},mousedown:function(e){t.ki67Anno=null}}},[i("v-dragon",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"osd",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:t.leftRoilist,curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,moveStatus:t.moveStatus,position:t.position,showMppGuide:t.showMppGuide,cellArea:110,"element-loading-text":"处理中，请耐心等待","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.5)"},on:{changeMoveStatus:t.changeMoveStatus,curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},clickDraw:t.clickDraw,getRoi:t.getRoi,roiChanged:t.roiChanged,parentId:function(e){return t.parentId=e},contextmenu:function(e,i){return t.showMenu(e,i)}}},[t.ki67Anno?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+"px",top:t.menuPosition.y+"px"}},[i("v-menus",{attrs:{pos:t.ki67Anno,menus:t.labeltree,currentItem:t.currentItem,newover:t.newover},on:{chosen:t.setAnnotation}})],1):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e(),t._v(" "),t.fullField&&!t.isMaxlvl?i("div",t._l(t.screenCount,function(e,s){return i("div",{key:s,staticClass:"tps",class:{lefttop:0==s,righttop:1==s,leftbottom:2==s,rightbottom:3==s}},[i("p",[t._v("阳性肿瘤细胞："),"countEnd"==t.moveStatus?i("span",{staticClass:"red"},[t._v(t._s(e.pos_tumor))]):t._e()]),t._v(" "),i("p",[t._v("TPS："),"countEnd"==t.moveStatus?i("span",[t._v(t._s((e.pos_tumor/(e.pos_tumor+e.neg_tumor||1)*100).toFixed(2))+"%")]):t._e()]),t._v(" "),"countEnd"!=t.moveStatus?i("div",{staticClass:"start",class:{end:"moveEnd"==t.moveStatus}}):t._e()])}),0):t._e(),t._v(" "),(t.isMaxlvl&&t.fullField||!t.fullField)&&t.slice.ai_suggest?i("div",{staticClass:"tps btmcenter"},[i("p",[t._v("阳性肿瘤细胞："),"countEnd"==t.moveStatus?i("span",{staticClass:"red"},[t._v(t._s(t.curCount.pos_tumor))]):t._e()]),t._v(" "),i("p",[t._v("TPS："),"countEnd"==t.moveStatus?i("span",[t._v(t._s((t.curCount.pos_tumor/(t.curCount.pos_tumor+t.curCount.neg_tumor||1)*100).toFixed(2))+"%")]):t._e()]),t._v(" "),"countEnd"!=t.moveStatus?i("div",{staticClass:"start",class:{end:"moveEnd"==t.moveStatus}}):t._e()]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("div",{staticClass:"quality"},[t._m(0),t._v(" "),i("div",{staticClass:"quality-detail"},[i("p",[t._v("清 晰 度："+t._s(t.slice.clarity?(100*t.slice.clarity).toFixed(2)+"%":"-"))]),t._v(" "),i("p",[t._v("扫描倍数："+t._s(t.slice.objective_rate||"-"))])])]),t._v(" "),i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v("AI处理")]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto?i("v-analyroi",{staticClass:"table",attrs:{slice:t.slice,ROIS:t.aiFatherRois,ave:t.ave,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged,movetoCenter:t.movetoCenter,acceptAI:function(e){return t.reCheck(e?e+"%":"")}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.rightRoilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"title"},[e("span",[this._v("AI质控")])])}]};var ii=i("VU/8")(ti,ei,!1,function(t){i("vTgc")},"data-v-8fb01f9e",null).exports,si={data:()=>({}),computed:{totalTps(){return this.ROIS.filter(t=>t.image).map(t=>this.getCount(t,"positive")).reduce((t,e)=>t+e,0)/(this.ROIS.filter(t=>t.image).map(t=>this.getCount(t,"positive")).reduce((t,e)=>t+e,0)+this.ROIS.filter(t=>t.image).map(t=>this.getCount(t,"negative")).reduce((t,e)=>t+e,0)||1)*100}},methods:{getCount(t,e){return this.sRois[t.id]&&this.sRois[t.id][e]?this.sRois[t.id][e]:0},checkall(){let t=this.ROIS.every(t=>!!t.image);this.ROIS.forEach(e=>this.$set(e,"image",!t)),this.$emit("closecontextmenu")},change(t,e,i){this.$emit("closecontextmenu"),this.$set(t,"image",i)},del(t){this.$emit("closecontextmenu"),this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})}},props:["showbutton","ROIS","currentRois","sRois","slice"]},ai={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"tctrois"},[t.ROIS?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),t.ROIS?i("div",{staticClass:"pal1table"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:0==t.ROIS.length?"":t.ROIS.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                    ROI\n                ")])]),t._v(" "),i("div",{staticClass:"long"},[t._v("阳性肿瘤")]),t._v(" "),i("div",{staticClass:"total"},[t._v(t._s(t.$t("slice.total")))]),t._v(" "),i("div",{staticClass:"tps"},[t._v("TPS")]),t._v(" "),i("div",{staticClass:"option"},[t._v(t._s(t.$t("slice.deleted")))])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.ROIS,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){t.$emit("closecontextmenu"),t.$emit("curROI",e,i.shiftKey)}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){i.stopPropagation(),t.change(e,"image",1-(e.image||0))}}}),t._v("\n                        "+t._s(s+1)+"\n                    ")])]),t._v(" "),i("div",{staticClass:"long",attrs:{title:t.getCount(e,"positive")||"0"}},[t._v(t._s(t.getCount(e,"positive")||"0"))]),t._v(" "),i("div",{staticClass:"total",attrs:{title:t.getCount(e,"positive")+t.getCount(e,"negative")||"0"}},[t._v("\n                    "+t._s(t.getCount(e,"positive")+t.getCount(e,"negative")||"0")+"\n                ")]),t._v(" "),i("div",{staticClass:"tps"},[t._v(t._s((t.getCount(e,"positive")/(t.getCount(e,"positive")+t.getCount(e,"negative")||1)*100).toFixed(1)+"%")+"\n                ")]),t._v(" "),i("div",{staticClass:"option"},[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])])}),0)]):t._e(),t._v(" "),t.ROIS?i("div",{staticClass:"pdl1btm"},[i("div",{staticClass:"result",staticStyle:{color:"red"}},[i("div",[t._v("\n                阳性肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(e){return t.getCount(e,"positive")}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result",staticStyle:{color:"green"}},[i("div",[t._v("\n                阴性肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(e){return t.getCount(e,"negative")}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result",staticStyle:{color:"yellow"}},[i("div",[t._v("\n                阳性非肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(e){return t.getCount(e,"positivenon")}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result",staticStyle:{color:"#9117d0"}},[i("div",[t._v("\n                阴性非肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(e){return t.getCount(e,"negativenon")}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result"},[i("div",[t._v("\n                细胞总数\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(e){return t.getCount(e,"total")}).reduce(function(t,e){return t+e},0)||0)+"\n            ")])]),t._v(" "),i("div",{staticClass:"result"},[i("div",[t._v("\n                TPS\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.totalTps.toFixed(1)+"%")+"\n            ")])])]):t._e()])},staticRenderFns:[]};var ni=i("VU/8")(si,ai,!1,function(t){i("Ro5g"),i("8ZfD")},null,null).exports;let oi;var li={data(){return{loopHandler:0,result:{},auto:!0,centerRegion:null,curRois:{},showbutton:!0,ki67Anno:null,labeltree:[{id:"positive",label:"阳性肿瘤"},{id:"negative",label:"阴性肿瘤"},{id:"positivenon",label:"阳性非肿瘤"},{id:"negativenon",label:"阴性非肿瘤"}],position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,addAnnRoi:!1,menuPosition:{},showMppGuide:!1,drawMpp:null,viewport:null,parentId:null}},computed:{getCommonAnnotation(){var t=Object.values(this.curRois);return t[0]&&t.every(t=>t.jgResult)&&t.every(e=>e.jgResult==t[0].jgResult)?t[0].jgResult.split(",")[0]:""}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:!this.slice.pdl1_sp236.result.length&&!this.slice.pdl1_sp236.result.filter(t=>t.image).length||this.slice.pdl1_sp236.pdl1_allresult.length?this.$confirm("未勾选任意roi，是否进行全片分析",{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.startAnalyze("pdl1_sp263all"),this.slice.pdl1_sp236.pdl1_allresult.length&&this.delCurRoi(this.slice.pdl1_sp236.result[0])}).catch(t=>{}):this.startAnalyze("pdl1_sp263roi")},canceltesk(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/revokeTask",{caseid:t,fileid:e,filename:i,type:this.slice.pdl1_sp236.type,other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},startAnalyze(t,e=this.record.id,i=this.slice.id,a=this.slice.filename){this.$set(this.slice.pdl1_sp236,"diagnosis",null),this.$set(this.slice.pdl1_sp236,"type",t),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,this.auto=!0,Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.pdl1_sp236.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:e,fileid:i,filename:a,type:t,other:JSON.stringify(this.slice.pdl1_sp236.result.filter(t=>t.image).map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>this.getAlgorithmResult()).catch(t=>console.log(t)),this.updateRecord()},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:this.slice.pdl1_sp236.type,other:JSON.stringify(this.slice.pdl1_sp236.result.filter(t=>t.image).map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.$set(this.slice,"type","pdl1_sp236"),-1!=t.data.rank)this.flag="error",this.$set(this.slice.pdl1_sp236,"diagnosis","error");else{let a;if("pdl1_sp263roi"===this.slice.pdl1_sp236.type){Object.keys(t.data.result).filter(t=>!this.slice.pdl1_sp236.result.find(e=>e.id==t)).map(e=>delete t.data.result[e]);let e=Object.assign({},this.slice.pdl1_sp236.airesult);for(let i in t.data.result)e[i]=t.data.result[i];[].concat.apply([],Object.values(e)).forEach(t=>{t.display=!1,t.cell.forEach(t=>{t.id||(t.id=(""+Math.random()).substr(2,8))})}),this.$set(this.slice.pdl1_sp236,"airesult",e);let i=0,s=0;for(let e in t.data.result)i+=t.data.result[e].positive,s+=t.data.result[e].positive+t.data.result[e].negative;a=(i/(s||1)*100).toFixed(1)}if("pdl1_sp263all"===this.slice.pdl1_sp236.type){var e={};e.id=(Math.random()+"").substr(2,6),e=Object.assign({},e,{image:1},{method:"maskArea"},{path:{x:[],y:[]}});var i=[...this.slice.pdl1_sp236.result,e];this.$set(this.slice.pdl1_sp236,"result",i);let n=Object.assign({},this.slice.pdl1_sp236.airesult);n[i[0].id]=t.data.result,n[i[0].id].isDisplayCell=!0,n[i[0].id].display=!0,this.$set(this.slice.pdl1_sp236,"airesult",JSON.parse(JSON.stringify(n).replace(/contours/g,"cell")));var s=[];t.data.result.contours.forEach((t,e)=>{var i={};i.id=(Math.random()+"").substr(2,6),i=Object.assign({},i,{image:1},{strokeWidth:0},{path:{x:[],y:[]}}),t.map(t=>{i.path.x.push(t.x),i.path.y.push(t.y)}),s.push(i)}),this.$set(this.slice.pdl1_sp236,"pdl1_allresult",s),a=(t.data.result.positive/(t.data.result.positive+t.data.result.negative||1)*100).toFixed(1)}this.$set(this.slice.pdl1_sp236,"diagnosis",1),0===this.record.slices.indexOf(this.slice)&&(this.record.analy="TPS: "+a+"%")}this.updateRecord()}else this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3)})},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[];let s=this.slice.pdl1_sp236.airesult,a=this.slice.pdl1_sp236.result;if(t&&a.some(e=>e.id===t.id)){for(let t in s)s[t].display=!1,s[t].cell.map(t=>{this.curRois[t.id]&&delete this.curRois[t.id]});s[t.id]&&(s[t.id].isDisplayCell?s[t.id].display=!0:this.$message({message:"由于细胞数过多，为避免卡顿，已对结果进行优化隐藏，可框选小roi进行结果预览标注",type:"warning"}))}this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"grey"==t.color||"spot"==t.method?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t}))},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},clickDraw(t,e){var i,s=t.x,a=t.y;if(i=void 0!=oi?{id:(Math.random()+"").substr(2,9),path:{x:[s],y:[a]},method:"spot",remark:oi.split(",")[1],jgResult:oi.split(",")[0]}:{id:(Math.random()+"").substr(2,9),path:{x:[s],y:[a]},method:"spot"}){let t={positive:2,negative:0,positivenon:3,negativenon:1},s={2:"positive",0:"negative",3:"positivenon",1:"negativenon"},a=(i.path.x[0],i.path.y[0],{id:i.id,x:i.path.x[0].toFixed(2),y:i.path.y[0].toFixed(2),type:oi?t[oi.split(",")[0]]:2}),n=this.slice.pdl1_sp236.airesult,o=this.slice.pdl1_sp236.result.find(t=>t.id===this.parentId);if(o){if(!n[o.id])return void this.$message({message:"欲进行标注操作，请选中已分析过的roi框",type:"warning"});if(!n[o.id].display)return void(n[o.id].isDisplayCell?this.$message({message:"欲进行标注操作，请选中已分析过的roi框",type:"warning"}):this.$message({message:"由于细胞数过多，为避免卡顿，已对结果进行优化隐藏，可框选小roi进行结果预览标注",type:"warning"}));n[o.id].cell.push(a),n[o.id].total+=1,n[o.id][s[a.type]]+=1;i.color=["green","purple","red","yellow"][a.type],e?Object.assign(this.curRois,{[i.id]:i}):this.curRois={[i.id]:i}}}},draw(t){if(this.auto){t.id=(Math.random()+"").substr(2,6),t=Object.assign({},t,{image:1});var e=[...this.slice.pdl1_sp236.result,t];this.$set(this.slice.pdl1_sp236,"result",e)}else t.id=(Math.random()+"").substr(2,9),this.slice.roilist=[...this.slice.roilist,t];this.slice.pdl1_sp236.pdl1_allresult.length&&(this.$message({message:"进行roi框选分析之前请先删除全场图分析结果",type:"warning"}),setTimeout(()=>{this.delCurRoi(t)},200))},async delCurRoi(t){if(Object.values(this.curRois)[0]&&"maskArea"===Object.values(this.curRois)[0].method)await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.$set(this.slice.pdl1_sp236,"result",[]),this.$set(this.slice.pdl1_sp236,"pdl1_allresult",[]),this.$set(this.slice.pdl1_sp236,"airesult",{}),this.curRois={};else{let i={},s=this.slice.pdl1_sp236.airesult;for(var e of(t?(i={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(this.ki67Anno=null,i=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),Object.keys(i)))if(6==e.length)this.slice.pdl1_sp236.result=this.slice.pdl1_sp236.result.filter(t=>t.id!=e),delete s[e],t&&"maskArea"===t.method&&this.$set(this.slice.pdl1_sp236,"pdl1_allresult",[]);else{let t={red:"positive",green:"negative",yellow:"positivenon",purple:"negativenon"};this.slice.pdl1_sp236.result.map(e=>{if(void 0!=s[e.id]){if(s[e.id].cell.some(t=>i[t.id]))for(let a in i)s[e.id].total-=1,s[e.id][t[i[a].color]]-=1;s[e.id].cell=s[e.id].cell.filter(t=>!i[t.id])}})}this.slice.roilist=this.slice.roilist.filter(t=>!i[t.id])}},roiChanged(){for(var t in this.curRois)this.curRois[t]=Object.assign({},this.curRois[t]);var e=Object.assign({},this.curRois),i=Object.assign({},i,...Object.values(e).filter(t=>"grey"!=t.color&&"spot"!=t.method).map(t=>({[t.id]:t})));this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var e=i[t.id];return e?(delete i[t.id],e):t}).concat(Object.values(i))),this.slice.pdl1_sp236.result.map(t=>{i[t.id]&&(this.slice.pdl1_sp236.airesult[t.id]=(this.slice.pdl1_sp236.airesult[t.id]||[]).filter(t=>!i[t.id]))})},setAnnotation(t){if(this.ki67Anno=null,"下载Roi"==t[0]){let t=Object.values(this.curRois)[0].path,n={};if(t.x.length<=4)n[0]=[],n[1]=[],n[0].push(t.x[0]),n[0].push(t.y[0]),n[1].push(t.x[2]),n[1].push(t.y[2]);else{n[0]=[],n[1]=[];var e=Math.max.apply(Math,t.x),i=Math.min.apply(Math,t.x),s=Math.max.apply(Math,t.y),a=Math.min.apply(Math,t.y);n[0].push(i),n[0].push(a),n[1].push(e),n[1].push(s)}return void window.open("/aipath/api/files/screenshot?caseid="+this.record.id+"&fileid="+this.slice.id+"&filename="+encodeURIComponent(this.slice.filename)+"&roi=[["+n[0][0]+","+n[0][1]+"],["+n[1][0]+","+n[1][1]+"]] &roiid="+Object.keys(this.curRois)[0])}var n;for(var o in n="string"!=typeof t?t[0]+","+t[1]:t,this.curRois){let t=this.curRois[o];this.curRois[o]=Object.assign({},t,{jgResult:n,remark:n.split(",")[n.split(",").length-1]})}oi=n;var l=Object.assign({},this.curRois);let r={positive:2,negative:0,positivenon:3,negativenon:1},c={2:"positive",0:"negative",3:"positivenon",1:"negativenon"};var h=Object.assign({},h,...Object.values(l).filter(t=>"grey"!=t.color).map(t=>({[t.id]:t})));let u=this.slice.pdl1_sp236.airesult;this.slice.pdl1_sp236.result.map(t=>{u[t.id]&&(u[t.id].cell||[]).forEach(e=>{if(h[e.id]){let i=c[e.type],s=c[r[oi.split(",")[0]]];u[t.id][i]-=1,u[t.id][s]||(u[t.id][s]=0),u[t.id][s]+=1,e.type=r[oi.split(",")[0]]}})}),this.curRois={}},showMenu(t,e){if((!t.type||t.button)&&(t.preventDefault(),"maskArea"!==e.method&&!(0==Object.keys(this.curRois).length||Object.keys(this.curRois).every(t=>t!=e.id)||this.slice.pdl1_sp236.result.some(t=>t.id==e.id)||this.slice.roilist.some(t=>t.id==e.id)))){var i=t.currentTarget,s=t.offsetX,a=t.offsetY,n=i.offsetWidth,o=i.offsetHeight;this.ki67Anno={},this.ki67Anno.hd=s>n/2?"right":"left",this.ki67Anno.vd=a>o/2?"bottom":"top",this.menuPosition={x:s,y:a}}},keydown(t){if("Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi(),"M"===t.key||"m"===t.key){var e=prompt("输入坐标字符串",'{"x":[54272, 55296, 55296, 54272],"y":[30720, 30720, 31744, 31744]}');e&&this.draw({color:"grey",method:"rectangle",path:JSON.parse(e)})}},checkjgResult:t=>(""+t).split(",")[0],noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")}},beforeMount(){this.slice.pdl1_sp236||(this.$set(this.slice,"pdl1_sp236",{}),this.$set(this.slice.pdl1_sp236,"result",[]),this.$set(this.slice.pdl1_sp236,"pdl1_allresult",[]),this.$set(this.slice.pdl1_sp236,"airesult",{})),this.slice.pdl1_sp236&&!this.slice.pdl1_sp236.airesult&&this.$set(this.slice.pdl1_sp236,"airesult",{});let t=[];this.slice.roilist.forEach(e=>{const i=t.findIndex(t=>e.id===t.id);-1!==i?t[i].value=t[i].value+e.value:t.push(e)}),this.slice.roilist=t},mounted(){this.slice.started&&this.slice.pdl1_sp236&&null===this.slice.pdl1_sp236.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},"slice.roilist":{handler(t){t.filter(t=>!!t.jgResult).length>1500&&(this.addAnnRoi=!0,setTimeout(()=>this.addAnnRoi=!1,2500),Object.values(this.curRois).map(t=>delete this.curRois[t.id]),t.pop())}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.slice.pdl1_sp236.result.length||this.slice.pdl1_sp236.result.filter(t=>t.image).length?this.startAnalyze("pdl1_sp263roi"):this.$confirm("未勾选任意roi，是否进行全片分析",{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.startAnalyze("pdl1_sp263all")}).catch(t=>{}))}}},props:["slice","record"],components:{"v-menus":_t,"v-dragon":v.a,"v-analyroi":ni,"v-roi":f}},ri={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright",on:{mousewheel:function(e){t.ki67Anno=null},mousedown:function(e){t.ki67Anno=null}}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})}).concat((this.slice.pdl1_sp236?this.slice.pdl1_sp236.result:[]).map(function(t){return Object.assign({method:"rectangle"},t,{editable:!1,color:"grey"})}),(this.slice.pdl1_sp236?[].concat.apply([],[].concat.apply([],Object.values(this.slice.pdl1_sp236.airesult)).filter(function(t){return t.display}).map(function(t){return t.cell})):[]).map(function(e){return{id:e.id,path:{x:[e.x],y:[e.y]},color:{0:"green",1:"purple",2:"red",3:"yellow"}[e.type],method:"spot",editable:!1,selectable:!1,radius:3/(t.slice.mppx||.242042)}}),(this.slice.pdl1_sp236?this.slice.pdl1_sp236.pdl1_allresult:[]).map(function(t){return Object.assign(t,{method:"maskArea"},{color:"rgba(255,182,193,0.6)"},{fillColor:"rgba(255,182,193,0.6)"})})),curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:268},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},contextmenu:function(e,i){return t.showMenu(e,i)},clickDraw:t.clickDraw,roiChanged:t.roiChanged,position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},viewer:function(e){return t.viewport=e},parentId:function(e){return t.parentId=e}}},[t.ki67Anno?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+"px",top:t.menuPosition.y+"px"}},[i("v-menus",{attrs:{pos:t.ki67Anno,menus:t.labeltree,currentItem:t.getCommonAnnotation},on:{chosen:t.setAnnotation}})],1):t._e(),t._v(" "),t.addAnnRoi?i("div",{staticClass:"addannroi"},[t._v("标注roi数量不能超出1500个")]):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist",on:{click:function(e){t.ki67Anno=null}}},[i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto?i("v-analyroi",{staticClass:"table ki67table",attrs:{ROIS:this.slice.pdl1_sp236?this.slice.pdl1_sp236.result:[],sRois:this.slice.pdl1_sp236?this.slice.pdl1_sp236.airesult:{},slice:t.slice,showbutton:t.showbutton,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},closecontextmenu:function(e){t.ki67Anno=null}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position"))+"\n        ")]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:function(e){return t.canceltesk()}}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n        "+t._s(t.$t("analyze.point"))+"\n      ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[]};var ci=i("VU/8")(li,ri,!1,function(t){i("9z/3")},"data-v-3abac4e6",null).exports,hi={data:()=>({}),methods:{changeImage(t){this.$set(t,"image",1-(t.image||0)),this.$emit("roiChanged","image",[t])},checkall(){if(!this.ROIS.length)return;let t=this.ROIS.every(t=>!!t.image),e=this.ROIS.map(e=>{return{id:e.id,image:t?0:1}});this.$emit("roiChanged","image",e)},del(t){this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})}},props:["ROIS","currentRois","slice","ave"]},ui={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"fishrois"},[t.ROIS.length?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),t.ROIS?i("div",{staticClass:"fishtable"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:t.ROIS.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                    ROI\n                ")])]),t._v(" "),i("div",[t._v("细胞核")]),t._v(" "),i("div",[t._v("红")]),t._v(" "),i("div",[t._v("绿")]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.deleted")))])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.ROIS,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){return i.stopPropagation(),t.changeImage(e)}}}),t._v("\n                        "+t._s(s+1)+"\n                    ")])]),t._v(" "),i("div",[t._v(t._s(e.aiResult.nuclues_num))]),t._v(" "),i("div",[t._v(t._s(e.aiResult.red_signal_num))]),t._v(" "),i("div",[t._v(t._s(e.aiResult.green_signal_num))]),t._v(" "),i("div",[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])])}),0)]):t._e()])},staticRenderFns:[]};var di=i("VU/8")(hi,ui,!1,function(t){i("Q9fs"),i("sBcn")},null,null).exports;let pi;var vi={data:()=>({labeltree:[{id:"red",label:"红信号点"},{id:"#00FF15",label:"绿信号点"}]}),methods:{async clickDraw(t,e){if(this.auto){if(!this.showbutton)return void this.$message({message:"计算中不能标注",type:"warning"});if(!this.aiFatherRois.length)return void this.$message({message:"该模块不支持区域分析，请直接计算后再做修改",type:"warning"});let a=this.aiFatherRois[0].id;var i={path:{x:[t.x],y:[t.y]},method:"spot",radius:8.333333333333334,mark_type:2,ai_type:"fishTissue",fillColor:"",strokeColor:pi||"red",area_id:a};if(i.id=await Object(s.e)(this.record.id,this.slice.id,i),!i.id)return;e?Object.assign(this.curRois,{[i.id]:i}):this.curRois={[i.id]:i},this.leftRoilist=[...this.leftRoilist,i],this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"fishTissue")}},async setAnnotation(t){for(var e in this.ki67Anno=null,this.curRois){let i=this.curRois[e];"spot"==i.method&&(this.curRois[e]=Object.assign({},i,{strokeColor:t}))}pi=t;var i=Object.assign({},this.curRois),a=Object.assign({},a,...Object.values(i).filter(t=>"spot"==t.method).map(t=>({[t.id]:t})));this.leftRoilist=this.leftRoilist.map(t=>(a[t.id]&&(t=a[t.id]),t)),this.curRois={};let n=this.$refs.osd.scope?Object.assign({},this.$refs.osd.scope,{color:Object.values(a)[0].strokeColor}):null;this.loading=!0,await Object(s.c)(this.record.id,this.slice.id,"fishTissue",Object.values(a).map(t=>({id:t.id,strokeColor:t.strokeColor,area_id:t.area_id})),n),this.loading=!1,this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"fishTissue"),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"fishTissue")},isDrawMpp(){this.startAnalyze()},async draw(t,e){if(t.strokeColor="yellow",t.mark_type=1,this.auto){if(!this.showbutton)return void this.$message({message:"计算中不能标注",type:"warning"});if(!this.aiFatherRois.length)return void this.$message({message:"该模块不支持区域分析，请直接计算后再做修改",type:"warning"});let e=this.aiFatherRois[0].id;t.strokeColor="#fff",t.mark_type=2,t.ai_type="fishTissue",t.area_id=e}t.id=await Object(s.e)(this.record.id,this.slice.id,t),t.id&&(this.curROIChange(t,e),this.leftRoilist=[...this.leftRoilist,t],this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"fishTissue"),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"fishTissue"),this.IsOutFrame())},async delCurRoi(t){t?(this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,"fishTissue",[t.id],null),this.loading=!1,this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois)),this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"fishTissue"),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"fishTissue")):await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})&&(this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,"fishTissue",Object.keys(this.curRois),this.$refs.osd.scope),this.loading=!1,[...new Set(Object.values(this.curRois).map(t=>t.mark_type))].map(async t=>{1===t?this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id):this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"fishTissue")}),this.curRois={},this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"fishTissue"))}},props:["slice","record","config"],components:{"v-dragon":v.a,"v-roi":f,"v-analyroi":di,"v-menus":X},mixins:[U]},mi={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",staticStyle:{width:"100%"},attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright",on:{mousewheel:function(e){t.ki67Anno=null},mousedown:function(e){t.ki67Anno=null}}},[i("v-dragon",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"osd",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:[].concat(t.leftRoilist),curRois:t.curRois,penColor:t.auto?"#fff":"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:1962,"element-loading-text":"处理中，请耐心等待","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.5)"},on:{curROI:t.curROIChange,roiChanged:t.roiChanged,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},getRoi:t.getRoi,clickDraw:t.clickDraw,contextmenu:function(e,i){return t.showMenu(e,i)}}},[t.ki67Anno?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+"px",top:t.menuPosition.y+"px"}},[i("v-menus",{attrs:{pos:t.ki67Anno,menus:t.labeltree,currentItem:t.currentItem,newover:t.newover},on:{chosen:function(e){return t.setAnnotation(e)}}})],1):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("div",{staticClass:"quality"},[t._m(0),t._v(" "),i("div",{staticClass:"quality-detail"},[i("p",[t._v("清 晰 度："+t._s(t.slice.clarity?(100*t.slice.clarity).toFixed(2)+"%":"-"))]),t._v(" "),i("p",[t._v("扫描倍数："+t._s(t.slice.objective_rate||"-"))])])]),t._v(" "),i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v("AI处理")]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v("手动处理")])]),t._v(" "),t.auto?i("v-analyroi",{staticClass:"table",attrs:{slice:t.slice,ROIS:t.aiFatherRois,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.rightRoilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"title"},[e("span",[this._v("AI质控")])])}]};var gi=i("VU/8")(vi,mi,!1,function(t){i("gWm7"),i("VS+2")},"data-v-03e5f70c",null).exports,fi={data:()=>({}),methods:{getlong(t){return this.sRois[t.id]&&this.sRois[t.id].length?Math.max(...this.sRois[t.id].map(t=>t.long)).toFixed(1):0},getshort(t){return this.sRois[t.id]&&this.sRois[t.id].length?Math.min(...this.sRois[t.id].map(t=>t.short)).toFixed(1):0},getperimeter(t){return this.sRois[t.id]&&this.sRois[t.id].length?(this.sRois[t.id].map(t=>t.perimeter).reduce((t,e)=>t+e,0)/this.sRois[t.id].length).toFixed(1):0},getarea(t){return this.sRois[t.id]&&this.sRois[t.id].length?this.sRois[t.id].map(t=>t.area).reduce((t,e)=>t+e,0).toFixed(1):0},getsamlarea(t){return this.sRois[t.id]&&this.sRois[t.id].length?(this.getarea(t)/this.sRois[t.id].length).toFixed(1):0},RoiArea(){return Object.values(this.sRois).length?[...[].concat.apply([],this.ROIS.filter(t=>!!t.image).map(t=>this.sRois[t.id]))].filter(t=>!!t).map(t=>t.area).reduce((t,e)=>t+e,0).toFixed(1):0},Roiarea(){if(Object.values(this.sRois).length){var t=[...[].concat.apply([],this.ROIS.filter(t=>!!t.image).map(t=>this.sRois[t.id]))].filter(t=>!!t);return(t.map(t=>t.area).reduce((t,e)=>t+e,0)/(t.length||1)).toFixed(1)}return 0},RoiPerimeter(){if(Object.values(this.sRois).length){var t=[...[].concat.apply([],this.ROIS.filter(t=>!!t.image).map(t=>this.sRois[t.id]))].filter(t=>!!t);return(t.map(t=>t.perimeter).reduce((t,e)=>t+e,0)/(t.length||1)).toFixed(1)}return 0},Roilong(){if(Object.values(this.sRois).length){var t=[...[].concat.apply([],this.ROIS.filter(t=>!!t.image).map(t=>this.sRois[t.id]))].filter(t=>!!t);return t.length?Math.max(...t.map(t=>t.long),0).toFixed(1):0}return 0},Roishort(){if(Object.values(this.sRois).length){var t=[...[].concat.apply([],this.ROIS.filter(t=>!!t.image).map(t=>this.sRois[t.id]))].filter(t=>!!t);return t.length?Math.min(...t.map(t=>t.short)).toFixed(1):0}return 0},getCount(t){return this.sRois[t.id]?this.sRois[t.id].length:0},checkall(){let t=this.ROIS.every(t=>!!t.image);this.ROIS.forEach(e=>this.$set(e,"image",!t)),this.$emit("closecontextmenu")},change(t,e,i){this.$set(t,"image",i),this.$emit("closecontextmenu")},del(t){this.$emit("closecontextmenu"),this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})}},props:["ROIS","currentRois","sRois","slice"]},_i={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"muscletctrois"},[t.ROIS?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),t.ROIS?i("div",{staticClass:"table"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:t.ROIS.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                    ROI\n                ")])]),t._v(" "),i("div",{staticStyle:{width:"68%"}},[t._v("详情")]),t._v(" "),i("div",[t._v(t._s(t.$t("slice.deleted")))])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.ROIS,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){t.$emit("curROI",e,i.shiftKey),t.$emit("closecontextmenu")}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){i.stopPropagation(),t.change(e,"image",1-(e.image||0))}}}),t._v("\n                        "+t._s(s+1)+"\n                    ")])]),t._v(" "),i("div",{staticClass:"roicenter",staticStyle:{width:"63%"}},[i("div",{staticClass:"item"},[i("div",[t._v("ROI面积:")]),t._v(" "),i("div",[i("span",[t._v(t._s(t.getarea(e)))]),t._m(0,!0)])]),t._v(" "),i("div",{staticClass:"item"},[i("div",[t._v("肌纤维数:")]),i("div",[t._v(t._s(t.getCount(e)))])]),t._v(" "),i("div",{staticClass:"item"},[i("div",[t._v("平均面积:")]),t._v(" "),i("div",[i("span",[t._v(t._s(t.getsamlarea(e)))]),t._m(1,!0)])]),t._v(" "),i("div",{staticClass:"item"},[i("div",[t._v("平均周长:")]),t._v(" "),i("div",[t._v("\n                            "+t._s(t.getperimeter(e))+"μm\n                        ")])]),t._v(" "),i("div",{staticClass:"item"},[i("div",[t._v("最长长径:")]),t._v(" "),i("div",[t._v("\n                            "+t._s(t.getlong(e))+"μm\n                        ")])]),t._v(" "),i("div",{staticClass:"item"},[i("div",[t._v("最短短径:")]),t._v(" "),i("div",[t._v("\n                            "+t._s(t.getshort(e))+"μm\n                        ")])])]),t._v(" "),i("div",{on:{click:function(i){return i.stopPropagation(),t.del(e)}}},[i("em",{attrs:{title:t.$t("upload.delete")}})])])}),0)]):t._e(),t._v(" "),t.ROIS?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"getResult"},[i("div",{staticClass:"left"},[t._v("\n                "+t._s(t.$t("slice.AiResult"))+"\n            ")]),t._v(" "),i("div",{staticClass:"right"},[i("div",{staticClass:"item"},[i("div",[t._v("ROI面积:")]),t._v(" "),i("div",[i("span",[t._v(t._s(t.RoiArea()))]),t._m(2)])]),t._v(" "),i("div",{staticClass:"item"},[i("div",[t._v("肌纤维数:")]),i("div",[t._v(t._s(t.ROIS.filter(function(t){return t.image}).map(function(e){return t.getCount(e)}).reduce(function(t,e){return t+e},0)))])]),t._v(" "),i("div",{staticClass:"item"},[i("div",[t._v("平均面积:")]),t._v(" "),i("div",[i("span",[t._v("\n                            "+t._s(t.Roiarea())+"\n                        ")]),t._v(" "),t._m(3)])]),t._v(" "),i("div",{staticClass:"item"},[i("div",[t._v("平均周长:")]),t._v(" "),i("div",[t._v("\n                    "+t._s(t.RoiPerimeter())+"μm\n                    ")])]),t._v(" "),i("div",{staticClass:"item"},[i("div",[t._v("最长长径:")]),t._v(" "),i("div",[t._v(t._s(t.Roilong())+"μm")])]),t._v(" "),i("div",{staticClass:"item"},[i("div",[t._v("最短短径:")]),t._v(" "),i("div",[t._v(t._s(t.Roishort())+"μm")])])])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),i("div",["error"!=t.slice.muscle.diagnosis&&null!=t.slice.muscle.diagnosis?i("div",[t._v("100"),i("span",[t._v("%")])]):t._e(),t._v(" "),"error"==t.slice.muscle.diagnosis?i("div",[t._v("0")]):t._e()])]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.muscle.computer,callback:function(e){t.$set(t.slice.muscle,"computer",e)},expression:"slice.muscle.computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e()])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("span",[this._v("μm"),e("sup",[this._v("2")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("span",[this._v("μm"),e("sup",[this._v("2")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("span",[this._v("μm"),e("sup",[this._v("2")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("span",[this._v("\n                            μm"),e("sup",[this._v("2")])])}]};var yi=i("VU/8")(fi,_i,!1,function(t){i("7VNn"),i("Eq5Q")},null,null).exports,bi={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,showroi:{},muscleroi:!1,musclestyle:{},totalArea:"",showMppGuide:!1,drawMpp:null}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},showMenu(t,e){this.muscleroi=!1,this.musclestyle={},Object.values(this.showroi).length?(this.muscleroi=!0,this.musclestyle.left=t.offsetX-76+"px",this.musclestyle.top=t.offsetY-128+"px"):this.muscleroi=!1},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;[].concat(...Object.values(this.slice.muscle.airesult));!t||"grey"==t.color&&this.totalArea>1e5?(i=[],this.totalArea=0):t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"grey"==t.color?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t})),this.showroi={},t&&this.curRois[t.id]&&(this.showroi=[].concat.apply([],Object.values(this.slice.muscle.airesult)).filter(e=>e.id==this.curRois[t.id].id)),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)}),Object.values(this.showroi).length||(this.muscleroi=!1)},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},getArea(t){if(t.area)return t.area;for(var e=0,i=[t.x[0],t.y[0]],s=1;s<t.x.length-1;s++){var a=[t.x[s],t.y[s]],n=[t.x[s+1],t.y[s+1]];e+=(i[0]*a[1]+a[0]*n[1]+n[0]*i[1]-i[0]*n[1]-a[0]*i[1]-n[0]*a[1])/2}return Math.round(Math.abs(e)*Math.pow(this.slice.mppx||.242042,2))},getPerimeter(t){if(t.perimeter)return t.perimeter;for(var e=0,i=0;i<t.x.length-1;i++){var s=t.x[i],a=t.y[i],n=t.x[i+1],o=t.y[i+1];e+=Math.hypot(s-n,a-o)*(this.slice.mppx||.242042)}return e},getLong(t){return t.long?t.long:t.axis[1]*(this.slice.mppx||.242042)},getShort(t){return t.short?t.short:t.axis[0]*(this.slice.mppx||.242042)},draw(t){this.totalArea=this.getArea(t.path);for(var e=0;e<this.slice.muscle.result.length;e++)this.totalArea+=this.getArea(this.slice.muscle.result[e].path);if(t.id=(Math.random()+"").substr(2,6),this.auto){if(this.totalArea>1e5)return void this.$message({message:"ROI总面积不能大于0.1mm²",type:"warning"});t=Object.assign({},t,{image:""});var i=[...this.slice.muscle.result,t];this.$set(this.slice.muscle,"result",i)}else this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};for(var i of(t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),Object.keys(e)))6==i.length?(this.slice.muscle.result=this.slice.muscle.result.filter(t=>t.id!=i),delete this.slice.muscle.airesult[i]):this.slice.muscle.result.map(t=>{void 0!=this.slice.muscle.airesult[t.id]&&(this.slice.muscle.airesult[t.id]=this.slice.muscle.airesult[t.id].filter(t=>!e[t.id]))});this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id]),this.muscleroi=!1,this.showroi={}},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"muscle",other:JSON.stringify(this.slice.muscle.result.map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.$set(this.slice,"type","muscle"),-1!=t.data.rank)this.flag="error",this.$set(this.slice.muscle,"diagnosis","error");else{Object.keys(t.data.result).filter(t=>!this.slice.muscle.result.find(e=>e.id==t)).map(e=>delete t.data.result[e]),this.slice.muscle.airesult=t.data.result,[].concat.apply([],Object.values(this.slice.muscle.airesult)).forEach(t=>t.id=(""+Math.random()).substr(2,8)),[].concat.apply([],Object.values(this.slice.muscle.airesult)).forEach(t=>t.area=this.getArea(t)),[].concat.apply([],Object.values(this.slice.muscle.airesult)).forEach(t=>t.perimeter=this.getPerimeter(t)),[].concat.apply([],Object.values(this.slice.muscle.airesult)).forEach(t=>t.long=this.getLong(t)),[].concat.apply([],Object.values(this.slice.muscle.airesult)).forEach(t=>t.short=this.getShort(t)),this.$set(this.slice.muscle,"diagnosis",1)}this.updateRecord()}else this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3)})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){0!=this.slice.muscle.result.length?(this.showroi={},this.$set(this.slice.muscle,"airesult",{}),this.$set(this.slice.muscle,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,this.auto=!0,this.slice.muscle.result.map(t=>t.image=!0),Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.muscle.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"muscle",other:JSON.stringify(this.slice.muscle.result.map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()):this.$message({message:"请先绘制ROI,再进行处理",type:"warning"})},canceltesk(){this.showbutton=!0,Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"muscle",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.slice.started=!1,this.record.started=!1,this.slice.muscle.result.map(t=>t.image=!1),this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},beforeMount(){this.slice.muscle||(this.$set(this.slice,"muscle",{}),this.$set(this.slice.muscle,"result",[]),this.$set(this.slice.muscle,"airesult",{})),this.slice.muscle&&!this.slice.muscle.airesult&&this.$set(this.slice.muscle,"airesult",{})},mounted(){this.slice.started&&this.slice.muscle&&null===this.slice.muscle.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},props:["slice","record"],components:{"v-dragon":v.a,"v-analyroi":yi,"v-roi":f}},Ri={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[s("div",{staticClass:"analyright",on:{mousewheel:function(e){t.muscleroi=!1},mousedown:function(e){t.muscleroi=!1}}},[s("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:(this.slice.muscle?this.slice.muscle.result:[]).map(function(t){return Object.assign({method:"rectangle"},t,{editable:!1,selectable:!1,color:"grey"})}).concat((this.slice.muscle?[].concat.apply([],Object.values(this.slice.muscle.airesult)):[]).map(function(t){return{id:t.id,path:{x:t.x,y:t.y},color:"#00ff00",method:"freepen",editable:!1,selectable:!1,width:3}}),this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})})),curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},contextmenu:function(e,i){return t.showMenu(e,i)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}},[t.muscleroi?s("div",{staticClass:"muscleroi",staticStyle:{position:"absolute"},style:t.musclestyle,on:{click:function(e){e.stopPropagation(),t.muscleroi=!1}}},[s("img",{attrs:{src:i("6lzc")}}),t._v(" "),s("div",{staticClass:"item"},[s("div",[t._v("面积:")]),s("div",[s("span",[t._v(t._s(t.showroi.length?t.getArea(t.showroi[0]).toFixed(1):0))]),s("span",[t._v("μm"),s("sup",[t._v("2")])])])]),t._v(" "),s("div",{staticClass:"item"},[s("div",[t._v("周长:")]),s("div",[t._v(t._s(t.showroi.length?t.getPerimeter(t.showroi[0]).toFixed(1):0)+"μm")])]),t._v(" "),s("div",{staticClass:"item"},[s("div",[t._v("长径:")]),s("div",[t._v(t._s(t.showroi.length?t.getLong(t.showroi[0]).toFixed(1):0)+"μm")])]),t._v(" "),s("div",{staticClass:"item"},[s("div",[t._v("短径:")]),s("div",[t._v(t._s(t.showroi.length?t.getShort(t.showroi[0]).toFixed(1):0)+"μm")])])]):t._e()]),t._v(" "),t.showbutton?s("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),s("div",{staticClass:"analylist",on:{click:function(e){t.muscleroi=!1}}},[s("h2",[s("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),s("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto?s("v-analyroi",{staticClass:"table",attrs:{slice:t.slice,ROIS:this.slice.muscle?this.slice.muscle.result:[],sRois:this.slice.muscle?this.slice.muscle.airesult:{},currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},closecontextmenu:function(e){t.muscleroi=!1}}}):t._e(),t._v(" "),t.auto?t._e():s("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},closecontextmenu:function(e){t.muscleroi=!1}}}),t._v(" "),!t.showbutton&&t.auto?s("div",{staticClass:"loding"},[s("div",{staticClass:"video"},[s("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?s("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?s("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),s("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),s("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),0==t.auto?s("div",{staticClass:"opinio"},[s("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),s("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[]};var Ci=i("VU/8")(bi,Ri,!1,function(t){i("Fd67")},"data-v-5c56e6f5",null).exports,wi={data(){return{loopHandler:0,auto:"one",centerRegion:null,curRois:{},showbutton:!0,radio:null,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,showMppGuide:!1,drawMpp:null}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},keypress(t){if(t.ctrlKey&&"KeyB"==t.code){let t=window.prompt("人工结果？");this.record.analy=this.slice.breast.diagnosis=t}},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>({[t.id]:t})))},roiChanged(){for(var t in this.curRois)this.curRois[t]=Object.assign({},this.curRois[t]);var e=Object.assign({},this.curRois);this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var i=e[t.id];return i?(delete e[t.id],i):t}).concat(Object.values(e))),this.slice.breast&&(this.slice.breast.result=this.slice.breast.result.filter(t=>!this.curRois[t.id]))},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},draw(t){t.id=(Math.random()+"").substr(2,6),"freepen"===t.method&&"yellow"===t.color&&(t.simplify=5),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.breast&&(this.slice.breast.result=this.slice.breast.result.filter(t=>!e[t.id])),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"breast",other:""}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.slice.breast&&0==this.slice.breast.result.length){if(-1==t.data.rank)if(0==Object.keys(t.data.result).length)this.$set(this.slice.breast,"diagnosis","U");else{var e,i=t.data.result.cells&&t.data.result.cells.slice(0,30).map(t=>({id:(Math.random()+"").substr(2,6),path:{x:t.contourPoints.slice(0,-1).map(t=>t[0]),y:t.contourPoints.slice(0,-1).map(t=>t[1])}}));this.$set(this.slice.breast,"result",i);try{e=t.data.result.diagnosis[0].toLowerCase()}catch(t){}e={n:"阴性",p:"阳性",u:"不确定"}[e]||"不满意",this.$set(this.slice.breast,"diagnosis",e)}else this.$set(this.slice.breast,"diagnosis","U");this.$set(this.slice,"type","breast"),this.updateRecord()}}else this.showbutton=!1,this.loopHandler=setTimeout(()=>{this.getAlgorithmResult()},5e3)})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice,"breast",{}),this.$set(this.slice.breast,"result",[]),this.slice.started=!0,this.record.started=!0,this.$set(this.slice.breast,"diagnosis",null),this.showbutton=!1,this.auto="one",Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.breast.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"breast",other:""}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"breast",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},mounted(){this.slice.started&&this.slice.breast&&null===this.slice.breast.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},"slice.breast.computer":{async handler(t){await Object(s.b)("ai/edit",{caseid:this.record.id,fileid:this.slice.id,filename:this.slice.filename,type:"breast",result:t}),this.slice.breast.diagnosis={negative:"阴性",positive:"阳性",unsure:"不确定"}[t],this.$emit("save","auto")}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},ki={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",staticStyle:{width:"100%"},attrs:{tabIndex:0},on:{keydown:t.keydown,keypress:t.keypress}},[i("div",{staticClass:"analyright"},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})}).concat((this.slice.breast?this.slice.breast.result:[]).map(function(t){return Object.assign({},t,{color:"red",method:"rectangle",editable:!0,selectable:!1})})),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,roiChanged:t.roiChanged,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:"one"==t.auto?"auto":"",on:{click:function(e){t.auto="one"}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:"two"==t.auto?"auto":"",on:{click:function(e){t.auto="two"}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),this.slice.breast&&"one"==t.auto?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:this.slice.breast?this.slice.breast.result:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),"two"==t.auto?i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.showbutton||"one"!=t.auto?t._e():i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]),t._v(" "),this.slice.breast||"one"!=t.auto?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),this.slice.breast&&"one"==t.auto?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                    "+t._s(t.$t("slice.AiResult"))+"\n                ")]),t._v(" "),i("div",{class:{error:"error"==this.slice.breast.diagnosis}},[i("input",{directives:[{name:"model",rawName:"v-model",value:t.slice.breast.diagnosis,expression:"slice.breast.diagnosis"}],attrs:{type:"text"},domProps:{value:t.slice.breast.diagnosis},on:{input:function(e){e.target.composing||t.$set(t.slice.breast,"diagnosis",e.target.value)}}})])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),t._m(0)]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.breast.computer,callback:function(e){t.$set(t.slice.breast,"computer",e)},expression:"slice.breast.computer"}},[i("el-radio",{attrs:{label:"positive"}},[t._v("阳性")]),t._v(" "),i("el-radio",{attrs:{label:"negative"}},[t._v("阴性")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("不确定")])],1)],1)]):t._e(),t._v(" "),"two"==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",[e("div",[this._v("100%")])])}]};var xi=i("VU/8")(wi,ki,!1,function(t){i("6tyt"),i("awQe")},"data-v-0d63da7f",null).exports,$i={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,showMppGuide:!1,drawMpp:null}},filters:{showdiagnosis(t){if(void 0!=t)switch(t){case"Benign":return"N";case"Malignant":return"P";case"Unsure":return"U";case"PreCancer":return"A";default:return"U"}}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>({[t.id]:t}))),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},draw(t){t.id=(Math.random()+"").substr(2,6),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"mucosa",other:""}).then(t=>{this.lineup=t.data.rank,t.data.done?(this.showbutton=!0,this.loopHandler=0,this.slice.cervix&&(this.$set(this.slice,"type","mucosa"),this.$set(this.slice.cervix,"diagnosis",t.data.result.flag),this.updateRecord())):(this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3))})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.slice.cervix={},this.$set(this.slice.cervix,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,this.auto=!0,Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"mucosa",other:""}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"mucosa",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},mounted(){this.slice.started&&this.slice.cervix&&null===this.slice.cervix.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},Ii={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt"},[i("div",{staticClass:"analyright",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:[].concat(this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})})),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:1==t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:0==t.auto?"noauto":"",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto&&this.slice.cervix?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),!t.slice.cervix&&t.auto?i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]):t._e(),t._v(" "),t.slice.cervix&&t.auto?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                    "+t._s(t.$t("slice.AiResult"))+"\n                ")]),t._v(" "),i("div",[t._v("\n                    N\n                ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),t._m(0)]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.company,callback:function(e){t.$set(t.slice,"company",e)},expression:"slice.company"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",[e("div",[this._v("100%")])])}]};var Oi=i("VU/8")($i,Ii,!1,function(t){i("b+np"),i("exB+")},"data-v-28e7f80c",null).exports,Si={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,showMppGuide:!1,drawMpp:null}},filters:{showdiagnosis(t){if(void 0!=t)switch(t){case"Benign":return"N";case"Malignant":return"P";case"Unsure":return"U";case"PreCancer":return"A";default:return"U"}}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>({[t.id]:t}))),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},draw(t){t.id=(Math.random()+"").substr(2,6),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"mucosa",other:""}).then(t=>{this.lineup=t.data.rank,t.data.done?(this.showbutton=!0,this.loopHandler=0,this.slice.lung&&(this.$set(this.slice,"type","lung"),this.$set(this.slice.lung,"diagnosis",t.data.result.flag),this.updateRecord())):(this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3))})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.slice.lung={},this.$set(this.slice.lung,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,this.auto=!0,Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"mucosa",other:""}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"mucosa",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},mounted(){this.slice.started&&this.slice.lung&&null===this.slice.lung.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},Ai={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt"},[i("div",{staticClass:"analyright",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:[].concat(this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})})),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:1==t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:0==t.auto?"noauto":"",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto&&this.slice.lung?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),!t.slice.lung&&t.auto?i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]):t._e(),t._v(" "),t.slice.lung&&t.auto?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                    "+t._s(t.$t("slice.AiResult"))+"\n                ")]),t._v(" "),i("div",[t._v("\n                    P\n                ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),t._m(0)]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.company,callback:function(e){t.$set(t.slice,"company",e)},expression:"slice.company"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",[e("div",[this._v("100%")])])}]};var Ti=i("VU/8")(Si,Ai,!1,function(t){i("iFgc"),i("WP8Z")},"data-v-5c1c7232",null).exports,Mi={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,showMppGuide:!1,drawMpp:null}},filters:{showdiagnosis(t){if(void 0!=t)switch(t){case"Benign":return"N";case"Malignant":return"P";case"Unsure":return"U";case"PreCancer":return"A";default:return"U"}}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>({[t.id]:t}))),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},draw(t){t.id=(Math.random()+"").substr(2,6),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"mucosa",other:""}).then(t=>{this.lineup=t.data.rank,t.data.done?(this.showbutton=!0,this.loopHandler=0,this.slice.prostate&&(this.$set(this.slice,"type","prostate"),this.$set(this.slice.prostate,"diagnosis",t.data.result.flag),this.updateRecord())):(this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3))})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.slice.prostate={},this.$set(this.slice.prostate,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,this.auto=!0,Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"mucosa",other:""}).then(t=>{this.getAlgorithmResult(),this.slice.prostate.taskid=t.data.task_id}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{ccaseid:this.record.id,fileid:this.slice.id,type:"mucosa",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},mounted(){this.slice.started&&this.slice.prostate&&null===this.slice.prostate.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},ji={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt"},[i("div",{staticClass:"analyright",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:[].concat(this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})})),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:1==t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:0==t.auto?"noauto":"",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto&&this.slice.prostate?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),!t.slice.prostate&&t.auto?i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]):t._e(),t._v(" "),t.slice.prostate&&t.auto?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                    "+t._s(t.$t("slice.AiResult"))+"\n                ")]),t._v(" "),i("div",[t._v("\n                    P\n                ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),t._m(0)]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.company,callback:function(e){t.$set(t.slice,"company",e)},expression:"slice.company"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",[e("div",[this._v("100%")])])}]};var Fi=i("VU/8")(Mi,ji,!1,function(t){i("ViJe"),i("IIUn")},"data-v-fe065bec",null).exports,Pi={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,showMppGuide:!1,drawMpp:null}},filters:{showdiagnosis(t){if(void 0!=t)switch(t){case"Benign":return"N";case"Malignant":return"P";case"Unsure":return"U";case"PreCancer":return"A";default:return"U"}}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>({[t.id]:t}))),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},draw(t){t.id=(Math.random()+"").substr(2,6),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"mucosa",other:""}).then(t=>{this.lineup=t.data.rank,t.data.done?(this.showbutton=!0,this.loopHandler=0,this.slice.sentinelnode&&(this.$set(this.slice,"type","sentinelnode"),this.$set(this.slice.sentinelnode,"diagnosis",t.data.result.flag),this.updateRecord())):(this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3))})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.slice.sentinelnode={},this.$set(this.slice.sentinelnode,"diagnosis",null),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,this.auto=!0,Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"mucosa",other:""}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"mucosa",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},mounted(){this.slice.started&&this.slice.sentinelnode&&null===this.slice.sentinelnode.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},props:["slice","record"],components:{"v-dragon":v.a,"v-roi":f}},Ei={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt"},[i("div",{staticClass:"analyright",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:[].concat(this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})})),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:1==t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:0==t.auto?"noauto":"",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto&&this.slice.sentinelnode?i("v-roi",{staticClass:"automanualroi",attrs:{roilist:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),!t.slice.sentinelnode&&t.auto?i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]):t._e(),t._v(" "),t.slice.sentinelnode&&t.auto?i("div",{staticClass:"tctbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v("\n                    "+t._s(t.$t("slice.AiResult"))+"\n                ")]),t._v(" "),i("div",[t._v("\n                    U\n                ")])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),t._m(0)]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.company,callback:function(e){t.$set(t.slice,"company",e)},expression:"slice.company"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",[e("div",[this._v("100%")])])}]};var Li=i("VU/8")(Pi,Ei,!1,function(t){i("2AQt"),i("DXLA")},"data-v-25ed3768",null).exports,Di={data:()=>({}),methods:{changearea:t=>(t/1e6).toFixed(2),checkall(){let t=this.roilist.every(t=>!!t.image);this.roilist.forEach(e=>this.$set(e,"image",t?0:1)),this.$emit("closecontextmenu")},del(t){this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>this.$emit("delRoi",t),t=>t)},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")}},props:["roilist","currentRois","startLearn","record"]},Hi={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"roi"},[t.startLearn?t._e():i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:!!t.roilist.length&&t.roilist.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                ROI\n            ")])]),t._v(" "),i("div",{staticClass:"center"},[t._v("\n            "+t._s(t.$t("slice.remark"))+"\n        ")]),t._v(" "),t._m(0),t._v(" "),i("div",{staticClass:"right"},[t._v("\n            "+t._s(t.$t("analyze.opration"))+"\n        ")])]),t._v(" "),t.startLearn?i("div",{staticClass:"startlearn"},[i("div",{staticClass:"learning"},[t._v("\n            训练中...\n        ")])]):i("div",{staticClass:"rois"},t._l(t.roilist,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){t.$emit("curROI",e,i.shiftKey),t.$emit("closecontextmenu")}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){i.stopPropagation(),t.$set(e,"image",1-(e.image||0)),t.$emit("closecontextmenu")}}}),t._v("\n                    "+t._s(s+1)+"\n                ")])]),t._v(" "),i("div",{staticClass:"center"},[i("input",{directives:[{name:"model",rawName:"v-model.lazy",value:e.remark,expression:"roi.remark",modifiers:{lazy:!0}}],attrs:{type:"text",placeholder:t.$t("slice.input"),maxlength:"300",title:e.remark},domProps:{value:e.remark},on:{keydown:function(e){if(!e.type.indexOf("key")&&t._k(e.keyCode,"delete",[8,46],e.key,["Backspace","Delete","Del"]))return null;e.stopPropagation()},input:t.noEmoji,change:function(i){return t.$set(e,"remark",i.target.value)}}})]),t._v(" "),i("div",{staticClass:"area"},[i("div",[t._v("\n                    "+t._s(e.area?t.changearea(e.area):"请输入...")+"\n                ")])]),t._v(" "),i("div",{staticClass:"right"},[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])])}),0)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"area area_top"},[this._v("\n            面积("),e("span",[this._v("mm"),e("sup",[this._v("2")])]),this._v(")\n        ")])}]};var zi=i("VU/8")(Di,Hi,!1,function(t){i("ymmg")},"data-v-13a8fd43",null).exports,Ni={data(){return{loopHandler:0,auto:"two",centerRegion:null,curRois:{},showbutton:!0,labeltree:[{id:"坏死区域",label:"坏死区域"},{id:"正常组织区域",label:"正常组织区域"}],liverAnno:null,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,addAnnRoi:!1,RoiWidth:null,PatchWidth:null,pathseg:!0,getroi:!0,startLearn:!1,menuPosition:{},showMppGuide:!1,drawMpp:null}},computed:{getCommonAnnotation(){var t=Object.values(this.curRois);return t[0]&&t.every(t=>t.jgResult)&&t.every(e=>e.jgResult==t[0].jgResult)?t[0].jgResult.split(",")[0]:""},percentage(){return 0==(this.slice.liver.result.filter(t=>"normal"==t.type).map(t=>t.area).reduce((t,e)=>t+e,0)/1e6).toFixed(2)?"0%":((this.slice.liver.result.filter(t=>"abnormal"==t.type).map(t=>t.area).reduce((t,e)=>t+e,0)/1e6).toFixed(2)/((this.slice.liver.result.filter(t=>"normal"==t.type).map(t=>t.area).reduce((t,e)=>t+e,0)+this.slice.liver.result.filter(t=>"abnormal"==t.type).map(t=>t.area).reduce((t,e)=>t+e,0))/1e6).toFixed(2)).toFixed(2)+"%"}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},mouseDown(){this.liverAnno=null},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>({[t.id]:t})))},clickDraw(t,e){var i=10,s=t.x,a=t.y,n={id:(Math.random()+"").substr(2,9),path:{x:[s-i,s+i,s+i,s-i],y:[a-i,a-i,a+i,a+i]},width:2,method:"rectangle"};this.slice.roilist=[...this.slice.roilist,n],this.curROIChange(n,e)},getArea(t){for(var e=0,i=0;i<t.x.length-2;i++){if(i+2<t.x.length)var s=[t.x[0],t.y[0]],a=[t.x[i+1],t.y[i+1]],n=[t.x[i+2],t.y[i+2]];e+=(Math.abs(s[0]*a[1])+Math.abs(a[0]*n[1])+Math.abs(n[0]*s[1])-Math.abs(s[0]*n[1])-Math.abs(a[0]*s[1])-Math.abs(n[0]*a[1]))/2}return e=Math.round(Math.abs(e)*Math.pow(this.slice.mppx||.49,2))},draw(t){t.id=(Math.random()+"").substr(2,9),t.area=this.getArea(t.path),"freepen"===t.method&&(t.simplify=5),this.slice.roilist=[...this.slice.roilist,t]},clearSimplify(t){this.$set(this.slice,"roilist",this.slice.roilist.map(e=>(e.id===t.id&&(e.path.x=t.x,e.path.y=t.y,e.simplify&&delete e.simplify),e)))},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.liver&&(this.slice.liver.result=this.slice.liver.result.filter(t=>!e[t.id])),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id]),this.liverAnno=null},roiChanged(){for(var t in this.curRois)this.curRois[t]=Object.assign({},this.curRois[t]);var e=Object.assign({},this.curRois);this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var i=e[t.id];return i?(delete e[t.id],i):t}).concat(Object.values(e))),this.slice.liver&&(this.slice.liver.result=this.slice.liver.result.filter(t=>!this.curRois[t.id]))},checkjgResult:t=>t.jgResult?t.jgResult.split(",")[1]:"",setAnnotation(t){var e;for(var i in e="string"!=typeof t?t[0]+","+t[1]:t,this.liverAnno=null,this.curRois){let t=this.curRois[i];this.curRois[i]=Object.assign({},t,{jgResult:e,remark:e.split(",")[e.split(",").length-1]})}var s=Object.assign({},this.curRois);this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var e=s[t.id];return e?(delete s[t.id],e):t}).concat(Object.values(s))),this.slice.liver&&(this.slice.liver.result=this.slice.liver.result.filter(t=>!this.curRois[t.id]))},showMenu(t,e){if((!t.type||t.button)&&(this.showleft=!1,this.showlivertop=!1,t.preventDefault(),0!=Object.keys(this.curRois).length&&!Object.keys(this.curRois).every(t=>t!=e.id))){var i=t.currentTarget,s=t.offsetX,a=t.offsetY,n=i.offsetWidth,o=i.offsetHeight;this.liverAnno={},this.liverAnno.hd=s>n/2?"right":"left",this.liverAnno.vd=a>o/2?"bottom":"top",this.menuPosition={x:s,y:a}}},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"hepatonecrosis",other:""}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.slice.liver&&0==this.slice.liver.result.length){if(-1==t.data.rank)if(0==Object.keys(t.data.result).length)this.$set(this.slice.liver,"diagnosis","U");else{var e=t.data.result[-1].abnormal_region&&t.data.result[-1].abnormal_region.map(t=>({id:(Math.random()+"").substr(2,9),editable:!1,path:{x:t.x,y:t.y},type:"abnormal",area:this.getArea({x:t.x,y:t.y}),remark:"坏死区域"})),i=t.data.result[-1].normal_region&&t.data.result[-1].normal_region.map(t=>({id:(Math.random()+"").substr(2,9),editable:!1,path:{x:t.x,y:t.y},type:"normal",area:this.getArea({x:t.x,y:t.y}),remark:"正常区域"})),s=e.concat(...i);this.$set(this.slice.liver,"result",s),this.$set(this.slice.liver,"diagnosis","U")}else this.$set(this.slice.liver,"diagnosis","U");this.$set(this.slice,"type","hepatonecrosis"),this.updateRecord()}}else this.showbutton=!1,this.loopHandler=setTimeout(()=>{this.getAlgorithmResult()},5e3)})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice,"liver",{}),this.$set(this.slice.liver,"result",[]),this.slice.started=!0,this.record.started=!0,this.$set(this.slice.liver,"diagnosis",null),this.showbutton=!1,Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.liver.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"hepatonecrosis",other:""}).then(t=>{this.getAlgorithmResult(),this.slice.liver.taskid=t.data.task_id}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"hepatonecrosis",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()},PathSeg(){this.pathseg=!1,Object(s.b)("script/cutwsi",{caseid:this.record.id,fileid:this.slice.id,filename:this.slice.filename,size:this.PatchWidth||1024}).then(t=>{console.log(t)}).catch(t=>{console.log(t)})},GetRoi(){this.getroi=!1,Object(s.b)("script/extractAnnots",{caseid:this.record.id,fileid:this.slice.id,filename:this.slice.filename,size:this.RoiWidth||1024}).then(t=>{console.log(t)}).catch(t=>{console.log(t)})},stoplearn(){this.startLearn=!this.startLearn,Object(s.b)("ai/train",{}).then(t=>{console.log(t)})},startlearn(){this.startLearn=!this.startLearn,Object(s.b)("ai/stopTrain",{}).then(t=>{console.log(t)})}},mounted(){this.slice.started&&this.slice.liver&&null===this.slice.liver.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},"slice.roilist":{handler(t){t.length>300&&(this.addAnnRoi=!0,setTimeout(()=>this.addAnnRoi=!1,2500),Object.values(this.curRois).map(t=>delete this.curRois[t.id]),t.pop())}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},props:["slice","record"],components:{"v-menus":_t,"v-dragon":v.a,"v-analyroi":zi}},Bi={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",staticStyle:{width:"100%"}},[i("div",{ref:"osd",staticClass:"analyright",attrs:{tabIndex:0},on:{mousewheel:function(e){t.liverAnno=null},keydown:t.keydown}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.map(function(e){return Object.assign({method:"rectangle"},e,{color:{"坏死区域":"red","正常组织区域":"green"}[t.checkjgResult(e)]})}).concat((this.slice.liver?this.slice.liver.result:[]).map(function(t){return Object.assign({},t,{color:{abnormal:"red",normal:"green"}[t.type],method:"rectangle",editable:!1})})),penColor:"yellow",curRois:t.curRois,centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},contextmenu:function(e,i){return t.showMenu(e,i)},roiChanged:t.roiChanged,mousedown:t.mouseDown,position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},clearSimplify:t.clearSimplify}},[t.liverAnno?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+5+"px",top:t.menuPosition.y+5+"px"}},[i("v-menus",{attrs:{pos:t.liverAnno,menus:t.labeltree,currentItem:t.getCommonAnnotation},on:{chosen:t.setAnnotation}})],1):t._e(),t._v(" "),t.addAnnRoi?i("div",{staticClass:"addannroi"},[t._v("标注roi数量不能超出300个")]):t._e()]),t._v(" "),t.showbutton&&!t.startLearn?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist",on:{click:function(e){t.liverAnno=null}}},[i("h2",[i("span",{class:"one"==t.auto?"auto":"",on:{click:function(e){t.auto="one"}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:"two"==t.auto?"auto":"",on:{click:function(e){t.auto="two"}}},[t._v("训练ROI")])]),t._v(" "),this.slice.liver&&"one"==t.auto?i("v-analyroi",{staticClass:"automanualroi",attrs:{roilist:this.slice.liver?this.slice.liver.result:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},closecontextmenu:function(e){t.liverAnno=null}}}):t._e(),t._v(" "),"two"==t.auto?i("v-analyroi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois,startLearn:t.startLearn,record:t.record},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},closecontextmenu:function(e){t.liverAnno=null}}}):t._e(),t._v(" "),t.showbutton||"one"!=t.auto?t._e():i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]),t._v(" "),this.slice.liver||"one"!=t.auto?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),this.slice.liver&&"one"==t.auto?i("div",{staticClass:"liverbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v(t._s(t.$t("slice.AiResult")))]),t._v(" "),i("div",[t._v("坏死区域面积:  "+t._s(this.slice.liver.result.length?(this.slice.liver.result.filter(function(t){return"abnormal"==t.type}).map(function(t){return t.area}).reduce(function(t,e){return t+e},0)/1e6).toFixed(2):0)+"  "),t._m(0)]),t._v(" "),i("div",[t._v("正常区域面积:  "+t._s(this.slice.liver.result.length?(this.slice.liver.result.filter(function(t){return"normal"==t.type}).map(function(t){return t.area}).reduce(function(t,e){return t+e},0)/1e6).toFixed(2):0)+"  "),t._m(1)]),t._v(" "),i("div",[t._v("\n                    坏死区域面积/总面积:  "+t._s(t.percentage))])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),t._m(2)]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.liver.computer,callback:function(e){t.$set(t.slice.liver,"computer",e)},expression:"slice.liver.computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),"two"==t.auto?i("div",{staticClass:"translate"},[i("button",{class:t.startLearn?"stop":"",on:{click:function(e){t.startLearn?t.startlearn():t.stoplearn()}}},[t._v(t._s(t.startLearn?"终止训练":"开始训练"))])]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("span",[this._v("mm"),e("sup",{staticStyle:{"font-size":"12px"}},[this._v("2")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("span",[this._v("mm"),e("sup",{staticStyle:{"font-size":"12px"}},[this._v("2")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",[e("div",[this._v("100%")])])}]};var Gi=i("VU/8")(Ni,Bi,!1,function(t){i("Ilek"),i("8tH+")},"data-v-4e8b7071",null).exports,Ui={data:()=>({}),methods:{changearea:t=>(t/1e6).toFixed(2),checkall(){let t=this.roilist.every(t=>!!t.image);this.roilist.forEach(e=>this.$set(e,"image",t?0:1))},del(t){this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>this.$emit("delRoi",t),t=>t)},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")}},props:["roilist","currentRois","record"]},Vi={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"roi"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:!!t.roilist.length&&t.roilist.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                ROI\n            ")])]),t._v(" "),i("div",{staticClass:"center"},[t._v("\n            "+t._s(t.$t("slice.remark"))+"\n        ")]),t._v(" "),t._m(0),t._v(" "),i("div",{staticClass:"right"},[t._v("\n            "+t._s(t.$t("analyze.opration"))+"\n        ")])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.roilist,function(e,s){return i("div",{key:s,staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){t.$emit("curROI",e,i.shiftKey),t.$emit("closecontextmenu")}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){i.stopPropagation(),t.$set(e,"image",1-(e.image||0)),t.$emit("closecontextmenu")}}}),t._v("\n                    "+t._s(s+1)+"\n                ")])]),t._v(" "),i("div",{staticClass:"center"},[i("input",{directives:[{name:"model",rawName:"v-model.lazy",value:e.remark,expression:"roi.remark",modifiers:{lazy:!0}}],attrs:{type:"text",placeholder:t.$t("slice.input"),maxlength:"300",title:e.remark},domProps:{value:e.remark},on:{keydown:function(e){if(!e.type.indexOf("key")&&t._k(e.keyCode,"delete",[8,46],e.key,["Backspace","Delete","Del"]))return null;e.stopPropagation()},input:t.noEmoji,change:function(i){return t.$set(e,"remark",i.target.value)}}})]),t._v(" "),i("div",{staticClass:"area"},[i("div",[t._v("\n                    "+t._s(e.area?t.changearea(e.area):"请输入...")+"\n                ")])]),t._v(" "),i("div",{staticClass:"right"},[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])])}),0)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"area area_top"},[this._v("\n            面积("),e("span",[this._v("mm"),e("sup",[this._v("2")])]),this._v(")\n        ")])}]};var Yi=i("VU/8")(Ui,Vi,!1,function(t){i("0DuT")},"data-v-d6f9ca3e",null).exports,Ji={data(){return{loopHandler:0,auto:"one",centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,addAnnRoi:!1,RoiWidth:null,PatchWidth:null,pathseg:!0,getroi:!0,showMppGuide:!1,drawMpp:null}},computed:{getCommonAnnotation(){var t=Object.values(this.curRois);return t[0]&&t.every(t=>t.jgResult)&&t.every(e=>e.jgResult==t[0].jgResult)?t[0].jgResult.split(",")[0]:""},percentage(){return 0==(this.slice.liver.result.filter(t=>"normal"==t.type).map(t=>t.area).reduce((t,e)=>t+e,0)/1e6).toFixed(2)?"0%":((this.slice.liver.result.filter(t=>"abnormal"==t.type).map(t=>t.area).reduce((t,e)=>t+e,0)/1e6).toFixed(2)/((this.slice.liver.result.filter(t=>"normal"==t.type).map(t=>t.area).reduce((t,e)=>t+e,0)+this.slice.liver.result.filter(t=>"abnormal"==t.type).map(t=>t.area).reduce((t,e)=>t+e,0))/1e6).toFixed(2)).toFixed(2)+"%"}},methods:{isDrawMpp(){/\.(png|jpg|jpeg|tiff|tif|bmp)$/.test(this.slice.filename)?this.showMppGuide=!0:this.startAnalyze()},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>({[t.id]:t})))},clickDraw(t,e){var i=10,s=t.x,a=t.y,n={id:(Math.random()+"").substr(2,9),path:{x:[s-i,s+i,s+i,s-i],y:[a-i,a-i,a+i,a+i]},width:2,method:"rectangle"};this.slice.roilist=[...this.slice.roilist,n],this.curROIChange(n,e)},getArea(t){for(var e=0,i=0;i<t.x.length-2;i++){if(i+2<t.x.length)var s=[t.x[0],t.y[0]],a=[t.x[i+1],t.y[i+1]],n=[t.x[i+2],t.y[i+2]];e+=(Math.abs(s[0]*a[1])+Math.abs(a[0]*n[1])+Math.abs(n[0]*s[1])-Math.abs(s[0]*n[1])-Math.abs(a[0]*s[1])-Math.abs(n[0]*a[1]))/2}return e=Math.round(Math.abs(e)*Math.pow(this.slice.mppx||.49,2))},draw(t){t.id=(Math.random()+"").substr(2,9),t.area=this.getArea(t.path),this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),this.slice.liver&&(this.slice.liver.result=this.slice.liver.result.filter(t=>!e[t.id])),this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},roiChanged(){for(var t in this.curRois)this.curRois[t]=Object.assign({},this.curRois[t]);var e=Object.assign({},this.curRois);this.$set(this.slice,"roilist",this.slice.roilist.map(t=>{var i=e[t.id];return i?(delete e[t.id],i):t}).concat(Object.values(e))),this.slice.liver&&(this.slice.liver.result=this.slice.liver.result.filter(t=>!this.curRois[t.id]))},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"hepatonecrosis",other:""}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.slice.liver&&0==this.slice.liver.result.length){if(-1==t.data.rank)if(0==Object.keys(t.data.result).length)this.$set(this.slice.liver,"diagnosis","U");else{var e=t.data.result[-1].abnormal_region&&t.data.result[-1].abnormal_region.map(t=>({id:(Math.random()+"").substr(2,9),editable:!1,path:{x:t.x,y:t.y},type:"abnormal",area:this.getArea({x:t.x,y:t.y}),remark:"坏死区域"})),i=t.data.result[-1].normal_region&&t.data.result[-1].normal_region.map(t=>({id:(Math.random()+"").substr(2,9),editable:!1,path:{x:t.x,y:t.y},type:"normal",area:this.getArea({x:t.x,y:t.y}),remark:"正常区域"})),s=e.concat(...i);this.$set(this.slice.liver,"result",s),this.$set(this.slice.liver,"diagnosis","U")}else this.$set(this.slice.liver,"diagnosis","U");this.$set(this.slice,"type","liver"),this.updateRecord()}}else this.showbutton=!1,this.loopHandler=setTimeout(()=>{this.getAlgorithmResult()},5e3)})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice,"liver",{}),this.$set(this.slice.liver,"result",[]),this.slice.started=!0,this.record.started=!0,this.$set(this.slice.liver,"diagnosis",null),this.showbutton=!1,Object.values(this.curRois).map(t=>this.slice.roilist.every(e=>t.id!=e.id)&&this.slice.liver.result.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"hepatonecrosis",other:""}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"hepatonecrosis",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()},PathSeg(){this.pathseg=!1,Object(s.b)("script/cutwsi",{caseid:this.record.id,fileid:this.slice.id,filename:this.slice.filename,size:this.PatchWidth||1024}).then(t=>{console.log(t)}).catch(t=>{console.log(t)})},GetRoi(){this.getroi=!1,Object(s.b)("script/extractAnnots",{caseid:this.record.id,fileid:this.slice.id,filename:this.slice.filename,size:this.RoiWidth||1024}).then(t=>{console.log(t)}).catch(t=>{console.log(t)})}},mounted(){this.slice.started&&this.slice.liver&&null===this.slice.liver.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()})},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},"slice.roilist":{handler(t){t.length>300&&(this.addAnnRoi=!0,setTimeout(()=>this.addAnnRoi=!1,2500),Object.values(this.curRois).map(t=>delete this.curRois[t.id]),t.pop())}},drawMpp:{handler(t){t&&(this.$set(this.slice,"mppx",t),this.$set(this.slice,"mppy",t),this.$emit("save","auto"),this.startAnalyze())}}},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},props:["slice","record"],components:{"v-menus":_t,"v-dragon":v.a,"v-analyroi":Yi}},Wi={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",staticStyle:{width:"100%"}},[i("div",{ref:"osd",staticClass:"analyright",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:"yellow"})}).concat((this.slice.liver?this.slice.liver.result:[]).map(function(t){return Object.assign({},t,{color:{abnormal:"red",normal:"green"}[t.type],method:"rectangle",editable:!1})})),penColor:"yellow",curRois:t.curRois,centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged,position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:"one"==t.auto?"auto":"",on:{click:function(e){t.auto="one"}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:"two"==t.auto?"auto":"",on:{click:function(e){t.auto="two"}}},[t._v("手工ROI")])]),t._v(" "),this.slice.liver&&"one"==t.auto?i("v-analyroi",{staticClass:"automanualroi",attrs:{roilist:this.slice.liver?this.slice.liver.result:[],currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),"two"==t.auto?i("v-analyroi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois,record:t.record},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.showbutton||"one"!=t.auto?t._e():i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]),t._v(" "),this.slice.liver||"one"!=t.auto?t._e():i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]),t._v(" "),this.slice.liver&&"one"==t.auto?i("div",{staticClass:"liverbtm"},[i("div",{staticClass:"AiResult"},[i("div",[t._v(t._s(t.$t("slice.AiResult")))]),t._v(" "),i("div",[t._v("坏死区域面积:  "+t._s(this.slice.liver.result.length?(this.slice.liver.result.filter(function(t){return"abnormal"==t.type}).map(function(t){return t.area}).reduce(function(t,e){return t+e},0)/1e6).toFixed(2):0)+"  "),t._m(0)]),t._v(" "),i("div",[t._v("正常区域面积:  "+t._s(this.slice.liver.result.length?(this.slice.liver.result.filter(function(t){return"normal"==t.type}).map(function(t){return t.area}).reduce(function(t,e){return t+e},0)/1e6).toFixed(2):0)+"  "),t._m(1)]),t._v(" "),i("div",[t._v("\n                    坏死区域面积/总面积:  "+t._s(t.percentage))])]),t._v(" "),i("div",{staticClass:"confidence"},[i("div",[t._v(t._s(t.$t("slice.confidence")))]),t._v(" "),t._m(2)]),t._v(" "),i("div",{staticClass:"interactive"},[i("div",[t._v(t._s(t.$t("slice.interaction")))]),t._v(" "),i("el-radio-group",{staticClass:"radios",model:{value:t.slice.liver.computer,callback:function(e){t.$set(t.slice.liver,"computer",e)},expression:"slice.liver.computer"}},[i("el-radio",{attrs:{label:!0}},[t._v("YES")]),t._v(" "),i("el-radio",{attrs:{label:!1}},[t._v("NO")]),t._v(" "),i("el-radio",{attrs:{label:"unsure"}},[t._v("UNSURE")])],1)],1)]):t._e(),t._v(" "),"two"==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("span",[this._v("mm"),e("sup",{staticStyle:{"font-size":"12px"}},[this._v("2")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("span",[this._v("mm"),e("sup",{staticStyle:{"font-size":"12px"}},[this._v("2")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",[e("div",[this._v("100%")])])}]};var Xi=i("VU/8")(Ji,Wi,!1,function(t){i("+we9"),i("0q1C")},"data-v-8a6f1e16",null).exports,qi={data:()=>({}),methods:{reduceCount(t){return Object.keys(this.sRois).map(e=>Number(this.sRois[e][t].toFixed(1))).reduce((t,e)=>t+e,0)},checkall(){let t=this.ROIS.every(t=>!!t.image);this.ROIS.forEach(e=>this.$set(e,"image",!t))},change(t,e,i){this.$set(t,"image",i)},del(t){this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})}},props:["ROIS","currentRois","sRois","slice"]},Ki={render:function(){var t=this,e=this,i=e.$createElement,s=e._self._c||i;return s("div",{staticClass:"ca-tctrois"},[e.ROIS.length?e._e():s("div",{staticClass:"ifshowtables"},[e._v(e._s(e.$t("slice.noanalysis")))]),e._v(" "),e.ROIS?s("div",{staticClass:"table"},[s("div",{staticClass:"top"},[s("div",{staticClass:"left"},[s("div",[s("span",{staticClass:"uncheck",class:{checked:e.ROIS.every(function(t){return!!t.image})},on:{click:e.checkall}}),e._v("\n                    ROI\n                ")])]),e._v(" "),s("div",{staticClass:"roicenter"},[e._v("详情")]),e._v(" "),s("div",[e._v(e._s(e.$t("slice.deleted")))])]),e._v(" "),s("div",{staticClass:"rois"},e._l(e.ROIS,function(t,i){return s("div",{key:i,staticClass:"row",class:{curRoi:e.currentRois[t.id]},on:{click:function(i){return e.$emit("curROI",t,i.shiftKey)}}},[s("div",{staticClass:"left"},[s("div",[s("span",{staticClass:"uncheck",class:{checked:t.image},on:{click:function(i){i.stopPropagation(),e.change(t,"image",1-(t.image||0))}}}),e._v(" "),s("span",{staticClass:"roidetails"},[e._v(e._s(i+1))])])]),e._v(" "),s("div",{staticClass:"roicenter"},[s("p",[e._v("血管周长："+e._s(e.sRois[t.id]?e.sRois[t.id].vessel_perimeter.toFixed(1):"0")+"μm")]),e._v(" "),s("p",[e._v("血管面积："+e._s(e.sRois[t.id]?e.sRois[t.id].vessel_area.toFixed(1):"0")+"μm²")]),e._v(" "),s("p",[e._v("血管个数："+e._s(e.sRois[t.id]?e.sRois[t.id].num_vessel:"0"))]),e._v(" "),s("p",[e._v("ROI面积："+e._s(e.sRois[t.id]?e.sRois[t.id].tumor_area.toFixed(1):"0")+"μm²")]),e._v(" "),s("p",[e._v("血管面积比："+e._s(e.sRois[t.id]?(100*e.sRois[t.id].vessel_tumor_ratio).toFixed(1):0)+"%")]),e._v(" "),s("p",[e._v("血管密度："+e._s(e.sRois[t.id]?(1e3*e.sRois[t.id].vessel_dense*1e3).toFixed(1):0)+"/mm²")])]),e._v(" "),s("div",[s("em",{attrs:{title:e.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),e.del(t)}}})])])}),0)]):e._e(),e._v(" "),e.sRois?s("div",{staticClass:"capbtm"},[s("h2",[e._v("处理结果")]),e._v(" "),s("div",{staticClass:"AiResult"},[s("p",[s("span",[e._v("总血管周长：")]),e._v(e._s(e.reduceCount("vessel_perimeter").toFixed(1))+"μm")]),e._v(" "),s("p",[s("span",[e._v("总血管面积：")]),e._v(e._s(e.reduceCount("vessel_area").toFixed(1))+"μm²")]),e._v(" "),s("p",[s("span",[e._v("总血管个数：")]),e._v(e._s(Object.keys(this.sRois).map(function(e){return Number(t.sRois[e].num_vessel)}).reduce(function(t,e){return t+e},0)))]),e._v(" "),s("p",[s("span",[e._v("ROI总面积：")]),e._v(e._s(e.reduceCount("tumor_area").toFixed(1))+"μm²")]),e._v(" "),s("p",[s("span",[e._v("总血管面积比：")]),e._v(e._s((e.reduceCount("vessel_area")/(e.reduceCount("tumor_area")||1)*100).toFixed(1))+"%")]),e._v(" "),s("p",[s("span",[e._v("总血管密度：")]),e._v(e._s((e.reduceCount("num_vessel")/(e.reduceCount("tumor_area")||1)*1e3*1e3).toFixed(1))+"/mm²")])])]):e._e()])},staticRenderFns:[]};var Zi=i("VU/8")(qi,Ki,!1,function(t){i("y75E"),i("gfnL")},null,null).exports,Qi={data(){return{loopHandler:0,auto:!0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,totalArea:"",showLayer:!0,viewport:null}},methods:{addLayer(){Object.keys(this.slice.angiocarpy.airesult).map(t=>{let e="/aipath/api/ai/getResultImage?caseid="+this.record.id+"&fileid="+this.slice.id+"&type=angiocarpy&roiid="+t,i=new Image;i.style.pointerEvents="none",i.id=t;let s=this.slice.angiocarpy.airesult[t];if(!Object.keys(s).length)return;i.src=location.origin+e;let a=s.position[0]/this.slice.width,n=s.position[1]/this.slice.width,o=s.size[0]/this.slice.width,l=s.size[1]/this.slice.width;this.viewport.viewer.addOverlay({element:i,location:new OpenSeadragon.Rect(a,n,o,l)})})},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},curROIChange(t,e){var i;!t||"grey"==t.color&&this.totalArea>5e5?(i=[],this.totalArea=0):t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>"grey"==t.color?{[t.id]:Object.assign({},t,{editable:!1})}:{[t.id]:t})),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},listChangeCurrent(){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null},getArea(t){for(var e=0,i=0;i<t.x.length-2;i++){if(i+2<t.x.length)var s=[t.x[0],t.y[0]],a=[t.x[i+1],t.y[i+1]],n=[t.x[i+2],t.y[i+2]];e+=(Math.abs(s[0]*a[1])+Math.abs(a[0]*n[1])+Math.abs(n[0]*s[1])-Math.abs(s[0]*n[1])-Math.abs(a[0]*s[1])-Math.abs(n[0]*a[1]))/2}return e=Math.round(Math.abs(e)*Math.pow(this.slice.mppx||.242042,2))},draw(t){this.totalArea=this.getArea(t.path);for(var e=0;e<this.slice.angiocarpy.result.length;e++)this.totalArea+=this.getArea(this.slice.angiocarpy.result[e].path);if(t.id=(Math.random()+"").substr(2,6),this.auto){t=Object.assign({},t,{image:""});var i=[...this.slice.angiocarpy.result,t];this.$set(this.slice.angiocarpy,"result",i)}else this.slice.roilist=[...this.slice.roilist,t]},async delCurRoi(t){let e={};for(var i of(t?(e={[t.id]:t},this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):(e=this.curRois,await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}),this.curRois={}),Object.keys(e)))this.slice.angiocarpy.result=this.slice.angiocarpy.result.filter(t=>t.id!=i),delete this.slice.angiocarpy.airesult[i],this.viewport.viewer.removeOverlay(i);this.slice.roilist=this.slice.roilist.filter(t=>!e[t.id])},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:"angiocarpy",other:JSON.stringify(this.slice.angiocarpy.result.map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{if(this.lineup=t.data.rank,t.data.done){if(this.showbutton=!0,this.loopHandler=0,this.$set(this.slice,"type","angiocarpy"),-1!=t.data.rank)this.flag="error",this.$set(this.slice.angiocarpy,"diagnosis","error");else{if(!t.data.result[-1]){Object.keys(t.data.result).filter(t=>!this.slice.angiocarpy.result.find(e=>e.id==t)).map(e=>delete t.data.result[e])}this.slice.angiocarpy.airesult=t.data.result,this.addLayer(),this.$set(this.slice.angiocarpy,"diagnosis",1)}this.updateRecord()}else this.showbutton=!1,this.loopHandler=setTimeout(()=>this.getAlgorithmResult(),5e3)})},startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice.angiocarpy,"airesult",{}),this.$set(this.slice.angiocarpy,"diagnosis",null),this.viewport.viewer.clearOverlays(),this.slice.started=!0,this.record.started=!0,this.showbutton=!1,this.auto=!0,this.slice.angiocarpy.result.map(t=>t.image=!0),Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:"angiocarpy",other:JSON.stringify(this.slice.angiocarpy.result.map(t=>({id:t.id,x:t.path.x,y:t.path.y})))}).then(t=>{this.getAlgorithmResult()}).catch(t=>console.log(t)),this.updateRecord()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:"angiocarpy",other:""}).then(t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.slice.started=!1,this.record.started=!1,this.slice.angiocarpy.result.map(t=>t.image=!1),this.updateRecord())}).catch(t=>console.log(t))},updateRecord(){this.$emit("save","auto")},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},beforeMount(){this.slice.angiocarpy||(this.$set(this.slice,"angiocarpy",{}),this.$set(this.slice.angiocarpy,"result",[]),this.$set(this.slice.angiocarpy,"airesult",{})),this.slice.angiocarpy&&!this.slice.angiocarpy.airesult&&this.$set(this.slice.angiocarpy,"airesult",{})},mounted(){this.slice.started&&this.slice.angiocarpy&&null===this.slice.angiocarpy.diagnosis&&this.getAlgorithmResult(),window.addEventListener("online",()=>{this.showbutton||this.getAlgorithmResult()}),Object.keys(this.slice.angiocarpy.airesult).length&&this.addLayer()},beforeDestroy(){clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}},showLayer:{handler(t){t?Object.keys(this.slice.angiocarpy.airesult).length&&this.addLayer():this.viewport.viewer.clearOverlays()},deep:!0}},props:["slice","record"],components:{"v-dragon":v.a,"v-analyroi":Zi,"v-roi":f}},ts={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright"},[i("v-dragon",{staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:this.slice.roilist.map(function(t){return Object.assign({method:"rectangle"},t,{color:{"阳性肿瘤":"red"}[t.jgResult]||"yellow"})}).concat((this.slice.angiocarpy?this.slice.angiocarpy.result:[]).map(function(t){return Object.assign({method:"rectangle"},t,{editable:!1,selectable:!1,color:"grey"})})),curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,position:t.position,showLayer:t.showLayer},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},viewer:function(e){return t.viewport=e},changeShowLayer:function(e){return t.showLayer=e}}}),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.startAnalyze()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v(t._s(t.$t("analyze.airoi")))]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v(t._s(t.$t("analyze.roi")))])]),t._v(" "),t.auto?i("v-analyroi",{staticClass:"table",attrs:{slice:t.slice,ROIS:this.slice.angiocarpy?this.slice.angiocarpy.result:[],sRois:this.slice.angiocarpy?this.slice.angiocarpy.airesult:{},currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.slice.roilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)}}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e(),t._v(" "),0==t.auto?i("div",{staticClass:"opinio"},[i("h1",[t._v("\n                "+t._s(t.$t("analyze.point"))+"\n            ")]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.record.opinion,expression:"record.opinion"}],attrs:{placeholder:t.$t("report.pointremind"),maxlength:"300"},domProps:{value:t.record.opinion},on:{input:[function(e){e.target.composing||t.$set(t.record,"opinion",e.target.value)},t.noEmoji]}})]):t._e()],1)])},staticRenderFns:[]};var es=i("VU/8")(Qi,ts,!1,function(t){i("ElZe")},"data-v-4c749fb6",null).exports,is=null,ss={name:"tree",data(){return{showOptions:!1,templates:[],cruTemplateId:this.templateId,groups:[],defaultProps:{children:"children",label:"label"},pageSize:100,pageIndex:1,tmDisplay:!1,hideAddSon:!1,rightMenu:{top:0,left:0},curGroup:{},rois:{},defaultExpandIds:[]}},methods:{strlen(t){for(var e=0,i=0;i<t.length;i++){var s=t.charCodeAt(i);s>=1&&s<=126||65376<=s&&s<=65439?e++:e+=2}return e},showEtc(t){if(t)return this.strlen(t)<24?t:t.includes(")")?t.slice(0,4)+"..."+t.slice(-7):t.slice(0,4)+"..."+t.slice(-4)},handleNodeExpand(t){let e=!1;this.defaultExpandIds.some(i=>{if(i===t.id)return e=!0,!0}),e||this.defaultExpandIds.push(t.id)},handleNodeCollapse(t){this.defaultExpandIds.some((e,i)=>{e===t.id&&this.defaultExpandIds.splice(i,1)}),this.removeChildrenIds(t)},removeChildrenIds(t){t.children&&t.children.forEach(t=>{const e=this.defaultExpandIds.indexOf(t.id);e>0&&this.defaultExpandIds.splice(e,1),this.removeChildrenIds(t)})},selectTree(t,e){t.children&&(e.isCurrent=!1,this.$refs.vueTree.setCurrentKey(this.group.id))},toogleGroupRois(t){t.is_show=1==t.is_show?-1:1,Object(s.b)(`slice/markShow?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,group_id:t.id}).then(async()=>{if(this.groups=await this.getGroups(this.templateId),this.selectGroup(this.group.id),t.children){let e=null;(await this.getCurGroup(t.id)).children.map(t=>{t.id==this.group.id?e=t:t.children&&t.children.map(t=>{t.id==this.group.id&&(e=t)})}),e?this.$emit("setGroup",e):this.$emit("loadLeft","checkCurRois")}else t.id==this.group.id?this.$emit("setGroup",t):this.$emit("loadLeft","checkCurRois");this.$nextTick(()=>{this.$refs.vueTree.setCurrentKey(this.group.id)})}).catch(t=>{this.$alert(t.message)})},getTemplate(){Object(s.b)(`slice/templateList?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id}).then(({data:t})=>{this.templates=t.templates,this.templateId&&this.$emit("curTem",t.templates.find(t=>t.id==this.templateId))}).catch(()=>{this.templates=[]})},async selectChange(t){this.$emit("setTemplateId",t),this.$emit("curTem",this.templates.find(e=>e.id==t)),this.groups=await this.getGroups(t),this.setGroupChecked(),this.$emit("loadLeft")},getGroups(t){return new Promise(e=>{Object(s.b)(`slice/selectTemplate?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,id:t}).then(({data:t})=>e(t)).catch(t=>e([]))})},dbclick(t){clearTimeout(is),this.reName(t),this.$refs.vueTree.setCurrentKey(this.group.id)},reName(t){this.$set(t,"modify",!0),setTimeout(()=>{this.$refs[t.id].$el.querySelector("input").focus()},200)},async setModifyFalse(t){t.label||(t.label="默认组名称"),this.$set(t,"modify",!1),delete t.modify,await this.modifyGroup("update")},getCurGroup(t){return new Promise(e=>{Object(s.b)(`slice/queryGroup?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,group_id:t}).then(t=>e(t.data)).catch(t=>{this.$alert(t.message)})})},async rightClick(t,e,i){let s=await this.getCurGroup(e.id);e.modify||(3==i.level||2==i.level&&!s.is_empty||1==i.level&&!s.is_empty?this.hideAddSon=!0:this.hideAddSon=!1,this.tmDisplay=!0,this.rightMenu={top:t.pageY+"px",left:t.pageX+"px"},this.curGroup=e,document.onclick=(t=>{t.target!==document.getElementById("perTreeMenu")&&(this.tmDisplay=!1)}))},async colorChange(t){t.color||(this.$set(t,"color","#f00"),t.color),await this.modifyGroup(),this.$emit("setGroup",t)},modifyGroup(t){return new Promise(e=>{Object(s.b)(`slice/modifyGroup?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,groups:JSON.stringify(this.groups)}).then(async()=>{t&&(this.groups=await this.getGroups(this.templateId)),e()}).catch(t=>{this.$alert(t.message)})})},getSon(t){return t.children?this.getSon(t.children[0]):t},setGroupChecked(){if(this.groups.length){let t=this.getSon(this.groups[0]);this.$emit("setGroup",t),this.selectGroup(t.id),this.$nextTick(()=>{this.$refs.vueTree.setCurrentKey(this.group.id)})}else this.$emit("setGroup",{}),this.rois={total:0,marks:[]}},removeExpandIds(t){if(this.defaultExpandIds.includes(t)){let e=this.defaultExpandIds.findIndex(e=>e===t);this.defaultExpandIds.splice(e,1)}},delGroup(t){this.$confirm("删除后该组下的所有组和标注信息将被清空且无法恢复，确定要删除吗？","操作确认",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{Object(s.b)(`slice/deleteGroup?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,group_id:t.id}).then(async()=>{this.groups=await this.getGroups(this.templateId),this.groups.forEach(t=>{t.children?t.children.forEach(t=>{this.removeExpandIds(t.id)}):this.removeExpandIds(t.id)}),this.removeExpandIds(t.id),this.group.id==t.id?this.setGroupChecked():t.children&&t.children.forEach(t=>{t.id==this.group.id&&this.setGroupChecked(),t.children&&t.children.forEach(t=>{t.id==this.group.id&&this.setGroupChecked()})}),this.$emit("loadLeft","checkCurRois")}).catch(t=>{this.$alert(t.message)})}).catch(()=>{})},async newGroup(){let t=await this.getGroupId(),e={id:t,label:"默认组名称",modify:!0,color:"#FF0000",is_empty:1,is_show:1};this.groups.push(e),setTimeout(()=>{document.getElementById(t).focus(),this.$refs.vueTree.setCurrentKey(t),this.pageIndex=1,this.$emit("setGroup",e),this.selectGroup(t)},200)},nodeClick(t){clearTimeout(is),is=setTimeout(async()=>{this.tmDisplay=!1,t.children||(this.pageIndex=1,this.selectGroup(t.id),this.$emit("setGroup",t))},200)},selectGroup(t){Object(s.b)(`slice/selectGroup?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,group_id:t,page:this.pageIndex,per_page:this.pageSize}).then(t=>{this.rois=t.data;let e=Math.ceil(t.data.total/this.pageSize);this.pageIndex>e&&this.pageIndex>1&&this.changeIndex(e)}).catch(t=>this.$alert(t.message))},getGroupId(){return new Promise(t=>{Object(s.b)(`slice/createGroup?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,template_id:this.cruTemplateId}).then(({data:e})=>t(e.new_group_id)).catch(t=>this.$alert(t.message))})},async addSon(){let t=await this.getGroupId(),e={id:t,label:"默认组名称",color:"#FF0000",is_show:1,is_empty:1,modify:!0};this.defaultExpandIds.includes(this.curGroup.id)||this.defaultExpandIds.push(this.curGroup.id),this.curGroup.children?this.curGroup.children.push(e):(this.curGroup.hasOwnProperty("children")&&delete this.curGroup.children,this.$set(this.curGroup,"children",[e])),setTimeout(async()=>{document.getElementById(t)&&document.getElementById(t).focus(),this.$refs.vueTree.setCurrentKey(t),this.pageIndex=1,this.$emit("setGroup",e),this.selectGroup(t)},200)},changeSize(t){this.pageIndex=1,this.pageSize=t,this.selectGroup(this.group.id)},changeIndex(t){this.pageIndex=t,this.selectGroup(this.group.id)}},destroyed(){document.onclick=null},async mounted(){this.getTemplate(),this.templateId&&(this.groups=await this.getGroups(this.templateId),Object.keys(this.group).length?(this.$emit("loadLeft"),this.selectGroup(this.group.id),this.$nextTick(()=>{this.$refs.vueTree.setCurrentKey(this.group.id)})):this.setGroupChecked())},props:["slice","record","templateId","group","currentRois","radius"]},as={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"marklist"},[s("div",{staticClass:"fatherlist"},[s("div",{staticClass:"top"},[s("div",{staticClass:"top-select",on:{click:function(e){t.showOptions=!t.showOptions}}},[s("el-select",{attrs:{placeholder:"请选择"},on:{change:t.selectChange},model:{value:t.cruTemplateId,callback:function(e){t.cruTemplateId=e},expression:"cruTemplateId"}},t._l(t.templates,function(t){return s("el-option",{key:t.id,attrs:{label:t.name,value:t.id}})}),1)],1),t._v(" "),t.cruTemplateId?s("div",{staticClass:"new-group",on:{click:t.newGroup}},[t._v("+新建组")]):t._e()]),t._v(" "),s("div",{staticClass:"group-list"},[s("el-tree",{ref:"vueTree",staticClass:"tree",attrs:{data:t.groups,props:t.defaultProps,"default-expanded-keys":t.defaultExpandIds,"expand-on-click-node":!1,"node-key":"id"},on:{"node-contextmenu":t.rightClick,"node-click":t.selectTree,"node-expand":t.handleNodeExpand,"node-collapse":t.handleNodeCollapse},scopedSlots:t._u([{key:"default",fn:function(e){var i=e.data;return[s("span",{staticStyle:{flex:"1",display:"flex","align-items":"center","justify-content":"space-between","font-size":"14px",width:"100%"}},[s("span",{staticClass:"hide-button",class:{hidden:i.is_show<0},on:{click:function(e){return e.stopPropagation(),t.toogleGroupRois(i)}}}),t._v(" "),i.modify||!i.label?s("span",{staticStyle:{width:"166px"}},[s("el-input",{ref:i.id,attrs:{id:i.id},on:{blur:function(e){return t.setModifyFalse(i)}},model:{value:i.label,callback:function(e){t.$set(i,"label",e)},expression:"data.label"}})],1):s("span",{ref:i.id,staticStyle:{width:"166px",overflow:"hidden","white-space":"nowrap","text-overflow":"ellipsis"},attrs:{title:i.label},on:{click:function(e){return t.nodeClick(i)},dblclick:function(e){return e.stopPropagation(),t.dbclick(i)}}},[t._v("   \n                            "+t._s(i.children?t.showEtc(i.label):t.showEtc(i.label+"("+i.mark_count+")"))+"\n                        ")]),t._v(" "),s("span",{staticStyle:{"font-size":"0"},on:{click:function(t){t.stopPropagation()}}},[i.children?t._e():s("el-color-picker",{staticStyle:{flex:"1"},attrs:{size:"mini"},on:{change:function(e){return t.colorChange(i)}},model:{value:i.color,callback:function(e){t.$set(i,"color",e)},expression:"data.color"}})],1),t._v(" "),s("span",{staticClass:"delimg",on:{click:function(e){return e.stopPropagation(),t.delGroup(i)}}})])]}}])}),t._v(" "),t.tmDisplay?s("div",{staticClass:"tree_menu",style:{left:t.rightMenu.left,top:t.rightMenu.top},attrs:{id:"perTreeMenu"}},[s("ul",[t.hideAddSon?t._e():s("li",{on:{click:t.addSon}},[t._v("新建下级组")]),t._v(" "),s("li",{on:{click:function(e){return t.reName(t.curGroup)}}},[t._v("重命名")])])]):t._e()],1)]),t._v(" "),s("div",{staticClass:"sonlist"},[s("div",{staticClass:"top"},[t.group.label?s("h3",{attrs:{title:t.group.label+"（"+(t.rois.total||0)+"）"}},[t._v(t._s(t.group.label)+"（"+t._s(t.rois.total||0)+"）")]):t._e()]),t._v(" "),s("div",{staticClass:"rois"},[t.rois.total?s("ul",{staticClass:"outerroi"},t._l(t.rois.marks,function(e){return s("li",{key:e.id,staticClass:"roillist",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){return t.$emit("curROI",e,i.shiftKey)}}},[s("span",{staticClass:"sort-name"},[t._v("标注"+t._s(e.index))]),s("span",{staticClass:"sort-name"},[s("input",{directives:[{name:"model",rawName:"v-model",value:e.remark,expression:"roi.remark"}],domProps:{value:e.remark},on:{blur:function(i){return t.$emit("roiChanged","remark",[e])},input:function(i){i.target.composing||t.$set(e,"remark",i.target.value)}}})]),s("span",{staticClass:"delete-bottom",on:{click:function(i){return i.stopPropagation(),t.$emit("delRoi",e.id)}}})])}),0):s("div",{staticClass:"noroi"},[s("img",{attrs:{src:i("SEzi")}}),t._v(" "),s("p",[t._v("当前没有标注 !")])]),t._v(" "),t.rois.total?s("el-pagination",{attrs:{"current-page":t.pageIndex,"page-sizes":[100,200,500],"page-size":t.pageSize,small:"",layout:"sizes, prev, pager, next",total:t.rois.total,"pager-count":5},on:{"size-change":t.changeSize,"current-change":t.changeIndex}}):t._e()],1)])])},staticRenderFns:[]};var ns=i("VU/8")(ss,as,!1,function(t){i("4iXm"),i("dptE")},null,null).exports,os={data(){return{loopHandler:0,centerRegion:null,curRois:{},showbutton:!0,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},lineup:null,showMppGuide:!1,drawMpp:null,parentId:null,curLevel:{},leftRoilist:[],rightRoilist:[],aiFatherRois:[],ki67Anno:null,templateId:this.slice.templateId||null,group:this.slice.group||{},loading:!1,radius:null,filled:!0,curTem:null,currentItem:"",defaultExpandIds:[]}},computed:{showBtn(){return!(!this.curTem||!["ki67","tct","fishTissue","er","pr","pdl1","her2","lct","ki67hot","np","dna","bm"].includes(this.curTem.type))}},methods:{getFilledType(){Object(s.b)(`slice/querySolidStatus?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id}).then(({data:t})=>{this.filled=t.is_solid}).catch(t=>{this.$alert(t.message)})},radiusChanged(t){this.radius=t.target.value,Object(s.b)(`slice/modifyRadius?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,radius:this.radius}).then(async()=>{this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"label",this.templateId)}).catch(t=>{this.$alert(t.message)})},showBg(){this.filled=!this.filled,Object(s.b)(`slice/modifySolidStatus?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,is_solid:1&this.filled}).then(async()=>{this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"label",this.templateId)}).catch(t=>{this.$alert(t.message)})},async loadLeft(t){if(this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"label",this.templateId),t)for(var e in this.curRois)this.leftRoilist.some(t=>t.id==e)||(delete this.curRois[e],this.curRois=Object.assign({},this.curRois))},rightDelRoi(t){this.$confirm("确认删除这个roi?",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,this.slice.toolType,[t],null,this.slice.templateId),this.loading=!1,this.$refs.group.groups=await this.$refs.group.getGroups(this.templateId),delete this.curRois[t],this.loadLeft(),this.$refs.group.selectGroup(this.group.id)}).catch(()=>{})},setTemplateId(t){this.templateId=t,this.$set(this.slice,"templateId",t),this.curRois={}},async setGroup(t){this.group=t,this.$set(this.slice,"group",t),Object.keys(t).length&&(this.loadLeft("checkCurRois"),this.$emit("save"))},importAIresult(){this.$confirm("导入后，原有标注组和标注数据将被清空","操作确认",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warnning"}).then(()=>{this.loading=!0,Object(s.b)(`slice/importAiResult?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id}).then(()=>{this.loading=!1,this.$refs.group.selectChange(this.templateId),this.getFilledType()}).catch(t=>{this.loading=!1,this.$message.error(t.message)})}).catch(t=>t)},showMenu(t,e){if((!t.type||t.button&&!e.dashed)&&(t.preventDefault(),!(0==Object.keys(this.curRois).length||Object.keys(this.curRois).every(t=>t!=e.id)||this.aiFatherRois.some(t=>t.id==e.id)||this.rightRoilist.some(t=>t.id==e.id)))){this.curRois[e.id]&&(this.$refs.group.groups.forEach(t=>{t.id==e.group_id?this.currentItem=t.id+":"+t.id:t.children&&t.children.forEach(i=>{i.id==e.group_id?this.currentItem=t.id+":"+i.id:i.children&&i.children.forEach(s=>{s.id==e.group_id&&(this.currentItem=t.id+":"+i.id+":"+s.id)})})}),this.newover=this.currentItem.substring(0,this.currentItem.lastIndexOf(":")));var i=t.currentTarget,s=t.offsetX,a=t.offsetY,n=i.offsetWidth,o=i.offsetHeight;this.ki67Anno={},this.ki67Anno.hd=s>n/2?"right":"left",this.ki67Anno.vd=a>o/2?"bottom":"top",this.menuPosition={x:s,y:a}}},async setAnnotation(t){this.ki67Anno=null,this.loading=!0,await this.changeRois(t,this.$refs.osd.scope),this.loading=!1,this.$refs.group.groups=await this.$refs.group.getGroups(this.templateId),this.loadLeft(),(Object.values(this.curRois).some(t=>t.group_id==this.group.id)||t==this.group.id)&&this.$refs.group.selectGroup(this.group.id),this.curRois={}},async getRoi(t){let{x1:e,y1:i,x2:s,y2:a,z:n}=t;this.curLevel={x:[e,s],y:[i,a],z:n},this.loadLeft()},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>({[t.id]:t})))},listChangeCurrent(){if(Object.keys(this.curRois).length){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null,this.$refs.osd.scope=null,Object.keys(this.curRois).forEach(t=>{this.leftRoilist.find(e=>e.id===t)||delete this.curRois[t]})}},async roiChanged(t,e){if(e){let i=e.map(e=>({id:e.id,remark:e[t]}));this.loading=!0,await Object(s.c)(this.record.id,this.slice.id,this.slice.toolType,i),this.loading=!1}else this.$refs.osd.scope?this.$message.error("不支持多选移动"):(this.loading=!0,await this.changeRois(null,this.$refs.osd.scope),this.loading=!1,Object.values(this.curRois).some(t=>t.group_id==this.group.id)&&this.$refs.group.selectGroup(this.group.id)),this.$refs.osd.scope&&this.$refs.osd.scope.offset&&(this.curRois={},this.$refs.osd.scope=null),Object.values(this.curRois).some(t=>t.group_id==this.group.id)&&this.$refs.group.selectGroup(this.group.id),this.loadLeft(),this.IsOutFrame()},changeRois(t,e){return new Promise(i=>{Object(s.b)(`slice/modifyMark?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,ai_type:this.slice.toolType,marks:JSON.stringify(Object.values(this.curRois)),selected_group_id:this.group.id,target_group_id:t,scope:JSON.stringify(e),template_id:this.templateId}).then(()=>i()).catch(t=>i())})},newMark(t){return new Promise(e=>{Object(s.b)(`slice/createMark?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,group_id:this.group.id,ai_type:"label",mark:JSON.stringify(t),template_id:this.templateId}).then(({data:t})=>e(t.new_mark_id)).catch(t=>e(null))})},async draw(t,e){Object.keys(this.group).length?this.group.is_show<0?this.$message.error("当前标注组被隐藏，无法绘制！"):(t.strokeColor=this.group.color,t.group_id=this.group.id,t.mark_type=1,t.dashed&&(t.strokeColor="#E3E9EF",t.mark_type=5,t.dashed=1),t.id=await this.newMark(t),t.id&&(this.curROIChange(t,e),this.leftRoilist=[...this.leftRoilist,t],this.loadLeft(),this.$refs.group.groups=await this.$refs.group.getGroups(this.templateId),this.$refs.group.selectGroup(this.group.id),this.IsOutFrame())):this.$message.error("请选择模板或新建一个组！")},async clickDraw(t,e){if(Object.keys(this.group).length)if(this.group.is_show<0)this.$message.error("当前标注组被隐藏，无法绘制！");else{var i={path:{x:[t.x],y:[t.y]},method:"spot",radius:this.radius/(this.slice.mppx||.242042),mark_type:1,fillColor:this.group.color,group_id:this.group.id};i.id=await this.newMark(i),i.id&&(this.curROIChange(i,e),this.leftRoilist=[...this.leftRoilist,i],this.loadLeft(),this.IsOutFrame(),this.$refs.group.groups=await this.$refs.group.getGroups(this.templateId),this.$refs.group.selectGroup(this.group.id))}else this.$message.error("请选择模板或新建一个组！")},IsOutFrame(){Object.keys(this.curRois).map(t=>{this.leftRoilist.some(e=>e.id==t)||(delete this.curRois[t],this.curRois=Object.assign({},this.curRois))})},async delCurRoi(){await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})&&(this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,this.slice.toolType,Object.keys(this.curRois),this.$refs.osd.scope,this.templateId),this.loading=!1,this.$refs.group.groups=await this.$refs.group.getGroups(this.templateId),Object.values(this.curRois).some(t=>t.group_id==this.group.id)&&this.$refs.group.selectGroup(this.group.id),this.curRois={},this.loadLeft())},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||["TEXTAREA","INPUT"].includes(t.target.nodeName)||this.delCurRoi()}},created(){Object(s.b)(`slice/queryRadius?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id}).then(({data:t})=>{this.radius=t.radius}).catch(t=>{this.$alert(t.message)})},async mounted(){this.loadLeft(),this.getFilledType(),console.log(this.config)},props:["slice","record","config"],components:{"v-dragon":v.a,"v-marktree":ns,"v-menus":X}},ls={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright",on:{mousewheel:function(e){t.ki67Anno=null},mousedown:function(e){t.ki67Anno=null}}},[i("v-dragon",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"osd",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:[].concat(t.leftRoilist),curRois:t.curRois,penColor:t.group.color||"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:110,"element-loading-text":"处理中，请耐心等待","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.5)",radius:t.radius,filled:t.filled},on:{curROI:t.curROIChange,draw:t.draw,position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},clickDraw:t.clickDraw,getRoi:t.getRoi,roiChanged:t.roiChanged,parentId:function(e){return t.parentId=e},contextmenu:function(e,i){return t.showMenu(e,i)},setRadius:t.radiusChanged,showBg:t.showBg}},[t.ki67Anno?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+"px",top:t.menuPosition.y+"px"}},[i("v-menus",{attrs:{pos:t.ki67Anno,menus:t.$refs.group.groups,currentItem:t.currentItem,newover:t.newover},on:{chosen:t.setAnnotation}})],1):t._e()]),t._v(" "),t.showBtn?i("button",{style:{right:t.config&&t.config.zeiss?"174px":"102px"},on:{click:t.importAIresult}},[t._v("导入算法结果")]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("v-marktree",{ref:"group",attrs:{slice:t.slice,record:t.record,templateId:t.templateId,group:t.group,currentRois:t.curRois},on:{setTemplateId:t.setTemplateId,curTem:function(e){return t.curTem=e},setGroup:t.setGroup,loadLeft:t.loadLeft,delRoi:t.rightDelRoi,roiChanged:t.roiChanged,curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()}}})],1)])},staticRenderFns:[]};var rs=i("VU/8")(os,ls,!1,function(t){i("M9nz")},"data-v-3d1eeec0",null).exports,cs={data:()=>({showBtn:!1}),computed:{lymbs(){let t={[this.getTotalCount("嗜酸性粒细胞")]:"嗜酸性粒细胞",[this.getTotalCount("淋巴细胞")]:"淋巴细胞",[this.getTotalCount("浆细胞")]:"浆细胞",[this.getTotalCount("中性粒细胞")]:"中性粒细胞"},e=Math.max(...[this.getTotalCount("嗜酸性粒细胞"),this.getTotalCount("淋巴细胞"),this.getTotalCount("浆细胞"),this.getTotalCount("中性粒细胞")]);return[e?t[e]+"：":"",e/this.getAllCount()*100]}},methods:{changeImage(t){this.$set(t,"image",1-(t.image||0)),this.$emit("roiChanged","image",[t])},del(t){this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})},getTotalCount(t){return this.ROIS.filter(t=>t.image).map(e=>e.aiResult[t].count).reduce((t,e)=>t+e,0)},getAllCount(){return this.getTotalCount("嗜酸性粒细胞")+this.getTotalCount("淋巴细胞")+this.getTotalCount("浆细胞")+this.getTotalCount("中性粒细胞")||1},getTotalArea(t){return this.ROIS.filter(t=>t.image).map(e=>e.aiResult[t].area).reduce((t,e)=>t+e,0)},denominator(t){return this.ROIS.filter(t=>t.image).map(e=>e.aiResult[t].total_area).reduce((t,e)=>t+e,0)||1}},props:["ROIS","currentRois"]},hs={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"nprois"},[t.ROIS.length?i("div",{staticClass:"nprtable",style:{height:t.showBtn?"calc(100% - 80px)":"calc(100% - 352px)"}},t._l(t.ROIS,function(e,s){return i("div",{key:s,staticClass:"roilist",on:{click:function(i){t.$emit("curROI",e,i.shiftKey),t.$emit("closecontextmenu")}}},[i("table",{class:{gocheck:t.currentRois[e.id]}},[i("tr",[i("th",{attrs:{width:"100"}},[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){return i.stopPropagation(),t.changeImage(e)}}}),t._v("炎细胞种类")]),i("th",{attrs:{width:"110"}},[t._v("数量")]),i("th",{attrs:{width:"90"}},[t._v("指数（%）")]),i("th",[t._v("操作")])]),t._v(" "),i("tr",{staticStyle:{color:"#FF0000"}},[i("td",[t._v("嗜酸性粒细胞")]),i("td",[t._v(t._s(e.aiResult["嗜酸性粒细胞"].count))]),i("td",[t._v(t._s(e.aiResult["嗜酸性粒细胞"].index))]),i("td",{attrs:{rowspan:"8"}},[i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])]),t._v(" "),i("tr",{staticStyle:{color:"#00EEFF"}},[i("td",[t._v("淋巴细胞")]),i("td",[t._v(t._s(e.aiResult["淋巴细胞"].count))]),i("td",[t._v(t._s(e.aiResult["淋巴细胞"].index))])]),t._v(" "),i("tr",{staticStyle:{color:"#EAFD00"}},[i("td",[t._v("浆细胞")]),i("td",[t._v(t._s(e.aiResult["浆细胞"].count))]),i("td",[t._v(t._s(e.aiResult["浆细胞"].index))])]),t._v(" "),i("tr",{staticStyle:{color:"#66FD00"}},[i("td",[t._v("中性粒细胞")]),i("td",[t._v(t._s(e.aiResult["中性粒细胞"].count))]),i("td",[t._v(t._s(e.aiResult["中性粒细胞"].index))])]),t._v(" "),t._m(0,!0),t._v(" "),i("tr",{staticStyle:{color:"#00FEBB"}},[i("td",[t._v("上皮区域")]),i("td",[t._v(t._s(e.aiResult["上皮区域"].area))]),i("td",[t._v(t._s(e.aiResult["上皮区域"].index))])]),t._v(" "),i("tr",{staticStyle:{color:"#AB86FF"}},[i("td",[t._v("腺体区域")]),i("td",[t._v(t._s(e.aiResult["腺体区域"].area))]),i("td",[t._v(t._s(e.aiResult["腺体区域"].index))])]),t._v(" "),i("tr",{staticStyle:{color:"#D32CD6"}},[i("td",[t._v("血管区域")]),i("td",[t._v(t._s(e.aiResult["血管区域"].area))]),i("td",[t._v(t._s(e.aiResult["血管区域"].index))])])])])}),0):t._e(),t._v(" "),i("div",{staticClass:"tal",class:{short:t.showBtn}},[i("div",{staticClass:"bottom"},[t._v("\n            统计     \n            "),i("span",{style:{transform:t.showBtn?"rotate(180deg)":"rotate(0deg)"},on:{click:function(e){t.showBtn=!t.showBtn}}})]),t._v(" "),!t.showBtn&&t.ROIS.length?i("div",{staticClass:"shownot"},[i("table",[t._m(1),t._v(" "),i("tr",{staticStyle:{color:"#FF0000"}},[i("td",[t._v("嗜酸性粒细胞")]),i("td",[t._v(t._s(t.getTotalCount("嗜酸性粒细胞")))]),i("td",[t._v(t._s(t.getTotalCount("嗜酸性粒细胞")/t.ROIS.length))]),i("td",[t._v(t._s((t.getTotalCount("嗜酸性粒细胞")/t.getAllCount()*100).toFixed(2)))])]),t._v(" "),i("tr",{staticStyle:{color:"#00EEFF"}},[i("td",[t._v("淋巴细胞")]),i("td",[t._v(t._s(t.getTotalCount("淋巴细胞")))]),i("td",[t._v(t._s(t.getTotalCount("淋巴细胞")/t.ROIS.length))]),i("td",[t._v(t._s((t.getTotalCount("淋巴细胞")/t.getAllCount()*100).toFixed(2)))])]),t._v(" "),i("tr",{staticStyle:{color:"#EAFD00"}},[i("td",[t._v("浆细胞")]),i("td",[t._v(t._s(t.getTotalCount("浆细胞")))]),i("td",[t._v(t._s(t.getTotalCount("浆细胞")/t.ROIS.length))]),i("td",[t._v(t._s((t.getTotalCount("浆细胞")/t.getAllCount()*100).toFixed(2)))])]),t._v(" "),i("tr",{staticStyle:{color:"#66FD00"}},[i("td",[t._v("中性粒细胞")]),i("td",[t._v(t._s(t.getTotalCount("中性粒细胞")))]),i("td",[t._v(t._s(t.getTotalCount("中性粒细胞")/t.ROIS.length))]),i("td",[t._v(t._s((t.getTotalCount("中性粒细胞")/t.getAllCount()*100).toFixed(2)))])])]),t._v(" "),i("table",[t._m(2),t._v(" "),i("tr",{staticStyle:{color:"#00FEBB"}},[i("td",[t._v("上皮区域")]),i("td",[t._v(t._s(t.getTotalArea("上皮区域").toFixed(2)))]),i("td",[t._v(t._s((t.getTotalArea("上皮区域")/t.ROIS.length).toFixed(2)))]),i("td",[t._v(t._s((t.getTotalArea("上皮区域")/t.denominator("上皮区域")*100).toFixed(2)))])]),t._v(" "),i("tr",{staticStyle:{color:"#AB86FF"}},[i("td",[t._v("腺体区域")]),i("td",[t._v(t._s(t.getTotalArea("腺体区域").toFixed(2)))]),i("td",[t._v(t._s((t.getTotalArea("腺体区域")/t.ROIS.length).toFixed(2)))]),i("td",[t._v(t._s((t.getTotalArea("腺体区域")/t.denominator("腺体区域")*100).toFixed(2)))])]),t._v(" "),i("tr",{staticStyle:{color:"#D32CD6"}},[i("td",[t._v("血管区域")]),i("td",[t._v(t._s(t.getTotalArea("血管区域").toFixed(2)))]),i("td",[t._v(t._s((t.getTotalArea("血管区域")/t.ROIS.length).toFixed(2)))]),i("td",[t._v(t._s((t.getTotalArea("血管区域")/t.denominator("血管区域")*100).toFixed(2)))])])])]):t._e(),t._v(" "),i("div",{staticClass:"doc-check"},[t._v(t._s(t.lymbs[0])),i("span",[t._v(t._s(t.lymbs[1].toFixed(2))+"%")])])])])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("tr",[e("td",{staticClass:"thed"},[this._v("区域种类")]),e("td",{staticClass:"thed"},[this._v("面积（um²）")]),e("td",{staticClass:"thed"},[this._v("指数（%）")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("tr",[e("th",{attrs:{width:"100"}},[this._v("炎细胞种类")]),e("th",{attrs:{width:"80"}},[this._v("总数")]),e("th",{attrs:{width:"90"}},[this._v("平均数")]),e("th",[this._v("指数（%）")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("tr",[e("th",{attrs:{width:"100"}},[this._v("区域种类")]),e("th",{attrs:{width:"80"}},[this._v("总面积（um²）")]),e("th",{attrs:{width:"90"}},[this._v("平均面积（um²）")]),e("th",[this._v("指数（%）")])])}]};var us=i("VU/8")(cs,hs,!1,function(t){i("5ie8"),i("dope")},null,null).exports,ds={data:()=>({labeltree:[{id:1,label:"嗜酸性粒细胞"},{id:2,label:"淋巴细胞"},{id:3,label:"浆细胞"},{id:4,label:"中性粒细胞"}],roiTypeOpitions:{1:"#FF0000",2:"#00EEFF",3:"#EAFD00",4:"#66FD00",5:"#00FEBB",6:"#AB86FF",7:"#D32CD6"},defaultColor:"#FF0000",defaultType:1,moveStatus:"countEnd",isMaxlvl:!1,screenCount:[],curCount:{}}),methods:{totalCount:t=>t["嗜酸性粒细胞"]+t["淋巴细胞"]+t["浆细胞"]+t["中性粒细胞"]||1,movetoCenter(t){let e=this.slice.width/this.slice.height,i=this.$refs.osd;switch(t){case"lefttop":i.move(.25,.25/e,Math.min(i.offsetHeight/i.offsetWidth*e*2,2));break;case"righttop":i.move(.75,.25/e,Math.min(i.offsetHeight/i.offsetWidth*e*2,2));break;case"leftbottom":i.move(.25,.75/e,Math.min(i.offsetHeight/i.offsetWidth*e*2,2));break;case"rightbottom":i.move(.75,.75/e,Math.min(i.offsetHeight/i.offsetWidth*e*2,2))}},changeMoveStatus(t){this.moveStatus=t,"moveEnd"==t&&this.slice.ai_suggest&&this.getScreenCount()},getScreenCount(){Object(s.b)(`slice/getScreenCount?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,position:JSON.stringify(this.curLevel),ai_type:"np"}).then(({data:t})=>{this.isMaxlvl=t.isMaxlvl,this.moveStatus="countEnd",!t.isMaxlvl&&this.fullField?this.screenCount=Object.values(t.result):this.curCount=t.result})}},computed:{fullField(){return this.aiFatherRois.some(t=>t.aiResult.whole_slide)}},components:{"v-dragon":v.a,"v-analyroi":us,"v-roi":f,"v-menus":X},mixins:[U]},ps={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright",class:{showall:t.fullField&&!t.isMaxlvl,"fixed-showall":t.$refs.osd&&t.$refs.osd.fullPage},on:{mousewheel:function(e){t.ki67Anno=null},mousedown:function(e){t.ki67Anno=null}}},[i("v-dragon",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"osd",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:t.leftRoilist,curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,moveStatus:t.moveStatus,position:t.position,showMppGuide:t.showMppGuide,cellArea:110,"element-loading-text":"处理中，请耐心等待","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.5)"},on:{changeMoveStatus:t.changeMoveStatus,curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},clickDraw:t.clickDraw,getRoi:function(e){return t.getRoi(e)},roiChanged:t.roiChanged,parentId:function(e){return t.parentId=e},contextmenu:function(e,i){return t.showMenu(e,i)}}},[t.ki67Anno?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+"px",top:t.menuPosition.y+"px"}},[i("v-menus",{attrs:{pos:t.ki67Anno,menus:t.labeltree,currentItem:t.currentItem,newover:t.newover},on:{chosen:function(e){return t.setAnnotation(e)}}})],1):t._e(),t._v(" "),(t.isMaxlvl&&t.fullField||!t.fullField)&&t.slice.ai_suggest?i("div",{staticClass:"tps btmcenter"},[i("p",[t._v("嗜酸性粒细胞："),"countEnd"==t.moveStatus?i("span",[t._v(t._s(t.curCount["嗜酸性粒细胞"])+"（"+t._s((t.curCount["嗜酸性粒细胞"]/t.totalCount(t.curCount)*100).toFixed(2))+"%）")]):t._e()]),t._v(" "),i("p",[t._v("淋巴细胞："),"countEnd"==t.moveStatus?i("span",[t._v(t._s(t.curCount["淋巴细胞"])+"（"+t._s((t.curCount["淋巴细胞"]/t.totalCount(t.curCount)*100).toFixed(2))+"%）")]):t._e()]),t._v(" "),i("p",[t._v("浆细胞："),"countEnd"==t.moveStatus?i("span",[t._v(t._s(t.curCount["浆细胞"])+"（"+t._s((t.curCount["浆细胞"]/t.totalCount(t.curCount)*100).toFixed(2))+"%）")]):t._e()]),t._v(" "),i("p",[t._v("中性粒细胞："),"countEnd"==t.moveStatus?i("span",[t._v(t._s(t.curCount["中性粒细胞"])+"（"+t._s((t.curCount["中性粒细胞"]/t.totalCount(t.curCount)*100).toFixed(2))+"%）")]):t._e()]),t._v(" "),"countEnd"!=t.moveStatus?i("div",{staticClass:"start",class:{end:"moveEnd"==t.moveStatus}}):t._e()]):t._e(),t._v(" "),t.fullField&&!t.isMaxlvl?i("div",t._l(t.screenCount,function(e,s){return i("div",{key:s,staticClass:"tps",class:{lefttop:0==s,righttop:1==s,leftbottom:2==s,rightbottom:3==s}},[i("p",[t._v("嗜酸性粒细胞："),"countEnd"==t.moveStatus?i("span",[t._v(t._s(e["嗜酸性粒细胞"])+"（"+t._s((e["嗜酸性粒细胞"]/t.totalCount(e)*100).toFixed(2))+"%）")]):t._e()]),t._v(" "),i("p",[t._v("淋巴细胞："),"countEnd"==t.moveStatus?i("span",[t._v(t._s(e["淋巴细胞"])+"（"+t._s((e["淋巴细胞"]/t.totalCount(e)*100).toFixed(2))+"%）")]):t._e()]),t._v(" "),i("p",[t._v("浆细胞："),"countEnd"==t.moveStatus?i("span",[t._v(t._s(e["浆细胞"])+"（"+t._s((e["浆细胞"]/t.totalCount(e)*100).toFixed(2))+"%）")]):t._e()]),t._v(" "),i("p",[t._v("中性粒细胞："),"countEnd"==t.moveStatus?i("span",[t._v(t._s(e["中性粒细胞"])+"（"+t._s((e["中性粒细胞"]/t.totalCount(e)*100).toFixed(2))+"%）")]):t._e()]),t._v(" "),"countEnd"!=t.moveStatus?i("div",{staticClass:"start",class:{end:"moveEnd"==t.moveStatus}}):t._e()])}),0):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("div",{staticClass:"quality"},[t._m(0),t._v(" "),i("div",{staticClass:"quality-detail"},[i("p",[t._v("清 晰 度："+t._s(t.slice.clarity?(100*t.slice.clarity).toFixed(2)+"%":"-"))]),t._v(" "),i("p",[t._v("扫描倍数："+t._s(t.slice.objective_rate||"-"))])])]),t._v(" "),i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v("AI处理")]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v("手动处理")])]),t._v(" "),t.auto?i("v-analyroi",{staticClass:"table",attrs:{slice:t.slice,ROIS:t.aiFatherRois,currentRois:t.curRois},on:{roiChanged:t.roiChanged,delRoi:function(e){return t.delCurRoi(e)},movetoCenter:t.movetoCenter,curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()}}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.rightRoilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"title"},[e("span",[this._v("AI质控")])])}]};var vs=i("VU/8")(ds,ps,!1,function(t){i("2UPN")},"data-v-4789ee4a",null).exports,ms={data(){return{index:0,options:[{value:"HER-2 0",label:"HER-2 0"},{value:"HER-2 1+",label:"HER-2 1+"},{value:"HER-2 2+",label:"HER-2 2+"},{value:"HER-2 3+",label:"HER-2 3+"}],checkResult:this.slice.alg===this.slice.toolType&&this.slice.check_result.slice(0,this.slice.check_result.length-1)||null}},methods:{changeResult(t){this.checkResult=t,this.$emit("update",t)},changeImage(t){this.$set(t,"image",1-(t.image||0)),this.$emit("roiChanged","image",[t])},checkall(){if(!this.ROIS.length)return;let t=this.ROIS.every(t=>!!t.image),e=this.ROIS.map(e=>{return{id:e.id,image:t?0:1}});this.$emit("roiChanged","image",e)},del(t){this.$emit("closecontextmenu"),this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.$emit("delRoi",t)},()=>{})}},props:["ROIS","currentRois","ave","slice"]},gs={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cdrois"},[t.ROIS?i("div",{staticClass:"cdtable"},[i("div",{staticClass:"top"},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:0==t.ROIS.length?"":t.ROIS.every(function(t){return!!t.image})},on:{click:t.checkall}}),t._v("\n                    ROI\n                ")])]),t._v(" "),i("div",{staticClass:"long"},[t._v("阳性肿瘤")]),t._v(" "),i("div",{staticClass:"total"},[t._v(t._s(t.$t("slice.total")))]),t._v(" "),i("div",{staticClass:"tps"},[t._v("TPS")]),t._v(" "),i("div",{staticClass:"option"},[t._v(t._s(t.$t("slice.deleted")))])]),t._v(" "),i("div",{staticClass:"rois"},t._l(t.ROIS,function(e,s){return i("div",{key:s},[i("div",{staticClass:"row",class:{curRoi:t.currentRois[e.id]},on:{click:function(i){t.$emit("closecontextmenu"),t.$emit("curROI",e,i.shiftKey)}}},[i("div",{staticClass:"left"},[i("div",[i("span",{staticClass:"uncheck",class:{checked:e.image},on:{click:function(i){return i.stopPropagation(),t.changeImage(e)}}}),t._v("\n                            "+t._s(s+1)+"\n                        ")])]),t._v(" "),i("div",{staticClass:"long",attrs:{title:e.aiResult.pos_tumor}},[t._v(t._s(e.aiResult.pos_tumor))]),t._v(" "),i("div",{staticClass:"total",attrs:{title:e.aiResult.total}},[t._v("\n                        "+t._s(e.aiResult.total)+"\n                    ")]),t._v(" "),i("div",{staticClass:"tps"},[t._v(t._s((100*e.aiResult.tps).toFixed(2)+"%")+"\n                    ")]),t._v(" "),i("div",{staticClass:"option"},[i("em",{staticClass:"eidt",attrs:{title:"详情"},on:{click:function(e){e.stopPropagation(),t.index===s?t.index=null:t.index=s}}}),t._v(" "),i("em",{attrs:{title:t.$t("upload.delete")},on:{click:function(i){return i.stopPropagation(),t.del(e)}}})])]),t._v(" "),t.index===s?i("div",{staticClass:"roi-detail"},[i("div",{staticClass:"detail-son"},[i("div",{staticClass:"left"},[t._v("1+")]),t._v(" "),i("div",{staticClass:"long"},[t._v(t._s(e.aiResult["1+"]))]),t._v(" "),i("div",{staticClass:"total"},[t._v(t._s(e.aiResult.total))]),t._v(" "),i("div",{staticClass:"tps"},[t._v(t._s((100*e.aiResult["1+tps"]).toFixed(2)+"%"))]),t._v(" "),i("div",{staticClass:"option"})]),t._v(" "),i("div",{staticClass:"detail-son"},[i("div",{staticClass:"left"},[t._v("2+")]),t._v(" "),i("div",{staticClass:"long"},[t._v(t._s(e.aiResult["2+"]))]),t._v(" "),i("div",{staticClass:"total"},[t._v(t._s(e.aiResult.total))]),t._v(" "),i("div",{staticClass:"tps"},[t._v(t._s((100*e.aiResult["2+tps"]).toFixed(2)+"%"))]),t._v(" "),i("div",{staticClass:"option"})]),t._v(" "),i("div",{staticClass:"detail-son"},[i("div",{staticClass:"left"},[t._v("3+")]),t._v(" "),i("div",{staticClass:"long"},[t._v(t._s(e.aiResult["3+"]))]),t._v(" "),i("div",{staticClass:"total"},[t._v(t._s(e.aiResult.total))]),t._v(" "),i("div",{staticClass:"tps"},[t._v(t._s((100*e.aiResult["3+tps"]).toFixed(2)+"%"))]),t._v(" "),i("div",{staticClass:"option"})])]):t._e()])}),0)]):t._e(),t._v(" "),t.ROIS?i("div",{staticClass:"cdbtm"},[i("div",{staticClass:"result",staticStyle:{color:"#D9001B"}},[i("div",[t._v("\n                阳性肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.pos_tumor}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result",staticStyle:{color:"#70B603"}},[i("div",[t._v("\n                阴性肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.neg_tumor}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result",staticStyle:{color:"#C280FF"}},[i("div",[t._v("\n                阳性非肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.pos_norm}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result",staticStyle:{color:"#FFFF00"}},[i("div",[t._v("\n                阴性非肿瘤细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.neg_norm}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result",staticStyle:{color:"#F59A23"}},[i("div",[t._v("\n                阳性不确定细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.pos_cell_uncertain}).reduce(function(t,e){return t+e},0))+"\n                "),i("button",{on:{click:function(e){return t.$emit("adopt","withdraw",1)}}},[t._v("撤销")]),t._v(" "),i("button",{on:{click:function(e){return t.$emit("adopt","adopt",1)}}},[t._v("纳入")])])]),t._v(" "),i("div",{staticClass:"result",staticStyle:{color:"#02A7F0"}},[i("div",[t._v("\n                阴性不确定细胞\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.neg_cell_uncertain}).reduce(function(t,e){return t+e},0))+"\n                "),i("button",{on:{click:function(e){return t.$emit("adopt","withdraw",2)}}},[t._v("撤销")]),t._v(" "),i("button",{on:{click:function(e){return t.$emit("adopt","adopt",2)}}},[t._v("纳入")])])]),t._v(" "),i("div",{staticClass:"result"},[i("div",[t._v("\n                肿瘤总数\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ROIS.filter(function(t){return t.image}).map(function(t){return t.aiResult.total}).reduce(function(t,e){return t+e},0))+"\n            ")])]),t._v(" "),i("div",{staticClass:"result"},[i("div",[t._v("\n                TPS\n            ")]),t._v(" "),i("div",[t._v("\n                "+t._s(t.ave)+"%\n            ")])])]):t._e(),t._v(" "),i("div",{staticClass:"recheck"},[i("div",{staticClass:"doc-check"},[i("i",[t._v("医生复核")]),t._v(" "),i("span",{on:{click:function(e){return t.changeResult("")}}},[t._v("清空")]),t._v(" "),i("span",{on:{click:function(e){return t.changeResult(t.ave)}}},[t._v("采纳AI建议")])]),t._v(" "),i("div",{staticClass:"check-result"},[t._v("指数"),i("input",{directives:[{name:"model",rawName:"v-model",value:t.checkResult,expression:"checkResult"}],domProps:{value:t.checkResult},on:{blur:function(e){return t.changeResult(t.checkResult)},input:function(e){e.target.composing||(t.checkResult=e.target.value)}}}),t._v("%")])])])},staticRenderFns:[]};var fs=i("VU/8")(ms,gs,!1,function(t){i("g+uk"),i("zgHq")},null,null).exports,_s={data:()=>({typeOptions:[{value:1,label:"外周T细胞淋巴瘤"},{value:2,label:"弥漫大B细胞淋巴瘤"},{value:3,label:"B细胞淋巴瘤"},{value:4,label:"T细胞淋巴瘤"}],labeltree:[{id:257,label:"阴性肿瘤细胞"},{id:258,label:"阳性肿瘤细胞-1+"},{id:259,label:"阳性肿瘤细胞-2+"},{id:260,label:"阳性肿瘤细胞-3+"},{id:261,label:"阴性非肿瘤细胞"},{id:262,label:"阳性非肿瘤细胞-1+"},{id:263,label:"阳性非肿瘤细胞-2+"},{id:264,label:"阳性非肿瘤细胞-3+"},{id:265,label:"纤维细胞"},{id:277,label:"阳性不确定细胞-1+"},{id:278,label:"阳性不确定细胞-2+"},{id:279,label:"阳性不确定细胞-3+"},{id:280,label:"阴性不确定细胞"}],roiTypeOpitions:{257:"#70B603",258:"#D9001B",259:"#D9001B",260:"#D9001B",261:"#FFFF00",262:"#C280FF",263:"#C280FF",264:"#C280FF",265:"#FFFF00",277:"#F59A23",278:"#F59A23",279:"#F59A23",280:"#02A7F0"},defaultColor:"#70B603",defaultType:257,model_type:1}),methods:{isDrawMpp(){this.startAnalyze()},adopt(t,e){let i="adopt"===t?`slice/adopt?companyid=${Object(s.o)().company}`:`slice/revoke?companyid=${Object(s.o)().company}`;const a="adopt"===t?{adopt_type:e,caseid:this.record.id,fileid:this.slice.id}:{revoke_type:e,caseid:this.record.id,fileid:this.slice.id},n="adopt"===t?"纳入成功":"撤销成功";Object(s.b)(i,a).then(async()=>{this.$message.success(n),this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,"cd30"),this.curRois={},this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,"cd30")}).catch(t=>this.$message.error(t.message))}},computed:{ave(){return(this.aiFatherRois.filter(t=>t.image).map(t=>t.aiResult.pos_tumor).reduce((t,e)=>t+e,0)/((this.aiFatherRois.filter(t=>t.image).map(t=>t.aiResult.pos_tumor).reduce((t,e)=>t+e,0)||0)+this.aiFatherRois.filter(t=>t.image).map(t=>t.aiResult.neg_tumor).reduce((t,e)=>t+e,0)||1)*100).toFixed(2)}},components:{"v-dragon":v.a,"v-analyroi":fs,"v-roi":f,"v-menus":X},mixins:[U]},ys={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",attrs:{tabIndex:0},on:{keydown:t.keydown}},[i("div",{staticClass:"analyright",on:{mousewheel:function(e){t.ki67Anno=null},mousedown:function(e){t.ki67Anno=null}}},[i("v-dragon",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"osd",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:t.leftRoilist,curRois:t.curRois,penColor:t.auto?"grey":"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:110,"element-loading-text":"处理中，请耐心等待","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.5)"},on:{curROI:t.curROIChange,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},closeMppGuide:function(e){t.showMppGuide=!1},changeMpp:function(e){return t.drawMpp=e},clickDraw:t.clickDraw,getRoi:function(e){return t.getRoi(e)},roiChanged:t.roiChanged,parentId:function(e){return t.parentId=e},contextmenu:function(e,i){return t.showMenu(e,i)}}},[t.ki67Anno?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+"px",top:t.menuPosition.y+"px"}},[i("v-menus",{attrs:{pos:t.ki67Anno,menus:t.labeltree,currentItem:t.currentItem,newover:t.newover},on:{chosen:function(e){return t.setAnnotation(e)}}})],1):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.isDrawMpp()}}},[t._v(t._s(t.$t("slice.start")))]):t._e(),t._v(" "),i("el-select",{staticClass:"m-2",model:{value:t.model_type,callback:function(e){t.model_type=e},expression:"model_type"}},t._l(t.typeOptions,function(t){return i("el-option",{key:t.value,attrs:{label:t.label,value:t.value}})}),1)],1),t._v(" "),i("div",{staticClass:"analylist"},[i("div",{staticClass:"quality"},[t._m(0),t._v(" "),i("div",{staticClass:"quality-detail"},[i("p",[t._v("清 晰 度："+t._s(t.slice.clarity?(100*t.slice.clarity).toFixed(2)+"%":"-"))]),t._v(" "),i("p",[t._v("扫描倍数："+t._s(t.slice.objective_rate||"-"))])])]),t._v(" "),i("h2",[i("span",{class:t.auto?"auto":"",on:{click:function(e){t.auto=!0}}},[t._v("AI处理")]),t._v(" "),i("span",{class:t.auto?"":"noauto",on:{click:function(e){t.auto=!1}}},[t._v("手动处理")])]),t._v(" "),t.auto?i("v-analyroi",{staticClass:"table",attrs:{slice:t.slice,ROIS:t.aiFatherRois,ave:t.ave,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged,update:function(e){return t.reCheck(e?e+"%":"")},closecontextmenu:function(e){t.ki67Anno=null},adopt:t.adopt}}):t._e(),t._v(" "),t.auto?t._e():i("v-roi",{staticClass:"manualroi",attrs:{roilist:t.rightRoilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}}),t._v(" "),!t.showbutton&&t.auto?i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:t.canceltesk}},[t._v(t._s(t.$t("slice.cancelTasks")))])]):t._e()],1)])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"title"},[e("span",[this._v("AI质控")])])}]};var bs=i("VU/8")(_s,ys,!1,function(t){i("cAUE")},"data-v-483961e2",null).exports,Rs={name:"v-menus",props:["menus","currentItem","pos","newover"],data(){var t={position:{},over:this.newover.substring(0,this.newover.indexOf(":"))||this.newover,curWidth:0,childPos:{}};return this.pos&&"top"==this.pos.vd?t.position.top=0:this.pos&&"bottom"==this.pos.vd&&(t.position.bottom=0),this.pos&&"left"==this.pos.hd?t.position.left=0:this.pos&&"right"==this.pos.hd&&(t.position.right=0),t},methods:{mouseOver(t){this.over=t}},updated(){this.curWidth=this.$refs[this.over].clientWidth+5},watch:{over:{immediate:!0,handler(){this.$nextTick(()=>{this.curWidth=this.$refs[this.over].clientWidth+5})}},pos:{immediate:!0,handler(){this.$nextTick(()=>{this.childPos={hd:this.pos&&this.pos.hd,vd:this.pos&&"top"==this.pos.vd?"bottom":"top"}})}}},components:{"v-menus":ws}},Cs={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{ref:t.over,staticClass:"container",style:t.position},t._l(t.menus,function(e,s){return i("div",{key:s,staticClass:"item",class:t.over==e.id?"active":"",on:{mouseover:function(i){return t.mouseOver(e.id)},mousedown:function(t){return t.stopPropagation(),t},click:function(i){i.stopPropagation(),(!e.children||!e.children.length)&&t.$emit("chosen",e.id)}}},[t.currentItem&&t.currentItem.split(":")[0]==e.id?i("span",{staticClass:"left"}):t._e(),t._v("\n        "+t._s(e.label)+"\n        "),e.id==t.over&&e.children?i("v-menus",{key:s,style:{transform:"translate("+("left"==t.pos.hd?t.curWidth+"px":-t.curWidth+"px")+",0"},attrs:{newover:t.currentItem&&t.currentItem.split(":").length>2?t.currentItem.substring(t.currentItem.indexOf(":")+1):t.currentItem.split(":")[0],menus:e.children,currentItem:t.currentItem&&t.currentItem.split(":").slice(1).join(":"),pos:t.childPos},on:{chosen:function(e){return t.$emit("chosen",e)}}}):t._e(),t._v(" "),e.children&&e.children.length?i("span",{staticClass:"right"}):t._e()],1)}),0)},staticRenderFns:[]};var ws=i("VU/8")(Rs,Cs,!1,function(t){i("9Rlj")},"data-v-ee052492",null).exports,ks={props:["slice","record","config"],components:{"v-dragon":v.a,"v-roi":f,"v-menus":ws},data(){return{curLevel:{},rightRoilist:[],aiFatherRois:[],curRois:{},ki67Anno:null,showMppGuide:!1,showbutton:!0,lineup:null,loopHandler:0,centerRegion:null,position:{offx:this.slice.position?this.slice.position.offx:.5,offy:this.slice.position?this.slice.position.offy:.5*this.slice.height/this.slice.width,zoom:this.slice.position?this.slice.position.zoom:null},parentId:null,loading:!1,currentItem:"",newover:"",auto:"one",leftRoilist:[],aiRoilist:[],humanRoilist:[],options:["HSIL","ASC-H","LSIL","ASC-US","AGC"],showType:"HSIL",showHumanType:"HSIL",aiResult:{},humanResult:{},cells:[],docResult:{microbe:[],background:[],tps:[],diagnosis:""},showTips:!1,labeltree:[{id:"骨髓细胞分类-红系",label:"骨髓细胞分类-红系",children:[{id:"原始红细胞",label:"原始红细胞"},{id:"中幼红细胞",label:"中幼红细胞"},{id:"早幼红细胞",label:"早幼红细胞"},{id:"晚幼红细胞",label:"晚幼红细胞"}]},{id:"骨髓细胞分类-单核系",label:"骨髓细胞分类-单核系",children:[{id:"原始单核细胞",label:"原始单核细胞"},{id:"单核细胞",label:"单核细胞"},{id:"异常单核细胞（PB）",label:"异常单核细胞（PB）"},{id:"幼稚单核细胞",label:"幼稚单核细胞"}]},{id:"骨髓细胞分类-巨核系",label:"骨髓细胞分类-巨核系",children:[{id:"原始巨核细胞",label:"原始巨核细胞"},{id:"幼稚巨核细胞",label:"幼稚巨核细胞"},{id:"颗粒型巨核细胞",label:"颗粒型巨核细胞"},{id:"产版型巨核细胞",label:"产版型巨核细胞"},{id:"裸核型巨核细胞",label:"裸核型巨核细胞"}]},{id:"骨髓细胞分类-浆细胞",label:"骨髓细胞分类-浆细胞",children:[{id:"浆细胞",label:"浆细胞"},{id:"骨髓瘤细胞",label:"骨髓瘤细胞"}]},{id:"骨髓细胞分类-Auer小体",label:"骨髓细胞分类-Auer小体",children:[{id:"柴捆细胞",label:"柴捆细胞"},{id:"含Auer小体细胞",label:"含Auer小体细胞"}]},{id:"骨髓细胞分类-Artefacts",label:"骨髓细胞分类-Artefacts",children:[{id:"Smudge cell",label:"Smudge cell"},{id:"Artefact",label:"Artefact"}]},{id:"骨髓细胞分类-淋巴系",label:"骨髓细胞分类-淋巴系",children:[{id:"原始淋巴细胞",label:"原始淋巴细胞"},{id:"淋巴细胞",label:"淋巴细胞"},{id:"反应性淋巴细胞",label:"反应性淋巴细胞"},{id:"大颗粒淋巴细胞",label:"大颗粒淋巴细胞"},{id:"毛细胞",label:"毛细胞"},{id:"套细胞",label:"套细胞"},{id:"滤泡细胞",label:"滤泡细胞"},{id:"Burkkit细胞",label:"Burkkit细胞"},{id:"淋巴瘤细胞（其他）",label:"淋巴瘤细胞（其他）"},{id:"幼稚淋巴细胞",label:"幼稚淋巴细胞"}]},{id:"骨髓细胞分类-粒系",label:"骨髓细胞分类-粒系",children:[{id:"原始粒细胞",label:"原始粒细胞"},{id:"早幼粒细胞",label:"早幼粒细胞"},{id:"中性中幼粒细胞",label:"中性中幼粒细胞"},{id:"中性杆状核粒细胞",label:"中性杆状核粒细胞"},{id:"嗜酸性粒细胞",label:"嗜酸性粒细胞"},{id:"嗜碱性粒细胞",label:"嗜碱性粒细胞"},{id:"异常早幼粒细胞",label:"异常早幼粒细胞"},{id:"异常中幼粒细胞t(8,21)",label:"异常中幼粒细胞t(8,21)"},{id:"异常嗜酸性粒细胞 inv(16)",label:"异常嗜酸性粒细胞 inv(16)"},{id:"中性晚幼粒细胞",label:"中性晚幼粒细胞"},{id:"中性分叶核粒细胞",label:"中性分叶核粒细胞"}]},{id:"骨髓细胞分类-其他细胞",label:"骨髓细胞分类-其他细胞",children:[{id:"成骨细胞",label:"成骨细胞"},{id:"破骨细胞",label:"破骨细胞"},{id:"戈谢细胞",label:"戈谢细胞"},{id:"海蓝细胞",label:"海蓝细胞"},{id:"尼曼匹克细胞",label:"尼曼匹克细胞"},{id:"分裂象",label:"分裂象"},{id:"转移瘤细胞",label:"转移瘤细胞"},{id:"吞噬细胞",label:"吞噬细胞"}]},{id:"MDS病态造血-红系",label:"MDS病态造血-红系",children:[{id:"核异常-核出芽",label:"核异常-核出芽"},{id:"核异常-核间桥",label:"核异常-核间桥"},{id:"核异常-核碎裂",label:"核异常-核碎裂"},{id:"核异常-多个核",label:"核异常-多个核"},{id:"胞浆异常-胞浆空泡",label:"胞浆异常-胞浆空泡"},{id:"大小异常-巨幼样变",label:"大小异常-巨幼样变"}]},{id:"MDS病态造血-粒系",label:"MDS病态造血-粒系",children:[{id:"核异常-分叶过多",label:"核异常-分叶过多"},{id:"核异常-分叶减少",label:"核异常-分叶减少"},{id:"胞浆异常-颗粒减少",label:"胞浆异常-颗粒减少"},{id:"胞浆异常-杜勒小体",label:"胞浆异常-杜勒小体"},{id:"胞浆异常-Auer小体",label:"胞浆异常-Auer小体"},{id:"大小异常-巨幼样变",label:"大小异常-巨幼样变"}]},{id:"MDS病态造血-巨核系",label:"MDS病态造血-巨核系",children:[{id:"大小异常-微小巨核",label:"大小异常-微小巨核"},{id:"大小异常-单圆巨核",label:"大小异常-单圆巨核"},{id:"大小异常-多圆巨核",label:"大小异常-多圆巨核"},{id:"核异常-核分叶减少",label:"核异常-核分叶减少"}]},{id:"MPN巨核细胞",label:"MPN巨核细胞",children:[{id:"CML-侏儒状巨核",label:"CML-侏儒状巨核"},{id:"ET-鹿角状巨核",label:"ET-鹿角状巨核"},{id:"PMF-气球状巨核",label:"PMF-气球状巨核"}]},{id:"原虫及真菌",label:"原虫及真菌",children:[{id:"疟原虫",label:"疟原虫"},{id:"利杜体",label:"利杜体"},{id:"马尔尼菲青霉菌",label:"马尔尼菲青霉菌"},{id:"荚膜组织胞浆菌",label:"荚膜组织胞浆菌"}]},{id:"血小板",label:"血小板",children:[{id:"血小板",label:"血小板"}]}],roiTypeOpitions:{HSIL:"#FF8A01",ASCH:"#FF8A01",LSIL:"#FF8A01","ASC-US":"#FF8A01",AGC:"#FF8A01","阴性":"#039D12","异物":"#039D12","滴虫":"#0000FF","霉菌":"#0000FF","线索":"#0000FF","放线菌":"#0000FF","疱疹":"#0000FF","不确定":"yellow"},contextmenuPosition:null,observer:null,curModule:"cellresult",clickTimer:null,currentFatherCellGroupIndex:0,currentSonCellGroupIndex:0,currentHumanFatherCellGroupIndex:0,currentHumanSonCellGroupIndex:0}},methods:{reCheck(t){this.$set(this.slice,"check_result",t),this.slice.alg!=this.alg&&(this.$set(this.slice,"alg",this.alg),this.$set(this.slice,"ai_suggest",null)),this.$emit("save")},getNum:(t,e)=>t+e,async start(t=this.record.id,e=this.slice.id,i=this.slice.filename){let a=this.aiFatherRois.filter(t=>!t.aiResult.whole_slide).map(t=>({id:t.id,x:t.path.x,y:t.path.y}));this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{[this.alg+"Started"]:!0})),this.$set(this.slice,"alg",this.alg),this.$set(this.slice,"ai_suggest",null),this.$set(this.slice,"check_result",null),this.showbutton=!1,this.auto="one",this.aiFatherRois.length&&"fishTissue"!=this.alg&&(this.aiFatherRois.map(t=>t.image=1),await Object(s.c)(t,e,this.alg,this.aiFatherRois.map(t=>({id:t.id,image:t.image})),null)),console.log(t),await Object(s.n)(t,e,i,this.alg,JSON.stringify(a),this.model_type),this.curRois={},this.leftRoilist=await Object(s.k)(t,e,this.curLevel,this.alg),this.aiFatherRois=await Object(s.l)(t,e,this.alg),Object.values(this.curRois).map(t=>this.leftRoilist.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),this.getAlgorithmResult()},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],["tct1","tct2","lct1","lct2","bm"].includes(this.alg)?this.curRois=Object.assign({},e&&this.curRois,...i.map(t=>({[t.id]:t}))):this.curRois=Object.assign({},e&&this.curRois,...i.filter(t=>!t.aiResult||!t.aiResult.whole_slide).map(t=>({[t.id]:t})))},async roiChanged(t,e){let i;i=e?e.map(e=>e.dna_index?{id:e.id,[t]:e[t],area_id:e.area_id,iconType:"dnaIcon"}:{id:e.id,[t]:e[t],area_id:e.area_id}):Object.values(this.curRois).map(e=>({id:e.id,[t]:e[t],area_id:e.area_id}));let a="image"==t||"remark"==t?null:this.$refs.osd.scope;a&&a.offset&&(this.curRois={},this.$refs.osd.scope=null),a?this.$message.error("不支持多选移动"):(this.loading=!0,await Object(s.c)(this.record.id,this.slice.id,this.alg,i,a),this.loading=!1),["tct1","tct2","lct1","lct2","fishTissue","dna","bm"].includes(this.alg)?this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg):(this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,this.alg),this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg)),this.IsOutFrame()},IsOutFrame(){Object.keys(this.curRois).map(t=>{this.leftRoilist.some(e=>e.id==t)||(delete this.curRois[t],this.curRois=Object.assign({},this.curRois))})},listChangeCurrent(){if(Object.keys(this.curRois).length){var t=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.x)),e=[].concat.apply([],Object.values(this.curRois).map(t=>t.path.y));t.length?this.centerRegion=[Math.min.apply(null,t),Math.min.apply(null,e),Math.max.apply(null,t),Math.max.apply(null,e)]:this.centerRegion=null,this.$refs.osd.scope=null}},async clickDraw(t,e){if(this.auto){if(!this.showbutton)return void this.$message({message:"计算中不能标注",type:"warning"});let a,n=this.leftRoilist.find(t=>t.id===this.parentId);if((a=this.aiFatherRois.some(t=>t.aiResult.whole_slide)?this.aiFatherRois.find(t=>t.aiResult.whole_slide):this.aiFatherRois.find(t=>t.id===this.parentId))||n&&2==n.mark_type){let o="cd30"===this.alg?4.131514365275448:1/(this.slice.mppx||.242042);if((i={path:{x:[t.x],y:[t.y]},method:"spot",radius:o,area_id:a?a.id:n.area_id,mark_type:2,ai_type:this.alg,type:"number"==typeof ki67remark?ki67remark:this.defaultType,fillColor:"number"==typeof ki67remark?this.roiTypeOpitions[ki67remark]:this.defaultColor}).id=await Object(s.e)(this.record.id,this.slice.id,i),!i.id)return;e?Object.assign(this.curRois,{[i.id]:i}):this.curRois={[i.id]:i},this.leftRoilist=[...this.leftRoilist,i],this.aiFatherRois=await Object(s.l)(this.record.id,this.slice.id,this.alg)}else this.$message({message:"只能在处理ROI区域内打点",type:"warning"})}else{var i;if((i={path:{x:[t.x],y:[t.y]},method:"spot",radius:3/(this.slice.mppx||.242042),mark_type:1,fillColor:"yellow"}).id=await Object(s.e)(this.record.id,this.slice.id,i),!i.id)return;this.curROIChange(i,e),this.leftRoilist=[...this.leftRoilist,i],this.rightRoilist=await Object(s.l)(this.record.id,this.slice.id)}},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()},goTocurRoi(t,e){this.curROIChange(t,e),this.listChangeCurrent()},showMenu(t,e){if((!t.type||t.button)&&(t.preventDefault(),0!=Object.keys(this.curRois).length&&!Object.keys(this.curRois).every(t=>t!=e.id))){var i=t.currentTarget,s=t.offsetX,a=t.offsetY,n=i.offsetWidth,o=i.offsetHeight;if(this.contextmenuPosition={},this.contextmenuPosition.hd=s>n/2?"right":"left",this.contextmenuPosition.vd=a>o/2?"bottom":"top",this.menuPosition={x:s,y:a},this.curRois[e.id]){let t=this.labeltree.find(t=>t.id==e.doctorDiagnosis),i=this.labeltree.filter(t=>t.children);if(t)this.currentItem=t.id+":"+t.id;else{let t=[];i.forEach(e=>{t.push(e.children.map(t=>Object.assign({},t,{fatherId:e.id})))});let s=t.flat().find(t=>t.id==e.doctorDiagnosis);this.currentItem=s?s.fatherId+":"+e.doctorDiagnosis:e.doctorDiagnosis+":"+e.doctorDiagnosis}this.newover=this.currentItem.substring(0,this.currentItem.lastIndexOf(":"))}}},async setAnnotation(t){for(var e in this.contextmenuPosition=null,this.curRois){let i=this.curRois[e];if(i.dashed)this.curRois[e]=Object.assign({},i,{strokeColor:"yellow",doctorDiagnosis:t});else{let e=Object.assign({},{path:i.path,dashed:1,doctorDiagnosis:t,strokeColor:"yellow",ai_type:"human_bm",mark_type:1,method:"rectangle"});await Object(s.e)(this.record.id,this.slice.id,e)}}var i=Object.assign({},this.curRois),a=Object.assign({},a,...Object.values(i).filter(t=>t.dashed).map(t=>({[t.id]:t})));this.curRois={},Object.keys(a).length&&(this.loading=!0,await Object(s.c)(this.record.id,this.slice.id,"human_bm",Object.values(a).map(t=>({id:t.id,strokeColor:t.strokeColor,doctorDiagnosis:t.doctorDiagnosis}))),this.loading=!1),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg),this.humanResult=await this.getHumanResult(),this.humanRoilist=this.humanResult[this.currentHumanFatherCellGroupIndex].data[this.currentHumanSonCellGroupIndex].data||[]},setShowType(){this.currentFatherCellGroupIndex=0,this.currentSonCellGroupIndex=0},changeImage(t){this.$set(t,"image",1-(t.image||0)),this.roiChanged("image",[t])},change(t,e){"阴性"===t&&(this.docResult.tps=[]),this.docResult[e]=t,this.check()},accept(){this.docResult=Object.assign({},{microbe:this.aiResult.microbe,tps:[this.aiResult.diagnosis[1]],diagnosis:this.aiResult.diagnosis[0],background:[]}),this.check()},clearCheckReslut(){this.$confirm("确认清空复核结果？","提示",{cancelTextButtom:"取消",confirmTextButtom:"确定"}).then(()=>{this.docResult={microbe:[],background:[],tps:[],diagnosis:""},this.check()}).catch(()=>!1)},check(){this.$set(this.slice,"check_result",this.docResult.diagnosis+" "+this.docResult.tps.join("+")+" "+this.docResult.microbe.join(",")+" "+this.docResult.background.join(",")),this.$set(this.slice,"alg",this.slice.toolType),this.$emit("save")},toggleCellsGroup(t,e){"father"==e?this.currentFatherCellGroupIndex!==t&&(this.currentFatherCellGroupIndex=t,this.currentSonCellGroupIndex=0,this.aiRoilist=this.aiResult.cells[this.currentFatherCellGroupIndex].data[this.currentSonCellGroupIndex].data):"son"==e?(this.currentSonCellGroupIndex=t,this.aiRoilist=this.aiResult.cells[this.currentFatherCellGroupIndex].data[this.currentSonCellGroupIndex].data):(this.currentFatherCellGroupIndex=0,this.currentSonCellGroupIndex=0,this.aiRoilist=this.aiResult.cells[this.currentFatherCellGroupIndex].data[this.currentSonCellGroupIndex].data),this.$nextTick(()=>{let t=this.$refs.aiRoilist;t&&(t.scrollTop=0,t.removeEventListener("scroll",this.scrollHander),t.addEventListener("scroll",this.scrollHander))}),this.startOberserve()},async toogleHumanType(t,e){"father"==e?this.currentHumanFatherCellGroupIndex!==t&&(this.currentHumanFatherCellGroupIndex=t,this.currentHumanSonCellGroupIndex=0,this.humanRoilist=this.humanResult[this.currentHumanFatherCellGroupIndex].data[this.currentHumanSonCellGroupIndex].data):"son"==e?(this.currentHumanSonCellGroupIndex=t,this.humanRoilist=this.humanResult[this.currentHumanFatherCellGroupIndex].data[this.currentHumanSonCellGroupIndex].data):(this.currentHumanFatherCellGroupIndex=0,this.currentHumanSonCellGroupIndex=0,this.humanRoilist=this.humanResult[this.currentHumanFatherCellGroupIndex].data[this.currentHumanSonCellGroupIndex].data)},async getRoi(t){let{x1:e,y1:i,x2:a,y2:n,z:o}=t;this.curLevel={x:[e,a],y:[i,n],z:o},this.leftRoilist.length||(this.leftRoilist=[...await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg)]),this.leftRoilist=[...await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.alg)]},async draw(t,e){t.strokeColor="yellow",t.mark_type=1,t.dashed=1,t.ai_type="human_bm",t.doctorDiagnosis="无",t.id=await Object(s.e)(this.record.id,this.slice.id,t),t.id&&(this.curROIChange(t,e),this.leftRoilist=[...this.leftRoilist,t],this.humanResult=await this.getHumanResult(),this.humanRoilist=this.humanResult[this.currentHumanFatherCellGroupIndex].data[this.currentHumanSonCellGroupIndex].data,this.IsOutFrame())},async delCurRoi(t){if(t)this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,"human_bm",[t.id],null),this.loading=!1,this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois)),this.humanResult=await this.getHumanResult(),this.humanRoilist=this.humanResult[this.currentHumanFatherCellGroupIndex].data[this.currentHumanSonCellGroupIndex].data,this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.slice.toolType);else if(await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})){let t=Object.values(this.curRois).filter(t=>t.dashed).map(t=>t.id);if(!t.length)return;this.loading=!0,await Object(s.f)(this.record.id,this.slice.id,"human_bm",t,this.$refs.osd.scope),this.loading=!1,this.humanResult=await this.getHumanResult(),this.humanRoilist=this.humanResult[this.currentHumanFatherCellGroupIndex].data[this.currentHumanSonCellGroupIndex].data,this.curRois={},this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.slice.toolType)}},getAlgorithmResult(t=this.record.id,e=this.slice.id,i=this.slice.filename){Object(s.b)("ai/getresult",{caseid:t,fileid:e,filename:i,type:this.slice.toolType,other:this.config&&this.config.mode?"cs":""}).then(async t=>{this.lineup=t.data.rank,t.data.done?(this.showbutton=!0,this.loopHandler=0,-1==t.data.rank&&(this.aiResult=await this.getAiResult(),this.aiRoilist=this.aiResult.cells[this.currentFatherCellGroupIndex].data[this.currentSonCellGroupIndex].data,this.cells=this.aiResult.cells,this.$set(this.slice,"ai_suggest",this.aiResult.diagnosis),this.$set(this.slice,"cell_num",this.aiResult.cell_num),this.$set(this.slice,"slide_quality",this.aiResult.slide_quality)),this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{[this.slice.toolType+"Started"]:!1})),this.startOberserve()):(this.showbutton=!1,this.loopHandler=setTimeout(()=>{this.getAlgorithmResult()},5e3))})},async getAiResult(){return new Promise(t=>{Object(s.b)(`slice/getROIList?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,ai_type:this.slice.toolType,other:this.config&&this.config.mode?"cs":""}).then(({data:e})=>{e.ROIS.length?t(e.ROIS[0].aiResult):t({})}).catch(e=>t({}))})},async getHumanResult(){return new Promise(t=>{Object(s.b)(`slice/getROIList?companyid=${Object(s.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,ai_type:"human_bm",other:this.config&&this.config.mode?"cs":""}).then(({data:e})=>{t(e.ROIS)}).catch(e=>t({}))})},async startAnalyze(t=this.record.id,e=this.slice.id,i=this.slice.filename){this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{[this.slice.toolType+"Started"]:!0})),this.$set(this.slice,"alg",this.slice.toolType),this.$set(this.slice,"ai_suggest",null),this.$set(this.slice,"check_result",null),this.$set(this.slice,"cell_num",null),this.$set(this.slice,"slide_quality",""),this.removeObserver(),this.showbutton=!1,this.auto="one",await Object(s.n)(t,e,i,this.slice.toolType,this.config&&this.config.mode?"cs":""),this.leftRoilist=await Object(s.k)(this.record.id,this.slice.id,this.curLevel,this.slice.toolType),this.aiResult=await this.getAiResult(),this.humanResult=await this.getHumanResult(),this.aiRoilist=this.aiResult.cells[this.currentFatherCellGroupIndex].data[this.currentSonCellGroupIndex].data||[],this.humanRoilist=this.humanResult[this.currentHumanFatherCellGroupIndex].data[this.currentHumanSonCellGroupIndex].data||[],Object.values(this.curRois).map(t=>this.leftRoilist.every(e=>t.id!=e.id)?delete this.curRois[t.id]:""),this.getAlgorithmResult()},canceltesk(){Object(s.b)("ai/revokeTask",{caseid:this.record.id,fileid:this.slice.id,type:this.slice.toolType,other:this.config&&this.config.mode?"cs":""}).then(async t=>{0==t.code&&(clearTimeout(this.loopHandler),this.loopHandler=0,this.showbutton=!0,this.$set(this.slice,"ai_dict",Object.assign(this.slice.ai_dict,{[this.slice.toolType+"Started"]:!1})),this.aiResult=await this.getAiResult(),this.cells=this.aiResult.cells)}).catch(t=>console.log(t))},scrollHander(){let t=this.$refs.aiRoilist;t.scrollTop+t.clientHeight==t.scrollHeight&&this.cells[this.currentFatherCellGroupIndex].data[this.currentSonCellGroupIndex].num>100?this.showTips=!0:this.showTips=!1},startOberserve(){this.observer&&this.removeObserver(),this.$nextTick(()=>{if(this.aiRoilist.length){document.querySelectorAll(".img-content img").forEach(t=>{this.observer.observe(t)})}})},removeObserver(){document.querySelectorAll(".img-content img").forEach(t=>{this.observer.disconnect(t)})},changeTab(t){this.auto!==t&&(this.auto=t,"one"===t&&this.startOberserve())}},async mounted(){this.aiResult=await this.getAiResult(),this.humanResult=await this.getHumanResult(),this.setShowType(),this.aiRoilist=this.aiResult.cells[this.currentFatherCellGroupIndex].data[this.currentSonCellGroupIndex].data||[],this.humanRoilist=this.humanResult[this.currentHumanFatherCellGroupIndex].data[this.currentHumanSonCellGroupIndex].data||[],this.cells=this.aiResult.cells,this.observer=new IntersectionObserver(t=>{t.forEach(t=>{t.intersectionRatio>0&&!t.target.src&&(t.target.src=t.target.dataset.src)})}),this.startOberserve(),this.$nextTick(()=>{let t=this.$refs.aiRoilist;t&&t.removeEventListener("scroll",this.scrollHander),t&&t.addEventListener("scroll",this.scrollHander)}),this.slice.ai_dict[[this.alg+"Started"]]?this.getAlgorithmResult():this.showbutton=!0},beforeDestroy(){let t=this.$refs.aiRoilist;t&&t.removeEventListener("scroll",this.scrollHander),this.removeObserver(),clearTimeout(this.loopHandler),this.loopHandler=0},watch:{"slice.id":{handler(){clearTimeout(this.loopHandler),this.loopHandler=0}}},computed:{alg(){return"fish"===this.slice.toolType?"fishTissue":this.slice.toolType},userInfo:()=>Object(s.o)()}},xs={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"cnt",staticStyle:{width:"100%"},attrs:{tabIndex:0},on:{keydown:t.keydown,mousewheel:function(e){t.contextmenuPosition=null},mousedown:function(e){t.contextmenuPosition=null}}},[i("div",{staticClass:"analyright"},[i("v-dragon",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],ref:"osd",staticClass:"dragon",attrs:{record:t.record,slice:t.slice,roilist:[].concat(t.leftRoilist),curRois:t.curRois,penColor:"yellow",centerRegion:t.centerRegion,position:t.position,showMppGuide:t.showMppGuide,cellArea:1962,"element-loading-text":"处理中，请耐心等待","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(0, 0, 0, 0.5)"},on:{curROI:t.curROIChange,roiChanged:t.roiChanged,draw:t.draw,delRoi:function(e){return t.delCurRoi(e)},position:function(e,i,s){t.$set(t.position,"offx",e),t.$set(t.position,"offy",i),t.$set(t.position,"zoom",s),t.$set(t.slice,"position",t.position)},contextmenu:function(e,i){return t.showMenu(e,i)},closeMppGuide:function(e){t.showMppGuide=!1},getRoi:t.getRoi}},[t.contextmenuPosition?i("div",{staticStyle:{position:"absolute"},style:{left:t.menuPosition.x+"px",top:t.menuPosition.y+"px"}},[i("v-menus",{attrs:{pos:t.contextmenuPosition,menus:t.labeltree,currentItem:t.currentItem,newover:t.newover},on:{chosen:function(e){return t.setAnnotation(e)}}})],1):t._e()]),t._v(" "),t.showbutton?i("button",{on:{click:function(e){return t.startAnalyze()}}},[t._v(t._s(t.$t("slice.start")))]):t._e()],1),t._v(" "),i("div",{staticClass:"analylist"},[i("div",{staticClass:"quality"},[t._m(0),t._v(" "),i("div",{staticClass:"quality-detail"},[i("p",[t._v("清 晰 度："+t._s(t.slice.clarity?(100*t.slice.clarity).toFixed(2)+"%":"-"))]),t._v(" "),i("p",[t._v("扫描倍数："+t._s(t.slice.objective_rate||"-"))])])]),t._v(" "),i("div",{staticClass:"quality q-center",style:{height:"two"==t.auto?"calc(100% - 82px)":(t.aiResult.diagnosis&&t.aiResult.diagnosis.length&&t.aiResult.aiNotCompleted,"calc(100% - 82px)")}},[i("div",{staticClass:"title"},[i("span",{class:"one"==t.auto?"auto":"",on:{click:function(e){return t.changeTab("one")}}},[t._v("AI处理")]),t._v(" "),i("span",{class:"two"==t.auto?"auto":"",on:{click:function(e){return t.changeTab("two")}}},[t._v("手工标注")])]),t._v(" "),t.aiResult.aiNotCompleted||"one"!=t.auto?t._e():i("div",{staticClass:"noroi"},[t.cells.length?i("div",{staticClass:"quality-detail-bm short"},[i("div",{staticClass:"father-title"},t._l(t.cells,function(e,s){return i("div",{key:"aifather"+s,class:{active:t.currentFatherCellGroupIndex===s},on:{click:function(e){return t.toggleCellsGroup(s,"father")}}},[i("div",{staticClass:"bm-label",attrs:{title:e.label}},[t._v(t._s(e.label))]),t._v(" "),i("div",{staticClass:"bm-count",attrs:{title:e.num}},[t._v(t._s(e.num))])])}),0),t._v(" "),i("div",{staticClass:"son-title"},t._l(t.cells[t.currentFatherCellGroupIndex].data,function(e,s){return i("div",{key:"aison"+s,class:{active:t.currentSonCellGroupIndex===s},on:{click:function(e){return t.toggleCellsGroup(s,"son")}}},[i("div",{staticClass:"bm-label",attrs:{title:e.label}},[t._v(t._s(e.label))]),t._v(" "),i("div",{staticClass:"bm-count",attrs:{title:e.num}},[t._v(t._s(e.num))])])}),0)]):t._e(),t._v(" "),i("div",{staticClass:"list-container"},[t.aiRoilist.length?i("div",{staticClass:"list"},[i("div",{ref:"aiRoilist",staticClass:"roi-container"},t._l(t.aiRoilist,function(e){return i("div",{key:e.id,staticClass:"img-content",class:{"check-img":t.curRois[e.id]},on:{click:function(i){return t.goTocurRoi(e,i.shiftKey)}}},[i("img",{attrs:{"data-src":"/aipath/api/files/ROI?caseid="+t.record.id+"&fileid="+t.slice.id+"&filename="+encodeURIComponent(t.slice.filename)+"&roi=[["+Math.min.apply(Math,e.path.x)+","+Math.min.apply(Math,e.path.y)+"],["+Math.max.apply(Math,e.path.x)+","+Math.max.apply(Math,e.path.y)+"]] &roiid="+e.id,alt:""}}),t._v(" "),i("span",{class:{blue:e.image},on:{click:function(i){return i.stopPropagation(),t.changeImage(e)}}})])}),0),t._v(" "),t.showTips?i("div",{staticClass:"viewpop"},[t._v("只展示置信度最高的前100个视野")]):t._e()]):i("h3",[t._v("处理结果为空～")])])]),t._v(" "),"two"==t.auto?i("div",{staticClass:"noroi manunal"},[i("div",{staticClass:"quality-detail-bm short"},[i("div",{staticClass:"father-title"},t._l(t.humanResult,function(e,s){return i("div",{key:"humanfather"+s,class:{active:t.currentHumanFatherCellGroupIndex===s},on:{click:function(e){return t.toogleHumanType(s,"father")}}},[i("div",{staticClass:"bm-label",attrs:{title:e.label}},[t._v(t._s(e.label))]),t._v(" "),i("div",{staticClass:"bm-count",attrs:{title:t.humanResult[s].data.map(function(t){return t.data.length}).reduce(t.getNum,0)}},[t._v(t._s(t.humanResult[s].data.map(function(t){return t.data.length}).reduce(t.getNum,0)))])])}),0),t._v(" "),i("div",{staticClass:"son-title"},t._l(t.humanResult[t.currentHumanFatherCellGroupIndex].data,function(e,s){return i("div",{key:"humanson"+s,class:{active:t.currentHumanSonCellGroupIndex===s},on:{click:function(e){return t.toogleHumanType(s,"son")}}},[i("div",{staticClass:"bm-label",attrs:{title:e.label}},[t._v(t._s(e.label))]),t._v(" "),i("div",{staticClass:"bm-count",attrs:{title:e.num}},[t._v(t._s(e.data.length))])])}),0)]),t._v(" "),i("v-roi",{staticClass:"checkroi",attrs:{roilist:t.humanRoilist,currentRois:t.curRois},on:{curROI:function(e,i){return t.curROIChange(e,i)+t.listChangeCurrent()},delRoi:function(e){return t.delCurRoi(e)},roiChanged:t.roiChanged}})],1):t._e()]),t._v(" "),t.aiResult.aiNotCompleted&&"one"==t.auto&&t.showbutton?i("div",{staticClass:"ifshowtables"},[t._v(t._s(t.$t("slice.noanalysis")))]):t._e(),t._v(" "),t.showbutton||"one"!=t.auto?t._e():i("div",{staticClass:"loding"},[i("div",{staticClass:"video"},[i("img",{attrs:{src:"/static/video/loading.gif"}}),t._v(" "),0==t.lineup?i("div",{staticClass:"lineup"},[t._v("正在处理...")]):t._e(),t._v(" "),t.lineup>0?i("div",{staticClass:"lineup"},[t._v(t._s(t.$t("slice.lineup"))+" "),i("span",{staticStyle:{color:"#4C9FFA","font-size":"18px","font-weight":"bolder"}},[t._v(t._s(t.lineup))]),t._v(" "+t._s(t.$t("slice.position")))]):t._e()]),t._v(" "),i("div",{staticClass:"cancel",on:{click:function(e){return t.canceltesk()}}},[t._v(t._s(t.$t("slice.cancelTasks")))])])])])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"title"},[e("span",[this._v("AI质控")])])}]};var $s=i("VU/8")(ks,xs,!1,function(t){i("rjQe"),i("wS5G")},"data-v-08011151",null).exports,Is={props:["record","showBatch","companyid","config","netSocket"],data(){return{company:this.companyid||Object(s.o)().company,currentRoiIndex:"",curAI:null,choosingAI:!1,closeAi:!1,fullPage:!1,startIndex:0,isMounted:!1,demoModeValue:"1"===localStorage.getItem("demoMode")||!1}},computed:{curSlice(){let t=this.record.slices.find(t=>t.id==this.record.slice)||this.record.slices.filter(t=>1==t.state)[0]||null;return t&&(this.curAI=t.toolType||"human"),t},url(){return location.href.split("#")[0]+"#/share?caseid="+this.record.id+"&fileid="+this.curSlice.id+"&companyid="+this.company+"&filename="+this.curSlice.filename},totalList(){return this.record.slices.filter(t=>t.width)},count(){return this.isMounted?Math.ceil(this.$refs.lazyloadImg.clientHeight/80):void 0},loadList(){return this.isMounted?this.totalList.slice(0,(2+this.startIndex)*this.count):void 0}},mounted(){const t=document.querySelector("#id"+this.record.id+" .btm_left");if(t){document.querySelector("#id"+this.record.id+" .db-page").style.top=t.offsetTop+t.offsetHeight+6+"px"}this.$refs.lazyloadImg&&(this.$refs.lazyloadImg.addEventListener("scroll",this.lazyload),this.isMounted=!0)},destroyed(){this.$refs.lazyloadImg&&this.$refs.lazyloadImg.removeEventListener("scroll",this.lazyload)},methods:{cameraMove(){if("open"!==this.netSocket.readyState)this.$alert("显微镜连接失败。请确保显微镜、上位机已开启，扫描软件已启动且设置>socket已勾选。","错误");else{const t=this.$refs.aiType.$refs.osd.viewport;let{x:e,y:i}=t.getBounds(!0).getCenter();const a=JSON.parse(localStorage.correctData);Object(s.b)(`files/stagePos?caseid=${this.record.id}&fileid=${this.curSlice.id}&filename=${encodeURIComponent(this.curSlice.filename||this.curSlice.name)}`,{xPos:e*this.curSlice.width,yPos:i*this.curSlice.width}).then(t=>{let e=t.xPos,i=t.yPos,s=t.zPos,n=e+Number(a.x),o=i+Number(a.y),l=s+Number(a.z);this.netSocket.write(JSON.stringify({method:"MoveStage",X:n,Y:o,Z:l,ack:!0})),this.$emit("move-stage",{finalX:n,finalY:o,finalZ:l})}).catch(t=>{this.$alert(t.message),console.log("moveStage err",t)})}},lazyload(){let t=this.$refs.lazyloadImg.scrollTop;if(80*this.loadList.length-Math.ceil(t)-this.$refs.lazyloadImg.clientHeight<=0){if(this.loadList.length===this.totalList.length)return;this.startIndex+=1}},toogleDouble(){"pdl1db"===this.curAI?this.curAI=localStorage.perToolType:(localStorage.perToolType=this.curAI||"human",this.curAI="pdl1db")},share(){this.$refs.shareLink.select(),document.execCommand("Copy"),this.$message({message:"复制成功,可粘贴",type:"success"})},switchSlices(t,e){this.$set(t,"slice",e.id)},keydown(t){let e=this.record.slices.filter(t=>1==t.state);if((t.ctrlKey||t.metaKey)&&this.curSlice&&("ArrowUp"==t.key||"ArrowDown"==t.key)){this.$refs.container.focus();let i=e.indexOf(this.curSlice);i=i+t.keyCode-39,i=Math.max(i,0),i=Math.min(i,e.length-1),this.$set(this.record,"slice",e[i].id)}},next(){this.$emit("next")},prev(){this.$emit("prev")},curRoiIndex(t){this.currentRoiIndex=t},save(t){this.$emit("save",t)}},watch:{curAI(t){["human","cellseg","center","pdl1db","tctann","ki67","ki67ann","pdl1ann","pathann","thyroid","mucosa","bladder","embolus","kidney","bacillus","er","erann","pr","prann","ck56","her2","pdl1","fish","muscle","mitosis","breast","prostate","lung","cervix","sentinelnode","tctanntwo","pdl1cellann","liverann","liver","ki67hot","dna","pdl1_sp236","capillary","esd","tct1","tct2","lct1","lct2","tcttest","lcttest","tagging","np","cd30","bm"].includes(t)?this.curSlice.toolType=t:this.curSlice.toolType="human","esd"===t&&(document.querySelector(".share").style.display="none")}},components:{chooseAI:p,human:b,esd:A,cellseg:j,center:H,pdl1db:B,tctann:Rt,ki67:jt,ki67hot:Ht,pdl1ann:Xt,pathann:ie,thyroid:ne,mucosa:re,bladder:ue,embolus:ve,kidney:we,bacillus:$e,erann:Me,prann:De,ck56:Ue,her2:qe,pdl1:ii,fish:gi,muscle:Ci,mitosis:be,breast:xi,prostate:Fi,lung:Ti,cervix:Oi,sentinelnode:Li,tctanntwo:It,pdl1cellann:Qt,liverann:Gi,liver:Xi,ki67anntwo:Yt,pdl1_sp236:ci,capillary:es,tct:et,tcttest:dt,lcttest:mt,tagging:rs,np:vs,dna:lt,cd30:bs,bm:$s,lct1:et,lct2:et,tct1:et,tct2:et,er:jt,pr:jt}},Os={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return this.record.slices.filter(function(t){return 1==t.state}).length?i("div",{ref:"container",staticClass:"container",attrs:{tabIndex:1},on:{click:function(e){t.closeAi=!t.closeAi},keydown:t.keydown}},[t.record.slices.length?i("div",{staticClass:"conter"},[i("div",{staticClass:"slice-list"},[i("table",{staticClass:"img-top"},[i("tr",[i("th",[t._v(t._s(t.$t("slice.slicelist")))])])]),t._v(" "),i("div",{ref:"lazyloadImg",staticClass:"img-list"},[i("table",{staticClass:"img-top"},t._l(t.loadList,function(e){return i("tr",{key:e.id,class:{tr_active:e==t.curSlice},on:{click:function(i){return t.switchSlices(t.record,e)}}},[i("td",{attrs:{width:"80"}},[i("img",{attrs:{src:"/aipath/api/files/thumbnail?caseid="+t.record.id+"&fileid="+e.id+"&companyid="+t.company}})]),t._v(" "),i("td",[i("p",{attrs:{title:e.name}},[t._v(t._s(e.name))]),t._v(" "),i("p",{attrs:{title:e.stain}},[t._v(t._s(e.stain))])])])}),0)])]),t._v(" "),i("chooseAI",{staticClass:"algorithmlist",attrs:{curAI:t.curAI,closeAi:t.closeAi},on:{chooseAI:function(e){return t.curAI=e}}})],1):t._e(),t._v(" "),t.curSlice?i("div",{key:t.curSlice.id,staticClass:"analy"},[i(t.curAI,{ref:"aiType",tag:"component",attrs:{config:t.config,showBatch:t.showBatch,record:t.record,slice:t.curSlice},on:{save:function(e){return t.save(e)}}}),t._v(" "),"human"==t.curAI?i("h2",[i("span",[t._v(t._s(t.$t("analyze.roi")))])]):t._e()],1):t._e(),t._v(" "),t.record.slices.length?i("div",{staticClass:"footer"},[i("div",{staticClass:"share"},[i("input",{ref:"shareLink",attrs:{type:"text",readonly:""},domProps:{value:t.url}}),t._v(" "),i("button",{on:{click:t.share}},[t._v("分享")])]),t._v(" "),t.config&&t.config.zeiss?i("span",{on:{click:t.cameraMove}},[t._v("移动")]):t._e(),t._v(" "),i("span",{on:{click:function(e){return t.save("auto")}}},[t._v("保存")]),t._v(" "),t.demoModeValue?t._e():i("span",{on:{click:t.prev}},[t._v("上一个")]),t._v(" "),t.demoModeValue?t._e():i("span",{on:{click:t.next}},[t._v("下一个")])]):t._e(),t._v(" "),i("div",{directives:[{name:"show",rawName:"v-show",value:!t.fullPage,expression:"!fullPage"}],staticClass:"db-page",attrs:{id:t.record.id}},[i("div",{staticClass:"img",class:{checked:"pdl1db"===t.curAI},on:{click:function(e){return t.toogleDouble()}}})])]):t._e()},staticRenderFns:[]};var Ss=i("VU/8")(Is,Os,!1,function(t){i("Lydp")},"data-v-4d243f2e",null).exports,As=i("70/Y"),Ts={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticStyle:{position:"relative",width:"100%",height:"100%"}},[i("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticClass:"outer",attrs:{"element-loading-text":"请稍后...","element-loading-background":"rgba(0, 0, 0, 0.8)"}},[i("v-eidtreport",{style:"transform:scale("+t.scaleRate+");height:calc((100% - 140px)/"+t.scaleRate+");overflow-y:auto;overflow-x:hidden;border-radius:4px;",attrs:{record:t.record,signed:t.signed,slices:t.slices,reportType:t.reportType,algType:t.algType,sign:t.sign},on:{typeChange:t.typeChange,sliceChangge:function(e){return t.getImages()},changeSign:t.changeSign}}),t._v(" "),i("div",{staticClass:"triangle1"},[t._v(t._s(t.$t("report.edit")))]),t._v(" "),t.slices.human?i("v-viewreport",{style:"transform:scale("+t.scaleRate+");height:calc((100% - 140px)/"+t.scaleRate+");overflow-y:auto;overflow-x:hidden;border-radius:4px;",attrs:{id:"viewreport",viewRecord:t.record,remotesigned:t.signed,propslices:t.slices,remotesign:t.sign,viewReportType:t.reportType}}):t._e(),t._v(" "),i("div",{staticClass:"triangle2"},[t._v(t._s(t.$t("report.preview")))]),t._v(" "),i("div",{staticClass:"footer"},[i("span",{on:{click:function(e){return t.$emit("save","auto")}}},[t._v("保存")]),t._v(" "),i("span",{on:{click:t.download}},[t._v(t._s(t.$t("report.next")))]),t._v(" "),t.demoModeValue?t._e():i("span",{on:{click:t.prev}},[t._v("上一个")]),t._v(" "),t.demoModeValue?t._e():i("span",{on:{click:function(e){return t.$emit("next")}}},[t._v("下一个")])])],1)])},staticRenderFns:[]};var Ms=function(t){i("xwt1")},js=i("VU/8")(As.a,Ts,!1,Ms,"data-v-57d464c5",null).exports,Fs=i("k5KV"),Ps=i.n(Fs),Es=i("Mk6O"),Ls=i.n(Es),Ds={props:["data","showBatch","companyid","config","filters","records","clickTimer","netSocket"],data(){if(!this.data.oldRecord){var t=this.data.record.slices.map((t,e)=>{if(t.id==this.data.record.slice)return Object(s.b)("files/getInfo?companyid="+(this.companyid||Object(s.o)().company),{caseid:this.data.record.id,fileid:t.id}).then(i=>this.$set(this.data.record.slices,e,Object.assign({},t,i.data,{name:t.name}))).catch(t=>1)});Promise.all(t).then(t=>this.oldRecord=Ps.a.clone(this.data.record))}return{company:this.companyid||Object(s.o)().company,record:this.data.record,oldRecord:this.data.oldRecord,transition:"",saved:!1,demoModeValue:"1"==localStorage.getItem("demoMode")||!1}},watch:{"record.stage":function(t,e){this.transition=e<t?"right2left":"left2right"},"data.record.slice":{handler(){this.getSliceInfo()}},clickTimer:function(t,e){this.clickTimer=e}},methods:{getSliceInfo(){if(this.data.record.slice){let t=this.data.record.slices.find(t=>t.id===this.data.record.slice),e=this.data.record.slices.findIndex(t=>t.id===this.data.record.slice);Object(s.b)("files/getInfo?companyid="+(this.companyid||Object(s.o)().company),{caseid:this.data.record.id,fileid:this.data.record.slice}).then(i=>{this.$set(this.data.record.slices,e,Object.assign({},t,i.data,{name:t.name})),this.oldRecord=Ps.a.clone(this.data.record)}).catch(t=>1)}},nav(t){this.record.stage=t},async prev(){if(new Date-this.clickTimer<3e3)return this.$message.error("操作频率过快，请稍后再试"),!1;let t,e=this.records.data.map((t,e)=>t.id).indexOf(this.data.id);if(0==e){if(this.filters.page--,this.filters.page<1)return this.filters.page++,void this.$message.error("这是第一个");this.datas=await this.$parent.getRecord(this.filters),t=this.datas.data[this.datas.data.length-1],this.$parent.currentPage=this.filters.page,this.$parent.saveReloadParams()}else t=-1==e?this.records.data[this.filters.limit-1]:this.records.data[e-1];if(t){let i;i=0==e?this.filters.limit:e,this.$message.success({message:`您当前在${(this.filters.page<1?0:this.filters.page-1)*this.filters.limit+i}/${this.records.total}`,showClose:!0,duration:1500}),await this.onclose("next",t)}else this.records||this.$message.error("这是第一个")},async next(){if(new Date-this.clickTimer<3e3)return this.$message.error("操作频率过快，请稍后再试"),!1;let t,e=this.records.data.map((t,e)=>t.id).indexOf(this.data.id);if(e==this.records.data.length-1){if(this.filters.page++,this.datas=await this.$parent.getRecord(this.filters),!this.datas.data.length)return this.filters.page--,void this.$message.error("已经是最后一个了");t=this.datas.data[0],this.$parent.currentPage=this.filters.page,this.$parent.saveReloadParams()}else t=-1==e?this.records.data[0]:this.records.data[e+1];if(t){let i;i=this.filters.limit==e+1?1:0==e?2:e+2,this.$message.success({message:`您当前在${(this.filters.page<1?0:this.filters.page-1)*this.filters.limit+i}/${this.records.total}`,showClose:!0,duration:1500}),await this.onclose("next",t)}else this.$message.error("已经是最后一个了")},getNeededCase(t){let e=Object.assign({},this.filters,{direction:t,caseid:this.record.id});for(let t in e)e[t]instanceof Object&&(e[t]=JSON.stringify(e[t]));return new Promise(t=>{Object(s.b)("records/previousOrNext",e).then(({data:e})=>{t(e)})})},cleanRecord:t=>Object.assign({},t,{slices:t.slices.filter(t=>1==t.state).map(({id:t,name:e,filename:i})=>({id:t,name:e,filename:i})),attachments:t.attachments.filter(t=>1==t.state)}),async save(t){var e=this;await Promise.all(this.record.slices.filter(t=>1==t.state).filter((t,e)=>{var i=this.oldRecord.slices.find(e=>e.id==t.id);return!i||!Ps.a.equals(i,t)}).map(function(t,i){if("1234567"!=t.id)return Object(s.b)("files/saveInfo?companyid="+e.company,{caseid:e.record.id,fileid:t.id,content:JSON.stringify(t)}).then(t=>{if(0==t.code)return 1;throw"保存切片失败"})}));var i=this.cleanRecord(this.record),a=this.cleanRecord(this.oldRecord);Ls()(a,i)&&await Object(s.b)("records/update?companyid="+this.company,{id:i.id,content:JSON.stringify(i)}),this.oldRecord=this.data.oldRecord=Ps.a.clone(this.record),"auto"==t&&(this.saved=!0,setTimeout(t=>this.saved=!1,1500)),"noListUpdate"!=t&&(this.$parent.getRecords(),this.$parent.getFilters())},async onclose(t,e){let i=Object.assign({},{basic:this.oldRecord.basic}),s=Object.assign({},{basic:this.record.basic});if(!Ps.a.equals(i,s))try{await this.$confirm(this.$t("detail.sureclose"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"})}catch(t){return}[...this.record.slices,...this.record.attachments].forEach(t=>1!=t.state&&(t.deleted=!0)),"next"===t?this.$emit("openNewWindow",e,this.record,t):this.$emit("closing",t)}},components:{basic:o,file:h,analyze:Ss,report:js}},Hs={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"blackback",attrs:{id:"id"+t.data.id}},[s("div",{staticClass:"header"},[s("img",{attrs:{src:i("HS3L"),alt:"迪英加",width:"186"}}),t._v(" "),t.demoModeValue?s("a",{staticClass:"crossmin",attrs:{href:"javascript:void(0);",title:t.$t("detail.min")},on:{click:function(e){return t.$emit("hidding")}}}):t._e(),t._v(" "),s("a",{staticClass:"crossclose",attrs:{href:"javascript:void(0);",title:t.$t("detail.close")},on:{click:t.onclose}}),t._v(" "),s("div",{staticClass:"nav"},[s("div",{class:t.record.stage>=0?"basic-nav-active":"basic-nav-normal",on:{click:function(e){return t.nav(0)}}},[t._v(t._s(t.$t("detail.basic")))]),t._v(" "),s("div",{class:t.record.stage>=1?"files-nav-active":"files-nav-normal",on:{click:function(e){return t.nav(1)}}},[t._v(t._s(t.$t("detail.files")))]),t._v(" "),s("div",{class:t.record.stage>=2?"analyze-nav-active":"analyze-nav-normal",on:{click:function(e){return t.nav(2)}}},[t._v(t._s(t.$t("detail.analyze")))]),t._v(" "),s("div",{class:t.record.stage>=3?"report-nav-active":"report-nav-normal",on:{click:function(e){return t.nav(3)}}},[t._v(t._s(t.$t("detail.report")))])])]),t._v(" "),s("div",{staticClass:"body"},[t.oldRecord?s("transition",{attrs:{name:t.transition}},[s(["basic","file","analyze","report"][t.record.stage],{tag:"component",attrs:{showBatch:t.showBatch,record:t.record,config:t.config,netSocket:t.netSocket,companyid:t.company},on:{next:t.next,prev:t.prev,save:t.save,"move-stage":function(e){return t.$emit("move-stage",e)}}})],1):t._e()],1),t._v(" "),t.saved?s("div",{staticClass:"saved"},[t._v("保存成功")]):t._e()])},staticRenderFns:[]};var zs=i("VU/8")(Ds,Hs,!1,function(t){i("BdLg")},"data-v-73d031b1",null);e.a=zs.exports},PRl9:function(t,e){},PVWf:function(t,e){},PZiJ:function(t,e){},Pd0x:function(t,e,i){"use strict";(function(t,s){var a=i("hfCn"),n=i("uVHs"),o=i("OfXo"),l=i("jyVo"),r=i("qpo7"),c=i("ZEUm");let h;if(window.electron){let t=(0,window.electron.remote.require)("fs");h=JSON.parse(t.readFileSync("config.json").toString())}let u=h&&h.mode?500:30;e.a={props:["batchMsg","isStart","queueMsg"],components:{"v-scanning":a.a,"v-analysis":n.a,"v-results":o.a},data:()=>({currentTime:"",slices:[],uploaded:{},scanned:{},results:{sliceTotal:0,reportArr:[]},curModel:"",ai:"",err:"",ifstopcut:!1,scanning:!1,uploading:null,modelliststr:JSON.parse(Object(l.o)().model_lis),model_list:Object(l.o)().model_lis?JSON.parse(Object(l.o)().model_lis).concat(["human"]):[].concat(["human"]),dialogVisible:!1,hoverIndex:null,choosefiles:[],showFileList:!1,uploadBatchNumber:null,showError:!1,errorList:[],scanTimeout:null,checked:!1,isMerge:!1,showTips:!1,uploadingList:[],currentScanEnd:!0,uploadStatus:Object(r.b)(),uploadStatusTimeout:null}),computed:{options(){return c.a.filter(t=>this.model_list.includes(t.toolType))},tagoptions(){return[{toolType:"ki67hot",label:"Ki-67 热区",analyname:"ki67hot",canannly:!0},{toolType:"pdl1",label:"PD-L1",analyname:"pdl1",canannly:!0},{toolType:"her2",label:"HER-2",analyname:"her2",canannly:!0},{toolType:"np",label:"鼻息肉",analyname:"np",canannly:!0},{toolType:"bm",label:"骨髓血细胞",analyname:"bm",canannly:!0}].filter(t=>this.model_list.includes(t.toolType))},mutialgTip(){return c.a.filter(t=>this.modelliststr.includes(t.toolType)).map(t=>{if("human"!=t.toolType&&"mutialg"!=t.toolType)return t.label})}},mounted(){this.choosefiles=localStorage.getItem("file")?JSON.parse(localStorage.getItem("file")):[],this.ai=localStorage.getItem("analy")||"",this.curModel=localStorage.getItem("curModel")||"",document.addEventListener("click",this.handleClick)},methods:{closeChoosefiles(){this.$confirm("是否清空所有文件夹？").then(()=>{this.choosefiles=[]}).catch(t=>t)},downloadExcel(){let t="No.,文件名,异常原因,时间,文件路径".split(","),e=this.errorList.map((t,e)=>[e+1,t.file,t.reason,t.time,t.directory]);e=[t].concat(e).map(t=>t.map(t=>'"'+(t+"").replace(/"/g,'""')+'"').join(",")).join("\n"),this.downloadCSV("records.csv",e)},downloadCSV(e,i){let s=new Blob(["\ufeff"+i],{type:"text/plain"}),a=new FileReader,n=window.electron.remote.require,o=n("fs"),l=n("stream");a.readAsDataURL(s),a.onload=(i=>{const{dialog:s}=window.electron.remote;s.showSaveDialog({defaultPath:e,title:"导出excel",filters:[{name:".csv",extensions:["csv"]},{name:".xls",extensions:["xls"]}]}).then(async({filePath:e})=>{if(e){let s=t.from(i.target.result.split("base64,")[1],"base64");const a=new l.PassThrough({allowHalfOpen:!1}).end(s),n=new o.createWriteStream(e);n.on("error",t=>{this.$message.error("导出错误，请重试"),this.loading=!1}).on("finish",()=>{this.loading=!1}),a.pipe(n)}else this.loading=!1})})},deleteFile(t){this.choosefiles.splice(t,1),localStorage.file=JSON.stringify(this.choosefiles)},handleClick(t){"filepath"!==t.target.className&&(this.showFileList=!1)},onmessage(t){for(let e in this.uploaded)if(this.uploaded[e].fileid===t.fileid){let{caseid:i,fileid:s,filename:a}=this.uploaded[e],n=t.ai_type,o=t.error;this.checked&&"tagging"===this.curModel&&Object(l.b)(`slice/importAiResult?companyid=${Object(l.o)().company}`,{caseid:i,fileid:s}).then(()=>{}),Object(r.e)(i,s,n,o).then(t=>{this.slices.indexOf(e)>=0&&this.slices.splice(this.slices.indexOf(e),1),delete this.uploaded[e],"error"!=t&&this.results.reportArr.push({fileid:s,caseid:i,result:t,filename:a})})}},getfile(){let t=electron.remote.dialog.showOpenDialogSync(s.electron.remote.getCurrentWindow(),{properties:["openDirectory","multiSelections"]});t&&(t.forEach(t=>{this.choosefiles.includes(t)||this.choosefiles.push(t)}),localStorage.file=JSON.stringify(this.choosefiles))},scanBegin(){for(var t=0;t<this.choosefiles.length;t++){let e=(0,window.electron.remote.require)("fs");try{e.readdirSync(this.choosefiles[t])}catch(e){return this.$refs.scan.pause(),void this.$alert(this.choosefiles[t]+"不可用,请确认是否移除了U盘或移动硬盘，建议更改/删除后重试。","扫描文件夹不可用")}}this.scanned={},this.slices=[],this.uploaded={},this.uploading=null,this.results={sliceTotal:0,reportArr:[]},this.errorList=[],this.currentTime=Object(l.i)(new Date).replace(/-/g,"."),this.scanning=!0,this.scan(),this.uploadBatchNumber=Object(l.i)(new Date).replace(/[-\s:]/g,"")},async scan(){if(this.scanning){if(this.uploadToBack(),this.currentScanEnd){this.currentScanEnd=!1;for(let t=0;t<this.choosefiles.length;t++){let e=null;if(this.slices.length<u&&(e=await Object(r.c)(this.choosefiles[t],async t=>!!this.scanned[t]||!!await Object(l.d)(t)&&(this.addErrorFile(t,"重复上传"),!0)))){if(e.includes("noDirectory:?"))return this.$refs.scan.pause(),void this.$alert(e.split("?")[1]+"不可用,请确认是否移除了U盘或移动硬盘，建议更改/删除后重试。","扫描文件夹不可用");this.slices.push(e),this.scanned[e]=1}}}this.currentScanEnd=!0}this.scanTimeout&&clearTimeout(this.scanTimeout),this.scanTimeout=setTimeout(()=>{this.scan()},5e3)},addErrorFile(t,e){let i=Object(l.i)(new Date),s=t.lastIndexOf("\\"),a=t.substring(s+1,t.length),n=t.substring(0,s);this.errorList.length&&this.errorList.find(e=>e.fpath===t)||this.errorList.push({fpath:t,file:a,reason:e,time:i,directory:n})},async uploadToBack(){let t=this.slices.filter(t=>!this.uploaded[t]);if(this.uploading)clearInterval(this.uploadStatusTimeout),this.uploadStatusTimeout=setInterval(()=>{this.uploadStatus=Object(r.b)()},100);else{clearInterval(this.uploadStatusTimeout),this.uploadStatusTimeout=null,this.uploadingList=[];for(let e of t){let t=this.ai;"tagging"===this.curModel&&(t=this.curModel);let i=this.uploading=Object(r.d)(e,t,this.uploadBatchNumber,this.isMerge,this.uploadingList).then(async({caseid:t,fileid:s,filename:a,option:n})=>{if(this.uploadStatus=!1,clearInterval(this.uploadStatusTimeout),i!=this.uploading)return void console.log("upload接口pending中停止");if(!t)return this.slices.indexOf(e)>=0&&this.slices.splice(this.slices.indexOf(e),1),await Object(l.a)(e),this.uploading=null,void("failed"===n?this.addErrorFile(e,"文件异常或格式不识别"):"repeat"===n?this.addErrorFile(e,"重复上传"):"nofile"===n&&this.addErrorFile(e,"找不到文件"));if("reUpload"===n)return void(this.uploading=null);if("diskFull"===n)return this.$refs.scan.pause(),this.uploading=null,void this.$alert("由于剩余存储空间不足无法继续上传切片，目前高通量任务已暂停。建议删除病例腾出空间后继续，也可以拨打客服热线400-8910357申请增加磁盘空间。");let o=this.ai;if("mutialg"==this.ai){let t=a.match(/(?<=\_).*(?=\.)/)[0].replace(/\-/,"").toLocaleLowerCase();switch(t){case"ki67热区":o="ki67hot";break;default:o=t}this.model_list.includes(o)||(o="human")}if(c.a.filter(t=>t.toolType==o)[0].canannly){let i=await Object(r.a)(t,s,a,this.options.find(t=>t.toolType==o).analyname,this.uploadBatchNumber);this.uploaded[e]={caseid:t,fileid:s,filename:a},1==i&&(this.$refs.scan.stopWork(),this.$alert("当前为试用账号，该模块的可用次数已用尽。","提示信息"))}else this.slices.indexOf(e)>=0&&this.slices.splice(this.slices.indexOf(e),1),this.results.reportArr.push({fileid:s,caseid:t,result:0,filename:a});this.results.sliceTotal++,await Object(l.a)(e),this.uploading=null},t=>{console.log(t+"catch upload")});break}}},pause(t){this.scanning=!t,this.scanning&&this.scan()},stopWork(){this.currentTime="",this.slices=[],this.uploading=null,this.scanning=!1,this.uploadBatchNumber=null,this.uploadingList.forEach(t=>{t.abort()}),this.uploadingList=[],this.uploadStatus=null,clearInterval(this.uploadStatusTimeout),this.uploadStatusTimeout=null},showerr(t){this.err=t,setTimeout(()=>this.err="",2e3)},opendetail(t){this.$emit("closeBatch"),this.$emit("click",t)},changeAI(t){"tagging"!==this.curModel&&(this.checked=!1),"mutialg"==t&&(this.dialogVisible=!0)}},watch:{curModel(t){"tagging"!==t&&(this.ai=t),localStorage.setItem("curModel",t)},ai(t){localStorage.setItem("analy",t)},batchMsg:{handler(t){t&&this.onmessage(t)},deep:!0}},destroyed(){clearTimeout(this.scanTimeout)}}}).call(e,i("EuP9").Buffer,i("DuR2"))},"Ps/q":function(t,e){},Pt1D:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=i("WK65"),a={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],staticClass:"container",attrs:{"element-loading-text":"请稍后...","element-loading-background":"rgba(0, 0, 0, 0.8)"},on:{keydown:t.keydown}},[s("header",{staticClass:"header"},[s("v-header",{attrs:{showSign:t.showSign,isStart:t.isStart,config:t.config},on:{showSign:function(e){t.showSign=!0},closeSign:function(e){t.showSign=!1},updateList:function(e){return t.updateList()}}})],1),t._v(" "),s("div",{staticClass:"center-content"},[s("div",{staticClass:"table-header"},[s("div",{staticClass:"basic-index"},[t._v(t._s(t.$t("caselist.tableheader.cases"))),s("span",[t._v(t._s(t.tableLength))])]),t._v(" "),s("div",{staticClass:"search-box"},[s("el-select",{attrs:{placeholder:"请选择"},model:{value:t.filterType,callback:function(e){t.filterType=e},expression:"filterType"}},t._l(t.options,function(e){return s("el-option",{key:e.value,attrs:{label:e.label,value:e.value}},[t._v(t._s(e.label))])}),1),t._v(" "),s("input",{directives:[{name:"model",rawName:"v-model",value:t.searchVal,expression:"searchVal"}],ref:"searchbox",attrs:{type:"text"},domProps:{value:t.searchVal},on:{input:function(e){e.target.composing||(t.searchVal=e.target.value)}}}),t._v(" "),s("button",{staticClass:"search",on:{click:t.topSearch}})],1),t._v(" "),s("div",{staticClass:"reset",on:{click:t.resetAll}},[t._v("重置筛选")]),t._v(" "),s("div",{staticClass:"header-setting",on:{click:function(e){t.showSetting=!t.showSetting}}}),t._v(" "),t.showBatch?s("div",{staticClass:"button",attrs:{id:"batch-scan"},on:{click:function(e){t.batch=!0}}},[t._v("\n          高通量扫描\n        ")]):t._e(),t._v(" "),s("div",{staticClass:"button",attrs:{id:"new-case"},on:{click:function(e){return t.createNew()}}},[t._v(t._s(t.$t("header.newCase")))]),t._v(" "),s("div",{staticClass:"button",attrs:{id:"excel-download"},on:{click:function(e){return t.downloadExcel()}}},[t._v("导出Excel")]),t._v(" "),s("div",{staticClass:"button",attrs:{id:"export-download"},on:{click:function(e){t.showImport=!0}}},[t._v("导入Excel")]),t._v(" "),s("transition",{attrs:{name:"fade"}},[t.showImport?s("div",{staticClass:"excelzhezao"},[s("div",{staticClass:"setting"},[s("div",{staticClass:"header"},[t._v("\n                Excel导入\n                "),s("span",{staticClass:"iconfont",on:{click:function(e){t.showImport=!1,t.excelname=""}}})]),t._v(" "),s("div",{staticClass:"content-setting"},[s("div",{staticClass:"mess"},[t._v("切片上传后，可通过excel表格导入病例相关字段信息。")]),t._v(" "),s("div",{staticClass:"stepone"},[s("span",[t._v("第一步：")]),s("img",{attrs:{src:i("+Xyh")},on:{click:t.downloadTemplate}})]),t._v(" "),s("div",{staticClass:"stepone"},[s("span",[t._v("第二步：")]),t._v("填写数据，上传文件\n                  "),s("div",{staticClass:"steptwo"},[s("div",{staticClass:"import-file"},[s("input",{ref:"importFile",attrs:{type:"file",accept:".xlsx"},on:{change:function(e){return t.imgPreview(e.currentTarget)}}}),t._v(" "),s("span",[t._v(t._s(t.excelname))])]),t._v(" "),s("p",[t._v("支持扩展名："),t._v("xlsx、10MB以内。")])])])]),t._v(" "),s("div",{staticClass:"footer"},[s("button",{staticClass:"save",on:{click:t.importExcel}},[t._v("确认导入数据")]),t._v(" "),s("button",{on:{click:function(e){t.showImport=!1,t.excelname=""}}},[t._v("关闭")])])])]):t._e()]),t._v(" "),t.showSetting?s("div",{staticClass:"set-choose",on:{click:function(t){t.stopPropagation()}}},[s("div",{staticClass:"tab-top"},[t._v("\n            列表展示\n          ")]),t._v(" "),s("div",{staticClass:"spend boxmain"},[s("el-checkbox",{attrs:{label:"全部展开"},on:{change:t.handleCheckAllChange},model:{value:t.checkAll,callback:function(e){t.checkAll=e},expression:"checkAll"}}),t._v(" "),s("p",[t._v("列表展开后，可在列表中直接查看病例下多个切片信息（最多10个）。")])],1),t._v(" "),s("div",{staticClass:"tab-top"},[t._v("\n            字段可见性\n            "),s("span",{on:{click:t.resetTableHead}},[t._v("重置")])]),t._v(" "),s("el-checkbox-group",{staticClass:"boxmain",on:{change:t.handleHeadChange},model:{value:t.tableChecked,callback:function(e){t.tableChecked=e},expression:"tableChecked"}},t._l(t.tableOptions,function(e){return s("el-checkbox",{key:e,attrs:{disabled:t.disableTab.includes(e),label:e}},[t._v(t._s(e))])}),1)],1):t._e()],1),t._v(" "),t.tableChecked.length?s("el-table",{ref:"table",staticClass:"table",attrs:{data:t.tableData,"span-method":t.arraySpanMethod,size:"medium","row-class-name":function(t){return t.rowIndex%2?"row1":"row2"},"row-key":t.getRowKey,"current-row-key":null,"header-cell-class-name":"header",height:"calc(100% - 277px)","highlight-current-row":"","empty-text":t.loaaded?t.$t("loading.nodata"):t.$t("loading.loading")},on:{"current-change":function(e){t.currentRecord=e||t.currentRecord},"row-dblclick":function(e){return t.openWindow(e,e.sliceId)},"filter-change":t.filterChange,"sort-change":t.sortChange,"selection-change":t.handleSelectionChange}},[s("el-table-column",{attrs:{type:"selection","reserve-selection":!0,width:"36"}}),t._v(" "),s("el-table-column",{attrs:{label:t.$t("caselist.tableheader.sample"),width:"140",sortable:"custom","column-key":"sampleNum"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("div",{ref:e.row.id,staticClass:"caseid"},[t._v("\n              "+t._s(e.row.basic.caseid)+"\n              "),s("div",{staticClass:"edit",on:{click:function(i){return i.stopPropagation(),t.openEdit(e.row,"caseId")}}}),t._v(" "),e.row.slices_count>1?s("i",{staticClass:"open-handle",class:{"el-icon-arrow-right":!e.row.opened,"el-icon-arrow-down":e.row.opened},on:{click:function(i){return i.stopPropagation(),t.toogleTable(e.row,e.row.opened)}}}):t._e()])]}}],null,!1,451277790)}),t._v(" "),t.tableChecked.includes("姓名")?s("el-table-column",{key:"name",attrs:{label:"姓名","min-width":"90"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("span",[t._v(t._s(e.row.basic.name))])]}}],null,!1,83659029)}):t._e(),t._v(" "),t.tableChecked.includes("性别")?s("el-table-column",{key:"gender",attrs:{label:t.$t("caselist.tableheader.sex"),width:"70",filters:[{text:"男",value:"男"},{text:"女",value:"女"},{text:"其他",value:"其他"}],prop:"basic.gender","column-key":"gender"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("a",{attrs:{type:e.row.basic.gender===""+t.$t("caselist.tableheader.gender[0]")?"primary":"success","disable-transitions":""}},[t._v("\n              "+t._s(t.gender[e.row.basic.gender])+"\n            ")])]}}],null,!1,1739215245)}):t._e(),t._v(" "),t.tableChecked.includes("年龄")?s("el-table-column",{key:"age",attrs:{label:t.$t("caselist.tableheader.age"),prop:"basic.age",width:"90",sortable:"custom","column-key":"age"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v("\n            "+t._s(e.row.basic.age)+"\n          ")]}}],null,!1,2461887210)},[s("template",{slot:"header"},[s("span",[t._v("年龄")]),s("div",{staticClass:"search-age",on:{click:function(e){return e.stopPropagation(),t.showAge(e)}}})])],2):t._e(),t._v(" "),t.tableChecked.includes("取样部位")?s("el-table-column",{key:"samplePart",attrs:{label:t.$t("caselist.tableheader.samplePart"),filters:t.samplePartList,prop:"basic.samplePart",width:"100","column-key":"samplePart"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("span",[t._v(t._s(e.row.basic.samplePart))])]}}],null,!1,708854339)}):t._e(),t._v(" "),t.tableChecked.includes("样本类型")?s("el-table-column",{key:"sampleType",attrs:{label:t.$t("caselist.tableheader.sampleType"),width:"100",filters:t.sampleTypeList,prop:"basic.sampleType","column-key":"sampleType"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("span",[t._v(t._s(e.row.basic.sampleType))])]}}],null,!1,2711362508)}):t._e(),t._v(" "),t.tableChecked.includes("切片数量")?s("el-table-column",{key:"slice_num",attrs:{label:t.$t("caselist.tableheader.sliceNum"),width:"100",sortable:"custom","column-key":"slice_num"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v("\n            "+t._s(e.row.slices_count)+"\n          ")]}}],null,!1,3018189602)}):t._e(),t._v(" "),s("el-table-column",{attrs:{label:"状态",filters:t.states(),width:"100","column-key":"status"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("span",{staticStyle:{position:"relative","padding-left":"18px"}},[s("i",{staticClass:"circle",class:{"bg-white":0==e.row.started,"bg-yellow":1==e.row.started,"bg-blue":2==e.row.started,"bg-red":3==e.row.started}}),t._v("\n              "+t._s(t.states().find(function(t){return t.value==e.row.started}).text)+"\n            ")])]}}],null,!1,2397898259)}),t._v(" "),t.tableChecked.includes("切片文件夹")?s("el-table-column",{key:"userFilePath",attrs:{label:"切片文件夹","min-width":"120",filters:t.folders,"column-key":"userFileFolder"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v("\n            "+t._s(e.row.userFilePath?e.row.userFilePath.split("\\")[e.row.userFilePath.split("\\").length-2]:"")+"\n          ")]}}],null,!1,3749173289)}):t._e(),t._v(" "),t.tableChecked.includes("切片标签")?s("el-table-column",{key:"slice_label",attrs:{label:"切片标签",width:"146",filters:[{text:"有",value:1},{text:"无",value:0}],"column-key":"label"},scopedSlots:t._u([{key:"default",fn:function(e){return[e.row.slices_count?s("img",{staticClass:"labelpic",attrs:{src:"/aipath/api/files/ocrlabel?caseid="+encodeURIComponent(e.row.id)+"&fileid="+e.row.sliceId+"&companyid="+t.userInfo.company,alt:"玻片"}}):s("el-tooltip",{attrs:{content:e.row.basic.filename}},[s("span",[t._v(t._s(e.row.basic.filename))])])]}}],null,!1,2588273161)}):t._e(),t._v(" "),t.tableChecked.includes("切片编号")?s("el-table-column",{key:"slice_number",attrs:{label:"切片编号",prop:"scope.row.slice_number",width:"130",filters:[{text:"有",value:1},{text:"无",value:0}],"column-key":"slice_no"},scopedSlots:t._u([{key:"default",fn:function(e){return[e.row.slices_count?s("div",{ref:e.row.sliceId,staticClass:"caseid"},[t._v("\n              "+t._s(e.row.slice_number)+"\n              ")]):t._e()]}}],null,!1,1455446136)}):t._e(),t._v(" "),s("el-table-column",{attrs:{label:"文件名",prop:"filename","min-width":"120"}}),t._v(" "),s("el-table-column",{attrs:{label:"AI模块",filters:t.AIList,prop:"alg",width:"90","column-key":"alg_list"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v("\n            "+t._s(t.formatAlg()[e.row.alg])+"\n          ")]}}],null,!1,3018021721)}),t._v(" "),s("el-table-column",{key:"ai_suggest",attrs:{label:"AI建议","min-width":"130",prop:"ai_suggest",filters:t.checkResult,"column-key":"ai_suggest"},scopedSlots:t._u([{key:"default",fn:function(e){return["pdl1"==e.row.alg||"cd30"==e.row.alg?s("div",[t._v("\n              "+t._s(e.row.ai_suggest?"TPS："+e.row.ai_suggest:e.row.ai_suggest)+"\n            ")]):"ki67"==e.row.alg||"er"==e.row.alg||"pr"==e.row.alg?s("div",[t._v("\n              "+t._s(e.row.ai_suggest?"指数："+e.row.ai_suggest:e.row.ai_suggest)+"\n            ")]):e.row.alg&&(e.row.alg.includes("tct")||e.row.alg.includes("lct"))?s("div",{staticStyle:{position:"relative","padding-left":"18px","line-height":"18px"}},[e.row.ai_suggest?s("i",{staticClass:"circle",class:{"bg-red":e.row.ai_suggest.includes("阳性"),"bg-blue":e.row.ai_suggest.includes("阴性")}}):t._e(),t._v("\n                "+t._s(e.row.ai_suggest)+"\n            ")]):"dna"==e.row.alg?s("div",{staticStyle:{position:"relative","padding-left":"18px","line-height":"18px"}},[e.row.ai_suggest&&e.row.ai_suggest.split(";")[0]?s("i",{staticClass:"circle",class:{"bg-red":e.row.ai_suggest.includes("阳性"),"bg-blue":e.row.ai_suggest.includes("阴性")}}):t._e(),t._v("\n              "+t._s((""+e.row.ai_suggest.split(" ").map(function(t,e){return 3==e?"("+t.split(";")[0]+")"+t.split(";")[1]:t}).join(" ")).replace(";"," "))+"\n            ")]):s("div",[t._v("\n              "+t._s(e.row.ai_suggest)+"\n            ")])]}}],null,!1,1744607292)}),t._v(" "),t.tableChecked.includes("复核结果")?s("el-table-column",{key:"check_result",attrs:{label:"复核结果","min-width":"130",prop:"check_result",filters:t.humanCheckResult,"column-key":"check_result"},scopedSlots:t._u([{key:"default",fn:function(e){return["pdl1"==e.row.alg?s("div",[t._v("\n              "+t._s(e.row.check_result?"TPS："+e.row.check_result:e.row.check_result)+"\n            ")]):"ki67"==e.row.alg||"er"==e.row.alg||"pr"==e.row.alg?s("div",[t._v("\n              "+t._s(e.row.check_result?"指数："+e.row.check_result:e.row.check_result)+"\n            ")]):e.row.alg&&(e.row.alg.includes("tct")||e.row.alg.includes("lct"))?s("div",{staticStyle:{position:"relative","padding-left":"18px","line-height":"18px"}},[e.row.check_result?s("i",{staticClass:"circle",class:{"bg-red":e.row.check_result.includes("阳性"),"bg-blue":e.row.check_result.includes("阴性")}}):t._e(),t._v("\n              "+t._s(""+e.row.check_result.split(" ").map(function(t,e){return 3==e?"("+t+")":t}).join(" "))+"\n            ")]):"dna"==e.row.alg?s("div",{staticStyle:{position:"relative","padding-left":"18px","line-height":"18px"}},[e.row.check_result&&e.row.check_result.split(";")[0]?s("i",{staticClass:"circle",class:{"bg-red":e.row.check_result.includes("阳性"),"bg-blue":e.row.check_result.includes("阴性")}}):t._e(),t._v("\n              "+t._s((""+e.row.check_result.split(" ").map(function(t,e){return 3==e?(t.split(";")[0]?"("+t.split(";")[0]+")":"")+t.split(";")[1]:t}).join(" ")).replace(";"," "))+"\n            ")]):s("div",[t._v(t._s(e.row.check_result))])]}}],null,!1,2468674788)}):t._e(),t._v(" "),t.tableChecked.includes("创建时间")?s("el-table-column",{attrs:{width:"156",sortable:"custom","column-key":"create_time",label:"创建时间"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v("\n            "+t._s(t._f("fmt")(e.row.create_time))+"\n          ")]}}],null,!1,156999701)},[s("template",{slot:"header"},[t._v("\n              创建时间"),s("div",{staticClass:"search-age search-creat",staticStyle:{right:"30px"},on:{click:function(e){return e.stopPropagation(),t.showTime(".search-creat")}}})])],2):t._e(),t._v(" "),s("el-table-column",{attrs:{width:"156",sortable:"custom","column-key":"update_time",label:"最后更新"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v("\n            "+t._s(t._f("fmt")(e.row.update))+"\n          ")]}}],null,!1,2089939978)},[s("template",{slot:"header"},[t._v("\n              最后更新"),s("div",{staticClass:"search-age search-time",staticStyle:{right:"30px"},on:{click:function(e){return e.stopPropagation(),t.showTime(".search-time")}}})])],2),t._v(" "),t.tableChecked.includes("操作人")?s("el-table-column",{key:"operator",attrs:{label:"操作人",width:"90",prop:"operator",filters:t.operators,"column-key":"operator"}}):t._e(),t._v(" "),t.tableChecked.includes("报告")?s("el-table-column",{key:"length",attrs:{label:t.$t("caselist.tableheader.report"),filters:t.checkReport(),width:"80",prop:"reports.length","column-key":"reports"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("span",{class:{report:e.row.reports.length},on:{click:function(i){return i.stopPropagation(),t.showReport(e.row)}}},[t._v("\n                "+t._s(e.row.reports.length?"查看报告":"--")+"\n              ")])]}}],null,!1,1812645644)}):t._e(),t._v(" "),"admin"==t.userInfo.role?s("el-table-column",{attrs:{label:t.$t("caselist.tableheader.operation"),width:"200",fixed:"right"},scopedSlots:t._u([{key:"default",fn:function(e){return[s("el-button",{staticClass:"delete",on:{click:function(i){return i.stopPropagation(),t.openWindow(e.row,null,0)}}},[t._v("登记")]),t._v(" "),s("el-button",{staticClass:"delete",attrs:{slot:"reference"},on:{click:function(i){return i.stopPropagation(),t.deleteRecord(e.row)}},slot:"reference"},[t._v(t._s(t.$t("caselist.operation.delete")))])]}}],null,!1,2155474662)}):t._e()],1):t._e(),t._v(" "),s("div",{staticClass:"message-bar",on:{click:function(e){t.showMultyAI=!1}}},[s("div",{staticClass:"message"},[t._v("\n          已选 "+t._s(this.recordChecked.length)+"\n          "),t.recordChecked.length?s("span",{staticClass:"clear",on:{click:function(e){t.recordChecked=[],t.folderList=[],t.$refs.table.clearSelection()}}},[t._v("清除已选")]):t._e(),t._v(" "),t.recordChecked.length?s("div",{staticClass:"mulAI",on:{click:function(e){e.stopPropagation(),t.showMultyAI=!t.showMultyAI}}},[t._v("\n            算法处理\n            "),t.showMultyAI?s("i",{staticClass:"el-icon-arrow-up"}):s("i",{staticClass:"el-icon-arrow-down"}),t._v(" "),t.showMultyAI?s("ul",{style:{top:40*-t.multyAI.length-3+"px"}},t._l(t.multyAI,function(e){return s("li",{key:e.value,class:{notallowed:!JSON.parse(t.userInfo.model_lis).includes(e.value)},on:{click:function(i){return t.cal(e.value,e.label)}}},[t._v("\n                "+t._s(e.label)+"\n              ")])}),0):t._e()]):t._e(),t._v(" "),t.recordChecked.length&&!t.userInfo.cloud&&t.showBatch?s("div",{staticClass:"del-all",on:{click:function(e){t.exportPop=!0}}},[t._v("导出切片")]):t._e(),t._v(" "),"admin"==t.userInfo.role&&t.recordChecked.length&&t.config&&t.config.zeiss?s("div",{staticClass:"del-all",on:{click:t.calibrationModel}},[t._v("模型校准")]):t._e(),t._v(" "),"admin"==t.userInfo.role&&t.recordChecked.length?s("div",{staticClass:"del-all",on:{click:t.delAll}},[t._v("删除")]):t._e()]),t._v(" "),t.records.length?s("el-pagination",{staticClass:"page",attrs:{"current-page":t.currentPage,"page-sizes":[20,50,100],"page-size":t.pagesize,layout:"sizes, prev, pager, next",total:t.tableLength},on:{"size-change":t.handleSizeChange,"current-change":t.handlePageChange}}):t._e()],1),t._v(" "),s("v-thumbnails",{key:"thumb"+(t.currentRecord&&t.currentRecord.id),attrs:{record:t.currentRecord&&t.tableData.find(function(e){return e.id==t.currentRecord.id})},on:{click:function(e){return t.openWindow(t.currentRecord,e)}}})],1),t._v(" "),s("div",{staticClass:"taskbar"},[s("div",{staticClass:"btns"},[t.windows.length?s("div",{staticClass:"leftbtm",class:{leftforbidden:!t.showLeft},on:{click:function(e){t.showLeft&&t.goLeft()}}}):t._e(),t._v(" "),s("div",{ref:"toolsContainer",staticClass:"tools-container"},[s("div",{ref:"toolslist",staticClass:"toolslist"},t._l(t.windows,function(e){return s("div",{key:e.id,class:{active:e==t.currentWindow},on:{click:function(i){t.openWindow(e.record),t.batch&&t.currentWindow&&(t.batch=!1)},contextmenu:function(i){return i.preventDefault(),t.showMenu(i,e)}}},[s("div",{staticClass:"cur-bar",style:"width:"+100*t.getProgress(e.record)+"%"}),t._v(" "),s("div",{attrs:{title:e.record.basic.caseid}},[t._v("\n                "+t._s(t.showEtc(e.record.basic.caseid))+"\n                "),s("span",{staticClass:"closecontext",on:{click:function(i){return i.stopPropagation(),t.closeConfirm(e)}}})])])}),0)]),t._v(" "),t.windows.length?s("div",{staticClass:"rightbtm",class:{rightforbidden:!t.showRight},on:{click:function(e){t.showRight&&t.goRight()}}}):t._e()]),t._v(" "),t.showContext?s("ul",{staticClass:"context-menu",style:{left:t.contextLeft+"px"}},[s("li",{on:{click:function(e){return e.stopPropagation(),t.closeCase("cur")}}},[t._v("关闭")]),t._v(" "),s("li",{on:{click:function(e){return e.stopPropagation(),t.closeCase("others")}}},[t._v("关闭其它标签")]),t._v(" "),s("li",{on:{click:function(e){return e.stopPropagation(),t.closeCase("all")}}},[t._v("关闭所有标签")])]):t._e()]),t._v(" "),t._l(t.windows,function(e){return s("v-detail",{key:e.id,ref:e.id+"detail",refInFor:!0,style:{transform:e.show?"scale(1)":"scale(0)","transform-origin":90*t.windows.indexOf(e)+20+52+"px bottom",transition:"transform 0.3s"},attrs:{data:e,showBatch:t.showBatch,config:t.config,records:t.recordsToChild,filters:t.conditions,clickTimer:t.clickTimer,netSocket:t.netSocket},on:{hidding:function(i){return t.hideWindow(e)},closing:function(i){return t.closeWindow(e)},updated:function(e){return t.updateList()},openNewWindow:t.openNewWindow,sign:function(e){t.showSign=!0},"move-stage":function(e){return t.stagePos=e}}})}),t._v(" "),s("keep-alive",[s("transition",{attrs:{name:"batch"}},[s("div",{directives:[{name:"show",rawName:"v-show",value:t.batch,expression:"batch"}],style:"transform-origin:95% bottom",attrs:{id:"batch"}},[s("v-batch",{ref:"batchDom",staticClass:"batch",attrs:{batchMsg:t.batchMsg,queueMsg:t.queueMsg,isStart:t.isStart},on:{closeBatch:t.closeBatch,click:t.opendetail,setStart:function(e){return t.isStart=e}}})],1)])],1),t._v(" "),s("transition",{attrs:{name:"fade"}},[t.showReports?s("div",{attrs:{id:"choosepdf"}},[s("div",{staticClass:"cnt"},[s("div",{staticClass:"header"},[t._v("\n            "+t._s(t.$t("caselist.tableheader.viewReport"))),s("i",[t._v(t._s(t.currentRecord.reports.length))]),t._v(" "),s("span",{staticClass:"iconfont",on:{click:function(e){t.showReports=!1}}})]),t._v(" "),s("div",{staticClass:"content"},[s("ul",{staticClass:"tp"},[s("li",[t._v(t._s(t.$t("caselist.reportlist.time")))]),t._v(" "),s("li",[t._v(t._s(t.$t("caselist.reportlist.doctor")))]),t._v(" "),s("li",[t._v(t._s(t.$t("caselist.reportlist.operation")))])]),t._v(" "),s("ul",{staticClass:"bm"},t._l(t.currentRecord.reports,function(e,i){return s("li",{key:i,class:{tr_active:!0}},[s("a",{attrs:{href:"javascript:;"}},[t._v(t._s(t._f("fmt")(e.date)))]),t._v(" "),s("a",{attrs:{href:"javascript:;"}},[t._v(t._s(e.doctor))]),t._v(" "),s("a",{ref:"lastA",refInFor:!0,staticClass:"lastA",on:{click:function(s){return t.download(t.currentRecord.id,e.id,i)}}},[t._v(t._s(t.$t("caselist.reportlist.checkPdf"))+" ")])])}),0)])])]):t._e()]),t._v(" "),t.showAgeRange?s("div",{staticClass:"age-range",style:{left:t.offLeft-227+"px"},on:{click:function(t){t.stopPropagation()}}},[s("div",{staticClass:"age-top"},[s("span",[t._v("年龄：")]),t._v(" "),s("input",{directives:[{name:"model",rawName:"v-model",value:t.ageStart,expression:"ageStart"}],attrs:{type:"text",onkeyup:"value=value.replace(/[^\\.\\d]/g,'')"},domProps:{value:t.ageStart},on:{input:function(e){e.target.composing||(t.ageStart=e.target.value)}}}),t._v(" "),s("span",[t._v("-")]),t._v(" "),s("input",{directives:[{name:"model",rawName:"v-model",value:t.ageEnd,expression:"ageEnd"}],attrs:{type:"text",onkeyup:"value=value.replace(/[^\\.\\d]/g,'')"},domProps:{value:t.ageEnd},on:{input:function(e){e.target.composing||(t.ageEnd=e.target.value)}}})]),t._v(" "),s("div",{staticClass:"age-bottom"},[s("button",{staticClass:"primary",on:{click:t.setAgeRange}},[t._v("筛选")]),t._v(" "),s("button",{on:{click:t.resetAge}},[t._v("重置")]),t._v(" "),s("button",{on:{click:function(e){t.showAgeRange=!1,t.ageEnd=t.ageStart=""}}},[t._v("取消")])])]):t._e(),t._v(" "),t.showTimeRange?s("div",{staticClass:"time-range",style:{left:t.offLeft-520+"px"},on:{click:function(t){t.stopPropagation()}}},[s("div",{staticClass:"age-top"},[s("span",[t._v("时间：")]),t._v(" "),s("el-date-picker",{attrs:{type:"datetimerange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期"},model:{value:t.dateTime,callback:function(e){t.dateTime=e},expression:"dateTime"}})],1),t._v(" "),s("div",{staticClass:"age-bottom"},[s("button",{staticClass:"primary",on:{click:function(e){return t.setTimeRange("update")}}},[t._v("筛选")]),t._v(" "),s("button",{on:{click:function(e){return t.resetTime("update")}}},[t._v("重置")]),t._v(" "),s("button",{on:{click:function(e){t.showTimeRange=!1,t.dateTime=[]}}},[t._v("取消")])])]):t._e(),t._v(" "),t.showCreateRange?s("div",{staticClass:"time-range",style:{left:t.offLeft-520+"px"},on:{click:function(t){t.stopPropagation()}}},[s("div",{staticClass:"age-top"},[s("span",[t._v("时间：")]),t._v(" "),s("el-date-picker",{attrs:{type:"datetimerange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期"},model:{value:t.createTime,callback:function(e){t.createTime=e},expression:"createTime"}})],1),t._v(" "),s("div",{staticClass:"age-bottom"},[s("button",{staticClass:"primary",on:{click:function(e){return t.setTimeRange("create")}}},[t._v("筛选")]),t._v(" "),s("button",{on:{click:function(e){return t.resetTime("create")}}},[t._v("重置")]),t._v(" "),s("button",{on:{click:function(e){t.showCreateRange=!1,t.createTime=[]}}},[t._v("取消")])])]):t._e(),t._v(" "),s("transition",{attrs:{name:"fade"}},[t.visiable?s("div",{ref:"editPop",staticClass:"editPop",on:{click:function(t){t.stopPropagation()}}},[s("input",{directives:[{name:"model",rawName:"v-model",value:t.editCase,expression:"editCase"}],ref:"checkvalue",staticClass:"name-input",attrs:{id:"222"},domProps:{value:t.editCase},on:{input:function(e){e.target.composing||(t.editCase=e.target.value)}}}),t._v(" "),s("button",{staticClass:"save-edit",on:{click:function(e){return t.saveEidt()}}},[t._v("保存")]),t._v(" "),s("img",{attrs:{src:i("rN2d")},on:{click:function(e){t.visiable=!1}}})]):t._e()]),t._v(" "),s("transition",{attrs:{name:"fade"}},[t.showSetPsw?s("PswPop",{attrs:{title:"导出.db仅限授权人员使用"},on:{confirmBtn:function(e){return t.exportDb()},cancelBtn:function(e){t.showSetPsw=!1}}}):t._e()],1),t._v(" "),s("transition",{attrs:{name:"fade"}},[t.exportPop?s("div",{staticClass:"excelzhezao"},[s("div",{staticClass:"folder-setting"},[s("div",{staticClass:"header"},[t._v("\n            操作确认\n            "),s("span",{staticClass:"iconfont",on:{click:function(e){t.exportPop=!1}}})]),t._v(" "),s("div",{staticClass:"content-folder"},[s("p",{staticClass:"tips"},[t._v("确定导出所选病例下所有切片吗？导出时无法进行其它操作。文件夹切片（含多小图）暂无法导出。")]),t._v(" "),s("div",{staticClass:"folder"},[s("span",[t._v("保存路径："),s("button",{on:{click:t.chooseFolder}},[t._v("更改")])]),t._v(" "),s("p",[t._v(t._s(this.folder))])]),t._v(" "),s("div",{staticClass:"ip"},[t._v("\n              IP："),s("input",{directives:[{name:"model",rawName:"v-model",value:t.ip,expression:"ip"}],attrs:{value:"text"},domProps:{value:t.ip},on:{input:function(e){e.target.composing||(t.ip=e.target.value)}}})]),t._v(" "),s("el-checkbox",{model:{value:t.exportSlideWithDB,callback:function(e){t.exportSlideWithDB=e},expression:"exportSlideWithDB"}},[t._v("同时导出.db")])],1),t._v(" "),s("div",{staticClass:"footer"},[s("button",{staticClass:"save",on:{click:t.exportSlides}},[t._v("确定")]),t._v(" "),s("button",{on:{click:function(e){t.exportPop=!1}}},[t._v("取消")])])])]):t._e()]),t._v(" "),s("transition",{attrs:{name:"fade"}},[t.cancleExport?t._e():s("div",{staticClass:"exportzhezao"},[s("div",{staticClass:"cen"},[s("i",{staticClass:"el-icon-loading"}),t._v(" "),s("p",[t._v("切片导出中...请勿关闭软件")]),t._v(" "),s("button",{staticClass:"cancel-export",on:{click:t.cancleExportSlides}},[t._v("取消导出")])])])]),t._v(" "),s("transition",{attrs:{name:"fade"}},[t.modelUpdate?s("div",{staticClass:"exportzhezao"},[s("div",{staticClass:"cen new-zen"},[s("img",{staticClass:"gif",attrs:{src:i("Bzth")}}),t._v(" "),s("h2",[t._v("模型校准中...")]),t._v(" "),s("h3",[t._v("请勿关闭服务器和客户端")]),t._v(" "),s("button",{staticClass:"cancel-export",on:{click:t.cancleCalibration}},[t._v("取消")])])]):t._e()])],2)},staticRenderFns:[]};var n=function(t){i("yi+Z")},o=i("VU/8")(s.a,a,!1,n,"data-v-1d34a35e",null);e.default=o.exports},Q9fs:function(t,e){},QQWi:function(t,e){},Qar8:function(t,e,i){t.exports=i.p+"static/img/多边形.838184f.svg"},QlC6:function(t,e,i){t.exports=i.p+"static/img/批量上传.1188967.svg"},"R/dF":function(t,e){},RR5D:function(t,e){},"Re+S":function(t,e){},RiVg:function(t,e){},Ro5g:function(t,e){},SEzi:function(t,e,i){t.exports=i.p+"static/img/标注列表-缺省.04d341d.png"},SQcn:function(t,e,i){"use strict";var s=i("Pd0x"),a={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"outer"},[s("div",{staticClass:"container"},[s("a",{staticClass:"goback",attrs:{href:"javascript:;"},on:{click:function(e){return t.$emit("closeBatch")}}},[t._v("返回")]),t._v(" "),s("div",{staticClass:"header"},[s("img",{staticClass:"logo",attrs:{src:i("io7N"),alt:"",width:"160"}}),t._v(" "),t.currentTime?s("div",{staticClass:"start-time"},[t._v("\n\t\t\t\t开始扫描时间："+t._s(t.currentTime)+"\n\t\t\t")]):t._e(),t._v(" "),s("div",{staticClass:"title"},[t._v("高通量分析系统")])]),t._v(" "),s("div",{staticClass:"content"},[t.showFileList?s("div",{staticClass:"filelist",on:{click:function(t){t.stopPropagation()}}},t._l(t.choosefiles,function(e,a){return s("p",{key:e,attrs:{title:e},on:{mouseenter:function(e){t.hoverIndex=a},mouseleave:function(e){t.hoverIndex=null}}},[t._v("\n\t\t\t\t\t"+t._s(e)+"\n\t\t\t\t\t"),t.hoverIndex===a?s("img",{attrs:{src:i("eqs2"),alt:""},on:{click:function(e){return t.deleteFile(a)}}}):t._e()])}),0):t._e(),t._v(" "),s("div",{staticClass:"add_name"},[s("div",{staticClass:"filepath",attrs:{title:t.choosefiles.length?"":"请选择要扫描切片所在的文件夹"},on:{click:function(e){t.showFileList=!t.showFileList}}},[t._v("\n\t\t\t\t\t"+t._s(t.choosefiles.length&&"已选择"+t.choosefiles.length+"个文件夹,点击查看"||"请选择要扫描切片所在的文件夹")+"\n\t\t\t\t")]),t._v(" "),t.choosefiles.length?s("span",{on:{click:t.closeChoosefiles}}):t._e(),t._v(" "),s("a",{staticClass:"file",attrs:{href:"javascript:;"}},[t._v("\n\t\t\t\t\t选择文件夹\n\t\t\t\t\t"),s("el-button",{staticClass:"button",attrs:{disabled:t.scanning},on:{click:t.getfile}})],1),t._v(" "),t.err?s("div",{staticClass:"err"},[t._v(t._s(t.err))]):t._e(),t._v(" "),"mutialg"!==t.curModel?s("el-checkbox",{staticClass:"cananalysis",attrs:{disabled:t.$refs.scan&&t.$refs.scan.isStart},model:{value:t.isMerge,callback:function(e){t.isMerge=e},expression:"isMerge"}},[t._v("合并切片")]):t._e(),"mutialg"!==t.curModel?s("i",{staticClass:"el-icon-warning-outline contact",on:{click:function(e){t.showTips=!t.showTips}}}):t._e(),t._v(" "),"tagging"===t.curModel?s("el-checkbox",{staticClass:"cananalysis",attrs:{disabled:t.$refs.scan&&t.$refs.scan.isStart},model:{value:t.checked,callback:function(e){t.checked=e},expression:"checked"}},[t._v("算法计算，结果导入标注")]):t._e()],1),t._v(" "),"tagging"!==t.curModel?s("el-select",{staticClass:"choosemodel",attrs:{"popper-class":"selectmodel",disabled:t.$refs.scan&&t.$refs.scan.isStart,placeholder:"请选择模块"},on:{change:t.changeAI},model:{value:t.curModel,callback:function(e){t.curModel=e},expression:"curModel"}},t._l(t.options,function(t){return s("el-option",{key:t.toolType,staticClass:"choosemodelItem",attrs:{label:t.label,value:t.toolType}})}),1):t._e(),t._v(" "),"tagging"===t.curModel?s("el-select",{staticClass:"choosemodel",staticStyle:{width:"150px"},attrs:{"popper-class":"selectmodel",disabled:t.$refs.scan&&t.$refs.scan.isStart,placeholder:"请选择模块"},on:{change:t.changeAI},model:{value:t.curModel,callback:function(e){t.curModel=e},expression:"curModel"}},t._l(t.options,function(t){return s("el-option",{key:t.toolType,staticClass:"choosemodelItem",attrs:{label:t.label,value:t.toolType}})}),1):t._e(),t._v(" "),"tagging"===t.curModel?s("el-select",{staticClass:"choosemodel",staticStyle:{width:"150px",left:"280px"},attrs:{"popper-class":"selectmodel",disabled:t.$refs.scan&&t.$refs.scan.isStart,placeholder:"请选择算法"},on:{change:t.changeAI},model:{value:t.ai,callback:function(e){t.ai=e},expression:"ai"}},t._l(t.tagoptions,function(t){return s("el-option",{key:t.toolType,staticClass:"choosemodelItem",attrs:{label:t.label,value:t.toolType}})}),1):t._e(),t._v(" "),s("v-scanning",{ref:"scan",attrs:{slices:t.slices,iffile:t.choosefiles.length,isStart:t.isStart,uploadStatus:t.uploadStatus,choosemodel:t.options.find(function(e){return e.toolType==t.ai})},on:{pause:t.pause,stopWork:t.stopWork,setStart:function(e){return t.$emit("setStart",e)},showerr:t.showerr,scanBegin:t.scanBegin}}),t._v(" "),s("v-analysis",{attrs:{slices:t.slices,ifstopcut:t.ifstopcut}}),t._v(" "),s("v-results",{attrs:{results:t.results,choosemodel:t.ai,errorListLength:t.errorList.length,queueMsg:t.queueMsg},on:{click:t.opendetail,"open-list":function(e){t.showError=!0}}})],1)]),t._v(" "),s("div",[s("el-dialog",{staticClass:"batch-dialog",attrs:{title:"提示",visible:t.showTips,width:"100%","modal-append-to-body":!1,"close-on-click-modal":!1},on:{"update:visible":function(e){t.showTips=e}}},[s("div",{staticClass:"standard-tip"},[s("span",{staticClass:"el-icon-warning-outline"}),t._v(" "),s("span",[t._v("确认开启后，上传时系统将根据切片文件名格式合并多切片到一个病例。")])]),t._v(" "),s("div",{staticClass:"standard-style"},[t._v("\n\t\t\t\t文件名格式规范：病例编号_xxx.文件后缀\n\t\t\t")]),t._v(" "),s("div",{staticClass:"standard-item"},[s("span",[t._v("【病例编号】")]),t._v(" "),s("span",[t._v("即第一个下划线之前的文本，将用于判断是否同一病例，病例编号将作为合并后病例的样本号保存。")])]),t._v(" "),s("div",{staticClass:"standard-item"},[s("span",[t._v("【例】")]),t._v(" "),s("span",[t._v("123789_01.svs     T3827192_01.tiff    T3827192_02.svs")])]),t._v(" "),s("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[s("el-button",{attrs:{type:"primary"},on:{click:function(e){t.showTips=!1}}},[t._v("确定")])],1)])],1),t._v(" "),s("div",[s("el-dialog",{staticClass:"batch-dialog",attrs:{title:"提示",visible:t.dialogVisible,width:"100%","modal-append-to-body":!1,"close-on-click-modal":!1},on:{"update:visible":function(e){t.dialogVisible=e}}},[s("div",{staticClass:"standard-tip"},[s("span",{staticClass:"el-icon-warning-outline"}),t._v(" "),s("span",[t._v("多算法模式下，请确保目标文件夹内的切片文件符合文件名格式规范，否则将造成AI处理失败。")])]),t._v(" "),s("div",{staticClass:"standard-style"},[t._v("\n\t\t\t\t文件名格式规范：病例编号_算法名称.文件后缀\n\t\t\t")]),t._v(" "),s("div",{staticClass:"standard-item"},[s("span",[t._v("【病例编号】")]),t._v(" "),s("span",[t._v("\n\t\t\t\t\t当多个切片文件的病例编号一致时，系统将视为同一病例，将这多个切片文件放置在一个病例下；\n\t\t\t\t")])]),t._v(" "),s("div",{staticClass:"standard-item"},[s("span",[t._v("【算法名称】")]),t._v(" "),s("span",[t._v("\n\t\t\t\t\t系统将根据算法名称来调用对应算法处理，目前支持PD-L1、Ki-67、Ki-67热区、ER、PR、HER-2、FISH、TCT、LCT（以实际已开通模块为准）\n\t\t\t\t")])]),t._v(" "),s("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[s("el-button",{attrs:{type:"primary"},on:{click:function(e){t.dialogVisible=!1}}},[t._v("确定")])],1)])],1),t._v(" "),t.showError?s("div",{staticClass:"error-box"},[s("header",[t._v("上传异常切片（"+t._s(t.errorList.length)+"）"),s("span",{staticClass:"iconfont",on:{click:function(e){t.showError=!1}}})]),t._v(" "),t._m(0),t._v(" "),s("div",{staticClass:"error-list"},[s("table",[t._m(1),t._v(" "),t._l(t.errorList,function(e,i){return s("tr",{key:e.fpath},[s("td",[t._v(t._s(i+1))]),t._v(" "),s("td",[t._v(t._s(e.file))]),t._v(" "),s("td",[t._v(t._s(e.reason))]),t._v(" "),s("td",[t._v(t._s(e.time))]),t._v(" "),s("td",[t._v(t._s(e.directory))])])})],2)]),t._v(" "),t.errorList.length?s("div",{staticClass:"download",on:{click:t.downloadExcel}},[t._v("导出Excel")]):t._e(),t._v(" "),s("footer",[s("button",{on:{click:function(e){t.showError=!1}}},[t._v("关闭")])])]):t._e()])},staticRenderFns:[function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"warning"},[i("h3",[i("i",{staticClass:"el-icon-info"}),t._v("说明")]),t._v(" "),i("p",[i("span",[t._v("重复上传：")]),t._v("高通量会跳过已上传的切片，请前往病例列表将对应切片删除后重试。")]),t._v(" "),i("p",[i("span",[t._v("文件异常或格式不识别：")]),t._v("如切片文件被破坏，不完整，或切片格式不兼容时，高通量将无法上传。")]),t._v(" "),i("p",[i("span",[t._v(" 找不到文件：")]),t._v("系统扫描到文件后才会开始上传，如果上传前文件被删除或硬盘被移除等，高通量将无法正常上传。")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("tr",[e("th",{attrs:{width:"50"}},[this._v("No.")]),e("th",{attrs:{width:"180"}},[this._v("文件名")]),e("th",{attrs:{width:"82"}},[this._v("异常原因")]),e("th",{attrs:{width:"160"}},[this._v("时间")]),e("th",[this._v("文件路径")])])}]};var n=function(t){i("+SYN"),i("XS7h")},o=i("VU/8")(s.a,a,!1,n,"data-v-b747ab3e",null);e.a=o.exports},SfvY:function(t,e,i){"use strict";var s,a=i("I9+T"),n=i("k5KV"),o=i.n(n),l=i("jyVo"),r={props:["slice","record","roilist","curRois","centerRegion","penColor","position","content","companyid","showMppGuide","cellArea","showLayer","moveStatus","radius","filled","currentAngle"],data(){return{mpp:this.slice.mppx||.242042,scale:1,fullPage:!1,osd:null,company:this.$props.companyid||Object(l.o)().company,viewport:null,paper:null,selectedTool:"choose",dataMapPath:{},offsetWidth:0,offsetHeight:0,showRoi:!0,saved:!1,showLabel:!0,knew:!1,drawMpp:!1,userMpp:null,deg:0,layers:[null,null,null,null,null,null],showPenTool:!1,pentool:"freepen",scope:null,pointAble:["ki67","er","pr","pdl1","tagging","fish","ki67hot","her2","np","cd30"].includes(this.slice.toolType),reverseAble:!1,showRadius:!1,newRadius:this.radius,segmentsList:[]}},methods:{adjustSegment(){Object.keys(this.curRois).length?this.selectedTool="pickTool":this.$message.warning("请先选择一个调整对象")},toNumber(){this.newRadius=this.newRadius.replace(/[^\.\d]/g,"")},checkTool(t){this.showPenTool=!1,this.pentool=t,this.selectedTool=t},chooseTool(){this.pentool==this.selectedTool&&(this.showPenTool=!this.showPenTool),this.selectedTool=this.pentool},rotate(){this.deg+=90,this.$refs.rotate.style.transform=`rotate(${this.deg}deg)`},drawCell(){this.$emit("closeMppGuide",!0),this.drawMpp=!0,this.selectedTool="rectangle"},convertPoint(t,e){return this.paper.view.viewToProject(new this.paper.Point(t,e))},initOSD(){let t=OpenSeadragon({element:this.$refs.osd,tileSources:{height:this.slice.height,width:this.slice.width,tileSize:1024,getTileUrl:(t,e,i)=>`/aipath/api/files/slice?x=${e}&y=${i}&z=${t}&caseid=${this.record.id}&fileid=${this.slice.id}&companyid=${this.company}&filename=${encodeURIComponent(this.slice.filename||this.slice.name)}`},minZoomLevel:.001,maxZoomLevel:1e4,visibilityRatio:.01,toolbar:this.$refs.hideToolbar,mouseNavEnabled:!1,animationTime:.8,maxImageCacheCount:12,immediately:!0,showNavigator:!0,navigatorPosition:"TOP_LEFT",navigatorAutoFade:!1});this.osd=t,this.viewport=t.viewport,this.$emit("viewer",this.viewport),t.activateImagingHelper(),t.addHandler("open",()=>{this.paper=new paper.PaperScope,this.paper.activate(),this.paper.setup(this.$refs.canvas),this.paper.settings.handleSize=8,this.layers[0]=new this.paper.Layer,this.layers[1]=new this.paper.Layer,this.layers[2]=new this.paper.Layer,this.layers[3]=new this.paper.Layer,this.layers[4]=new this.paper.Layer,this.layers[5]=new this.paper.Layer,this.roilistChange(this.roilist||[],[]),this.resized(),this.position.zoom?this.update(this.position,!0):this.buttonClick("home");let e=null;t.addHandler("update-viewport",()=>{let t=this.slice.width,{x:i,y:s}=this.viewport.getBounds(!0).getCenter();this.paper.view.rotation=this.currentAngle||0,this.paper.view.setCenter(i*t,s*t);let a=this.viewport.getZoom(!0);this.paper.view.zoom=this.viewport.viewportToImageZoom(a),clearTimeout(e),e=setTimeout(()=>{this.getRoi()},400)}),t.addHandler("animation-start",()=>{"pdl1"!=this.slice.toolType&&"np"!=this.slice.toolType||this.$emit("changeMoveStatus","moveStart")}),t.addHandler("animation-finish",()=>{let t=this.slice.width/this.slice.height,e=this.paper.view.getCenter().x/this.slice.width,i=this.paper.view.getCenter().y/this.slice.height/t;this.position.offx.toFixed(10)===e.toFixed(10)&&this.position.offy.toFixed(10)===i.toFixed(10)||this.move(e,i)})}),this.$refs.osd.addEventListener("contextmenu",this.contextmenu),window.addEventListener("resize",this.resize)},getRoi(){if(!this.paper.view)return;let t=parseInt(this.convertPoint(0,0).x),e=parseInt(this.convertPoint(0,0).y);if(this.$refs.osd){let t=this.$refs.osd.querySelector(".openseadragon-canvas").querySelector("canvas");var i=parseInt(this.convertPoint(t.width,t.height).x),s=parseInt(this.convertPoint(t.width,t.height).y)}let a=this.osd.world.getItemAt(0).lastDrawn,n=Math.max(...a.map(t=>t.level));this.$emit("getRoi",{x1:t,x2:i,y1:e,y2:s,z:n}),"pdl1"!=this.slice.toolType&&"np"!=this.slice.toolType||this.$emit("changeMoveStatus","moveEnd")},move(t,e,i){this.$emit("position","number"==typeof t?t:this.position.offx,"number"==typeof e?e:this.position.offy,"number"==typeof i?i:this.position.zoom)},update(t=this.position,e){this.viewport.zoomTo(t.zoom,"",e),this.viewport.panTo({x:t.offx,y:t.offy},e)},resize(){setTimeout(t=>this.resized(this.position.zoom/this.scale),0)},resized(t){this.offsetWidth=this.$refs.osd.offsetWidth,this.offsetHeight=this.$refs.osd.offsetHeight,this.paper.view.viewSize=[this.offsetWidth,this.offsetHeight],this.scale=this.mpp*this.slice.width*Math.min(this.offsetHeight/this.offsetWidth,1)/22e3,this.move(null,null,t?t*this.scale:null),t&&t*this.scale!=this.position.zoom||setTimeout(this.update,80)},navstart(t){if(t.button)return;let e=this.$refs.navigator;var i=t=>{t=c(t),this.move(t.offsetX/e.clientWidth,t.offsetY/e.clientHeight*this.slice.height/this.slice.width)},s=()=>{e.removeEventListener("mousemove",i),e.removeEventListener("touchmove",i),window.removeEventListener("mouseup",s)};e.addEventListener("mousemove",i),e.addEventListener("touchmove",i),window.addEventListener("mouseup",s),i(t)},handleFullScreen(){this.fullPage=!this.fullPage,this.$parent.$parent.fullPage=this.fullPage,this.resize()},buttonClick(t){switch(t){case"zoom-in":this.move(null,null,2*this.position.zoom);break;case"zoom-out":this.move(null,null,this.position.zoom/2);break;case"home":let e=this.slice.width/this.slice.height;this.move(.5,.5/e,Math.min(this.offsetHeight/this.offsetWidth*e,1));break;case"original":this.move(null,null,this.slice.width/this.offsetWidth);break;default:this.move(null,null,t)}},path2data:t=>({x:t.map(t=>t.point.x),y:t.map(t=>t.point.y)}),equal(t,e){if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(t[i].image!==e[i].image)return!1;return!0},roilistChange(t,e){let i={},s={};t.map(t=>{i[t.id]=t}),e.map(t=>{s[t.id]=t});let a=e.filter(t=>!o.a.equals(t,i[t.id])),n=t.filter(t=>!o.a.equals(t,s[t.id]));for(let t of a)this.dataMapPath[t.id]&&!this.curRois[t.id]&&(this.dataMapPath[t.id].text&&(this.dataMapPath[t.id].text.remove(),this.dataMapPath[t.id].rectangle.remove()),this.dataMapPath[t.id].path.remove(),delete this.dataMapPath[t.id]);let l=n.length,r=0,c=200;var h=this;l>0&&function t(){let e=r+c>n.length?n.length:r+c;if(!(r>l)){for(var i=r;i<e;i++)h.newRoi(n[i]);r+=c,t()}}(),this.setLayer(),this.roilist.forEach(t=>{this.showRoi?this.dataMapPath[t.id].path.selected=!!this.curRois[t.id]:this.dataMapPath[t.id].path.selected=!1,"spot"!=t.method&&this.curRois[t.id]&&this.drawArea(t)})},setLayer(){let t=Object.values(this.dataMapPath);var e={};let i=[...new Set(t.map(t=>t.data.mark_type))].map(t=>(e[t]=[],t));t.map(t=>{i.filter(e=>e==t.data.mark_type).length&&e[t.data.mark_type].push(t.path)}),this.layers[0].children=null,this.layers[1].children=e[3],this.layers[2].children=e[1],this.layers[3].children=e[2],this.layers[4].children=e[4],this.layers[5].children=e[5]},spliceArray(t){for(var e=void 0,i=0;i<t.x.length-1;i++){var s=t.x[i+1]-t.x[i],a=(t.y[i+1]-t.y[i])/s;(isNaN(e)&&isNaN(a)||a==e)&&(t.x.splice(i,1),t.y.splice(i,1),i--),e=a}return t},newRoi(t={editable:1,path:{x:[],y:[]}}){t=o.a.clone(t);let e,i={};if(this.paper.activate(),t.path.x.length>4&&(t.path=this.spliceArray(t.path)),e="spot"==t.method?new this.paper.Path.Circle({center:[4===t.path.x.length?t.path.x[1]:t.path.x[0],t.path.y[0]],radius:t.radius,strokeScaling:!1,fillColor:t.fillColor||"rgba(0,0,0,0.001)",strokeColor:t.strokeColor||null,owner:t,strokeWidth:3}):new this.paper.Path({segments:t.path.x.map((e,i)=>({x:e,y:t.path.y[i]})),strokeWidth:t.width||3,fillColor:t.fillColor||("secectMulty"==t.method?"rgba(255,255,255,0.5)":"rgba(0,0,0,0.001)"),strokeColor:t.strokeColor,strokeScaling:!1,owner:t,closed:!0,dashArray:t.dashed?[10,5]:[0,0]}),Object.assign(i,{path:e,dragCenter:!1,dragVertex:!1,dragEdge:!1,resetDragStatus(){this.dragCenter=this.dragVertex=this.dragEdge=!1}}),"freepen"==t.method||"freepenReverse"==t.method){var s=this;i.drag=function(t){this.dragVertex?(this.segment.point.x+=t.x,this.segment.point.y+=t.y,i.text&&(i.text.content=this.content?this.content:"面积:"+Math.round(Math.abs(i.path.area)*Math.pow(s.mpp,2))+"μm²")):this.dragCenter&&(this.path.position.x+=t.x,this.path.position.y+=t.y,i.text&&(i.text.position.x+=t.x,i.text.position.y+=t.y,i.rectangle.position.x+=t.x,i.rectangle.position.y+=t.y))},i.checkPath=function(t,e){if(this.segment=null,this.resetDragStatus(),"segment"==e.type){this.segment=e.segment;let t=e.item;"pickTool"===s.selectedTool&&t.smooth({type:"catmull-rom",factor:.5,from:this.segment.previous.index,to:this.segment.next.index}),this.dragVertex=!0,i.text&&(i.text.content=this.content?this.content:"面积:"+Math.round(Math.abs(i.path.area)*Math.pow(s.mpp,2))+"μm²")}else"fill"==e.type&&(this.dragCenter=!0)}}else if("rectangle"==t.method||"rectangleReverse"==t.method||"secectMulty"==t.method){s=this;i.drag=function(t){let e=(t,e)=>Math.abs(t-e)<1e-4;if(this.dragVertex){let a=this.segment.point.x,n=this.segment.point.y,o=a+t.x,l=n+t.y;this.path.segments.map(t=>{t.point.x=e(t.point.x,a)?o:t.point.x,t.point.y=e(t.point.y,n)?l:t.point.y});let r=this.path.segments[0].point.x<this.path.segments[2].point.x?this.path.segments[0].point.x:this.path.segments[2].point.x,c=this.path.segments[0].point.y<this.path.segments[2].point.y?this.path.segments[0].point.y:this.path.segments[2].point.y;i.text.content=this.content?this.content:"面积:"+Math.round(Math.abs(i.path.area)*Math.pow(s.mpp,2))+"μm²";let h=r!=Math.min.apply(null,i.data.path.x),u=c!=Math.min.apply(null,i.data.path.y);h&&!u&&(i.text.position.x+=t.x,i.rectangle.position.x+=t.x),!h&&u&&(i.text.position.y+=t.y,i.rectangle.position.y+=t.y),h&&u&&(i.text.position.y+=t.y,i.rectangle.position.y+=t.y,i.text.position.x+=t.x,i.rectangle.position.x+=t.x)}else if(this.dragEdge){if(e(this.editPt1.x,this.editPt2.x)&&(this.editPt1.x+=t.x,this.editPt2.x+=t.x,i.text)){i.text.content=this.content?this.content:"面积:"+Math.round(Math.abs(i.path.area)*Math.pow(s.mpp,2))+"μm²";let e=i.path.segments[0].point.x>i.path.segments[2].point.x?i.path.segments[0].point.x:i.path.segments[2].point.x;this.editPt1.x<e&&(i.text.position.x+=t.x,i.rectangle.position.x+=t.x)}if(e(this.editPt1.y,this.editPt2.y)&&(this.editPt1.y+=t.y,this.editPt2.y+=t.y,i.text)){i.text.content=this.content?this.content:"面积:"+Math.round(Math.abs(i.path.area)*Math.pow(s.mpp,2))+"μm²";let e=i.path.segments[0].point.y>i.path.segments[2].point.y?i.path.segments[0].point.y:i.path.segments[2].point.y;this.editPt1.y<e&&(i.text.position.y+=t.y,i.rectangle.position.y+=t.y)}}else this.dragCenter&&(this.path.segments.map(e=>{e.point.x+=t.x,e.point.y+=t.y}),i.text&&(i.text.position.x+=t.x,i.text.position.y+=t.y,i.rectangle.position.x+=t.x,i.rectangle.position.y+=t.y))},i.checkPath=function(t,e){if(this.segment=this.editPt1=this.editPt2=null,this.resetDragStatus(),"segment"==e.type)this.segment=e.segment,this.dragVertex=!0;else if("stroke"==e.type){let t=e.location;this.editPt1=t.curve.point1,this.editPt2=t.curve.point2,this.dragEdge=!0}else"fill"==e.type&&(this.dragCenter=!0)}}else"spot"==t.method&&(i.drag=function(t){this.path.position.x+=t.x,this.path.position.y+=t.y},i.checkPath=function(t,e){this.segment=null,this.resetDragStatus(),"segment"==e.type?(this.segment=e.segment,this.dragVertex=!0):"fill"==e.type&&(this.dragCenter=!0)});return i.data=t,i.path.visible=this.showRoi,i.path.selected=this.showRoi,this.dataMapPath[t.id]=i,i},drawArea(t){this.paper.activate();let e=this.dataMapPath[t.id];e&&e.text&&(e.text.remove(),e.rectangle.remove());let i=Math.min.apply(null,t.path.x.map(t=>t)),s=Math.min.apply(null,t.path.y.map(t=>t));"freepen"!=t.method&&"freepenReverse"!=t.method||(s=Math.min.apply(null,t.path.y.map(t=>t)),i=t.path.x[t.path.y.findIndex(e=>e==Math.min.apply(null,t.path.y.map(t=>t)))]);let a=this.viewport.viewportToImageZoom(this.position.zoom);var n={x:i,y:s-30/a},o={x:i,y:s};e.text=new this.paper.PointText({point:o,content:this.content?this.content:"面积:"+Math.round(Math.abs(e.path.area)*Math.pow(this.mpp,2))+"μm²",fillColor:"white",justification:"center",fontSize:14/a});var l=e.text.bounds.width,r=e.text.bounds.height;e.text.bounds.top-=28/a-r,e.text.bounds.left+=l/2+4/a,e.rectangle=new this.paper.Path.Rectangle(n,l+8/a,24/a,4/a),e.rectangle.fillColor="rgba(0,0,0,0.5)",this.paper.project.activeLayer.addChild(e.text),"freepen"!=t.method&&"freepenReverse"!=t.method||(e.text.bounds.left-=l+12/a,e.rectangle.bounds.left-=e.rectangle.bounds.width+4/a),this.showRoi||(e.text.visible=!1,e.rectangle.visible=!1)},contextmenu(t){let e=this.convertPoint(t.offsetX,t.offsetY),i=this.paper.project.hitTest(e,{stroke:!0,segments:!0,fill:!0}),s=i.item.owner.path,a=Math.max.apply(null,s.x.map(t=>t)),n=Math.max.apply(null,s.y.map(t=>t));"freepen"!=i.item.owner.method&&"freepenReverse"!=i.item.owner.method||(a=Math.max.apply(null,s.x.map(t=>t)),n=s.y[s.x.findIndex(t=>t==Math.max.apply(null,s.x.map(t=>t)))]);let o=this.paper.view.projectToView(new this.paper.Point(a,n));i&&(this.$emit("contextmenu",t,i.item.owner,o),this.selectedTool="choose")},keydown(t){let e=t.key;if("INPUT"!=t.target.nodeName)switch(e){case"ArrowUp":t.ctrlKey||t.metaKey||this.move(null,this.position.offy-.95*this.viewport.getBounds().height);break;case"ArrowDown":t.ctrlKey||t.metaKey||this.move(null,this.position.offy+.95*this.viewport.getBounds().height);break;case"ArrowLeft":t.ctrlKey||t.metaKey||this.move(this.position.offx-.95*this.viewport.getBounds().width);break;case"ArrowRight":t.ctrlKey||t.metaKey||this.move(this.position.offx+.95*this.viewport.getBounds().width);break;case"Escape":this.fullPage&&this.handleFullScreen();break;case"F":case"f":this.selectedTool="freepen",this.pentool="freepen";break;case"R":case"r":this.selectedTool="rectangle",this.pentool="rectangle";break;case"P":case"p":this.selectedTool="dottingTool",this.pentool="dottingTool";break;case" ":this.selectedTool="choose";break;case"=":this.buttonClick("zoom-in");break;case"-":this.buttonClick("zoom-out");break;case"1":this.buttonClick("home");break;case"2":this.buttonClick(2*this.scale);break;case"3":this.buttonClick(4*this.scale);break;case"4":this.buttonClick(10*this.scale);break;case"5":this.buttonClick(20*this.scale);break;case"6":this.buttonClick(40*this.scale);break;case"7":this.buttonClick("original");break;case"8":this.handleFullScreen();break;case"Escape":this.fullPage&&this.handleFullScreen();break;case"A":case"a":if(t.ctrlKey||t.metaKey){t.preventDefault();let e=this.convertPoint(0,0),i=this.convertPoint(this.offsetWidth,this.offsetHeight),s=this.roilist.filter(t=>t.path.x.every(t=>t>e.x&&t<i.x)&&t.path.y.every(t=>t>e.y&&t<i.y));s.length&&this.$emit("curROI",s,!1)}}},wheel(t){if("dottingTool"==this.selectedTool)return;let e=t.wheelDeltaY>0?1.2:1/1.2;var i=this.viewport.pointFromPixel(new OpenSeadragon.Point(t.offsetX,t.offsetY)),s=this.position;this.move((s.offx-i.x)/e+i.x,(s.offy-i.y)/e+i.y,s.zoom*e)},getDistance(t,e){var i=Math.abs(e.pageX-t.pageX),s=Math.abs(e.pageY-t.pageY);return Math.sqrt(i*i+s*s)},isInPolygon(t,e){var i,s,a,n,o=0,l=e.length;for(a=e[0],i=1;i<=l;i++)n=e[i%l],t[0]>Math.min(a[0],n[0])&&t[0]<=Math.max(a[0],n[0])&&t[1]<=Math.max(a[1],n[1])&&a[0]!=n[0]&&(s=(t[0]-a[0])*(n[1]-a[1])/(n[0]-a[0])+a[1],(a[1]==n[1]||t[1]<=s)&&o++),a=n;return o%2!=0},mouseDown(t){this.$refs.osd.querySelector(".openseadragon-canvas").focus(),t.preventDefault(),this.$emit("mousedown");let e=c(t);var i,s,a=t=>{var a=c(t,this.$refs.osd);if(new paper.Point(d.x-a.x,d.y-a.y).length>5&&(p=!0),m)if(t.touches&&2==t.touches.length){let e=this.viewport.deltaPointsFromPixels(new paper.Point((u.touches[0].clientX+u.touches[1].clientX-t.touches[0].clientX-t.touches[1].clientX)/2,(u.touches[0].clientY+u.touches[1].clientY-t.touches[0].clientY-t.touches[1].clientY)/2)),i=Math.hypot(u.touches[0].clientX-u.touches[1].clientX,u.touches[0].clientY-u.touches[1].clientY),s=Math.hypot(t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY);this.move(this.position.offx+e.x,this.position.offy+e.y,this.position.zoom*s/i)}else{let t=this.viewport.deltaPointsFromPixels(new paper.Point(r.x-a.x,r.y-a.y));this.move(this.position.offx+t.x,this.position.offy+t.y)}else{let t=this.convertPoint(a.x-e.x+e.offsetX,a.y-e.y+e.offsetY);switch(this.selectedTool){case"choose":for(let t in this.curRois){if((n=this.dataMapPath[t]).dragCenter||this.curRoi.owner.id==t)if(0!=this.curRois[t].editable){let t=this.convertPoint(0,0),e=this.convertPoint(a.x-r.x,a.y-r.y);e.x-=t.x,e.y-=t.y,n.drag(e)}else m=!0}break;case"pickTool":for(let t in this.curRois){var n=this.dataMapPath[t];if(this.curRoi&&this.curRoi.owner.id==t){if(this.curRoi.segments.filter(t=>t.point.selected).length<3)return;if(0!=this.curRois[t].editable){let t=this.convertPoint(0,0),e=this.convertPoint(a.x-r.x,a.y-r.y);e.x-=t.x,e.y-=t.y,n.drag(e)}}}break;case"freepen":case"freepenReverse":case"secectMulty":this.curRoi.path.closed=!1,this.curRoi.path.fullySelected=!1,this.curRoi.path.add(t);break;case"rectangle":case"rectangleReverse":{let e=this.curRoi.path.segments[0].point;this.curRoi.path.removeSegments(),this.curRoi.path.addSegments([e,new this.paper.Point(t.x,e.y),t,new this.paper.Point(e.x,t.y)]);break}case"measure":{s&&s.remove(),i&&i.remove(),this.paper.activate(),(s=new this.paper.Path([v,t])).strokeWidth=2,s.strokeScaling=!1,s.strokeColor="#e4141b";let e=new this.paper.Point({x:t.x-v.x,y:t.y-v.y}),a=e.normalize(10/this.paper.view.zoom).rotate(Math.abs(e.angle)>90?90:-90);(i=new this.paper.PointText({point:{x:(t.x+v.x)/2+a.x,y:(v.y+t.y)/2+a.y},content:Math.round(100*e.length*this.mpp)/100+"μm",justification:"center",fontSize:14/this.paper.view.zoom})).rotate(Math.abs(e.angle)>90?180+e.angle:e.angle)}}this.paper.view.draw()}r={x:a.x,y:a.y},u=t},n=!1,o=t=>{if(t.cancelBubble=!0,t.preventDefault(),n=!0,window.removeEventListener("mousemove",a),window.removeEventListener("touchmove",a),window.removeEventListener("mouseup",o),window.removeEventListener("touchend",o),this.$refs.osd.removeEventListener("touchstart",f),t=t.changedTouches?h(t.changedTouches[0],this.$refs.osd):t,p){if(m)return;switch(this.selectedTool){case"freepen":case"rectangle":case"freepenReverse":case"rectangleReverse":this.drawRoi(this.curRoi,t.shiftKey,"removePath");break;case"secectMulty":{let t=this.curRoi.data;t.path=this.path2data(this.curRoi.path.segments);let e=t.path.x.map((e,i)=>[e,t.path.y[i]]),i=this.roilist.filter(t=>t.path.x.some((i,s)=>this.isInPolygon([i,t.path.y[s]],e)));if(this.curRoi.path.remove(),this.curRoi=null,i.length){this.scope={x:t.path.x,y:t.path.y};let e=this.slice.toolType;switch(this.slice.toolType){case"pdl1db":e="human";break;case"fish":e="fishTissue"}Object(l.b)(`slice/selectCount?companyid=${Object(l.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,scope:JSON.stringify(this.scope),template_id:"tagging"==this.slice.toolType?this.slice.templateId:null,ai_type:e}).then(({data:t})=>{this.$message({showClose:!0,message:`已选中${t.select_count}个（可能包含隐藏标注）`,type:"warning",duration:3e3}),this.$emit("curROI",i,!1)}).catch(t=>{this.$alert(t.message,"提示",{confirmTextButtom:"确定"})})}else this.scope=null,this.$emit("curROI",null,!1);this.selectedTool="choose";break}case"choose":{let t=Object.assign({},Object.values(this.curRois)[0]),e=this.path2data(this.dataMapPath[t.id].path.segments),i=("spot"===t.method&&e.x.length>1?e.x[1]:e.x[0])-t.path.x[0],s=e.y[0]-t.path.y[0];this.scope&&(this.scope.offset=[i,s]),Object.values(this.curRois).map(t=>{t.path=this.path2data(this.dataMapPath[t.id].path.segments)}),this.$emit("curROI",Object.values(this.curRois),!1),this.$emit("roiChanged","path"),this.curRoi=null;break}case"pickTool":this.curRoi&&(this.dataMapPath[this.curRoi.owner.id].path.flatten(0),this.segmentsList=[],Object.values(this.curRois).map(t=>{t.path=this.path2data(this.dataMapPath[t.id].path.segments)}),this.$emit("curROI",Object.values(this.curRois),!1),this.$emit("roiChanged","path"),this.curRoi=null);break;case"measure":s.remove(),i.remove(),this.selectedTool="choose"}}else{let i=this.convertPoint(t.offsetX,t.offsetY);if("choose"==this.selectedTool){let e=this.slice.mppx?2:5,s=this.paper.project.hitTest(i,{fill:!0,stroke:!0,segments:!0,tolerance:e});if(s){if(!s.item.owner)return;this.scope=null,"grey"==s.item.owner.strokeColor&&"ki67hot"==this.slice.toolType||this.$emit("curROI",s.item.owner,t.shiftKey),(t={offsetX:t.offsetX,offsetY:t.offsetY,type:t.type}).preventDefault||(t.preventDefault=(t=>0)),t.currentTarget=this.$refs.osd,this.$emit("contextmenu",t,s.item.owner)}else this.scope=null,this.$emit("curROI",null,t.shiftKey,0),this.curROI=null}else if("freepen"==this.selectedTool||"rectangle"==this.selectedTool||"freepenReverse"==this.selectedTool||"rectangleReverse"==this.selectedTool||"secectMulty"==this.selectedTool)delete this.dataMapPath[this.curRoi.id],this.curRoi.path.remove(),this.curRoi=null;else if("point"==this.selectedTool)this.$emit("clickDraw",i);else if("dottingTool"==this.selectedTool)if(this.polygonRoi){let s=this.paper.project.hitTest(i,{stroke:!0,segments:!0,fill:!0,tolerance:this.slice.mppx?2:5});if(s&&"segment"===s.type&&!s.item.closed)return this.polygonRoi.path.closed=!0,this.polygonRoi.path.selected=!0,void this.drawRoi(this.polygonRoi);let a=this.convertPoint(t.x-e.x+e.offsetX,t.y-e.y+e.offsetY);this.polygonRoi.path.closed=!1,this.polygonRoi.path.selected=!0,this.polygonRoi.path.add(a)}else this.polygonRoi=this.newRoi({path:{x:[i.x],y:[i.y]},method:"freepen",strokeColor:"yellow"})}};if(e.button)return;let r={x:e.x,y:e.y},u=t,d=r,p=!1,v=this.convertPoint(e.offsetX,e.offsetY),m=!1;switch(this.selectedTool){case"choose":{let e=this.paper.project.hitTest(v,{fill:!0,stroke:!0,segments:!0,tolerance:this.slice.mppx?2:5}),i=Object.values(this.curRois).map(t=>this.dataMapPath[t.id]);i.some(t=>t.path==(e&&e.item))?(this.curRoi=e.item,i.map(t=>{t.checkPath(null,e)})):t.touches&&("stylus"==t.touches[0].touchType||t.touches[0].force<1)?(this.selectedTool="freepen",this.curRoi=this.newRoi({path:{x:[v.x],y:[v.y]},method:"freepen",strokeColor:this.penColor})):m=!0;break}case"pickTool":{let t=this.paper.project.hitTest(v,{fill:!0,stroke:!0,segments:!0,tolerance:this.slice.mppx?2:5});if(!t.item.owner)return;if(t&&this.curRois[t.item.owner.id]&&"segment"===t.type&&"freepen"===t.item.owner.method&&0!=t.item.owner.editable){let e=t.segment,i=t.item,s=i.segments.filter(t=>t.point.selected).length;if(!this.segmentsList.length&&s<3)e.point.selected=!0,this.segmentsList.push(e);else if(1===this.segmentsList.length&&this.segmentsList[0].index!==e.index){e.point.selected=!0,this.segmentsList.push(e);let t=i.lastSegment.index,s=Math.min(this.segmentsList[0].index,this.segmentsList[1].index),a=Math.max(this.segmentsList[0].index,this.segmentsList[1].index),n=Math.abs(s-a),o=t-n+1,l=new paper.Point((this.segmentsList[0].point.x+this.segmentsList[1].point.x)/2,(this.segmentsList[0].point.y+this.segmentsList[1].point.y)/2);if(o>n){let t=i.segments.slice(s+1,a);for(var g=0;g<t.length;g++)i.removeSegment(t[g].index);i.insert(s+1,l),i.segments[s+1].point.selected=!0}else{let e=i.segments.slice(0,s),n=i.segments.slice(a+1,t+1),o=e.concat(n);for(let t=0;t<o.length;t++)i.removeSegment(o[t].index);i.insert(i.segments.length,l),i.segments[i.segments.length-1].point.selected=!0}this.segmentsList=[];let r=this.paper.project.hitTest(l,{fill:!0,stroke:!0,segments:!0});this.curRoi=r.item,this.dataMapPath[r.item.owner.id].checkPath(null,r)}}break}case"freepen":case"rectangle":case"secectMulty":this.curRoi=this.newRoi({path:{x:[v.x],y:[v.y]},method:this.selectedTool,strokeColor:this.drawMpp?"yellow":"secectMulty"==this.selectedTool?"#E3E9EF":this.penColor});break;case"freepenReverse":case"rectangleReverse":this.curRoi=this.newRoi({path:{x:[v.x],y:[v.y]},method:this.selectedTool,strokeColor:"#E3E9EF",dashed:!0});break;case"point":let e=this.paper.project.hitTest(v,{fill:!0,stroke:!0,segments:!0});this.$emit("parentId",e?e.item.owner.id:null)}window.addEventListener("touchmove",a),window.addEventListener("mousemove",a),window.addEventListener("mouseup",o),window.addEventListener("touchend",o);var f=t=>{n||o(t)};this.$refs.osd.addEventListener("touchstart",f)},dblclick(t){this.$refs.osd.querySelector(".openseadragon-canvas").focus();let e=this.convertPoint(t.offsetX,t.offsetY),i=this.paper.project.hitTest(e,{fill:!0,stroke:!0,segments:!0});i&&"grey"===i.item.owner.strokeColor&&"ki67hot"===this.slice.toolType&&this.$emit("curROI",i.item.owner)},drawRoi(t,e,i){let s=t.data;s.path=this.path2data(t.path.segments),delete this.dataMapPath[t.id],this.drawMpp?(this.userMpp=Math.sqrt((this.cellArea||200)/t.path.area).toFixed(4),"NaN"===this.userMpp||"Infinity"===this.userMpp?(this.$alert("您画的roi太小,请选择矩形工具重新画一个"),t.path.remove(),t=null):(this.mpp=this.userMpp,this.drawMpp=!1,this.knew=!0)):(i&&t.path.remove(),t=null,this.$emit("draw",s,e),this.scope=null),this.selectedTool="choose"},mousemoveNew(t){let e=this.convertPoint(t.offsetX,t.offsetY);s&&s.remove(),"pickTool"!==this.selectedTool&&"choose"!==this.selectedTool||(s=new this.paper.Path.Circle({center:[e.x,e.y],radius:this.slice.mppx?Math.floor(1/this.slice.mppx):5,fillColor:"#f00"}),this.layers[0].children=[s])}},created(){this.curRoi=null,this.polygonRoi=null},mounted(){this.initOSD(),this.$refs.osd.addEventListener("touchstart",this.mouseDown)},beforeDestroy(){window.removeEventListener("resize",this.resize),setTimeout(()=>{this.paper.view.remove(),this.osd.destroy()},800)},watch:{radius(t){this.newRadius=t},position:{handler(t){this.update(t)},deep:!0},selectedTool:{handler(t){switch(t){case"choose":case"pickTool":this.$refs.osd.querySelector(".openseadragon-canvas").style.cursor="pointer";break;case"freepen":case"rectangle":case"measure":case"point":case"freepenReverse":case"rectangleReverse":case"secectMulty":case"dottingTool":this.$refs.osd.querySelector(".openseadragon-canvas").style.cursor="crosshair"}},deep:!0},"position.zoom":function(){setTimeout(t=>{for(let t in this.curRois)"spot"!=this.curRois[t].method&&this.drawArea(this.curRois[t])},90)},showRoi(t){t?this.$emit("changeShowLayer",!0):this.$emit("changeShowLayer",!1);for(let e in this.dataMapPath)this.dataMapPath[e].path.visible=!!t,this.dataMapPath[e].path.selected=this.curRois[e]&&t,this.dataMapPath[e].text&&(this.dataMapPath[e].text.visible=!!t,this.dataMapPath[e].rectangle.visible=!!t)},roilist(t,e){this.roilistChange(t,e),this.polygonRoi=null},centerRegion([t,e,i,s]){let a,n=1.5*(i-t),o=1.5*(s-e),l=this.slice.width,r=(t+i)/2,c=(e+s)/2;a=n/o>this.offsetWidth/this.offsetHeight?l/n:l/o*this.offsetHeight/this.offsetWidth,this.slice.toolType&&(this.slice.toolType.includes("tct")||this.slice.toolType.includes("lct")||"dna"===this.slice.toolType)||"bm"===this.slice.toolType?this.move(r/l,c/l,Math.max(40*this.scale,this.position.zoom)):this.move(r/l,c/l,Math.min(a,this.position.zoom))},curRois(t,e){this.roilist.forEach(e=>{this.showRoi?(this.dataMapPath[e.id].path.selected=!!t[e.id],!t[e.id]||0==t[e.id].editable||3==t[e.id].mark_type&&"grey"==t[e.id].strokeColor||this.paper.project.activeLayer.addChild(this.dataMapPath[e.id].path)):this.dataMapPath[e.id].path.selected=!1,this.dataMapPath[e.id].path.visible=!!this.showRoi});for(let t in this.dataMapPath)this.dataMapPath[t].text&&(this.dataMapPath[t].text.remove(),this.dataMapPath[t].rectangle.remove());for(let e in t)t[e]&&"spot"!=t[e].method&&this.roilist.length&&this.drawArea(t[e]);Object.keys(t).toString()!=Object.keys(e).toString()&&(this.segmentsList=[])}},components:{"v-attactments":a.a}};function c(t,e=t.currentTarget){return t.touches?h(t.touches[0],e):t}function h(t,e){for(var i={x:0,y:0};e.offsetParent;)i.x+=e.offsetLeft,i.y+=e.offsetTop,e=e.offsetParent;return{offsetX:t.clientX-i.x,offsetY:t.clientY-i.y,x:t.clientX,y:t.clientY,shiftKey:t.shiftKey}}var u={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"osd",class:{"fixed-fullpage":t.fullPage},on:{keydown:t.keydown}},[t._t("default"),t._v(" "),s("div",{ref:"osd",staticClass:"osd",on:{mousedown:t.mouseDown,mousewheel:t.wheel,dblclick:t.dblclick}}),t._v(" "),s("div",{staticClass:"btm_left"},[s("div",{staticClass:"zoom-in",attrs:{title:t.$t("analyze.zoomin")},on:{click:function(e){return t.buttonClick("zoom-in")}}}),t._v(" "),s("p",{staticClass:"showzoom",attrs:{title:t.position.zoom/t.scale+"X"}},[t._v(t._s((t.position.zoom/t.scale).toFixed(1))+"X")]),t._v(" "),s("div",{staticClass:"zoom-out",attrs:{title:t.$t("analyze.zoomout")},on:{click:function(e){return t.buttonClick("zoom-out")}}}),t._v(" "),s("div",{ref:"home",staticClass:"home",attrs:{title:t.$t("analyze.home")},on:{click:function(e){return t.buttonClick("home")}}}),t._v(" "),s("div",{attrs:{title:t.$t("analyze.2x")},on:{click:function(e){return t.buttonClick(2*t.scale)}}},[t._v("2X")]),t._v(" "),s("div",{attrs:{title:t.$t("analyze.4x")},on:{click:function(e){return t.buttonClick(4*t.scale)}}},[t._v("4X")]),t._v(" "),s("div",{attrs:{title:t.$t("analyze.10x")},on:{click:function(e){return t.buttonClick(10*t.scale)}}},[t._v("10X")]),t._v(" "),s("div",{attrs:{title:t.$t("analyze.20x")},on:{click:function(e){return t.buttonClick(20*t.scale)}}},[t._v("20X")]),t._v(" "),s("div",{attrs:{title:t.$t("analyze.40x")},on:{click:function(e){return t.buttonClick(40*t.scale)}}},[t._v("40X")]),t._v(" "),s("div",{attrs:{title:t.$t("analyze.original")},on:{click:function(e){return t.buttonClick("original")}}},[t._v("1:1")]),t._v(" "),s("div",{staticClass:"full-page",class:{"exit-full-page":t.fullPage},attrs:{title:t.fullPage?t.$t("analyze.exitfullpage"):t.$t("analyze.fullpage")},on:{click:function(e){return t.handleFullScreen()}}})]),t._v(" "),s("div",{staticClass:"btm",attrs:{tabindex:"0"},on:{click:function(e){t.showPenTool=!1},keydown:t.keydown}},[s("div",{staticClass:"show-roi",class:{bigContent:!t.showRoi},attrs:{title:t.$t("analyze.showRoi")},on:{click:function(e){t.showRoi=!t.showRoi}}}),t._v(" "),"tagging"==t.slice.toolType?s("div",{staticClass:"show-radius",class:{bigContent:t.showRadius},attrs:{title:"设置半径"},on:{click:function(e){t.showRadius=!t.showRadius}}}):t._e(),t._v(" "),t.showRadius?s("div",{staticClass:"radius",on:{click:function(t){t.stopPropagation()}}},[t._v("\n            标注点半径:\n            "),s("el-input",{ref:"radius",staticClass:"small-input",on:{blur:function(e){t.$emit("setRadius",e)}},nativeOn:{keyup:function(e){return t.toNumber(e)}},model:{value:t.newRadius,callback:function(e){t.newRadius=e},expression:"newRadius"}})],1):t._e(),t._v(" "),"tagging"==t.slice.toolType?s("div",{staticClass:"fill",class:{bigContent:!t.filled},attrs:{title:t.filled?"设为空心":"设为实心"},on:{click:function(e){return t.$emit("showBg")}}}):t._e(),t._v(" "),s("div",{staticClass:"secect-multy",class:{bigContent:"secectMulty"==t.selectedTool},attrs:{title:"多选"},on:{click:function(e){t.selectedTool="secectMulty"}}}),t._v(" "),s("div",{class:["freepen"==t.selectedTool||"rectangle"==t.selectedTool||"point"==t.selectedTool||"freepenReverse"==t.selectedTool||"dottingTool"==t.selectedTool||"rectangleReverse"==t.selectedTool?"bigContent":"",t.pentool],on:{click:function(e){return e.stopPropagation(),t.chooseTool(e)}}},[s("span",{staticClass:"triangle",on:{click:function(e){e.stopPropagation(),t.showPenTool=!t.showPenTool}}})]),t._v(" "),s("div",{staticClass:"drag",class:{bigContent:"choose"==t.selectedTool},attrs:{title:t.$t("analyze.choose")},on:{click:function(e){t.selectedTool="choose"}}}),t._v(" "),s("div",{staticClass:"measure-tool",class:{bigContent:"measure"==t.selectedTool},attrs:{title:t.$t("analyze.measure")},on:{click:function(e){t.selectedTool="measure"}}}),t._v(" "),s("div",{staticClass:"pick-tool",class:{bigContent:"pickTool"==t.selectedTool},attrs:{title:"轮廓调整"},on:{click:t.adjustSegment}}),t._v(" "),s("v-attactments",{attrs:{record:t.record}})],1),t._v(" "),s("ul",{directives:[{name:"show",rawName:"v-show",value:t.showPenTool,expression:"showPenTool"}],staticClass:"pens"},[s("li",{class:{"li-bg":"freepen"==t.selectedTool},on:{click:function(e){return t.checkTool("freepen")}}},[s("img",{staticStyle:{left:"12px"},attrs:{src:i("aRHw"),width:"40"}}),t._v("自由ROI")]),t._v(" "),s("li",{class:{"li-bg":"rectangle"==t.selectedTool},on:{click:function(e){return t.checkTool("rectangle")}}},[s("img",{attrs:{src:i("jdSn"),width:"23"}}),t._v("矩形ROI")]),t._v(" "),s("li",{class:{"li-bg":"dottingTool"==t.selectedTool},on:{click:function(e){return t.checkTool("dottingTool")}}},[s("img",{attrs:{src:i("Qar8"),width:"23"}}),t._v("多边形ROI")]),t._v(" "),s("li",{class:{"li-bg":"point"==t.selectedTool,"disable-tool":!t.pointAble},on:{click:function(e){return t.checkTool("point")}}},[t.pointAble?s("span",[s("img",{attrs:{src:i("NmLI"),width:"25"}}),t._v("\n                打点\n            ")]):s("span",{staticClass:"grey"},[s("img",{attrs:{src:i("Tcqk"),width:"25"}}),t._v("\n                打点\n            ")])]),t._v(" "),s("li",{class:{"li-bg":"freepenReverse"==t.selectedTool,"disable-tool":!t.reverseAble},on:{click:function(e){return t.checkTool("freepenReverse")}}},[t.reverseAble?s("span",[s("img",{attrs:{src:i("4jrt"),width:"25"}}),t._v("\n                自由排除区域\n            ")]):s("span",{staticClass:"grey"},[s("img",{attrs:{src:i("FcKU"),width:"21"}}),t._v("\n                自由排除区域\n            ")])]),t._v(" "),s("li",{class:{"li-bg":"rectangleReverse"==t.selectedTool,"disable-tool":!t.reverseAble},on:{click:function(e){return t.checkTool("rectangleReverse")}}},[t.reverseAble?s("span",[s("img",{attrs:{src:i("iEaZ"),width:"25"}}),t._v("\n                矩形排除区域\n            ")]):s("span",{staticClass:"grey"},[s("img",{attrs:{src:i("vhYd"),width:"21"}}),t._v("\n                矩形排除区域\n            ")])])]),t._v(" "),s("div",{ref:"hideToolbar",staticStyle:{display:"none"}}),t._v(" "),s("canvas",{ref:"canvas",staticClass:"canvas"}),t._v(" "),t.saved?s("div",{staticClass:"saved"},[t._v("保存成功")]):t._e(),t._v(" "),t.showLabel?s("img",{ref:"rotate",staticClass:"label",attrs:{title:"点击旋转",src:"/aipath/api/files/getLabel?caseid="+t.record.id+"&fileid="+t.slice.id+"&companyid="+t.company},on:{click:t.rotate,error:function(e){t.showLabel=!1}}}):t._e(),t._v(" "),t.showMppGuide?s("div",{staticClass:"mpp-box"},[s("h2",[t._v("请框选出一个中等大小细胞核。如示例图:")]),t._v(" "),s("img",{attrs:{src:i("T4+n"),alt:"图例"}}),t._v(" "),s("span",{on:{click:function(e){return t.drawCell()}}},[t._v("我知道了")]),t._v(" "),s("div",{staticClass:"closeBtn",on:{click:function(e){return t.$emit("closeMppGuide",!0)}}},[s("img",{attrs:{src:i("YPLu"),alt:"关闭",width:"19"}})])]):t._e(),t._v(" "),t.knew?s("div",{staticClass:"knew"},[s("h2",[t._v("确认开始处理？")]),t._v(" "),s("div",{staticClass:"confirm-buttons"},[s("span",{staticClass:"finishdraw",on:{click:function(e){t.$emit("changeMpp",t.userMpp),t.curRoi.path.remove(),t.curRoi=null,t.knew=!1}}},[t._v("\n            确认")]),t._v(" "),s("span",{on:{click:function(e){t.$emit("changeMpp",!1),t.curRoi.path.remove(),t.curRoi=null,t.knew=!1}}},[t._v("\n            取消")])])]):t._e()],2)},staticRenderFns:[]};var d=i("VU/8")(r,u,!1,function(t){i("c2Ms"),i("90z+")},"data-v-7987d474",null);e.a=d.exports},T0JB:function(t,e){},"T4+n":function(t,e,i){t.exports=i.p+"static/img/图例.cf250fc.jpg"},TQNe:function(t,e){},TcE1:function(t,e){},Tcqk:function(t,e,i){t.exports=i.p+"static/img/打点-d.7dec91a.svg"},UIaW:function(t,e){},UaiW:function(t,e){},"VS+2":function(t,e){},ViJe:function(t,e){},WK65:function(t,e,i){"use strict";(function(t){var s=i("JCuE"),a=i("Y+x6"),n=i("aRG1"),o=i("PAWB"),l=i("k5KV"),r=i.n(l),c=i("SQcn"),h=i("B2xp"),u=i("jyVo"),d=i("mtWM"),p=i.n(d),v=i("mw3O"),m=i.n(v);let g,f,_,y;if(window.reportTypeMode="single",window.electron){let t=window.electron.remote.require;g=t("fs"),_=t("stream"),y=t("path").dirname(window.electron.remote.app.getPath("exe")),f=JSON.parse(g.readFileSync("config.json").toString()),window.reportTypeMode=f.reportTypeMode||"single"}e.a={data(){return{showImport:!1,contextLeft:0,showContext:!1,curContextCase:null,loaaded:!1,loading:!1,records:[],tableData:[],tableLength:0,currentRecord:null,windows:[],currentWindow:null,showReports:!1,showSign:!1,showBatch:this.showBatch||!1,currentPage:localStorage.getItem("searchParams")?JSON.parse(localStorage.getItem("searchParams")).currentPage:1,pagesize:localStorage.getItem("searchParams")?JSON.parse(localStorage.getItem("searchParams")).pagesize:20,searchVal:"",filters:localStorage.getItem("searchParams")?JSON.parse(localStorage.getItem("searchParams")).filters:{},samplePartList:[],sampleTypeList:[],folders:[],operators:[],batch:!1,showLeft:!1,showRight:!1,config:f,showSetting:!1,tableChecked:[],disableTab:["样本号","状态","文件名","AI模块","AI建议","最后更新"],tableOptions:["样本号","姓名","性别","年龄","取样部位","样本类型","切片数量","状态","切片文件夹","切片标签","切片编号","文件名","AI模块","AI建议","复核结果","创建时间","最后更新","操作人","报告"],showAgeRange:!1,filterType:"sampleNum",ageStart:"",ageEnd:"",offLeft:0,showTimeRange:!1,dateTime:[],showCreateRange:!1,createTime:[],editCase:"",editId:"",visiable:!1,editType:"",ws:null,lockReconnect:!1,timeout:3e3,timeoutObj:null,timeoutnum:null,batchMsg:null,queueMsg:0,checkAll:"true"===localStorage.getItem("checkAll")||!1,recordChecked:[],checkedFilenames:[],folderList:[],showMultyAI:!1,curAI:"",isStart:!1,excelname:"",clickTimer:null,demoModeValue:"1"===localStorage.getItem("demoMode")||!1,exportSlideWithDB:!1,showSetPsw:!1,exportPop:!1,cancleExport:!0,folder:y,ip:Object(u.j)(),exportKey:"",recordsToChild:{},detailTimes:0,netSocket:null,netReconnect:null,netReconnectState:!1,stagePos:{},modelUpdate:!1}},filters:{fmt:u.i},async mounted(){const t=this.$route.query.sampleId;t&&this.getSearchedList(t),this.getChecks(),document.title=this.$t("title.title"),window.addEventListener("click",this.closeSetting),window.addEventListener("click",this.closeEdit),this.getRecords(),this.getFilters(),this.createWebSocket()},beforeDestroy(){window.removeEventListener("click",this.closeSetting),window.removeEventListener("click",this.closeEdit),this.$refs.table.bodyWrapper.removeEventListener("scroll",this.closeNameInut)},computed:{options(){return[{label:"样本号",value:"sampleNum"},{label:"姓名",value:"name"},{label:"切片文件夹",value:"userFilePath"},{label:"切片编号",value:"slice_number"},{label:"文件名",value:"filename"}].filter(t=>this.tableChecked.includes(t.label))},userInfo:()=>Object(u.o)(),gender:()=>"en"==window.i18n.locale?{"男":"M","女":"F","其他":"O"}:{"男":"男","女":"女","其他":"其他"},multyAI:()=>[{label:"TCT1.0",value:"tct1"},{label:"TCT2.0",value:"tct2"},{label:"LCT1.0",value:"lct1"},{label:"LCT2.0",value:"lct2"},{label:"PD-L1",value:"pdl1"},{label:"Ki-67",value:"ki67"},{label:"Ki-67 热区",value:"ki67hot"},{label:"ER",value:"er"},{label:"PR",value:"pr"},{label:"FISH",value:"fish"},{label:"HER-2",value:"her2"},{label:"鼻息肉",value:"np"},{label:"TBS+DNA",value:"dna"},{label:"骨髓血细胞",value:"bm"}]},watch:{tableChecked(){this.$nextTick(()=>{this.$refs.table.doLayout(),this.$refs.table.bodyWrapper.removeEventListener("scroll",this.closeNameInut),this.$refs.table.bodyWrapper.addEventListener("scroll",this.closeNameInut)})}},methods:{reconnectSocket(){this.netReconnectState||(this.netReconnectState=!0,this.netReconnect&&clearTimeout(this.netReconnect),this.netReconnect=setTimeout(()=>{this.netSocket.destroy(),this.netSocket=null,this.createSocket(),this.netReconnectState=!1},4e3))},createSocket(){let t=(0,window.electron.remote.require)("net");this.netSocket=new t.Socket,this.netSocket.connect(58207,"localhost",()=>{console.log("CONNECTED succcess")}),this.netSocket.on("data",t=>{let e=JSON.parse(t);if(console.log(e),e.code&&this.$message.error("移动失败，"+e.result),"StageStopped"===e.method){const{finalX:t,finalY:e,finalZ:i}=this.stagePos;this.$message.success(`移动成功（${parseInt(t)}，${parseInt(e)}，${parseInt(i)})`)}}),this.netSocket.on("close",()=>{console.log("Connection closed"),this.reconnectSocket()}),this.netSocket.on("error",()=>{console.log("Connection error"),this.reconnectSocket()}),this.netSocket.on("end",()=>{console.log("Connection end"),this.reconnectSocket()})},saveReloadParams(){localStorage.searchParams=JSON.stringify({currentPage:this.currentPage,pagesize:this.pagesize,filters:this.filters})},chooseFolder(){const{remote:t}=window.electron,{dialog:e}=t,i=e.showOpenDialogSync(t.getCurrentWindow(),{properties:["openDirectory"]});i&&(this.folder=i[0])},imgPreview(t){var e=t.files[0];if(e.size/1024/1024>10)return void this.$message.error("文件大小不能超过10MB");let i=new FormData;i.append("file",e),Object(u.b)("records/uploadImportDoc",i).then(t=>{this.excelname=e.name,this.$refs.importFile.value=""}).catch(t=>{this.$message.error(t.message)})},importExcel(){Object(u.b)("records/importRecords").then(t=>{this.$alert(`<div>导入成功：${t.data.succeed_count}条数据，</div><div>导入失败：${t.data.failure_count}条数据（存在相同切片）</div> <div>跳过处理：${t.data.skip_count}条数据（找不到对应切片）</div>`,"导入成功",{dangerouslyUseHTMLString:!0,confirmButtonText:"确定",showClose:!1}).then(()=>{this.updateList(),this.showImport=!1})}).catch(t=>{this.$message.error(t.message)})},closeNameInut(){this.visiable=!1},keydown(t){switch(t.key){case"Enter":this.$refs.searchbox==document.activeElement&&this.topSearch(),this.$refs.checkvalue==document.activeElement&&this.saveEidt()}},strlen(t){for(var e=0,i=0;i<t.length;i++){var s=t.charCodeAt(i);s>=1&&s<=126||65376<=s&&s<=65439?e++:e+=2}return e},showEtc(t){if(t)return this.strlen(t)<14?t:t.slice(0,4)+"..."+t.slice(-4)},handleSelectionChange(t){const e={},i=t.reduce((t,i)=>(!e[i.id]&&(e[i.id]=t.push(i)),t),[]);this.recordChecked=i.map(t=>t.id),this.checkedFilenames=i.map(t=>t.slices[0]&&t.slices[0].filename);let s=i.map(t=>t.slices);this.folderList=[...new Set(s.flat().map(t=>t.userFilePath))]},getRowKey:t=>t.sliceId,cal(t,e){JSON.parse(Object(u.o)().model_lis).includes(t)&&(t&&this.recordChecked.length?this.$confirm(`已选择${this.recordChecked.length}个病例，将调用<span style="color:#2A9FF6">${e}</span>模块计算选中病例下的<span style="color:#2A9FF6">所有切片</span>。如切片已处理，<span style="color:#2A9FF6">已处理结果将被清空</span>，确定继续吗？`,"操作确认",{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning",dangerouslyUseHTMLString:!0}).then(()=>{this.loading=!0,"fish"==t&&(t="fishTissue"),Object(u.b)("ai/batchCalculation",{caseid_list:JSON.stringify(this.recordChecked),algor_type:t,other:this.config&&this.config.mode?"cs":"",company:Object(u.o)().company}).then(t=>{this.loading=!1,this.getRecords(),this.getFilters(),this.curAI="",this.$refs.table.clearSelection(),this.recordChecked=this.folderList=[],this.$message.success(t.message)}).catch(t=>{this.loading=!1,this.curAI="",this.$message.error(t.message)})}).catch(()=>{this.curAI=""}):this.curAI="")},delAll(){this.$confirm(`已选择${this.recordChecked.length}个病例，确定删除病例和病例下的全部切片数据吗？`,"操作确认",{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning",dangerouslyUseHTMLString:!0}).then(()=>{this.loading=!0,Object(u.b)("records/delete",{id:JSON.stringify(this.recordChecked)}).then(()=>{this.loading=!1,this.$message.success("操作成功"),this.windows=this.windows.filter(t=>!this.recordChecked.includes(t.id)),this.folderList.forEach(t=>{Object(u.h)(t)});let t=Math.ceil((this.tableLength-this.recordChecked.length)/this.pagesize);this.currentPage>t&&this.currentPage>1&&(this.currentPage=t),this.$refs.table.clearSelection(),this.recordChecked=this.folderList=[],this.getRecords(),this.getFilters()}).catch(t=>{this.loading=!1,this.$message.error(t.message)})}).catch(()=>{})},calibrationModel(){this.isStart?this.$alert("校准前请先停止高通量任务。","提示"):this.$confirm(`已选择${this.recordChecked.length}个病例，系统将根据切片情况进行模型校准，从而提升模型表现。<p style="color:#f00">※ 校准期间系统无法进行分析工作。</p><p style="color:#f00">※ 目前仅支持TCT、LCT、TBS+DNA模型的校准，请正确选择病例切片。</p><p style="color:#f00">※ 系统将最多抽取5张切片进行校准。</p>`,"操作确认",{confirmButtonText:"开始校准",cancelButtonText:this.$t("confirm.quit"),dangerouslyUseHTMLString:!0}).then(()=>{this.modelUpdate=!0,Object(u.b)("ai/modelCalibration",{caseid_list:JSON.stringify(this.recordChecked),company:Object(u.o)().company,algor_type:"tct"}).then(()=>{}).catch(t=>{this.modelUpdate=!1,this.$message.error(t.message)})}).catch(()=>{})},cancleCalibration(){Object(u.b)("ai/cancelCalibration").then(()=>{this.$message.success("取消成功"),this.modelUpdate=!1}).catch(t=>{this.$message.error(t.message)})},exportSlides(){this.exportSlideWithDB?(this.showSetPsw=!0,this.exportPop=!1):(this.cancleExport=!1,this.exportPop=!1,this.exportCase())},exportDb(){this.showSetPsw=!1,this.cancleExport=!1,this.exportCase()},async exportCase(){try{g.readdirSync(this.folder)}catch(t){return this.$message.error(this.folder+"不可用,请确认是否移除了U盘或移动硬盘，建议更改/删除后重试。"),void(this.cancleExport=!0)}this.exportKey=Object(u.i)(new Date),Object(u.b)("files/download",{caseid:JSON.stringify(this.recordChecked),want_db:this.exportSlideWithDB?1:0,companyid:Object(u.o)().company,path:this.folder,ip:this.ip,key:this.exportKey}).then(async()=>{}).catch(t=>{this.$message.error(t.message),this.cancleExport=!0})},cancleExportSlides(){Object(u.b)("files/cancelDownload",{key:this.exportKey}).then(()=>{this.cancleExport=!0,this.exportKey=""}).catch(t=>this.$message.error(t.message))},createWebSocket(){let t;if("https:"==window.location.protocol)t=`wss://ws-${window.location.host}`;else{let e=Number(window.location.port)+1;t=`ws://${window.location.hostname}:${e}`}console.log("ws连接开始");const e=`${t}/aipath/api/ai/connect?company=${Object(u.o)().company}`;window.ws||(window.ws=new WebSocket(e)),window.ws.onopen=this.onopen,window.ws.onmessage=this.onmessage,window.ws.onclose=this.onclose,window.ws.onerror=this.onerror},reconnect(){this.lockReconnect||(this.lockReconnect=!0,this.timeoutnum&&clearTimeout(this.timeoutnum),this.timeoutnum=setTimeout(()=>{window.ws&&window.ws.close(),window.ws=null,this.createWebSocket(),this.lockReconnect=!1},5e3))},reset(){clearTimeout(this.timeoutObj),this.start()},start(){this.timeoutObj&&clearTimeout(this.timeoutObj),this.timeoutObj=setTimeout(()=>{1==window.ws.readyState?window.ws.send(this.msgInfo("check","heartbeat")):this.reconnect()},this.timeout)},onopen(){this.start()},onmessage(t){let e=JSON.parse(t.data);switch(e.type){case"inform":this.getRecords(),this.getFilters();break;case"highThrough_inform":this.batchMsg=e.slice_data,this.getRecords(),this.getFilters();break;case"queue":this.queueMsg=e.message;break;case"download":this.cancleExport=!0,this.$message(e.message);break;case"calibrate":this.$alert("模型校准已完成，原处理结果不变。","提示",{confirmButtonText:"关闭",showClose:!1,type:"success"}).then(()=>{this.modelUpdate=!1,this.$refs.table.clearSelection(),this.recordChecked=this.folderList=[]}).catch(t=>t)}this.reset()},msgInfo:(t,e)=>JSON.stringify({type:t,message:e}),onclose(t){console.log("连接关闭"),console.log("websocket 断开: "+t.code+" "+t.reason+" "+t.wasClean),this.reconnect()},onerror(t){console.log("出现错误"),this.reconnect()},showMenu(t,e){this.contextLeft=t.pageX-22,this.showContext=!0,this.curContextCase=e},closeCase(t){switch(t){case"all":this.$confirm("确认要关闭吗？如有数据未保存，直接关闭将丢失。").then(()=>{this.windows=[],this.closeContext()}).catch(t=>t);break;case"cur":this.closeConfirm(this.curContextCase);break;case"others":this.$confirm("确认要关闭吗？如有数据未保存，直接关闭将丢失。").then(()=>{this.windows=this.windows.filter(t=>t==this.curContextCase),this.closeContext()}).catch(t=>t)}},closeConfirm(t){let e=this.$refs[t.id+"detail"][0].oldRecord,i=this.$refs[t.id+"detail"][0].record;r.a.equals(e.basic,i.basic)?(this.windows=this.windows.filter(e=>e.id!=t.id),this.closeContext()):this.$confirm("有数据还未保存，真的要关闭吗？").then(()=>{this.windows=this.windows.filter(e=>e!=t),this.closeContext()}).catch(t=>t)},closeContext(){this.showContext=!1,this.curContextCase=null,this.reloadTable()},openEdit(t,e){this.visiable=!0,this.editType=e,this.editCase="caseId"===e?t.basic.caseid:t.slice_number,this.editId="caseId"===e?t.id:t.sliceId;let i="caseId"===e?this.$refs[t.id].parentNode.parentNode:this.$refs[t.sliceId].parentNode.parentNode,s=(i.getBoundingClientRect().left,i.getBoundingClientRect().top+i.clientHeight);this.$nextTick(()=>{let t=this.$refs.editPop;t.style.left="60px",t.style.top=s+6+"px",this.$refs.checkvalue.select()})},closeEdit(){this.visiable&&(this.visiable=!1)},async saveEidt(){"caseId"===this.editType?(await this.changeCaseId(),this.visiable=!1):(await this.changeSlideId(),this.visiable=!1)},async topSearch(){this.filters=Object.assign({},this.filters,{search_key:this.filterType,search_value:this.searchVal}),this.clearTableFiters(),this.saveReloadParams()},async clearTableFiters(){this.windows=[],this.$refs.table.clearSelection(),this.recordChecked=[],this.checkedFilenames=[],this.folderList=[],this.currentPage=1,this.loading=!0,await this.getRecords(),this.loading=!1,this.$refs.table.bodyWrapper.scrollTop=0},async resetAll(){this.$refs.table.clearFilter(),this.$refs.table.clearSort(),this.filters={},this.searchVal="",this.dateTime=[],this.createTime=[],this.ageStart=this.ageEnd="",this.clearTableFiters(),this.saveReloadParams()},changeSlideId(){Object(u.b)("records/setsliceNum",{fileid:this.editId,slice_number:this.editCase}).then(()=>{this.getRecords(),this.getFilters()})},changeCaseId(){Object(u.b)("records/setCaseid",{id:this.editId,caseid:this.editCase}).then(()=>{this.getRecords(),this.getFilters()})},arraySpanMethod({row:t,column:e,rowIndex:i,columnIndex:s}){if(["样本号","姓名","性别","年龄","取样部位","样本类型","切片数量","创建时间","最后更新","报告","操作"].includes(e.label)||0===s)return t.len>0?{rowspan:t.len,colspan:1}:{rowspan:0,colspan:0}},toogleTable(t,e){let i=this.records.map(i=>(i.id===t.id&&(i.opened=!e),i));this.tableData=this.handleTabelData(i)},handleCheckAllChange(t){localStorage.checkAll=t;let e=this.records.map(e=>(e.slices_count&&(e.opened=!!t),e));this.tableData=this.handleTabelData(e)},handleHeadChange(t){Object(u.b)("records/setChecked",{tableChecked:JSON.stringify(t)})},resetTableHead(){this.tableChecked=["样本号","姓名","性别","切片数量","状态","切片标签","切片编号","文件名","AI模块","AI建议","复核结果","创建时间","最后更新","报告"],this.handleHeadChange()},offset(t,e){for(var i="offset"+e[0].toUpperCase()+e.substring(1),s=t[i],a=t.offsetParent;null!=a;)s+=a[i],a=a.offsetParent;return s},showAge(){let t=document.querySelector(".search-age"),e=this.offset(t,"left");this.offLeft=e,this.showAgeRange=!this.showAgeRange,this.showTimeRange=!1,this.showCreateRange=!1},async setAgeRange(){this.ageStart&&this.ageEnd?(Object.assign(this.filters,{age_min:this.ageStart,age_max:this.ageEnd}),this.showAgeRange=!1,this.showTimeRange=!1,this.showCreateRange=!1,this.clearTableFiters(),this.saveReloadParams()):this.$message({message:"年龄段必填",type:"error"})},async resetAge(){this.ageEnd=this.ageStart="",delete this.filters.age_min,delete this.filters.age_max,this.clearTableFiters(),this.saveReloadParams()},showTime(t){let e=document.querySelector(t),i=this.offset(e,"left");this.offLeft=i,".search-creat"===t?(this.showCreateRange=!this.showCreateRange,this.showTimeRange=!1):(this.showTimeRange=!this.showTimeRange,this.showCreateRange=!1),this.showAgeRange=!1},getLong:t=>new Date(t).getTime(),async resetTime(t){"create"===t?(this.createTime=[],delete this.filters.create_min,delete this.filters.create_max):(this.dateTime=[],delete this.filters.update_min,delete this.filters.update_max),this.showTimeRange=!1,this.showCreateRange=!1,this.clearTableFiters(),this.saveReloadParams()},async setTimeRange(t){if("create"==t){if(!this.createTime.length)return void this.$message({message:"时间段必填",type:"error"});Object.assign(this.filters,{create_min:this.createTime[0],create_max:this.createTime[1]})}else{if(!this.dateTime.length)return void this.$message({message:"时间段必填",type:"error"});Object.assign(this.filters,{update_min:this.dateTime[0],update_max:this.dateTime[1]})}this.clearTableFiters(),this.saveReloadParams(),this.showAgeRange=!1,this.showTimeRange=!1,this.showCreateRange=!1},closeSetting(t){this.showSetting&&"header-setting"!==t.target.className&&(this.showSetting=!1),this.showTimeRange&&(this.showTimeRange=!1),this.showCreateRange&&(this.showCreateRange=!1),this.showAgeRange&&(this.showAgeRange=!1),this.showContext&&"context-menu"!==t.target.className&&(this.showContext=!1)},downloadTemplate(){window.location.href=`/aipath/api/files/downloadTemplate?name=${encodeURIComponent("病例列表导入模板.xlsx")}`},downloadExcel(){this.$confirm("如果导出数据过多，excel文件可能会运行缓慢。也可通过搜索筛选出要导出的数据后，再做尝试。","提示",{confirmButtonText:"导出excel",cancelButtonText:"取消",type:"warning"}).then(()=>{this.loading=!0;let e=Object(u.i)(new Date).replace(/\s+/g,""),i=Object.assign({},this.filters);for(let t in i)i[t]instanceof Object&&(i[t]=JSON.stringify(i[t]));p()({headers:{"Content-Type":" application/x-www-form-urlencoded"},method:"post",url:`/aipath/api/records/export?time=${e}`,data:m.a.stringify(i),responseType:"blob"}).then(e=>{if(window.electron){let i=new Blob([e.data],{type:"application/vnd.ms-excel"}),s=new FileReader;s.readAsDataURL(i),s.onload=(e=>{const{dialog:i}=window.electron.remote;i.showSaveDialog({defaultPath:"病例列表.xlsx",title:"导出excel",filters:[{name:".xlsx",extensions:["xlsx"]},{name:".xls",extensions:["xls"]}]}).then(async({filePath:i})=>{if(i){let s=t.from(e.target.result.split("base64,")[1],"base64");const a=new _.PassThrough({allowHalfOpen:!1}).end(s),n=new g.createWriteStream(i);n.on("error",t=>{console.log(t),this.$message.error("导出错误，请重试"),this.loading=!1}).on("finish",()=>{this.loading=!1}),a.pipe(n)}else this.loading=!1})})}else{const t=document.createElement("a");let i=new Blob([e.data],{type:"application/vnd.ms-excel"});t.style.display="none",t.href=URL.createObjectURL(i),t.download="病例列表.xlsx",document.body.appendChild(t),t.click(),document.body.removeChild(t),window.URL.revokeObjectURL(t.href),this.loading=!1}}).catch(t=>{this.$message.error(t)})}).catch(t=>t)},toogleBatch(){this.batch=!this.batch,this.windows.map(t=>this.hideWindow(t)),this.batch||(this.getRecords(),this.getFilters())},goLeft(){let t=this.$refs.toolslist,e=t.style.left.slice(0,-2);t.style.left=t.offsetLeft+142+"px",this.showRight=!0,e>-143&&(this.showLeft=!1)},goRight(){let t=this.$refs.toolslist,e=this.$refs.toolsContainer,i=t.style.left.slice(0,-2);t.style.left=t.offsetLeft-142+"px",this.showLeft=!0,142*(this.windows.length-1)+Number(i)<e.offsetWidth&&(this.showRight=!1)},async download(t,e,i){if(window.electron){let i=window.location.origin+`/aipath/api/report/view?caseid=${t}&reportid=${e}`;const{BrowserWindow:s}=window.electron.remote;let a=new s({width:1e3,height:800,enableRemoteModule:!0});a.loadURL(i),a.on("closed",()=>{a=null})}else{let s=this.$refs.lastA[i];s.href=`/aipath/api/report/view?caseid=${t}&reportid=${e}`,s.target=this.showBatch?"_self":"_blank"}},opendetail(t){this.openWindow(this.records.filter(e=>e.id==t)[0])},closeBatch(){this.batch=!1},updateList(){this.demoModeValue="1"===localStorage.getItem("demoMode")||!1,!this.demoModeValue&&this.windows.length>1&&(this.windows=[]),this.getRecords(),this.getFilters()},handleSizeChange:async function(t){localStorage.pageNum=this.pagesize=t,this.currentPage=1,this.loading=!0,await this.getRecords(),this.loading=!1,this.$refs.table.bodyWrapper.scrollTop=0,this.saveReloadParams()},async handlePageChange(t){this.currentPage=t,this.loading=!0,await this.getRecords(),this.loading=!1,this.$refs.table.bodyWrapper.scrollTop=0,this.saveReloadParams()},states:()=>[{text:"待处理",value:0},{text:"处理中",value:1},{text:"已处理",value:2},{text:"处理异常",value:3}],checkReport:()=>[{text:"有",value:1},{text:"无",value:2}],formatAlg:()=>({tct1:"TCT1.0",tct2:"TCT2.0",lct1:"LCT1.0",lct2:"LCT2.0",pdl1:"PD-L1",ki67:"Ki-67",er:"ER",pr:"PR",fish:"FISH",cellseg:"细胞分割",celldet:"细胞检测",her2:"HER-2",ki67hot:"Ki-67 热区",np:"鼻息肉",dna:"TBS+DNA",bm:"骨髓血细胞"}),showReport(t){t.reports.length&&(this.showReports=!0,this.currentRecord=t)},async filterChange(t){this.filters=Object.assign({},this.filters,t),this.clearTableFiters(),this.saveReloadParams()},async sortChange({column:t,order:e}){e?(this.filters.seq_key=t.columnKey,this.filters.seq="ascending"===e?2:1):(this.filters.seq_key=null,this.filters.seq=null),this.clearTableFiters(),this.saveReloadParams()},createNew(){this.openWindow({id:Object(u.i)(new Date).replace(/[-\s:]/g,"_")+"_"+Math.floor(1e6*Math.random()),basic:{name:"",samplePart:"",sampleCollectDate:"",sampleType:"",caseid:"",sampleTime:"",medicalHistory:"",age:"",gender:"",generallySeen:"",cancerType:"",familyHistory:""},stage:0,slices:[],attachments:[],reports:[],update:(new Date).toISOString()})},openWindow(t,e,i){let s=this.windows.find(e=>e.id==t.id);if(s)this.currentWindow&&this.currentWindow.id==s.id?this.$set(s,"show",!s.show):(this.$set(s,"show",1),this.windows.filter(e=>e.id!==t.id).map(t=>{this.$set(t,"show",0)}),s=this.currentWindow=s);else{if(!this.demoModeValue&&this.windows.length>0)return void this.$message.error("详情页打开过多，请关闭底部标签后再试");if(this.windows.length>9)return void this.$message.error("详情页打开过多，请关闭底部标签后再试");s=this.currentWindow={id:t.id,record:r.a.clone(t),oldrecord:null,show:1},this.windows.push(s),this.detailTimes++}if(s){var a=e;e||(a=s.record.slice?s.record.slice:s.record.slices_count?s.record.slices[0].id:null),this.$set(s.record,"slice",a),this.$set(s.record,"stage",i<=0||i?i:s.record.slices_count>0?2:0)}},openNewWindow(t,e,i){if(new Date-this.clickTimer<3e3)this.$message.error("操作频率过快，请稍后再试");else{this.detailTimes++;let s=this.windows.find(t=>t.id==e.id);this.closeWindow(s,i),this.windows=this.windows.filter(e=>e.id!=t.id);let a=this.currentWindow={id:t.id,record:r.a.clone(t),oldrecord:null,show:1};this.windows.push(a),this.$set(a.record,"slice",a.record.slices_count?a.record.slices[0].id:null),this.$set(a.record,"stage",e.stage),this.clickTimer=new Date}},reloadTable(){if(this.detailTimes>99)if(this.isStart){if(this.$refs.batchDom.uploadStatus)return;this.$refs.batchDom.$refs.scan.stopWork(),this.batch=!0,this.$alert("因反复阅片占用过多资源，系统即将刷新并优化（耗时约1s），完成后需重新开始高通量任务（已上传切片将自动跳过处理）。","系统稳定性保护",{confirmButtonText:"立即优化",showClose:!1,type:"error",callback:()=>{window.location.reload()}})}else this.$alert("因反复阅片占用过多资源，系统即将刷新并优化（耗时约1s）","系统稳定性保护",{confirmButtonText:"立即优化",showClose:!1,type:"error",callback:()=>{window.location.reload()}})},closeWindow(t,e){"next"!==e&&this.updateList(),this.windows=this.windows.filter(e=>e!=t),this.reloadTable()},hideWindow(t){this.$set(t,"show",0),this.updateList()},handleTabelData(t){let e=[];for(let i=0;i<t.length;i++){let s=t[i].slices;if(s.length){let a=1;t[i].opened&&(a=s.length>10?10:s.length);for(let n=0;n<a;n++){let o=Object.assign({},t[i],{len:0===n?a:0,started:s[n].started,filename:s[n].filename,userFilePath:s[n].userFilePath,alg:s[n].alg,ai_suggest:s[n].ai_suggest,check_result:s[n].check_result,operator:s[n].operator,slice_number:s[n].slice_number,sliceId:s[n].id,have_label:s[n].have_label});e.push(o)}}else{let s=Object.assign({},t[i],{len:1,started:0,filename:"",alg:"",ai_suggest:"",check_result:"",operator:""});e.push(s)}}return e},getFilters(){Object(u.b)("records/all").then(t=>{this.samplePartList=t.data.samplePart,this.sampleTypeList=t.data.sampleType,this.folders=t.data.folders,this.operators=t.data.operators}).catch(t=>{console.error(t)})},getChecks(){Object(u.b)("records/getChecked").then(t=>{this.tableChecked=t.data}).catch(t=>{console.error(t)})},getSearchedList(t){const e={page:1,search_value:t,search_key:this.filterType};Object(u.b)("records/search",e).then(t=>{const e=this.handleTabelData(t.data.data)[parseInt(localStorage.getItem("scanDetailTag")||0)],i=window.location.href.split("?")[0];this.windows.length&&this.closeConfirm(this.windows[0]),window.history.replaceState({},"",i),this.openWindow(e,e.sliceId,2)})},getRecords(){let t=Object.assign({},this.filters,{page:this.currentPage,limit:this.pagesize});this.conditions=t;for(let e in t)t[e]instanceof Object&&(t[e]=JSON.stringify(t[e]));return new Promise(e=>{Object(u.b)("records/search",t).then(({data:t})=>{let i=t.data.filter(t=>t.slices_count>1).map(t=>t.id);return this.records=t.data.map(t=>(i.includes(t.id)&&(this.checkAll?t.opened=!0:t.opened=!1),t)),this.tableData=this.handleTabelData(t.data),this.currentRecord=this.currentRecord&&t.data.find(t=>t.id==this.currentRecord.id),this.currentRecord&&this.$refs.table&&this.$refs.table.setCurrentRow(this.tableData.find(t=>t.id===this.currentRecord.id)),this.loaaded=!0,this.tableLength=t.total,this.recordsToChild=t,e(t),this.records}).catch(t=>{this.loaaded=!0,console.error(t)})})},async getRecord(t){let e=await Object(u.b)("records/search",t);return this.recordsToChild=e.data,e.data},deleteRecord(t){this.$confirm(this.$t("caselist.deleteCase")+`${t.basic.caseid?t.basic.caseid:""}?`,{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{this.loading=!0,Object(u.b)("records/delete",{id:JSON.stringify([t.id])}).then(()=>{this.loading=!1,t.slices.length&&t.slices.forEach(t=>{Object(u.h)(t.userFilePath)}),this.windows=this.windows.filter(e=>e.id!==t.id);let e=this.recordChecked.findIndex(e=>e===t.id);this.recordChecked.splice(e,1),this.checkedFilenames.splice(e,1),this.tableData.filter(e=>e.id==t.id).forEach(t=>this.$refs.table.toggleRowSelection(t,!1));let i=Math.ceil((this.tableLength-1)/this.pagesize);this.currentPage>i&&this.currentPage>1&&(this.currentPage=i),this.getRecords(),this.getFilters()})}).catch(t=>{console.log(t)})},getProgress:(t,e=t.slices.concat(t.attachments))=>e.map(t=>t.loaded).reduce((t,e)=>t+e,0)/(e.map(t=>t.total).reduce((t,e)=>t+e,0)||1)},components:{"v-header":s.a,"v-thumbnails":a.a,"v-footer":n.a,"v-detail":o.a,"v-batch":c.a,PswPop:h.a},created(){if(this.showBatch=!!window.electron,window.electron&&(console.log(window.electron.remote.process.versions),f.zeiss)){(0,window.electron.remote.require)("process").on("uncaughtException",t=>{console.log("高通量系统报错:",t),this.reconnectSocket()}),this.createSocket()}const t=[{text:"阴性",value:"阴性"},{text:"阳性",value:"阳性"},{text:"样本不满意",value:"样本不满意"},{text:"HSIL",value:"HSIL"},{text:"ASC-H",value:"ASC-H"},{text:"LSIL",value:"LSIL"},{text:"ASC-US",value:"ASC-US"},{text:"AGC",value:"AGC"},{text:"滴虫",value:"滴虫"},{text:"霉菌",value:"霉菌"},{text:"线索",value:"线索"},{text:"放线菌",value:"放线菌"}],e=[{text:"HER-2 0",value:"HER-2 0"},{text:"HER-2 1+",value:"HER-2 1+"},{text:"HER-2 2+",value:"HER-2 2+"},{text:"HER-2 3+",value:"HER-2 3+"}],i=[{text:"有效检测细胞不足",value:"有效检测细胞不足"},{text:"未见DNA倍体异常细胞",value:"未见DNA倍体异常细胞"},{text:"可见少量DNA倍体异常细胞（1-2个）",value:"可见少量DNA倍体异常细胞（1-2个）"},{text:"可见少量细胞增生（5%-10%）",value:"可见少量细胞增生（5%-10%）"},{text:"可见细胞异常增生（≥10%）",value:"可见细胞异常增生（≥10%）"},{text:"可见DNA倍体异常细胞（≥3个）",value:"可见DNA倍体异常细胞（≥3个）"},{text:"可见异倍体细胞峰",value:"可见异倍体细胞峰"}];let s=[{text:"无",value:"无"}];(JSON.parse(Object(u.o)().model_lis).includes("dna")||JSON.parse(Object(u.o)().model_lis).includes("tct1")||JSON.parse(Object(u.o)().model_lis).includes("tct2")||JSON.parse(Object(u.o)().model_lis).includes("lct1")||JSON.parse(Object(u.o)().model_lis).includes("lct2"))&&(s=s.concat(t)),JSON.parse(Object(u.o)().model_lis).includes("her2")&&(s=s.concat(e)),JSON.parse(Object(u.o)().model_lis).includes("dna")&&(s=s.concat(i)),this.humanCheckResult=s,JSON.parse(Object(u.o)().model_lis).includes("dna")&&(this.humanCheckResult=this.humanCheckResult.concat([{text:"标本不满意：上皮细胞数目太少",value:"标本不满意：上皮细胞数目太少"},{text:"标本不满意",value:"标本不满意"},{text:"其它",value:"其它"}])),this.checkResult=s,this.AIList=[{text:"TCT1.0",value:"tct1"},{text:"TCT2.0",value:"tct2"},{text:"LCT1.0",value:"lct1"},{text:"LCT2.0",value:"lct2"},{text:"PD-L1",value:"pdl1"},{text:"Ki-67",value:"ki67"},{text:"ER",value:"er"},{text:"PR",value:"pr"},{text:"FISH",value:"fish"},{text:"细胞分割",value:"cellseg"},{text:"细胞检测",value:"celldet"},{text:"HER-2",value:"her2"},{text:"Ki-67 热区",value:"ki67hot"},{text:"鼻息肉",value:"np"},{text:"TBS+DNA",value:"dna"},{text:"CD30",value:"cd30"},{text:"骨髓血细胞",value:"bm"}]},destroyed(){window.removeEventListener("click",this.closeSetting),window.removeEventListener("click",this.closeEdit),clearTimeout(this.timeoutObj),this.netSocket&&this.netSocket.destroy(),clearTimeout(this.netReconnect),this.netSocket=this.netReconnect=null}}}).call(e,i("EuP9").Buffer)},WP8Z:function(t,e){},X3Zj:function(t,e){},XA3p:function(t,e,i){t.exports=i.p+"static/img/提醒.1ae81ce.svg"},XS7h:function(t,e){},Xiz7:function(t,e){},"Y+x6":function(t,e,i){"use strict";var s=i("jyVo"),a={data:()=>({isActive:null,showLeft:!1,showRight:!0,company:Object(s.o)().company,startIndex:0}),computed:{slideLength(){return Math.min(this.startIndex+10,this.record.slices.length)}},methods:{loadImg(){for(let t=Math.max(0,this.startIndex);t<Math.min(this.record.slices.length,this.slideLength);t++)this.$refs.num[t].style.backgroundImage=`url('/aipath/api/files/thumbnail?caseid=${encodeURIComponent(this.record.id)}&fileid=${this.record.slices[t].id}&companyid=${encodeURIComponent(this.company)}')`},rollover(t){this.isActive=t,this.$refs.num[t].style.left=310*t-39+"px"},rollout(t){this.isActive=null,this.$refs.num[t].style.left=310*t+"px"},goLeft(){var t=this.$refs.inner.style.left.substring(0,this.$refs.inner.style.left.length-2);t&&t<38&&(this.$refs.inner.style.left=this.$refs.inner.offsetLeft+620+"px",t=this.$refs.inner.style.left.substring(0,this.$refs.inner.style.left.length-2),this.startIndex-=4,this.loadImg(),this.showRight=!0),t&&t>0&&(this.$refs.inner.style.left="48px",this.showLeft=!1)},goRight(){var t=this.$refs.inner.style.left.substring(0,this.$refs.inner.style.left.length-2);this.width()+Number(t)>930&&(this.$refs.inner.style.left=this.$refs.inner.offsetLeft-620+"px",t=this.$refs.inner.style.left.substring(0,this.$refs.inner.style.left.length-2),this.startIndex+=4,this.loadImg(),this.showLeft=!0),this.width()+Number(t)<931&&(this.showRight=!1)},width(){return this.record?310*this.record.slices.length:0}},mounted(){this.showRight=this.width()>this.$refs.outer.offsetWidth;document.querySelector(".outer");this.record&&this.record.slices&&this.loadImg()},watch:{"record.slices":function(t){if(t){let t=this.record?310*this.record.slices.length:0;this.showRight=t>this.$refs.outer.offsetWidth}else this.showRight=!1,this.showLeft=!1}},props:["record"]},n={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{ref:"outer",staticClass:"outer"},[t.record&&t.showLeft?i("div",{staticClass:"left",on:{click:function(e){return t.goLeft()}}}):t._e(),t._v(" "),t.record?i("div",{ref:"inner",staticClass:"inner"},t._l(t.record.slices,function(e,s){return i("div",{key:s,ref:"num",refInFor:!0,staticClass:"images",class:{active:s==t.isActive},style:"left:"+310*s+"px;background-size:contain;",on:{dblclick:function(i){return t.$emit("click",e.id)},mouseover:function(e){return t.rollover(s)},mouseout:function(e){return t.rollout(s)}}},[i("div",[i("p",[t._v(t._s(e.name))]),t._v(" "),e.stain?i("p",[t._v(t._s(e.stain))]):t._e()])])}),0):t._e(),t._v(" "),t.record&&t.showRight?i("div",{staticClass:"right",on:{click:function(e){return t.goRight()}}}):t._e()])},staticRenderFns:[]};var o=i("VU/8")(a,n,!1,function(t){i("qGnM")},"data-v-23627652",null);e.a=o.exports},YPLu:function(t,e,i){t.exports=i.p+"static/img/关闭.a9102f6.png"},Yd62:function(t,e){},YhIh:function(t,e){},ZEUm:function(t,e,i){"use strict";e.a=[{toolType:"human",label:"手工",analyname:"null",canannly:!1},{toolType:"mutialg",label:"多算法",analyname:"null",canannly:!0},{toolType:"tct1",label:"TCT1.0",analyname:"tct1",canannly:!0},{toolType:"tct2",label:"TCT2.0",analyname:"tct2",canannly:!0},{toolType:"lct1",label:"LCT1.0",analyname:"lct1",canannly:!0},{toolType:"lct2",label:"LCT2.0",analyname:"lct2",canannly:!0},{toolType:"dna",label:"TBS+DNA",analyname:"dna",canannly:!0},{toolType:"ki67",label:"Ki-67",analyname:"ki67",canannly:!0},{toolType:"ki67hot",label:"Ki-67 热区",analyname:"ki67hot",canannly:!0},{toolType:"er",label:"ER",analyname:"er",canannly:!0},{toolType:"pr",label:"PR",analyname:"pr",canannly:!0},{toolType:"pdl1",label:"PD-L1",analyname:"pdl1",canannly:!0},{toolType:"cellseg",label:"细胞分割",analyname:"cellseg",canannly:!1},{toolType:"center",label:"细胞检测",analyname:"celldet",canannly:!0},{toolType:"her2",label:"HER-2",analyname:"her2",canannly:!0},{toolType:"fish",label:"FISH",analyname:"fishTissue",canannly:!0},{toolType:"np",label:"鼻息肉",analyname:"np",canannly:!0},{toolType:"bm",label:"骨髓血细胞",analyname:"bm",canannly:!0},{toolType:"tagging",label:"标注",analyname:"null",canannly:!0}]},ZOtu:function(t,e,i){t.exports=i.p+"static/img/point.4b98629.svg"},ZULA:function(t,e){},aN2i:function(t,e){},aRG1:function(t,e,i){"use strict";var s={data:()=>({time:"",date:"",diskImg:"",freeSpace:"",messageList:!1,messageTotal:"",currentMessage:{},showBg:!1}),methods:{showMessage:function(){this.messageList=!0,this.showBg=!0},hideMessage:function(){this.messageList=!1,this.showBg=!1},updateTime:function(){var t=this;this.$store.state.roi.nowTime=setInterval(function(){t.currentTime()},1e3)},currentTime:function(){var t=new Date;this.time=this.zeroPadding(t.getHours(),2)+":"+this.zeroPadding(t.getMinutes(),2),this.date=this.zeroPadding(t.getFullYear(),4)+"/"+this.zeroPadding(t.getMonth()+1,2)+"/"+this.zeroPadding(t.getDate(),2)},zeroPadding:function(t,e){for(var i="",s=0;s<e;s++)i+="0";return(i+t).slice(-e)},diskSpace:function(){var t=this,e={success:function(e){1==e.status?(t.freeSpace=e.msg.freeDiscSize+"G可用，共"+e.msg.totalDiscSize+"G",e.msg.freeDiscSize>=50&&(t.diskImg="/static/img/icon_disk_enough.png"),50>e.msg.freeDiscSize&&e.msg.freeDiscSize>=20&&(t.diskImg="/static/img/disk_danger.png"),e.msg.freeDiscSize<20&&(t.diskImg="/static/img/icon_disk_Notenough.png")):this.$alert(e.msg)}};common_function.ajax_request(e,"/case/disc","get")},messages:function(){var t=this,e={success:function(e){if(1==e.status)if(e.msg.list){t.messageTotal=e.msg.list;for(var i=0;i<e.msg.list.length;i++)"info"==e.msg.list[i].msgStatus?(t.messageTotal[i].img="/static/img/dialog-icon-done.png",t.messageTotal[i].class="message-info"):"warn"==e.msg.list[i].msgStatus?(t.messageTotal[i].img="/static/img/dialog-icon-alarm.png",t.messageTotal[i].class="message-warn"):"error"==e.msg.list[i].msgStatus?(t.messageTotal[i].img="/static/img/dialog-icon-warn.png",t.messageTotal[i].class="message-error"):(t.messageTotal[i].img="",t.messageTotal[i].class="");t.currentMessage=e.msg.list[0]}else t.messageTotal=[],t.currentMessage={};else console.log(e.msg),t.messageTotal=[],t.currentMessage={}}};common_function.ajax_request(e,"/case/bottomMessage","get")}},mounted(){this.updateTime(),this.diskSpace(),this.messages();var t=this;this.$store.state.roi.intervalDisk=setInterval(function(){t.diskSpace(),t.messages()},1e4)}},a={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{staticClass:"updage-message",class:t.currentMessage.class,on:{click:function(e){return t.showMessage()}}},[i("img",{attrs:{src:t.currentMessage.img}}),t._v(" "),i("span",[t._v(t._s(t.currentMessage.time))]),t._v(t._s(t.currentMessage.content)),i("i")]),t._v(" "),i("div",{staticClass:"current-time"},[i("span",[t._v(t._s(t.time))]),i("span",[t._v(t._s(t.date))])]),t._v(" "),i("div",{staticClass:"disk"},[i("img",{attrs:{src:t.diskImg,title:t.freeSpace}})]),t._v(" "),t.showBg?i("div",{staticClass:"popBg",on:{click:function(e){return t.hideMessage()}}}):t._e(),t._v(" "),t.messageList?i("div",{staticClass:"message-list"},[i("ul",t._l(t.messageTotal,function(e,s){return i("li",{key:s,class:e.class},[i("img",{attrs:{src:e.img}}),t._v(" "),i("span",[t._v(t._s(e.time))]),t._v(t._s(e.content))])}),0)]):t._e()])},staticRenderFns:[]};var n=i("VU/8")(s,a,!1,function(t){i("knUx")},"data-v-88a12784",null);e.a=n.exports},aRHw:function(t,e,i){t.exports=i.p+"static/img/自由笔.d194396.svg"},awQe:function(t,e){},"b+np":function(t,e){},bahX:function(t,e){},c2Ms:function(t,e){},cAUE:function(t,e){},cnSL:function(t,e){},dE9I:function(t,e,i){t.exports=i.p+"static/img/scan-icon.58c50fd.svg"},dQmP:function(t,e,i){t.exports=i.p+"static/img/图例.cf250fc.jpg"},dVh8:function(t,e){},dope:function(t,e){},dptE:function(t,e){},eqs2:function(t,e,i){t.exports=i.p+"static/img/删除.f6b48db.svg"},"exB+":function(t,e){},fC4T:function(t,e){t.exports=function(t){return t&&"object"==typeof t&&"function"==typeof t.copy&&"function"==typeof t.fill&&"function"==typeof t.readUInt8}},fT8I:function(t,e){},fbUa:function(t,e){},fft9:function(t,e){},fwhK:function(t,e){},"g+uk":function(t,e){},gWm7:function(t,e){},gfnL:function(t,e){},gpZe:function(t,e){},h5LH:function(t,e){},hJXG:function(t,e){},hfCn:function(t,e,i){"use strict";var s={props:["slices","choosemodel","iffile","isStart","uploadStatus"],data:()=>({slide:"0",Len:0,cut:!1,showGif:!1}),methods:{startButton(){return this.iffile?this.choosemodel?(this.$emit("scanBegin",JSON.stringify(this.choosemodel)),this.showGif=!0,void this.$emit("setStart",!0)):this.$emit("showerr","请选择算法"):this.$emit("showerr","请选择文件夹")},stopWork(){this.uploadStatus?this.$alert("您有一张切片正在上传，请稍后再停止。","警告",{confirmButtonText:"确定",showClose:!1,type:"error",callback:()=>{}}):(this.$emit("setStart",!1),this.cut=!1,this.showGif=!1,this.$emit("stopWork"))},pause(){this.cut=!0,this.showGif=!1,this.$emit("pause",!0)},goon(){this.cut=!1,this.showGif=!0,this.$emit("pause",!1)}},beforeUpdate(){this.slices.length>this.Len&&(this.slide=this.slices[1]||"key"),this.Len=this.slices.length}},a={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("div",{staticClass:"scanning"},[s("h3",{staticClass:"title"},[t._v("切片扫描传输中...")]),t._v(" "),s("div",{staticClass:"scanning-box corner1"},[s("div",{staticClass:"scanning-video"},[s("img",{directives:[{name:"show",rawName:"v-show",value:t.showGif,expression:"showGif"}],staticClass:"coverimg",attrs:{src:i("ApPL"),alt:""}}),t._v(" "),s("img",{directives:[{name:"show",rawName:"v-show",value:!t.showGif,expression:"!showGif"}],staticClass:"coverimg",attrs:{src:i("IVJQ"),alt:""}})]),t._v(" "),s("div",{staticClass:"scanning-state"},[t.isStart?s("div",{key:t.slide,staticClass:"scanning-being"},[s("span",{staticClass:"info fl"},[t._v(t._s(t.cut?"暂停中...":"正在扫描中..."))]),t._v(" "),t.cut?t._e():s("img",{attrs:{src:i("r8Ek"),alt:""}}),t._v(" "),s("div",{staticClass:"autostop"},[t.cut?t._e():s("button",{staticClass:"cut",attrs:{title:"暂停后，已上传切片将继续分析"},on:{click:t.pause}},[t._v("暂停扫描")]),t._v(" "),t.cut?s("button",{staticClass:"goon",on:{click:function(e){return t.goon()}}},[t._v("继续")]):t._e(),t._v(" "),s("button",{staticClass:"stop",on:{click:function(e){return t.stopWork()}}},[t._v("停止扫描")])])]):s("a",{staticClass:"start-button",attrs:{href:"javascript:;"},on:{click:t.startButton}},[t._v("开始分析")])]),t._v(" "),s("i",{staticStyle:{display:"none"}},[t._v(t._s(t.slices.length))])])])])},staticRenderFns:[]};var n=i("VU/8")(s,a,!1,function(t){i("TcE1")},"data-v-4e75835b",null);e.a=n.exports},i1en:function(t,e,i){t.exports=i.p+"static/img/存储.f7c365f.svg"},iEaZ:function(t,e,i){t.exports=i.p+"static/img/矩形排除.e7e2699.svg"},iFgc:function(t,e){},igVU:function(t,e,i){t.exports=i.p+"static/img/analyze.f0944af.gif"},io7N:function(t,e,i){t.exports=i.p+"static/img/迪英加logo.4252a2a.svg"},jLS6:function(t,e){},jdSn:function(t,e,i){t.exports=i.p+"static/img/矩形.2e64410.svg"},jjsr:function(t,e){},k5KV:function(t,e,i){(function(){var e,s,a=[].slice;s=i("rdLu"),i("OMJi").puts,e={isPlainObject:function(t){return null!=(null!=t?t.constructor:void 0)&&"Object"===t.constructor.name},clone:function(t){var i,a,n,o,l;if(s.isArray(t)){for(i=[],o=0,l=t.length;o<l;o++)n=t[o],i.push(e.clone(n));return i}if(e.isPlainObject(t)){for(a in i={},t)n=t[a],i[a]=e.clone(n);return i}return t},equals:function(t,i){var a,n,o,l,r;if(t===i)return!0;if(s.isArray(t)){if(!s.isArray(i)||t.length!==i.length)return!1;for(a=l=0,r=t.length;0<=r?l<r:l>r;a=0<=r?++l:--l)if(!e.equals(t[a],i[a]))return!1;return!0}if(e.isPlainObject(t)){if(o=s.size(t),!e.isPlainObject(i)||o!==s.size(i))return!1;for(n in t)if(!e.equals(t[n],i[n]))return!1;return!0}return!1},extend:function(){var t,i,s,n,o,l;for(t=arguments[0],o=0,l=(n=2<=arguments.length?a.call(arguments,1):[]).length;o<l;o++)for(i in s=n[o])e.isPlainObject(t[i])&&e.isPlainObject(s[i])?e.extend(t[i],s[i]):t[i]=e.clone(s[i]);return t},select:function(t,i,a){var n,o,l,r;if(null==a&&(a=[]),l=[],i(t))l.push({path:a,value:t});else if(s.isObject(t))for(o in t)r=t[o],(n=s.clone(a)).push(o),l=l.concat(e.select(r,i,n));return l},set:function(t,e,i){var a,n,o;for(a=(e=s.clone(e)).pop(),n=0,o=e.length;n<o;n++)t=t[e[n]];return t[a]=i},transform:function(t,i,a){var n,o,l,r,c;if(i(t))return a(t);if(s.isArray(t)){for(o=[],r=0,c=t.length;r<c;r++)l=t[r],o.push(e.transform(l,i,a));return o}if(e.isPlainObject(t)){for(n in o={},t)l=t[n],o[n]=e.transform(l,i,a);return o}return t}},t.exports=e}).call(this)},knUx:function(t,e){},koDA:function(t,e){},kqDl:function(t,e){},l7ju:function(t,e){},lNFS:function(t,e){},mlws:function(t,e){},nwg3:function(t,e,i){t.exports=i.p+"static/img/point.95b8c37.png"},oMm1:function(t,e,i){"use strict";(function(t){var s=i("jyVo"),a=i("mtWM"),n=i.n(a),o=i("mw3O"),l=i.n(o),r=[];r.append=function(t){let e=()=>{var t=r.shift();if(!t)return r.running=!1;r.running=!0,t().then(e).catch(e)};this.push(t),this.running||e()};var c={data:()=>({uploadData:new Map,alertTitle:!1,uploadType:".sdpc,.tif,.tiff,.sxs,.png,.jpg,.jpeg,.svs,.kfb,.ndpi,image/vms,image/vmu,image/scn,image/bif,.mdsx,.zyp,.tmap,.bif,.czi",startIndex:0,isMounted:!1,loading:!1,userInfo:Object(s.o)(),demoModeValue:"1"===localStorage.getItem("demoMode")||!1}),computed:{count(){return this.isMounted?Math.ceil(this.$refs.sliceTable.bodyWrapper.style.height.slice(0,-2)/45):void 0},loadList(){return this.isMounted?this.record.slices.slice(0,(2+this.startIndex)*this.count):void 0}},destroyed(){this.$refs.sliceTable&&this.$refs.sliceTable.bodyWrapper.removeEventListener("scroll",this.lazyload)},methods:{lazyload(){let t=document.querySelectorAll(".el-autocomplete-suggestion"),e=document.querySelectorAll("input");t.forEach(t=>t.style.display="none"),e.forEach(t=>t.blur());let i=this.$refs.sliceTable.bodyWrapper.scrollTop;if(45*this.loadList.length-Math.ceil(i)-this.$refs.sliceTable.bodyWrapper.style.height.slice(0,-2)<=2){if(this.loadList.length===this.record.slices.length)return;this.startIndex+=1}},uploadAll(){this.record.slices.forEach(t=>{2!==t.state&&3!==t.state||this.upload(t)})},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},alert(t){this.alertTitle=t},addDb(t,e){var i=t.files[0];let a=i.size/1024/1024;var n=new FileReader;a>100?this.$message.error("文件大小不能超过100MB"):(n.onload=(()=>{let t=new FormData;t.append("file",i),Object(s.b)(`files/importDb?caseid=${this.record.id}&fileid=${e.id}`,t).then(t=>{t.code?this.$message.error("上传失败"):this.$message.success("上传成功")})}),n.readAsDataURL(i))},exportDb(e,i){this.loading=!0;let s="json"===i?"/aipath/api/files/exportJson":"/aipath/api/files/exportDb";n()({headers:{"Content-Type":" application/x-www-form-urlencoded"},method:"post",url:s,data:l.a.stringify({fileid:e.id,caseid:this.record.id}),responseType:"blob"}).then(s=>{let a=e.filename.substring(0,e.filename.lastIndexOf("."));if(window.electron){let e=window.electron.remote.require,n=e("fs"),o=e("stream"),l=new Blob([s.data],{type:`application/${i}`}),r=new FileReader;r.readAsDataURL(l),r.onload=(e=>{const{dialog:s}=window.electron.remote;s.showSaveDialog({defaultPath:`${a}.${i}`,title:`导出${i}`,filters:[{name:`.${i}`,extensions:[i]}]}).then(async({filePath:i})=>{if(i){let s=t.from(e.target.result.split("base64,")[1],"base64");const a=new o.PassThrough({allowHalfOpen:!1}).end(s),l=new n.createWriteStream(i);l.on("error",t=>{console.log(t),this.$message.error("导出错误，请重试"),this.loading=!1}).on("finish",()=>{this.loading=!1}),a.pipe(l)}else this.loading=!1})})}else{const t=document.createElement("a");let e=new Blob([s.data],{type:`application/${i}`});t.style.display="none",t.href=URL.createObjectURL(e),t.download=`${a}.${i}`,document.body.appendChild(t),t.click(),document.body.removeChild(t),window.URL.revokeObjectURL(t.href),this.loading=!1}}).catch(t=>{this.$message.error(t)})},async addFiles(t,e="slice"){for(var i of t.files){let t=i.size,s={id:Math.floor(1e7*Math.random())+"",filename:i.name,name:i.name,loaded:0,total:t,stain:"",state:4},a=new FormData;a.append("file",i),a.append("caseid",this.record.id),a.append("fileid",s.id),a.append("type",e),a.type=e,a.path=i.path,"slice"==e?this.record.slices.unshift(s):this.record.attachments.unshift(s),this.uploadData.set(s,a),this.upload(s)}t.value=""},async upload(t){var e=this.uploadData.get(t);t.state=4,t.loaded=0,r.append(async()=>{if(!this.$parent._isDestroyed){if(e.path&&e.path.endsWith(".mrxs")){let i=window.require("fs"),s=window.require("path"),a=window.require("http"),n=e.path.slice(0,-5),{name:o}=s.parse(e.path),l=i.readdirSync(n).map(t=>n+"\\"+t),r=l.map(t=>i.statSync(t).size).reduce((t,e)=>t+e);t.total=r,t.state=0;for(let e of l){if(t.deleted)return;await new Promise(n=>{let{base:l}=s.parse(e),r=i.createReadStream(e),c=a.request({host:location.hostname,port:location.port,path:`/aipath/api/files/upload2?caseid=${this.record.id}&fileid=${t.id}&type=slice&filename=${encodeURIComponent(o+"\\"+l)}&other=${this.config&&this.config.mode?"cs":""}`,headers:{Cookie:document.cookie,"Content-Type":"application/octet-stream","Transfer-Encoding":"chunked",Connection:"keep-alive"}},n);r.pipe(c),r.on("end",e=>c.end()+(t.loaded+=r.bytesRead)),c.on("error",e=>{throw t.state=3,t.loaded=0,console.error(`problem with request: ${e.message}`),e})})}}return t.ajaxToken=Object(s.b)(`files/upload?caseid=${this.record.id}&fileid=${t.id}&type=${e.type}&filename=${t.name}&other=${this.config&&this.config.mode&&"slice"==e.type?"cs":""}&total=${t.total}`,e,{onUploadProgress:e=>{t.deleted?t.ajaxToken.cancel():(t.total=Math.max(t.total,e.total),t.loaded=Math.max(t.loaded,e.loaded),t.state=0)}}),t.ajaxToken.then(e=>{0==e.code?(t.state=1,Object.assign(t,e.data,{total:t.total,loaded:t.loaded}),this.$parent.save()):5==e.code?t.state=5:t.state=2}).catch(e=>{t.state=3,t.loaded=0})}})},del(t){let e=1==t.state||2==t.state?"确定要删除 ("+t.name+") ?":"确定要取消上传 ("+t.name+") ?";this.$confirm(e,{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).then(()=>{t.deleted=!0,Object(s.b)("files/delSlice",{caseid:this.record.id,fileid:t.id}).then(e=>{e.code||(this.record.slices=this.record.slices.filter(e=>e!=t),this.record.attachments=this.record.attachments.filter(e=>e!=t),this.$emit("save"))}).catch(t=>{this.$message.error(t.message)})},()=>{})},stainTypes(t,e){t=t&&t.trim().toLowerCase(),e(this.$t("upload.stainType").filter(e=>!t||e.toLowerCase().indexOf(t)>=0).slice(0,30).map(t=>({value:t})))},next(){this.$emit("next")},prev(){this.$emit("prev")}},mounted(){window.electron&&(this.uploadType=".sdpc,.tif,.tiff,.sxs,.png,.jpg,.jpeg,.svs,.kfb,.ndpi,image/vms,image/vmu,image/scn,image/bif,.mrxs,.mdsx,.zyp,.tmap,.bif,.czi"),window.addEventListener("keydown",function(t){83==t.keyCode&&(navigator.platform.match("Mac")?t.metaKey:t.ctrlKey)&&t.preventDefault()},!1),this.$refs.sliceTable&&setTimeout(t=>{this.$refs.sliceTable.bodyWrapper.addEventListener("scroll",this.lazyload),this.isMounted=!0},0)},props:["record","config"]};e.a=c}).call(e,i("EuP9").Buffer)},obDR:function(t,e){},pbmt:function(t,e){},"pm++":function(t,e){},q0G1:function(t,e){},qGnM:function(t,e){},qNVf:function(t,e){},qU0u:function(t,e){},qpo7:function(t,e,i){"use strict";e.b=function(){return u},e.c=function(t,e){return new Promise(i=>{o.readdir(t,async(s,a)=>{if(s)return console.log("scan error:"+s),i("noDirectory:?"+t);for(let s of a)try{var l=n.join(t,s),r=o.statSync(l);if(r.isDirectory()){let t=n.join(l,"Thumbs");if(o.existsSync(n.join(l,"Slidedat.ini")))l+=".mrxs";else if(o.readdirSync(l).find(t=>t.endsWith(".svs"))&&o.existsSync(n.join(l,"Scan.txt")))l+=".svs";else if(o.existsSync(t)&&o.readdirSync(t).find(t=>t.startsWith("Result-")))l+=".hdx";else{if(!o.readdirSync(l).find(t=>t.endsWith(".mdsx")))continue;l+=".mdsx"}}else if(!o.statSync(l).size)continue;let a=n.extname(l).toLowerCase();if(!d.includes(a))continue;if(await e(l))continue;let u=(new Date).valueOf();if(".mrxs"==a){let t=l.slice(0,-5),e=o.readdirSync(t);if(e.length<18)continue;r=null,e.forEach(e=>{let i=o.statSync(n.join(t,e));(!r||i.mtimeMs>r.mtimeMs)&&(r=i)})}if(".svs"==a&&r.isDirectory()||".hdx"==a){var c=n.join(l.slice(0,-4),"Scan.txt"),h=o.readFileSync(c,"utf8");if(!h.includes("[Images]")){console.log("scan.txt 不存在 Images section, 文件路径："+c);continue}r=o.statSync(c)}if(r.mtimeMs>=u-2e4)continue;return i(l)}catch(t){console.log("scane error2: ",t.message);continue}i(null)})})},e.d=async function(t,e,i,r,d){let p=n.basename(t),v=Object(s.i)(new Date).replace(/[-\s:]/g,"")+Math.floor(1e4*Math.random()),m=Object(s.i)(new Date).replace(/[-\s:]/g,"")+Math.floor(1e4*Math.random());if("mutialg"==e){let t=p.split("_");v=t[0];let i=t[1].split(".")[0].replace(/\-/,"").toLocaleLowerCase();switch(i){case"ki67热区":e="ki67hot";break;default:e=i}h.includes(e)||(e="human")}else if(r&&p.includes("_")){var g=p.trim().indexOf("_");v=p.substring(0,g)}if(t.includes(".mrxs")){let e=o.readFileSync(n.join(t.slice(0,-5),"Slidedat.ini"),"utf-8").split("\n").find(t=>t.includes("SLIDE_NAME"));if(!e)return{};let i=e.substring(e.indexOf("=")+1).trim(),s=i.split(".");s.length>1&&(v=s[0],m=i,slideName=i)}try{console.log("下一步:上传"+t),await async function(t,e,i,r,h,d,p,v){let m,{name:g,dir:f,ext:_}=n.parse(e),y=!1;if(".mdsx"==_||".svs"==_)try{var b=o.statSync(e);b.isDirectory()&&(y=!0)}catch(t){y=!0}try{m=".mrxs"==_||".hdx"==_||".svs"==_&&y||".mdsx"==_&&y?[...function t(e,i){var s=o.readdirSync(e+"\\"+i);var a=[];s.forEach(function(s){if(s.startsWith("Scan.txt")&&!s.endsWith("txt"))return;let n=o.statSync(e+"\\"+i+"\\"+s);n.isDirectory()?a=a.concat(t(e,i+"\\"+s)):a.push({path:i+"\\"+s,file:e+"\\"+i+"\\"+s,size:n.size})});return a}(f,g),{file:"zero",path:i,size:0}]:[{file:e,path:i,size:o.statSync(e).size}]}catch(t){throw console.log("文件、目录读取错误："+t.message),3}let R=0;function C(t){C.rejects.length>0?(console.error("发生错误,重试",t),C.rejects.forEach(t=>t(1))):console.error("居然连reject都还没挂上?那真没办法了",t)}C.rejects=[],electron.remote.process.on("uncaughtException",C);let w=[];for(let{path:e,file:i,size:n}of m){if(w.length>3)try{await Promise.all(w)}catch(t){throw 6==t?6:(console.error("promise里崩了",t),0)}let h;h=new Promise(async function(u,d){let p={host:c||location.hostname,port:location.port,path:`/aipath/api/files/upload2?caseid=${t}&fileid=${r}&type=slice&filename=${encodeURIComponent(e)}&other=${l.mode?"cs":""}&size=${n}`,method:"POST",headers:{Cookie:document.cookie,"Content-Type":"application/octet-stream","Transfer-Encoding":"chunked",Connection:"keep-alive"}};for(;;){let t;try{await new Promise(function(s,n){t=n,C.rejects.push(n);let l=a.request(p,function(t){if(200!=t.statusCode)return console.error("error statusCode:"+t.statusCode)+n(1);t.setEncoding("utf8"),t.on("data",function(t){let i=v.findIndex(t=>decodeURIComponent(t.path).includes(e));v.splice(i,1);try{if(JSON.parse(t).code)return n(0);s()}catch(t){n(1)}})});if(l.on("error",function(t){console.log(`problem with request: ${t.message}`),"socket hang up"===t.message?n(2):n(1)}),v.push(l),o.existsSync(i)){let t=o.createReadStream(i);t.on("error",t=>console.error("stream",t,i)+n(0)),t.pipe(l).on("error",t=>console.error("pip:",t,i))}else console.error("文件丢失:",i),n(0)}),R+=n;break}catch(t){if(console.log("try catch",t),1!=t){if(2==t){d(6);break}console.error("文件错误：",e),d(0);break}console.log("正在等待重试",e),await Object(s.g)(5e3),console.log("正在重试",e)}finally{C.rejects=C.rejects.filter(e=>e!=t)}}w=w.filter(t=>t!=h),u()}),w.push(h)}await Promise.all(w);for(;;)try{u=!0;let a=await Object(s.b)(`files/upload?caseid=${t}&fileid=${r}&filename=${encodeURIComponent(i)}&other=${l.mode?"cs":""}&type=slice&total=${R}&toolType=${h}&company=${Object(s.o)().company}&high_through=1&uploadBatchNumber=${d}&userFilePath=${encodeURIComponent(e)}&cover_slice_number=${p}`,{});if(u=!1,!a)break;if(0!=a.code)throw a;break}catch(t){if(u=!1,1==t.code)throw console.log("丢包的需要重传整个切片"+e),1;if(2==t.code)throw console.log("上传重复"+e),2;if(3==t.code)throw console.log("切片损坏"+e),0;if(5==t.code)throw console.log("剩余磁盘空间不足"),5;await Object(s.g)(5e3),console.log("upload接口失败，重新upload")}}(v,t,p,m,e,i,r,d),console.log("上传完了"+t)}catch(t){if(0==t)return console.log("失败打不开，删除病例"),{option:"failed"};if(2==t)return console.log("repeat"),{option:"repeat"};if(3==t)return console.log("文件、目录读取错误"),{option:"nofile"};if(1==t)return console.log("重传"),{caseid:v,fileid:m,filename:p,option:"reUpload"};if(5==t)return console.log("磁盘满了，重传"),{caseid:v,fileid:m,filename:p,option:"diskFull"};if(6==t)return console.log("用户点击停止终止当前切片上传"),{}}return{caseid:v,fileid:m,filename:p}},e.a=async function(t,e,i,a,n){for(;;)try{return await Object(s.b)("ai/start",{caseid:t,fileid:e,filename:i,type:a,other:a&&(a.includes("tct")||a.includes("lct"))&&l.mode?"cs":"",uploadBatchNumber:n}),0}catch(t){if(1==t.code)return console.log("start：测试账号次数用尽"),1;if(2==t.code)return console.log("start：找不到病理或切片"),2;await Object(s.g)(5e3),console.log("start失败，重新start")}},e.e=async function(t,e,i,a){switch(i){case"pdl1":return async function(t,e,i){if(i)return"error";let a=await Object(s.l)(t,e,"pdl1"),n=((a=a[0].aiResult).pos_tumor/(a.pos_tumor+a.neg_tumor==0?1:a.pos_tumor+a.neg_tumor)*100).toFixed(1);var o=1;n<1?o=-1:n>=25&&(o=0);return{type:o,TPS:n}}(t,e,a);case"her2":return async function(t,e,i){if(i)return"error";let a=await Object(s.l)(t,e,"her2"),n=(a=a[0].aiResult)["分级结果"],o=null;"HER-2 0"==n&&(o=-1);"HER-2 1+"==n&&(o=1);"HER-2 2+"==n&&(o=2);"HER-2 3+"==n&&(o=3);return{type:o,analy:n}}(t,e,a);case"ki67":case"er":case"pr":case"ki67hot":return async function(t,e,i,a){if(a)return"error";let n=await Object(s.l)(t,e,i);return(n.filter(t=>t.image).map(t=>t.aiResult.pos_tumor).reduce((t,e)=>t+e,0)/(n.filter(t=>t.image).map(t=>t.aiResult.total).reduce((t,e)=>t+e,0)||1)*100).toFixed(2)||0}(t,e,i,a);case"tct":case"tct1":case"tct2":case"lct":case"lct1":case"lct2":case"dna":return async function(t,e,i,a){if(a)return{type:2,analy:"处理异常"};try{let a=await async function(t,e,i){return new Promise(a=>{Object(s.b)(`slice/getROIList?companyid=${Object(s.o)().company}`,{caseid:t,fileid:e,ai_type:i,other:l.mode?"cs":""}).then(({data:t})=>{t.ROIS.length?a(t.ROIS[0].aiResult):a({diagnosis:[""]})}).catch(()=>a({diagnosis:[""]}))})}(t,e,i),n=a.diagnosis[0];return"阳性"==n?{type:0,analy:"阳性"}:"阴性"==n?{type:1,analy:"阴性"}:{type:2,analy:"处理异常"}}catch(t){return{type:2,analy:"处理异常"}}}(t,e,i,a);default:return async function(t,e,i,a){if(a)return"error";let n="";try{Object(s.b)(`slice/getROIList?companyid=${Object(s.o)().company}`,{caseid:t,fileid:e,ai_type:i}).then(()=>{}).catch(t=>n=null)}catch(t){return 0}return n||0}(t,e,i,a)}};var s=i("jyVo");let a,n,o,l,r,c,h=Object(s.o)().model_lis?JSON.parse(Object(s.o)().model_lis).concat(["human"]):[].concat(["human"]),u=!1;if(window.electron){let t=window.location.protocol.replace(":",""),e=window.electron.remote.require;a=e(t),r=e("dns"),n=e("path"),o=e("fs"),l=JSON.parse(o.readFileSync("config.json").toString()),t.includes("s")||r.lookup(location.hostname,function(t,e,i){t||(c=e)})}const d=[".svs",".tiff",".vmu",".ndpi",".mrxs",".svslide",".kfb",".scn",".vms",".svslide",".jpg",".jpeg",".png",".sdpc",".tif",".mdsx",".hdx",".zyp",".tmap",".bif",".czi"]},r8Ek:function(t,e,i){t.exports=i.p+"static/img/sow.399667a.gif"},rMce:function(t,e){},rN2d:function(t,e,i){t.exports=i.p+"static/img/关闭.1dc3b03.svg"},rNPa:function(t,e){},rdLu:function(t,e,i){(function(){var i=this,s=i._,a={},n=Array.prototype,o=Object.prototype,l=Function.prototype,r=n.push,c=n.slice,h=n.concat,u=o.toString,d=o.hasOwnProperty,p=n.forEach,v=n.map,m=n.reduce,g=n.reduceRight,f=n.filter,_=n.every,y=n.some,b=n.indexOf,R=n.lastIndexOf,C=Array.isArray,w=Object.keys,k=l.bind,x=function(t){return t instanceof x?t:this instanceof x?void(this._wrapped=t):new x(t)};void 0!==t&&t.exports&&(e=t.exports=x),e._=x,x.VERSION="1.4.4";var $=x.each=x.forEach=function(t,e,i){if(null!=t)if(p&&t.forEach===p)t.forEach(e,i);else if(t.length===+t.length){for(var s=0,n=t.length;s<n;s++)if(e.call(i,t[s],s,t)===a)return}else for(var o in t)if(x.has(t,o)&&e.call(i,t[o],o,t)===a)return};x.map=x.collect=function(t,e,i){var s=[];return null==t?s:v&&t.map===v?t.map(e,i):($(t,function(t,a,n){s[s.length]=e.call(i,t,a,n)}),s)};var I="Reduce of empty array with no initial value";x.reduce=x.foldl=x.inject=function(t,e,i,s){var a=arguments.length>2;if(null==t&&(t=[]),m&&t.reduce===m)return s&&(e=x.bind(e,s)),a?t.reduce(e,i):t.reduce(e);if($(t,function(t,n,o){a?i=e.call(s,i,t,n,o):(i=t,a=!0)}),!a)throw new TypeError(I);return i},x.reduceRight=x.foldr=function(t,e,i,s){var a=arguments.length>2;if(null==t&&(t=[]),g&&t.reduceRight===g)return s&&(e=x.bind(e,s)),a?t.reduceRight(e,i):t.reduceRight(e);var n=t.length;if(n!==+n){var o=x.keys(t);n=o.length}if($(t,function(l,r,c){r=o?o[--n]:--n,a?i=e.call(s,i,t[r],r,c):(i=t[r],a=!0)}),!a)throw new TypeError(I);return i},x.find=x.detect=function(t,e,i){var s;return O(t,function(t,a,n){if(e.call(i,t,a,n))return s=t,!0}),s},x.filter=x.select=function(t,e,i){var s=[];return null==t?s:f&&t.filter===f?t.filter(e,i):($(t,function(t,a,n){e.call(i,t,a,n)&&(s[s.length]=t)}),s)},x.reject=function(t,e,i){return x.filter(t,function(t,s,a){return!e.call(i,t,s,a)},i)},x.every=x.all=function(t,e,i){e||(e=x.identity);var s=!0;return null==t?s:_&&t.every===_?t.every(e,i):($(t,function(t,n,o){if(!(s=s&&e.call(i,t,n,o)))return a}),!!s)};var O=x.some=x.any=function(t,e,i){e||(e=x.identity);var s=!1;return null==t?s:y&&t.some===y?t.some(e,i):($(t,function(t,n,o){if(s||(s=e.call(i,t,n,o)))return a}),!!s)};x.contains=x.include=function(t,e){return null!=t&&(b&&t.indexOf===b?-1!=t.indexOf(e):O(t,function(t){return t===e}))},x.invoke=function(t,e){var i=c.call(arguments,2),s=x.isFunction(e);return x.map(t,function(t){return(s?e:t[e]).apply(t,i)})},x.pluck=function(t,e){return x.map(t,function(t){return t[e]})},x.where=function(t,e,i){return x.isEmpty(e)?i?null:[]:x[i?"find":"filter"](t,function(t){for(var i in e)if(e[i]!==t[i])return!1;return!0})},x.findWhere=function(t,e){return x.where(t,e,!0)},x.max=function(t,e,i){if(!e&&x.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.max.apply(Math,t);if(!e&&x.isEmpty(t))return-1/0;var s={computed:-1/0,value:-1/0};return $(t,function(t,a,n){var o=e?e.call(i,t,a,n):t;o>=s.computed&&(s={value:t,computed:o})}),s.value},x.min=function(t,e,i){if(!e&&x.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.min.apply(Math,t);if(!e&&x.isEmpty(t))return 1/0;var s={computed:1/0,value:1/0};return $(t,function(t,a,n){var o=e?e.call(i,t,a,n):t;o<s.computed&&(s={value:t,computed:o})}),s.value},x.shuffle=function(t){var e,i=0,s=[];return $(t,function(t){e=x.random(i++),s[i-1]=s[e],s[e]=t}),s};var S=function(t){return x.isFunction(t)?t:function(e){return e[t]}};x.sortBy=function(t,e,i){var s=S(e);return x.pluck(x.map(t,function(t,e,a){return{value:t,index:e,criteria:s.call(i,t,e,a)}}).sort(function(t,e){var i=t.criteria,s=e.criteria;if(i!==s){if(i>s||void 0===i)return 1;if(i<s||void 0===s)return-1}return t.index<e.index?-1:1}),"value")};var A=function(t,e,i,s){var a={},n=S(e||x.identity);return $(t,function(e,o){var l=n.call(i,e,o,t);s(a,l,e)}),a};x.groupBy=function(t,e,i){return A(t,e,i,function(t,e,i){(x.has(t,e)?t[e]:t[e]=[]).push(i)})},x.countBy=function(t,e,i){return A(t,e,i,function(t,e){x.has(t,e)||(t[e]=0),t[e]++})},x.sortedIndex=function(t,e,i,s){for(var a=(i=null==i?x.identity:S(i)).call(s,e),n=0,o=t.length;n<o;){var l=n+o>>>1;i.call(s,t[l])<a?n=l+1:o=l}return n},x.toArray=function(t){return t?x.isArray(t)?c.call(t):t.length===+t.length?x.map(t,x.identity):x.values(t):[]},x.size=function(t){return null==t?0:t.length===+t.length?t.length:x.keys(t).length},x.first=x.head=x.take=function(t,e,i){if(null!=t)return null==e||i?t[0]:c.call(t,0,e)},x.initial=function(t,e,i){return c.call(t,0,t.length-(null==e||i?1:e))},x.last=function(t,e,i){if(null!=t)return null==e||i?t[t.length-1]:c.call(t,Math.max(t.length-e,0))},x.rest=x.tail=x.drop=function(t,e,i){return c.call(t,null==e||i?1:e)},x.compact=function(t){return x.filter(t,x.identity)};var T=function(t,e,i){return $(t,function(t){x.isArray(t)?e?r.apply(i,t):T(t,e,i):i.push(t)}),i};x.flatten=function(t,e){return T(t,e,[])},x.without=function(t){return x.difference(t,c.call(arguments,1))},x.uniq=x.unique=function(t,e,i,s){x.isFunction(e)&&(s=i,i=e,e=!1);var a=i?x.map(t,i,s):t,n=[],o=[];return $(a,function(i,s){(e?s&&o[o.length-1]===i:x.contains(o,i))||(o.push(i),n.push(t[s]))}),n},x.union=function(){return x.uniq(h.apply(n,arguments))},x.intersection=function(t){var e=c.call(arguments,1);return x.filter(x.uniq(t),function(t){return x.every(e,function(e){return x.indexOf(e,t)>=0})})},x.difference=function(t){var e=h.apply(n,c.call(arguments,1));return x.filter(t,function(t){return!x.contains(e,t)})},x.zip=function(){for(var t=c.call(arguments),e=x.max(x.pluck(t,"length")),i=new Array(e),s=0;s<e;s++)i[s]=x.pluck(t,""+s);return i},x.object=function(t,e){if(null==t)return{};for(var i={},s=0,a=t.length;s<a;s++)e?i[t[s]]=e[s]:i[t[s][0]]=t[s][1];return i},x.indexOf=function(t,e,i){if(null==t)return-1;var s=0,a=t.length;if(i){if("number"!=typeof i)return t[s=x.sortedIndex(t,e)]===e?s:-1;s=i<0?Math.max(0,a+i):i}if(b&&t.indexOf===b)return t.indexOf(e,i);for(;s<a;s++)if(t[s]===e)return s;return-1},x.lastIndexOf=function(t,e,i){if(null==t)return-1;var s=null!=i;if(R&&t.lastIndexOf===R)return s?t.lastIndexOf(e,i):t.lastIndexOf(e);for(var a=s?i:t.length;a--;)if(t[a]===e)return a;return-1},x.range=function(t,e,i){arguments.length<=1&&(e=t||0,t=0),i=arguments[2]||1;for(var s=Math.max(Math.ceil((e-t)/i),0),a=0,n=new Array(s);a<s;)n[a++]=t,t+=i;return n},x.bind=function(t,e){if(t.bind===k&&k)return k.apply(t,c.call(arguments,1));var i=c.call(arguments,2);return function(){return t.apply(e,i.concat(c.call(arguments)))}},x.partial=function(t){var e=c.call(arguments,1);return function(){return t.apply(this,e.concat(c.call(arguments)))}},x.bindAll=function(t){var e=c.call(arguments,1);return 0===e.length&&(e=x.functions(t)),$(e,function(e){t[e]=x.bind(t[e],t)}),t},x.memoize=function(t,e){var i={};return e||(e=x.identity),function(){var s=e.apply(this,arguments);return x.has(i,s)?i[s]:i[s]=t.apply(this,arguments)}},x.delay=function(t,e){var i=c.call(arguments,2);return setTimeout(function(){return t.apply(null,i)},e)},x.defer=function(t){return x.delay.apply(x,[t,1].concat(c.call(arguments,1)))},x.throttle=function(t,e){var i,s,a,n,o=0,l=function(){o=new Date,a=null,n=t.apply(i,s)};return function(){var r=new Date,c=e-(r-o);return i=this,s=arguments,c<=0?(clearTimeout(a),a=null,o=r,n=t.apply(i,s)):a||(a=setTimeout(l,c)),n}},x.debounce=function(t,e,i){var s,a;return function(){var n=this,o=arguments,l=i&&!s;return clearTimeout(s),s=setTimeout(function(){s=null,i||(a=t.apply(n,o))},e),l&&(a=t.apply(n,o)),a}},x.once=function(t){var e,i=!1;return function(){return i?e:(i=!0,e=t.apply(this,arguments),t=null,e)}},x.wrap=function(t,e){return function(){var i=[t];return r.apply(i,arguments),e.apply(this,i)}},x.compose=function(){var t=arguments;return function(){for(var e=arguments,i=t.length-1;i>=0;i--)e=[t[i].apply(this,e)];return e[0]}},x.after=function(t,e){return t<=0?e():function(){if(--t<1)return e.apply(this,arguments)}},x.keys=w||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var i in t)x.has(t,i)&&(e[e.length]=i);return e},x.values=function(t){var e=[];for(var i in t)x.has(t,i)&&e.push(t[i]);return e},x.pairs=function(t){var e=[];for(var i in t)x.has(t,i)&&e.push([i,t[i]]);return e},x.invert=function(t){var e={};for(var i in t)x.has(t,i)&&(e[t[i]]=i);return e},x.functions=x.methods=function(t){var e=[];for(var i in t)x.isFunction(t[i])&&e.push(i);return e.sort()},x.extend=function(t){return $(c.call(arguments,1),function(e){if(e)for(var i in e)t[i]=e[i]}),t},x.pick=function(t){var e={},i=h.apply(n,c.call(arguments,1));return $(i,function(i){i in t&&(e[i]=t[i])}),e},x.omit=function(t){var e={},i=h.apply(n,c.call(arguments,1));for(var s in t)x.contains(i,s)||(e[s]=t[s]);return e},x.defaults=function(t){return $(c.call(arguments,1),function(e){if(e)for(var i in e)null==t[i]&&(t[i]=e[i])}),t},x.clone=function(t){return x.isObject(t)?x.isArray(t)?t.slice():x.extend({},t):t},x.tap=function(t,e){return e(t),t};var M=function(t,e,i,s){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return t===e;t instanceof x&&(t=t._wrapped),e instanceof x&&(e=e._wrapped);var a=u.call(t);if(a!=u.call(e))return!1;switch(a){case"[object String]":return t==String(e);case"[object Number]":return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case"[object Date]":case"[object Boolean]":return+t==+e;case"[object RegExp]":return t.source==e.source&&t.global==e.global&&t.multiline==e.multiline&&t.ignoreCase==e.ignoreCase}if("object"!=typeof t||"object"!=typeof e)return!1;for(var n=i.length;n--;)if(i[n]==t)return s[n]==e;i.push(t),s.push(e);var o=0,l=!0;if("[object Array]"==a){if(l=(o=t.length)==e.length)for(;o--&&(l=M(t[o],e[o],i,s)););}else{var r=t.constructor,c=e.constructor;if(r!==c&&!(x.isFunction(r)&&r instanceof r&&x.isFunction(c)&&c instanceof c))return!1;for(var h in t)if(x.has(t,h)&&(o++,!(l=x.has(e,h)&&M(t[h],e[h],i,s))))break;if(l){for(h in e)if(x.has(e,h)&&!o--)break;l=!o}}return i.pop(),s.pop(),l};x.isEqual=function(t,e){return M(t,e,[],[])},x.isEmpty=function(t){if(null==t)return!0;if(x.isArray(t)||x.isString(t))return 0===t.length;for(var e in t)if(x.has(t,e))return!1;return!0},x.isElement=function(t){return!(!t||1!==t.nodeType)},x.isArray=C||function(t){return"[object Array]"==u.call(t)},x.isObject=function(t){return t===Object(t)},$(["Arguments","Function","String","Number","Date","RegExp"],function(t){x["is"+t]=function(e){return u.call(e)=="[object "+t+"]"}}),x.isArguments(arguments)||(x.isArguments=function(t){return!(!t||!x.has(t,"callee"))}),x.isFunction=function(t){return"function"==typeof t},x.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},x.isNaN=function(t){return x.isNumber(t)&&t!=+t},x.isBoolean=function(t){return!0===t||!1===t||"[object Boolean]"==u.call(t)},x.isNull=function(t){return null===t},x.isUndefined=function(t){return void 0===t},x.has=function(t,e){return d.call(t,e)},x.noConflict=function(){return i._=s,this},x.identity=function(t){return t},x.times=function(t,e,i){for(var s=Array(t),a=0;a<t;a++)s[a]=e.call(i,a);return s},x.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))};var j={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};j.unescape=x.invert(j.escape);var F={escape:new RegExp("["+x.keys(j.escape).join("")+"]","g"),unescape:new RegExp("("+x.keys(j.unescape).join("|")+")","g")};x.each(["escape","unescape"],function(t){x[t]=function(e){return null==e?"":(""+e).replace(F[t],function(e){return j[t][e]})}}),x.result=function(t,e){if(null==t)return null;var i=t[e];return x.isFunction(i)?i.call(t):i},x.mixin=function(t){$(x.functions(t),function(e){var i=x[e]=t[e];x.prototype[e]=function(){var t=[this._wrapped];return r.apply(t,arguments),H.call(this,i.apply(x,t))}})};var P=0;x.uniqueId=function(t){var e=++P+"";return t?t+e:e},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var E=/(.)^/,L={"'":"'","\\":"\\","\r":"r","\n":"n","\t":"t","\u2028":"u2028","\u2029":"u2029"},D=/\\|'|\r|\n|\t|\u2028|\u2029/g;x.template=function(t,e,i){var s;i=x.defaults({},i,x.templateSettings);var a=new RegExp([(i.escape||E).source,(i.interpolate||E).source,(i.evaluate||E).source].join("|")+"|$","g"),n=0,o="__p+='";t.replace(a,function(e,i,s,a,l){return o+=t.slice(n,l).replace(D,function(t){return"\\"+L[t]}),i&&(o+="'+\n((__t=("+i+"))==null?'':_.escape(__t))+\n'"),s&&(o+="'+\n((__t=("+s+"))==null?'':__t)+\n'"),a&&(o+="';\n"+a+"\n__p+='"),n=l+e.length,e}),o+="';\n",i.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{s=new Function(i.variable||"obj","_",o)}catch(t){throw t.source=o,t}if(e)return s(e,x);var l=function(t){return s.call(this,t,x)};return l.source="function("+(i.variable||"obj")+"){\n"+o+"}",l},x.chain=function(t){return x(t).chain()};var H=function(t){return this._chain?x(t).chain():t};x.mixin(x),$(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=n[t];x.prototype[t]=function(){var i=this._wrapped;return e.apply(i,arguments),"shift"!=t&&"splice"!=t||0!==i.length||delete i[0],H.call(this,i)}}),$(["concat","join","slice"],function(t){var e=n[t];x.prototype[t]=function(){return H.call(this,e.apply(this._wrapped,arguments))}}),x.extend(x.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this)},rjQe:function(t,e){},"rwp+":function(t,e){},sBcn:function(t,e){},sOR5:function(t,e){var i={}.toString;t.exports=Array.isArray||function(t){return"[object Array]"==i.call(t)}},ssjl:function(t,e){},tdau:function(t,e){},uBBm:function(t,e){},uVHs:function(t,e,i){"use strict";var s={props:["slices","ifstopcut"],data:()=>({})},a={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticStyle:{position:"relative"}},[s("div",{staticClass:"analyze"},[s("h3",{staticClass:"title"},[t._v("智能切片分析中...")]),t._v(" "),s("div",{staticClass:"analyze-box"},[s("div",[s("div",{staticClass:"analyze-video"},[s("b",{staticClass:"corner1"}),t._v(" "),s("b",{staticClass:"corner2"}),t._v(" "),s("div",[s("transition-group",{attrs:{name:"slide"}},[t.slices[0]&&!t.ifstopcut?s("div",{key:t.slices[0],staticClass:"videobox"},[s("img",{attrs:{src:i("igVU"),alt:""}})]):t._e()])],1)]),t._v(" "),t.slices.length?s("div",{staticClass:"slices-list"},[s("transition-group",{attrs:{name:"out",appear:""}},t._l(t.slices,function(e,a){return s("div",{key:e,style:{top:57*a+"px"}},[s("span",{staticClass:"fl",attrs:{title:e.replace(/\\/g,"/").substring(e.replace(/\\/g,"/").lastIndexOf("/")+1,e.length)}},[t._v(t._s(e.replace(/\\/g,"/").substring(e.replace(/\\/g,"/").lastIndexOf("/")+1,e.length)))]),t._v(" "),t.ifstopcut?t._e():s("span",{staticClass:"fr"},[s("img",{attrs:{src:i("dE9I"),alt:""}}),t._v("已完成扫描正在分析中\n              ")]),t._v(" "),t.ifstopcut?s("span",{staticClass:"fr"},[s("img",{attrs:{src:i("EPE3"),alt:""}}),t._v("暂停分析中\n              ")]):t._e()])}),0)],1):s("h4",[s("img",{attrs:{src:i("ZOtu"),alt:""}}),t._v(" 您好！暂时还没有可分析的切片！\n        ")])])])])])},staticRenderFns:[]};var n=i("VU/8")(s,a,!1,function(t){i("PRl9")},"data-v-32603a78",null);e.a=n.exports},ufj2:function(t,e){},ujcs:function(t,e){e.read=function(t,e,i,s,a){var n,o,l=8*a-s-1,r=(1<<l)-1,c=r>>1,h=-7,u=i?a-1:0,d=i?-1:1,p=t[e+u];for(u+=d,n=p&(1<<-h)-1,p>>=-h,h+=l;h>0;n=256*n+t[e+u],u+=d,h-=8);for(o=n&(1<<-h)-1,n>>=-h,h+=s;h>0;o=256*o+t[e+u],u+=d,h-=8);if(0===n)n=1-c;else{if(n===r)return o?NaN:1/0*(p?-1:1);o+=Math.pow(2,s),n-=c}return(p?-1:1)*o*Math.pow(2,n-s)},e.write=function(t,e,i,s,a,n){var o,l,r,c=8*n-a-1,h=(1<<c)-1,u=h>>1,d=23===a?Math.pow(2,-24)-Math.pow(2,-77):0,p=s?0:n-1,v=s?1:-1,m=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(l=isNaN(e)?1:0,o=h):(o=Math.floor(Math.log(e)/Math.LN2),e*(r=Math.pow(2,-o))<1&&(o--,r*=2),(e+=o+u>=1?d/r:d*Math.pow(2,1-u))*r>=2&&(o++,r/=2),o+u>=h?(l=0,o=h):o+u>=1?(l=(e*r-1)*Math.pow(2,a),o+=u):(l=e*Math.pow(2,u-1)*Math.pow(2,a),o=0));a>=8;t[i+p]=255&l,p+=v,l/=256,a-=8);for(o=o<<a|l,c+=a;c>0;t[i+p]=255&o,p+=v,o/=256,c-=8);t[i+p-v]|=128*m}},umLD:function(t,e,i){"use strict";var s=i("jyVo"),a={props:["info","opinions"],data(){return this.info.REG={opinion:this.opinions}},methods:{changeValue(){this.$emit("sendValue",this.opinion)},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")}},watch:{opinions:{immediate:!0,deep:!0,handler(t){this.opinion=t}}}},n={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{staticClass:"opinion"},[i("h4",{staticClass:"title"},[t._v(t._s(t.$t("report.point")))]),t._v(" "),i("div",{staticClass:"opinion-write"},[i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.opinion,expression:"opinion"}],attrs:{spellcheck:"false",name:"",id:"",maxlength:"300",cols:"30",rows:"10",placeholder:t.$t("report.pointremind")},domProps:{value:t.opinion},on:{change:t.changeValue,input:[function(e){e.target.composing||(t.opinion=e.target.value)},t.noEmoji]}})])])])},staticRenderFns:[]};var o=i("VU/8")(a,n,!1,function(t){i("h5LH")},"data-v-4878c4e5",null).exports,l={props:["info","opinions","firstSlice"],data(){return this.info.LCT={isStatisfied:"number"==typeof this.firstSlice.slide_quality?this.firstSlice.slide_quality>0?"1":"0":"",cellNum:"number"==typeof this.firstSlice.cell_num?this.firstSlice.cell_num>5e3?"greater":"less":"",cervicalCanalCells:"",metaplasticCells:"",inflammatoryCells:"",erythrocyte:"",cataplasia:"",intrauterineDevice:"",radiotherapy:"",selectopinion:"",opinion:this.opinions,options:["未见上皮内病变细胞或恶性细胞（NILM）","意义不明确的非典型鳞状细胞（ASC-US）","不除外高级别鳞状上皮内病变细胞的非典型鳞状细胞（ASC-H）","低级别鳞状上皮内病变（LSIL）","高级别鳞状上皮内病变（HSIL）","鳞状细胞癌（SCC）","非典型腺细胞（不能明确意义）","非典型腺细胞（倾向瘤变）","颈管原位腺癌（AIS）","腺癌","其他恶性肿瘤"],pathogen:[]}},methods:{changeValue(t){"string"==typeof t&&(this.opinion=t),this.$emit("sendValue",this.opinion)},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")}},mounted(){this.info.LCT.opinion=this.opinions,this.$nextTick(()=>{if(this.firstSlice.alg&&(this.firstSlice.alg.includes("tct")||this.firstSlice.alg.includes("lct")))if(this.firstSlice.check_result){let t=this.firstSlice.check_result.split(" ")[2];this.info.LCT.pathogen=t?t.split(","):[]}else if(this.firstSlice.ai_suggest){let t=this.firstSlice.ai_suggest.split(" ")[2];this.info.LCT.pathogen=t?t.split(","):[]}})},watch:{opinions:{immediate:!0,deep:!0,handler(t){this.opinion=t}}}},r={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{staticClass:"tct"},[i("h4",{staticClass:"title"},[t._v(t._s(t.$t("basic.sample")))]),t._v(" "),i("div",{staticClass:"tct-text"},[i("div",{staticClass:"left"},[i("div",{staticClass:"seption"},[i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("标本满意度:")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.isStatisfied,callback:function(e){t.isStatisfied=e},expression:"isStatisfied"}},[t._v(t._s(t.$t("report.satisfied")))]),t._v(" "),i("el-radio",{attrs:{label:"0"},model:{value:t.isStatisfied,callback:function(e){t.isStatisfied=e},expression:"isStatisfied"}},[t._v(t._s(t.$t("report.notsatisfied")))])],1),t._v(" "),i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("细胞量:")]),t._v(" "),i("el-radio",{attrs:{label:"greater"},model:{value:t.cellNum,callback:function(e){t.cellNum=e},expression:"cellNum"}},[t._v(">5000")]),t._v(" "),i("el-radio",{attrs:{label:"less"},model:{value:t.cellNum,callback:function(e){t.cellNum=e},expression:"cellNum"}},[t._v("≤5000")])],1),t._v(" "),i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("颈管细胞:")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.cervicalCanalCells,callback:function(e){t.cervicalCanalCells=e},expression:"cervicalCanalCells"}},[t._v("有")]),t._v(" "),i("el-radio",{attrs:{label:"0"},model:{value:t.cervicalCanalCells,callback:function(e){t.cervicalCanalCells=e},expression:"cervicalCanalCells"}},[t._v("无")])],1),t._v(" "),i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("化生细胞:")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.metaplasticCells,callback:function(e){t.metaplasticCells=e},expression:"metaplasticCells"}},[t._v("有")]),t._v(" "),i("el-radio",{attrs:{label:"0"},model:{value:t.metaplasticCells,callback:function(e){t.metaplasticCells=e},expression:"metaplasticCells"}},[t._v("无")])],1)]),t._v(" "),i("div",{staticClass:"seption"},[i("div",{staticClass:"line weight600"},[t._v("\n            炎症以及反应性细胞改变\n          ")]),t._v(" "),i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("炎细胞:")]),t._v(" "),i("el-radio",{attrs:{label:"less"},model:{value:t.inflammatoryCells,callback:function(e){t.inflammatoryCells=e},expression:"inflammatoryCells"}},[t._v("少量")]),t._v(" "),i("el-radio",{attrs:{label:"medium"},model:{value:t.inflammatoryCells,callback:function(e){t.inflammatoryCells=e},expression:"inflammatoryCells"}},[t._v("中量")]),t._v(" "),i("el-radio",{attrs:{label:"more"},model:{value:t.inflammatoryCells,callback:function(e){t.inflammatoryCells=e},expression:"inflammatoryCells"}},[t._v("大量")])],1),t._v(" "),i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("红细胞:")]),t._v(" "),i("el-radio",{attrs:{label:"less"},model:{value:t.erythrocyte,callback:function(e){t.erythrocyte=e},expression:"erythrocyte"}},[t._v("少量")]),t._v(" "),i("el-radio",{attrs:{label:"medium"},model:{value:t.erythrocyte,callback:function(e){t.erythrocyte=e},expression:"erythrocyte"}},[t._v("中量")]),t._v(" "),i("el-radio",{attrs:{label:"more"},model:{value:t.erythrocyte,callback:function(e){t.erythrocyte=e},expression:"erythrocyte"}},[t._v("大量")])],1),t._v(" "),i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("细胞萎缩:")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.cataplasia,callback:function(e){t.cataplasia=e},expression:"cataplasia"}},[t._v("有")]),t._v(" "),i("el-radio",{attrs:{label:"0"},model:{value:t.cataplasia,callback:function(e){t.cataplasia=e},expression:"cataplasia"}},[t._v("无")])],1)]),t._v(" "),i("div",{staticClass:"seption"},[i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("宫内节育器:")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.intrauterineDevice,callback:function(e){t.intrauterineDevice=e},expression:"intrauterineDevice"}},[t._v("有")]),t._v(" "),i("el-radio",{attrs:{label:"0"},model:{value:t.intrauterineDevice,callback:function(e){t.intrauterineDevice=e},expression:"intrauterineDevice"}},[t._v("无")])],1),t._v(" "),i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("放疗:")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.radiotherapy,callback:function(e){t.radiotherapy=e},expression:"radiotherapy"}},[t._v("有")]),t._v(" "),i("el-radio",{attrs:{label:"0"},model:{value:t.radiotherapy,callback:function(e){t.radiotherapy=e},expression:"radiotherapy"}},[t._v("无")])],1)])]),t._v(" "),i("div",{staticClass:"right"},[i("div",{staticClass:"line weight600"},[t._v("微生物:")]),t._v(" "),i("el-checkbox-group",{staticStyle:{display:"inline-block"},model:{value:t.pathogen,callback:function(e){t.pathogen=e},expression:"pathogen"}},t._l(t.$t("report.padthogenArr"),function(t,e){return i("el-checkbox",{key:e,attrs:{label:t}})}),1)],1)])]),t._v(" "),i("div",{staticClass:"opinion"},[i("h4",{staticClass:"title"},[t._v("\n      "+t._s(t.$t("report.point"))+"\n       "),i("el-select",{on:{change:t.changeValue},model:{value:t.info.LCT.selectopinion,callback:function(e){t.$set(t.info.LCT,"selectopinion",e)},expression:"info.LCT.selectopinion"}},t._l(this.info.LCT.options,function(t){return i("el-option",{key:t,attrs:{label:t,value:t}})}),1)],1),t._v(" "),i("div",{staticClass:"opinion-write"},[i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.opinion,expression:"opinion"}],attrs:{spellcheck:"false",name:"",id:"",maxlength:"300",cols:"30",rows:"10",placeholder:"诊断意见"},domProps:{value:t.opinion},on:{change:t.changeValue,input:[function(e){e.target.composing||(t.opinion=e.target.value)},t.noEmoji]}})])])])},staticRenderFns:[]};var c=i("VU/8")(l,r,!1,function(t){i("2Yd2")},"data-v-23754d73",null).exports,h=i("k5KV"),u=i.n(h),d={props:["info","opinions","esdMessage","record"],data(){return this.info.ESD=29==Object.keys(this.info.ESD).length?this.info.ESD:{locationId:"",operativeMethodId:"",specimenIntegrityId:"",mucosalSize:"",numberofLesions:"",others:"",mucosalWidth:"",mucosalHeight:"",grossType:"",histologicalType:"",histologyGrade:"",lauren:"",invasionDepth:"",wettingPattern:"",astricMucosa:"",isCombinedUlcer:"1",isTumorThrombus:"1",isNerveInvasion:"1",horizontalPMH:"1",verticalPVM:"1",PMH:"",PVM:"",uploadData:new Map,src1:"",src2:"",src3:"",opinion:this.opinions,reportBasicId:this.record.basic.caseid,imgData:{}}},methods:{handleInput(t){t.target.value=t.target.value.match(/^\d*(\.?\d{0,1})/g)[0]||null},changeValue(){this.$emit("sendValue",this.opinion)},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")},cleanRecord:t=>Object.assign({},t,{slices:t.slices.filter(t=>1==t.state).map(({id:t,name:e,filename:i})=>({id:t,name:e,filename:i})),attachments:t.attachments.filter(t=>1==t.state)})},created(){var t=[],e=[];this.esdMessage.filter(t=>-1===t.name.indexOf("痕")&&-1===t.name.indexOf("体")).forEach(e=>{e.roilist.map(t=>{t.filename=e.name}),t=[...t,...e.roilist]}),t.filter(t=>t.hasOwnProperty("esdMessage")).forEach(t=>{e=[...e,...t.esdMessage]});var i=t.filter(t=>"rectangle"===t.method)[0];let a=this.record.slices.filter(t=>-1!=t.filename.indexOf("体"))[0];this.src1="/aipath/api/files/slice?x=0&y=0&z=9&caseid="+this.record.id+"&fileid="+a.id+"&companyid="+Object(s.o)().company+"&filename="+encodeURIComponent(a.filename);var n=this.record.attachments.filter(t=>-1!=t.filename.indexOf("大体病变图"));if(0!=n.length&&(this.src2=`/aipath/api/files/attachment?caseid=${this.record.id}&fileid=${n[0].id}&filename=${n[0].name}`),i){let t=this.record.slices.filter(t=>t.filename===i.filename)[0].id;this.src3="/aipath/api/files/ROI?caseid="+this.record.id+"&fileid="+t+"&filename="+encodeURIComponent(i.filename)+"&roi=[["+Math.min.apply(Math,i.path.x)+","+Math.min.apply(Math,i.path.y)+"],["+Math.max.apply(Math,i.path.x)+","+Math.max.apply(Math,i.path.y)+"]] &roiid=rectangle"+(Math.random()+"").substr(2,6)}e.forEach(t=>{"脉管癌栓"===t.title&&(this.isTumorThrombus="0"),"神经侵犯"===t.title&&(this.isNerveInvasion="0")});var o=0,l=e.map(t=>({title:t.title,length:parseFloat(t.iD)})).reduce(function(t,e){return e.title in t?t[e.title]=t[e.title]+e.length:t[e.title]=e.length,o+=e.length,t},{});if(2===Object.keys(l).length&&"高级别上皮内瘤变（包括原位癌）"in l)this.histologicalType=Object.keys(l).find(t=>"高级别上皮内瘤变（包括原位癌）"!==t);else for(var r in l){if(l[r]/o==1&&"高级别上皮内瘤变（包括原位癌）"===r){this.histologicalType="高级别上皮内瘤变（包括原位癌）";break}if(l[r]/o>=.5){this.histologicalType=r+"";break}if(l[r]/o<.5){this.histologicalType="腺癌混合型";break}}var c=t.filter(t=>t.hasOwnProperty("esdMessage")).map(t=>t.esdMessage),h=[];if(c.forEach(t=>{var e=0;t.forEach(t=>{e+=parseFloat(t.iD)}),h.push(e)}),"高级别上皮内瘤变（包括原位癌）"!==this.histologicalType){var d=u.a.clone(c);d.forEach(t=>{t.map((e,i)=>{"高级别上皮内瘤变（包括原位癌）"===e.title&&t.splice(i,1)})}),h=[],d.forEach(t=>{var e=0;t.forEach(t=>{e+=parseFloat(t.iD)}),h.push(e)})}this.mucosalWidth=(Math.max(...h)/1e3).toFixed(2);var p=[],v=[],m=[];this.record.slices.forEach(t=>{t.measure&&(p=[...p,...t.measure.map(t=>t.length)]),t.level_measure&&(v=[...v,...t.level_measure.map(t=>t.length)]),t.verticl_measure&&(m=[...m,...t.verticl_measure.map(t=>t.length)])}),p.length&&(this.mucosalHeight=(Math.max(...p)/1e3).toFixed(2)),v.length&&(this.PMH=(Math.max(...v)/1e3).toFixed(2)),m.length&&(this.PVM=(Math.max(...m)/1e3).toFixed(2))}},p={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{staticClass:"tct"},[i("h4",{staticClass:"title"},[t._v(t._s(t.$t("basic.cancerTypeTitle")))]),t._v(" "),i("table",[i("tr",[i("td",{attrs:{colspan:"3"}},[i("el-row",[i("el-col",{attrs:{span:3}},[i("div",{staticClass:"weight600"},[t._v(t._s(t.$t("report.location"))+":")])]),t._v(" "),i("el-col",{attrs:{span:21}},[i("div",[i("span",{staticClass:"textDecoration"},[t._v(t._s(t.$t(t.locationId)))]),i("br"),t._v(" "),t._l(t.$t("report.esdLocation"),function(e,s){return i("el-radio",{key:s,attrs:{label:e},model:{value:t.locationId,callback:function(e){t.locationId=e},expression:"locationId"}},[t._v(t._s(e)+"\n                                ")])})],2)])],1)],1)]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("el-row",[i("el-col",{attrs:{span:3}},[i("div",{staticClass:"weight600"},[t._v(t._s(t.$t("report.operativeMethods"))+":")])]),t._v(" "),i("el-col",{attrs:{span:21}},[i("div",[i("span",{staticClass:"textDecoration"},[t._v(t._s(t.$t(t.operativeMethodId)))]),i("br"),t._v(" "),t._l(t.$t("report.operativeMethod"),function(e,s){return i("el-radio",{key:s,attrs:{label:e},model:{value:t.operativeMethodId,callback:function(e){t.operativeMethodId=e},expression:"operativeMethodId"}},[t._v(t._s(e)+"\n                                ")])})],2)])],1)],1)]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("el-row",[i("el-col",{attrs:{span:3}},[i("div",{staticClass:"weight600"},[t._v(t._s(t.$t("report.specimenCompleteness"))+":")])]),t._v(" "),i("el-col",{attrs:{span:21}},[i("div",[i("span",{staticClass:"textDecoration"},[t._v(t._s(t.$t(t.specimenIntegrityId)))]),i("br"),t._v(" "),t._l(t.$t("report.specimenIntegrity"),function(e,s){return i("el-radio",{key:s,attrs:{label:e},model:{value:t.specimenIntegrityId,callback:function(e){t.specimenIntegrityId=e},expression:"specimenIntegrityId"}},[t._v(t._s(e)+"\n                                ")])})],2)])],1)],1)]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("el-row",[i("el-col",{attrs:{span:3}},[i("div",{staticClass:"weight600"},[t._v(t._s(t.$t("report.mucosalSize"))+":")])]),t._v(" "),i("el-col",{attrs:{span:19}},[i("div",[i("input",{directives:[{name:"model",rawName:"v-model",value:t.mucosalSize,expression:"mucosalSize"}],staticClass:"textDecoration",attrs:{type:"text"},domProps:{value:t.mucosalSize},on:{keydown:t.handleInput,input:function(e){e.target.composing||(t.mucosalSize=e.target.value)}}}),t._v(" mm\n                            ")])])],1)],1)]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("el-row",[i("el-col",{attrs:{span:3}},[i("div",{staticClass:"weight600"},[t._v(t._s(t.$t("report.numberofLesions"))+":")])]),t._v(" "),i("el-col",{attrs:{span:19}},[i("div",[i("input",{directives:[{name:"model",rawName:"v-model",value:t.numberofLesions,expression:"numberofLesions"}],staticClass:"textDecoration",attrs:{type:"text"},domProps:{value:t.numberofLesions},on:{input:function(e){e.target.composing||(t.numberofLesions=e.target.value)}}})])])],1)],1)]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("el-row",[i("el-col",{attrs:{span:3}},[i("div",{staticClass:"weight600"},[t._v(t._s(t.$t("report.lesionRange"))+":")])]),t._v(" "),i("el-col",{attrs:{span:19}},[i("div",{staticStyle:{"padding-left":"8px"}},[t._v("\n                                宽度"),i("input",{directives:[{name:"model",rawName:"v-model",value:t.mucosalWidth,expression:"mucosalWidth"}],staticClass:"textDecoration",attrs:{type:"text"},domProps:{value:t.mucosalWidth},on:{keydown:t.handleInput,input:function(e){e.target.composing||(t.mucosalWidth=e.target.value)}}}),t._v(" mm\n                                 深度"),i("input",{directives:[{name:"model",rawName:"v-model",value:t.mucosalHeight,expression:"mucosalHeight"}],staticClass:"textDecoration",attrs:{type:"text"},domProps:{value:t.mucosalHeight},on:{keydown:t.handleInput,input:function(e){e.target.composing||(t.mucosalHeight=e.target.value)}}}),t._v(" mm\n                            ")])])],1)],1)]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("el-row",[i("el-col",{attrs:{span:3}},[i("div",{staticClass:"weight600"},[t._v(t._s(t.$t("report.grossType"))+":")])]),t._v(" "),i("el-col",{attrs:{span:19}},[i("div",[i("span",{staticClass:"textDecoration"},[t._v(t._s(t.$t(t.grossType)))]),i("br"),t._v(" "),t._l(t.$t("report.grossTypes"),function(e,s){return i("el-radio",{key:s,attrs:{label:e},model:{value:t.grossType,callback:function(e){t.grossType=e},expression:"grossType"}},[t._v(t._s(e)+"\n                                ")])})],2)])],1)],1)]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("el-row",[i("el-col",{attrs:{span:3}},[i("div",{staticClass:"weight600"},[t._v(t._s(t.$t("report.histologicalType"))+":")])]),t._v(" "),i("el-col",{attrs:{span:19}},[i("div",[i("span",{staticClass:"textDecoration",staticStyle:{width:"225px"}},[t._v(t._s(t.$t(t.histologicalType)))]),i("br"),t._v(" "),t._l(t.$t("report.histologicalTypes"),function(e,s){return i("el-radio",{key:s,attrs:{label:e},model:{value:t.histologicalType,callback:function(e){t.histologicalType=e},expression:"histologicalType"}},[t._v(t._s(e)+"\n                                ")])})],2)])],1)],1)]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("el-row",[i("el-col",{attrs:{span:3}},[i("div",{staticClass:"weight600"},[t._v(t._s(t.$t("report.histologyGrade"))+":")])]),t._v(" "),i("el-col",{attrs:{span:19}},[i("div",[i("span",{staticClass:"textDecoration",staticStyle:{width:"225px"}},[t._v(t._s(t.$t(t.histologyGrade)))]),i("br"),t._v(" "),t._l(t.$t("report.histologyGrades"),function(e,s){return i("el-radio",{key:s,attrs:{label:e},model:{value:t.histologyGrade,callback:function(e){t.histologyGrade=e},expression:"histologyGrade"}},[t._v(t._s(e)+"\n                                ")])})],2)])],1)],1)]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("el-row",[i("el-col",{attrs:{span:3}},[i("div",{staticClass:"weight600"},[t._v(t._s(t.$t("report.lauren"))+":")])]),t._v(" "),i("el-col",{attrs:{span:19}},[i("div",[i("span",{staticClass:"textDecoration"},[t._v(t._s(t.$t(t.lauren)))]),i("br"),t._v(" "),t._l(t.$t("report.laurens"),function(e,s){return i("el-radio",{key:s,attrs:{label:e},model:{value:t.lauren,callback:function(e){t.lauren=e},expression:"lauren"}},[t._v(t._s(e)+"\n                                ")])})],2)])],1)],1)]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("el-row",[i("el-col",{attrs:{span:3}},[i("div",{staticClass:"weight600"},[t._v(t._s(t.$t("report.invasionDepth"))+":")])]),t._v(" "),i("el-col",{attrs:{span:19}},[i("div",[i("span",{staticClass:"textDecoration",staticStyle:{width:"225px"}},[t._v(t._s(t.$t(t.invasionDepth)))]),i("br"),t._v(" "),t._l(t.$t("report.invasionDepths"),function(e,s){return i("el-radio",{key:s,attrs:{label:e},model:{value:t.invasionDepth,callback:function(e){t.invasionDepth=e},expression:"invasionDepth"}},[t._v(t._s(e)+"\n                                ")])})],2),t._v(" "),i("span",{staticStyle:{"margin-left":"10px",color:"#E1E1E1"}},[t._v("如垂直切缘（+），则描述：浸润深度（mm）")])])],1)],1)]),t._v(" "),i("tr",[i("td",[i("span",{staticClass:"weight600",staticStyle:{"margin-right":"21px"}},[t._v(t._s(t.$t("report.combinedUlcer"))+":")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.isCombinedUlcer,callback:function(e){t.isCombinedUlcer=e},expression:"isCombinedUlcer"}},[t._v("否")]),t._v(" "),i("el-radio",{attrs:{label:"0"},model:{value:t.isCombinedUlcer,callback:function(e){t.isCombinedUlcer=e},expression:"isCombinedUlcer"}},[t._v("是")])],1)]),t._v(" "),i("tr",[i("td",[i("span",{staticClass:"weight600",staticStyle:{"margin-right":"21px"}},[t._v(t._s(t.$t("report.tumorThrombus"))+":")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.isTumorThrombus,callback:function(e){t.isTumorThrombus=e},expression:"isTumorThrombus"}},[t._v("否")]),t._v(" "),i("el-radio",{attrs:{label:"0"},model:{value:t.isTumorThrombus,callback:function(e){t.isTumorThrombus=e},expression:"isTumorThrombus"}},[t._v("是")])],1)]),t._v(" "),i("tr",[i("td",[i("span",{staticClass:"weight600",staticStyle:{"margin-right":"21px"}},[t._v(t._s(t.$t("report.nerveInvasion"))+":")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.isNerveInvasion,callback:function(e){t.isNerveInvasion=e},expression:"isNerveInvasion"}},[t._v("否")]),t._v(" "),i("el-radio",{attrs:{label:"0"},model:{value:t.isNerveInvasion,callback:function(e){t.isNerveInvasion=e},expression:"isNerveInvasion"}},[t._v("是")])],1)]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("el-row",[i("el-col",{attrs:{span:3}},[i("div",{staticClass:"weight600"},[t._v(t._s(t.$t("report.wettingPattern"))+":")])]),t._v(" "),i("el-col",{attrs:{span:19}},[i("div",[i("span",{staticClass:"textDecoration",staticStyle:{width:"225px"}},[t._v(t._s(t.$t(t.wettingPattern)))]),i("br"),t._v(" "),t._l(t.$t("report.wettingPatterns"),function(e,s){return i("el-radio",{key:s,attrs:{label:e},model:{value:t.wettingPattern,callback:function(e){t.wettingPattern=e},expression:"wettingPattern"}},[t._v(t._s(e)+"\n                                ")])})],2)])],1)],1)]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("el-row",[i("el-col",{attrs:{span:3}},[i("div",{staticClass:"weight600"},[t._v(t._s(t.$t("report.astricMucosa"))+":")])]),t._v(" "),i("el-col",{attrs:{span:19}},[i("div",[i("span",{staticClass:"textDecoration",staticStyle:{width:"225px"}},[t._v(t._s(t.$t(t.astricMucosa)))]),i("br"),t._v(" "),t._l(t.$t("report.astricMucosas"),function(e,s){return i("el-radio",{key:s,attrs:{label:e},model:{value:t.astricMucosa,callback:function(e){t.astricMucosa=e},expression:"astricMucosa"}},[t._v(t._s(e)+"\n                                ")])})],2)])],1)],1)]),t._v(" "),i("tr",[i("td",[i("span",{staticClass:"weight600",staticStyle:{"margin-right":"21px"}},[t._v(t._s(t.$t("report.horizontalPMH"))+":")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.horizontalPMH,callback:function(e){t.horizontalPMH=e},expression:"horizontalPMH"}},[t._v(t._s(t.$t("analyze.negative")))]),t._v(" "),i("span",{staticStyle:{"margin-left":"10px"}},[t._v(t._s(t.$t("report.nearestDistance"))+":")]),t._v(" "),i("input",{directives:[{name:"model",rawName:"v-model",value:t.PMH,expression:"PMH"}],staticClass:"textDecoration",staticStyle:{width:"80px"},attrs:{type:"text"},domProps:{value:t.PMH},on:{keydown:t.handleInput,input:function(e){e.target.composing||(t.PMH=e.target.value)}}}),t._v(" mm(+)\n                    "),i("el-radio",{attrs:{label:"0"},model:{value:t.horizontalPMH,callback:function(e){t.horizontalPMH=e},expression:"horizontalPMH"}},[t._v(t._s(t.$t("analyze.positive")))])],1)]),t._v(" "),i("tr",[i("td",[i("span",{staticClass:"weight600",staticStyle:{"margin-right":"21px"}},[t._v(t._s(t.$t("report.verticalPVM"))+":")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.verticalPVM,callback:function(e){t.verticalPVM=e},expression:"verticalPVM"}},[t._v(t._s(t.$t("analyze.negative")))]),t._v(" "),i("span",{staticStyle:{"margin-left":"10px"}},[t._v(t._s(t.$t("report.nearestDistance"))+":")]),t._v(" "),i("input",{directives:[{name:"model",rawName:"v-model",value:t.PVM,expression:"PVM"}],staticClass:"textDecoration",staticStyle:{width:"80px"},attrs:{type:"text"},domProps:{value:t.PVM},on:{keydown:t.handleInput,input:function(e){e.target.composing||(t.PVM=e.target.value)}}}),t._v(" mm(+)\n                    "),i("el-radio",{attrs:{label:"0"},model:{value:t.verticalPVM,callback:function(e){t.verticalPVM=e},expression:"verticalPVM"}},[t._v(t._s(t.$t("analyze.positive")))])],1)]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("el-row",[i("el-col",{attrs:{span:3}},[i("div",{staticClass:"weight600"},[t._v(t._s(t.$t("report.others"))+":")])]),t._v(" "),i("el-col",{attrs:{span:19}},[i("div",[i("input",{directives:[{name:"model",rawName:"v-model",value:t.others,expression:"others"}],staticClass:"textDecoration",attrs:{type:"text"},domProps:{value:t.others},on:{input:function(e){e.target.composing||(t.others=e.target.value)}}})])])],1)],1)])])]),t._v(" "),i("div",{staticClass:"opinion"},[i("h4",{staticClass:"title"},[t._v(t._s(t.$t("report.remark")))]),t._v(" "),i("div",{staticClass:"opinion-write"},[i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.opinion,expression:"opinion"}],attrs:{spellcheck:"false",name:"",id:"",maxlength:"300",cols:"30",rows:"10",placeholder:"备注"},domProps:{value:t.opinion},on:{change:t.changeValue,input:[function(e){e.target.composing||(t.opinion=e.target.value)},t.noEmoji]}})])]),t._v(" "),i("div",{staticClass:"esdUpload"},[i("div",{staticClass:"esdUploadItem"},[i("div",[t._v("大体原图")]),t._v(" "),""!==t.src1?i("img",{staticClass:"src-slide",attrs:{src:t.src1,alt:""}}):t._e()]),t._v(" "),i("div",{staticClass:"esdUploadItem"},[i("div",[t._v("大体病变图")]),t._v(" "),""!==t.src2?i("img",{staticClass:"src-slide",attrs:{src:t.src2,alt:""}}):t._e()]),t._v(" "),i("div",{staticClass:"esdUploadItem"},[i("div",[t._v("镜下所见")]),t._v(" "),i("img",{staticClass:"src-slide",attrs:{src:t.src3,alt:""}})])])])},staticRenderFns:[]};var v=i("VU/8")(d,p,!1,function(t){i("Ps/q")},"data-v-0d21b90b",null).exports,m={data:()=>({references:['Lin Yang, Peter Meer and David J. Foran, "Unsupervised analysis of imaged pathology specimens based on robust estimation and color active contour models", IEEE Transaction on Information Technology in Biomedicine (TITB), Vol. 9, No. 1, pp. 475-486, 2005.','Oncel Tuzel, Lin Yang, Peter Meer and David J. Foran, "Classification of hematologic malignancies using texton signatures", Pattern Analysis and Applications (PAA), Vol. 10, No. 4, pp. 277-290, 2007.','Lin Yang, Wenjin Chen, Peter Meer, Gratian Salaru, Viktors Berstis and David J. Foran, "Virtual microscopy and grid-enabled decision support for large scale analysis of imaged pathology specimens", IEEE Transaction on Information Technology in Biomedicine (TITB), Vol. 13, No. 4, pp. 636-644, 2009','Lin Yang, Oncel Tuzel, Wenjin Chen, Peter Meer, Gratian Salaru, Lauri A. Goodell and David J. Foran, "PathMiner: A web-based tool for computer assisted diagnostics in pathology", IEEE Transaction on Information Technology in Biomedicine (TITB). Vol. 13, No. 3, pp. 291-299, 2009','Jianqin Qu, Leiguang Gong and Lin Yang, "A 3D point matching algorithm for affine registration", International Journal of Computer Assisted Radiology and Surgery, Vol. 6, No. 2, pp. 229-236, 2010.','Lin Yang, Bogdan Georgescu, Yefeng Zheng, Wang Yang, Peter Meer and Dorin Comaniciu, "Prediction based collaborative trackers (PCT): A robust and accurate approach toward 3D medical object tracking ", IEEE Transaction on Medical Imaging (TMI), Vol. 30, No. 11, pp. 1921-1932, 2011','David J. Foran , Lin Yang, Wenjin Chen, Jun Hu, Lauri A. Goodell, Michael Reiss, Fusheng Wang, Tahsin Kurc, Tony Pan, Ashish Sharma, and Joel Saltz. "Image miner: Comparative analysis of tissue microarrays using content based image retrieval, high performance computing, and Grid technology", Journal of American Medical Information Association (JAMIA), Vol. 18, No. 4, pp. 403-415, 2011','David J. Foran, Wenjin Chen and Lin Yang, "Automated image interpretation computer-assisted diagnosis", Analytical Cellular Pathology, Vol. 34, No. 6, pp. 279-300, 2011','Xin Qi, Fuyong Xing, David J. Foran and Lin Yang, "Robust segmentation of overlapping cells in histopathology specimens using parallel seed detection and repulsive level set ", IEEE Transaction on Biomedical Engineering (TBME), Vol. 59, No. 3, pp. 754-765, 2012',"Rebekah H. Gensure, David J. Foran, Vincent M. Lee, Vyacheslav M Gendal, Salma K Jabbour, Darren R Carpizo, John L. Nosher, and Lin Yang, “Evaluation of hepatic tumor response to yttrium-90 radioembolization therapy using texture signatures generated from contrast-enhanced CT”, Academic Radiology, Vol. 19, No. 10, pp. 1201-1207, 2012.",'Xin Qi, Fuyong Xing, David J. Foran, Lin Yang, "A Fast, Automatic Segmentation Algorithm for Locating and Delineating Touching Cell Boundaries in Imaged Histopathology ", Journal of Methods in Medical Informatics, Vol. 51, No. 3, pp. 91- 102, 2012',"Xin Qi, Hyunjoo Kim, Fuyong Xing, Manish Parashar, David J. Foran, Lin Yang, “The Analysis of Image Feature Robustness Using CometCloud”, Vol. 3. No. 33, pp. 1-13, Journal of Pathology Informatics, 2012.","Baiyang Liu, Junzhou Huang, Casimir Kulikowski, Lin Yang, “Robust Visual Tracking Using Local Sparse Appearance Model and K-selection”, IEEE Transaction on Pattern Analysis and Machine Intelligence (TPAMI), Vol. 35, No. 12, pp. 2968-2981, 2013.","Joythi Mula, Jonah D. Lee, Fujun Liu, Lin Yang, Charlotte A. Peterson, “Automated Image Analysis of Skeletal Muscle Fiber Cross-sectional Area”, Journal of Applied Physiology (JAP), Vol. 114, No. 1, pp. 148-155, 2013.","Fujun Liu, Abigail L. Mackey, Ratchakrit Srikuea, Karyn Esser, Lin Yang, “Automated Image Segmentation of Hemotoxylin and Eosin Stained Skeletal Muscle Cross-Sections”, Journal of Microscopy, Vol. 253, No. 3, pp. 275-285, 2013","Hai Su, Fuyong Xing, Jonah Lee, Charlotte Peterson, Lin Yang, “Automatic Myonuclear Detection in Isolated Single Muscle Fiber Using Robust Ellipse Fitting and Sparse Optimization”, IEEE/ACM Transaction on Computational Biology and Bioinformatics (TCBB), 14 pages, 2013","Fujun Liu, Christopher S. Fry, Jyothi Mula, Janna R. Jackson, Jonah D. Lee, Charlotte A. Peterson, Lin Yang, “Automated Fiber-type-specific Cross-sectional Area Assessment and Myonuclei Counting in Skeletal Muscle”, Journal of Applied Physiology (JAP), Vol. 115, No. 11, pp. 1714-1724, 2013","Lin Yang, Xin Qi, Fuyong Xing, Tahsin Kurc, Joel Saltz, David J. Foran, “Parallel Content Based Sub-image Retrieval Using Hierarchical Searching”, Bioinformatics, Vol. 30, No. 7, pp. 996-1002, 2014",'Hui Meng, Paul M. L. Janssen, Robert W. Grange, Lin Yang, Alan H. Beggs, Lindsay C. Swanson, Stacy A. Cossette, Alison Frase, Martin K. Childers, Henk Granzier, Emanuela Gussoni, Michael W. Lawlor, "Tissue triage and freezing for models of skeletal muscle disease", Journal of Visualized Experiments (JOVE), No. 89, 2014',"Michael W. Lawlor, Marissa G. Viola, Hui Meng, Rachel V. Edelstein, Fujun Liu, Ke Yang, Elizabeth J. Luna, Alexandra Lerch-Gaggl, Raymond G. Hoffmann, Christopher R. Pierson, Anna Buj-Bello, Jennifer L. Lachey, Scott Pearsall, Lin Yang, Cecilia Hillard, Alan H. Beggs, “Differential Muscle Hypertrophy Is Associated With Satellite Cell Numbers And Akt Pathway Activation Following Activin Type IIB Receptor Inhibition In Mtm1 p.R69C Mice”, American Journal of Pathology, Vol. 184, No. 6, pp. 1831-1842, 2014","Hongyuan Wang, Fuyong Xing, Hai Su, Arnold Stromberg, and Lin Yang, “Novel image markers for non-small cell lung cancer classification and survival prediction”, BMC Bioinformatics, Vol. 19, No. 15, pp. 310-324, 2014.","Xin Qi, Daihou Wang, Ivan Rodero, Javier Diaz-Montes, Rebekah H Gensure, Fuyong Xing, Hua Zhong, Lauri Goodell, Manish Parashar, David J Foran, Lin Yang, “Content-based histopathology image retrieval using CometCloud”, BMC Bioinformatics, Vol. 15, pp. 287-300, 2014",'Sandra Donkervoort, Ying Hu, Tanya Stojkovic, Nicol Voermans, A. Reghan Foley, Meganne E Leach, Jahannaz Dastgir, Veronique Bolduc, Thomas Cullup, Alix de Becdelievre, Lin Yang, Hai Su, Katherine Meilleur, Alice Schindler, Erik-Jan Kamsteeg, Pascale Richard, Russell Butterfield, Thomas L. Winder, Thomas Crawford, Robert B. Weiss, Francesco Muntoni, Valerie Allamand, Carsten G. Bonnemann, "Mosaicism for dominant COLVI mutations as a cause for intra-familial phenotypic variability", Human Mutation, Vol. 36, No. 1, pp. 48-56, 2014','Michael Spencer, Lin Yang, Akosua Adu, Brian S. Finlin, Beibei Zhu, Lindsey R. Shipp, Neda Rasouli, Charlotte A. Peterson, Philip Kern, "Pioglitazone treatment reduces adipose tissue inflammation through reduction of mast cell and macrophage number and by improving vascularity", PLOS ONE, Vol. 9, No. 7, 2014.','Nicolas Wein, Adeline Vulin, Maria Sofia Falzarano, Christina Al-Khalili Szigyarto, Baijayanta Maiti, Andrew Findlay, Kristin H. Heller, Mathias Uhlen, Baskar Bakthavachalu, Sonia Messina, Giuseppe Vita, Chiara Passarelli, Francesca Gualandi, Steve D. Wilton, Louise Rodino-Klapec, Lin Yang, Diane M. Dunn, Daniel Schoenberg, Robert B. Weiss, Michael T. Howard, Alessandra Ferlini, Kevin M. Flanigan, "A novel DMD IRES results in a functional N-truncated dystrophin, providing a potential route to therapy for patients with 5’ mutations", Nature Medicine, Vol. 20, No. 9, pp. 992-1000, 2014.',"Fuyong Xing, Hai Su, Janna Neltner, Lin Yang, “Automatic Ki-67 Counting Using Robust Cell Detection and Online Dictionary Learning”, IEEE Transaction on Biomedical Engineering (TBME), Vol. 61, No. 3, pp. 859-870, 2014",'Christopher S. Fry, Jonah D. Lee, Jyothi Mula, Tyler J. Kirby, Janna R. Jackson, Fujun Liu, Lin Yang, Esther E. Dupont-Versteegden, John J. McCarthy, Charlotte A. Peterson, "Inducible depletion of satellite cells in adult, sedentary mice impairs muscle regenerative capacity without affecting sarcopenia", Nature Medicine, Vol. 21, pp. 76-80, 2015.','Xiaofan Zhang, Fuyong Xing, Hai Su, Lin Yang, Shaoting Zhang, "High throughput histopathology image analysis via robust cell segmentation and hashing", Medical Image Analysis, Vol. 26, No. 1, pp. 306-315, 2015.',"Tahsin Kurc, Xin Qi, Daihou Wang, Fusheng Wang, George Teodoro, Lee Cooper, Michael Nalisnik, Lin Yang, Joel Saltz, David J Foran, “Scalable Analysis of Big Pathology Image Data Cohorts using Efficient Methods and High-Performance Computing Strategies”, BMC Bioinformatics, Vol. 16, No. 399, 2015","Hai Su, Fuyong Xing, Lin Yang, “Robust cell detection of histopathological brain tumor images using sparse reconstruction and adaptive dictionary selection”, IEEE Transaction on Medical Imaging, Vol. 35, No. 6, 2016.","Fuyong Xing, Lin Yang, “An automatic learning-based framework for robust nucleus segmentation”, IEEE Transaction on Medical Imaging, Vol. 35, No. 2, pp. 550-566, 2016.","Fuyong Xing, Lin Yang, “Robust nucleus/cell detection and segmentation for digital pathology and microscopic images: A comprehensive review”, IEEE Reviews in Biomedical Engineering, No. 9, pp. 234-263, 2016.","Xiaoshuang Shi, Zhenhuo Guo, Feiping Nie, Lin Yang, Jane You, and Dacheng Tao, “Two-dimensional whitening reconstruction for enhancing robustness of principle component analysis”, IEEE Transaction on Pattern Analysis and Machine Intelligence, Vol. 38, No. 10, pp. 2130-2136, 2016","Manish Sapkota, Fujun Liu, Yuanpu Xie, Hai Su, Fuyong Xing, Lin Yang, “AIIMD: An integrated framework of automatic idiopathic inflammatory myopathy diagnosis for muscle”, IEEE Journal of Biomedical and Health Informatics, 2017","Yuanpu Xie, Fuyong Xing, Xiaoshuang Shi, Xiaofei Kong, Hai Su, Lin Yang, “Efficient and robust cell detection: A structured regression approach”, Medical Image Analysis, 2017","Xiaoshuang Shi, Fuyong Xing, Kaidi Xu, Yuanpu Xie, Hai Su, Lin Yang, “Supervised graph hashing for histopathology image retrieval and classification”, Medical Image Analysis, Vol. 22, pp. 117-128, 2017","Zizhao Zhang, Fuyong Xing, Xiaoshuang Shi, Lin Yang, “Revisiting Graph Construction for Fast Image Segmentation”, Pattern Recognition (PR), 2018","Yuanpu Xie, Fuyong Xing, Lin Yang, “Deep Voting and Structured Regression for Microscopy Image Analysis” In Deep Learning for Medical Image Analysis (pp. 155-175), 2018",'Xiaoshuang Shi, Manish Sapkota, Fuyong Xing, Fujun Liu, Lei Cui, Lin Yang, "Pairwise based deep ranking hashing for histopathology image classification and retrieval", accepted to Pattern Recognition, 2018',"Xiaoshuang Shi, Fuyong Xing, Jinzheng Cai, Lin Yang, “Self-learning for face clustering”, accepted to Pattern Recognition, 2018",'Lin Yang, Peter Meer and David J. Foran, "Multiple class segmentation using a unified framework over mean-shift patches", Proc. IEEE International Conference on Computer Vision and Pattern Recognition (CVPR), Vol. 1, pp. 1-8, June 2007.','Lin Yang, Wenjin Chen, Peter Meer, Gratian Salaru, Michael D. Feldman and David J. Foran, "High throughput analysis of breast cancer specimens on the Grid", Proc. International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Vol. 10, pp. 617-625, 2007.','Lin Yang, Bogdan Georgescu, Yefeng Zheng, David J. Foran and Dorin Comaniciu. "A fast and accurate tracking algorithm of left ventricles in 3D echocardiography", Proc. International Symposium on Biomedical Imaging (ISBI), Vol. 5, pp. 221-224, 2008.','Lin Yang, Bogdan Georgescu, Yefeng Zheng, Peter Meer and Dorin Comaniciu, "3D Ultrasound tracking of the left ventricle using one-step forward prediction and data fusion of collaborative trackers", Proc. IEEE International Conference on Computer Vision and Pattern Recognition (CVPR), Vol. 1, pp. 1-8, 2008.','Lin Yang, Oncel Tuzel, Peter Meer and David J. Foran, "Automatic image analysis of histopathology specimens using concave vertex graph", Proc. International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Vol. 11, pp. 833-841, 2008.','Hong Zhang, Lin Yang, David J. Foran, John Nosher, Peter Yim, "3D segmentation of the liver using free-form deformation based on boosting and deformation gradients", Proc. IEEE International Symposium on Biomedical Imaging (ISBI), Vol. 1, pp. 494-497, 2009.','David J. Foran, Lin Yang, Oncel Tuzel, Wenjin Chen, Jun Hu, Tahsin Kurc, Renato Ferreira, Joel Saltz, "A caGrid-enabled, learning based image segmentation method for histopathology specimens", Proc. IEEE International Symposium on Biomedical Imaging (ISBI), Vol. 1, pp. 1306-1309, 2009.','Baiyang Liu, Lin Yang, Casimir Kulikowski, Jinghao Zhou, Leiguang Gong, David J. Foran, Salma J. Jabbour and Ning J. Yue. "An adaptive tracking algorithm of lung tumors in fluoroscopy using online learned collaborative trackers ", IEEE International Symposium on Biomedical Imaging (ISBI), Vol. 1, pp. 209-212, 2010','Baiyang Liu, Lin Yang, Junzhou Huang, P. Meer, Leiguang Gong, Casimir Kulikowski, "Robust and fast visual tracking with two stage sparse optimization", European Conference on Computer Vision (ECCV), Vol. 6314, pp. 624-637, 2010','Tahsin Kurc, Patrick Widener, Wenjin Chen, Fusheng Wang, Lin Yang, Jun Hu, Vijay Kumar, Vicky Chu, Lee Cooper, Jun Kong, Ashish Sharma, Tony Pan, Joel Saltz, David Foran, "Grid-enabled, high-performance microscopy image analysis", High Performance Computing (HP) workshop associated with Proc. International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Beijing, China, 2010','Xin Qi, Fuyong Xing, David J. Foran and Lin Yang, "GPU enabled parallel touching cell segmentation using mean shift based seed detection and repulsive level set", High Performance Computing (HP) workshop associated with Proc. International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Beijing, China, 2010','Xin Qi, Hyunjoo Kim, Fuyong Xing, Manish Parashar, David Foran and Lin Yang, "The Analysis of Image Texture Feature Robustness Using CometCloud", High Performance Computing (HP) Workshop associated with Proc. International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Toronto, Canada, 2011','Lin Yang, Hyunjoo Kim, Manish Parashar and David Foran, "High Throughput Landmark Based Image Registration Using Cloud Computing", High Performance Computing (HP) workshop associated with Proc. International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Toronto, Canada, 2011','Baiyang Liu, Junzhou Huang, Casimir Kulikowski, Lin Yang, "Robust tracking using local sparse appearance model and K-Selection", Proc. IEEE International Conference on Computer Vision and Pattern Recognition (CVPR), Vol. 1, pp. 1-8, 2011',"Xin Qi, Fuyong Xing, Meghana Ghadge, Ivan Rodero, Moustafa Abdelbaky, Manish Parashar, Evita Sadimin, David Foran, Lin Yang, “Content-based Image Retrieval on Imaged Peripheral Blood Smear Specimens using High Performance Computation”, Data- and Compute-intensive Clinical and Translation Imaging associated with the International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Nice, France, 2012","Fuyong Xing, Xin Qi, David Foran, Tahsin Kurc, Joel Saltz, Lin Yang, “Content-based Parallel Sub-image Retrieval”, Data- and Compute-intensive Clinical and Translation Imaging associated with the International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Nice, France, 2012","Fuyong Xing, Lin Yang, “Robust non-small cell lung cancer classification using molecular morphological features”, International Symposium on Biomedical Imaging (ISBI), 2013","Hai Su, Fuyong Xing, Jonah Lee, Charlotte Peterson, Lin Yang, “Learning based automatic detection of myonuclei in isolated single skeletal muscle fibers using multi-focus image fusion”, International Symposium on Biomedical Imaging (ISBI), 2013","Fuyong Xing, Lin Yang, “Robust Selection-based Sparse Shape Model for Lung Cancer Image Segmentation”, The 16th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Nagoya, Japan, 2013","Fuyong Xing, Hai Su, Lin Yang, “An Integrated Framework for Automatic Ki-67 Scoring in Pancreatic Neuroendocrine Tumor”, The 16th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Nagoya, Japan, 2013","Xin Qi, Daihou Wang, Javier Diaz-Montes, Ivan Rodero, Tony Pan, Abulimit Aji, Lee Cooper, Fuyong Xing, Manish Parashar, David J. Foran, Lin Yang, “Exploring Online Nuclear Segmentation on Large Fluorescence Brain Tumor Images Using CometCloud”, Accepted to the Six High Performance Computing Workshop Associated with The 16th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Nagoya, Japan, 2013","Daihou Wang, Xin Qi, Manish Parashar, David J. Foran, Lin Yang, “High Throughput Content-based Image Retrieval Using GPGPU”, Accepted to the Six High Performance Computing Workshop Associated with The 16th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Nagoya, Japan, 2013","Manish Sapkota, Fujun Liu, Lin Yang, “Distributed Content Based Image Retrieval for Skeletal Muscle Images Using Kd-Tree and MapReduce”, Accepted to the Six High Performance Computing Workshop Associated with The 16th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Nagoya, Japan, 2013","Fujun Liu, Fuyong Xing, Lin Yang, “Robust muscle cell segmentation using region selection with dynamic programming”, Accepted to 2014 International Symposium on Biomedical Imaging (ISBI), 2014","Fujun Liu, Fuyong Xing, Hai Su, Lin Yang, “Touching adipocyte cells decomposition using combinatorial optimization”, Accepted to 2014 International Symposium on Biomedical Imaging (ISBI), 2014","Xiaofan Zhang, Lin Yang, Wei Liu, Hai Su, Shaoting Zhang, “Mining histopathology images via composite hashing and online learning”, Accepted to The 17th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Boston, MA, U. S. A., 2014","Fuyong Xing, Manish Sapkota, Lin Yang, “Histopathology lung cancer image mining with Kd-tree and MapReduce”, Accepted to the Seventh High Performance Computing Workshop Associated with The 16th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Boston, MA, U. S. A. 2014","Daihou Wang, Manuel Diaz Granados, Javier Diaz-Montes, Ivan Rodero, Lin Yang, Manish Parashar, David J. Fordan, Xin Qi, “High-throughput Automatic Gleason-grading System for Prostate Histopathology Images using CometCloud”, Accepted to the Seventh High Performance Computing Workshop Associated with The 16th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Boston, MA, U. S. A. 2014",'Hai Su, Fujun Liu, Yuanpu Xie, Fuyong Xing, Sreenivasan Meyyappan, Lin Yang, "Region segmentation in histopathological breast cancer images using deep convolutional neural network", Accepted to the 2015 International Symposium on Biomedical Imaging (ISBI), 2015','Fuyong Xing, Lin Yang, "Unsupervised shape prior modeling for cell segmentation in neuroendocrine tumor", Accepted to the 2015 International Symposium on Biomedical Imaging (ISBI), 2015','Manish Sapkota, Fuyong Xing, Hai Su, Lin Yang, "Automatic muscle perimysium annotation using deep convolutional neural network", Accepted to the 2015 International Symposium on Biomedical Imaging (ISBI), 2015',"Xiaofan Zhang, Hai Su, Lin Yang, Shaoting Zhang, “Weighted hashing with multiple cues for cell-level analysis of histopathology images”, Accepted to the 2015 International 24th Biennial International Conference on Information Processing in Medical Imaging (IPMI), 2015","Xiaofan Zhang, Hai Su, Lin Yang, Shaoting Zhang, “Scalable analysis of histopathology images via robust cellular segmentation and weighted hashing”, Accepted to the 2015 International Conference on Computer Vision and Patter Recognition (CVPR), 2015","Fuyong Xing, Lin Yang, “Fast Cell Segmentation Using Scalable Sparse Manifold Learning and Affine Transform-approximated Active Contour”, Accepted to The 18th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Munich, Germany, 8 pages, 2015","Fujun Liu, Fuyong Xing, Zizhao Zhang, Mason Mcgough, Lin Yang, “Robust Muscle Cell Quantification Using Structured Edge Detection and Hierarchical Segmentation”, Accepted to The 18th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Munich, Germany, 8 pages, 2015","Fujun Liu, Lin Yang, “A Novel Cell Detection Method Using Deep Convolutional Neural Network and Maximum-Weight Independent Set”, Accepted to The 18th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Munich, Germany, 8 pages, 2015","Yuanpu Xie, Fuyong Xing, Xiangfei Kong, Hai Su, Lin Yang, “Beyond Classification: Structured Regression For Robust Cell Detection Using Convolutional Neural Network”, Accepted to The 18th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Munich, Germany, 8 pages, 2015","Yuanpu Xie, Xiangfei Kong, Fuyong Xing, Fujun Liu, Hai Su, Lin Yang, “Deep Voting: A Robust Approach Towards Nucleus Localization In Microscopy Images”, Accepted to The 18th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Munich, Germany, 8 pages, 2015","Hai Su, Fuyong Xing, Xiangfei Kong, Yuanpu Xie, Shaoting Zhang, Lin Yang, “Robust Cell Detection and Segmentation in Histopathological Images using Sparse Reconstruction and Stacked Denoising Autoencoders”, Accepted to The 18th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Munich, Germany, 8 pages, 2015","Menglin Jiang, Shaoting Zhang, Junzhou Huang, Lin Yang, Dimitris Metaxas, “Joint Kernel-Based Supervised Hashing for Scalable Histopathological Image Analysis”, Accepted to The 18th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Munich, Germany, 8 pages, 2015",'Yuanpu Xie, Zizhao Zhang, Manish Sapkota, Lin Yang, "Spatial Clockwork Recurrent Neural Network for Muscle Perimysium Segmentation", Accepted to The 19th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), 2016.','Fuyong Xing, Xiaoshuang Shi, Zizhao Zhang, Jinzheng Cai, Yuanpu Xie, Lin Yang, "Transfer Shape Priors Towards High-throughput Microscopy Image Segmentation", Accepted to The 19th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), 2016.','Jinzheng Cai, Le Lu, Qian Yin, Zizhao Zhang, Fuyong Xing, Lin Yang, "Pancreas Segmentation using Graph based Data Fusion with Convolutional Neural Networks", Accepted to The 19th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), 2016.','Zizhao Zhang, Fuyong Xing, Xiaoshuang Shi, Lin Yang, "SemiContour: A semi-supervised learning approach for contour detection", IEEE International Conference on Computer Vision and Pattern Recognition (CVPR), 2016','Xiaoshuang Shi, Fuyong Xing, Jinzheng Cai, Zizhao Zhang, Yuanpu Xie, Lin Yang, "Kernel-based supervised discrete hashing for image retrieval", European Conference on Computer Vision (ECCV), 2016.','Zizhao Zhang, Yuanpu, Xie, Fuyong Xing, Mason Mcgough, Lin Yang, "MDNet: A Semantically and Visually Interpretable Medical Image Diagnosis Network", IEEE Conference on Computer Vision and Pattern Recognition (CVPR), 2017 oral (2.7% acceptance rate)','Zizhao Zhang, Pingjun Chen, Manish Sapkota, Lin Yang, "TandemNet: Distilling Knowledge from Medical Images Using Diagnostic Reports as Optional Semantic References", International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), 2017 oral (3.6% acceptance rate)','Xiaoshuang Shi, Fuyong Xing, Kaidi Xu, Manish Sapkota, Lin Yang, "Asymmetric discrete graph hashing", The thirty-first AAAI conference on Artificial Intelligence (AAAI), 2017','Jinzheng Cai, Le Lu, Yuanpu Xie, Fuyong Xing, Lin Yang, "Improving deep pancreas segmentation in CT and MRI image via recurrent neural contextual learning and direct loss function", International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), 2017','Xiaoshuang Shi, Fuyong Xing, Yuanpu Xie, Lin Yang, "Cell encoding for histopathology image classification", International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), 2017',"Zizhao Zhang*, Yuanpu Xie*, Lin Yang, “Photographic Text-to-Image Synthesis with a Hierarchically-nested Adversarial Network”, International Conference on Computer Vision and Pattern Recognition (CVPR), 2018, Spotlight (~8%) * indicates equal contribution","Zizhao Zhang, Lin Yang, Y. Zheng, “Translating and Segmenting Multimodal Medical Volumes with Cycle- and Shape-Consistency Generative Adversarial Network”, International Conference on Computer Vision and Pattern Recognition (CVPR), 2018",'Mehmet Celenk, Lin Yang, Ganti Kamalakar, Derek J. Bleyle, Sudhir K. Sunkara, Yufei Wang, Philip Prudich, Yuangcui Huang and Qiang Zhou, "Tumor detection in VIVO NIRF imaging", Vol. 5370, SPIE International Symposium on Medical Imaging (SPIE), 2004.','Lin Yang, Jundong Liu, Charles D. Cavanaugh and Lonnie R. Welch, "A robust QoS forecasting algorithm for a dynamic, distributed real-time testbed", Proc. IEEE International Workshop on Computer Architectures for Machine Perception (WCAMP), New Orleans, LA, May, 2003','Lin Yang, Jundong Liu, Charles D. Cavanaugh and Lonnie R. Welch, "A L2E-based QoS forecasting technique for dynamic, distributed real-time systems", Proc. International Conference on Parallel and Distributed Processing Techniques and Applications (PDPTA), 2004.','Dazhang Gu, Lin Yang and Lonnie R. Welch. "A predictive, decentralized load balancing approach", 19th Proc. IEEE International Parallel and Distributed Processing Symposium (IPDPS), Vo1. 1, pp. 101-110, 2005.','Lin Yang and David J. Foran. "A variational framework for partially occluded image segmentation using coarse to fine shape alignment and semi-parametric density approximation", Proc. IEEE International Conference on Image Processing (ICIP), Vol. 1, pp. 78-82, 2007.','Lin Yang, Leiguang Gong, Hong Zhang, John L. Nosher and David J. Foran, "A multicore based parallel image registration method", Proc. International Conference on Engineering in Medicine and Biology Society (EMBS), Vol. 1, pp. 98-101, 2009.','Lin Yang, Leiguang Gong, Hong Zhang, John L. Nosher and David J. Foran, "A parallel point matching algorithm for landmark based image registration using multicore platform", European Conference on Parallel Computing (Euro-par), Vol. 5704, pp. 936-947, 2009.','Hyunjoo Kim, Manish Parashar, David J. Foran and Lin Yang, "Investigating the use of automatic cloudbursts for high-throughput medical image registration", IEEE International Conference on Grid Computing (GRID), Vol. 1, pp. 34-41, 2009.','Fuyong Xing, Baiyang Liu, Xin Qi, David J. Foran and Lin Yang, "Digital tissue microarray classification using sparse reconstruction", SPIE International Symposium on Medical Imaging (SPIE), 2012',"Hai Su, Yong Shen, Fuyong Xing, Xin Qi, Kim M. Hirshfield, Lin Yang, and David J. Foran, “Robust automatic breast cancer staging using a combination of functional genomics and image-omics”, Proc. International Conference on Engineering in Medicine and Biology Society (EMBS), accepted, 5 pages, 2015"]})},g={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("h4",{staticClass:"reference"},[t._v(t._s(t.$t("report.references")))]),t._v(" "),i("ul",t._l(t.references,function(e,s){return i("li",{key:s,staticClass:"refer-items"},[t._v("\n            "+t._s(s+1+".")+t._s(e)+"\n        ")])}),0)])},staticRenderFns:[]};var f=i("VU/8")(m,g,!1,function(t){i("R/dF")},"data-v-519f0b0e",null).exports,_={props:["basic"],computed:{gender:()=>"zh"==i18n.locale?{"男":"男","女":"女","其他":"其他"}:{"男":"M","女":"F","其他":"O"}},methods:{noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")}}},y={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"person-info"},[i("h4",{staticClass:"title"},[t._v(t._s(t.$t("basic.basic")))]),t._v(" "),i("table",[i("tr",{attrs:{valign:"top"}},[i("td",{attrs:{width:"35%"}},[i("span",{staticClass:"weight600"},[t._v("姓名：")]),t._v(" "),i("input",{directives:[{name:"model",rawName:"v-model",value:t.basic.name,expression:"basic.name"}],attrs:{type:"text"},domProps:{value:t.basic.name},on:{input:function(e){e.target.composing||t.$set(t.basic,"name",e.target.value)}}})]),t._v(" "),i("td",{attrs:{width:"35%"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("basic.sex")))]),t._v(" "),i("el-select",{model:{value:t.basic.gender,callback:function(e){t.$set(t.basic,"gender",e)},expression:"basic.gender"}},[i("el-option",{attrs:{label:"男",value:"男"}}),t._v(" "),i("el-option",{attrs:{label:"女",value:"女"}}),t._v(" "),i("el-option",{attrs:{label:"其他",value:"其他"}})],1)],1),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("basic.age")))]),t._v(" "),i("input",{directives:[{name:"model",rawName:"v-model",value:t.basic.age,expression:"basic.age"}],staticStyle:{width:"100px"},attrs:{type:"text",maxlength:"3"},domProps:{value:t.basic.age},on:{input:[function(e){e.target.composing||t.$set(t.basic,"age",e.target.value)},function(e){t.noEmoji,t.basic.age=t.basic.age.replace(/[^\d]/g,"")&&parseInt(t.basic.age.replace(/[^\d]/g,""))}]}})])]),t._v(" "),i("tr",{attrs:{valign:"top"}},[i("td",[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("basic.sampleCollectDate")))]),t._v(" "),i("el-date-picker",{attrs:{type:"date","value-format":"yyyy-MM-dd"},model:{value:t.basic.sampleCollectDate,callback:function(e){t.$set(t.basic,"sampleCollectDate",e)},expression:"basic.sampleCollectDate"}})],1),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v("样本号：")]),t._v(" "),i("input",{directives:[{name:"model",rawName:"v-model",value:t.basic.caseid,expression:"basic.caseid"}],staticStyle:{width:"140px"},attrs:{type:"text"},domProps:{value:t.basic.caseid},on:{input:function(e){e.target.composing||t.$set(t.basic,"caseid",e.target.value)}}})]),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("basic.samplePart")))]),t._v(" "),i("input",{directives:[{name:"model",rawName:"v-model",value:t.basic.samplePart,expression:"basic.samplePart"}],staticStyle:{width:"100px"},attrs:{type:"text"},domProps:{value:t.basic.samplePart},on:{input:function(e){e.target.composing||t.$set(t.basic,"samplePart",e.target.value)}}})])]),t._v(" "),i("tr",{attrs:{valign:"top"}},[i("td",[i("span",{staticClass:"weight600"},[t._v("送检医院：")]),t._v(" "),i("input",{directives:[{name:"model",rawName:"v-model",value:t.basic.inspectionHospital,expression:"basic.inspectionHospital"}],attrs:{type:"text",maxlength:"24"},domProps:{value:t.basic.inspectionHospital},on:{input:function(e){e.target.composing||t.$set(t.basic,"inspectionHospital",e.target.value)}}})]),t._v(" "),i("td",{attrs:{colspan:"2"}},[i("span",{staticClass:"weight600"},[t._v("送检医生：")]),t._v(" "),i("input",{directives:[{name:"model",rawName:"v-model",value:t.basic.inspectionDoctor,expression:"basic.inspectionDoctor"}],attrs:{type:"text"},domProps:{value:t.basic.inspectionDoctor},on:{input:function(e){e.target.composing||t.$set(t.basic,"inspectionDoctor",e.target.value)}}})])]),t._v(" "),i("tr",{attrs:{valign:"top"}},[i("td",{staticStyle:{"padding-top":"10px"},attrs:{colspan:"3"}},[i("span",{staticClass:"weight600",staticStyle:{"vertical-align":"top"}},[t._v(t._s(t.$t("basic.cancerType")))]),t._v(" "),i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.basic.cancerType,expression:"basic.cancerType"}],domProps:{value:t.basic.cancerType},on:{input:function(e){e.target.composing||t.$set(t.basic,"cancerType",e.target.value)}}})])])])])},staticRenderFns:[]};var b=i("VU/8")(_,y,!1,function(t){i("rwp+")},"data-v-ee5f4218",null).exports,R={props:["slices","recordId","type","roishow","modeType"],data:()=>({showRoi:[],dna2List:[],reportTypeMode:window.reportTypeMode}),methods:{stateChange(){this.$emit("roiState")},async editRemark(t,e){e.includes("tct")||e.includes("lct")?await Object(s.c)(this.recordId,t.fileid,e.replace(/[0-9]/g,""),[{id:t.id,remark:t.remark}],null):await Object(s.c)(this.recordId,t.fileid,e,[{id:t.id,remark:t.remark}],null)},checkData(){let t=[...this.slices.dna],e=[];t.length&&(e=t.filter(t=>"dnaIcon"!=t.iconType)),this.showRoi=[...this.slices.human,...e],this.dna2List=e}},watch:{slices:{immediate:!0,deep:!0,handler(t){this.slices=t,"dna"==this.modeType&&this.checkData()}},modeType:{immediate:!0,deep:!0,handler(t){this.modeType=t}}},mounted(){"dna"==this.modeType&&this.checkData()}},C={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"microscope"},[i("h4",{staticClass:"title slice"},[t._v(t._s(t.$t("report.microscope")))]),t._v(" "),t.slices.human&&t.slices.human.length||t.slices.tct&&t.slices.tct.length||t.slices.dna&&t.slices.dna.length?i("button",{staticClass:"showhide",on:{click:t.stateChange}},[t._v(t._s(t.roishow?"展示切片名称":"隐藏切片名称"))]):t._e(),t._v(" "),"dna"!==t.modeType||"double"==t.reportTypeMode?i("div",{staticClass:"slices"},[t.slices.human&&t.slices.human.length?i("div",{staticClass:"card"},[i("p",{staticClass:"result"},[t._v(t._s(t.$t("report.handwork")))]),t._v(" "),i("div",t._l(t.slices.human,function(e,s){return i("div",{key:s,staticClass:"slice-list clearfix"},[i("div",{staticClass:"fleft"},[i("img",{attrs:{src:"/aipath/api/files/ROI?caseid="+t.recordId+"&fileid="+e.fileid+"&filename="+encodeURIComponent(e.filename)+"&roi=[["+Math.min.apply(Math,e.path.x)+","+Math.min.apply(Math,e.path.y)+"],["+Math.max.apply(Math,e.path.x)+","+Math.max.apply(Math,e.path.y)+"]] &roiid="+e.id,alt:""}})]),t._v(" "),t.roishow?t._e():i("div",{staticClass:"slice-name"},[t._v("切片名称："+t._s(e.filename))]),t._v(" "),i("div",{staticClass:"fright"},[i("textarea",{directives:[{name:"model",rawName:"v-model",value:e.remark,expression:"roi.remark"}],attrs:{maxlength:"300",name:"",placeholder:t.$t("report.remarkremind")},domProps:{value:e.remark},on:{blur:function(i){return t.editRemark(e,e.type)},input:function(i){i.target.composing||t.$set(e,"remark",i.target.value)}}})])])}),0)]):t._e(),t._v(" "),"dna"!=t.modeType&&t.slices.tct&&t.slices.tct.length?i("div",{staticClass:"card"},[i("p",{staticClass:"result"},[t._v("AI处理结果")]),t._v(" "),i("div",t._l(t.slices.tct,function(e,s){return i("div",{key:s,staticClass:"slice-list clearfix"},[i("div",{staticClass:"fleft"},[i("img",{attrs:{src:"/aipath/api/files/ROI?caseid="+t.recordId+"&fileid="+e.fileid+"&filename="+encodeURIComponent(e.filename)+"&roi=[["+Math.min.apply(Math,e.path.x)+","+Math.min.apply(Math,e.path.y)+"],["+Math.max.apply(Math,e.path.x)+","+Math.max.apply(Math,e.path.y)+"]] &roiid="+e.id,alt:""}})]),t._v(" "),t.roishow?t._e():i("div",{staticClass:"slice-name"},[t._v("切片名称："+t._s(e.filename))]),t._v(" "),i("div",{staticClass:"fright"},[i("textarea",{directives:[{name:"model",rawName:"v-model",value:e.remark,expression:"roi.remark"}],attrs:{maxlength:"300",name:"",placeholder:t.$t("report.remarkremind")},domProps:{value:e.remark},on:{blur:function(i){return t.editRemark(e,t.type)},input:function(i){i.target.composing||t.$set(e,"remark",i.target.value)}}})])])}),0)]):t._e(),t._v(" "),"dna"==t.modeType&&t.dna2List&&t.dna2List.length?i("div",{staticClass:"card"},[i("p",{staticClass:"result"},[t._v("AI处理结果")]),t._v(" "),i("div",t._l(t.dna2List,function(e,s){return i("div",{key:s,staticClass:"slice-list clearfix"},[i("div",{staticClass:"fleft"},[i("img",{attrs:{src:"/aipath/api/files/ROI?caseid="+t.recordId+"&fileid="+e.fileid+"&filename="+encodeURIComponent(e.filename)+"&roi=[["+Math.min.apply(Math,e.path.x)+","+Math.min.apply(Math,e.path.y)+"],["+Math.max.apply(Math,e.path.x)+","+Math.max.apply(Math,e.path.y)+"]] &roiid="+e.id,alt:""}})]),t._v(" "),t.roishow?t._e():i("div",{staticClass:"slice-name"},[t._v("切片名称："+t._s(e.filename))]),t._v(" "),i("div",{staticClass:"fright"},[i("textarea",{directives:[{name:"model",rawName:"v-model",value:e.remark,expression:"roi.remark"}],attrs:{maxlength:"300",name:"",placeholder:t.$t("report.remarkremind")},domProps:{value:e.remark},on:{blur:function(i){return t.editRemark(e,t.type)},input:function(i){i.target.composing||t.$set(e,"remark",i.target.value)}}})])])}),0)]):t._e()]):i("div",[t.showRoi.length?i("div",{staticClass:"card"},[i("p",{staticClass:"result"},[t._v(t._s(t.slices.human.length?t.$t("report.handwork"):"AI处理结果"))]),t._v(" "),i("div",t._l([t.showRoi[0]],function(e,s){return i("div",{key:s,staticClass:"slice-list clearfix"},[i("div",{staticClass:"fleft"},[i("img",{attrs:{src:"/aipath/api/files/ROI?caseid="+t.recordId+"&fileid="+e.fileid+"&filename="+encodeURIComponent(e.filename)+"&roi=[["+Math.min.apply(Math,e.path.x)+","+Math.min.apply(Math,e.path.y)+"],["+Math.max.apply(Math,e.path.x)+","+Math.max.apply(Math,e.path.y)+"]] &roiid="+e.id,alt:""}})]),t._v(" "),t.roishow?t._e():i("div",{staticClass:"slice-name"},[t._v("切片名称："+t._s(e.filename))]),t._v(" "),i("div",{staticClass:"fright"},[i("textarea",{directives:[{name:"model",rawName:"v-model",value:e.remark,expression:"roi.remark"}],attrs:{maxlength:"300",name:"",placeholder:t.$t("report.remarkremind")},domProps:{value:e.remark},on:{blur:function(i){return t.editRemark(e,t.type)},input:function(i){i.target.composing||t.$set(e,"remark",i.target.value)}}})])])}),0)]):t._e()]),t._v(" "),t.slices.human&&t.slices.human.length||t.slices.tct&&t.slices.tct.length||t.slices.dna&&t.slices.dna.length?t._e():i("div",{staticClass:"qs"},[t._v("\n        请在上一步AI处理和手动处理中，勾选ROI添加镜下视野\n    ")])])},staticRenderFns:[]};var w=i("VU/8")(R,C,!1,function(t){i("8+aK")},"data-v-06dc6ed6",null).exports,k={props:["info","opinions","firstSlice","DNAOpinions","dnaCellCount"],data(){let t=this.opinions?this.opinions.split(";"):[];return this.info.DNA={isStatisfied:"number"==typeof this.firstSlice.slide_quality?this.firstSlice.slide_quality>0?"1":"0":"",cellNum:"number"==typeof this.firstSlice.cell_num?this.firstSlice.cell_num>5e3?"greater":"less":"",cervicalCanalCells:"",metaplasticCells:"",inflammatoryCells:"",erythrocyte:"",cataplasia:"",intrauterineDevice:"",radiotherapy:"",selectopinion:"",selectDNAOpinion:"",selectUniteOpinion:"",tbsOpinion:t[0]?t[0]:"",opinion:this.opinions,options:["未见上皮内病变细胞或恶性细胞（NILM）","意义不明确的非典型鳞状细胞（ASC-US）","不除外高级别鳞状上皮内病变细胞的非典型鳞状细胞（ASC-H）","低级别鳞状上皮内病变（LSIL）","高级别鳞状上皮内病变（HSIL）","鳞状细胞癌（SCC）","非典型腺细胞（不能明确意义）","非典型腺细胞（倾向瘤变）","颈管原位腺癌（AIS）","腺癌","其他恶性肿瘤"],DNAOpinion:this.DNAOpinions,DNAOptions:["标本不满意:上皮细胞数目太少","标本不满意","其它","有效检测细胞不足","未见DNA倍体异常细胞","可见少量DNA倍体异常细胞（1-2个）","可见DNA倍体异常细胞（≥3个）","可见少量细胞增生（5%-10%）","可见细胞异常增生（≥10%）","可见异倍体细胞峰"],uniteOpinion:t[1]?t[1]:"",uniteOptions:["请选择","按TBS诊断结果给建议","定期筛查","一个月复查","4~6个月复查","阴道镜检查及活体组织检查或结合临床考虑","颈管搔刮或子宫内膜活检或诊刮"],pathogen:[],pageType:"DNAPage",reportTypeMode:window.reportTypeMode,num_normal:this.dnaCellCount.num_normal,num_abnormal_low:this.dnaCellCount.num_abnormal_low,num_abnormal_high:this.dnaCellCount.num_abnormal_high}},methods:{changeValue(t,e){"opinion"==e?("string"==typeof t&&(this.tbsOpinion=t,this.opinion=this.tbsOpinion+";"+this.uniteOpinion),this.$emit("sendValue",this.tbsOpinion+";"+this.uniteOpinion,e)):"DNAOpinion"==e?("string"==typeof t&&(this.DNAOpinion=t),this.$emit("sendValue",this.DNAOpinion,e)):"uniteOpinion"==e&&("string"==typeof t&&(this.uniteOpinion=t,this.opinion=this.tbsOpinion+";"+this.uniteOpinion),this.$emit("sendValue",this.tbsOpinion+";"+this.uniteOpinion,"opinion"))},noEmoji(t){t.target.value=t.target.value.replace(/[^\u0020-\u007E\u00A0-\u00BE\u2E80-\uA4CF\uF900-\uFAFF\uFE30-\uFE4F\uFF00-\uFFEF\u0080-\u009F\u2000-\u201f\u2026\u2022\u20ac\r\n]/g,"")}},mounted(){this.$nextTick(()=>{if("dna"===this.firstSlice.alg)if(this.firstSlice.check_result){let t=this.firstSlice.check_result.split(";");if(t[0]){let e=t[0].split(" ")[2];this.info.DNA.pathogen=e?e.split(","):[]}else if(this.firstSlice.ai_suggest){let t=this.firstSlice.ai_suggest.split(";");if(t[0]){let e=t[0].split(" ")[2];this.info.DNA.pathogen=e?e.split(","):[]}}}else if(this.firstSlice.ai_suggest){let t=this.firstSlice.ai_suggest.split(";");if(t[0]){let e=t[0].split(" ")[2];this.info.DNA.pathogen=e?e.split(","):[]}}})},watch:{opinions:{immediate:!0,deep:!0,handler(t){let e=t?t.split(";"):[];this.tbsOpinion=e[0]?e[0]:"",this.uniteOpinion=e[1]?e[1]:""}},DNAOpinions:{immediate:!0,deep:!0,handler(t){this.DNAOpinion=t}},dnaCellCount:{immediate:!0,deep:!0,handler(t){this.info.DNA.num_normal=t.num_normal,this.info.DNA.num_abnormal_low=t.num_abnormal_low,this.info.DNA.num_abnormal_high=t.num_abnormal_high}}}},x={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{staticClass:"dna"},[i("h4",{staticClass:"title"},[t._v(t._s(t.$t("basic.sample")))]),t._v(" "),i("div",{staticClass:"tct-text"},[i("div",{staticClass:"left"},[i("div",{staticClass:"seption"},[i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("标本满意度:")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.isStatisfied,callback:function(e){t.isStatisfied=e},expression:"isStatisfied"}},[t._v(t._s(t.$t("report.satisfied")))]),t._v(" "),i("el-radio",{attrs:{label:"0"},model:{value:t.isStatisfied,callback:function(e){t.isStatisfied=e},expression:"isStatisfied"}},[t._v(t._s(t.$t("report.notsatisfied")))])],1),t._v(" "),i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("细胞量:")]),t._v(" "),i("el-radio",{attrs:{label:"greater"},model:{value:t.cellNum,callback:function(e){t.cellNum=e},expression:"cellNum"}},[t._v(">5000")]),t._v(" "),i("el-radio",{attrs:{label:"less"},model:{value:t.cellNum,callback:function(e){t.cellNum=e},expression:"cellNum"}},[t._v("≤5000")])],1),t._v(" "),i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("颈管细胞:")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.cervicalCanalCells,callback:function(e){t.cervicalCanalCells=e},expression:"cervicalCanalCells"}},[t._v("有")]),t._v(" "),i("el-radio",{attrs:{label:"0"},model:{value:t.cervicalCanalCells,callback:function(e){t.cervicalCanalCells=e},expression:"cervicalCanalCells"}},[t._v("无")])],1),t._v(" "),i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("化生细胞:")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.metaplasticCells,callback:function(e){t.metaplasticCells=e},expression:"metaplasticCells"}},[t._v("有")]),t._v(" "),i("el-radio",{attrs:{label:"0"},model:{value:t.metaplasticCells,callback:function(e){t.metaplasticCells=e},expression:"metaplasticCells"}},[t._v("无")])],1)]),t._v(" "),i("div",{staticClass:"seption"},[i("div",{staticClass:"line weight600"},[t._v("\n            炎症以及反应性细胞改变\n          ")]),t._v(" "),i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("炎细胞:")]),t._v(" "),i("el-radio",{attrs:{label:"less"},model:{value:t.inflammatoryCells,callback:function(e){t.inflammatoryCells=e},expression:"inflammatoryCells"}},[t._v("少量")]),t._v(" "),i("el-radio",{attrs:{label:"medium"},model:{value:t.inflammatoryCells,callback:function(e){t.inflammatoryCells=e},expression:"inflammatoryCells"}},[t._v("中量")]),t._v(" "),i("el-radio",{attrs:{label:"more"},model:{value:t.inflammatoryCells,callback:function(e){t.inflammatoryCells=e},expression:"inflammatoryCells"}},[t._v("大量")])],1),t._v(" "),i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("红细胞:")]),t._v(" "),i("el-radio",{attrs:{label:"less"},model:{value:t.erythrocyte,callback:function(e){t.erythrocyte=e},expression:"erythrocyte"}},[t._v("少量")]),t._v(" "),i("el-radio",{attrs:{label:"medium"},model:{value:t.erythrocyte,callback:function(e){t.erythrocyte=e},expression:"erythrocyte"}},[t._v("中量")]),t._v(" "),i("el-radio",{attrs:{label:"more"},model:{value:t.erythrocyte,callback:function(e){t.erythrocyte=e},expression:"erythrocyte"}},[t._v("大量")])],1),t._v(" "),i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("细胞萎缩:")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.cataplasia,callback:function(e){t.cataplasia=e},expression:"cataplasia"}},[t._v("有")]),t._v(" "),i("el-radio",{attrs:{label:"0"},model:{value:t.cataplasia,callback:function(e){t.cataplasia=e},expression:"cataplasia"}},[t._v("无")])],1)]),t._v(" "),i("div",{staticClass:"seption"},[i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("宫内节育器:")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.intrauterineDevice,callback:function(e){t.intrauterineDevice=e},expression:"intrauterineDevice"}},[t._v("有")]),t._v(" "),i("el-radio",{attrs:{label:"0"},model:{value:t.intrauterineDevice,callback:function(e){t.intrauterineDevice=e},expression:"intrauterineDevice"}},[t._v("无")])],1),t._v(" "),i("div",{staticClass:"line"},[i("span",{staticClass:"weight600"},[t._v("放疗:")]),t._v(" "),i("el-radio",{attrs:{label:"1"},model:{value:t.radiotherapy,callback:function(e){t.radiotherapy=e},expression:"radiotherapy"}},[t._v("有")]),t._v(" "),i("el-radio",{attrs:{label:"0"},model:{value:t.radiotherapy,callback:function(e){t.radiotherapy=e},expression:"radiotherapy"}},[t._v("无")])],1)])]),t._v(" "),i("div",{staticClass:"right"},[i("div",{staticClass:"line weight600"},[t._v("微生物:")]),t._v(" "),i("el-checkbox-group",{staticStyle:{display:"inline-block"},model:{value:t.pathogen,callback:function(e){t.pathogen=e},expression:"pathogen"}},t._l(t.$t("report.padthogenArr"),function(t,e){return i("el-checkbox",{key:e,attrs:{label:t}})}),1)],1)])]),t._v(" "),i("div",{staticClass:"opinion"},[i("h4",{staticClass:"title"},[t._v("\n      "+t._s("TBS诊断意见")+"\n       "),i("el-select",{on:{change:function(e){return t.changeValue(e,"opinion")}},model:{value:t.info.DNA.selectopinion,callback:function(e){t.$set(t.info.DNA,"selectopinion",e)},expression:"info.DNA.selectopinion"}},t._l(this.info.DNA.options,function(t){return i("el-option",{key:t,attrs:{label:t,value:t}})}),1)],1),t._v(" "),i("div",{staticClass:"opinion-write"},[i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.tbsOpinion,expression:"tbsOpinion"}],attrs:{spellcheck:"false",name:"",id:"",maxlength:"300",cols:"30",rows:"10",placeholder:"诊断意见"},domProps:{value:t.tbsOpinion},on:{change:function(e){return t.changeValue(e,"opinion")},input:[function(e){e.target.composing||(t.tbsOpinion=e.target.value)},t.noEmoji]}})])]),t._v(" "),i("div",{staticClass:"opinion"},[i("h4",{staticClass:"title"},[t._v("\n      "+t._s("DNA检测意见")+"\n       "),i("el-select",{on:{change:function(e){return t.changeValue(e,"DNAOpinion")}},model:{value:t.info.DNA.selectDNAOpinion,callback:function(e){t.$set(t.info.DNA,"selectDNAOpinion",e)},expression:"info.DNA.selectDNAOpinion"}},t._l(this.info.DNA.DNAOptions,function(t){return i("el-option",{key:t,attrs:{label:t,value:t}})}),1)],1),t._v(" "),i("div",{staticClass:"opinion-write"},[i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.DNAOpinion,expression:"DNAOpinion"}],attrs:{spellcheck:"false",name:"",id:"",maxlength:"300",cols:"30",rows:"10",placeholder:"诊断意见"},domProps:{value:t.DNAOpinion},on:{change:function(e){return t.changeValue(e,"DNAOpinion")},input:[function(e){e.target.composing||(t.DNAOpinion=e.target.value)},t.noEmoji]}})])]),t._v(" "),i("div",{staticClass:"opinion"},[i("h4",{staticClass:"title"},[t._v("\n      "+t._s("联合诊断建议")+"\n       "),i("el-select",{on:{change:function(e){return t.changeValue(e,"uniteOpinion")}},model:{value:t.info.DNA.selectUniteOpinion,callback:function(e){t.$set(t.info.DNA,"selectUniteOpinion",e)},expression:"info.DNA.selectUniteOpinion"}},t._l(this.info.DNA.uniteOptions,function(t){return i("el-option",{key:t,attrs:{label:t,value:t}})}),1)],1),t._v(" "),i("div",{staticClass:"opinion-write"},[i("textarea",{directives:[{name:"model",rawName:"v-model",value:t.uniteOpinion,expression:"uniteOpinion"}],attrs:{spellcheck:"false",name:"",id:"",maxlength:"300",cols:"30",rows:"10",placeholder:"诊断意见"},domProps:{value:t.uniteOpinion},on:{change:function(e){return t.changeValue(e,"uniteOpinion")},input:[function(e){e.target.composing||(t.uniteOpinion=e.target.value)},t.noEmoji]}})])])])},staticRenderFns:[]};var $=i("VU/8")(k,x,!1,function(t){i("Js0x")},"data-v-44f35a8a",null).exports,I=[];I.append=function(t){let e=()=>{var t=I.shift();if(!t)return I.running=!1;I.running=!0,t().then(e).catch(e)};this.push(t),this.running||e()};var O={props:["record","reportType","signed","logoSrc","slices","sign","algType"],components:{"v-reg":o,"v-tct2":c,"v-dna":$,"v-esd":v,"v-reference":f,"v-basic":b,"v-slides":w},data(){return{types:[{key:"REG",value:"REG"},{key:"TCT / LCT",value:"LCT"},{key:"TBS+DNA",value:"DNA"}],uploadData:new Map,img_error:!0,opinion:this.record.opinion,dnaCellCount:{}}},methods:{getValue(t){this.$set(this.record,"opinion",t)},getDNAValue(t,e){"opinion"==e?this.$set(this.record,"opinion",t):"DNAOpinion"==e&&this.$set(this.record,"DNAOpinion",t)},getDNAInfo(){Object(s.b)("report/getDNAInfo",{caseid:this.record.id,fileid:this.record.slice}).then(({data:t})=>{this.dnaCellCount=t})},roiState(){this.$set(this.record,"roishow",!this.record.roishow)},currentTime(){var t=new Date,e=t.getFullYear(),i=t.getMonth()+1,s=t.getDate();return e+"-"+(i<10?"0"+i:i)+"-"+(s<10?"0"+s:s)},addFiles(t){for(let i of t.files){var e=new FileReader;if(e.readAsDataURL(i),i.size/1024/1024>5)return void this.$message.error("文件大小不能超过5MB");e.onload=(t=>{this.$set(this.record,"logo",t.target.result)})}},addSign(t){for(let i of t.files){var e=new FileReader;if(e.readAsDataURL(i),i.size/1024/1024>5)return void this.$message.error("文件大小不能超过5MB");e.onload=(t=>{let e=new FormData;e.append("sign",i),Object(s.b)("user/updateSign",e).then(()=>{this.$emit("changeSign")})})}},async save(t){this.record.update=this.record.update=(new Date).toISOString(),await Object(s.b)("records/update",{id:this.record.id,content:JSON.stringify(this.record)})},imgError(){this.img_error=!1}},mounted(){this.record.hasOwnProperty("report_name")||this.$set(this.record,"report_name",Object(s.o)().company),this.record.hasOwnProperty("report_info")||this.$set(this.record,"report_info","病理检查报告")},watch:{"record.opinion":{immediate:!0,handler(t){this.opinion=t}},"record.DNAOpinion":{immediate:!0,handler(t){this.DNAOpinion=t}},reportType:{immediate:!0,handler(t){"DNA"==t&&this.getDNAInfo()}}}},S={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"father"},[i("div",{staticClass:"content"},[i("div",{staticClass:"header clearfix"},[i("div",{staticClass:"logo-content"},[t.record.logo?i("img",{staticClass:"logo",attrs:{src:t.record.logo,id:"logo",alt:""}}):i("span",[i("em",[t._v("+")]),t._v("上传LOGO")]),t._v(" "),i("input",{staticClass:"choseLogo",attrs:{type:"file",accept:"image/jpeg,image/png,image/bmp"},on:{change:function(e){return t.addFiles(e.currentTarget)}}})]),t._v(" "),i("div",{staticClass:"text"},[t._v("样本号："+t._s(this.record.basic.caseid)+"   "+t._s(t.$t("report.date"))+t._s(t.currentTime())+"\n            ")])]),t._v(" "),i("div",{staticClass:"main"},[i("h3",[i("input",{directives:[{name:"model",rawName:"v-model",value:t.record.report_name,expression:"record.report_name"}],attrs:{type:"text"},domProps:{value:t.record.report_name},on:{input:function(e){e.target.composing||t.$set(t.record,"report_name",e.target.value)}}})]),t._v(" "),i("h3",[i("input",{directives:[{name:"model",rawName:"v-model",value:t.record.report_info,expression:"record.report_info"}],staticClass:"names",attrs:{type:"text"},domProps:{value:t.record.report_info},on:{input:function(e){e.target.composing||t.$set(t.record,"report_info",e.target.value)}}})]),t._v(" "),i("v-basic",{attrs:{basic:t.record.basic}}),t._v(" "),i("div",{staticClass:"options clearfix"},[i("select",{attrs:{name:""},on:{change:function(e){return t.$emit("typeChange",e.target.value)}}},t._l(t.types,function(e,s){return i("option",{key:s,domProps:{selected:e.value==t.reportType,value:e.value}},[t._v(t._s(e.key))])}),0),t._v(" "),"REG"==t.reportType?i("v-reg",{attrs:{info:t.record.reportInfo,opinions:t.opinion},on:{sendValue:t.getValue}}):"LCT"==t.reportType?i("v-tct2",{attrs:{info:t.record.reportInfo,opinions:t.opinion,firstSlice:t.record.slices[0]},on:{sendValue:t.getValue}}):"DNA"==t.reportType?i("v-dna",{attrs:{info:t.record.reportInfo,opinions:t.opinion,DNAOpinions:t.DNAOpinion,firstSlice:t.record.slices[0],dnaCellCount:t.dnaCellCount},on:{sendValue:t.getDNAValue}}):t._e()],1),t._v(" "),i("v-slides",{attrs:{recordId:t.record.id,roishow:t.record.roishow,slices:t.slices,type:t.algType&&t.algType.toLowerCase(),modeType:t.reportType.toLowerCase()},on:{roiState:t.roiState,sliceChangge:function(e){return t.$emit("sliceChangge")}}}),t._v(" "),i("div",{staticClass:"sign clearfix",staticStyle:{width:"260px","box-sizing":"content-box"}},[i("span",[t._v(t._s(t.$t("report.doctor")))]),t._v(" "),i("div",{staticClass:"logo-content sign-content"},[t.signed?t._e():i("span",[i("em",[t._v("+")]),t._v("上传签名")]),t._v(" "),t.signed?i("img",{directives:[{name:"show",rawName:"v-show",value:t.img_error,expression:"img_error"}],staticClass:"signed",attrs:{src:t.sign},on:{error:function(e){return t.imgError()}}}):t._e(),t._v(" "),i("input",{staticClass:"choseLogo",attrs:{type:"file",accept:"image/jpeg,image/png,image/bmp"},on:{change:function(e){return t.addSign(e.currentTarget)}}})])])],1),t._v(" "),i("div",{staticClass:"footer clearfix"},[i("div",{staticClass:"fleft"},[i("p",[t._v(t._s(t.$t("report.bottom")))]),t._v(" "),i("p",[t._v("research use only")])])])])])},staticRenderFns:[]};var A=i("VU/8")(O,S,!1,function(t){i("+cZ/")},"data-v-97bdd7fa",null);e.a=A.exports},vCUm:function(t,e){},vI3O:function(t,e){},vTgc:function(t,e){},vhYd:function(t,e,i){t.exports=i.p+"static/img/矩形排除-d.95f3983.svg"},wS5G:function(t,e){},xAxs:function(t,e){},xFpc:function(t,e){},xVoh:function(t,e){},xaJR:function(t,e){},xwt1:function(t,e){},y75E:function(t,e){},yd85:function(t,e){},"ygU+":function(t,e){},"yi+Z":function(t,e){},yiVy:function(t,e){},ylzz:function(t,e){},ymmg:function(t,e){},yxHg:function(t,e,i){"use strict";var s={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{class:{tct:!0,print:t.host}},[i("h4",{class:{title:!0,print:t.host}},[t._v("样本信息")]),t._v(" "),i("table",{class:{print:t.host},attrs:{cellspacing:"0"}},[i("tr",[i("td",{attrs:{width:"40%"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.satisfaction")))]),t._v(" "),"1"==t.info.LCT.isStatisfied?i("span",[t._v(t._s(t.$t("report.satisfied")))]):"0"==t.info.LCT.isStatisfied?i("span",[t._v(t._s(t.$t("report.notsatisfied")))]):t._e()]),t._v(" "),t._m(0),t._v(" "),i("td",{attrs:{rowspan:"2",width:"20%"}},[i("span",{staticClass:"weight600"},[t._v("微生物:")]),t._v("\n          "+t._s(t.info.LCT.pathogen&&t.info.LCT.pathogen.length?t.info.LCT.pathogen.join(","):"无")+"\n        ")])]),t._v(" "),i("tr",[i("td",[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.cellmass")))]),t._v(" "),"greater"==t.info.LCT.cellNum?i("span",[t._v(">5000")]):"less"==t.info.LCT.cellNum?i("span",[t._v("≤5000")]):t._e()]),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v("炎细胞：")]),t._v(" "),"less"==t.info.LCT.inflammatoryCells?i("span",[t._v("少量")]):"medium"==t.info.LCT.inflammatoryCells?i("span",[t._v("中量")]):"more"==t.info.LCT.inflammatoryCells?i("span",[t._v("大量")]):t._e()])]),t._v(" "),i("tr",[i("td",[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.solencyte")))]),t._v(" "),"1"==t.info.LCT.cervicalCanalCells?i("span",[t._v("有")]):"0"==t.info.LCT.cervicalCanalCells?i("span",[t._v("无")]):t._e()]),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v("红细胞：")]),t._v(" "),"less"==t.info.LCT.erythrocyte?i("span",[t._v("少量")]):"medium"==t.info.LCT.erythrocyte?i("span",[t._v("中量")]):"more"==t.info.LCT.erythrocyte?i("span",[t._v("大量")]):t._e()]),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v("放疗：")]),t._v(" "),"1"==t.info.LCT.radiotherapy?i("span",[t._v("有")]):"0"==t.info.LCT.radiotherapy?i("span",[t._v("无")]):t._e()])]),t._v(" "),i("tr",[i("td",[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.metaplastic")))]),t._v(" "),"1"==t.info.LCT.metaplasticCells?i("span",[t._v("有")]):"0"==t.info.LCT.metaplasticCells?i("span",[t._v("无")]):t._e()]),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v("细胞萎缩：")]),t._v(" "),"1"==t.info.LCT.cataplasia?i("span",[t._v("有")]):"0"==t.info.LCT.cataplasia?i("span",[t._v("无")]):t._e()]),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v("宫内节育器：")]),t._v(" "),"1"==t.info.LCT.intrauterineDevice?i("span",[t._v("有")]):"0"==t.info.LCT.intrauterineDevice?i("span",[t._v("无")]):t._e()])])])]),t._v(" "),i("div",{class:{opinion:!0,print:t.host}},[i("h4",{class:{title:!0,print:t.host}},[t._v(t._s(t.$t("report.point")))]),t._v(" "),i("div",{staticClass:"opinion-write",domProps:{innerHTML:t._s(t.opinion)}})])])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("td",{attrs:{width:"40%"}},[e("span",{staticClass:"weight600"},[this._v("炎症以及反应性细胞改变")])])}]};var a=i("VU/8")({props:["info","host"],computed:{opinion:function(){if(this.info.LCT.opinion)return this.info.LCT.opinion.replace(/\r\n/g,"<br>").replace(/\n/g,"<br>").replace(/\s/g," ")}}},s,!1,function(t){i("Nx4E")},"data-v-e285b0aa",null).exports,n={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{class:{tct:!0,print:t.host}},[i("h4",{class:{title:!0,print:t.host}},[t._v("样本信息")]),t._v(" "),i("table",{class:{print:t.host},attrs:{cellspacing:"0"}},[i("tr",[i("td",{attrs:{width:"40%"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.satisfaction")))]),t._v(" "),"1"==t.info.DNA.isStatisfied?i("span",[t._v(t._s(t.$t("report.satisfied")))]):"0"==t.info.DNA.isStatisfied?i("span",[t._v(t._s(t.$t("report.notsatisfied")))]):t._e()]),t._v(" "),t._m(0),t._v(" "),i("td",{attrs:{rowspan:"2",width:"20%"}},[i("span",{staticClass:"weight600"},[t._v("微生物:")]),t._v("\n          "+t._s(t.info.DNA.pathogen&&t.info.DNA.pathogen.length?t.info.DNA.pathogen.join(","):"无")+"\n        ")])]),t._v(" "),i("tr",[i("td",[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.cellmass")))]),t._v(" "),"greater"==t.info.DNA.cellNum?i("span",[t._v(">5000")]):"less"==t.info.DNA.cellNum?i("span",[t._v("≤5000")]):t._e()]),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v("炎细胞：")]),t._v(" "),"less"==t.info.DNA.inflammatoryCells?i("span",[t._v("少量")]):"medium"==t.info.DNA.inflammatoryCells?i("span",[t._v("中量")]):"more"==t.info.DNA.inflammatoryCells?i("span",[t._v("大量")]):t._e()])]),t._v(" "),i("tr",[i("td",[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.solencyte")))]),t._v(" "),"1"==t.info.DNA.cervicalCanalCells?i("span",[t._v("有")]):"0"==t.info.DNA.cervicalCanalCells?i("span",[t._v("无")]):t._e()]),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v("红细胞：")]),t._v(" "),"less"==t.info.DNA.erythrocyte?i("span",[t._v("少量")]):"medium"==t.info.DNA.erythrocyte?i("span",[t._v("中量")]):"more"==t.info.DNA.erythrocyte?i("span",[t._v("大量")]):t._e()]),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v("放疗：")]),t._v(" "),"1"==t.info.DNA.radiotherapy?i("span",[t._v("有")]):"0"==t.info.DNA.radiotherapy?i("span",[t._v("无")]):t._e()])]),t._v(" "),i("tr",[i("td",[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.metaplastic")))]),t._v(" "),"1"==t.info.DNA.metaplasticCells?i("span",[t._v("有")]):"0"==t.info.DNA.metaplasticCells?i("span",[t._v("无")]):t._e()]),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v("细胞萎缩：")]),t._v(" "),"1"==t.info.DNA.cataplasia?i("span",[t._v("有")]):"0"==t.info.DNA.cataplasia?i("span",[t._v("无")]):t._e()]),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v("宫内节育器：")]),t._v(" "),"1"==t.info.DNA.intrauterineDevice?i("span",[t._v("有")]):"0"==t.info.DNA.intrauterineDevice?i("span",[t._v("无")]):t._e()])])])]),t._v(" "),i("div",{class:{opinion:!0,print:t.host}},[i("h4",{class:{title:!0,print:t.host}},[t._v(t._s(t.$t("report.point")))]),t._v(" "),i("div",{staticClass:"opinion-write",domProps:{innerHTML:t._s(t.opinion)}})])])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("td",{attrs:{width:"40%"}},[e("span",{staticClass:"weight600"},[this._v("炎症以及反应性细胞改变")])])}]};var o=i("VU/8")({props:["info","host"],computed:{opinion:function(){if(this.info.DNA.tbsOpinion)return"TBS诊断意见："+this.info.DNA.tbsOpinion.replace(/\r\n/g,"<br>").replace(/\n/g,"<br>").replace(/\s/g," ")}}},n,!1,function(t){i("rMce")},"data-v-6747d72c",null).exports,l=i("Gu7T"),r=i.n(l),c={props:["info","sliceId","host","slices","recordId","roishow"],data:function(){return{showRoi:[],list:[],checkedArrayList:[]}},computed:{opinion:function(){if(this.info.DNA.tbsOpinion)return"TBS诊断意见："+this.info.DNA.tbsOpinion.replace(/\r\n/g,"<br>").replace(/\n/g,"<br>").replace(/\s/g," ")},DNAOpinion:function(){if(this.info.DNA.DNAOpinion)return'<font style="font-size:18px;font-weight:bold;display:block;margin-bottom:10px">DNA检测意见：</font>'+this.info.DNA.DNAOpinion.replace(/\r\n/g,"<br>").replace(/\n/g,"<br>").replace(/\s/g," ")},uniteOpinion:function(){if(this.info.DNA.uniteOpinion)return'<font style="font-size:18px;font-weight:bold;display:block;margin-bottom:10px">诊断建议：</font>'+this.info.DNA.uniteOpinion.replace(/\r\n/g,"<br>").replace(/\n/g,"<br>").replace(/\s/g," ")},tableData:function(){return this.info.DNA}},methods:{getDNAInfo:function(){},checkData:function(){var t=[].concat(r()(this.slices.human),r()(this.slices.dna)),e=[],i=[];this.checkedArrayList=[],t.length&&(e=t.filter(function(t){return"dnaIcon"!=t.iconType})),[].concat(r()(this.slices.dna)).length&&(i=[].concat(r()(this.slices.dna)).filter(function(t){return"dnaIcon"==t.iconType}),this.checkedArrayList=i.filter(function(t){return t.di>=2.5}),i.length>30&&(i=i.slice(0,30))),this.showRoi=e,this.list=i}},watch:{slices:{immediate:!0,deep:!0,handler:function(t){this.slices=t,this.checkData()}}},mounted:function(){this.checkData(),this.getDNAInfo()}},h={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{class:{opinion:!0,print:t.host}},[i("h4",{class:{title:!0,print:t.host}},[t._v(t._s(t.$t("report.point")))]),t._v(" "),i("div",{staticClass:"pic-index"},[i("img",{staticClass:"pic-index-img",attrs:{src:t.host?t.host+"/data/"+t.recordId+"/slices/"+t.sliceId+"dna_index.png":"/aipath/api/files/getImage?caseid="+t.recordId+"&fileid="+t.sliceId+"&type=histplot&date="+(new Date).getTime(),alt:""}})]),t._v(" "),i("div",{staticClass:"pic-index"},[i("img",{staticClass:"pic-index-img",attrs:{src:t.host?t.host+"/data/"+t.recordId+"/slices/"+t.sliceId+"scatterplot.png":"/aipath/api/files/getImage?caseid="+t.recordId+"&fileid="+t.sliceId+"&type=scatterplot&date="+(new Date).getTime(),alt:""}})])]),t._v(" "),i("div",{staticClass:"pic"},[i("div",{staticClass:"dna-item-analy"},[i("li",{staticStyle:{color:"rgb(112,182,3)"}},[i("span",{staticClass:"dna-item-title"},[t._v("正常二倍体细胞")]),t._v("  "+t._s(t.tableData.num_normal))]),t._v(" "),i("li",{staticStyle:{color:"rgb(245,154,35)"}},[i("span",{staticClass:"dna-item-title"},[t._v("增生细胞")]),t._v("  "+t._s(t.tableData.num_abnormal_low))]),t._v(" "),i("li",{staticStyle:{color:"rgb(217,0,27)"}},[i("span",{staticClass:"dna-item-title"},[t._v("多倍体细胞")]),t._v("  "+t._s(t.tableData.num_abnormal_high>100?t.checkedArrayList.length+(t.tableData.num_abnormal_high-100):t.checkedArrayList.length))]),t._v(" "),i("li",{staticStyle:{marginBottom:"20px"}},[i("span",{staticClass:"dna-item-title"},[t._v("上皮细胞")]),t._v("  "+t._s(t.tableData.num_normal+t.tableData.num_abnormal_low+t.tableData.num_abnormal_high))]),t._v(" "),i("div",{staticClass:"opinion-write",domProps:{innerHTML:t._s(t.DNAOpinion)}}),t._v(" "),i("br"),t._v(" "),i("div",{staticClass:"opinion-write",domProps:{innerHTML:t._s(t.uniteOpinion)}})]),t._v(" "),i("div",{staticClass:"pic-dna"},[t.list.length?i("div",{staticClass:"pic-dna-icons"},t._l(t.list,function(e){return i("div",{key:e.id,staticClass:"pic-dna-icon"},[i("img",{staticClass:"pic-dna-icon-img",attrs:{src:t.host?t.host+"/data/"+t.recordId+"/slices/"+e.fileid+"/roi/"+t.roi.id+".jpg":"/aipath/api/files/ROI?caseid="+t.recordId+"&fileid="+e.fileid+"&filename="+encodeURIComponent(e.filename)+"&roi=[["+Math.min.apply(Math,e.path.x)+","+Math.min.apply(Math,e.path.y)+"],["+Math.max.apply(Math,e.path.x)+","+Math.max.apply(Math,e.path.y)+"]] &roiid="+e.id,alt:""}}),t._v(" "),i("div",{staticClass:"roi-percent",class:{"red-color":e.di-0>=2.5}},[t._v(t._s(e.di))])])}),0):t._e()])])])},staticRenderFns:[]};var u=i("VU/8")(c,h,!1,function(t){i("jjsr")},"data-v-78b9f4e6",null).exports,d={props:["info","sliceId","host","slices","recordId","roishow"],data:function(){return{showRoi:[],list:[],checkedArrayList:[]}},computed:{opinion:function(){if(this.info.DNA.tbsOpinion)return"TBS诊断意见："+this.info.DNA.tbsOpinion.replace(/\r\n/g,"<br>").replace(/\n/g,"<br>").replace(/\s/g," ")},DNAOpinion:function(){if(this.info.DNA.DNAOpinion)return"DNA检测意见："+this.info.DNA.DNAOpinion.replace(/\r\n/g,"<br>").replace(/\n/g,"<br>").replace(/\s/g," ")},uniteOpinion:function(){if(this.info.DNA.uniteOpinion)return"联合诊断建议："+this.info.DNA.uniteOpinion.replace(/\r\n/g,"<br>").replace(/\n/g,"<br>").replace(/\s/g," ")},tableData:function(){return this.info.DNA}},methods:{getDNAInfo:function(){},checkData:function(){var t=[].concat(r()(this.slices.human),r()(this.slices.dna)),e=[],i=[];this.checkedArrayList=[],t.length&&(e=t.filter(function(t){return"dnaIcon"!=t.iconType})),[].concat(r()(this.slices.dna)).length&&(i=[].concat(r()(this.slices.dna)).filter(function(t){return"dnaIcon"==t.iconType}),this.checkedArrayList=i.filter(function(t){return t.di>=2.5}),i.length>30&&(i=i.slice(0,30))),this.showRoi=e,this.list=i}},watch:{slices:{immediate:!0,deep:!0,handler:function(t){this.slices=t,this.checkData()}}},mounted:function(){this.checkData(),this.getDNAInfo()}},p={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{class:{tct:!0,print:t.host}},[i("h4",{class:{title:!0,print:t.host}},[t._v("样本信息")]),t._v(" "),i("table",{class:{print:t.host},attrs:{cellspacing:"0"}},[i("tr",[i("td",{attrs:{width:"50%"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.satisfaction")))]),t._v(" "),"1"==t.info.DNA.isStatisfied?i("span",[t._v(t._s(t.$t("report.satisfied")))]):"0"==t.info.DNA.isStatisfied?i("span",[t._v(t._s(t.$t("report.notsatisfied")))]):t._e()]),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.solencyte")))]),t._v(" "),"1"==t.info.DNA.cervicalCanalCells?i("span",[t._v("有")]):"0"==t.info.DNA.cervicalCanalCells?i("span",[t._v("无")]):t._e()])]),t._v(" "),i("tr",[i("td",[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.cellmass")))]),t._v(" "),"greater"==t.info.DNA.cellNum?i("span",[t._v(">5000")]):"less"==t.info.DNA.cellNum?i("span",[t._v("≤5000")]):t._e()]),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.metaplastic")))]),t._v(" "),"1"==t.info.DNA.metaplasticCells?i("span",[t._v("有")]):"0"==t.info.DNA.metaplasticCells?i("span",[t._v("无")]):t._e()])]),t._v(" "),t._m(0),t._v(" "),i("tr",[i("td",{attrs:{width:"50%"}},[i("span",{staticClass:"weight600"},[t._v("炎细胞：")]),t._v(" "),"less"==t.info.DNA.inflammatoryCells?i("span",[t._v("少量")]):"medium"==t.info.DNA.inflammatoryCells?i("span",[t._v("中量")]):"more"==t.info.DNA.inflammatoryCells?i("span",[t._v("大量")]):t._e()]),t._v(" "),i("td",{attrs:{width:"50%"}},[i("span",{staticClass:"weight600"},[t._v("微生物:")]),t._v("\n            "+t._s(t.info.DNA.pathogen&&t.info.DNA.pathogen.length?t.info.DNA.pathogen.join(","):"无")+"\n          ")])]),t._v(" "),i("tr",[i("td",{attrs:{width:"50%"}},[i("span",{staticClass:"weight600"},[t._v("红细胞：")]),t._v(" "),"less"==t.info.DNA.erythrocyte?i("span",[t._v("少量")]):"medium"==t.info.DNA.erythrocyte?i("span",[t._v("中量")]):"more"==t.info.DNA.erythrocyte?i("span",[t._v("大量")]):t._e()]),t._v(" "),i("td",{attrs:{width:"50%"}},[i("span",{staticClass:"weight600"},[t._v("放疗：")]),t._v(" "),"1"==t.info.DNA.radiotherapy?i("span",[t._v("有")]):"0"==t.info.DNA.radiotherapy?i("span",[t._v("无")]):t._e()])]),t._v(" "),i("tr",[i("td",{attrs:{width:"50%"}},[i("span",{staticClass:"weight600"},[t._v("细胞萎缩：")]),t._v(" "),"1"==t.info.DNA.cataplasia?i("span",[t._v("有")]):"0"==t.info.DNA.cataplasia?i("span",[t._v("无")]):t._e()]),t._v(" "),i("td",{attrs:{width:"50%"}},[i("span",{staticClass:"weight600"},[t._v("宫内节育器：")]),t._v(" "),"1"==t.info.DNA.intrauterineDevice?i("span",[t._v("有")]):"0"==t.info.DNA.intrauterineDevice?i("span",[t._v("无")]):t._e()])])]),t._v(" "),i("div",{class:{opinion:!0,print:t.host}},[i("h4",{class:{title:!0,print:t.host}},[t._v(t._s(t.$t("report.point")))]),t._v(" "),i("div",{staticClass:"opinion-write",domProps:{innerHTML:t._s(t.opinion)}}),t._v(" "),i("div",{staticClass:"pic-index"},[i("img",{staticClass:"pic-index-img",attrs:{src:t.host?t.host+"/data/"+t.recordId+"/slices/"+t.sliceId+"dna_index.png":"/aipath/api/files/getImage?caseid="+t.recordId+"&fileid="+t.sliceId+"&type=histplot&date="+(new Date).getTime(),alt:""}})]),t._v(" "),i("div",{staticClass:"pic-index"},[i("img",{staticClass:"pic-index-img",attrs:{src:t.host?t.host+"/data/"+t.recordId+"/slices/"+t.sliceId+"scatterplot.png":"/aipath/api/files/getImage?caseid="+t.recordId+"&fileid="+t.sliceId+"&type=scatterplot&date="+(new Date).getTime(),alt:""}})]),t._v(" "),i("div",{staticClass:"opinion-write",domProps:{innerHTML:t._s(t.DNAOpinion)}}),t._v(" "),i("div",{staticClass:"opinion-write",domProps:{innerHTML:t._s(t.uniteOpinion)}})])]),t._v(" "),i("div",{staticClass:"pic"},[t.showRoi.length?i("div",{staticClass:"pic-tbs",class:t.host?"slice-list clearfix print":"slice-list clearfix"},[t._l([t.showRoi[0]],function(e){return i("div",{key:e.id,staticClass:"pic-tbs-content"},[i("img",{staticClass:"pic-tbs-content-img",attrs:{src:t.host?t.host+"/data/"+t.recordId+"/slices/"+e.fileid+"scatterplot.png":"/aipath/api/files/ROI?caseid="+t.recordId+"&fileid="+e.fileid+"&filename="+encodeURIComponent(e.filename)+"&roi=[["+Math.min.apply(Math,e.path.x)+","+Math.min.apply(Math,e.path.y)+"],["+Math.max.apply(Math,e.path.x)+","+Math.max.apply(Math,e.path.y)+"]] &roiid="+e.id,alt:""}})])}),t._v(" "),t.roishow?t._e():i("div",{staticClass:"slice-name"},[t._v("切片名称："+t._s(t.showRoi[0].filename))]),t._v(" "),i("div",{staticClass:"slice-name"},[t._v(t._s(t.showRoi[0].remark))])],2):i("div",{staticClass:"pic-tbs"}),t._v(" "),i("div",{staticClass:"pic-dna"},[t.list.length?i("div",{staticClass:"pic-dna-icons"},t._l(t.list,function(e){return i("div",{key:e.id,staticClass:"pic-dna-icon"},[i("img",{staticClass:"pic-dna-icon-img",attrs:{src:t.host?t.host+"/data/"+t.recordId+"/slices/"+e.fileid+"/roi/"+t.roi.id+".jpg":"/aipath/api/files/ROI?caseid="+t.recordId+"&fileid="+e.fileid+"&filename="+encodeURIComponent(e.filename)+"&roi=[["+Math.min.apply(Math,e.path.x)+","+Math.min.apply(Math,e.path.y)+"],["+Math.max.apply(Math,e.path.x)+","+Math.max.apply(Math,e.path.y)+"]] &roiid="+e.id,alt:""}}),t._v(" "),i("div",{staticClass:"roi-percent",class:{"red-color":e.di-0>=2.5}},[t._v(t._s(e.di))])])}),0):t._e(),t._v(" "),i("div",{staticClass:"dna-item-analy"},[i("li",{staticStyle:{color:"rgb(112,182,3)"}},[i("span",{staticClass:"dna-item-title"},[t._v("正常二倍体细胞")]),t._v("  "+t._s(t.tableData.num_normal))]),t._v(" "),i("li",{staticStyle:{color:"rgb(245,154,35)"}},[i("span",{staticClass:"dna-item-title"},[t._v("增生细胞")]),t._v("  "+t._s(t.tableData.num_abnormal_low))]),t._v(" "),i("li",{staticStyle:{color:"rgb(217,0,27)"}},[i("span",{staticClass:"dna-item-title"},[t._v("多倍体细胞")]),t._v("  "+t._s(t.tableData.num_abnormal_high>100?t.checkedArrayList.length+(t.tableData.num_abnormal_high-100):t.checkedArrayList.length))]),t._v(" "),i("li",[i("span",{staticClass:"dna-item-title"},[t._v("上皮细胞")]),t._v("  "+t._s(t.tableData.num_normal+t.tableData.num_abnormal_low+t.tableData.num_abnormal_high))])])])])])},staticRenderFns:[function(){var t=this.$createElement,e=this._self._c||t;return e("tr",[e("td",{attrs:{width:"50%"}},[e("span",{staticClass:"weight600"},[this._v("炎症以及反应性细胞改变")])])])}]};var v=i("VU/8")(d,p,!1,function(t){i("uBBm")},"data-v-0d09b26e",null).exports,m={render:function(){var t=this.$createElement,e=this._self._c||t;return e("div",[e("div",{class:{opinion:!0,print:this.host}},[e("h4",{staticClass:"title"},[this._v(this._s(this.$t("report.point")))]),this._v(" "),e("div",{staticClass:"opinion-write",domProps:{innerHTML:this._s(this.opinion)}})])])},staticRenderFns:[]};var g=i("VU/8")({props:["info","host"],computed:{opinion:function(){if(this.info.REG.opinion)return this.info.REG.opinion.replace(/\r\n/g,"<br>").replace(/\n/g,"<br>").replace(/\s/g," ")}}},m,!1,function(t){i("9u13")},"data-v-5ebbf3ba",null).exports,f={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("div",{class:{tct:!0,print:t.host}},[i("h4",{class:{title:!0,print:t.host}},[t._v(t._s(t.$t("basic.cancerTypeTitle")))]),t._v(" "),i("table",{class:{print:t.host},attrs:{cellspacing:"0"}},[i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.location"))+":")]),t._v(" "),i("span",{staticClass:"contentItem"},[t._v(t._s(t.info.ESD.locationId))])])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.operativeMethods"))+":")]),t._v(" "),i("span",{staticClass:"contentItem"},[t._v(t._s(t.info.ESD.operativeMethodId))])])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.specimenCompleteness"))+":")]),t._v(" "),i("span",{staticClass:"contentItem"},[t._v(t._s(t.info.ESD.specimenIntegrityId))])])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.mucosalSize"))+":")]),t._v(" "),i("span",{staticClass:"contentItem"},[t._v(t._s(t.info.ESD.mucosalSize))]),t._v(" mm\n                ")])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.numberofLesions"))+":")]),t._v(" "),i("span",{staticClass:"contentItem"},[t._v(t._s(t.info.ESD.numberofLesions))])])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.lesionRange"))+":")]),t._v(" "),i("span",{staticClass:"contentItem"},[t._v("宽度"+t._s(t.info.ESD.mucosalWidth)+"mm")]),i("span",{staticStyle:{"margin-left":"20px"}},[t._v("深度"+t._s(t.info.ESD.mucosalHeight)+"mm")])])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.grossType"))+":")]),t._v(" "),i("span",{staticClass:"contentItem"},[t._v(t._s(t.info.ESD.grossType))])])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.histologicalType"))+":")]),t._v(" "),i("span",{staticClass:"contentItem"},[t._v(t._s(t.info.ESD.histologicalType))])])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.histologyGrade"))+":")]),t._v(" "),i("span",{staticClass:"contentItem"},[t._v(t._s(t.info.ESD.histologyGrade))])])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.lauren"))+":")]),t._v(" "),i("span",{staticClass:"contentItem"},[t._v(t._s(t.info.ESD.lauren))])])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.invasionDepth"))+":")]),t._v(" "),i("span",{staticClass:"contentItem"},[t._v(t._s(t.info.ESD.invasionDepth))])])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.combinedUlcer"))+":")]),t._v(" "),0==t.info.ESD.isCombinedUlcer?i("span",[t._v("是")]):t._e(),1==t.info.ESD.isCombinedUlcer?i("span",[t._v("否")]):t._e()])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.tumorThrombus"))+":")]),t._v(" "),0==t.info.ESD.isTumorThrombus?i("span",[t._v("是")]):t._e(),1==t.info.ESD.isTumorThrombus?i("span",[t._v("否")]):t._e()])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.nerveInvasion"))+":")]),t._v(" "),0==t.info.ESD.isNerveInvasion?i("span",[t._v("是")]):t._e(),1==t.info.ESD.isNerveInvasion?i("span",[t._v("否")]):t._e()])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.wettingPattern"))+":")]),t._v(" "),i("span",{staticClass:"contentItem"},[t._v(t._s(t.info.ESD.wettingPattern))])])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.astricMucosa"))+":")]),t._v(" "),i("span",{staticClass:"contentItem"},[t._v(t._s(t.info.ESD.astricMucosa))])])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.horizontalPMH"))+":")]),t._v(" "),1==t.info.ESD.horizontalPMH?i("span",[t._v("阴性，最近距离阳性为"+t._s(t.info.ESD.PMH)+"mm")]):t._e(),t._v(" "),0==t.info.ESD.horizontalPMH?i("span",[t._v("阳性")]):t._e()])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.verticalPVM"))+":")]),t._v(" "),1==t.info.ESD.verticalPVM?i("span",[t._v("阴性，最近距离阳性为"+t._s(t.info.ESD.PVM)+"mm")]):t._e(),t._v(" "),0==t.info.ESD.verticalPVM?i("span",[t._v("阳性")]):t._e()])]),t._v(" "),i("tr",[i("td",{attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.others"))+":")]),t._v(" "),i("span",{staticClass:"contentItem"},[t._v(t._s(t.info.ESD.others))])])])])]),t._v(" "),i("div",{class:{opinion:!0,print:t.host}},[i("h4",{class:{title:!0,print:t.host}},[t._v(t._s(t.$t("report.remark")))]),t._v(" "),i("div",{staticClass:"opinion-write",domProps:{innerHTML:t._s(t.opinion)}})]),t._v(" "),i("el-row",{attrs:{gutter:20}},[i("el-col",{attrs:{span:8}},[i("div",{staticClass:"grid-content"},[i("img",{staticClass:"img_esd",attrs:{src:t.info.ESD.src1,alt:""}})])]),t._v(" "),i("el-col",{attrs:{span:8}},[i("div",{staticClass:"grid-content"},[i("img",{staticClass:"img_esd",attrs:{src:t.info.ESD.src2,alt:""}})])]),t._v(" "),i("el-col",{attrs:{span:8}},[i("div",{staticClass:"grid-content"},[i("img",{staticClass:"img_esd",attrs:{src:t.info.ESD.src3,alt:""}})])])],1)],1)},staticRenderFns:[]};var _=i("VU/8")({props:["info","host"],computed:{opinion:function(){if(this.info.ESD.opinion)return this.info.ESD.opinion.replace(/\r\n/g,"<br>").replace(/\n/g,"<br>").replace(/\s/g," ")}}},f,!1,function(t){i("Ii/p")},"data-v-137dc25a",null).exports,y={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[i("h4",{class:t.host?"reference print":"reference"},[t._v(t._s(t.$t("report.references")))]),t._v(" "),i("ul",t._l(t.references,function(e,s){return i("li",{key:s,class:t.host?"refer-items print":"refer-items"},[t._v("\n            "+t._s(s+1+".")+t._s(e)+"\n        ")])}),0)])},staticRenderFns:[]};var b=i("VU/8")({props:["host"],data:function(){return{references:['Lin Yang, Peter Meer and David J. Foran, "Unsupervised analysis of imaged pathology specimens based on robust estimation and color active contour models", IEEE Transaction on Information Technology in Biomedicine (TITB), Vol. 9, No. 1, pp. 475-486, 2005.','Oncel Tuzel, Lin Yang, Peter Meer and David J. Foran, "Classification of hematologic malignancies using texton signatures", Pattern Analysis and Applications (PAA), Vol. 10, No. 4, pp. 277-290, 2007.','Lin Yang, Wenjin Chen, Peter Meer, Gratian Salaru, Viktors Berstis and David J. Foran, "Virtual microscopy and grid-enabled decision support for large scale analysis of imaged pathology specimens", IEEE Transaction on Information Technology in Biomedicine (TITB), Vol. 13, No. 4, pp. 636-644, 2009','Lin Yang, Oncel Tuzel, Wenjin Chen, Peter Meer, Gratian Salaru, Lauri A. Goodell and David J. Foran, "PathMiner: A web-based tool for computer assisted diagnostics in pathology", IEEE Transaction on Information Technology in Biomedicine (TITB). Vol. 13, No. 3, pp. 291-299, 2009','Jianqin Qu, Leiguang Gong and Lin Yang, "A 3D point matching algorithm for affine registration", International Journal of Computer Assisted Radiology and Surgery, Vol. 6, No. 2, pp. 229-236, 2010.','Lin Yang, Bogdan Georgescu, Yefeng Zheng, Wang Yang, Peter Meer and Dorin Comaniciu, "Prediction based collaborative trackers (PCT): A robust and accurate approach toward 3D medical object tracking ", IEEE Transaction on Medical Imaging (TMI), Vol. 30, No. 11, pp. 1921-1932, 2011','David J. Foran , Lin Yang, Wenjin Chen, Jun Hu, Lauri A. Goodell, Michael Reiss, Fusheng Wang, Tahsin Kurc, Tony Pan, Ashish Sharma, and Joel Saltz. "Image miner: Comparative analysis of tissue microarrays using content based image retrieval, high performance computing, and Grid technology", Journal of American Medical Information Association (JAMIA), Vol. 18, No. 4, pp. 403-415, 2011','David J. Foran, Wenjin Chen and Lin Yang, "Automated image interpretation computer-assisted diagnosis", Analytical Cellular Pathology, Vol. 34, No. 6, pp. 279-300, 2011','Xin Qi, Fuyong Xing, David J. Foran and Lin Yang, "Robust segmentation of overlapping cells in histopathology specimens using parallel seed detection and repulsive level set ", IEEE Transaction on Biomedical Engineering (TBME), Vol. 59, No. 3, pp. 754-765, 2012',"Rebekah H. Gensure, David J. Foran, Vincent M. Lee, Vyacheslav M Gendal, Salma K Jabbour, Darren R Carpizo, John L. Nosher, and Lin Yang, “Evaluation of hepatic tumor response to yttrium-90 radioembolization therapy using texture signatures generated from contrast-enhanced CT”, Academic Radiology, Vol. 19, No. 10, pp. 1201-1207, 2012.",'Xin Qi, Fuyong Xing, David J. Foran, Lin Yang, "A Fast, Automatic Segmentation Algorithm for Locating and Delineating Touching Cell Boundaries in Imaged Histopathology ", Journal of Methods in Medical Informatics, Vol. 51, No. 3, pp. 91- 102, 2012',"Xin Qi, Hyunjoo Kim, Fuyong Xing, Manish Parashar, David J. Foran, Lin Yang, “The Analysis of Image Feature Robustness Using CometCloud”, Vol. 3. No. 33, pp. 1-13, Journal of Pathology Informatics, 2012.","Baiyang Liu, Junzhou Huang, Casimir Kulikowski, Lin Yang, “Robust Visual Tracking Using Local Sparse Appearance Model and K-selection”, IEEE Transaction on Pattern Analysis and Machine Intelligence (TPAMI), Vol. 35, No. 12, pp. 2968-2981, 2013.","Joythi Mula, Jonah D. Lee, Fujun Liu, Lin Yang, Charlotte A. Peterson, “Automated Image Analysis of Skeletal Muscle Fiber Cross-sectional Area”, Journal of Applied Physiology (JAP), Vol. 114, No. 1, pp. 148-155, 2013.","Fujun Liu, Abigail L. Mackey, Ratchakrit Srikuea, Karyn Esser, Lin Yang, “Automated Image Segmentation of Hemotoxylin and Eosin Stained Skeletal Muscle Cross-Sections”, Journal of Microscopy, Vol. 253, No. 3, pp. 275-285, 2013","Hai Su, Fuyong Xing, Jonah Lee, Charlotte Peterson, Lin Yang, “Automatic Myonuclear Detection in Isolated Single Muscle Fiber Using Robust Ellipse Fitting and Sparse Optimization”, IEEE/ACM Transaction on Computational Biology and Bioinformatics (TCBB), 14 pages, 2013","Fujun Liu, Christopher S. Fry, Jyothi Mula, Janna R. Jackson, Jonah D. Lee, Charlotte A. Peterson, Lin Yang, “Automated Fiber-type-specific Cross-sectional Area Assessment and Myonuclei Counting in Skeletal Muscle”, Journal of Applied Physiology (JAP), Vol. 115, No. 11, pp. 1714-1724, 2013","Lin Yang, Xin Qi, Fuyong Xing, Tahsin Kurc, Joel Saltz, David J. Foran, “Parallel Content Based Sub-image Retrieval Using Hierarchical Searching”, Bioinformatics, Vol. 30, No. 7, pp. 996-1002, 2014",'Hui Meng, Paul M. L. Janssen, Robert W. Grange, Lin Yang, Alan H. Beggs, Lindsay C. Swanson, Stacy A. Cossette, Alison Frase, Martin K. Childers, Henk Granzier, Emanuela Gussoni, Michael W. Lawlor, "Tissue triage and freezing for models of skeletal muscle disease", Journal of Visualized Experiments (JOVE), No. 89, 2014',"Michael W. Lawlor, Marissa G. Viola, Hui Meng, Rachel V. Edelstein, Fujun Liu, Ke Yang, Elizabeth J. Luna, Alexandra Lerch-Gaggl, Raymond G. Hoffmann, Christopher R. Pierson, Anna Buj-Bello, Jennifer L. Lachey, Scott Pearsall, Lin Yang, Cecilia Hillard, Alan H. Beggs, “Differential Muscle Hypertrophy Is Associated With Satellite Cell Numbers And Akt Pathway Activation Following Activin Type IIB Receptor Inhibition In Mtm1 p.R69C Mice”, American Journal of Pathology, Vol. 184, No. 6, pp. 1831-1842, 2014","Hongyuan Wang, Fuyong Xing, Hai Su, Arnold Stromberg, and Lin Yang, “Novel image markers for non-small cell lung cancer classification and survival prediction”, BMC Bioinformatics, Vol. 19, No. 15, pp. 310-324, 2014.","Xin Qi, Daihou Wang, Ivan Rodero, Javier Diaz-Montes, Rebekah H Gensure, Fuyong Xing, Hua Zhong, Lauri Goodell, Manish Parashar, David J Foran, Lin Yang, “Content-based histopathology image retrieval using CometCloud”, BMC Bioinformatics, Vol. 15, pp. 287-300, 2014",'Sandra Donkervoort, Ying Hu, Tanya Stojkovic, Nicol Voermans, A. Reghan Foley, Meganne E Leach, Jahannaz Dastgir, Veronique Bolduc, Thomas Cullup, Alix de Becdelievre, Lin Yang, Hai Su, Katherine Meilleur, Alice Schindler, Erik-Jan Kamsteeg, Pascale Richard, Russell Butterfield, Thomas L. Winder, Thomas Crawford, Robert B. Weiss, Francesco Muntoni, Valerie Allamand, Carsten G. Bonnemann, "Mosaicism for dominant COLVI mutations as a cause for intra-familial phenotypic variability", Human Mutation, Vol. 36, No. 1, pp. 48-56, 2014','Michael Spencer, Lin Yang, Akosua Adu, Brian S. Finlin, Beibei Zhu, Lindsey R. Shipp, Neda Rasouli, Charlotte A. Peterson, Philip Kern, "Pioglitazone treatment reduces adipose tissue inflammation through reduction of mast cell and macrophage number and by improving vascularity", PLOS ONE, Vol. 9, No. 7, 2014.','Nicolas Wein, Adeline Vulin, Maria Sofia Falzarano, Christina Al-Khalili Szigyarto, Baijayanta Maiti, Andrew Findlay, Kristin H. Heller, Mathias Uhlen, Baskar Bakthavachalu, Sonia Messina, Giuseppe Vita, Chiara Passarelli, Francesca Gualandi, Steve D. Wilton, Louise Rodino-Klapec, Lin Yang, Diane M. Dunn, Daniel Schoenberg, Robert B. Weiss, Michael T. Howard, Alessandra Ferlini, Kevin M. Flanigan, "A novel DMD IRES results in a functional N-truncated dystrophin, providing a potential route to therapy for patients with 5’ mutations", Nature Medicine, Vol. 20, No. 9, pp. 992-1000, 2014.',"Fuyong Xing, Hai Su, Janna Neltner, Lin Yang, “Automatic Ki-67 Counting Using Robust Cell Detection and Online Dictionary Learning”, IEEE Transaction on Biomedical Engineering (TBME), Vol. 61, No. 3, pp. 859-870, 2014",'Christopher S. Fry, Jonah D. Lee, Jyothi Mula, Tyler J. Kirby, Janna R. Jackson, Fujun Liu, Lin Yang, Esther E. Dupont-Versteegden, John J. McCarthy, Charlotte A. Peterson, "Inducible depletion of satellite cells in adult, sedentary mice impairs muscle regenerative capacity without affecting sarcopenia", Nature Medicine, Vol. 21, pp. 76-80, 2015.','Xiaofan Zhang, Fuyong Xing, Hai Su, Lin Yang, Shaoting Zhang, "High throughput histopathology image analysis via robust cell segmentation and hashing", Medical Image Analysis, Vol. 26, No. 1, pp. 306-315, 2015.',"Tahsin Kurc, Xin Qi, Daihou Wang, Fusheng Wang, George Teodoro, Lee Cooper, Michael Nalisnik, Lin Yang, Joel Saltz, David J Foran, “Scalable Analysis of Big Pathology Image Data Cohorts using Efficient Methods and High-Performance Computing Strategies”, BMC Bioinformatics, Vol. 16, No. 399, 2015","Hai Su, Fuyong Xing, Lin Yang, “Robust cell detection of histopathological brain tumor images using sparse reconstruction and adaptive dictionary selection”, IEEE Transaction on Medical Imaging, Vol. 35, No. 6, 2016.","Fuyong Xing, Lin Yang, “An automatic learning-based framework for robust nucleus segmentation”, IEEE Transaction on Medical Imaging, Vol. 35, No. 2, pp. 550-566, 2016.","Fuyong Xing, Lin Yang, “Robust nucleus/cell detection and segmentation for digital pathology and microscopic images: A comprehensive review”, IEEE Reviews in Biomedical Engineering, No. 9, pp. 234-263, 2016.","Xiaoshuang Shi, Zhenhuo Guo, Feiping Nie, Lin Yang, Jane You, and Dacheng Tao, “Two-dimensional whitening reconstruction for enhancing robustness of principle component analysis”, IEEE Transaction on Pattern Analysis and Machine Intelligence, Vol. 38, No. 10, pp. 2130-2136, 2016","Manish Sapkota, Fujun Liu, Yuanpu Xie, Hai Su, Fuyong Xing, Lin Yang, “AIIMD: An integrated framework of automatic idiopathic inflammatory myopathy diagnosis for muscle”, IEEE Journal of Biomedical and Health Informatics, 2017","Yuanpu Xie, Fuyong Xing, Xiaoshuang Shi, Xiaofei Kong, Hai Su, Lin Yang, “Efficient and robust cell detection: A structured regression approach”, Medical Image Analysis, 2017","Xiaoshuang Shi, Fuyong Xing, Kaidi Xu, Yuanpu Xie, Hai Su, Lin Yang, “Supervised graph hashing for histopathology image retrieval and classification”, Medical Image Analysis, Vol. 22, pp. 117-128, 2017","Zizhao Zhang, Fuyong Xing, Xiaoshuang Shi, Lin Yang, “Revisiting Graph Construction for Fast Image Segmentation”, Pattern Recognition (PR), 2018","Yuanpu Xie, Fuyong Xing, Lin Yang, “Deep Voting and Structured Regression for Microscopy Image Analysis” In Deep Learning for Medical Image Analysis (pp. 155-175), 2018",'Xiaoshuang Shi, Manish Sapkota, Fuyong Xing, Fujun Liu, Lei Cui, Lin Yang, "Pairwise based deep ranking hashing for histopathology image classification and retrieval", accepted to Pattern Recognition, 2018',"Xiaoshuang Shi, Fuyong Xing, Jinzheng Cai, Lin Yang, “Self-learning for face clustering”, accepted to Pattern Recognition, 2018",'Lin Yang, Peter Meer and David J. Foran, "Multiple class segmentation using a unified framework over mean-shift patches", Proc. IEEE International Conference on Computer Vision and Pattern Recognition (CVPR), Vol. 1, pp. 1-8, June 2007.','Lin Yang, Wenjin Chen, Peter Meer, Gratian Salaru, Michael D. Feldman and David J. Foran, "High throughput analysis of breast cancer specimens on the Grid", Proc. International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Vol. 10, pp. 617-625, 2007.','Lin Yang, Bogdan Georgescu, Yefeng Zheng, David J. Foran and Dorin Comaniciu. "A fast and accurate tracking algorithm of left ventricles in 3D echocardiography", Proc. International Symposium on Biomedical Imaging (ISBI), Vol. 5, pp. 221-224, 2008.','Lin Yang, Bogdan Georgescu, Yefeng Zheng, Peter Meer and Dorin Comaniciu, "3D Ultrasound tracking of the left ventricle using one-step forward prediction and data fusion of collaborative trackers", Proc. IEEE International Conference on Computer Vision and Pattern Recognition (CVPR), Vol. 1, pp. 1-8, 2008.','Lin Yang, Oncel Tuzel, Peter Meer and David J. Foran, "Automatic image analysis of histopathology specimens using concave vertex graph", Proc. International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Vol. 11, pp. 833-841, 2008.','Hong Zhang, Lin Yang, David J. Foran, John Nosher, Peter Yim, "3D segmentation of the liver using free-form deformation based on boosting and deformation gradients", Proc. IEEE International Symposium on Biomedical Imaging (ISBI), Vol. 1, pp. 494-497, 2009.','David J. Foran, Lin Yang, Oncel Tuzel, Wenjin Chen, Jun Hu, Tahsin Kurc, Renato Ferreira, Joel Saltz, "A caGrid-enabled, learning based image segmentation method for histopathology specimens", Proc. IEEE International Symposium on Biomedical Imaging (ISBI), Vol. 1, pp. 1306-1309, 2009.','Baiyang Liu, Lin Yang, Casimir Kulikowski, Jinghao Zhou, Leiguang Gong, David J. Foran, Salma J. Jabbour and Ning J. Yue. "An adaptive tracking algorithm of lung tumors in fluoroscopy using online learned collaborative trackers ", IEEE International Symposium on Biomedical Imaging (ISBI), Vol. 1, pp. 209-212, 2010','Baiyang Liu, Lin Yang, Junzhou Huang, P. Meer, Leiguang Gong, Casimir Kulikowski, "Robust and fast visual tracking with two stage sparse optimization", European Conference on Computer Vision (ECCV), Vol. 6314, pp. 624-637, 2010','Tahsin Kurc, Patrick Widener, Wenjin Chen, Fusheng Wang, Lin Yang, Jun Hu, Vijay Kumar, Vicky Chu, Lee Cooper, Jun Kong, Ashish Sharma, Tony Pan, Joel Saltz, David Foran, "Grid-enabled, high-performance microscopy image analysis", High Performance Computing (HP) workshop associated with Proc. International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Beijing, China, 2010','Xin Qi, Fuyong Xing, David J. Foran and Lin Yang, "GPU enabled parallel touching cell segmentation using mean shift based seed detection and repulsive level set", High Performance Computing (HP) workshop associated with Proc. International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Beijing, China, 2010','Xin Qi, Hyunjoo Kim, Fuyong Xing, Manish Parashar, David Foran and Lin Yang, "The Analysis of Image Texture Feature Robustness Using CometCloud", High Performance Computing (HP) Workshop associated with Proc. International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Toronto, Canada, 2011','Lin Yang, Hyunjoo Kim, Manish Parashar and David Foran, "High Throughput Landmark Based Image Registration Using Cloud Computing", High Performance Computing (HP) workshop associated with Proc. International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Toronto, Canada, 2011','Baiyang Liu, Junzhou Huang, Casimir Kulikowski, Lin Yang, "Robust tracking using local sparse appearance model and K-Selection", Proc. IEEE International Conference on Computer Vision and Pattern Recognition (CVPR), Vol. 1, pp. 1-8, 2011',"Xin Qi, Fuyong Xing, Meghana Ghadge, Ivan Rodero, Moustafa Abdelbaky, Manish Parashar, Evita Sadimin, David Foran, Lin Yang, “Content-based Image Retrieval on Imaged Peripheral Blood Smear Specimens using High Performance Computation”, Data- and Compute-intensive Clinical and Translation Imaging associated with the International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Nice, France, 2012","Fuyong Xing, Xin Qi, David Foran, Tahsin Kurc, Joel Saltz, Lin Yang, “Content-based Parallel Sub-image Retrieval”, Data- and Compute-intensive Clinical and Translation Imaging associated with the International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Nice, France, 2012","Fuyong Xing, Lin Yang, “Robust non-small cell lung cancer classification using molecular morphological features”, International Symposium on Biomedical Imaging (ISBI), 2013","Hai Su, Fuyong Xing, Jonah Lee, Charlotte Peterson, Lin Yang, “Learning based automatic detection of myonuclei in isolated single skeletal muscle fibers using multi-focus image fusion”, International Symposium on Biomedical Imaging (ISBI), 2013","Fuyong Xing, Lin Yang, “Robust Selection-based Sparse Shape Model for Lung Cancer Image Segmentation”, The 16th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Nagoya, Japan, 2013","Fuyong Xing, Hai Su, Lin Yang, “An Integrated Framework for Automatic Ki-67 Scoring in Pancreatic Neuroendocrine Tumor”, The 16th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Nagoya, Japan, 2013","Xin Qi, Daihou Wang, Javier Diaz-Montes, Ivan Rodero, Tony Pan, Abulimit Aji, Lee Cooper, Fuyong Xing, Manish Parashar, David J. Foran, Lin Yang, “Exploring Online Nuclear Segmentation on Large Fluorescence Brain Tumor Images Using CometCloud”, Accepted to the Six High Performance Computing Workshop Associated with The 16th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Nagoya, Japan, 2013","Daihou Wang, Xin Qi, Manish Parashar, David J. Foran, Lin Yang, “High Throughput Content-based Image Retrieval Using GPGPU”, Accepted to the Six High Performance Computing Workshop Associated with The 16th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Nagoya, Japan, 2013","Manish Sapkota, Fujun Liu, Lin Yang, “Distributed Content Based Image Retrieval for Skeletal Muscle Images Using Kd-Tree and MapReduce”, Accepted to the Six High Performance Computing Workshop Associated with The 16th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Nagoya, Japan, 2013","Fujun Liu, Fuyong Xing, Lin Yang, “Robust muscle cell segmentation using region selection with dynamic programming”, Accepted to 2014 International Symposium on Biomedical Imaging (ISBI), 2014","Fujun Liu, Fuyong Xing, Hai Su, Lin Yang, “Touching adipocyte cells decomposition using combinatorial optimization”, Accepted to 2014 International Symposium on Biomedical Imaging (ISBI), 2014","Xiaofan Zhang, Lin Yang, Wei Liu, Hai Su, Shaoting Zhang, “Mining histopathology images via composite hashing and online learning”, Accepted to The 17th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Boston, MA, U. S. A., 2014","Fuyong Xing, Manish Sapkota, Lin Yang, “Histopathology lung cancer image mining with Kd-tree and MapReduce”, Accepted to the Seventh High Performance Computing Workshop Associated with The 16th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Boston, MA, U. S. A. 2014","Daihou Wang, Manuel Diaz Granados, Javier Diaz-Montes, Ivan Rodero, Lin Yang, Manish Parashar, David J. Fordan, Xin Qi, “High-throughput Automatic Gleason-grading System for Prostate Histopathology Images using CometCloud”, Accepted to the Seventh High Performance Computing Workshop Associated with The 16th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Boston, MA, U. S. A. 2014",'Hai Su, Fujun Liu, Yuanpu Xie, Fuyong Xing, Sreenivasan Meyyappan, Lin Yang, "Region segmentation in histopathological breast cancer images using deep convolutional neural network", Accepted to the 2015 International Symposium on Biomedical Imaging (ISBI), 2015','Fuyong Xing, Lin Yang, "Unsupervised shape prior modeling for cell segmentation in neuroendocrine tumor", Accepted to the 2015 International Symposium on Biomedical Imaging (ISBI), 2015','Manish Sapkota, Fuyong Xing, Hai Su, Lin Yang, "Automatic muscle perimysium annotation using deep convolutional neural network", Accepted to the 2015 International Symposium on Biomedical Imaging (ISBI), 2015',"Xiaofan Zhang, Hai Su, Lin Yang, Shaoting Zhang, “Weighted hashing with multiple cues for cell-level analysis of histopathology images”, Accepted to the 2015 International 24th Biennial International Conference on Information Processing in Medical Imaging (IPMI), 2015","Xiaofan Zhang, Hai Su, Lin Yang, Shaoting Zhang, “Scalable analysis of histopathology images via robust cellular segmentation and weighted hashing”, Accepted to the 2015 International Conference on Computer Vision and Patter Recognition (CVPR), 2015","Fuyong Xing, Lin Yang, “Fast Cell Segmentation Using Scalable Sparse Manifold Learning and Affine Transform-approximated Active Contour”, Accepted to The 18th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Munich, Germany, 8 pages, 2015","Fujun Liu, Fuyong Xing, Zizhao Zhang, Mason Mcgough, Lin Yang, “Robust Muscle Cell Quantification Using Structured Edge Detection and Hierarchical Segmentation”, Accepted to The 18th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Munich, Germany, 8 pages, 2015","Fujun Liu, Lin Yang, “A Novel Cell Detection Method Using Deep Convolutional Neural Network and Maximum-Weight Independent Set”, Accepted to The 18th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Munich, Germany, 8 pages, 2015","Yuanpu Xie, Fuyong Xing, Xiangfei Kong, Hai Su, Lin Yang, “Beyond Classification: Structured Regression For Robust Cell Detection Using Convolutional Neural Network”, Accepted to The 18th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Munich, Germany, 8 pages, 2015","Yuanpu Xie, Xiangfei Kong, Fuyong Xing, Fujun Liu, Hai Su, Lin Yang, “Deep Voting: A Robust Approach Towards Nucleus Localization In Microscopy Images”, Accepted to The 18th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Munich, Germany, 8 pages, 2015","Hai Su, Fuyong Xing, Xiangfei Kong, Yuanpu Xie, Shaoting Zhang, Lin Yang, “Robust Cell Detection and Segmentation in Histopathological Images using Sparse Reconstruction and Stacked Denoising Autoencoders”, Accepted to The 18th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Munich, Germany, 8 pages, 2015","Menglin Jiang, Shaoting Zhang, Junzhou Huang, Lin Yang, Dimitris Metaxas, “Joint Kernel-Based Supervised Hashing for Scalable Histopathological Image Analysis”, Accepted to The 18th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), Munich, Germany, 8 pages, 2015",'Yuanpu Xie, Zizhao Zhang, Manish Sapkota, Lin Yang, "Spatial Clockwork Recurrent Neural Network for Muscle Perimysium Segmentation", Accepted to The 19th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), 2016.','Fuyong Xing, Xiaoshuang Shi, Zizhao Zhang, Jinzheng Cai, Yuanpu Xie, Lin Yang, "Transfer Shape Priors Towards High-throughput Microscopy Image Segmentation", Accepted to The 19th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), 2016.','Jinzheng Cai, Le Lu, Qian Yin, Zizhao Zhang, Fuyong Xing, Lin Yang, "Pancreas Segmentation using Graph based Data Fusion with Convolutional Neural Networks", Accepted to The 19th International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), 2016.','Zizhao Zhang, Fuyong Xing, Xiaoshuang Shi, Lin Yang, "SemiContour: A semi-supervised learning approach for contour detection", IEEE International Conference on Computer Vision and Pattern Recognition (CVPR), 2016','Xiaoshuang Shi, Fuyong Xing, Jinzheng Cai, Zizhao Zhang, Yuanpu Xie, Lin Yang, "Kernel-based supervised discrete hashing for image retrieval", European Conference on Computer Vision (ECCV), 2016.','Zizhao Zhang, Yuanpu, Xie, Fuyong Xing, Mason Mcgough, Lin Yang, "MDNet: A Semantically and Visually Interpretable Medical Image Diagnosis Network", IEEE Conference on Computer Vision and Pattern Recognition (CVPR), 2017 oral (2.7% acceptance rate)','Zizhao Zhang, Pingjun Chen, Manish Sapkota, Lin Yang, "TandemNet: Distilling Knowledge from Medical Images Using Diagnostic Reports as Optional Semantic References", International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), 2017 oral (3.6% acceptance rate)','Xiaoshuang Shi, Fuyong Xing, Kaidi Xu, Manish Sapkota, Lin Yang, "Asymmetric discrete graph hashing", The thirty-first AAAI conference on Artificial Intelligence (AAAI), 2017','Jinzheng Cai, Le Lu, Yuanpu Xie, Fuyong Xing, Lin Yang, "Improving deep pancreas segmentation in CT and MRI image via recurrent neural contextual learning and direct loss function", International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), 2017','Xiaoshuang Shi, Fuyong Xing, Yuanpu Xie, Lin Yang, "Cell encoding for histopathology image classification", International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI), 2017',"Zizhao Zhang*, Yuanpu Xie*, Lin Yang, “Photographic Text-to-Image Synthesis with a Hierarchically-nested Adversarial Network”, International Conference on Computer Vision and Pattern Recognition (CVPR), 2018, Spotlight (~8%) * indicates equal contribution","Zizhao Zhang, Lin Yang, Y. Zheng, “Translating and Segmenting Multimodal Medical Volumes with Cycle- and Shape-Consistency Generative Adversarial Network”, International Conference on Computer Vision and Pattern Recognition (CVPR), 2018",'Mehmet Celenk, Lin Yang, Ganti Kamalakar, Derek J. Bleyle, Sudhir K. Sunkara, Yufei Wang, Philip Prudich, Yuangcui Huang and Qiang Zhou, "Tumor detection in VIVO NIRF imaging", Vol. 5370, SPIE International Symposium on Medical Imaging (SPIE), 2004.','Lin Yang, Jundong Liu, Charles D. Cavanaugh and Lonnie R. Welch, "A robust QoS forecasting algorithm for a dynamic, distributed real-time testbed", Proc. IEEE International Workshop on Computer Architectures for Machine Perception (WCAMP), New Orleans, LA, May, 2003','Lin Yang, Jundong Liu, Charles D. Cavanaugh and Lonnie R. Welch, "A L2E-based QoS forecasting technique for dynamic, distributed real-time systems", Proc. International Conference on Parallel and Distributed Processing Techniques and Applications (PDPTA), 2004.','Dazhang Gu, Lin Yang and Lonnie R. Welch. "A predictive, decentralized load balancing approach", 19th Proc. IEEE International Parallel and Distributed Processing Symposium (IPDPS), Vo1. 1, pp. 101-110, 2005.','Lin Yang and David J. Foran. "A variational framework for partially occluded image segmentation using coarse to fine shape alignment and semi-parametric density approximation", Proc. IEEE International Conference on Image Processing (ICIP), Vol. 1, pp. 78-82, 2007.','Lin Yang, Leiguang Gong, Hong Zhang, John L. Nosher and David J. Foran, "A multicore based parallel image registration method", Proc. International Conference on Engineering in Medicine and Biology Society (EMBS), Vol. 1, pp. 98-101, 2009.','Lin Yang, Leiguang Gong, Hong Zhang, John L. Nosher and David J. Foran, "A parallel point matching algorithm for landmark based image registration using multicore platform", European Conference on Parallel Computing (Euro-par), Vol. 5704, pp. 936-947, 2009.','Hyunjoo Kim, Manish Parashar, David J. Foran and Lin Yang, "Investigating the use of automatic cloudbursts for high-throughput medical image registration", IEEE International Conference on Grid Computing (GRID), Vol. 1, pp. 34-41, 2009.','Fuyong Xing, Baiyang Liu, Xin Qi, David J. Foran and Lin Yang, "Digital tissue microarray classification using sparse reconstruction", SPIE International Symposium on Medical Imaging (SPIE), 2012',"Hai Su, Yong Shen, Fuyong Xing, Xin Qi, Kim M. Hirshfield, Lin Yang, and David J. Foran, “Robust automatic breast cancer staging using a combination of functional genomics and image-omics”, Proc. International Conference on Engineering in Medicine and Biology Society (EMBS), accepted, 5 pages, 2015"]}}},y,!1,function(t){i("bahX")},"data-v-428021ea",null).exports,R={props:["basic","host"],computed:{gender:function(){return"zh"==(this.host?window.lang:i18n.locale)?{"男":"男","女":"女","其他":"其他"}:{"男":"M","女":"F","其他":"O"}}}},C={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"person-info"},[i("h4",{class:{title:!0,print:t.host}},[t._v(t._s(t.$t("basic.basic")))]),t._v(" "),i("table",{class:{print:t.host},attrs:{cellspacing:"0"}},[i("tr",{attrs:{valign:"top"}},[i("td",{attrs:{width:"40%"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.name")))]),t._v("\n                "+t._s(t.basic.name)+"\n            ")]),t._v(" "),i("td",{attrs:{width:"40%"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("basic.sex")))]),t._v("\n                "+t._s(t.gender[t.basic.gender])+"\n            ")]),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("basic.age")))]),t._v("\n                "+t._s(t.basic.age)+"\n            ")])]),t._v(" "),i("tr",{attrs:{valign:"top"}},[i("td",{attrs:{width:"40%"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("basic.sampleCollectDate")))]),t._v("\n                "+t._s(t.basic.sampleCollectDate)+"\n            ")]),t._v(" "),i("td",{attrs:{width:"40%"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("report.caseid")))]),t._v("\n                "+t._s(t.basic.caseid)+"\n            ")]),t._v(" "),i("td",[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("basic.samplePart")))]),t._v("\n                "+t._s(t.basic.samplePart)+"\n            ")])]),t._v(" "),i("tr",{attrs:{valign:"top"}},[i("td",{attrs:{width:"40%"}},[i("span",{staticClass:"weight600"},[t._v("送检医院：")]),t._v("\n                "+t._s(t.basic.inspectionHospital)+"\n            ")]),t._v(" "),i("td",{attrs:{colspan:"2"}},[i("span",{staticClass:"weight600"},[t._v("送检医生：")]),t._v("\n                "+t._s(t.basic.inspectionDoctor)+"\n            ")])]),t._v(" "),i("tr",{attrs:{valign:"top"}},[i("td",{staticClass:"dias",attrs:{colspan:"3"}},[i("span",{staticClass:"weight600"},[t._v(t._s(t.$t("basic.cancerType")))]),t._v(" "),i("span",{staticStyle:{display:"inline-block",width:"500px","min-height":"20px","vertical-align":"top","line-height":"20px"}},[t._v(t._s(t.basic.cancerType))])])])])])},staticRenderFns:[]};var w=i("VU/8")(R,C,!1,function(t){i("ssjl")},"data-v-50d3c3c8",null).exports,k={props:["slices","recordId","host","type","roishow"],data:function(){return{list:[]}},methods:{checkData:function(){var t=[];[].concat(r()(this.slices.dna)).length&&(t=[].concat(r()(this.slices.dna)).filter(function(t){return"dnaIcon"!==t.iconType})),this.list=[].concat(r()(this.slices.human),r()(this.slices.tct),r()(t))}},watch:{slices:{immediate:!0,deep:!0,handler:function(t){this.slices=t,"dna"==this.type?this.checkData():this.list=[].concat(r()(this.slices.human),r()(this.slices.tct))}},type:{immediate:!0,deep:!0,handler:function(t){this.type=t,"dna"==this.type?this.checkData():this.list=[].concat(r()(this.slices.human),r()(this.slices.tct))}}}},x={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{class:{microscope:!0,print:t.host}},[i("h4",{class:{title:!0,print:t.host}},[t._v("镜下所见")]),t._v(" "),i("div",{staticClass:"slices"},[t.slices.human&&t.slices.human.length||t.slices.tct&&t.slices.tct.length||t.slices.dna&&t.slices.dna.length?i("div",{staticClass:"card"},t._l([].concat(t.list),function(e){return i("div",{key:e.id,class:t.host?"slice-list clearfix print":"slice-list clearfix"},[i("div",{staticClass:"fleft"},[i("img",{attrs:{src:t.host?t.host+"/data/"+t.recordId+"/slices/"+e.fileid+"/roi/"+t.ai.id+".jpg":"/aipath/api/files/ROI?caseid="+t.recordId+"&fileid="+e.fileid+"&filename="+encodeURIComponent(e.filename)+"&roi=[["+Math.min.apply(Math,e.path.x)+","+Math.min.apply(Math,e.path.y)+"],["+Math.max.apply(Math,e.path.x)+","+Math.max.apply(Math,e.path.y)+"]] &roiid="+e.id,alt:""}})]),t._v(" "),t.roishow?t._e():i("div",{staticClass:"slice-name"},[t._v("切片名称："+t._s(e.filename))]),t._v(" "),i("div",{staticClass:"slice-name"},[t._v(t._s(e.remark))])])}),0):t._e()])])},staticRenderFns:[]};var $=i("VU/8")(k,x,!1,function(t){i("tdau")},"data-v-73b8a2f7",null).exports,I=i("mtWM"),O=i.n(I),S=i("mw3O"),A=i.n(S),T=O.a.CancelToken;function M(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{headers:{},onUploadProgress:void 0};t.startsWith("/")||(t="/aipath/api/"+t);var s=T.source();i.cancelToken=s.token;var a=O()({method:"post",onUploadProgress:i.onUploadProgress,url:t,data:A.a.stringify(e)}).then(function(t){if(400==t.data.code&&console.log(vue.$router.push("/login")),0!=t.data.code)throw t.data;return t.data});return a.cancel=function(){s.cancel("取消")},a}function j(){return F("jwt")?JSON.parse(atob(F("jwt").split(".")[1]+"")):{}}function F(t){var e,i=new RegExp("(^| )"+t+"=([^;]*)(;|$)");return(e=document.cookie.match(i))?unescape(e[2]):null}var P={props:["viewRecord","host","viewReportType","propslices","remotesign","remotesigned"],components:{"v-tct2":a,"v-tct1":o,"v-dna":v,"v-dna2":u,"v-reg":g,"v-esd":_,"v-reference":b,"v-basic":w,"v-slides":$},data:function(){return{record:this.viewRecord,reportType:this.viewReportType,componentType:"view",img_error:!0,slices:this.propslices,sign:this.remotesign,signed:this.remotesigned,showDna:!1}},watch:{viewRecord:function(t){this.record=t},viewReportType:function(t){this.reportType=t},propslices:function(t){this.slices=t},remotesigned:function(t){this.signed=t},remotesign:function(t){this.sign=t}},methods:{imgError:function(){this.img_error=!1},currentTime:function(){var t=new Date,e=t.getFullYear(),i=t.getMonth()+1,s=t.getDate();return e+"-"+(i<10?"0"+i:i)+"-"+(s<10?"0"+s:s)},getReport:function(t,e){var i=this;return M("report/get",{caseid:t,reportid:e}).then(function(t){if(0==t.code){var e=JSON.parse(t.data);i.record=e,i.reportType=e.reportInfo.type.toUpperCase()}}).catch(function(t){i.$message({message:t.message,type:"error"})})},getremoteImage:function(t){var e=this;M("report/getReportROI",{caseid:t,alg:this.reportType.toLowerCase()}).then(function(t){e.slices=t.data,e.dnaType?(e.showDna=!0,setTimeout(function(){window.status=1},5e3)):setTimeout(function(){window.status=1},3e3)})},GetQueryString:function(t){for(var e=window.location.search,i=e.indexOf("?"),s=(e=e.substr(i+1)).split("&"),a=[],n=0;n<s.length;n++){var o=s[n].indexOf("=");a.push(s[n].substring(0,o)),a.push(s[n].substr(o+1))}var l=a.indexOf(t);return l>=0?a[l+1]:t+"不是正确的参数名"},getDNAInfo:function(t,e){M("report/getDNAInfo",{caseid:this.record.id,fileid:this.record.slice}).then(function(t){var i=t.data;e(i)})}},computed:{esdType:function(){return this.record&&"ESD"==(this.reportType||this.record.reportInfo.type)},lctType:function(){return this.record&&("LCT"==this.reportType||"LCT"==this.record.reportInfo.type)},dnaType:function(){return this.record&&"DNA"==(this.reportType||this.record.reportInfo.type)},regType:function(){return this.record&&"REG"==(this.reportType||this.record.reportInfo.type)},pureReport:function(){return!this.host&&"report"!=this.componentType},pageType:function(){return this.record&&this.record.reportInfo.DNA&&this.record.reportInfo.DNA.pageType},reportTypeMode:function(){return this.record&&this.record.reportInfo.DNA&&this.record.reportInfo.DNA.reportTypeMode}},created:function(){var t=this;"/report.html"==window.location.pathname&&(this.getReport(this.GetQueryString("caseid"),this.GetQueryString("reportid")).then(function(e){t.getremoteImage(t.GetQueryString("caseid"))}),this.componentType="report",this.sign="/aipath/api/user/sign?id="+this.GetQueryString("username")+"&"+Math.random(),M("user/haveSign").then(function(e){t.signed=e.data}),console.log(444))},mounted:function(){"view"===this.componentType&&(this.showDna=!0,this.$refs.father.style.width="905px",this.$refs.father.style.position="absolute",this.$refs.father.style.position="absolute",this.$refs.father.style.right="22px",this.$refs.father.style.top="62px")},updated:function(){var t=this;this.$nextTick(function(){"report"===t.componentType&&(document.getElementById("main").style.paddingTop="44px")})}},E={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{ref:"father",staticClass:"father"},[t.dnaType&&"double"==t.reportTypeMode?i("div",{class:t.host?"print content first":"content first"},[t.pureReport?i("div",{staticClass:"header"},[i("img",{staticClass:"logo",attrs:{src:t.record.logo,id:"logoView",alt:""}}),t._v(" "),i("div",{staticClass:"text"},[t._v("\n                    样本号："+t._s(this.record.basic.caseid)+"   "+t._s(t.$t("report.date"))+t._s(t.currentTime())+"\n                ")])]):t._e(),t._v(" "),"TBSPage"===t.pageType?i("div",{staticClass:"main",attrs:{id:"main"}},[i("h2",{class:{print:t.host}},[t._v(t._s(t.record.report_name))]),t._v(" "),i("h3",{class:{print:t.host}},[t._v(t._s(t.record.report_info))]),t._v(" "),t.record?i("v-basic",{attrs:{basic:t.record.basic,host:t.host}}):t._e(),t._v(" "),t.dnaType?i("v-tct1",{attrs:{info:t.record.reportInfo,host:t.host}}):t._e(),t._v(" "),i("v-slides",{attrs:{slices:t.slices,recordId:t.record.id,roishow:t.record.roishow,type:t.reportType&&t.reportType.toLowerCase()||t.record.reportInfo.type.toLowerCase(),host:t.host}}),t._v(" "),i("div",{class:t.host?"print sign":"sign",staticStyle:{"box-sizing":"content-box"}},[i("div",[t._v(t._s(t.$t("report.doctor")))]),t._v(" "),t.signed?i("img",{directives:[{name:"show",rawName:"v-show",value:t.img_error,expression:"img_error"}],attrs:{src:t.sign},on:{error:function(e){return t.imgError()}}}):t._e()])],1):t._e(),t._v(" "),"DNAPage"===t.pageType?i("div",{staticClass:"main",attrs:{id:"main"}},[i("h2",{class:{print:t.host}},[t._v(t._s(t.record.report_name))]),t._v(" "),i("h3",{class:{print:t.host}},[t._v(t._s(t.record.report_info))]),t._v(" "),t.record?i("v-basic",{attrs:{basic:t.record.basic,host:t.host}}):t._e(),t._v(" "),t.dnaType&&t.showDna?i("v-dna2",{attrs:{info:t.record.reportInfo,sliceId:t.record.slice,host:t.host,slices:t.slices,recordId:t.record.id,roishow:t.record.roishow},on:{getDNAInfo:t.getDNAInfo}}):t._e(),t._v(" "),i("div",{class:t.host?"print sign":"sign",staticStyle:{"box-sizing":"content-box"}},[i("div",[t._v(t._s(t.$t("report.doctor")))]),t._v(" "),t.signed?i("img",{directives:[{name:"show",rawName:"v-show",value:t.img_error,expression:"img_error"}],attrs:{src:t.sign},on:{error:function(e){return t.imgError()}}}):t._e()])],1):t._e(),t._v(" "),t.pureReport?i("div",{staticClass:"footer clearfix"},[i("div",{staticClass:"fleft"},[i("p",[t._v(t._s(t.$t("report.bottom")))]),t._v(" "),i("p",[t._v("research use only")])])]):t._e()]):i("div",{class:t.host?"print content first":"content first"},[t.pureReport?i("div",{staticClass:"header"},[i("img",{staticClass:"logo",attrs:{src:t.record.logo,id:"logoView",alt:""}}),t._v(" "),i("div",{staticClass:"text"},[t._v("\n                    样本号："+t._s(this.record.basic.caseid)+"   "+t._s(t.$t("report.date"))+t._s(t.currentTime())+"\n                ")])]):t._e(),t._v(" "),i("div",{staticClass:"main",attrs:{id:"main"}},[i("h2",{class:{print:t.host}},[t._v(t._s(t.record.report_name))]),t._v(" "),i("h3",{class:{print:t.host}},[t._v(t._s(t.record.report_info))]),t._v(" "),t.record?i("v-basic",{attrs:{basic:t.record.basic,host:t.host}}):t._e(),t._v(" "),t.lctType?i("v-tct2",{attrs:{info:t.record.reportInfo,host:t.host}}):t._e(),t._v(" "),t.dnaType&&t.showDna?i("v-dna",{attrs:{info:t.record.reportInfo,sliceId:t.record.slice,host:t.host,slices:t.slices,recordId:t.record.id,roishow:t.record.roishow},on:{getDNAInfo:t.getDNAInfo}}):t._e(),t._v(" "),t.regType?i("v-reg",{attrs:{info:t.record.reportInfo,host:t.host}}):t._e(),t._v(" "),t.esdType?i("v-esd",{attrs:{info:t.record.reportInfo,host:t.host}}):t._e(),t._v(" "),t.dnaType?t._e():i("v-slides",{attrs:{slices:t.slices,recordId:t.record.id,roishow:t.record.roishow,type:t.reportType&&t.reportType.toLowerCase()||t.record.reportInfo.type.toLowerCase(),host:t.host}}),t._v(" "),i("div",{class:t.host?"print sign":"sign",staticStyle:{"box-sizing":"content-box"}},[i("div",[t._v(t._s(t.$t("report.doctor")))]),t._v(" "),t.signed?i("img",{directives:[{name:"show",rawName:"v-show",value:t.img_error,expression:"img_error"}],attrs:{src:t.sign},on:{error:function(e){return t.imgError()}}}):t._e()])],1),t._v(" "),t.pureReport?i("div",{staticClass:"footer clearfix"},[i("div",{staticClass:"fleft"},[i("p",[t._v(t._s(t.$t("report.bottom")))]),t._v(" "),i("p",[t._v("research use only")])])]):t._e()])])},staticRenderFns:[]};i.d(e,!1,function(){return j}),i.d(e,!1,function(){return F});var L=i("VU/8")(P,E,!1,function(t){i("JoHU")},"data-v-5d3a8a64",null);e.a=L.exports},"z+oc":function(t,e){},zdsT:function(t,e){},zgHq:function(t,e){}});