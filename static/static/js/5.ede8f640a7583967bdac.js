webpackJsonp([5],{"7PVR":function(t,e){},"I9+T":function(t,e,i){"use strict";i("jyVo");var n={data(){return{basic:this.$props.record.basic,isOpen:!1,checked:"basicMessage",isBig:!1}},methods:{toggleBig:function(){this.isBig=!this.isBig},download(t,e,i){window.location.href=`/aipath/api/files/attachment?caseid=${t}&fileid=${e}&filename=${i}`}},computed:{gender(){let t=window.localStorage.getItem("localeLanguage");return"zh"==t?{"男":"男","女":"女","其他":"其他"}:"en"==t?{"男":"M","女":"F","其他":"O"}:void 0}},props:["record"]},s={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"container"},[i("div",{staticClass:"open-message",attrs:{title:t.$t("basic.basic")},on:{click:function(e){t.isOpen=!t.isOpen}}}),t._v(" "),t.isOpen?i("div",{class:{"case-bigger":t.isBig,"case-message":!t.isBig}},[i("h1",[i("span",{class:{"cur-checked":"basicMessage"==t.checked},on:{click:function(e){t.checked="basicMessage"}}},[t._v(t._s(t.$t("basic.message")))]),t._v(" "),i("span",{class:{"cur-checked":"attachment"==t.checked},on:{click:function(e){t.checked="attachment"}}},[t._v(t._s(t.$t("basic.attactment")))]),t._v(" "),i("i",{staticClass:"close",on:{click:function(e){t.isOpen=!1}}}),i("i",{staticClass:"scale",class:{"bg-blue":t.isBig},on:{click:function(e){return t.toggleBig()}}})]),t._v(" "),i("div",{staticClass:"message-content"},["attachment"==t.checked?i("div",[i("ul",t._l(t.record.attachments.filter(function(t){return 1==t.state}),function(e){return i("li",{key:e.id},[i("a",{ref:"attachment",refInFor:!0,attrs:{title:e.name},on:{click:function(i){return t.download(t.record.id,e.id,e.name)}}},[t._v(t._s(e.name))])])}),0)]):t._e(),t._v(" "),"basicMessage"==t.checked?i("div",[i("div",{staticClass:"basics"},[i("h1",[t._v(t._s(t.$t("basic.basic")))]),t._v(" "),i("ul",[i("li",[i("dl",[i("dt",[t._v(t._s(t.$t("basic.age")))]),i("dd",[t._v(t._s(t.basic.age))])]),i("dl",[i("dt",[t._v(t._s(t.$t("basic.sex")))]),i("dd",[t._v(t._s(t.gender[t.basic.gender]))])])]),t._v(" "),i("li",[i("dl",{staticStyle:{width:"100%"}},[i("dt",{attrs:{title:t.$t("basic.cancerTypeTitle")}},[t._v(t._s(t.$t("basic.cancerType")))]),i("dd",[t._v(t._s(t.basic.cancerType))])])]),t._v(" "),i("li",[i("dl",{staticStyle:{width:"100%"}},[i("dt",{attrs:{title:t.$t("basic.familyHistoryTitle")}},[t._v(t._s(t.$t("basic.familyHistory")))]),i("dd",[t._v(t._s(t.basic.familyHistory))])])]),t._v(" "),i("li",[i("dl",{staticStyle:{width:"100%"}},[i("dt",{attrs:{title:t.$t("basic.medicalHistoryTitle")}},[t._v(t._s(t.$t("basic.medicalHistory")))]),i("dd",[t._v(t._s(t.basic.medicalHistory))])])])])]),t._v(" "),i("div",{staticClass:"basics"},[i("h1",[t._v(t._s(t.$t("basic.sample")))]),t._v(" "),i("ul",[i("li",[i("dl",{staticStyle:{width:"100%"}},[i("dt",{attrs:{title:t.$t("basic.samplePartTitle")}},[t._v(t._s(t.$t("basic.samplePart")))]),i("dd",[t._v(t._s(t.basic.samplePart))])])]),t._v(" "),i("li",[i("dl",{staticStyle:{width:"100%"}},[i("dt",{attrs:{title:t.$t("basic.sampleTypeTitle")}},[t._v(t._s(t.$t("basic.sampleType")))]),i("dd",[t._v(t._s(t.basic.sampleType))])])]),t._v(" "),i("li",[i("dl",{staticStyle:{width:"100%"}},[i("dt",[t._v(t._s(t.$t("basic.generallySeen")))]),i("dd",[t._v(t._s(t.basic.generallySeen))])])])])])]):t._e()])]):t._e()])},staticRenderFns:[]};var r=i("VU/8")(n,s,!1,function(t){i("l7ju")},"data-v-a17105bc",null);e.a=r.exports},LC74:function(t,e){"function"==typeof Object.create?t.exports=function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(t,e){t.super_=e;var i=function(){};i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=t}},OMJi:function(t,e,i){(function(t,n){var s=/%[sdj%]/g;e.format=function(t){if(!y(t)){for(var e=[],i=0;i<arguments.length;i++)e.push(a(arguments[i]));return e.join(" ")}i=1;for(var n=arguments,r=n.length,o=String(t).replace(s,function(t){if("%%"===t)return"%";if(i>=r)return t;switch(t){case"%s":return String(n[i++]);case"%d":return Number(n[i++]);case"%j":try{return JSON.stringify(n[i++])}catch(t){return"[Circular]"}default:return t}}),l=n[i];i<r;l=n[++i])m(l)||!w(l)?o+=" "+l:o+=" "+a(l);return o},e.deprecate=function(i,s){if(v(t.process))return function(){return e.deprecate(i,s).apply(this,arguments)};if(!0===n.noDeprecation)return i;var r=!1;return function(){if(!r){if(n.throwDeprecation)throw new Error(s);n.traceDeprecation?console.trace(s):console.error(s),r=!0}return i.apply(this,arguments)}};var r,o={};function a(t,i){var n={seen:[],stylize:c};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),d(i)?n.showHidden=i:i&&e._extend(n,i),v(n.showHidden)&&(n.showHidden=!1),v(n.depth)&&(n.depth=2),v(n.colors)&&(n.colors=!1),v(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=l),h(n,t,n.depth)}function l(t,e){var i=a.styles[e];return i?"["+a.colors[i][0]+"m"+t+"["+a.colors[i][1]+"m":t}function c(t,e){return t}function h(t,i,n){if(t.customInspect&&i&&k(i.inspect)&&i.inspect!==e.inspect&&(!i.constructor||i.constructor.prototype!==i)){var s=i.inspect(n,t);return y(s)||(s=h(t,s,n)),s}var r=function(t,e){if(v(e))return t.stylize("undefined","undefined");if(y(e)){var i="'"+JSON.stringify(e).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return t.stylize(i,"string")}if(g(e))return t.stylize(""+e,"number");if(d(e))return t.stylize(""+e,"boolean");if(m(e))return t.stylize("null","null")}(t,i);if(r)return r;var o=Object.keys(i),a=function(t){var e={};return t.forEach(function(t,i){e[t]=!0}),e}(o);if(t.showHidden&&(o=Object.getOwnPropertyNames(i)),R(i)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return u(i);if(0===o.length){if(k(i)){var l=i.name?": "+i.name:"";return t.stylize("[Function"+l+"]","special")}if(x(i))return t.stylize(RegExp.prototype.toString.call(i),"regexp");if(b(i))return t.stylize(Date.prototype.toString.call(i),"date");if(R(i))return u(i)}var c,w="",P=!1,_=["{","}"];(f(i)&&(P=!0,_=["[","]"]),k(i))&&(w=" [Function"+(i.name?": "+i.name:"")+"]");return x(i)&&(w=" "+RegExp.prototype.toString.call(i)),b(i)&&(w=" "+Date.prototype.toUTCString.call(i)),R(i)&&(w=" "+u(i)),0!==o.length||P&&0!=i.length?n<0?x(i)?t.stylize(RegExp.prototype.toString.call(i),"regexp"):t.stylize("[Object]","special"):(t.seen.push(i),c=P?function(t,e,i,n,s){for(var r=[],o=0,a=e.length;o<a;++o)T(e,String(o))?r.push(p(t,e,i,n,String(o),!0)):r.push("");return s.forEach(function(s){s.match(/^\d+$/)||r.push(p(t,e,i,n,s,!0))}),r}(t,i,n,a,o):o.map(function(e){return p(t,i,n,a,e,P)}),t.seen.pop(),function(t,e,i){if(t.reduce(function(t,e){return 0,e.indexOf("\n")>=0&&0,t+e.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60)return i[0]+(""===e?"":e+"\n ")+" "+t.join(",\n  ")+" "+i[1];return i[0]+e+" "+t.join(", ")+" "+i[1]}(c,w,_)):_[0]+w+_[1]}function u(t){return"["+Error.prototype.toString.call(t)+"]"}function p(t,e,i,n,s,r){var o,a,l;if((l=Object.getOwnPropertyDescriptor(e,s)||{value:e[s]}).get?a=l.set?t.stylize("[Getter/Setter]","special"):t.stylize("[Getter]","special"):l.set&&(a=t.stylize("[Setter]","special")),T(n,s)||(o="["+s+"]"),a||(t.seen.indexOf(l.value)<0?(a=m(i)?h(t,l.value,null):h(t,l.value,i-1)).indexOf("\n")>-1&&(a=r?a.split("\n").map(function(t){return"  "+t}).join("\n").substr(2):"\n"+a.split("\n").map(function(t){return"   "+t}).join("\n")):a=t.stylize("[Circular]","special")),v(o)){if(r&&s.match(/^\d+$/))return a;(o=JSON.stringify(""+s)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(o=o.substr(1,o.length-2),o=t.stylize(o,"name")):(o=o.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),o=t.stylize(o,"string"))}return o+": "+a}function f(t){return Array.isArray(t)}function d(t){return"boolean"==typeof t}function m(t){return null===t}function g(t){return"number"==typeof t}function y(t){return"string"==typeof t}function v(t){return void 0===t}function x(t){return w(t)&&"[object RegExp]"===P(t)}function w(t){return"object"==typeof t&&null!==t}function b(t){return w(t)&&"[object Date]"===P(t)}function R(t){return w(t)&&("[object Error]"===P(t)||t instanceof Error)}function k(t){return"function"==typeof t}function P(t){return Object.prototype.toString.call(t)}function _(t){return t<10?"0"+t.toString(10):t.toString(10)}e.debuglog=function(t){if(v(r)&&(r=Object({NODE_ENV:"production"}).NODE_DEBUG||""),t=t.toUpperCase(),!o[t])if(new RegExp("\\b"+t+"\\b","i").test(r)){var i=n.pid;o[t]=function(){var n=e.format.apply(e,arguments);console.error("%s %d: %s",t,i,n)}}else o[t]=function(){};return o[t]},e.inspect=a,a.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},a.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},e.isArray=f,e.isBoolean=d,e.isNull=m,e.isNullOrUndefined=function(t){return null==t},e.isNumber=g,e.isString=y,e.isSymbol=function(t){return"symbol"==typeof t},e.isUndefined=v,e.isRegExp=x,e.isObject=w,e.isDate=b,e.isError=R,e.isFunction=k,e.isPrimitive=function(t){return null===t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||"symbol"==typeof t||void 0===t},e.isBuffer=i("fC4T");var M=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function T(t,e){return Object.prototype.hasOwnProperty.call(t,e)}e.log=function(){var t,i;console.log("%s - %s",(t=new Date,i=[_(t.getHours()),_(t.getMinutes()),_(t.getSeconds())].join(":"),[t.getDate(),M[t.getMonth()],i].join(" ")),e.format.apply(e,arguments))},e.inherits=i("LC74"),e._extend=function(t,e){if(!e||!w(e))return t;for(var i=Object.keys(e),n=i.length;n--;)t[i[n]]=e[i[n]];return t}}).call(e,i("DuR2"),i("W2nU"))},fC4T:function(t,e){t.exports=function(t){return t&&"object"==typeof t&&"function"==typeof t.copy&&"function"==typeof t.fill&&"function"==typeof t.readUInt8}},jDAy:function(t,e){},k5KV:function(t,e,i){(function(){var e,n,s=[].slice;n=i("rdLu"),i("OMJi").puts,e={isPlainObject:function(t){return null!=(null!=t?t.constructor:void 0)&&"Object"===t.constructor.name},clone:function(t){var i,s,r,o,a;if(n.isArray(t)){for(i=[],o=0,a=t.length;o<a;o++)r=t[o],i.push(e.clone(r));return i}if(e.isPlainObject(t)){for(s in i={},t)r=t[s],i[s]=e.clone(r);return i}return t},equals:function(t,i){var s,r,o,a,l;if(t===i)return!0;if(n.isArray(t)){if(!n.isArray(i)||t.length!==i.length)return!1;for(s=a=0,l=t.length;0<=l?a<l:a>l;s=0<=l?++a:--a)if(!e.equals(t[s],i[s]))return!1;return!0}if(e.isPlainObject(t)){if(o=n.size(t),!e.isPlainObject(i)||o!==n.size(i))return!1;for(r in t)if(!e.equals(t[r],i[r]))return!1;return!0}return!1},extend:function(){var t,i,n,r,o,a;for(t=arguments[0],o=0,a=(r=2<=arguments.length?s.call(arguments,1):[]).length;o<a;o++)for(i in n=r[o])e.isPlainObject(t[i])&&e.isPlainObject(n[i])?e.extend(t[i],n[i]):t[i]=e.clone(n[i]);return t},select:function(t,i,s){var r,o,a,l;if(null==s&&(s=[]),a=[],i(t))a.push({path:s,value:t});else if(n.isObject(t))for(o in t)l=t[o],(r=n.clone(s)).push(o),a=a.concat(e.select(l,i,r));return a},set:function(t,e,i){var s,r,o;for(s=(e=n.clone(e)).pop(),r=0,o=e.length;r<o;r++)t=t[e[r]];return t[s]=i},transform:function(t,i,s){var r,o,a,l,c;if(i(t))return s(t);if(n.isArray(t)){for(o=[],l=0,c=t.length;l<c;l++)a=t[l],o.push(e.transform(a,i,s));return o}if(e.isPlainObject(t)){for(r in o={},t)a=t[r],o[r]=e.transform(a,i,s);return o}return t}},t.exports=e}).call(this)},l7ju:function(t,e){},rdLu:function(t,e,i){(function(){var i=this,n=i._,s={},r=Array.prototype,o=Object.prototype,a=Function.prototype,l=r.push,c=r.slice,h=r.concat,u=o.toString,p=o.hasOwnProperty,f=r.forEach,d=r.map,m=r.reduce,g=r.reduceRight,y=r.filter,v=r.every,x=r.some,w=r.indexOf,b=r.lastIndexOf,R=Array.isArray,k=Object.keys,P=a.bind,_=function(t){return t instanceof _?t:this instanceof _?void(this._wrapped=t):new _(t)};void 0!==t&&t.exports&&(e=t.exports=_),e._=_,_.VERSION="1.4.4";var M=_.each=_.forEach=function(t,e,i){if(null!=t)if(f&&t.forEach===f)t.forEach(e,i);else if(t.length===+t.length){for(var n=0,r=t.length;n<r;n++)if(e.call(i,t[n],n,t)===s)return}else for(var o in t)if(_.has(t,o)&&e.call(i,t[o],o,t)===s)return};_.map=_.collect=function(t,e,i){var n=[];return null==t?n:d&&t.map===d?t.map(e,i):(M(t,function(t,s,r){n[n.length]=e.call(i,t,s,r)}),n)};var T="Reduce of empty array with no initial value";_.reduce=_.foldl=_.inject=function(t,e,i,n){var s=arguments.length>2;if(null==t&&(t=[]),m&&t.reduce===m)return n&&(e=_.bind(e,n)),s?t.reduce(e,i):t.reduce(e);if(M(t,function(t,r,o){s?i=e.call(n,i,t,r,o):(i=t,s=!0)}),!s)throw new TypeError(T);return i},_.reduceRight=_.foldr=function(t,e,i,n){var s=arguments.length>2;if(null==t&&(t=[]),g&&t.reduceRight===g)return n&&(e=_.bind(e,n)),s?t.reduceRight(e,i):t.reduceRight(e);var r=t.length;if(r!==+r){var o=_.keys(t);r=o.length}if(M(t,function(a,l,c){l=o?o[--r]:--r,s?i=e.call(n,i,t[l],l,c):(i=t[l],s=!0)}),!s)throw new TypeError(T);return i},_.find=_.detect=function(t,e,i){var n;return j(t,function(t,s,r){if(e.call(i,t,s,r))return n=t,!0}),n},_.filter=_.select=function(t,e,i){var n=[];return null==t?n:y&&t.filter===y?t.filter(e,i):(M(t,function(t,s,r){e.call(i,t,s,r)&&(n[n.length]=t)}),n)},_.reject=function(t,e,i){return _.filter(t,function(t,n,s){return!e.call(i,t,n,s)},i)},_.every=_.all=function(t,e,i){e||(e=_.identity);var n=!0;return null==t?n:v&&t.every===v?t.every(e,i):(M(t,function(t,r,o){if(!(n=n&&e.call(i,t,r,o)))return s}),!!n)};var j=_.some=_.any=function(t,e,i){e||(e=_.identity);var n=!1;return null==t?n:x&&t.some===x?t.some(e,i):(M(t,function(t,r,o){if(n||(n=e.call(i,t,r,o)))return s}),!!n)};_.contains=_.include=function(t,e){return null!=t&&(w&&t.indexOf===w?-1!=t.indexOf(e):j(t,function(t){return t===e}))},_.invoke=function(t,e){var i=c.call(arguments,2),n=_.isFunction(e);return _.map(t,function(t){return(n?e:t[e]).apply(t,i)})},_.pluck=function(t,e){return _.map(t,function(t){return t[e]})},_.where=function(t,e,i){return _.isEmpty(e)?i?null:[]:_[i?"find":"filter"](t,function(t){for(var i in e)if(e[i]!==t[i])return!1;return!0})},_.findWhere=function(t,e){return _.where(t,e,!0)},_.max=function(t,e,i){if(!e&&_.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.max.apply(Math,t);if(!e&&_.isEmpty(t))return-1/0;var n={computed:-1/0,value:-1/0};return M(t,function(t,s,r){var o=e?e.call(i,t,s,r):t;o>=n.computed&&(n={value:t,computed:o})}),n.value},_.min=function(t,e,i){if(!e&&_.isArray(t)&&t[0]===+t[0]&&t.length<65535)return Math.min.apply(Math,t);if(!e&&_.isEmpty(t))return 1/0;var n={computed:1/0,value:1/0};return M(t,function(t,s,r){var o=e?e.call(i,t,s,r):t;o<n.computed&&(n={value:t,computed:o})}),n.value},_.shuffle=function(t){var e,i=0,n=[];return M(t,function(t){e=_.random(i++),n[i-1]=n[e],n[e]=t}),n};var O=function(t){return _.isFunction(t)?t:function(e){return e[t]}};_.sortBy=function(t,e,i){var n=O(e);return _.pluck(_.map(t,function(t,e,s){return{value:t,index:e,criteria:n.call(i,t,e,s)}}).sort(function(t,e){var i=t.criteria,n=e.criteria;if(i!==n){if(i>n||void 0===i)return 1;if(i<n||void 0===n)return-1}return t.index<e.index?-1:1}),"value")};var $=function(t,e,i,n){var s={},r=O(e||_.identity);return M(t,function(e,o){var a=r.call(i,e,o,t);n(s,a,e)}),s};_.groupBy=function(t,e,i){return $(t,e,i,function(t,e,i){(_.has(t,e)?t[e]:t[e]=[]).push(i)})},_.countBy=function(t,e,i){return $(t,e,i,function(t,e){_.has(t,e)||(t[e]=0),t[e]++})},_.sortedIndex=function(t,e,i,n){for(var s=(i=null==i?_.identity:O(i)).call(n,e),r=0,o=t.length;r<o;){var a=r+o>>>1;i.call(n,t[a])<s?r=a+1:o=a}return r},_.toArray=function(t){return t?_.isArray(t)?c.call(t):t.length===+t.length?_.map(t,_.identity):_.values(t):[]},_.size=function(t){return null==t?0:t.length===+t.length?t.length:_.keys(t).length},_.first=_.head=_.take=function(t,e,i){if(null!=t)return null==e||i?t[0]:c.call(t,0,e)},_.initial=function(t,e,i){return c.call(t,0,t.length-(null==e||i?1:e))},_.last=function(t,e,i){if(null!=t)return null==e||i?t[t.length-1]:c.call(t,Math.max(t.length-e,0))},_.rest=_.tail=_.drop=function(t,e,i){return c.call(t,null==e||i?1:e)},_.compact=function(t){return _.filter(t,_.identity)};var S=function(t,e,i){return M(t,function(t){_.isArray(t)?e?l.apply(i,t):S(t,e,i):i.push(t)}),i};_.flatten=function(t,e){return S(t,e,[])},_.without=function(t){return _.difference(t,c.call(arguments,1))},_.uniq=_.unique=function(t,e,i,n){_.isFunction(e)&&(n=i,i=e,e=!1);var s=i?_.map(t,i,n):t,r=[],o=[];return M(s,function(i,n){(e?n&&o[o.length-1]===i:_.contains(o,i))||(o.push(i),r.push(t[n]))}),r},_.union=function(){return _.uniq(h.apply(r,arguments))},_.intersection=function(t){var e=c.call(arguments,1);return _.filter(_.uniq(t),function(t){return _.every(e,function(e){return _.indexOf(e,t)>=0})})},_.difference=function(t){var e=h.apply(r,c.call(arguments,1));return _.filter(t,function(t){return!_.contains(e,t)})},_.zip=function(){for(var t=c.call(arguments),e=_.max(_.pluck(t,"length")),i=new Array(e),n=0;n<e;n++)i[n]=_.pluck(t,""+n);return i},_.object=function(t,e){if(null==t)return{};for(var i={},n=0,s=t.length;n<s;n++)e?i[t[n]]=e[n]:i[t[n][0]]=t[n][1];return i},_.indexOf=function(t,e,i){if(null==t)return-1;var n=0,s=t.length;if(i){if("number"!=typeof i)return t[n=_.sortedIndex(t,e)]===e?n:-1;n=i<0?Math.max(0,s+i):i}if(w&&t.indexOf===w)return t.indexOf(e,i);for(;n<s;n++)if(t[n]===e)return n;return-1},_.lastIndexOf=function(t,e,i){if(null==t)return-1;var n=null!=i;if(b&&t.lastIndexOf===b)return n?t.lastIndexOf(e,i):t.lastIndexOf(e);for(var s=n?i:t.length;s--;)if(t[s]===e)return s;return-1},_.range=function(t,e,i){arguments.length<=1&&(e=t||0,t=0),i=arguments[2]||1;for(var n=Math.max(Math.ceil((e-t)/i),0),s=0,r=new Array(n);s<n;)r[s++]=t,t+=i;return r},_.bind=function(t,e){if(t.bind===P&&P)return P.apply(t,c.call(arguments,1));var i=c.call(arguments,2);return function(){return t.apply(e,i.concat(c.call(arguments)))}},_.partial=function(t){var e=c.call(arguments,1);return function(){return t.apply(this,e.concat(c.call(arguments)))}},_.bindAll=function(t){var e=c.call(arguments,1);return 0===e.length&&(e=_.functions(t)),M(e,function(e){t[e]=_.bind(t[e],t)}),t},_.memoize=function(t,e){var i={};return e||(e=_.identity),function(){var n=e.apply(this,arguments);return _.has(i,n)?i[n]:i[n]=t.apply(this,arguments)}},_.delay=function(t,e){var i=c.call(arguments,2);return setTimeout(function(){return t.apply(null,i)},e)},_.defer=function(t){return _.delay.apply(_,[t,1].concat(c.call(arguments,1)))},_.throttle=function(t,e){var i,n,s,r,o=0,a=function(){o=new Date,s=null,r=t.apply(i,n)};return function(){var l=new Date,c=e-(l-o);return i=this,n=arguments,c<=0?(clearTimeout(s),s=null,o=l,r=t.apply(i,n)):s||(s=setTimeout(a,c)),r}},_.debounce=function(t,e,i){var n,s;return function(){var r=this,o=arguments,a=i&&!n;return clearTimeout(n),n=setTimeout(function(){n=null,i||(s=t.apply(r,o))},e),a&&(s=t.apply(r,o)),s}},_.once=function(t){var e,i=!1;return function(){return i?e:(i=!0,e=t.apply(this,arguments),t=null,e)}},_.wrap=function(t,e){return function(){var i=[t];return l.apply(i,arguments),e.apply(this,i)}},_.compose=function(){var t=arguments;return function(){for(var e=arguments,i=t.length-1;i>=0;i--)e=[t[i].apply(this,e)];return e[0]}},_.after=function(t,e){return t<=0?e():function(){if(--t<1)return e.apply(this,arguments)}},_.keys=k||function(t){if(t!==Object(t))throw new TypeError("Invalid object");var e=[];for(var i in t)_.has(t,i)&&(e[e.length]=i);return e},_.values=function(t){var e=[];for(var i in t)_.has(t,i)&&e.push(t[i]);return e},_.pairs=function(t){var e=[];for(var i in t)_.has(t,i)&&e.push([i,t[i]]);return e},_.invert=function(t){var e={};for(var i in t)_.has(t,i)&&(e[t[i]]=i);return e},_.functions=_.methods=function(t){var e=[];for(var i in t)_.isFunction(t[i])&&e.push(i);return e.sort()},_.extend=function(t){return M(c.call(arguments,1),function(e){if(e)for(var i in e)t[i]=e[i]}),t},_.pick=function(t){var e={},i=h.apply(r,c.call(arguments,1));return M(i,function(i){i in t&&(e[i]=t[i])}),e},_.omit=function(t){var e={},i=h.apply(r,c.call(arguments,1));for(var n in t)_.contains(i,n)||(e[n]=t[n]);return e},_.defaults=function(t){return M(c.call(arguments,1),function(e){if(e)for(var i in e)null==t[i]&&(t[i]=e[i])}),t},_.clone=function(t){return _.isObject(t)?_.isArray(t)?t.slice():_.extend({},t):t},_.tap=function(t,e){return e(t),t};var C=function(t,e,i,n){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return t===e;t instanceof _&&(t=t._wrapped),e instanceof _&&(e=e._wrapped);var s=u.call(t);if(s!=u.call(e))return!1;switch(s){case"[object String]":return t==String(e);case"[object Number]":return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case"[object Date]":case"[object Boolean]":return+t==+e;case"[object RegExp]":return t.source==e.source&&t.global==e.global&&t.multiline==e.multiline&&t.ignoreCase==e.ignoreCase}if("object"!=typeof t||"object"!=typeof e)return!1;for(var r=i.length;r--;)if(i[r]==t)return n[r]==e;i.push(t),n.push(e);var o=0,a=!0;if("[object Array]"==s){if(a=(o=t.length)==e.length)for(;o--&&(a=C(t[o],e[o],i,n)););}else{var l=t.constructor,c=e.constructor;if(l!==c&&!(_.isFunction(l)&&l instanceof l&&_.isFunction(c)&&c instanceof c))return!1;for(var h in t)if(_.has(t,h)&&(o++,!(a=_.has(e,h)&&C(t[h],e[h],i,n))))break;if(a){for(h in e)if(_.has(e,h)&&!o--)break;a=!o}}return i.pop(),n.pop(),a};_.isEqual=function(t,e){return C(t,e,[],[])},_.isEmpty=function(t){if(null==t)return!0;if(_.isArray(t)||_.isString(t))return 0===t.length;for(var e in t)if(_.has(t,e))return!1;return!0},_.isElement=function(t){return!(!t||1!==t.nodeType)},_.isArray=R||function(t){return"[object Array]"==u.call(t)},_.isObject=function(t){return t===Object(t)},M(["Arguments","Function","String","Number","Date","RegExp"],function(t){_["is"+t]=function(e){return u.call(e)=="[object "+t+"]"}}),_.isArguments(arguments)||(_.isArguments=function(t){return!(!t||!_.has(t,"callee"))}),_.isFunction=function(t){return"function"==typeof t},_.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},_.isNaN=function(t){return _.isNumber(t)&&t!=+t},_.isBoolean=function(t){return!0===t||!1===t||"[object Boolean]"==u.call(t)},_.isNull=function(t){return null===t},_.isUndefined=function(t){return void 0===t},_.has=function(t,e){return p.call(t,e)},_.noConflict=function(){return i._=n,this},_.identity=function(t){return t},_.times=function(t,e,i){for(var n=Array(t),s=0;s<t;s++)n[s]=e.call(i,s);return n},_.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))};var E={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};E.unescape=_.invert(E.escape);var z={escape:new RegExp("["+_.keys(E.escape).join("")+"]","g"),unescape:new RegExp("("+_.keys(E.unescape).join("|")+")","g")};_.each(["escape","unescape"],function(t){_[t]=function(e){return null==e?"":(""+e).replace(z[t],function(e){return E[t][e]})}}),_.result=function(t,e){if(null==t)return null;var i=t[e];return _.isFunction(i)?i.call(t):i},_.mixin=function(t){M(_.functions(t),function(e){var i=_[e]=t[e];_.prototype[e]=function(){var t=[this._wrapped];return l.apply(t,arguments),F.call(this,i.apply(_,t))}})};var L=0;_.uniqueId=function(t){var e=++L+"";return t?t+e:e},_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var A=/(.)^/,I={"'":"'","\\":"\\","\r":"r","\n":"n","\t":"t","\u2028":"u2028","\u2029":"u2029"},D=/\\|'|\r|\n|\t|\u2028|\u2029/g;_.template=function(t,e,i){var n;i=_.defaults({},i,_.templateSettings);var s=new RegExp([(i.escape||A).source,(i.interpolate||A).source,(i.evaluate||A).source].join("|")+"|$","g"),r=0,o="__p+='";t.replace(s,function(e,i,n,s,a){return o+=t.slice(r,a).replace(D,function(t){return"\\"+I[t]}),i&&(o+="'+\n((__t=("+i+"))==null?'':_.escape(__t))+\n'"),n&&(o+="'+\n((__t=("+n+"))==null?'':__t)+\n'"),s&&(o+="';\n"+s+"\n__p+='"),r=a+e.length,e}),o+="';\n",i.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{n=new Function(i.variable||"obj","_",o)}catch(t){throw t.source=o,t}if(e)return n(e,_);var a=function(t){return n.call(this,t,_)};return a.source="function("+(i.variable||"obj")+"){\n"+o+"}",a},_.chain=function(t){return _(t).chain()};var F=function(t){return this._chain?_(t).chain():t};_.mixin(_),M(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=r[t];_.prototype[t]=function(){var i=this._wrapped;return e.apply(i,arguments),"shift"!=t&&"splice"!=t||0!==i.length||delete i[0],F.call(this,i)}}),M(["concat","join","slice"],function(t){var e=r[t];_.prototype[t]=function(){return F.call(this,e.apply(this._wrapped,arguments))}}),_.extend(_.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this)},xJsL:function(t,e){},xJtg:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n,s=i("I9+T"),r=i("k5KV"),o=i.n(r),a=i("jyVo"),l={props:["slice","record","roilist","curRois","centerRegion","penColor","position","content","companyid","showMppGuide","cellArea","showLayer","moveStatus","radius","filled","currentAngle"],data(){return{mpp:this.slice.mppx||.242042,scale:1,fullPage:!1,osd:null,company:this.$props.companyid||Object(a.o)().company,viewport:null,paper:null,selectedTool:"choose",dataMapPath:{},offsetWidth:0,offsetHeight:0,showRoi:!0,saved:!1,showLabel:!0,knew:!1,drawMpp:!1,userMpp:null,deg:0,layers:[null,null,null,null,null,null],showPenTool:!1,pentool:"freepen",scope:null,pointAble:["ki67","er","pr","pdl1","tagging","fish","ki67hot","her2","np","cd30"].includes(this.slice.toolType),reverseAble:!1,showRadius:!1,newRadius:this.radius,segmentsList:[]}},methods:{wheel(t){if("dottingTool"==this.selectedTool)return;let e=t.wheelDeltaY>0?1.2:1/1.2;var i=this.viewport.pointFromPixel(new OpenSeadragon.Point(t.offsetX,t.offsetY)),n=this.position;this.move((n.offx-i.x)/e+i.x,(n.offy-i.y)/e+i.y,n.zoom*e)},adjustSegment(){Object.keys(this.curRois).length?this.selectedTool="pickTool":this.$message.warning("请先选择一个调整对象")},toNumber(){this.newRadius=this.newRadius.replace(/[^\.\d]/g,"")},checkTool(t){this.showPenTool=!1,this.pentool=t,this.selectedTool=t},chooseTool(){this.pentool==this.selectedTool&&(this.showPenTool=!this.showPenTool),this.selectedTool=this.pentool},rotate(){this.deg+=90,this.$refs.rotate.style.transform=`rotate(${this.deg}deg)`},drawCell(){this.$emit("closeMppGuide",!0),this.drawMpp=!0,this.selectedTool="rectangle"},convertPoint(t,e){return this.paper.view.viewToProject(new this.paper.Point(t,e))},initOSD(){let t=OpenSeadragon({element:this.$refs.osd,tileSources:{height:this.slice.height,width:this.slice.width,tileSize:1024,getTileUrl:(t,e,i)=>`/aipath/api/files/slice?x=${e}&y=${i}&z=${t}&caseid=${this.record.id}&fileid=${this.slice.id}&companyid=${this.company}&filename=${encodeURIComponent(this.slice.filename||this.slice.name)}`},minZoomLevel:.001,maxZoomLevel:1e4,visibilityRatio:.1,toolbar:this.$refs.hideToolbar,mouseNavEnabled:!0,animationTime:.8,maxImageCacheCount:12,immediately:!0,showNavigator:!0,constrainDuringPan:!0,useCanvas:!1,iOSDevice:!0});this.osd=t,this.viewport=t.viewport,this.$emit("viewer",this.viewport),t.activateImagingHelper(),t.addHandler("open",()=>{console.log(1),this.paper=new paper.PaperScope,this.paper.activate(),this.paper.setup(this.$refs.canvas),this.paper.settings.handleSize=8,this.layers[0]=new this.paper.Layer,this.layers[1]=new this.paper.Layer,this.layers[2]=new this.paper.Layer,this.layers[3]=new this.paper.Layer,this.layers[4]=new this.paper.Layer,this.layers[5]=new this.paper.Layer,this.roilistChange(this.roilist||[],[]),this.resized(),this.position.zoom?this.update(this.position,!0):this.buttonClick("home");t.addHandler("update-viewport",()=>{let t=this.slice.width,{x:e,y:i}=this.viewport.getBounds(!0).getCenter();this.paper.view.rotation=this.currentAngle||0,this.paper.view.setCenter(e*t,i*t);let n=this.viewport.getZoom(!0);this.paper.view.zoom=this.viewport.viewportToImageZoom(n),console.log(n)}),t.addHandler("animation-start",()=>{"pdl1"==this.slice.toolType&&this.$emit("changeMoveStatus","moveStart")}),t.addHandler("animation-finish",()=>{let t=this.viewport.getZoom(!0);console.log(t)})}),this.$refs.osd.addEventListener("contextmenu",this.contextmenu),window.addEventListener("resize",this.resize)},getRoi(){if(!this.paper.view)return;let t=parseInt(this.convertPoint(0,0).x),e=parseInt(this.convertPoint(0,0).y);if(this.$refs.osd){let t=this.$refs.osd.querySelector(".openseadragon-canvas").querySelector("canvas");var i=parseInt(this.convertPoint(t.width,t.height).x),n=parseInt(this.convertPoint(t.width,t.height).y)}let s=this.osd.world.getItemAt(0).lastDrawn,r=Math.max(...s.map(t=>t.level));this.$emit("getRoi",{x1:t,x2:i,y1:e,y2:n,z:r}),"pdl1"==this.slice.toolType&&this.$emit("changeMoveStatus","moveEnd")},move(t,e,i){this.$emit("position","number"==typeof t?t:this.position.offx,"number"==typeof e?e:this.position.offy,"number"==typeof i?i:this.position.zoom)},update(t=this.position,e){this.viewport.zoomTo(t.zoom,"",e),this.viewport.panTo({x:t.offx,y:t.offy},e)},resize(){setTimeout(t=>this.resized(this.position.zoom/this.scale),0)},resized(t){this.offsetWidth=this.$refs.osd.offsetWidth,this.offsetHeight=this.$refs.osd.offsetHeight,this.paper.view.viewSize=[this.offsetWidth,this.offsetHeight],this.scale=this.mpp*this.slice.width*Math.min(this.offsetHeight/this.offsetWidth,1)/22e3,this.move(null,null,t?t*this.scale:null),t&&t*this.scale!=this.position.zoom||setTimeout(this.update,80)},navstart(t){if(t.button)return;let e=this.$refs.navigator;var i=t=>{t=c(t),this.move(t.offsetX/e.clientWidth,t.offsetY/e.clientHeight*this.slice.height/this.slice.width)},n=()=>{e.removeEventListener("mousemove",i),e.removeEventListener("touchmove",i),window.removeEventListener("mouseup",n)};e.addEventListener("mousemove",i),e.addEventListener("touchmove",i),window.addEventListener("mouseup",n),i(t)},handleFullScreen(){this.fullPage=!this.fullPage,this.$parent.$parent.fullPage=this.fullPage,this.resize()},buttonClick(t){switch(t){case"zoom-in":this.move(null,null,2*this.position.zoom);break;case"zoom-out":this.move(null,null,this.position.zoom/2);break;case"home":let e=this.slice.width/this.slice.height;this.move(.5,.5/e,Math.min(this.offsetHeight/this.offsetWidth*e,1));break;case"original":this.move(null,null,this.slice.width/this.offsetWidth);break;default:this.move(null,null,t)}},path2data:t=>({x:t.map(t=>t.point.x),y:t.map(t=>t.point.y)}),equal(t,e){if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(t[i].image!==e[i].image)return!1;return!0},roilistChange(t,e){let i={},n={};t.map(t=>{i[t.id]=t}),e.map(t=>{n[t.id]=t});let s=e.filter(t=>!o.a.equals(t,i[t.id])),r=t.filter(t=>!o.a.equals(t,n[t.id]));for(let t of s)this.dataMapPath[t.id]&&!this.curRois[t.id]&&(this.dataMapPath[t.id].text&&(this.dataMapPath[t.id].text.remove(),this.dataMapPath[t.id].rectangle.remove()),this.dataMapPath[t.id].path.remove(),delete this.dataMapPath[t.id]);let a=r.length,l=0,c=200;var h=this;a>0&&function t(){let e=l+c>r.length?r.length:l+c;if(!(l>a)){for(var i=l;i<e;i++)h.newRoi(r[i]);l+=c,t()}}(),this.setLayer(),this.roilist.forEach(t=>{this.showRoi?this.dataMapPath[t.id].path.selected=!!this.curRois[t.id]:this.dataMapPath[t.id].path.selected=!1,"spot"!=t.method&&this.curRois[t.id]&&this.drawArea(t)})},setLayer(){let t=Object.values(this.dataMapPath);var e={};let i=[...new Set(t.map(t=>t.data.mark_type))].map(t=>(e[t]=[],t));t.map(t=>{i.filter(e=>e==t.data.mark_type).length&&e[t.data.mark_type].push(t.path)}),this.layers[0].children=null,this.layers[1].children=e[3],this.layers[2].children=e[1],this.layers[3].children=e[2],this.layers[4].children=e[4],this.layers[5].children=e[5]},spliceArray(t){for(var e=void 0,i=0;i<t.x.length-1;i++){var n=t.x[i+1]-t.x[i],s=(t.y[i+1]-t.y[i])/n;(isNaN(e)&&isNaN(s)||s==e)&&(t.x.splice(i,1),t.y.splice(i,1),i--),e=s}return t},newRoi(t={editable:1,path:{x:[],y:[]}}){t=o.a.clone(t);let e,i={};if(this.paper.activate(),t.path.x.length>4&&(t.path=this.spliceArray(t.path)),e="spot"==t.method?new this.paper.Path.Circle({center:[4===t.path.x.length?t.path.x[1]:t.path.x[0],t.path.y[0]],radius:t.radius,strokeScaling:!1,fillColor:t.fillColor||"rgba(0,0,0,0.001)",strokeColor:t.strokeColor||null,owner:t,strokeWidth:3}):new this.paper.Path({segments:t.path.x.map((e,i)=>({x:e,y:t.path.y[i]})),strokeWidth:t.width||3,fillColor:t.fillColor||("secectMulty"==t.method?"rgba(255,255,255,0.5)":"rgba(0,0,0,0.001)"),strokeColor:t.strokeColor,strokeScaling:!1,owner:t,closed:!0,dashArray:t.dashed?[10,5]:[0,0]}),Object.assign(i,{path:e,dragCenter:!1,dragVertex:!1,dragEdge:!1,resetDragStatus(){this.dragCenter=this.dragVertex=this.dragEdge=!1}}),"freepen"==t.method||"freepenReverse"==t.method){var n=this;i.drag=function(t){this.dragVertex?(this.segment.point.x+=t.x,this.segment.point.y+=t.y,i.text&&(i.text.content=this.content?this.content:"面积:"+Math.round(Math.abs(i.path.area)*Math.pow(n.mpp,2))+"μm²")):this.dragCenter&&(this.path.position.x+=t.x,this.path.position.y+=t.y,i.text&&(i.text.position.x+=t.x,i.text.position.y+=t.y,i.rectangle.position.x+=t.x,i.rectangle.position.y+=t.y))},i.checkPath=function(t,e){if(this.segment=null,this.resetDragStatus(),"segment"==e.type){this.segment=e.segment;let t=e.item;"pickTool"===n.selectedTool&&t.smooth({type:"catmull-rom",factor:.5,from:this.segment.previous.index,to:this.segment.next.index}),this.dragVertex=!0,i.text&&(i.text.content=this.content?this.content:"面积:"+Math.round(Math.abs(i.path.area)*Math.pow(n.mpp,2))+"μm²")}else"fill"==e.type&&(this.dragCenter=!0)}}else if("rectangle"==t.method||"rectangleReverse"==t.method||"secectMulty"==t.method){n=this;i.drag=function(t){let e=(t,e)=>Math.abs(t-e)<1e-4;if(this.dragVertex){let s=this.segment.point.x,r=this.segment.point.y,o=s+t.x,a=r+t.y;this.path.segments.map(t=>{t.point.x=e(t.point.x,s)?o:t.point.x,t.point.y=e(t.point.y,r)?a:t.point.y});let l=this.path.segments[0].point.x<this.path.segments[2].point.x?this.path.segments[0].point.x:this.path.segments[2].point.x,c=this.path.segments[0].point.y<this.path.segments[2].point.y?this.path.segments[0].point.y:this.path.segments[2].point.y;i.text.content=this.content?this.content:"面积:"+Math.round(Math.abs(i.path.area)*Math.pow(n.mpp,2))+"μm²";let h=l!=Math.min.apply(null,i.data.path.x),u=c!=Math.min.apply(null,i.data.path.y);h&&!u&&(i.text.position.x+=t.x,i.rectangle.position.x+=t.x),!h&&u&&(i.text.position.y+=t.y,i.rectangle.position.y+=t.y),h&&u&&(i.text.position.y+=t.y,i.rectangle.position.y+=t.y,i.text.position.x+=t.x,i.rectangle.position.x+=t.x)}else if(this.dragEdge){if(e(this.editPt1.x,this.editPt2.x)&&(this.editPt1.x+=t.x,this.editPt2.x+=t.x,i.text)){i.text.content=this.content?this.content:"面积:"+Math.round(Math.abs(i.path.area)*Math.pow(n.mpp,2))+"μm²";let e=i.path.segments[0].point.x>i.path.segments[2].point.x?i.path.segments[0].point.x:i.path.segments[2].point.x;this.editPt1.x<e&&(i.text.position.x+=t.x,i.rectangle.position.x+=t.x)}if(e(this.editPt1.y,this.editPt2.y)&&(this.editPt1.y+=t.y,this.editPt2.y+=t.y,i.text)){i.text.content=this.content?this.content:"面积:"+Math.round(Math.abs(i.path.area)*Math.pow(n.mpp,2))+"μm²";let e=i.path.segments[0].point.y>i.path.segments[2].point.y?i.path.segments[0].point.y:i.path.segments[2].point.y;this.editPt1.y<e&&(i.text.position.y+=t.y,i.rectangle.position.y+=t.y)}}else this.dragCenter&&(this.path.segments.map(e=>{e.point.x+=t.x,e.point.y+=t.y}),i.text&&(i.text.position.x+=t.x,i.text.position.y+=t.y,i.rectangle.position.x+=t.x,i.rectangle.position.y+=t.y))},i.checkPath=function(t,e){if(this.segment=this.editPt1=this.editPt2=null,this.resetDragStatus(),"segment"==e.type)this.segment=e.segment,this.dragVertex=!0;else if("stroke"==e.type){let t=e.location;this.editPt1=t.curve.point1,this.editPt2=t.curve.point2,this.dragEdge=!0}else"fill"==e.type&&(this.dragCenter=!0)}}else"spot"==t.method&&(i.drag=function(t){this.path.position.x+=t.x,this.path.position.y+=t.y},i.checkPath=function(t,e){this.segment=null,this.resetDragStatus(),"segment"==e.type?(this.segment=e.segment,this.dragVertex=!0):"fill"==e.type&&(this.dragCenter=!0)});return i.data=t,i.path.visible=this.showRoi,i.path.selected=this.showRoi,this.dataMapPath[t.id]=i,i},drawArea(t){this.paper.activate();let e=this.dataMapPath[t.id];e&&e.text&&(e.text.remove(),e.rectangle.remove());let i=Math.min.apply(null,t.path.x.map(t=>t)),n=Math.min.apply(null,t.path.y.map(t=>t));"freepen"!=t.method&&"freepenReverse"!=t.method||(n=Math.min.apply(null,t.path.y.map(t=>t)),i=t.path.x[t.path.y.findIndex(e=>e==Math.min.apply(null,t.path.y.map(t=>t)))]);let s=this.viewport.viewportToImageZoom(this.position.zoom);var r={x:i,y:n-30/s},o={x:i,y:n};e.text=new this.paper.PointText({point:o,content:this.content?this.content:"面积:"+Math.round(Math.abs(e.path.area)*Math.pow(this.mpp,2))+"μm²",fillColor:"white",justification:"center",fontSize:14/s});var a=e.text.bounds.width,l=e.text.bounds.height;e.text.bounds.top-=28/s-l,e.text.bounds.left+=a/2+4/s,e.rectangle=new this.paper.Path.Rectangle(r,a+8/s,24/s,4/s),e.rectangle.fillColor="rgba(0,0,0,0.5)",this.paper.project.activeLayer.addChild(e.text),"freepen"!=t.method&&"freepenReverse"!=t.method||(e.text.bounds.left-=a+12/s,e.rectangle.bounds.left-=e.rectangle.bounds.width+4/s),this.showRoi||(e.text.visible=!1,e.rectangle.visible=!1)},contextmenu(t){let e=this.convertPoint(t.offsetX,t.offsetY),i=this.paper.project.hitTest(e,{stroke:!0,segments:!0,fill:!0});i&&(this.$emit("contextmenu",t,i.item.owner),this.selectedTool="choose")},keydown(t){let e=t.key;if("INPUT"!=t.target.nodeName)switch(e){case"ArrowUp":t.ctrlKey||t.metaKey||this.move(null,this.position.offy-.95*this.viewport.getBounds().height);break;case"ArrowDown":t.ctrlKey||t.metaKey||this.move(null,this.position.offy+.95*this.viewport.getBounds().height);break;case"ArrowLeft":t.ctrlKey||t.metaKey||this.move(this.position.offx-.95*this.viewport.getBounds().width);break;case"ArrowRight":t.ctrlKey||t.metaKey||this.move(this.position.offx+.95*this.viewport.getBounds().width);break;case"Escape":this.fullPage&&this.handleFullScreen();break;case"F":case"f":this.selectedTool="freepen",this.pentool="freepen";break;case"R":case"r":this.selectedTool="rectangle",this.pentool="rectangle";break;case"P":case"p":this.selectedTool="dottingTool",this.pentool="dottingTool";break;case" ":this.selectedTool="choose";break;case"=":this.buttonClick("zoom-in");break;case"-":this.buttonClick("zoom-out");break;case"1":this.buttonClick("home");break;case"2":this.buttonClick(2*this.scale);break;case"3":this.buttonClick(4*this.scale);break;case"4":this.buttonClick(10*this.scale);break;case"5":this.buttonClick(20*this.scale);break;case"6":this.buttonClick(40*this.scale);break;case"7":this.buttonClick("original");break;case"8":this.handleFullScreen();break;case"Escape":this.fullPage&&this.handleFullScreen();break;case"A":case"a":if(t.ctrlKey||t.metaKey){t.preventDefault();let e=this.convertPoint(0,0),i=this.convertPoint(this.offsetWidth,this.offsetHeight),n=this.roilist.filter(t=>t.path.x.every(t=>t>e.x&&t<i.x)&&t.path.y.every(t=>t>e.y&&t<i.y));n.length&&this.$emit("curROI",n,!1)}}},getDistance(t,e){var i=Math.abs(e.pageX-t.pageX),n=Math.abs(e.pageY-t.pageY);return Math.sqrt(i*i+n*n)},isInPolygon(t,e){var i,n,s,r,o=0,a=e.length;for(s=e[0],i=1;i<=a;i++)r=e[i%a],t[0]>Math.min(s[0],r[0])&&t[0]<=Math.max(s[0],r[0])&&t[1]<=Math.max(s[1],r[1])&&s[0]!=r[0]&&(n=(t[0]-s[0])*(r[1]-s[1])/(r[0]-s[0])+s[1],(s[1]==r[1]||t[1]<=n)&&o++),s=r;return o%2!=0},mouseDown(t){this.$refs.osd.querySelector(".openseadragon-canvas").focus(),t.preventDefault(),this.$emit("mousedown");let e=c(t);var i,n,s=t=>{var s=c(t,this.$refs.osd);if(new paper.Point(p.x-s.x,p.y-s.y).length>5&&(f=!0),m)if(t.touches&&2==t.touches.length){let e=this.viewport.deltaPointsFromPixels(new paper.Point((u.touches[0].clientX+u.touches[1].clientX-t.touches[0].clientX-t.touches[1].clientX)/2,(u.touches[0].clientY+u.touches[1].clientY-t.touches[0].clientY-t.touches[1].clientY)/2)),i=Math.hypot(u.touches[0].clientX-u.touches[1].clientX,u.touches[0].clientY-u.touches[1].clientY),n=Math.hypot(t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY);alert(2),this.move(this.position.offx+e.x,this.position.offy+e.y,this.position.zoom*n/i)}else{let t=this.viewport.deltaPointsFromPixels(new paper.Point(l.x-s.x,l.y-s.y));this.move(this.position.offx+t.x,this.position.offy+t.y)}else{let t=this.convertPoint(s.x-e.x+e.offsetX,s.y-e.y+e.offsetY);switch(this.selectedTool){case"choose":for(let t in this.curRois){if((r=this.dataMapPath[t]).dragCenter||this.curRoi.owner.id==t)if(0!=this.curRois[t].editable){let t=this.convertPoint(0,0),e=this.convertPoint(s.x-l.x,s.y-l.y);e.x-=t.x,e.y-=t.y,r.drag(e)}else m=!0}break;case"pickTool":for(let t in this.curRois){var r=this.dataMapPath[t];if(this.curRoi&&this.curRoi.owner.id==t){if(this.curRoi.segments.filter(t=>t.point.selected).length<3)return;if(0!=this.curRois[t].editable){let t=this.convertPoint(0,0),e=this.convertPoint(s.x-l.x,s.y-l.y);e.x-=t.x,e.y-=t.y,r.drag(e)}}}break;case"freepen":case"freepenReverse":case"secectMulty":this.curRoi.path.closed=!1,this.curRoi.path.fullySelected=!1,this.curRoi.path.add(t);break;case"rectangle":case"rectangleReverse":{let e=this.curRoi.path.segments[0].point;this.curRoi.path.removeSegments(),this.curRoi.path.addSegments([e,new this.paper.Point(t.x,e.y),t,new this.paper.Point(e.x,t.y)]);break}case"measure":{n&&n.remove(),i&&i.remove(),this.paper.activate(),(n=new this.paper.Path([d,t])).strokeWidth=2,n.strokeScaling=!1,n.strokeColor="#e4141b";let e=new this.paper.Point({x:t.x-d.x,y:t.y-d.y}),s=e.normalize(10/this.paper.view.zoom).rotate(Math.abs(e.angle)>90?90:-90);(i=new this.paper.PointText({point:{x:(t.x+d.x)/2+s.x,y:(d.y+t.y)/2+s.y},content:Math.round(100*e.length*this.mpp)/100+"μm",justification:"center",fontSize:14/this.paper.view.zoom})).rotate(Math.abs(e.angle)>90?180+e.angle:e.angle)}}this.paper.view.draw()}l={x:s.x,y:s.y},u=t},r=!1,o=t=>{if(t.cancelBubble=!0,t.preventDefault(),r=!0,window.removeEventListener("mousemove",s),window.removeEventListener("touchmove",s),window.removeEventListener("mouseup",o),window.removeEventListener("touchend",o),this.$refs.osd.removeEventListener("touchstart",y),t=t.changedTouches?h(t.changedTouches[0],this.$refs.osd):t,f){if(m)return;switch(this.selectedTool){case"freepen":case"rectangle":case"freepenReverse":case"rectangleReverse":this.drawRoi(this.curRoi,t.shiftKey,"removePath");break;case"secectMulty":{let t=this.curRoi.data;t.path=this.path2data(this.curRoi.path.segments);let e=t.path.x.map((e,i)=>[e,t.path.y[i]]),i=this.roilist.filter(t=>t.path.x.some((i,n)=>this.isInPolygon([i,t.path.y[n]],e)));if(this.curRoi.path.remove(),this.curRoi=null,i.length){this.scope={x:t.path.x,y:t.path.y};let e=this.slice.toolType;switch(this.slice.toolType){case"pdl1db":e="human";break;case"fish":e="fishTissue"}Object(a.b)(`slice/selectCount?companyid=${Object(a.o)().company}`,{caseid:this.record.id,fileid:this.slice.id,scope:JSON.stringify(this.scope),template_id:"tagging"==this.slice.toolType?this.slice.templateId:null,ai_type:e}).then(({data:t})=>{this.$message({showClose:!0,message:`已选中${t.select_count}个（可能包含隐藏标注）`,type:"warning",duration:3e3}),this.$emit("curROI",i,!1)}).catch(t=>{this.$alert(t.message,"提示",{confirmTextButtom:"确定"})})}else this.scope=null,this.$emit("curROI",null,!1);this.selectedTool="choose";break}case"choose":{let t=Object.assign({},Object.values(this.curRois)[0]),e=this.path2data(this.dataMapPath[t.id].path.segments),i=("spot"===t.method&&e.x.length>1?e.x[1]:e.x[0])-t.path.x[0],n=e.y[0]-t.path.y[0];this.scope&&(this.scope.offset=[i,n]),Object.values(this.curRois).map(t=>{t.path=this.path2data(this.dataMapPath[t.id].path.segments)}),this.$emit("curROI",Object.values(this.curRois),!1),this.$emit("roiChanged","path"),this.curRoi=null;break}case"pickTool":this.curRoi&&(this.dataMapPath[this.curRoi.owner.id].path.flatten(0),this.segmentsList=[],Object.values(this.curRois).map(t=>{t.path=this.path2data(this.dataMapPath[t.id].path.segments)}),this.$emit("curROI",Object.values(this.curRois),!1),this.$emit("roiChanged","path"),this.curRoi=null);break;case"measure":n.remove(),i.remove(),this.selectedTool="choose"}}else{let i=this.convertPoint(t.offsetX,t.offsetY);if("choose"==this.selectedTool){let e=this.slice.mppx?2:5,n=this.paper.project.hitTest(i,{fill:!0,stroke:!0,segments:!0,tolerance:e});if(n){if(!n.item.owner)return;this.scope=null,"grey"==n.item.owner.strokeColor&&"ki67hot"==this.slice.toolType||this.$emit("curROI",n.item.owner,t.shiftKey),(t={offsetX:t.offsetX,offsetY:t.offsetY,type:t.type}).preventDefault||(t.preventDefault=(t=>0)),t.currentTarget=this.$refs.osd,this.$emit("contextmenu",t,n.item.owner)}else this.scope=null,this.$emit("curROI",null,t.shiftKey,0),this.curROI=null}else if("freepen"==this.selectedTool||"rectangle"==this.selectedTool||"freepenReverse"==this.selectedTool||"rectangleReverse"==this.selectedTool||"secectMulty"==this.selectedTool)delete this.dataMapPath[this.curRoi.id],this.curRoi.path.remove(),this.curRoi=null;else if("point"==this.selectedTool)this.$emit("clickDraw",i);else if("dottingTool"==this.selectedTool)if(this.polygonRoi){let n=this.paper.project.hitTest(i,{stroke:!0,segments:!0,fill:!0,tolerance:this.slice.mppx?2:5});if(n&&"segment"===n.type&&!n.item.closed)return this.polygonRoi.path.closed=!0,this.polygonRoi.path.selected=!0,void this.drawRoi(this.polygonRoi);let s=this.convertPoint(t.x-e.x+e.offsetX,t.y-e.y+e.offsetY);this.polygonRoi.path.closed=!1,this.polygonRoi.path.selected=!0,this.polygonRoi.path.add(s)}else this.polygonRoi=this.newRoi({path:{x:[i.x],y:[i.y]},method:"freepen",strokeColor:"yellow"})}};if(e.button)return;let l={x:e.x,y:e.y},u=t,p=l,f=!1,d=this.convertPoint(e.offsetX,e.offsetY),m=!1;switch(this.selectedTool){case"choose":{let e=this.paper.project.hitTest(d,{fill:!0,stroke:!0,segments:!0,tolerance:this.slice.mppx?2:5}),i=Object.values(this.curRois).map(t=>this.dataMapPath[t.id]);i.some(t=>t.path==(e&&e.item))?(this.curRoi=e.item,i.map(t=>{t.checkPath(null,e)})):t.touches&&("stylus"==t.touches[0].touchType||t.touches[0].force<1)?(this.selectedTool="freepen",this.curRoi=this.newRoi({path:{x:[d.x],y:[d.y]},method:"freepen",strokeColor:this.penColor})):m=!0;break}case"pickTool":{let t=this.paper.project.hitTest(d,{fill:!0,stroke:!0,segments:!0,tolerance:this.slice.mppx?2:5});if(!t.item.owner)return;if(t&&this.curRois[t.item.owner.id]&&"segment"===t.type&&"freepen"===t.item.owner.method&&0!=t.item.owner.editable){let e=t.segment,i=t.item,n=i.segments.filter(t=>t.point.selected).length;if(!this.segmentsList.length&&n<3)e.point.selected=!0,this.segmentsList.push(e);else if(1===this.segmentsList.length&&this.segmentsList[0].index!==e.index){e.point.selected=!0,this.segmentsList.push(e);let t=i.lastSegment.index,n=Math.min(this.segmentsList[0].index,this.segmentsList[1].index),s=Math.max(this.segmentsList[0].index,this.segmentsList[1].index),r=Math.abs(n-s),o=t-r+1,a=new paper.Point((this.segmentsList[0].point.x+this.segmentsList[1].point.x)/2,(this.segmentsList[0].point.y+this.segmentsList[1].point.y)/2);if(o>r){let t=i.segments.slice(n+1,s);for(var g=0;g<t.length;g++)i.removeSegment(t[g].index);i.insert(n+1,a),i.segments[n+1].point.selected=!0}else{let e=i.segments.slice(0,n),r=i.segments.slice(s+1,t+1),o=e.concat(r);for(let t=0;t<o.length;t++)i.removeSegment(o[t].index);i.insert(i.segments.length,a),i.segments[i.segments.length-1].point.selected=!0}this.segmentsList=[];let l=this.paper.project.hitTest(a,{fill:!0,stroke:!0,segments:!0});this.curRoi=l.item,this.dataMapPath[l.item.owner.id].checkPath(null,l)}}break}case"freepen":case"rectangle":case"secectMulty":this.curRoi=this.newRoi({path:{x:[d.x],y:[d.y]},method:this.selectedTool,strokeColor:this.drawMpp?"yellow":"secectMulty"==this.selectedTool?"#E3E9EF":this.penColor});break;case"freepenReverse":case"rectangleReverse":this.curRoi=this.newRoi({path:{x:[d.x],y:[d.y]},method:this.selectedTool,strokeColor:"#E3E9EF",dashed:!0});break;case"point":let e=this.paper.project.hitTest(d,{fill:!0,stroke:!0,segments:!0});this.$emit("parentId",e?e.item.owner.id:null)}window.addEventListener("touchmove",s),window.addEventListener("mousemove",s),window.addEventListener("mouseup",o),window.addEventListener("touchend",o);var y=t=>{r||o(t)};this.$refs.osd.addEventListener("touchstart",y)},drawRoi(t,e,i){let n=t.data;n.path=this.path2data(t.path.segments),delete this.dataMapPath[t.id],this.drawMpp?(this.userMpp=Math.sqrt((this.cellArea||200)/t.path.area).toFixed(4),"NaN"===this.userMpp||"Infinity"===this.userMpp?(this.$alert("您画的roi太小,请选择矩形工具重新画一个"),t.path.remove(),t=null):(this.mpp=this.userMpp,this.drawMpp=!1,this.knew=!0)):(i&&t.path.remove(),t=null,this.$emit("draw",n,e),this.scope=null),this.selectedTool="choose"},mousemoveNew(t){let e=this.convertPoint(t.offsetX,t.offsetY);n&&n.remove(),"pickTool"!==this.selectedTool&&"choose"!==this.selectedTool||(n=new this.paper.Path.Circle({center:[e.x,e.y],radius:this.slice.mppx?Math.floor(1/this.slice.mppx):5,fillColor:"#f00"}),this.layers[0].children=[n])}},created(){this.curRoi=null,this.polygonRoi=null},mounted(){this.initOSD()},destroyed(){window.removeEventListener("resize",this.resize),setTimeout(()=>{this.paper.view.remove(),this.osd.destroy()},1e3)},watch:{radius(t){this.newRadius=t},position:{handler(t){this.update(t)},deep:!0},selectedTool:{handler(t){switch(t){case"choose":case"pickTool":this.$refs.osd.querySelector(".openseadragon-canvas").style.cursor="pointer";break;case"freepen":case"rectangle":case"measure":case"point":case"freepenReverse":case"rectangleReverse":case"secectMulty":case"dottingTool":this.$refs.osd.querySelector(".openseadragon-canvas").style.cursor="crosshair"}},deep:!0},"position.zoom":function(){setTimeout(t=>{for(let t in this.curRois)"spot"!=this.curRois[t].method&&this.drawArea(this.curRois[t])},90)},showRoi(t){t?this.$emit("changeShowLayer",!0):this.$emit("changeShowLayer",!1);for(let e in this.dataMapPath)this.dataMapPath[e].path.visible=!!t,this.dataMapPath[e].path.selected=this.curRois[e]&&t,this.dataMapPath[e].text&&(this.dataMapPath[e].text.visible=!!t,this.dataMapPath[e].rectangle.visible=!!t)},roilist(t,e){this.roilistChange(t,e),this.polygonRoi=null},centerRegion([t,e,i,n]){let s,r=1.5*(i-t),o=1.5*(n-e),a=this.slice.width,l=(t+i)/2,c=(e+n)/2;s=r/o>this.offsetWidth/this.offsetHeight?a/r:a/o*this.offsetHeight/this.offsetWidth,this.slice.toolType&&(this.slice.toolType.includes("tct")||this.slice.toolType.includes("lct")||"dna"===this.slice.toolType)||"bm"===this.slice.toolType?this.move(l/a,c/a,Math.max(40*this.scale,this.position.zoom)):this.move(l/a,c/a,Math.min(s,this.position.zoom))},curRois(t,e){this.roilist.forEach(e=>{this.showRoi?(this.dataMapPath[e.id].path.selected=!!t[e.id],!t[e.id]||0==t[e.id].editable||3==t[e.id].mark_type&&"grey"==t[e.id].strokeColor||this.paper.project.activeLayer.addChild(this.dataMapPath[e.id].path)):this.dataMapPath[e.id].path.selected=!1,this.dataMapPath[e.id].path.visible=!!this.showRoi});for(let t in this.dataMapPath)this.dataMapPath[t].text&&(this.dataMapPath[t].text.remove(),this.dataMapPath[t].rectangle.remove());for(let e in t)t[e]&&"spot"!=t[e].method&&this.roilist.length&&this.drawArea(t[e]);Object.keys(t).toString()!=Object.keys(e).toString()&&(this.segmentsList=[])}},components:{"v-attactments":s.a}};function c(t,e=t.currentTarget){return t.touches?h(t.touches[0],e):t}function h(t,e){for(var i={x:0,y:0};e.offsetParent;)i.x+=e.offsetLeft,i.y+=e.offsetTop,e=e.offsetParent;return{offsetX:t.clientX-i.x,offsetY:t.clientY-i.y,x:t.clientX,y:t.clientY,shiftKey:t.shiftKey}}var u={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"osd",class:{"fixed-fullpage":t.fullPage},on:{keydown:t.keydown}},[t._t("default"),t._v(" "),i("div",{ref:"osd",staticClass:"osd"}),t._v(" "),i("div",{ref:"hideToolbar",staticStyle:{display:"none"}}),t._v(" "),i("canvas",{ref:"canvas",staticClass:"canvas"}),t._v(" "),t.saved?i("div",{staticClass:"saved"},[t._v("保存成功")]):t._e(),t._v(" "),t.showLabel?i("img",{ref:"rotate",staticClass:"label",attrs:{title:"点击旋转",src:"/aipath/api/files/getLabel?caseid="+t.record.id+"&fileid="+t.slice.id+"&companyid="+t.company},on:{click:t.rotate,error:function(e){t.showLabel=!1}}}):t._e()],2)},staticRenderFns:[]};var p=i("VU/8")(l,u,!1,function(t){i("xJsL"),i("7PVR")},"data-v-6695e50e",null).exports,f={data(){return{centerRegion:null,curRois:{},companyid:this.$route.query.companyid,filename:this.$route.query.filename,fileid:this.$route.query.fileid,slice:null,record:{id:this.$route.query.caseid,slices:this.slice}}},mounted(){this.getrecords()},methods:{async getrecords(){await Object(a.b)("files/getInfo?companyid="+this.companyid,{caseid:this.record.id,fileid:this.fileid}).then(t=>{this.slice=Object.assign({filename:this.filename,id:this.fileid},t.data)})},curROIChange(t,e){var i;t?t.length?i=t:e&&this.curRois[t.id]?(delete this.curRois[t.id],i=[]):i=[t]:i=[],this.curRois=Object.assign({},e&&this.curRois||{},...i.map(t=>({[t.id]:t}))),this.slice.roilist.forEach(t=>{this.curRois[t.id]&&this.$set(t,"path",this.curRois[t.id].path)})},draw(t){t.id=(Math.random()+"").substr(2,6),this.slice.roilist=[...this.slice.roilist,t]},clickDraw(t,e){var i=60,n=t.x,s=t.y,r={id:(Math.random()+"").substr(2,6),path:{x:[n-i,n+i,n+i,n-i],y:[s-i,s-i,s+i,s+i]},width:3,method:"rectangle"};this.slice.roilist=[...this.slice.roilist,r],this.curROIChange(r,e)},async delCurRoi(t){t?(this.slice.roilist=this.slice.roilist.filter(e=>e.id!=t.id),this.curRois[t.id]&&(delete this.curRois[t.id],this.curRois=Object.assign({},this.curRois))):await this.$confirm(this.$t("analaysisPanel.delete"),{confirmButtonText:this.$t("confirm.confirm"),cancelButtonText:this.$t("confirm.quit"),type:"warning"}).catch(()=>{})&&(this.slice.roilist=this.slice.roilist.filter(t=>!this.curRois[t.id]),this.curRois={})},keydown(t){"Delete"!=t.key&&"Backspace"!=t.key||!Object.keys(this.curRois).length||this.delCurRoi()}},components:{"v-dragon":p}},d={render:function(){var t=this.$createElement,e=this._self._c||t;return e("div",[this.slice?e("v-dragon",{staticClass:"dragon",attrs:{record:this.record,slice:this.slice,roilist:[],curRois:{},companyid:this.companyid}}):this._e()],1)},staticRenderFns:[]};var m=i("VU/8")(f,d,!1,function(t){i("jDAy")},"data-v-71089c62",null);e.default=m.exports}});